<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jamin Blog</title>
  <icon>https://www.gravatar.com/avatar/fca0f49342f608d216999d4b41d5ba65</icon>
  <subtitle>一个不聊技术的 DBA 不是一个好厨子...</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jiemin.wang/"/>
  <updated>2019-07-24T02:50:50.743Z</updated>
  <id>https://jiemin.wang/</id>
  
  <author>
    <name>Wang Jiemin</name>
    <email>278667010@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>四脚吞金兽</title>
    <link href="https://jiemin.wang/2019/07/24/myson/"/>
    <id>https://jiemin.wang/2019/07/24/myson/</id>
    <published>2019-07-24T01:37:34.000Z</published>
    <updated>2019-07-24T02:50:50.743Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="14365369037725935.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>不知道哪家的小姑娘有福气嫁给萌萌哒帅气小伙子💯</strong></p></blockquote><h3 id="四脚吞金兽"><a href="#四脚吞金兽" class="headerlink" title="四脚吞金兽 "></a><strong>四脚吞金兽 </strong></h3><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-知我者谓我心忧，不知我者谓我何求。近一年来，四脚吞金兽一直千扰着我，无论走到哪里，都要为之揪心。那么，何为四脚吞金兽？且听分解："><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-知我者谓我心忧，不知我者谓我何求。近一年来，四脚吞金兽一直千扰着我，无论走到哪里，都要为之揪心。那么，何为四脚吞金兽？且听分解：" class="headerlink" title="      知我者谓我心忧，不知我者谓我何求。近一年来，四脚吞金兽一直千扰着我，无论走到哪里，都要为之揪心。那么，何为四脚吞金兽？且听分解："></a>      知我者谓我心忧，不知我者谓我何求。近一年来，四脚吞金兽一直千扰着我，无论走到哪里，都要为之揪心。那么，何为四脚吞金兽？且听分解：</h5><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-江湖传说，四脚吞金兽，又名”小祖宗”。初始技能一哭二闹三吃奶尿尿，养大后自动附加说话、打酱油、气人等魂环🤣-需要提前十个月预定，两种型号，系统随机选择💤没有图纸，不能退货，售后失联，没有自理能力，性格设定和语音库都需自行安装👀一年内，以乳充饥，待机时间非常短，每两个小时就要充一次。尤其，成长进化一年后，附加咿呀说话、拆家等一系列技能……😤是自古人类延续香火，兴旺门楣的上乘首选宝贝。虽然，养这样一个“小祖宗”非常费时费力，而且需要大量的财力物力，但是丝毫不影响他在任何家庭的地位😒"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-江湖传说，四脚吞金兽，又名”小祖宗”。初始技能一哭二闹三吃奶尿尿，养大后自动附加说话、打酱油、气人等魂环🤣-需要提前十个月预定，两种型号，系统随机选择💤没有图纸，不能退货，售后失联，没有自理能力，性格设定和语音库都需自行安装👀一年内，以乳充饥，待机时间非常短，每两个小时就要充一次。尤其，成长进化一年后，附加咿呀说话、拆家等一系列技能……😤是自古人类延续香火，兴旺门楣的上乘首选宝贝。虽然，养这样一个“小祖宗”非常费时费力，而且需要大量的财力物力，但是丝毫不影响他在任何家庭的地位😒" class="headerlink" title="      江湖传说，四脚吞金兽，又名”小祖宗”。初始技能一哭二闹三吃奶尿尿，养大后自动附加说话、打酱油、气人等魂环🤣 需要提前十个月预定，两种型号，系统随机选择💤没有图纸，不能退货，售后失联，没有自理能力，性格设定和语音库都需自行安装👀一年内，以乳充饥，待机时间非常短，每两个小时就要充一次。尤其，成长进化一年后，附加咿呀说话、拆家等一系列技能……😤是自古人类延续香火，兴旺门楣的上乘首选宝贝。虽然，养这样一个“小祖宗”非常费时费力，而且需要大量的财力物力，但是丝毫不影响他在任何家庭的地位😒"></a>      江湖传说，四脚吞金兽，又名”小祖宗”。初始技能一哭二闹三吃奶尿尿，养大后自动附加说话、打酱油、气人等魂环🤣 需要提前十个月预定，两种型号，系统随机选择💤没有图纸，不能退货，售后失联，没有自理能力，性格设定和语音库都需自行安装👀一年内，以乳充饥，待机时间非常短，每两个小时就要充一次。尤其，成长进化一年后，附加咿呀说话、拆家等一系列技能……😤是自古人类延续香火，兴旺门楣的上乘首选宝贝。虽然，养这样一个“小祖宗”非常费时费力，而且需要大量的财力物力，但是丝毫不影响他在任何家庭的地位😒</h5><img src="/2019/07/24/myson/WechatIMG776.jpeg" title="WechatIMG776"><img src="/2019/07/24/myson/WechatIMG774.jpeg" title="WechatIMG774"><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-说到这里，大概都明白了这四脚吞金兽到底是什么了吧。不错，正是家庭生活中的重要成员——幼子婴孩。爷爷奶奶翘首以盼，姥姥姥爷孜孜以求，爸爸妈妈更是倾情奉献，这活脱脱一个小小的九五至尊。"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-说到这里，大概都明白了这四脚吞金兽到底是什么了吧。不错，正是家庭生活中的重要成员——幼子婴孩。爷爷奶奶翘首以盼，姥姥姥爷孜孜以求，爸爸妈妈更是倾情奉献，这活脱脱一个小小的九五至尊。" class="headerlink" title="      说到这里，大概都明白了这四脚吞金兽到底是什么了吧。不错，正是家庭生活中的重要成员——幼子婴孩。爷爷奶奶翘首以盼，姥姥姥爷孜孜以求，爸爸妈妈更是倾情奉献，这活脱脱一个小小的九五至尊。"></a>      说到这里，大概都明白了这四脚吞金兽到底是什么了吧。不错，正是家庭生活中的重要成员——幼子婴孩。爷爷奶奶翘首以盼，姥姥姥爷孜孜以求，爸爸妈妈更是倾情奉献，这活脱脱一个小小的九五至尊。</h5><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-每到周末，在脑海里，紧绷着工作的弦，微信消息的轰炸，身体上，做着奶爸的事。虽说天伦已聚，但身心疲劳仍有微微，感觉战战兢兢，如临深渊，如履薄冰，生怕处事不周。看着垫子上、床上、窗台上……随地匍匐攀爬与行走的孩子，活泼可爱，童真爽朗，看着看管孩子的父母白发苍苍，却欣喜万分，我的心，既有兴奋溢出，又有压力山大，未来育儿的方法道路还会任重道远，实在难以言表😘"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-每到周末，在脑海里，紧绷着工作的弦，微信消息的轰炸，身体上，做着奶爸的事。虽说天伦已聚，但身心疲劳仍有微微，感觉战战兢兢，如临深渊，如履薄冰，生怕处事不周。看着垫子上、床上、窗台上……随地匍匐攀爬与行走的孩子，活泼可爱，童真爽朗，看着看管孩子的父母白发苍苍，却欣喜万分，我的心，既有兴奋溢出，又有压力山大，未来育儿的方法道路还会任重道远，实在难以言表😘" class="headerlink" title="      每到周末，在脑海里，紧绷着工作的弦，微信消息的轰炸，身体上，做着奶爸的事。虽说天伦已聚，但身心疲劳仍有微微，感觉战战兢兢，如临深渊，如履薄冰，生怕处事不周。看着垫子上、床上、窗台上……随地匍匐攀爬与行走的孩子，活泼可爱，童真爽朗，看着看管孩子的父母白发苍苍，却欣喜万分，我的心，既有兴奋溢出，又有压力山大，未来育儿的方法道路还会任重道远，实在难以言表😘"></a>      每到周末，在脑海里，紧绷着工作的弦，微信消息的轰炸，身体上，做着奶爸的事。虽说天伦已聚，但身心疲劳仍有微微，感觉战战兢兢，如临深渊，如履薄冰，生怕处事不周。看着垫子上、床上、窗台上……随地匍匐攀爬与行走的孩子，活泼可爱，童真爽朗，看着看管孩子的父母白发苍苍，却欣喜万分，我的心，既有兴奋溢出，又有压力山大，未来育儿的方法道路还会任重道远，实在难以言表😘</h5><img src="/2019/07/24/myson/WechatIMG769.jpeg" title="WechatIMG769"><img src="/2019/07/24/myson/WechatIMG770.jpeg" title="WechatIMG770"><img src="/2019/07/24/myson/WechatIMG771.jpeg" title="WechatIMG771"><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-犬子鸿钧，靓宝一枚，正在上演着叛逆与淘气，天真与活泼的一幕卡通喜剧。都说孩子的脸属猫，说变就变。诚然，一个月前，这小子作息习惯昼夜颠倒，异于常人，每当夜深人静却能听到他的哭闹，使得整家人都休不安宁，一会儿抱来，一会儿抱去，一会儿逗开心，一会儿换尿布……一夜都开着灯，折腾的家里声嘶力竭。最多的时候，每天喂奶二十多次，一到点便哭个不停，准时的不差分秒。如今，再次看到艰辛能爬，感到无比欣慰和开心。瞅瞅父母，有操劳了不少。我常以上班在外而不能陪伴家人孩子，全凭父母、妻子照应，每次体会，都觉非常感恩和理解。人常说，父母之于孩子，捧在手心怕坏了，含在嘴里怕化了，直到自己有了孩子，尤其在如此幼小的世界里，才真正体会感触得到。这，并不是溺爱，也不是夸张，这种感受是人性本善的驱使和代代传承的力量铸就。"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-犬子鸿钧，靓宝一枚，正在上演着叛逆与淘气，天真与活泼的一幕卡通喜剧。都说孩子的脸属猫，说变就变。诚然，一个月前，这小子作息习惯昼夜颠倒，异于常人，每当夜深人静却能听到他的哭闹，使得整家人都休不安宁，一会儿抱来，一会儿抱去，一会儿逗开心，一会儿换尿布……一夜都开着灯，折腾的家里声嘶力竭。最多的时候，每天喂奶二十多次，一到点便哭个不停，准时的不差分秒。如今，再次看到艰辛能爬，感到无比欣慰和开心。瞅瞅父母，有操劳了不少。我常以上班在外而不能陪伴家人孩子，全凭父母、妻子照应，每次体会，都觉非常感恩和理解。人常说，父母之于孩子，捧在手心怕坏了，含在嘴里怕化了，直到自己有了孩子，尤其在如此幼小的世界里，才真正体会感触得到。这，并不是溺爱，也不是夸张，这种感受是人性本善的驱使和代代传承的力量铸就。" class="headerlink" title="      犬子鸿钧，靓宝一枚，正在上演着叛逆与淘气，天真与活泼的一幕卡通喜剧。都说孩子的脸属猫，说变就变。诚然，一个月前，这小子作息习惯昼夜颠倒，异于常人，每当夜深人静却能听到他的哭闹，使得整家人都休不安宁，一会儿抱来，一会儿抱去，一会儿逗开心，一会儿换尿布……一夜都开着灯，折腾的家里声嘶力竭。最多的时候，每天喂奶二十多次，一到点便哭个不停，准时的不差分秒。如今，再次看到艰辛能爬，感到无比欣慰和开心。瞅瞅父母，有操劳了不少。我常以上班在外而不能陪伴家人孩子，全凭父母、妻子照应，每次体会，都觉非常感恩和理解。人常说，父母之于孩子，捧在手心怕坏了，含在嘴里怕化了，直到自己有了孩子，尤其在如此幼小的世界里，才真正体会感触得到。这，并不是溺爱，也不是夸张，这种感受是人性本善的驱使和代代传承的力量铸就。"></a>      犬子鸿钧，靓宝一枚，正在上演着叛逆与淘气，天真与活泼的一幕卡通喜剧。都说孩子的脸属猫，说变就变。诚然，一个月前，这小子作息习惯昼夜颠倒，异于常人，每当夜深人静却能听到他的哭闹，使得整家人都休不安宁，一会儿抱来，一会儿抱去，一会儿逗开心，一会儿换尿布……一夜都开着灯，折腾的家里声嘶力竭。最多的时候，每天喂奶二十多次，一到点便哭个不停，准时的不差分秒。如今，再次看到艰辛能爬，感到无比欣慰和开心。瞅瞅父母，有操劳了不少。我常以上班在外而不能陪伴家人孩子，全凭父母、妻子照应，每次体会，都觉非常感恩和理解。人常说，父母之于孩子，捧在手心怕坏了，含在嘴里怕化了，直到自己有了孩子，尤其在如此幼小的世界里，才真正体会感触得到。这，并不是溺爱，也不是夸张，这种感受是人性本善的驱使和代代传承的力量铸就。</h5><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-孩子，你是一家人在心里投下的一抹暖阳，温暖着爷爷奶奶姥爷姥姥，更温暖着你的父母，温暖着所有人的心。时光之门打开，永远不会倒流，你的欢乐与悲伤，在父母长辈眼里将是一种辛酸苦辣的触发。你若哭泣，在我们眼里也在下雨，将能淋湿我们所有土地，你若开心，在我们心里犹如太阳升起，将启迪和促使我们事事如意！"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-孩子，你是一家人在心里投下的一抹暖阳，温暖着爷爷奶奶姥爷姥姥，更温暖着你的父母，温暖着所有人的心。时光之门打开，永远不会倒流，你的欢乐与悲伤，在父母长辈眼里将是一种辛酸苦辣的触发。你若哭泣，在我们眼里也在下雨，将能淋湿我们所有土地，你若开心，在我们心里犹如太阳升起，将启迪和促使我们事事如意！" class="headerlink" title="      孩子，你是一家人在心里投下的一抹暖阳，温暖着爷爷奶奶姥爷姥姥，更温暖着你的父母，温暖着所有人的心。时光之门打开，永远不会倒流，你的欢乐与悲伤，在父母长辈眼里将是一种辛酸苦辣的触发。你若哭泣，在我们眼里也在下雨，将能淋湿我们所有土地，你若开心，在我们心里犹如太阳升起，将启迪和促使我们事事如意！"></a>      孩子，你是一家人在心里投下的一抹暖阳，温暖着爷爷奶奶姥爷姥姥，更温暖着你的父母，温暖着所有人的心。时光之门打开，永远不会倒流，你的欢乐与悲伤，在父母长辈眼里将是一种辛酸苦辣的触发。你若哭泣，在我们眼里也在下雨，将能淋湿我们所有土地，你若开心，在我们心里犹如太阳升起，将启迪和促使我们事事如意！</h5><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-如今的幼子婴孩，已经届满一岁，从此开启你的天使与恶魔的纯真无邪，愿你健康快乐成长，为家里多带来些幸福幸运！"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-如今的幼子婴孩，已经届满一岁，从此开启你的天使与恶魔的纯真无邪，愿你健康快乐成长，为家里多带来些幸福幸运！" class="headerlink" title="      如今的幼子婴孩，已经届满一岁，从此开启你的天使与恶魔的纯真无邪，愿你健康快乐成长，为家里多带来些幸福幸运！"></a>      如今的幼子婴孩，已经届满一岁，从此开启你的天使与恶魔的纯真无邪，愿你健康快乐成长，为家里多带来些幸福幸运！</h5><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-喂！小子，最近你是不是又在作妖？"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-喂！小子，最近你是不是又在作妖？" class="headerlink" title="      喂！小子，最近你是不是又在作妖？"></a>      喂！小子，最近你是不是又在作妖？</h5><img src="/2019/07/24/myson/WechatIMG786.jpeg" title="WechatIMG786"><img src="/2019/07/24/myson/WechatIMG787.jpeg" title="WechatIMG787"><img src="/2019/07/24/myson/WechatIMG816.jpeg" title="WechatIMG816"><img src="/2019/07/24/myson/WechatIMG817.jpeg" title="WechatIMG817"><h5 id="nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-怎么感觉你在我心里份量越来越重了呢……😎"><a href="#nbsp-nbsp-nbsp-nbsp-nbsp-nbsp-怎么感觉你在我心里份量越来越重了呢……😎" class="headerlink" title="      怎么感觉你在我心里份量越来越重了呢……😎"></a>      怎么感觉你在我心里份量越来越重了呢……😎</h5><img src="/2019/07/24/myson/WechatIMG782.jpeg" title="WechatIMG782"><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;14365369037725935.jpg&quot; class=&quot;full-
      
    
    </summary>
    
      <category term="生活中的美好" scheme="https://jiemin.wang/categories/%E7%94%9F%E6%B4%BB%E4%B8%AD%E7%9A%84%E7%BE%8E%E5%A5%BD/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQL/MariaDB binlog/relaylog 回滚/闪回,前滚,DML分析报告,DDL信息</title>
    <link href="https://jiemin.wang/2019/07/17/my2fback/"/>
    <id>https://jiemin.wang/2019/07/17/my2fback/</id>
    <published>2019-07-17T08:02:54.000Z</published>
    <updated>2019-07-18T06:44:49.014Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="tupian.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>喜歡就去追阿～ 晚下手，你就是孩子她舅！早下手，就是喜当爹．．．</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>flashback闪回原理<a href="https://jiemin.wang/2019/04/19/mysql-flashback-priciple-and-practice/">上一篇</a></p><p>flashback的概念最早出现于Oracle数据库，用于快速恢复用户的误操作。</p><p>flashback for MySQL用于恢复由DML语句引起的误操作，目前不支持DDL语句。例如下面的语句：<br></p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> DELETE FROM XXX; UPDATE XXX SET YYY=ZZZ;</span><br></pre></td></tr></tbody></table></figure><p></p><p>若没有flashback功能，那么当发生误操作时，用户只能通过全备+二进制日志前滚的方式进行恢复。通常来说，这样所需的恢复时间会非常长。为了缩短误操作恢复的时间，通常可以在slave上搭建LVM，通过定期快照的方式来缩短误操作的恢复时间。但是LVM快照的缺点是会对slave的性能产生一定的影响。</p><p>官方<a href="https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html" target="_blank" rel="noopener">mysqlbinlog</a>命令为解析MySQL的二进制日志。当二进制日志的格式为ROW格式时，可以输出每个操作的每条记录的前项与后项。那么通过逆操作即可进行回滚操作，例如：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">原始操作：<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ...</span><br><span class="line"><span class="keyword">flashback</span>操作：<span class="keyword">DELETE</span> ...</span><br><span class="line">  </span><br><span class="line">原始操作：<span class="keyword">DELETE</span> <span class="keyword">FROM</span> ...</span><br><span class="line"><span class="keyword">flashback</span>操作：<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ...</span><br><span class="line">  </span><br><span class="line">原始操作：<span class="keyword">UPDATE</span> XXX <span class="keyword">SET</span> OLD_VALUES ...</span><br><span class="line"><span class="keyword">flashback</span>操作：<span class="keyword">UPDATE</span> XXX <span class="keyword">SET</span> NEW_VALUES ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>目前flashback功能还没有集成于官方<a href="https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html" target="_blank" rel="noopener">mysqlbinlog</a>g命令。于是自己开发了一套 MySQL Flashback 工具 <strong><code>my2fback</code></strong></p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>my2fback 实现了基于row格式binlog的回滚闪回功能，让误删除或者误更新数据，可以不停机不使用备份而快速回滚误操作。也可以解释binlog（支持非row格式binlog）生成易读的SQL。可以按配置输出各个表的update/insert/delete统计报表， 也会输出大事务与长事务的分析， 应用是否干了坏事一目了然， 也会输出所有DDL。</p><p>my2fback 连接数据库帐号的权限: </p><ul><li><p>MySQL5.6/MariaDB10.1/MariaDB10.2版本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT, PROCESS ON *.* TO <span class="string">'user'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'xxxxxx'</span>;</span><br></pre></td></tr></tbody></table></figure></li><li><p>MySQL5.7版本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql> CREATE USER <span class="string">'user'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'xxxxxx'</span>;</span><br><span class="line">mysql> GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT, PROCESS ON *.* TO <span class="string">'user'</span>@<span class="string">'localhost'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><p>my2fback 通过解释mysql/mariadb binlog/relaylog实现以下三大功能:</p><ol><li><p>flashback/闪回/回滚， DML回滚到任意时间或者位置。</p><ul><li>生成的文件名为rollback.xxx.sql或者db.tb.rollback.xxx.sql</li></ul><ul><li>生成的SQL形式如下<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">1</span></span><br><span class="line"><span class="comment"># datetime=2019-06-15_16:23:58 database=test table=t1 binlog=mysql-bin.000012 startpos=417 stoppos=575</span></span><br><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p>前滚，把binlog/relaylog的DML解释成易读的SQL语句。</p><ul><li>支持非row格式的binlog， 默认不解释非row格式的DML， 需要指定参数 -stsql</li><li>生成的文件名为forward.xxx.sql或者db.tb.forward.xxx.sql</li></ul><ul><li>生成的SQL形式如下<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment"># datetime=2019-06-15_16:23:58 database=test table=t1 binlog=mysql-bin.000012 startpos=417 stoppos=575</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`t1`</span> (<span class="string">`id`</span>,<span class="string">`name`</span>,<span class="string">`sr`</span>,<span class="string">`icon`</span>,<span class="string">`points`</span>,<span class="string">`sa`</span>,<span class="string">`sex`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'张三1'</span>,<span class="string">'华南理工大学&SCUT'</span>,X<span class="string">'89504e47'</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p>输出row格式下的原始SQL（5.7）</p><ul><li>结果文件名为original_sql.binlogxxx.sql</li></ul></li><li><p>统计分析， 输出各个表的DML统计， 输出大事务与长事务， 输出所有的DDL </p><ul><li><em>DML统计结果文件</em>：<strong><code>binlog_status.txt</code></strong></li><li><em>大事务与长事务结果文件</em>：<strong><code>binlog_biglong_trx.txt</code></strong></li><li><em>DDL结果文件</em>：<strong><code>ddl_info.txt</code></strong></li></ul></li></ol><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ol><li>支持V4版本的binlog， 支持传统与GTID的binlog， 支持mysql5.1与mairiadb5.5及以上版本的binlog， 也同样支持relaylog(结果中注释的信息binlog=xxx startpos=xxx stoppos=xx是对应的主库的binlog信息)<ul><li>–mtype=mariadb</li></ul></li><li>支持以时间及位置条件过滤， 并且支持单个以及多个连续binlog的解释。<ul><li>区间范围为左闭右开， [-sxx， -exxx)</li><li>解释binlog的开始位置：<ul><li>-sbin mysql-bin.000101</li><li>-spos 4</li></ul></li><li>解释binlog的结束位置：<ul><li>-ebin mysql-bin.000105</li><li>-epos 4</li></ul></li><li>解释binlog的开始时间<ul><li>-sdt “2019-06-15 00:00:00”</li></ul></li><li>解释binlog的结束时间  </li></ul><ul><li>-edt “2019-06-15 11:00:00”</li></ul></li><li>支持以库及表条件过滤, 以逗号分隔<ul><li>支持正则表达式，如-dbs “db\d+,db_sh\d+”。正则表达式中请使用小写字母，因为数据库名与表名会先转成小写再与正则表达式进行匹配</li></ul></li></ol><ul><li>-dbs db1,db2</li><li>-tbs tb1,tb2</li></ul><ol start="4"><li>支持以DML类型(update,delete,insert)条件过滤<ul><li>-sql delete,update</li></ul></li><li>支持分析本地binlog，也支持复制协议， my2fback作为一个从库从主库拉binlog来本地解释<ul><li>-m file //解释本地binlog</li><li>-m repl //my2fback作为slave连接到主库拉binlog来解释</li></ul></li><li>输出的结果支持一个binlog一个文件， 也可以一个表一个文件<ul><li>-f <ul><li>例如对于binlog mysql-bin.000101, 如果一个表一个文件， 则生成的文件形式为</li></ul></li><li>db.tb.rollback.101.sql(回滚)</li><li>db.tb.forward.101.sql(前滚)，<ul><li>否则是rollback.101.sql(回滚),forward.101.sql(前滚)</li></ul></li></ul></li><li>输出的结果是大家常见的易读形式的SQL，支持表名前是否加数据库名<ul><li>-d<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:34 database=test table=t1 binlog=mysql-bin.000012 startpos=21615 stoppos=22822</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:45 database=test table=t1 binlog=mysql-bin.000012 startpos=22822 stoppos=23930</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li></ol><p>否则为<br> </p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:34 database=test table=t1 binlog=mysql-bin.000012 startpos=21615 stoppos=22822</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:45 database=test table=t1 binlog=mysql-bin.000012 startpos=22822 stoppos=23930</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></tbody></table></figure><p></p><ol start="8"><li>输出结果支持是否保留事务<ul><li>-k<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:34 database=test table=t1 binlog=mysql-bin.000012 startpos=21615 stoppos=22822</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:45 database=test table=t1 binlog=mysql-bin.000012 startpos=22822 stoppos=23930</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></tbody></table></figure></li></ul></li></ol><p>不保留则是这样：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datetime=2019-06-15_00:14:34 database=test table=t1 binlog=mysql-bin.000012 startpos=21615 stoppos=22822</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:45 database=test table=t1 binlog=mysql-bin.000012 startpos=22822 stoppos=23930</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果复制因为特别大的事务而中断， 则可以以不保留事务的形式生成前滚的SQL, 在从库上执行， 然后跳过这个事务， 再启动复制， 免去重建从库的<br>麻烦， 特别是很大的库</p><ol start="9"><li>支持输出是否包含时间与binlog位置信息</li></ol><ul><li>-e</li></ul><ul><li>包含额外的信息则为<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datetime=2019-06-15_00:14:34 database=test table=t1 binlog=mysql-bin.000012 startpos=21615 stoppos=22822</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="comment"># datetime=2019-06-15_00:14:45 database=test table=t1 binlog=mysql-bin.000012 startpos=22822 stoppos=23930</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><p>否则为<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`name`</span>=<span class="literal">null</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><ol start="10"><li>支持生成的SQL只包含最少必须的字段, 前提下是表含有主键或者唯一索引</li></ol><ul><li><p>默认为</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`sa`</span>=<span class="number">1001</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure></li><li><p>-a 则为</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="string">`test`</span>.<span class="string">`t1`</span> <span class="keyword">SET</span> <span class="string">`id`</span>=<span class="number">5</span>, <span class="string">`age`</span>=<span class="number">21</span>, <span class="string">`sex`</span>=<span class="string">'M'</span>,<span class="string">`sa`</span>=<span class="number">1001</span>, <span class="string">`name`</span>=<span class="string">'test'</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span> <span class="keyword">and</span> <span class="string">`age`</span>=<span class="number">21</span> <span class="keyword">and</span> <span class="string">`sex`</span>=<span class="string">'M'</span> <span class="keyword">and</span> <span class="string">`sa`</span>=<span class="number">900</span> <span class="keyword">and</span> <span class="string">`name`</span>=<span class="string">'test'</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">WHERE</span> <span class="string">`id`</span>=<span class="number">5</span> <span class="keyword">and</span> <span class="string">`age`</span>=<span class="number">21</span> <span class="keyword">and</span> <span class="string">`sex`</span>=<span class="string">'M'</span> <span class="keyword">and</span> <span class="string">`sa`</span>=<span class="number">900</span> <span class="keyword">and</span> <span class="string">`name`</span>=<span class="string">'test'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><ol start="11"><li>支持优先使用唯一索引而不是主键来构建where条件<ul><li>-U</li><li>有时不希望使用主健来构建wheret条件， 如发生双写时， 自增主健冲突了， 这时使用非主健的唯一索引来避免生成的SQL主健冲突</li></ul></li><li>支持生成的insert语句不包含主健<ul><li>-I<ul><li>发生双写时， 自增主健冲突了， 这时使用这个参数来让生成的insert语句不包括主健来避免生成的SQL主健冲突</li></ul></li></ul></li><li><p>支持大insert拆分成小insert语句。</p><ul><li>-r 100</li></ul><ul><li>对于一个insert 1000行的插入， 会生成10个insert语句，每个语句插入100行</li></ul></li><li><p>支持非row格式binlog的解释</p><ul><li>当-w 2sql时加上参数-stsql，则会解释非row格式的DML语句。</li></ul><ul><li>由于不是支持所有要SQL， 如create trigger就不支持， 遇到SQL无法解释时会报错退出， 如需要跳过该SQL并继续解释， 请使用参数-ies。-ies 后接正则表达式，</li><li>解释错误或者无法解释的SQL如果匹配-ies指定的正则表达式， 则my2fback不会退出而是跳过该SQL继续解释后面的binlog， 否则错误退出。</li></ul><ul><li>-ies 后接的正则表达式请使用小写字母, my2fback会先把SQL转成小写再与之匹配。</li></ul></li></ol><h2 id="安装与下载"><a href="#安装与下载" class="headerlink" title="安装与下载"></a>安装与下载</h2><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>如果需要编译， 请使用GO>=1.11.x版本来编译。</p><ul><li><p>开启GO111MODULE参数</p><ul><li><p>编译linux 平台</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o releases/my2fback -ldflags <span class="string">"-s -w"</span> main.go</span><br></pre></td></tr></tbody></table></figure></li><li><p>编译windows 平台</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o releases/my2fback -ldflags <span class="string">"-s -w"</span> main.go</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p>没有开启GO111MODULE参数</p><ul><li><p>编译linux 平台</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o releases/my2fback -ldflags <span class="string">"-s -w"</span> main.go</span><br></pre></td></tr></tbody></table></figure></li><li><p>编译windows 平台</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o releases/my2fback -ldflags <span class="string">"-s -w"</span> main.go</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><ul><li>linux版本: <a href="https://github.com/WangJiemin/my2fback/blob/master/releases/my2fback" target="_blank" rel="noopener">linux_releases</a></li><li>windows版本:<a href="https://github.com/WangJiemin/my2fback/blob/master/releases/my2fback.exe" target="_blank" rel="noopener">windows_releases</a></li></ul><h2 id="使用帮助"><a href="#使用帮助" class="headerlink" title="使用帮助"></a>使用帮助</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># /usr/local/bin/my2fback -h</span></span><br><span class="line">my2fback V2.0 By WangJiemin.</span><br><span class="line">E_mail: 278667010@qq.com</span><br><span class="line"></span><br><span class="line">*****************************************************************************************************</span><br><span class="line">*system_command: /usr/<span class="built_in">local</span>/bin/my2fback*</span><br><span class="line">*system_goos: linux*</span><br><span class="line">*system_arch: amd64*</span><br><span class="line">*hostname: test_dbs2.yz.babytree-ops.org*</span><br><span class="line">*hostaddress: 10.10.1.221*</span><br><span class="line">*blog: https://jiemin.wang*</span><br><span class="line">*<span class="built_in">read</span> binlog from master, work as a fake slave: ./my2fback -m repl opts...*</span><br><span class="line">*<span class="built_in">read</span> binlog from <span class="built_in">local</span> filesystem: ./my2fback -m file opts... mysql-bin.000010*</span><br><span class="line">*****************************************************************************************************</span><br><span class="line"></span><br><span class="line">  -Cworks with -w=<span class="string">'stats'</span>, keep analyzing transations to last binlog <span class="keyword">for</span> -m=file, and keep analyzing <span class="keyword">for</span> -m=repl</span><br><span class="line">  -H string</span><br><span class="line">master host, DONOT need to specify when -w=stats. <span class="keyword">if</span> mode is file, it can be slave or other mysql contains same schema and table structure, not only master. default 127.0.0.1 (default <span class="string">"127.0.0.1"</span>)</span><br><span class="line">  -I<span class="keyword">for</span> insert statement when -wtype=2sql, ignore primary key</span><br><span class="line">  -M string</span><br><span class="line">valid options are:  mysql,mariadb. server of binlog, mysql or mariadb, default mysql (default <span class="string">"mysql"</span>)</span><br><span class="line">  -P uint</span><br><span class="line">master port, default 3306. DONOT need to specify when -w=stats (default 3306)</span><br><span class="line">  -S string</span><br><span class="line">mysql socket file</span><br><span class="line">  -Uprefer to use unique key instead of primary key to build <span class="built_in">where</span> condition <span class="keyword">for</span> delete/update sql</span><br><span class="line">  -aWorks with -w=2sql|rollback. <span class="keyword">for</span> update sql, include unchanged columns. <span class="keyword">for</span> update and delete, use all columns to build <span class="built_in">where</span> condition.</span><br><span class="line">default <span class="literal">false</span>, this is, use changed columns to build <span class="built_in">set</span> part, use primary/unique key to build <span class="built_in">where</span> condition</span><br><span class="line">  -b int</span><br><span class="line">transaction with affected rows greater or equal to this value is considerated as big transaction. Valid values range from 10 to 30000, default 500 (default 500)</span><br><span class="line">  -dWorks with -w=2sql|rollback. Prefix table name with database name <span class="keyword">in</span> sql, ex: insert into db1.tb1 (x1, x1) values (y1, y1). Default <span class="literal">true</span> (default <span class="literal">true</span>)</span><br><span class="line">  -dbs string</span><br><span class="line">only parse database <span class="built_in">which</span> match any of these regular expressions. The regular expression should be <span class="keyword">in</span> lower <span class="keyword">case</span> because database name is translated into lower <span class="keyword">case</span> and <span class="keyword">then</span> matched against it.</span><br><span class="line">Multi regular expressions is seperated by comma, default parse all databases. Useless when -w=stats</span><br><span class="line">  -dj string</span><br><span class="line">dump table structure to this file. default tabSchame.json (default <span class="string">"tabSchame.json"</span>)</span><br><span class="line">  -eWorks with -w=2sql|rollback. Print database/table/datetime/binlogposition...info on the line before sql, default <span class="literal">false</span></span><br><span class="line">  -ebin string</span><br><span class="line">binlog file to stop reading</span><br><span class="line">  -edt string</span><br><span class="line">Stop reading the binlog at first event having a datetime equal or posterior to the argument, it should be like this: <span class="string">"2004-12-25 11:25:56"</span></span><br><span class="line">  -epos uint</span><br><span class="line">Stop reading the binlog at position</span><br><span class="line">  -fWorks with -w=2sql|rollback. one file <span class="keyword">for</span> one table <span class="keyword">if</span> <span class="literal">true</span>, <span class="keyword">else</span> one file <span class="keyword">for</span> all tables. default <span class="literal">false</span>. Attention, always one file <span class="keyword">for</span> one binlog</span><br><span class="line">  -i int</span><br><span class="line">works with -w=<span class="string">'stats'</span>, <span class="built_in">print</span> stats info each PrintInterval. Valid values range from 1 to 600, default 30 (default 30)</span><br><span class="line">  -ies string</span><br><span class="line"><span class="keyword">for</span> sql <span class="built_in">which</span> is error to parsed and matched by this regular expression, just <span class="built_in">print</span> error info, skip it and <span class="built_in">continue</span> parsing, otherwise stop parsing and <span class="built_in">exit</span>.</span><br><span class="line">The regular expression should be <span class="keyword">in</span> lower <span class="keyword">case</span>, because sql is translated into lower <span class="keyword">case</span> and <span class="keyword">then</span> matched against it. (default <span class="string">"^create definer.+trigger"</span>)</span><br><span class="line">  -kWorks with -w=2sql|rollback. wrap result statements with <span class="string">'begin...commit|rollback'</span></span><br><span class="line">  -l int</span><br><span class="line">transaction with duration greater or equal to this value is considerated as long transaction. Valid values range from 1 to 3600, default 300 (default 300)</span><br><span class="line">  -m string</span><br><span class="line">valid options are:  repl,file. repl: as a slave to get binlogs from master. file: get binlogs from <span class="built_in">local</span> filesystem. default file (default <span class="string">"file"</span>)</span><br><span class="line">  -mid uint</span><br><span class="line">works with -m=repl, this program replicates from master as slave to <span class="built_in">read</span> binlogs. Must <span class="built_in">set</span> this server id unique from other slaves, default 1113306 (default 1113306)</span><br><span class="line">  -o string</span><br><span class="line">result output dir, default current work dir. Attension, result files could be large, <span class="built_in">set</span> it to a dir with large free space</span><br><span class="line">  -oj</span><br><span class="line">Only use table structure from -rj, <span class="keyword">do</span> not get or merge table struct from mysql</span><br><span class="line">  -ors</span><br><span class="line"><span class="keyword">for</span> mysql>=5.6.2 and binlog_rows_query_log_events=on, <span class="keyword">if</span> <span class="built_in">set</span>, output original sql. default <span class="literal">false</span></span><br><span class="line">  -p string</span><br><span class="line">mysql user password. DONOT need to specify when -w=stats</span><br><span class="line">  -r int</span><br><span class="line">Works with -w=2sql|rollback. rows <span class="keyword">for</span> each insert sql. Valid values range from 1 to 500, default 30 (default 30)</span><br><span class="line">  -rj string</span><br><span class="line">Works with -w=2sql|rollback, <span class="built_in">read</span> table structure from this file and merge from mysql</span><br><span class="line">  -sbin string</span><br><span class="line">binlog file to start reading</span><br><span class="line">  -sdt string</span><br><span class="line">Start reading the binlog at first event having a datetime equal or posterior to the argument, it should be like this: <span class="string">"2004-12-25 11:25:56"</span></span><br><span class="line">  -spos uint</span><br><span class="line">start reading the binlog at position</span><br><span class="line">  -sql string</span><br><span class="line">valid options are:  insert,update,delete. only parse these types of sql, comma seperated, valid types are: insert, update, delete; default is all(insert,update,delete)</span><br><span class="line">  -stsql</span><br><span class="line">when -w=2sql, also parse plain sql and write into result file even <span class="keyword">if</span> binlog_format is not row. default <span class="literal">false</span></span><br><span class="line">  -t uint</span><br><span class="line">Works with -w=2sql|rollback. threads to run, default 4 (default 2)</span><br><span class="line">  -tbs string</span><br><span class="line">only parse table <span class="built_in">which</span> match any of these regular expressions.The regular expression should be <span class="keyword">in</span> lower <span class="keyword">case</span> because database name is translated into lower <span class="keyword">case</span> and <span class="keyword">then</span> matched against it.</span><br><span class="line"> Multi regular expressions is seperated by comma, default parse all tables. Useless when -w=stats</span><br><span class="line">  -tl string</span><br><span class="line">time location to parse timestamp/datetime column <span class="keyword">in</span> binlog, such as Asia/Shanghai. default Local (default <span class="string">"Local"</span>)</span><br><span class="line">  -u string</span><br><span class="line">mysql user. DONOT need to specify when -w=stats</span><br><span class="line">  -v<span class="built_in">print</span> version</span><br><span class="line">  -w string</span><br><span class="line">valid options are:  tbldef,stats,2sql,rollback. tbldef: only get table definition structure; 2sql: convert binlog to sqls, rollback: generate rollback sqls, stats: analyze transactions. default: stats (default <span class="string">"stats"</span>)</span><br><span class="line">test_dbs2 ~ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p><strong><code>常用参数</code></strong><br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">-m string</span><br><span class="line">valid options are:  repl,file. repl: as a slave to get binlogs from master. file: get binlogs from <span class="built_in">local</span> filesystem. default file (default <span class="string">"file"</span>)</span><br><span class="line">relp: 模仿 SLAVE 的IO_THREAD连接到MASTER获取BINLOG EVENT</span><br><span class="line">file: 解析本地的BINLOG(default: file)</span><br><span class="line">-w string</span><br><span class="line">valid options are:  tbldef,stats,2sql,rollback. tbldef: only get table definition structure; 2sql: convert binlog to sqls, rollback: generate rollback sqls, stats: analyze transactions. default: stats (default <span class="string">"stats"</span>)</span><br><span class="line">2sql: 解析成SQL语句</span><br><span class="line">rollback: 解析为回滚语句</span><br><span class="line">-M string</span><br><span class="line">valid options are:  mysql,mariadb. server of binlog, mysql or mariadb, default mysql (default <span class="string">"mysql"</span>)</span><br><span class="line">选择是MySQL还是Mariadb, 不选择默认为MySQL</span><br><span class="line">-e  Works with -w=2sql|rollback. Print database/table/datetime/binlogposition...info on the line before sql, default <span class="literal">false</span></span><br><span class="line"> 在sql之前的行上打印database/table/datetime/binlogposition...info，默认为<span class="literal">false</span></span><br><span class="line">-f  Works with -w=2sql|rollback. one file <span class="keyword">for</span> one table <span class="keyword">if</span> <span class="literal">true</span>, <span class="keyword">else</span> one file <span class="keyword">for</span> all tables. default <span class="literal">false</span>. Attention, always one file <span class="keyword">for</span> one binlog</span><br><span class="line"> 如果为<span class="literal">true</span>，则为一个表的一个文件，否则为所有表的一个文件。默认为<span class="literal">false</span>。注意，一个binlog总是一个文件</span><br><span class="line">-r int</span><br><span class="line">Works with -w=2sql|rollback. rows <span class="keyword">for</span> each insert sql. Valid values range from 1 to 500, default 30 (default 30)</span><br><span class="line">INSERT SQL 语句每一行包含的values的行数</span><br><span class="line">-t uint</span><br><span class="line">Works with -w=2sql|rollback. threads to run, default 4 (default 2)</span><br><span class="line">开启几个thread进行来执行解析2sql|rollback</span><br><span class="line">-o string</span><br><span class="line">result output dir, default current work dir. Attension, result files could be large, <span class="built_in">set</span> it to a dir with large free space</span><br><span class="line">输入的目录</span><br><span class="line">-k  Works with -w=2sql|rollback. wrap result statements with <span class="string">'begin...commit|rollback'</span></span><br><span class="line"> 使用-w = 2sql | rollback。使用<span class="string">'begin ... commit | rollback'</span>包装结果语句</span><br><span class="line">-l int</span><br><span class="line">transaction with duration greater or equal to this value is considerated as long transaction. Valid values range from 1 to 3600, default 300 (default 300)</span><br><span class="line"> </span><br><span class="line">-b int</span><br><span class="line">transaction with affected rows greater or equal to this value is considerated as big transaction. Valid values range from 10 to 30000, default 500 (default 500)</span><br><span class="line"></span><br><span class="line">-dWorks with -w=2sql|rollback. Prefix table name with database name <span class="keyword">in</span> sql, ex: insert into db1.tb1 (x1, x1) values (y1, y1). Default <span class="literal">true</span> (default <span class="literal">true</span>)</span><br><span class="line"> 使用-w=2sql|rollback。在sql中具有数据库名称的前缀表名</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><ul><li><p>测试机器</p><ul><li>CPU 2c</li><li>内存 4G</li><li>磁盘 400G</li></ul></li><li><p>file本地方式解析binlog</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># time /usr/local/bin/my2fback -m file -w 2sql -M mysql -t 6 -H ***.***.***.*** -u test -p test -dbs babytree -tbs userbaby -e -f -d -r 20 -k -b 100 -l 10  -o /data/bak/20190626/tosql /data/bak/20190626/mysql-bin.002938</span></span><br></pre></td></tr></tbody></table></figure></li></ul><img src="/2019/07/17/my2fback/file_jiexi.png" title="file_jiexi"><img src="/2019/07/17/my2fback/file_jiexi_end.png" title="file_jiexi"><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># ls /data/bak/20190626/tosql/</span></span><br></pre></td></tr></tbody></table></figure><img src="/2019/07/17/my2fback/file_2sql_output.png" title="file_jiexi"><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># cat /data/bak/20190626/tosql/babytree.UserBaby.forward.2938.sql |more</span></span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:18 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=79686 stoppos=80034</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `name`=<span class="string">'双双'</span>, `update_ts`=1561512918, `extra`=<span class="string">'{\"born_preg_week\":30,\"born_preg_day\":5,\"is_premature\":0,\"born_height\":0,\"born_weight\":0,\"is_only_child\":0}'</span> WHE</span><br><span class="line">RE `id`=83758158;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:18 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=121354 stoppos=121552</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `birthday`=1582905600, `gender`=3, `update_ts`=1561512918, `extra`=<span class="string">'{\"is_premature\":0}'</span> WHERE `id`=87162805;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:18 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=128088 stoppos=128234</span></span><br><span class="line">INSERT INTO `babytree`.`UserBaby` (`id`,`user_id`,`name`,`birthday`,`gender`,`is_default`,`state`,`photo_url`,`text_info`,`create_ts`,`update_ts`,`baby_status`,`extra`) VALUES (87163008,87041217,<span class="string">''</span>,0,1,1,</span><br><span class="line">1,<span class="string">''</span>,<span class="string">''</span>,1561512918,1561512918,1,<span class="string">''</span>);</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:19 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=159954 stoppos=160134</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `gender`=0, `update_ts`=1561512919 WHERE `id`=87163008;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:19 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=251027 stoppos=251207</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `update_ts`=1561512919 WHERE `id`=87163007;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:20 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=342791 stoppos=342971</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `update_ts`=1561512920 WHERE `id`=87163008;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:22 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=607938 stoppos=608256</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `birthday`=1560268800, `gender`=1, `update_ts`=1561512922, `baby_status`=3, `extra`=<span class="string">'{\"born_height\":0,\"born_weight\":0,\"is_premature\":0,\"born_preg_week\":39,\"born_p</span></span><br><span class="line"><span class="string">reg_day\":0}'</span> WHERE `id`=81204050;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:22 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=628699 stoppos=628897</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `birthday`=-192551296, `gender`=3, `update_ts`=1561512922, `extra`=<span class="string">'{\"is_premature\":0}'</span> WHERE `id`=87162871;</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:22 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=631950 stoppos=632130</span></span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `update_ts`=1561512922 WHERE `id`=84567514;</span><br><span class="line">commit;</span><br></pre></td></tr></tbody></table></figure><ul><li>file本地方式回滚binlog<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">est_dbs2 ~ <span class="comment"># time /usr/local/bin/my2fback -m file -w rollback -M mysql -t 6 -H ***.***.***.*** -u test -p test -dbs babytree -tbs userbaby -e -f -d -r 20 -k -b 100 -l 10  -o /data/bak/20190626/tosql /data/bak/20190626/mysql-bin.002938</span></span><br></pre></td></tr></tbody></table></figure></li></ul><p><strong><code>-w 修改为 rollback</code></strong><br><img src="/2019/07/17/my2fback/rollback_start.png" title="file_jiexi"><br><img src="/2019/07/17/my2fback/rollback_end.png" title="file_jiexi"><br><img src="/2019/07/17/my2fback/rollback_wenjian.png" title="file_jiexi"></p><p>看上面解析的SQl,用grep 进行搜索下，是不是回滚对了。还有一定要和<strong>业务方确认，业务方确认，业务方确认</strong>。重要的事情说三遍<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># cat /data/bak/20190626/tosql/babytree.UserBaby.rollback.2938.sql|grep -C 2 83758158</span></span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `name`=<span class="string">''</span>, `update_ts`=1548426675, `extra`=<span class="string">'{\"born_preg_week\":30,\"born_preg_day\":5,\"is_premature\":0}'</span> WHERE `id`=83758158;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:18 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=79686 stoppos=80034</span></span><br><span class="line">commit;</span><br><span class="line">test_dbs2 ~ <span class="comment"># cat /data/bak/20190626/tosql/babytree.UserBaby.rollback.2938.sql|grep -C 2 87163008</span></span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `birthday`=0, `gender`=0, `update_ts`=1561512920, `baby_status`=1, `extra`=<span class="string">''</span> WHERE `id`=87163008;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:36:41 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=9292334 stoppos=9292532</span></span><br><span class="line">commit;</span><br><span class="line">--</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `update_ts`=1561512919 WHERE `id`=87163008;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:20 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=342791 stoppos=342971</span></span><br><span class="line">commit;</span><br><span class="line">--</span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line">UPDATE `babytree`.`UserBaby` SET `gender`=1, `update_ts`=1561512918 WHERE `id`=87163008;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:19 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=159954 stoppos=160134</span></span><br><span class="line">commit;</span><br><span class="line">begin;</span><br><span class="line">DELETE FROM `babytree`.`UserBaby` WHERE `id`=87163008;</span><br><span class="line"><span class="comment"># datetime=2019-06-26_09:35:18 database=babytree table=UserBaby binlog=mysql-bin.002938 startpos=128088 stoppos=128234</span></span><br><span class="line">commit;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>relp 方式解析binlog</li></ul><ul><li>数据库上的binlog文件起始文件和结束文件<img src="/2019/07/17/my2fback/binlog_totle.png" title="binlog_totle"></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># time /usr/local/bin/my2fback -m repl -w 2sql -M mysql -t 6 -H ***.***.***.*** -u test -p test -dbs babytree -tbs userbaby -e -f -d -r 20 -k -b 100 -l 10 -sbin mysql-bin.003045 -spos 4 -ebin mysql-bin.003079 -epos 4 -o /data/bak/20190626/tosql/</span></span><br></pre></td></tr></tbody></table></figure><p>系统资源<br><img src="/2019/07/17/my2fback/top.png" title="top"></p><p>执行截图</p><img src="/2019/07/17/my2fback/repl_jiexi_start.png" title="repl_jiexi_start"><img src="/2019/07/17/my2fback/repl_jiexi1.png" title="repl_jiexi1"><img src="/2019/07/17/my2fback/repl_jiexi_end.png" title="repl_end"><blockquote><p>binlog文件共计有36个。文件大小为36G。解析时间:57m24.978s</p></blockquote><ul><li>repl 方式回滚binlog<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># time /usr/local/bin/my2fback -m repl -w rollback -M mysql -t 6 -H ***.***.***.*** -u test -p test -dbs babytree -tbs userbaby -e -f -d -r 20 -k -b 100 -l 10 -sbin mysql-bin.003045 -spos 4 -ebin mysql-bin.003045 -epos 888888 -o /data/bak/20190626/tosql/</span></span><br></pre></td></tr></tbody></table></figure></li></ul><p>就不贴图了。和file方式一致。</p><blockquote><p>解析文件可以是一个时间范围，也可以是一个positiions范围。</p></blockquote><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>一个小菜鸟撸的菜鸟工具，如果有BUG。请大家多多包容。</p><p>测试通过，已经在宝宝树线上使用。累计恢复数据120G。</p><p>如果不放心。请使用binlog2sql。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;tupian.jpeg&quot; class=&quot;full-image&quot; alt
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Linux 常用yum源整理</title>
    <link href="https://jiemin.wang/2019/06/05/linux-yumReposSummary/"/>
    <id>https://jiemin.wang/2019/06/05/linux-yumReposSummary/</id>
    <published>2019-06-05T02:48:58.000Z</published>
    <updated>2019-06-05T02:59:17.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="fm461.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>出卖自己的灵魂和原则并不丢人，丢人的是没能卖一个好价钱。</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CentOS系统带有几个官方源，默认启用的仅有base, updates和extras三个。如果希望从源安装Nginx，高版本的gcc/PHP等软件，则要导入提供软件包的第三方源。本文整理常见的第三方yum源，并以CentOS 7为例介绍其安装方法。</p><h2 id="第三方yum源"><a href="#第三方yum源" class="headerlink" title="第三方yum源"></a>第三方yum源</h2><h4 id="EPEL"><a href="#EPEL" class="headerlink" title="EPEL"></a>EPEL</h4><p>EPEL是Extra Packages for Enterprise Linux的缩写，其为EL6或EL7提供重建的Fedora组件，并且不会替换base中的包。EPEL算得上是最著名的第三方软件源，几乎各个云服务器厂商提供的CentOS 系统均会自带该源并默认启用。其收录了web中常用的Nginx软件包。</p><p>EPEL的官网是：<a href="http://fedoraproject.org/wiki/EPEL，可以通过`yum" target="_blank" rel="noopener">http://fedoraproject.org/wiki/EPEL，可以通过`yum</a> install -y epel-release`安装。</p><h4 id="SCL"><a href="#SCL" class="headerlink" title="SCL"></a>SCL</h4><p>SCL是Software Collections的缩写，由CentOS 特别兴趣小组所维护。其收录了许多程序的新版本，例如gcc, PHP, git, python等。安装的软件可与旧版共存，包名多以rh-为前缀。</p><p>SCL的官网是<a href="https://www.softwarecollections.org，CentOS" target="_blank" rel="noopener">https://www.softwarecollections.org，CentOS</a> 7的安装方法是：<code>yum install centos-release-scl</code>。安装完成后在<code>/etc/yum.repos.d</code>目录下会出现<code>CentOS-SCLo-scl.repo</code>和<code>CentOS-SCLo-scl-rh.repo</code>两个文件。安装后源默认启用。</p><h4 id="ELRepo"><a href="#ELRepo" class="headerlink" title="ELRepo"></a>ELRepo</h4><p>ELRepo是The Community Enterprise Linux Repository的缩写，旨在提供驱动程序来增强系统的硬件支持（包括：显示、文件系统、硬件监控、网络、音效、网络摄像镜驱动程序）。也提供较新版的内核，例如支持BBR算法的4.9+内核。</p><p>ELRepo的官方是<a href="http://elrepo.org/，CentOS" target="_blank" rel="noopener">http://elrepo.org/，CentOS</a> 7系统的安装方法是：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br></pre></td></tr></tbody></table></figure><p></p><p>安装完成后在<code>/etc/yum.repos.d</code>目录下出现<code>elrepo.repo</code>文件，可编辑文件中的<code>enable</code>的值启用具体仓库，也可在运行时用<code>--enablerepo="xxx"</code>指定使用的软件库。</p><h4 id="IUS"><a href="#IUS" class="headerlink" title="IUS"></a>IUS</h4><p>IUS的官网是<a href="https://ius.io/，旨在为RHEL和CentOS提供高质量、最新版的软件，如PHP" target="_blank" rel="noopener">https://ius.io/，旨在为RHEL和CentOS提供高质量、最新版的软件，如PHP</a>, Python, MySQL等。CentOS 7安装该源的命令为：<code>rpm -Uvh https://centos7.iuscommunity.org/ius-release.rpm</code>。</p><h4 id="RPMfusion"><a href="#RPMfusion" class="headerlink" title="RPMfusion"></a>RPMfusion</h4><p>RPMfusion提供Fedora Project或 Red Hat不愿发行的软件，包含“免费（开源软件）”和“非免费（源代码可公开获取但不开源且限非商业用途）”两种类型的仓库。</p><p>RPMfusion的官网是<a href="https://rpmfusion.org/，CentOS" target="_blank" rel="noopener">https://rpmfusion.org/，CentOS</a> 7的安装方法是：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 免费库</span></span><br><span class="line">yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm</span><br><span class="line"><span class="comment"># 非免费库</span></span><br><span class="line">yum localinstall --nogpgcheck https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-7.noarch.rpm</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Remi"><a href="#Remi" class="headerlink" title="Remi"></a>Remi</h4><p>Remi维护大量组件，包括最新版的PHP, GLPI等。Remi的safe仓库不会替代系统的基本组件，但remi-phpxx.repo中的软件包会替代系统默认的php。需要注意的是Remi可能会与IUS的软件包冲突，因为双方都提供最新版的PHP。</p><p>Remi的官方网站是<a href="http://rpms.remirepo.net/，CentOS" target="_blank" rel="noopener">http://rpms.remirepo.net/，CentOS</a> 7的安装方法是：<code>yum install -y remi-release</code>。</p><h4 id="Webtatic"><a href="#Webtatic" class="headerlink" title="Webtatic"></a>Webtatic</h4><p>提供较新版的PHP、MySQL及其它组件。建议用IUS或SCL代替。</p><h4 id="软件官方维护的源"><a href="#软件官方维护的源" class="headerlink" title="软件官方维护的源"></a>软件官方维护的源</h4><p>除上述收录多个软件包的综合源外，还有许多由软件官方维护的源，例如<code>Nginx</code>, <code>Gitlab</code>, <code>Nodejs</code>等。这些源的安装和使用方法请参考官方指南。</p><h4 id="源管理"><a href="#源管理" class="headerlink" title="源管理"></a>源管理</h4><p>源的配置文件均位于<code>/etc/yum.repos.d</code>目录下，可用<code>vim</code>, <code>nano</code>等编辑器打开配置文件并编辑。</p><p>一些有用的源管理yum命令：</p><ul><li><code>yum repolist</code>： 列出所有启用的源, 等同于<code>yum repolist enabled</code>；</li><li><code>yum repolist disabled</code>： 列出所有禁用的源；</li><li><code>yum repoinfo [enabled|disabled]</code>：列出启用（禁用）源的更详细信息</li><li><code>yum --disablerepo="*" --enablerepo="xxxx" install/search</code>: 从指定源安装/搜索软件；<code>"–disablerepo"</code>和<code>"–enablerepo"</code>选项可独立或配合使用，动态启用和禁用源。</li></ul><h4 id="国内镜像"><a href="#国内镜像" class="headerlink" title="国内镜像"></a>国内镜像</h4><p>因为某些原因，从位于境外的源镜像安装软件慢的让人抓狂。如果遇到了此种情形，建议使用代理，或者配置源的地址为国内镜像的地址。国内知名的yum源镜像站有：</p><ol><li>阿里云，网址：<a href="https://opsx.alibaba.com/mirror" target="_blank" rel="noopener">https://opsx.alibaba.com/mirror</a></li><li>网易163，网址：<a href="http://mirrors.163.com/" target="_blank" rel="noopener">http://mirrors.163.com/</a></li><li>清华大学，网址：<a href="http://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener">http://mirrors.tuna.tsinghua.edu.cn/</a></li><li>中科大，网址：<a href="http://mirrors.ustc.edu.cn/" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/</a></li><li>浙大，网址：<a href="http://mirrors.zju.edu.cn/" target="_blank" rel="noopener">http://mirrors.zju.edu.cn/</a></li></ol><p>具体仓库的配置方法请参考站内指南。需要注意的是并非所有的镜像都包含上述列出的yum源，本人推荐阿里云、清华大学、中科大镜像站。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="https://wiki.centos.org/zh/AdditionalResources/Repositories" target="_blank" rel="noopener">https://wiki.centos.org/zh/AdditionalResources/Repositories</a></li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;fm461.jpg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>DBA不可不知的操作系统内核参数</title>
    <link href="https://jiemin.wang/2019/05/24/Linux-systemctl-variables/"/>
    <id>https://jiemin.wang/2019/05/24/Linux-systemctl-variables/</id>
    <published>2019-05-24T10:15:37.000Z</published>
    <updated>2019-05-24T10:20:47.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="images.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>每当我找到成功的钥匙，就发现有人把锁芯给换了。</strong></p></blockquote><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>操作系统为了适应更多的硬件环境，许多初始的设置值，宽容度都很高。    </p><p>如果不经调整，这些值可能无法适应HPC，或者硬件稍好些的环境。    </p><p>无法发挥更好的硬件性能，甚至可能影响某些应用软件的使用，特别是数据库。    </p><h2 id="数据库关心的OS内核参数"><a href="#数据库关心的OS内核参数" class="headerlink" title="数据库关心的OS内核参数"></a>数据库关心的OS内核参数</h2><p>512GB 内存为例      </p><p>1.     </p><p>  参数      </p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br></pre></td><td class="code"><pre><span class="line">fs.aio-max-nr  </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">  支持系统      </span><br><span class="line">  </span><br><span class="line">```    </span><br><span class="line">CentOS 6, 7       </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">  参数解释      </span><br><span class="line">  </span><br><span class="line">```    </span><br><span class="line">aio-nr & aio-max-nr:    </span><br><span class="line">.  </span><br><span class="line">aio-nr is the running total of the number of events specified on the    </span><br><span class="line">io_setup system call for all currently active aio contexts.    </span><br><span class="line">.  </span><br><span class="line">If aio-nr reaches aio-max-nr then io_setup will fail with EAGAIN.    </span><br><span class="line">.  </span><br><span class="line">Note that raising aio-max-nr does not result in the pre-allocation or re-sizing    </span><br><span class="line">of any kernel data structures.    </span><br><span class="line">.  </span><br><span class="line">aio-nr & aio-max-nr:    </span><br><span class="line">.  </span><br><span class="line">aio-nr shows the current system-wide number of asynchronous io requests.    </span><br><span class="line">.  </span><br><span class="line">aio-max-nr allows you to change the maximum value aio-nr can grow to.    </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">  推荐设置       </span><br><span class="line">  </span><br><span class="line">```    </span><br><span class="line">fs.aio-max-nr = 1xxxxxx  </span><br><span class="line">.  </span><br><span class="line">PostgreSQL, Greenplum 均未使用io_setup创建aio contexts. 无需设置。    </span><br><span class="line">如果Oracle数据库，要使用aio的话，需要设置它。    </span><br><span class="line">设置它也没什么坏处，如果将来需要适应异步IO，可以不需要重新修改这个设置。   </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">2\.     </span><br><span class="line">  </span><br><span class="line">  参数       </span><br><span class="line">  </span><br><span class="line">```    </span><br><span class="line">fs.file-max  </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">  支持系统      </span><br><span class="line">  </span><br><span class="line">```    </span><br><span class="line">CentOS 6, 7       </span><br><span class="line">```    </span><br><span class="line">      </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">file-max & file-nr:    </span><br><span class="line">.  </span><br><span class="line">The value in file-max denotes the maximum number of file handles that the Linux kernel will allocate.   </span><br><span class="line">.  </span><br><span class="line">When you get lots of error messages about running out of file handles,   </span><br><span class="line">you might want to increase this limit.    </span><br><span class="line">.  </span><br><span class="line">Historically, the kernel was able to allocate file handles dynamically,   </span><br><span class="line">but not to free them again.     </span><br><span class="line">.  </span><br><span class="line">The three values in file-nr denote :      </span><br><span class="line">the number of allocated file handles ,     </span><br><span class="line">the number of allocated but unused file handles ,     </span><br><span class="line">the maximum number of file handles.     </span><br><span class="line">.  </span><br><span class="line">Linux 2.6 always reports 0 as the number of free    </span><br><span class="line">file handles -- this is not an error, it just means that the    </span><br><span class="line">number of allocated file handles exactly matches the number of    </span><br><span class="line">used file handles.    </span><br><span class="line">.  </span><br><span class="line">Attempts to allocate more file descriptors than file-max are reported with printk,   </span><br><span class="line">look for "VFS: file-max limit <number> reached".    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">fs.file-max = 7xxxxxxx  </span><br><span class="line">.  </span><br><span class="line">PostgreSQL 有一套自己管理的VFS，真正打开的FD与内核管理的文件打开关闭有一套映射的机制，所以真实情况不需要使用那么多的file handlers。     </span><br><span class="line">max_files_per_process 参数。     </span><br><span class="line">假设1GB内存支撑100个连接，每个连接打开1000个文件，那么一个PG实例需要打开10万个文件，一台机器按512G内存来算可以跑500个PG实例，则需要5000万个file handler。     </span><br><span class="line">以上设置绰绰有余。     </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">3\.    </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.core_pattern  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7       </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">core_pattern:    </span><br><span class="line">.  </span><br><span class="line">core_pattern is used to specify a core dumpfile pattern name.    </span><br><span class="line">. max length 128 characters; default value is "core"    </span><br><span class="line">. core_pattern is used as a pattern template for the output filename;    </span><br><span class="line">  certain string patterns (beginning with '%') are substituted with    </span><br><span class="line">  their actual values.    </span><br><span class="line">. backward compatibility with core_uses_pid:    </span><br><span class="line">        If core_pattern does not include "%p" (default does not)    </span><br><span class="line">        and core_uses_pid is set, then .PID will be appended to    </span><br><span class="line">        the filename.    </span><br><span class="line">. corename format specifiers:    </span><br><span class="line">        %<NUL>  '%' is dropped    </span><br><span class="line">        %%      output one '%'    </span><br><span class="line">        %p      pid    </span><br><span class="line">        %P      global pid (init PID namespace)    </span><br><span class="line">        %i      tid    </span><br><span class="line">        %I      global tid (init PID namespace)    </span><br><span class="line">        %u      uid    </span><br><span class="line">        %g      gid    </span><br><span class="line">        %d      dump mode, matches PR_SET_DUMPABLE and    </span><br><span class="line">                /proc/sys/fs/suid_dumpable    </span><br><span class="line">        %s      signal number    </span><br><span class="line">        %t      UNIX time of dump    </span><br><span class="line">        %h      hostname    </span><br><span class="line">        %e      executable filename (may be shortened)    </span><br><span class="line">        %E      executable path    </span><br><span class="line">        %<OTHER> both are dropped    </span><br><span class="line">. If the first character of the pattern is a '|', the kernel will treat    </span><br><span class="line">  the rest of the pattern as a command to run.  The core dump will be    </span><br><span class="line">  written to the standard input of that program instead of to a file.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.core_pattern = /xxx/core_%e_%u_%t_%s.%p    </span><br><span class="line">.  </span><br><span class="line">这个目录要777的权限，如果它是个软链，则真实目录需要777的权限  </span><br><span class="line">mkdir /xxx  </span><br><span class="line">chmod 777 /xxx  </span><br><span class="line">留足够的空间  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">4\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.sem   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7       </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.sem = 4096 2147483647 2147483646 512000    </span><br><span class="line">.  </span><br><span class="line">4096 每组多少信号量 (>=17, PostgreSQL 每16个进程一组, 每组需要17个信号量) ,     </span><br><span class="line">2147483647 总共多少信号量 (2^31-1 , 且大于4096*512000 ) ,     </span><br><span class="line">2147483646 每个semop()调用支持多少操作 (2^31-1),     </span><br><span class="line">512000 多少组信号量 (假设每GB支持100个连接, 512GB支持51200个连接, 加上其他进程, > 51200*2/16 绰绰有余)     </span><br><span class="line">.  </span><br><span class="line"># sysctl -w kernel.sem="4096 2147483647 2147483646 512000"    </span><br><span class="line">.  </span><br><span class="line"># ipcs -s -l    </span><br><span class="line">  ------ Semaphore Limits --------    </span><br><span class="line">max number of arrays = 512000    </span><br><span class="line">max semaphores per array = 4096    </span><br><span class="line">max semaphores system wide = 2147483647    </span><br><span class="line">max ops per semop call = 2147483646    </span><br><span class="line">semaphore max value = 32767    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.sem = 4096 2147483647 2147483646 512000    </span><br><span class="line">.  </span><br><span class="line">4096可能能够适合更多的场景, 所以大点无妨，关键是512000 arrays也够了。    </span><br><span class="line">```  </span><br><span class="line">      </span><br><span class="line">5\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.shmall = 107374182    </span><br><span class="line">kernel.shmmax = 274877906944    </span><br><span class="line">kernel.shmmni = 819200    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7        </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">假设主机内存 512GB    </span><br><span class="line">.  </span><br><span class="line">shmmax 单个共享内存段最大 256GB (主机内存的一半，单位字节)      </span><br><span class="line">shmall 所有共享内存段加起来最大 (主机内存的80%，单位PAGE)      </span><br><span class="line">shmmni 一共允许创建819200个共享内存段 (每个数据库启动需要2个共享内存段。  将来允许动态创建共享内存段，可能需求量更大)     </span><br><span class="line">.  </span><br><span class="line"># getconf PAGE_SIZE    </span><br><span class="line">4096    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">kernel.shmall = 107374182    </span><br><span class="line">kernel.shmmax = 274877906944    </span><br><span class="line">kernel.shmmni = 819200    </span><br><span class="line">.  </span><br><span class="line">9.2以及以前的版本，数据库启动时，对共享内存段的内存需求非常大，需要考虑以下几点  </span><br><span class="line">Connections:(1800 + 270 * max_locks_per_transaction) * max_connections  </span><br><span class="line">Autovacuum workers:(1800 + 270 * max_locks_per_transaction) * autovacuum_max_workers  </span><br><span class="line">Prepared transactions:(770 + 270 * max_locks_per_transaction) * max_prepared_transactions  </span><br><span class="line">Shared disk buffers:(block_size + 208) * shared_buffers  </span><br><span class="line">WAL buffers:(wal_block_size + 8) * wal_buffers  </span><br><span class="line">Fixed space requirements:770 kB  </span><br><span class="line">.  </span><br><span class="line">以上建议参数根据9.2以前的版本设置，后期的版本同样适用。  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">6\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.netdev_max_backlog  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7     </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">netdev_max_backlog    </span><br><span class="line">  ------------------    </span><br><span class="line">Maximum number  of  packets,  queued  on  the  INPUT  side,    </span><br><span class="line">when the interface receives packets faster than kernel can process them.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.netdev_max_backlog=1xxxx    </span><br><span class="line">.  </span><br><span class="line">INPUT链表越长，处理耗费越大，如果用了iptables管理的话，需要加大这个值。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">7\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.rmem_default  </span><br><span class="line">net.core.rmem_max  </span><br><span class="line">net.core.wmem_default  </span><br><span class="line">net.core.wmem_max  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7     </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">rmem_default    </span><br><span class="line">  ------------    </span><br><span class="line">The default setting of the socket receive buffer in bytes.    </span><br><span class="line">.  </span><br><span class="line">rmem_max    </span><br><span class="line">  --------    </span><br><span class="line">The maximum receive socket buffer size in bytes.    </span><br><span class="line">.  </span><br><span class="line">wmem_default    </span><br><span class="line">  ------------    </span><br><span class="line">The default setting (in bytes) of the socket send buffer.    </span><br><span class="line">.  </span><br><span class="line">wmem_max    </span><br><span class="line">  --------    </span><br><span class="line">The maximum send socket buffer size in bytes.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.rmem_default = 262144    </span><br><span class="line">net.core.rmem_max = 4194304    </span><br><span class="line">net.core.wmem_default = 262144    </span><br><span class="line">net.core.wmem_max = 4194304    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">8\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.somaxconn   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7        </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">somaxconn - INTEGER    </span><br><span class="line">        Limit of socket listen() backlog, known in userspace as SOMAXCONN.    </span><br><span class="line">        Defaults to 128.    </span><br><span class="line">See also tcp_max_syn_backlog for additional tuning for TCP sockets.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.core.somaxconn=4xxx    </span><br><span class="line">```  </span><br><span class="line">      </span><br><span class="line">9\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_max_syn_backlog  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_max_syn_backlog - INTEGER    </span><br><span class="line">        Maximal number of remembered connection requests, which have not    </span><br><span class="line">        received an acknowledgment from connecting client.    </span><br><span class="line">        The minimal value is 128 for low memory machines, and it will    </span><br><span class="line">        increase in proportion to the memory of machine.    </span><br><span class="line">        If server suffers from overload, try increasing this number.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_max_syn_backlog=4xxx    </span><br><span class="line">pgpool-II 使用了这个值，用于将超过num_init_child以外的连接queue。     </span><br><span class="line">所以这个值决定了有多少连接可以在队列里面等待。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">10\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_keepalive_intvl=20    </span><br><span class="line">net.ipv4.tcp_keepalive_probes=3    </span><br><span class="line">net.ipv4.tcp_keepalive_time=60     </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7        </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_keepalive_time - INTEGER    </span><br><span class="line">        How often TCP sends out keepalive messages when keepalive is enabled.    </span><br><span class="line">        Default: 2hours.    </span><br><span class="line">.  </span><br><span class="line">tcp_keepalive_probes - INTEGER    </span><br><span class="line">        How many keepalive probes TCP sends out, until it decides that the    </span><br><span class="line">        connection is broken. Default value: 9.    </span><br><span class="line">.  </span><br><span class="line">tcp_keepalive_intvl - INTEGER    </span><br><span class="line">        How frequently the probes are send out. Multiplied by    </span><br><span class="line">        tcp_keepalive_probes it is time to kill not responding connection,    </span><br><span class="line">        after probes started. Default value: 75sec i.e. connection    </span><br><span class="line">        will be aborted after ~11 minutes of retries.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置    </span><br><span class="line">    </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_keepalive_intvl=20    </span><br><span class="line">net.ipv4.tcp_keepalive_probes=3    </span><br><span class="line">net.ipv4.tcp_keepalive_time=60    </span><br><span class="line">.  </span><br><span class="line">连接空闲60秒后, 每隔20秒发心跳包, 尝试3次心跳包没有响应，关闭连接。 从开始空闲，到关闭连接总共历时120秒。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">11\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_mem=8388608 12582912 16777216    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_mem - vector of 3 INTEGERs: min, pressure, max    </span><br><span class="line">单位 page    </span><br><span class="line">        min: below this number of pages TCP is not bothered about its    </span><br><span class="line">        memory appetite.    </span><br><span class="line">.  </span><br><span class="line">        pressure: when amount of memory allocated by TCP exceeds this number    </span><br><span class="line">        of pages, TCP moderates its memory consumption and enters memory    </span><br><span class="line">        pressure mode, which is exited when memory consumption falls    </span><br><span class="line">        under "min".    </span><br><span class="line">.  </span><br><span class="line">        max: number of pages allowed for queueing by all TCP sockets.    </span><br><span class="line">.  </span><br><span class="line">        Defaults are calculated at boot time from amount of available    </span><br><span class="line">        memory.    </span><br><span class="line">64GB 内存，自动计算的值是这样的    </span><br><span class="line">net.ipv4.tcp_mem = 1539615      2052821 3079230    </span><br><span class="line">.  </span><br><span class="line">512GB 内存，自动计算得到的值是这样的    </span><br><span class="line">net.ipv4.tcp_mem = 49621632     66162176        99243264    </span><br><span class="line">.  </span><br><span class="line">这个参数让操作系统启动时自动计算，问题也不大  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_mem=8388608 12582912 16777216    </span><br><span class="line">.  </span><br><span class="line">这个参数让操作系统启动时自动计算，问题也不大  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">12\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_fin_timeout  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7        </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_fin_timeout - INTEGER    </span><br><span class="line">        The length of time an orphaned (no longer referenced by any    </span><br><span class="line">        application) connection will remain in the FIN_WAIT_2 state    </span><br><span class="line">        before it is aborted at the local end.  While a perfectly    </span><br><span class="line">        valid "receive only" state for an un-orphaned connection, an    </span><br><span class="line">        orphaned connection in FIN_WAIT_2 state could otherwise wait    </span><br><span class="line">        forever for the remote to close its end of the connection.    </span><br><span class="line">        Cf. tcp_max_orphans    </span><br><span class="line">        Default: 60 seconds    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置    </span><br><span class="line">    </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_fin_timeout=5    </span><br><span class="line">.  </span><br><span class="line">加快僵尸连接回收速度   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">13\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_synack_retries  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_synack_retries - INTEGER    </span><br><span class="line">        Number of times SYNACKs for a passive TCP connection attempt will    </span><br><span class="line">        be retransmitted. Should not be higher than 255. Default value    </span><br><span class="line">        is 5, which corresponds to 31seconds till the last retransmission    </span><br><span class="line">        with the current initial RTO of 1second. With this the final timeout    </span><br><span class="line">        for a passive TCP connection will happen after 63seconds.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_synack_retries=2    </span><br><span class="line">.  </span><br><span class="line">缩短tcp syncack超时时间  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">14\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_syncookies  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_syncookies - BOOLEAN    </span><br><span class="line">        Only valid when the kernel was compiled with CONFIG_SYN_COOKIES    </span><br><span class="line">        Send out syncookies when the syn backlog queue of a socket    </span><br><span class="line">        overflows. This is to prevent against the common 'SYN flood attack'    </span><br><span class="line">        Default: 1    </span><br><span class="line">.  </span><br><span class="line">        Note, that syncookies is fallback facility.    </span><br><span class="line">        It MUST NOT be used to help highly loaded servers to stand    </span><br><span class="line">        against legal connection rate. If you see SYN flood warnings    </span><br><span class="line">        in your logs, but investigation shows that they occur    </span><br><span class="line">        because of overload with legal connections, you should tune    </span><br><span class="line">        another parameters until this warning disappear.    </span><br><span class="line">        See: tcp_max_syn_backlog, tcp_synack_retries, tcp_abort_on_overflow.    </span><br><span class="line">.  </span><br><span class="line">        syncookies seriously violate TCP protocol, do not allow    </span><br><span class="line">        to use TCP extensions, can result in serious degradation    </span><br><span class="line">        of some services (f.e. SMTP relaying), visible not by you,    </span><br><span class="line">        but your clients and relays, contacting you. While you see    </span><br><span class="line">        SYN flood warnings in logs not being really flooded, your server    </span><br><span class="line">        is seriously misconfigured.    </span><br><span class="line">.  </span><br><span class="line">        If you want to test which effects syncookies have to your    </span><br><span class="line">        network connections you can set this knob to 2 to enable    </span><br><span class="line">        unconditionally generation of syncookies.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_syncookies=1    </span><br><span class="line">.  </span><br><span class="line">防止syn flood攻击   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">15\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_timestamps  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">    </span><br><span class="line">```  </span><br><span class="line">tcp_timestamps - BOOLEAN    </span><br><span class="line">        Enable timestamps as defined in RFC1323.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置      </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_timestamps=1    </span><br><span class="line">.  </span><br><span class="line">tcp_timestamps 是 tcp 协议中的一个扩展项，通过时间戳的方式来检测过来的包以防止 PAWS(Protect Against Wrapped  Sequence numbers)，可以提高 tcp 的性能。  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">16\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_tw_recycle  </span><br><span class="line">net.ipv4.tcp_tw_reuse  </span><br><span class="line">net.ipv4.tcp_max_tw_buckets  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_tw_recycle - BOOLEAN    </span><br><span class="line">        Enable fast recycling TIME-WAIT sockets. Default value is 0.    </span><br><span class="line">        It should not be changed without advice/request of technical    </span><br><span class="line">        experts.    </span><br><span class="line">.  </span><br><span class="line">tcp_tw_reuse - BOOLEAN    </span><br><span class="line">        Allow to reuse TIME-WAIT sockets for new connections when it is    </span><br><span class="line">        safe from protocol viewpoint. Default value is 0.    </span><br><span class="line">        It should not be changed without advice/request of technical    </span><br><span class="line">        experts.    </span><br><span class="line">.  </span><br><span class="line">tcp_max_tw_buckets - INTEGER  </span><br><span class="line">        Maximal number of timewait sockets held by system simultaneously.  </span><br><span class="line">        If this number is exceeded time-wait socket is immediately destroyed  </span><br><span class="line">        and warning is printed.   </span><br><span class="line">This limit exists only to prevent simple DoS attacks,   </span><br><span class="line">you _must_ not lower the limit artificially,   </span><br><span class="line">        but rather increase it (probably, after increasing installed memory),    </span><br><span class="line">        if network conditions require more than default value.   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置    </span><br><span class="line">    </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_tw_recycle=0    </span><br><span class="line">net.ipv4.tcp_tw_reuse=1    </span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 2xxxxx    </span><br><span class="line">.  </span><br><span class="line">net.ipv4.tcp_tw_recycle和net.ipv4.tcp_timestamps不建议同时开启    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">17\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_rmem  </span><br><span class="line">net.ipv4.tcp_wmem  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">tcp_wmem - vector of 3 INTEGERs: min, default, max    </span><br><span class="line">        min: Amount of memory reserved for send buffers for TCP sockets.    </span><br><span class="line">        Each TCP socket has rights to use it due to fact of its birth.    </span><br><span class="line">        Default: 1 page    </span><br><span class="line">.  </span><br><span class="line">        default: initial size of send buffer used by TCP sockets.  This    </span><br><span class="line">        value overrides net.core.wmem_default used by other protocols.    </span><br><span class="line">        It is usually lower than net.core.wmem_default.    </span><br><span class="line">        Default: 16K    </span><br><span class="line">.  </span><br><span class="line">        max: Maximal amount of memory allowed for automatically tuned    </span><br><span class="line">        send buffers for TCP sockets. This value does not override    </span><br><span class="line">        net.core.wmem_max.  Calling setsockopt() with SO_SNDBUF disables    </span><br><span class="line">        automatic tuning of that socket's send buffer size, in which case    </span><br><span class="line">        this value is ignored.    </span><br><span class="line">        Default: between 64K and 4MB, depending on RAM size.    </span><br><span class="line">.  </span><br><span class="line">tcp_rmem - vector of 3 INTEGERs: min, default, max    </span><br><span class="line">        min: Minimal size of receive buffer used by TCP sockets.    </span><br><span class="line">        It is guaranteed to each TCP socket, even under moderate memory    </span><br><span class="line">        pressure.    </span><br><span class="line">        Default: 1 page    </span><br><span class="line">.  </span><br><span class="line">        default: initial size of receive buffer used by TCP sockets.    </span><br><span class="line">        This value overrides net.core.rmem_default used by other protocols.    </span><br><span class="line">        Default: 87380 bytes. This value results in window of 65535 with    </span><br><span class="line">        default setting of tcp_adv_win_scale and tcp_app_win:0 and a bit    </span><br><span class="line">        less for default tcp_app_win. See below about these variables.    </span><br><span class="line">.  </span><br><span class="line">        max: maximal size of receive buffer allowed for automatically    </span><br><span class="line">        selected receiver buffers for TCP socket. This value does not override    </span><br><span class="line">        net.core.rmem_max.  Calling setsockopt() with SO_RCVBUF disables    </span><br><span class="line">        automatic tuning of that socket's receive buffer size, in which    </span><br><span class="line">        case this value is ignored.    </span><br><span class="line">        Default: between 87380B and 6MB, depending on RAM size.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.tcp_rmem=8192 87380 16777216    </span><br><span class="line">net.ipv4.tcp_wmem=8192 65536 16777216    </span><br><span class="line">.  </span><br><span class="line">许多数据库的推荐设置，提高网络性能  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">18\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.nf_conntrack_max  </span><br><span class="line">net.netfilter.nf_conntrack_max  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">nf_conntrack_max - INTEGER    </span><br><span class="line">        Size of connection tracking table.    </span><br><span class="line">Default value is nf_conntrack_buckets value * 4.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.nf_conntrack_max=1xxxxxx    </span><br><span class="line">net.netfilter.nf_conntrack_max=1xxxxxx    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">19\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.dirty_background_bytes   </span><br><span class="line">vm.dirty_expire_centisecs   </span><br><span class="line">vm.dirty_ratio   </span><br><span class="line">vm.dirty_writeback_centisecs   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7        </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_background_bytes    </span><br><span class="line">.  </span><br><span class="line">Contains the amount of dirty memory at which the background kernel    </span><br><span class="line">flusher threads will start writeback.    </span><br><span class="line">.  </span><br><span class="line">Note: dirty_background_bytes is the counterpart of dirty_background_ratio. Only    </span><br><span class="line">one of them may be specified at a time. When one sysctl is written it is    </span><br><span class="line">immediately taken into account to evaluate the dirty memory limits and the    </span><br><span class="line">other appears as 0 when read.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_background_ratio    </span><br><span class="line">.  </span><br><span class="line">Contains, as a percentage of total system memory, the number of pages at which    </span><br><span class="line">the background kernel flusher threads will start writing out dirty data.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_bytes    </span><br><span class="line">.  </span><br><span class="line">Contains the amount of dirty memory at which a process generating disk writes    </span><br><span class="line">will itself start writeback.    </span><br><span class="line">.  </span><br><span class="line">Note: dirty_bytes is the counterpart of dirty_ratio. Only one of them may be    </span><br><span class="line">specified at a time. When one sysctl is written it is immediately taken into    </span><br><span class="line">account to evaluate the dirty memory limits and the other appears as 0 when    </span><br><span class="line">read.    </span><br><span class="line">.  </span><br><span class="line">Note: the minimum value allowed for dirty_bytes is two pages (in bytes); any    </span><br><span class="line">value lower than this limit will be ignored and the old configuration will be    </span><br><span class="line">retained.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_expire_centisecs    </span><br><span class="line">.  </span><br><span class="line">This tunable is used to define when dirty data is old enough to be eligible    </span><br><span class="line">for writeout by the kernel flusher threads.  It is expressed in 100'ths    </span><br><span class="line">of a second.  Data which has been dirty in-memory for longer than this    </span><br><span class="line">interval will be written out next time a flusher thread wakes up.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_ratio    </span><br><span class="line">.  </span><br><span class="line">Contains, as a percentage of total system memory, the number of pages at which    </span><br><span class="line">a process which is generating disk writes will itself start writing out dirty    </span><br><span class="line">data.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">dirty_writeback_centisecs    </span><br><span class="line">.  </span><br><span class="line">The kernel flusher threads will periodically wake up and write `old' data    </span><br><span class="line">out to disk.  This tunable expresses the interval between those wakeups, in    </span><br><span class="line">100'ths of a second.    </span><br><span class="line">.  </span><br><span class="line">Setting this to zero disables periodic writeback altogether.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.dirty_background_bytes = 4096000000    </span><br><span class="line">vm.dirty_expire_centisecs = 6000    </span><br><span class="line">vm.dirty_ratio = 80    </span><br><span class="line">vm.dirty_writeback_centisecs = 50    </span><br><span class="line">.  </span><br><span class="line">减少数据库进程刷脏页的频率，dirty_background_bytes根据实际IOPS能力以及内存大小设置    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">20\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.extra_free_kbytes  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">extra_free_kbytes    </span><br><span class="line">.  </span><br><span class="line">This parameter tells the VM to keep extra free memory   </span><br><span class="line">between the threshold where background reclaim (kswapd) kicks in,   </span><br><span class="line">and the threshold where direct reclaim (by allocating processes) kicks in.    </span><br><span class="line">.  </span><br><span class="line">This is useful for workloads that require low latency memory allocations    </span><br><span class="line">and have a bounded burstiness in memory allocations,   </span><br><span class="line">for example a realtime application that receives and transmits network traffic    </span><br><span class="line">(causing in-kernel memory allocations) with a maximum total message burst    </span><br><span class="line">size of 200MB may need 200MB of extra free memory to avoid direct reclaim    </span><br><span class="line">related latencies.    </span><br><span class="line">.  </span><br><span class="line">目标是尽量让后台进程回收内存，比用户进程提早多少kbytes回收，因此用户进程可以快速分配内存。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.extra_free_kbytes=4xxxxxx    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">21\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.min_free_kbytes  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">min_free_kbytes:    </span><br><span class="line">.  </span><br><span class="line">This is used to force the Linux VM to keep a minimum number    </span><br><span class="line">of kilobytes free.  The VM uses this number to compute a    </span><br><span class="line">watermark[WMARK_MIN] value for each lowmem zone in the system.    </span><br><span class="line">Each lowmem zone gets a number of reserved free pages based    </span><br><span class="line">proportionally on its size.    </span><br><span class="line">.  </span><br><span class="line">Some minimal amount of memory is needed to satisfy PF_MEMALLOC    </span><br><span class="line">allocations; if you set this to lower than 1024KB, your system will    </span><br><span class="line">become subtly broken, and prone to deadlock under high loads.    </span><br><span class="line">.  </span><br><span class="line">Setting this too high will OOM your machine instantly.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.min_free_kbytes = 2xxxxxx     # vm.min_free_kbytes 建议每32G内存分配1G vm.min_free_kbytes</span><br><span class="line">.  </span><br><span class="line">防止在高负载时系统无响应，减少内存分配死锁概率。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">22\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.mmap_min_addr  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7       </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">mmap_min_addr    </span><br><span class="line">.  </span><br><span class="line">This file indicates the amount of address space  which a user process will    </span><br><span class="line">be restricted from mmapping.  Since kernel null dereference bugs could    </span><br><span class="line">accidentally operate based on the information in the first couple of pages    </span><br><span class="line">of memory userspace processes should not be allowed to write to them.  By    </span><br><span class="line">default this value is set to 0 and no protections will be enforced by the    </span><br><span class="line">security module.  Setting this value to something like 64k will allow the    </span><br><span class="line">vast majority of applications to work correctly and provide defense in depth    </span><br><span class="line">against future potential kernel bugs.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.mmap_min_addr=6xxxx    </span><br><span class="line">.  </span><br><span class="line">防止内核隐藏的BUG导致的问题  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">23\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.overcommit_memory   </span><br><span class="line">vm.overcommit_ratio   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">overcommit_kbytes:    </span><br><span class="line">.  </span><br><span class="line">When overcommit_memory is set to 2, the committed address space is not    </span><br><span class="line">permitted to exceed swap plus this amount of physical RAM. See below.    </span><br><span class="line">.  </span><br><span class="line">Note: overcommit_kbytes is the counterpart of overcommit_ratio. Only one    </span><br><span class="line">of them may be specified at a time. Setting one disables the other (which    </span><br><span class="line">then appears as 0 when read).    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">overcommit_memory:    </span><br><span class="line">.  </span><br><span class="line">This value contains a flag that enables memory overcommitment.    </span><br><span class="line">.  </span><br><span class="line">When this flag is 0,   </span><br><span class="line">the kernel attempts to estimate the amount    </span><br><span class="line">of free memory left when userspace requests more memory.    </span><br><span class="line">.  </span><br><span class="line">When this flag is 1,   </span><br><span class="line">the kernel pretends there is always enough memory until it actually runs out.    </span><br><span class="line">.  </span><br><span class="line">When this flag is 2,   </span><br><span class="line">the kernel uses a "never overcommit"    </span><br><span class="line">policy that attempts to prevent any overcommit of memory.    </span><br><span class="line">Note that user_reserve_kbytes affects this policy.    </span><br><span class="line">.  </span><br><span class="line">This feature can be very useful because there are a lot of    </span><br><span class="line">programs that malloc() huge amounts of memory "just-in-case"    </span><br><span class="line">and don't use much of it.    </span><br><span class="line">.  </span><br><span class="line">The default value is 0.    </span><br><span class="line">.  </span><br><span class="line">See Documentation/vm/overcommit-accounting and    </span><br><span class="line">security/commoncap.c::cap_vm_enough_memory() for more information.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">.  </span><br><span class="line">overcommit_ratio:    </span><br><span class="line">.  </span><br><span class="line">When overcommit_memory is set to 2,   </span><br><span class="line">the committed address space is not permitted to exceed   </span><br><span class="line">      swap + this percentage of physical RAM.    </span><br><span class="line">See above.    </span><br><span class="line">.  </span><br><span class="line">==============================================================    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.overcommit_memory = 0    </span><br><span class="line">vm.overcommit_ratio = 90    </span><br><span class="line">.  </span><br><span class="line">vm.overcommit_memory = 0 时 vm.overcommit_ratio可以不设置   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">24\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.swappiness   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">swappiness    </span><br><span class="line">.  </span><br><span class="line">This control is used to define how aggressive the kernel will swap    </span><br><span class="line">memory pages.    </span><br><span class="line">Higher values will increase agressiveness, lower values    </span><br><span class="line">decrease the amount of swap.    </span><br><span class="line">.  </span><br><span class="line">The default value is 60.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.swappiness = 0    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">25\.     </span><br><span class="line">  </span><br><span class="line">  参数     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.zone_reclaim_mode   </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">zone_reclaim_mode:    </span><br><span class="line">.  </span><br><span class="line">Zone_reclaim_mode allows someone to set more or less aggressive approaches to    </span><br><span class="line">reclaim memory when a zone runs out of memory. If it is set to zero then no    </span><br><span class="line">zone reclaim occurs. Allocations will be satisfied from other zones / nodes    </span><br><span class="line">in the system.    </span><br><span class="line">.  </span><br><span class="line">This is value ORed together of    </span><br><span class="line">.  </span><br><span class="line">1       = Zone reclaim on    </span><br><span class="line">2       = Zone reclaim writes dirty pages out    </span><br><span class="line">4       = Zone reclaim swaps pages    </span><br><span class="line">.  </span><br><span class="line">zone_reclaim_mode is disabled by default.  For file servers or workloads    </span><br><span class="line">that benefit from having their data cached, zone_reclaim_mode should be    </span><br><span class="line">left disabled as the caching effect is likely to be more important than    </span><br><span class="line">data locality.    </span><br><span class="line">.  </span><br><span class="line">zone_reclaim may be enabled if it's known that the workload is partitioned    </span><br><span class="line">such that each partition fits within a NUMA node and that accessing remote    </span><br><span class="line">memory would cause a measurable performance reduction.  The page allocator    </span><br><span class="line">will then reclaim easily reusable pages (those page cache pages that are    </span><br><span class="line">currently not used) before allocating off node pages.    </span><br><span class="line">.  </span><br><span class="line">Allowing zone reclaim to write out pages stops processes that are    </span><br><span class="line">writing large amounts of data from dirtying pages on other nodes. Zone    </span><br><span class="line">reclaim will write out dirty pages if a zone fills up and so effectively    </span><br><span class="line">throttle the process. This may decrease the performance of a single process    </span><br><span class="line">since it cannot use all of system memory to buffer the outgoing writes    </span><br><span class="line">anymore but it preserve the memory on other nodes so that the performance    </span><br><span class="line">of other processes running on other nodes will not be affected.    </span><br><span class="line">.  </span><br><span class="line">Allowing regular swap effectively restricts allocations to the local    </span><br><span class="line">node unless explicitly overridden by memory policies or cpuset    </span><br><span class="line">configurations.    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">vm.zone_reclaim_mode=0    </span><br><span class="line">.  </span><br><span class="line">不使用NUMA  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">26\.    </span><br><span class="line">  </span><br><span class="line">  参数  </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.ip_local_port_range  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7         </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">ip_local_port_range - 2 INTEGERS  </span><br><span class="line">        Defines the local port range that is used by TCP and UDP to  </span><br><span class="line">        choose the local port. The first number is the first, the  </span><br><span class="line">        second the last local port number. The default values are  </span><br><span class="line">        32768 and 61000 respectively.  </span><br><span class="line">.  </span><br><span class="line">ip_local_reserved_ports - list of comma separated ranges  </span><br><span class="line">        Specify the ports which are reserved for known third-party  </span><br><span class="line">        applications. These ports will not be used by automatic port  </span><br><span class="line">        assignments (e.g. when calling connect() or bind() with port  </span><br><span class="line">        number 0). Explicit port allocation behavior is unchanged.  </span><br><span class="line">.  </span><br><span class="line">        The format used for both input and output is a comma separated  </span><br><span class="line">        list of ranges (e.g. "1,2-4,10-10" for ports 1, 2, 3, 4 and  </span><br><span class="line">        10). Writing to the file will clear all previously reserved  </span><br><span class="line">        ports and update the current list with the one given in the  </span><br><span class="line">        input.  </span><br><span class="line">.  </span><br><span class="line">        Note that ip_local_port_range and ip_local_reserved_ports  </span><br><span class="line">        settings are independent and both are considered by the kernel  </span><br><span class="line">        when determining which ports are available for automatic port  </span><br><span class="line">        assignments.  </span><br><span class="line">.  </span><br><span class="line">        You can reserve ports which are not in the current  </span><br><span class="line">        ip_local_port_range, e.g.:  </span><br><span class="line">.  </span><br><span class="line">        $ cat /proc/sys/net/ipv4/ip_local_port_range  </span><br><span class="line">        32000   61000  </span><br><span class="line">        $ cat /proc/sys/net/ipv4/ip_local_reserved_ports  </span><br><span class="line">        8080,9148  </span><br><span class="line">.  </span><br><span class="line">        although this is redundant. However such a setting is useful  </span><br><span class="line">        if later the port range is changed to a value that will  </span><br><span class="line">        include the reserved ports.  </span><br><span class="line">.  </span><br><span class="line">        Default: Empty  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置     </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">net.ipv4.ip_local_port_range=40000 65535    </span><br><span class="line">.  </span><br><span class="line">限制本地动态端口分配范围，防止占用监听端口。  </span><br><span class="line">```  </span><br><span class="line">      </span><br><span class="line">27\.    </span><br><span class="line">  </span><br><span class="line">  参数    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">  vm.nr_hugepages  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  支持系统    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">CentOS 6, 7  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  参数解释    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">==============================================================  </span><br><span class="line">nr_hugepages  </span><br><span class="line">Change the minimum size of the hugepage pool.  </span><br><span class="line">See Documentation/vm/hugetlbpage.txt  </span><br><span class="line">==============================================================  </span><br><span class="line">nr_overcommit_hugepages  </span><br><span class="line">Change the maximum size of the hugepage pool. The maximum is  </span><br><span class="line">nr_hugepages + nr_overcommit_hugepages.  </span><br><span class="line">See Documentation/vm/hugetlbpage.txt  </span><br><span class="line">.  </span><br><span class="line">The output of "cat /proc/meminfo" will include lines like:  </span><br><span class="line">......  </span><br><span class="line">HugePages_Total: vvv  </span><br><span class="line">HugePages_Free:  www  </span><br><span class="line">HugePages_Rsvd:  xxx  </span><br><span class="line">HugePages_Surp:  yyy  </span><br><span class="line">Hugepagesize:    zzz kB  </span><br><span class="line">.  </span><br><span class="line">where:  </span><br><span class="line">HugePages_Total is the size of the pool of huge pages.  </span><br><span class="line">HugePages_Free  is the number of huge pages in the pool that are not yet  </span><br><span class="line">                allocated.  </span><br><span class="line">HugePages_Rsvd  is short for "reserved," and is the number of huge pages for  </span><br><span class="line">                which a commitment to allocate from the pool has been made,  </span><br><span class="line">                but no allocation has yet been made.  Reserved huge pages  </span><br><span class="line">                guarantee that an application will be able to allocate a  </span><br><span class="line">                huge page from the pool of huge pages at fault time.  </span><br><span class="line">HugePages_Surp  is short for "surplus," and is the number of huge pages in  </span><br><span class="line">                the pool above the value in /proc/sys/vm/nr_hugepages. The  </span><br><span class="line">                maximum number of surplus huge pages is controlled by  </span><br><span class="line">                /proc/sys/vm/nr_overcommit_hugepages.  </span><br><span class="line">.  </span><br><span class="line">/proc/filesystems should also show a filesystem of type "hugetlbfs" configured  </span><br><span class="line">in the kernel.  </span><br><span class="line">.  </span><br><span class="line">/proc/sys/vm/nr_hugepages indicates the current number of "persistent" huge  </span><br><span class="line">pages in the kernel's huge page pool.  "Persistent" huge pages will be  </span><br><span class="line">returned to the huge page pool when freed by a task.  A user with root  </span><br><span class="line">privileges can dynamically allocate more or free some persistent huge pages  </span><br><span class="line">by increasing or decreasing the value of 'nr_hugepages'.  </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">  推荐设置    </span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line">如果要使用PostgreSQL的huge page，建议设置它。    </span><br><span class="line">大于数据库需要的共享内存即可。    </span><br><span class="line">```  </span><br><span class="line">    </span><br><span class="line">28\.</span><br><span class="line"></span><br><span class="line">  参数</span><br></pre></td></tr></tbody></table></figure><p>  fs.nr_open<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">支持系统</span><br></pre></td></tr></tbody></table></figure><p></p><p>CentOS 6, 7<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">参数解释</span><br></pre></td></tr></tbody></table></figure><p></p><p>nr_open:</p><p>This denotes the maximum number of file-handles a process can<br>allocate. Default value is 1024*1024 (1048576) which should be<br>enough for most machines. Actual limit depends on RLIMIT_NOFILE<br>resource limit.</p><p>它还影响security/limits.conf 的文件句柄限制，单个进程的打开句柄不能大于fs.nr_open，所以要加大文件句柄限制，首先要加大nr_open</p><pre><code>推荐设置</code></pre><p>对于有很多对象（表、视图、索引、序列、物化视图等）的PostgreSQL数据库，建议设置为2000万，<br>例如fs.nr_open=20480000</p><pre><code>## 数据库关心的资源限制  1\. 通过/etc/security/limits.conf设置，或者ulimit设置    2\. 通过/proc/$pid/limits查看当前进程的设置    </code></pre><h1 id="core-limits-the-core-file-size-KB"><a href="#core-limits-the-core-file-size-KB" class="headerlink" title="- core - limits the core file size (KB)"></a>- core - limits the core file size (KB)</h1><h1 id="memlock-max-locked-in-memory-address-space-KB"><a href="#memlock-max-locked-in-memory-address-space-KB" class="headerlink" title="- memlock - max locked-in-memory address space (KB)"></a>- memlock - max locked-in-memory address space (KB)</h1><h1 id="nofile-max-number-of-open-files-建议设置为1000万-但是必须设置sysctl-fs-nr-open大于它，否则会导致系统无法登陆。"><a href="#nofile-max-number-of-open-files-建议设置为1000万-但是必须设置sysctl-fs-nr-open大于它，否则会导致系统无法登陆。" class="headerlink" title="- nofile - max number of open files  建议设置为1000万 , 但是必须设置sysctl, fs.nr_open大于它，否则会导致系统无法登陆。"></a>- nofile - max number of open files  建议设置为1000万 , 但是必须设置sysctl, fs.nr_open大于它，否则会导致系统无法登陆。</h1><h1 id="nproc-max-number-of-processes"><a href="#nproc-max-number-of-processes" class="headerlink" title="- nproc - max number of processes"></a>- nproc - max number of processes</h1><p>以上四个是非常关心的配置<br>….  </p><h1 id="data-max-data-size-KB"><a href="#data-max-data-size-KB" class="headerlink" title="- data - max data size (KB)"></a>- data - max data size (KB)</h1><h1 id="fsize-maximum-filesize-KB"><a href="#fsize-maximum-filesize-KB" class="headerlink" title="- fsize - maximum filesize (KB)"></a>- fsize - maximum filesize (KB)</h1><h1 id="rss-max-resident-set-size-KB"><a href="#rss-max-resident-set-size-KB" class="headerlink" title="- rss - max resident set size (KB)"></a>- rss - max resident set size (KB)</h1><h1 id="stack-max-stack-size-KB"><a href="#stack-max-stack-size-KB" class="headerlink" title="- stack - max stack size (KB)"></a>- stack - max stack size (KB)</h1><h1 id="cpu-max-CPU-time-MIN"><a href="#cpu-max-CPU-time-MIN" class="headerlink" title="- cpu - max CPU time (MIN)"></a>- cpu - max CPU time (MIN)</h1><h1 id="as-address-space-limit-KB"><a href="#as-address-space-limit-KB" class="headerlink" title="- as - address space limit (KB)"></a>- as - address space limit (KB)</h1><h1 id="maxlogins-max-number-of-logins-for-this-user"><a href="#maxlogins-max-number-of-logins-for-this-user" class="headerlink" title="- maxlogins - max number of logins for this user"></a>- maxlogins - max number of logins for this user</h1><h1 id="maxsyslogins-max-number-of-logins-on-the-system"><a href="#maxsyslogins-max-number-of-logins-on-the-system" class="headerlink" title="- maxsyslogins - max number of logins on the system"></a>- maxsyslogins - max number of logins on the system</h1><h1 id="priority-the-priority-to-run-user-process-with"><a href="#priority-the-priority-to-run-user-process-with" class="headerlink" title="- priority - the priority to run user process with"></a>- priority - the priority to run user process with</h1><h1 id="locks-max-number-of-file-locks-the-user-can-hold"><a href="#locks-max-number-of-file-locks-the-user-can-hold" class="headerlink" title="- locks - max number of file locks the user can hold"></a>- locks - max number of file locks the user can hold</h1><h1 id="sigpending-max-number-of-pending-signals"><a href="#sigpending-max-number-of-pending-signals" class="headerlink" title="- sigpending - max number of pending signals"></a>- sigpending - max number of pending signals</h1><h1 id="msgqueue-max-memory-used-by-POSIX-message-queues-bytes"><a href="#msgqueue-max-memory-used-by-POSIX-message-queues-bytes" class="headerlink" title="- msgqueue - max memory used by POSIX message queues (bytes)"></a>- msgqueue - max memory used by POSIX message queues (bytes)</h1><h1 id="nice-max-nice-priority-allowed-to-raise-to-values-20-19"><a href="#nice-max-nice-priority-allowed-to-raise-to-values-20-19" class="headerlink" title="- nice - max nice priority allowed to raise to values: [-20, 19]"></a>- nice - max nice priority allowed to raise to values: [-20, 19]</h1><h1 id="rtprio-max-realtime-priority"><a href="#rtprio-max-realtime-priority" class="headerlink" title="- rtprio - max realtime priority"></a>- rtprio - max realtime priority</h1><pre><code>## 数据库关心的IO调度规则  1\. 目前操作系统支持的IO调度策略包括cfq, deadline, noop 等。    </code></pre><p>/kernel-doc-xxx/Documentation/block<br>-r–r–r– 1 root root   674 Apr  8 16:33 00-INDEX<br>-r–r–r– 1 root root 55006 Apr  8 16:33 biodoc.txt<br>-r–r–r– 1 root root   618 Apr  8 16:33 capability.txt<br>-r–r–r– 1 root root 12791 Apr  8 16:33 cfq-iosched.txt<br>-r–r–r– 1 root root 13815 Apr  8 16:33 data-integrity.txt<br>-r–r–r– 1 root root  2841 Apr  8 16:33 deadline-iosched.txt<br>-r–r–r– 1 root root  4713 Apr  8 16:33 ioprio.txt<br>-r–r–r– 1 root root  2535 Apr  8 16:33 null_blk.txt<br>-r–r–r– 1 root root  4896 Apr  8 16:33 queue-sysfs.txt<br>-r–r–r– 1 root root  2075 Apr  8 16:33 request.txt<br>-r–r–r– 1 root root  3272 Apr  8 16:33 stat.txt<br>-r–r–r– 1 root root  1414 Apr  8 16:33 switching-sched.txt<br>-r–r–r– 1 root root  3916 Apr  8 16:33 writeback_cache_control.txt  </p><pre><code>如果你要详细了解这些调度策略的规则，可以查看WIKI或者看内核文档。    从这里可以看到它的调度策略  </code></pre><p>cat /sys/block/vdb/queue/scheduler<br>noop [deadline] cfq   </p><pre><code>修改    </code></pre><p>echo deadline > /sys/block/hda/queue/scheduler  </p><pre><code>或者修改启动参数    </code></pre><p>grub.conf<br>elevator=deadline<br><code>`</code>  </p><p>  从很多测试结果来看，数据库使用deadline调度，性能会更稳定一些。      </p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>1. 关闭透明大页  </p><p>2. 禁用NUMA  </p><p>3. SSD的对齐  </p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;images.jpeg&quot; class=&quot;full-image&quot; alt
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>mongodb 的 forEach用法</title>
    <link href="https://jiemin.wang/2019/05/21/mongodb-forEach/"/>
    <id>https://jiemin.wang/2019/05/21/mongodb-forEach/</id>
    <published>2019-05-21T04:49:45.000Z</published>
    <updated>2019-05-21T05:10:49.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="a81fc51f0f.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>努力不一定会成功，可不努力会很轻松哦</strong></p></blockquote><h2 id="MongoDB-forEach-说明"><a href="#MongoDB-forEach-说明" class="headerlink" title="MongoDB forEach 说明"></a>MongoDB <a href="https://docs.mongodb.com/manual/reference/method/cursor.forEach/" target="_blank" rel="noopener">forEach</a> 说明</h2><p>forEach方法中的function回调有三个参数:</p><ul><li>遍历的数组内容</li><li>对应的数组索引</li><li>数组本身</li></ul><h2 id="MongoDB-forEach-使用案例"><a href="#MongoDB-forEach-使用案例" class="headerlink" title="MongoDB forEach 使用案例"></a>MongoDB forEach 使用案例</h2><h4 id="MongoDB数据插入、删除、更新、批量更新某个字段"><a href="#MongoDB数据插入、删除、更新、批量更新某个字段" class="headerlink" title="MongoDB数据插入、删除、更新、批量更新某个字段"></a>MongoDB数据插入、删除、更新、批量更新某个字段</h4><p>批量更新某个字段</p><p>例1<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'bond_sentiment_news'</span>).find({<span class="string">"source"</span> : 2,<span class="string">"siteUrl"</span> : <span class="string">"http://www.21jingji.com/"</span>}).forEach(</span><br><span class="line">   <span class="keyword">function</span>(item){                </span><br><span class="line">       db.getCollection(<span class="string">'bond_sentiment_news'</span>).update({<span class="string">"_id"</span>:item._id},{<span class="variable">$set</span>:{<span class="string">"siteName"</span>:<span class="string">"21经济网"</span>}})</span><br><span class="line">   }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>例2<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'my_booking'</span>).find({<span class="string">"hospitalName"</span>:/xx医院/,openId:/^2/}).forEach(</span><br><span class="line">   <span class="keyword">function</span>(item){                </span><br><span class="line">       db.getCollection(<span class="string">'my_booking'</span>).update({<span class="string">"_id"</span>:item._id},{<span class="variable">$set</span>:{<span class="string">"payType"</span>: <span class="string">"1"</span>}})</span><br><span class="line">   }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>查询出hospitalName是xx医院和openId以2开头的所有记录，并且更新my_booking表中的payType为1.</p><p>例3<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'my_booking'</span>).find({<span class="string">"hospitalName"</span>:/运城市中心医院/,openId:{<span class="variable">$not</span>:/^2/}}).forEach(</span><br><span class="line">   <span class="keyword">function</span>(item){                </span><br><span class="line">       db.getCollection(<span class="string">'my_booking'</span>).update({<span class="string">"_id"</span>:item._id},{<span class="variable">$set</span>:{<span class="string">"outTradeNo1"</span>: item.outTradeNo2}})</span><br><span class="line">   }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>查询出xx医院和不已2开头的openId的所有记录，并且将每条记录的outTradeNo2赋值给outTradeNo1.</p><h4 id="MongoDB-数组遍历操作-forEach"><a href="#MongoDB-数组遍历操作-forEach" class="headerlink" title="MongoDB 数组遍历操作 forEach"></a>MongoDB 数组遍历操作 forEach</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.User.find().forEach(</span><br><span class="line">   <span class="keyword">function</span>(item){                </span><br><span class="line">       db.User.update({<span class="string">"_id"</span>:item._id},{<span class="string">"<span class="variable">$set</span>"</span>:{<span class="string">"LastUpdate"</span>:item.CreateAt}},<span class="literal">false</span>,<span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><h4 id="MongoDB-更新每条数据某个字段的值"><a href="#MongoDB-更新每条数据某个字段的值" class="headerlink" title="MongoDB 更新每条数据某个字段的值"></a>MongoDB 更新每条数据某个字段的值</h4><p>例1<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var begin = 1499675090;</span><br><span class="line">var end = 1499675198;</span><br><span class="line">var t = begin;</span><br><span class="line"><span class="keyword">while</span>(t<=end){</span><br><span class="line">    db.getCollection(<span class="string">'event'</span>).find({createdDate:{<span class="variable">$lt</span>:t+100, <span class="variable">$gte</span>:t}}).forEach(</span><br><span class="line">        <span class="keyword">function</span>(item){</span><br><span class="line">            <span class="keyword">if</span>(item.account_login!= undefined && item.account_login!= null){</span><br><span class="line">                item.account_login = item.account_login.substr(0,5)+<span class="string">'123456'</span>;</span><br><span class="line">                db.getCollection(<span class="string">'event'</span>).save(item);</span><br><span class="line">            }</span><br><span class="line">       </span><br><span class="line">        };</span><br><span class="line">    );</span><br><span class="line">    t+=100;</span><br><span class="line">        </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>例2<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var begin = 1499675090;</span><br><span class="line">var end = 1499675198;</span><br><span class="line">var t = begin;</span><br><span class="line"><span class="keyword">while</span>(t<=end){</span><br><span class="line">    var aa=db.getCollection(<span class="string">'event'</span>).find({createdDate:{<span class="variable">$lt</span>:t+100, <span class="variable">$gte</span>:t}})</span><br><span class="line">    aa.forEach(</span><br><span class="line">        <span class="keyword">function</span>(item){</span><br><span class="line">            <span class="keyword">if</span>(item.account_login!= undefined && item.account_login!= null){</span><br><span class="line">                item.account_login = item.account_login.substr(0,5)+<span class="string">'123456'</span>;</span><br><span class="line">                db.getCollection(<span class="string">'event'</span>).save(item);</span><br><span class="line">            }</span><br><span class="line">       </span><br><span class="line">        };</span><br><span class="line">    );</span><br><span class="line">    t+=100;</span><br><span class="line">        </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'event'</span>).find().forEach(</span><br><span class="line">     <span class="keyword">function</span>(item){</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">if</span>(item.account_login!= undefined&&item.account_login!= null){</span><br><span class="line">           </span><br><span class="line">      item.account_login = item.account_login.substr(0,5)+<span class="string">'123456'</span>;</span><br><span class="line">            </span><br><span class="line">      db.getCollection(<span class="string">'event'</span>).save(item);</span><br><span class="line">       }</span><br><span class="line">       </span><br><span class="line">  }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><h4 id="MongoDB-更新字段操作"><a href="#MongoDB-更新字段操作" class="headerlink" title="MongoDB 更新字段操作"></a>MongoDB 更新字段操作</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'book'</span>).find({}).forEach(</span><br><span class="line">    <span class="keyword">function</span>(X){</span><br><span class="line">        x.age = new NumberInt(x.age);// 将字符串转化为数字</span><br><span class="line">        db.book.save(x);//保存数据</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h4 id="添加字段或更新值"><a href="#添加字段或更新值" class="headerlink" title="添加字段或更新值"></a>添加字段或更新值</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'test'</span>).update(</span><br><span class="line">  {},</span><br><span class="line">  {</span><br><span class="line">       <span class="variable">$set</span>:{</span><br><span class="line">             <span class="string">'createTime'</span>:<span class="string">'2017-06-29 08:08'</span>,</span><br><span class="line">             <span class="string">'updateTime'</span>:<span class="string">'2017-06-29 08:08</span></span><br><span class="line"><span class="string">       }</span></span><br><span class="line"><span class="string">  }</span></span><br><span class="line"><span class="string">);</span></span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;a81fc51f0f.jpg&quot; class=&quot;full-image&quot; 
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>mongodb aggregate 基于UNIX时间戳的聚合</title>
    <link href="https://jiemin.wang/2019/05/20/mongodb-aggregate/"/>
    <id>https://jiemin.wang/2019/05/20/mongodb-aggregate/</id>
    <published>2019-05-20T10:31:54.000Z</published>
    <updated>2019-05-21T07:41:21.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiiiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>对今天解决不了的事情，也不要着急。因为明天也可能还是解决不了。</strong></p></blockquote><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>开发找我问<code>MongoDB</code> 的 <code>aggregate 聚合</code>用过不<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f630.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f630.png?v8">😰</span> 。</p><p>我说查查资料吧，发现是<code>aggregate</code>聚合管道 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f628.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f628.png?v8">😨</span> 。</p><p>把SQL 与 Aggergation 对比下<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span></p><table><thead><tr><th style="text-align:center">SQL Terms, Functions, and Concepts</th><th style="text-align:center">MongoDB Aggregation Operators</th></tr></thead><tbody><tr><td style="text-align:center">WHERE</td><td style="text-align:center">$match</td></tr><tr><td style="text-align:center">HAVING</td><td style="text-align:center">$match</td></tr><tr><td style="text-align:center">SELECT</td><td style="text-align:center">$project</td></tr><tr><td style="text-align:center">ORDER BY</td><td style="text-align:center">$sort</td></tr><tr><td style="text-align:center">LIMIT</td><td style="text-align:center">$limit</td></tr><tr><td style="text-align:center">SUM()</td><td style="text-align:center">$sum</td></tr><tr><td style="text-align:center">COUNT()</td><td style="text-align:center">$sum</td></tr><tr><td style="text-align:center">COUNT()</td><td style="text-align:center">$sortByCount</td></tr><tr><td style="text-align:center">join</td><td style="text-align:center">$lookup</td></tr></tbody></table><p>开发的需求是:</p><ul><li>按照天分组，统计一下数量</li></ul><p>经过查看<code>MongoDB官网</code>的<a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener">aggregate资料</a>实现开发的需求</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>查询数据的状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.find({<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}).pretty().<span class="built_in">limit</span>(1);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">        <span class="string">"_id"</span> : ObjectId(<span class="string">"5c125657372eecd7a0a54e5e"</span>),</span><br><span class="line">        <span class="string">"adRate"</span> : 0,</span><br><span class="line">        <span class="string">"assoId"</span> : <span class="string">"223794113"</span>,</span><br><span class="line">        <span class="string">"assoType"</span> : 201,</span><br><span class="line">        <span class="string">"clientIp"</span> : <span class="string">"183.131.7.23"</span>,</span><br><span class="line">        <span class="string">"clientType"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"confidence"</span> : 12.655,</span><br><span class="line">        <span class="string">"content"</span> : <span class="string">"****http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1\**"</span>,</span><br><span class="line">        <span class="string">"createTs"</span> : NumberLong(1544705623),</span><br><span class="line">        <span class="string">"emailStatus"</span> : <span class="string">"verified"</span>,</span><br><span class="line">        <span class="string">"handleTs"</span> : NumberLong(1545036013),</span><br><span class="line">        <span class="string">"hotScore"</span> : 14.285,</span><br><span class="line">        <span class="string">"inspectStatus"</span> : 2,</span><br><span class="line">        <span class="string">"message"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"moduleId"</span> : NumberLong(5),</span><br><span class="line">        <span class="string">"normalScore"</span> : 73.25,</span><br><span class="line">        <span class="string">"ocrKeyword"</span> : [ ],</span><br><span class="line">        <span class="string">"ocrText"</span> : [ ],</span><br><span class="line">        <span class="string">"opUser"</span> : <span class="string">"fanyanning"</span>,</span><br><span class="line">        <span class="string">"opUserId"</span> : NumberLong(31648494),</span><br><span class="line">        <span class="string">"pornScore"</span> : 12.464,</span><br><span class="line">        <span class="string">"qcode"</span> : 0,</span><br><span class="line">        <span class="string">"receiveTs"</span> : NumberLong(1545035885),</span><br><span class="line">        <span class="string">"regTs"</span> : NumberLong(1475385061),</span><br><span class="line">        <span class="string">"requestId"</span> : <span class="string">"6f078c58-1235-4816-96a5-e876ea0cbcf2"</span>,</span><br><span class="line">        <span class="string">"rotOcrKeyword"</span> : [ ],</span><br><span class="line">        <span class="string">"rotOcrText"</span> : [ ],</span><br><span class="line">        <span class="string">"ruleId"</span> : NumberLong(10019),</span><br><span class="line">        <span class="string">"sim"</span> : 0,</span><br><span class="line">        <span class="string">"status"</span> : 1000,</span><br><span class="line">        <span class="string">"trashType"</span> : 0,</span><br><span class="line">        <span class="string">"ts"</span> : NumberLong(1544705623),</span><br><span class="line">        <span class="string">"url"</span> : <span class="string">"http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1"</span>,</span><br><span class="line">        <span class="string">"userId"</span> : NumberLong(56349617),</span><br><span class="line">        <span class="string">"userLevel"</span> : 3,</span><br><span class="line">        <span class="string">"version"</span> : <span class="string">"1.0.0"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>开发给的聚合的查询<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([</span><br><span class="line">{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}},</span><br><span class="line">{ <span class="variable">$group</span>: {_id :{<span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date: <span class="string">"<span class="variable">$createTs</span>"</span> }},count: { <span class="variable">$sum</span>: 1 }}}</span><br><span class="line">]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mgset-11469021:SECONDARY> db.antispam_image.aggregate([{<span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5, createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}}, {<span class="variable">$group</span>: {_id: {<span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date: <span class="string">"<span class="variable">$createTs</span>"</span>}}, count: {<span class="variable">$sum</span>: 1}}}]);</span><br><span class="line">assert: <span class="built_in">command</span> failed: {</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1558347069, 2),</span><br><span class="line">        <span class="string">"ok"</span> : 0,</span><br><span class="line">        <span class="string">"errmsg"</span> : <span class="string">"can't convert from BSON type long to Date"</span>,</span><br><span class="line">        <span class="string">"code"</span> : 16006,</span><br><span class="line">        <span class="string">"codeName"</span> : <span class="string">"Location16006"</span></span><br><span class="line">} : aggregate failed</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">doassert@src/mongo/shell/assert.js:16:14</span><br><span class="line">assert.commandWorked@src/mongo/shell/assert.js:370:5</span><br><span class="line">DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5</span><br><span class="line">@(shell):1:1</span><br><span class="line"></span><br><span class="line">2019-05-20T18:11:10.818+0800 E QUERY    [thread1] Error: <span class="built_in">command</span> failed: {</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1558347069, 2),</span><br><span class="line">        <span class="string">"ok"</span> : 0,</span><br><span class="line">        <span class="string">"errmsg"</span> : <span class="string">"can't convert from BSON type long to Date"</span>,</span><br><span class="line">        <span class="string">"code"</span> : 16006,</span><br><span class="line">        <span class="string">"codeName"</span> : <span class="string">"Location16006"</span></span><br><span class="line">} : aggregate failed :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">doassert@src/mongo/shell/assert.js:16:14</span><br><span class="line">assert.commandWorked@src/mongo/shell/assert.js:370:5</span><br><span class="line">DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5</span><br><span class="line">@(shell):1:1</span><br></pre></td></tr></tbody></table></figure><p>报错了，问开发。开发又给了一个查询语句<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([</span><br><span class="line">{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}},</span><br><span class="line">{ <span class="variable">$group</span>: {</span><br><span class="line">_id :{ <span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date:{<span class="string">"<span class="variable">$add</span>"</span>:[new Date(0),<span class="string">"<span class="variable">$createTs</span>"</span>]}} },</span><br><span class="line">count: { <span class="variable">$sum</span>: 1 }</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"_id"</span> : <span class="string">"1970-01-19"</span>, <span class="string">"count"</span> : 15131 }</span><br><span class="line">{ <span class="string">"_id"</span> : <span class="string">"1970-01-18"</span>, <span class="string">"count"</span> : 180400 }</span><br></pre></td></tr></tbody></table></figure><p>发现时间戳转化不对</p><p>于是查看官网资料，继续改写先把UNIX时间戳转化为日期。可是MongoDB又没有<code>MySQL</code>那种<code>FROM_UNIXTIME()</code>与<code>UNIX_TIMESTAMP()</code>函数。只能自己造</p><p>通过将值乘以1000将createTs字段转换为毫秒时间戳<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>]}</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>$multiply    将数字相乘以返回产品。接受任意数量的参数表达式。</p></blockquote><p>然后转换为日期<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>]} ]</span><br></pre></td></tr></tbody></table></figure><p></p><p>继续组装查询<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="string">"<span class="variable">$group</span>"</span>: { <span class="string">"_id"</span>: { <span class="string">"year"</span>: { <span class="string">"<span class="variable">$year</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"mmonth"</span>: { <span class="string">"<span class="variable">$month</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"day"</span>: { <span class="string">"<span class="variable">$dayOfMonth</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}}, <span class="string">"count"</span> : { <span class="string">"<span class="variable">$sum</span>"</span> : 1 }}}</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>在<code>$project</code>管道中完成,方法是将<code>毫秒时间</code>添加到<code>零毫秒Date(0)</code>对象,然后从转换后的<code>日期</code>中提取<code>$year</code>,<code>$month</code>,<code>$dayOfMonth</code>个零件,可以在<code>$group</code>管道中使用这些零件对文档进行分组</p></blockquote><p>完整的查询语句拼接出来<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}}, {<span class="string">"<span class="variable">$group</span>"</span>: { <span class="string">"_id"</span>: { <span class="string">"year"</span>: { <span class="string">"<span class="variable">$year</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"mmonth"</span>: { <span class="string">"<span class="variable">$month</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"day"</span>: { <span class="string">"<span class="variable">$dayOfMonth</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ] }}}, <span class="string">"count"</span> : { <span class="string">"<span class="variable">$sum</span>"</span> : 1 }}}]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 30 }, <span class="string">"count"</span> : 624 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 28 }, <span class="string">"count"</span> : 695 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 27 }, <span class="string">"count"</span> : 683 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 26 }, <span class="string">"count"</span> : 765 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 12 }, <span class="string">"count"</span> : 610 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 4 }, <span class="string">"count"</span> : 429 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 3 }, <span class="string">"count"</span> : 475 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 29 }, <span class="string">"count"</span> : 732 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 12, <span class="string">"day"</span> : 31 }, <span class="string">"count"</span> : 592 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 12, <span class="string">"day"</span> : 30 }, <span class="string">"count"</span> : 542 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 14 }, <span class="string">"count"</span> : 1155 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 13 }, <span class="string">"count"</span> : 1169 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 20 }, <span class="string">"count"</span> : 945 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 15 }, <span class="string">"count"</span> : 1062 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 24 }, <span class="string">"count"</span> : 751 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 15 }, <span class="string">"count"</span> : 721 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 18 }, <span class="string">"count"</span> : 895 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 16 }, <span class="string">"count"</span> : 713 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 14 }, <span class="string">"count"</span> : 1278 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 17 }, <span class="string">"count"</span> : 583 }</span><br><span class="line">Type <span class="string">"it"</span> <span class="keyword">for</span> more</span><br><span class="line">mgset-11469021:SECONDARY></span><br></pre></td></tr></tbody></table></figure><p>拿这样查询出来的数据问开发是否是这样、开发确认这样可以。需求解决。</p><p>开发写了一个查询<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_report.aggregate(</span><br><span class="line">   [</span><br><span class="line">     {</span><br><span class="line">       <span class="variable">$project</span>: {</span><br><span class="line">          createTs: 1,</span><br><span class="line">          date1Str: {<span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date:{<span class="string">"<span class="variable">$add</span>"</span>:[new Date(0),{<span class="string">"<span class="variable">$multiply</span>"</span>:[<span class="string">"<span class="variable">$createTs</span>"</span>,1000]},28800000]}}}</span><br><span class="line">       }</span><br><span class="line">     }</span><br><span class="line">   ]</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>添加了时区时间28800000</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bd41d96e870a1daab7a0d6d"</span>), <span class="string">"createTs"</span> : NumberLong(1540627862), <span class="string">"date1Str"</span> : <span class="string">"2018-10-27"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bd8fc96e870a1daab5e99c1"</span>), <span class="string">"createTs"</span> : NumberLong(1540947095), <span class="string">"date1Str"</span> : <span class="string">"2018-10-31"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bf9ed96e870a1daabe6b236"</span>), <span class="string">"createTs"</span> : NumberLong(1543105942), <span class="string">"date1Str"</span> : <span class="string">"2018-11-25"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5c025140e870a1daaba6f00c"</span>), <span class="string">"createTs"</span> : NumberLong(1543655744), <span class="string">"date1Str"</span> : <span class="string">"2018-12-01"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bffc529e870a1daabadff49"</span>), <span class="string">"createTs"</span> : NumberLong(1543488809), <span class="string">"date1Str"</span> : <span class="string">"2018-11-29"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5c0ce4b8e870a1daab28b208"</span>), <span class="string">"createTs"</span> : NumberLong(1544348856), <span class="string">"date1Str"</span> : <span class="string">"2018-12-09"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bf23dc4e870a1daab3b698c"</span>), <span class="string">"createTs"</span> : NumberLong(1542602181), <span class="string">"date1Str"</span> : <span class="string">"2018-11-19"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bf1fdc2e870a1daab7729b1"</span>), <span class="string">"createTs"</span> : NumberLong(1542585793), <span class="string">"date1Str"</span> : <span class="string">"2018-11-19"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bf9ed8be870a1daabe57c10"</span>), <span class="string">"createTs"</span> : NumberLong(1543105931), <span class="string">"date1Str"</span> : <span class="string">"2018-11-25"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5c064d15e870a1daabcb43bd"</span>), <span class="string">"createTs"</span> : NumberLong(1543916821), <span class="string">"date1Str"</span> : <span class="string">"2018-12-04"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5be44e5ce870a1daabb1b84f"</span>), <span class="string">"createTs"</span> : NumberLong(1541688924), <span class="string">"date1Str"</span> : <span class="string">"2018-11-08"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bffeafee870a1daab044619"</span>), <span class="string">"createTs"</span> : NumberLong(1543498494), <span class="string">"date1Str"</span> : <span class="string">"2018-11-29"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5c076f01e870a1daabe32b96"</span>), <span class="string">"createTs"</span> : NumberLong(1543991041), <span class="string">"date1Str"</span> : <span class="string">"2018-12-05"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bdc4cc8e870a1daab855084"</span>), <span class="string">"createTs"</span> : NumberLong(1541164232), <span class="string">"date1Str"</span> : <span class="string">"2018-11-02"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bc343d8e870a1daab708be1"</span>), <span class="string">"createTs"</span> : NumberLong(1539523544), <span class="string">"date1Str"</span> : <span class="string">"2018-10-14"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bfcd64de870a1daab0d2617"</span>), <span class="string">"createTs"</span> : NumberLong(1543296589), <span class="string">"date1Str"</span> : <span class="string">"2018-11-27"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bc9adefe870a1daabf4ab80"</span>), <span class="string">"createTs"</span> : NumberLong(1539943919), <span class="string">"date1Str"</span> : <span class="string">"2018-10-19"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bbd8c31e870a1daab26cf3e"</span>), <span class="string">"createTs"</span> : NumberLong(1539148850), <span class="string">"date1Str"</span> : <span class="string">"2018-10-10"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5beff335e870a1daab8be35a"</span>), <span class="string">"createTs"</span> : NumberLong(1542452021), <span class="string">"date1Str"</span> : <span class="string">"2018-11-17"</span> }</span><br><span class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"5bc9ae33e870a1daabf4c03a"</span>), <span class="string">"createTs"</span> : NumberLong(1539943987), <span class="string">"date1Str"</span> : <span class="string">"2018-10-19"</span> }</span><br><span class="line">Type <span class="string">"it"</span> <span class="keyword">for</span> more</span><br></pre></td></tr></tbody></table></figure><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>针对DBA这个岗位来说。大多数都是从事MongoDB 运维工作 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span>。</p><p>很少贴近开发需求，这次开发问了我这个问题。我当然无法立马给出答案。只能不断的查询。拼接，才能马马虎虎的满足了开发的需求 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8">✅</span>。</p><p>刚才问一个架构师，架构师说有一个更简单的方式：</p><ol><li>查出总结出一天的数据，放到管道中临时保存起来</li><li>在用前一次查询的结束时间作为第二天的开始时间，在加上一天的时间(86400s)得出结尾时间。</li><li>查询完成在统一显示打印出来</li></ol><p>这种方式就需要使用<code>MongoDB forEach</code>方式实现了。</p><p>开发又说不能按时间排序<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f631.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f631.png?v8">😱</span> , 妹的<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span>哪里来的这么多要求<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f631.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f631.png?v8">😱</span></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>MongoDB 官方资料: <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener">aggregate资料</a></li><li><a href="https://blog.gaoqixhb.com/p/5938ca473b447c14248d41ad" target="_blank" rel="noopener">MongoDB 聚合查询 - 按时间分组统计</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiiiii.jpg&quot; class=&quot;full-image&quot; alt=
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>mongodb数据导出CSV文件</title>
    <link href="https://jiemin.wang/2019/05/17/mongodb-to-csv/"/>
    <id>https://jiemin.wang/2019/05/17/mongodb-to-csv/</id>
    <published>2019-05-17T05:45:15.000Z</published>
    <updated>2019-05-17T06:20:44.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="qiong.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>要不是因为我，你能有今天？</strong><br><strong>要不是我伤害你，你能成长？</strong></p></blockquote><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>产品需要分析达人文章的标签，需要把2019年1月1号到现在的标签，从mongo导出来，导出格式为csv，查询条件如下：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.content_medium_hismatch.find({<span class="string">"content_type_id"</span>:<span class="string">"28"</span>,<span class="string">"update_time"</span>:{<span class="string">"<span class="variable">$gte</span>"</span>:1546272000000},<span class="string">"is_delete"</span>:0}, {<span class="string">"content_id"</span>:1,<span class="string">"content_tags"</span>:1});</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>使用<code>MongoDB</code>中的<code>mongoexport</code>命令<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">mongoexport --<span class="built_in">help</span></span><br><span class="line">Usage:</span><br><span class="line">  mongoexport <options></span><br><span class="line"></span><br><span class="line">Export data from MongoDB <span class="keyword">in</span> CSV or JSON format.</span><br><span class="line"></span><br><span class="line">See http://docs.mongodb.org/manual/reference/program/mongoexport/ <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">general options:</span><br><span class="line">      --<span class="built_in">help</span>                                      <span class="built_in">print</span> usage</span><br><span class="line">      --version                                   <span class="built_in">print</span> the tool version and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">verbosity options:</span><br><span class="line">  -v, --verbose=<level>                           more detailed <span class="built_in">log</span> output (include multiple <span class="built_in">times</span> <span class="keyword">for</span> more verbosity, e.g. -vvvvv, or specify a numeric value, e.g. --verbose=N)</span><br><span class="line">      --quiet                                     hide all <span class="built_in">log</span> output</span><br><span class="line"></span><br><span class="line">connection options:</span><br><span class="line">  -h, --host=<hostname>                           mongodb host to connect to (setname/host1,host2 <span class="keyword">for</span> replica sets)</span><br><span class="line">      --port=<port>                               server port (can also use --host hostname:port)</span><br><span class="line"></span><br><span class="line">ssl options:</span><br><span class="line">      --ssl                                       connect to a mongod or mongos that has ssl enabled</span><br><span class="line">      --sslCAFile=<filename>                      the .pem file containing the root certificate chain from the certificate authority</span><br><span class="line">      --sslPEMKeyFile=<filename>                  the .pem file containing the certificate and key</span><br><span class="line">      --sslPEMKeyPassword=<password>              the password to decrypt the sslPEMKeyFile, <span class="keyword">if</span> necessary</span><br><span class="line">      --sslCRLFile=<filename>                     the .pem file containing the certificate revocation list</span><br><span class="line">      --sslAllowInvalidCertificates               bypass the validation <span class="keyword">for</span> server certificates</span><br><span class="line">      --sslAllowInvalidHostnames                  bypass the validation <span class="keyword">for</span> server name</span><br><span class="line">      --sslFIPSMode                               use FIPS mode of the installed openssl library</span><br><span class="line"></span><br><span class="line">authentication options:</span><br><span class="line">  -u, --username=<username>                       username <span class="keyword">for</span> authentication</span><br><span class="line">  -p, --password=<password>                       password <span class="keyword">for</span> authentication</span><br><span class="line">      --authenticationDatabase=<database-name>    database that holds the user<span class="string">'s credentials</span></span><br><span class="line"><span class="string">      --authenticationMechanism=<mechanism>       authentication mechanism to use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">namespace options:</span></span><br><span class="line"><span class="string">  -d, --db=<database-name>                        database to use</span></span><br><span class="line"><span class="string">  -c, --collection=<collection-name>              collection to use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">output options:</span></span><br><span class="line"><span class="string">  -f, --fields=<field>[,<field>]*                 comma separated list of field names (required for exporting CSV) e.g. -f "name,age"</span></span><br><span class="line"><span class="string">      --fieldFile=<filename>                      file with field names - 1 per line</span></span><br><span class="line"><span class="string">      --type=<type>                               the output format, either json or csv (defaults to '</span>json<span class="string">') (default: json)</span></span><br><span class="line"><span class="string">  -o, --out=<filename>                            output file; if not specified, stdout is used</span></span><br><span class="line"><span class="string">      --jsonArray                                 output to a JSON array rather than one object per line</span></span><br><span class="line"><span class="string">      --pretty                                    output JSON formatted to be human-readable</span></span><br><span class="line"><span class="string">      --noHeaderLine                              export CSV data without a list of field names at the first line</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">querying options:</span></span><br><span class="line"><span class="string">  -q, --query=<json>                              query filter, as a JSON string, e.g., '</span>{x:{<span class="variable">$gt</span>:1}}<span class="string">'</span></span><br><span class="line"><span class="string">      --queryFile=<filename>                      path to a file containing a query filter (JSON)</span></span><br><span class="line"><span class="string">  -k, --slaveOk                                   allow secondary reads if available (default true) (default: false)</span></span><br><span class="line"><span class="string">      --readPreference=<string>|<json>            specify either a preference name or a preference json object</span></span><br><span class="line"><span class="string">      --forceTableScan                            force a table scan (do not use $snapshot)</span></span><br><span class="line"><span class="string">      --skip=<count>                              number of documents to skip</span></span><br><span class="line"><span class="string">      --limit=<count>                             limit the number of documents to export</span></span><br><span class="line"><span class="string">      --sort=<json>                               sort order, as a JSON string, e.g. '</span>{x:1}<span class="string">'</span></span><br><span class="line"><span class="string">      --assertExists                              if specified, export fails if the collection does not exist (default: false)</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>操作命令如下:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</span> --<span class="built_in">type</span>=csv --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:18:52.325+0800    error validating settings: query <span class="string">'[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line">2019-05-17T13:18:52.325+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information</span><br></pre></td></tr></tbody></table></figure><p>初步判断是导出<code>CSV文件</code>中需要的<code>逗号(,)</code>分割。字段发生错误。语句添加–fields _id,content_id,content_tags<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</span> --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`2019-05-17T13:18:54.325+0800    error validating settings: query <span class="string">'[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line"> 2019-05-17T13:18:54.325+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information``bash</span><br></pre></td></tr></tbody></table></figure><p>开始排查为什么还继续报错。使用 <code>mongo shell</code> 连接到mongodb中查询发现是能获取到数据的。去掉–query 条件之后再执行一次发现是没问题<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:24:18.176+0800    connected to: localhost:29001</span><br><span class="line">2019-05-17T13:24:19.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:20.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:21.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:22.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:23.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:24.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:25.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:26.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">^C2019-05-17T13:24:26.900+0800  signal <span class="string">'interrupt'</span> received; forcefully terminating</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># ls</span></span><br><span class="line">content_medium_hismatch.csv</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># cat content_medium_hismatch.csv |more</span></span><br><span class="line">_id,content_id,content_tags</span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db599),1229,<span class="string">"["</span><span class="string">"奶瓶"</span><span class="string">","</span><span class="string">"吃奶"</span><span class="string">","</span><span class="string">"吸吮"</span><span class="string">","</span><span class="string">"乳头混淆"</span><span class="string">","</span><span class="string">"母乳"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5c8),1290,<span class="string">"["</span><span class="string">"衣服"</span><span class="string">","</span><span class="string">"二手衣服"</span><span class="string">","</span><span class="string">"清洗"</span><span class="string">","</span><span class="string">"皮肤"</span><span class="string">","</span><span class="string">"细菌"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5cd),1297,<span class="string">"["</span><span class="string">"身材"</span><span class="string">","</span><span class="string">"产后妈妈"</span><span class="string">","</span><span class="string">"新妈妈"</span><span class="string">","</span><span class="string">"裙子"</span><span class="string">","</span><span class="string">"衣服"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5e1),1325,<span class="string">"["</span><span class="string">"护肤品"</span><span class="string">","</span><span class="string">"哺乳期"</span><span class="string">","</span><span class="string">"皮肤"</span><span class="string">","</span><span class="string">"健康"</span><span class="string">","</span><span class="string">"护肤"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5e8),1343,<span class="string">"["</span><span class="string">"收纳"</span><span class="string">","</span><span class="string">"家具"</span><span class="string">","</span><span class="string">"奶粉"</span><span class="string">","</span><span class="string">"分享"</span><span class="string">","</span><span class="string">"三角形"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db618),1393,<span class="string">"["</span><span class="string">"背带"</span><span class="string">","</span><span class="string">"婴儿"</span><span class="string">","</span><span class="string">"带宝宝"</span><span class="string">","</span><span class="string">"出门"</span><span class="string">","</span><span class="string">"肌肉发育"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db65e),1465,<span class="string">"["</span><span class="string">"维生素"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"骨骼"</span><span class="string">","</span><span class="string">"眼睛"</span><span class="string">","</span><span class="string">"帮助"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db660),1467,<span class="string">"["</span><span class="string">"晒太阳"</span><span class="string">","</span><span class="string">"紫外线"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">","</span><span class="string">"黄疸"</span><span class="string">","</span><span class="string">"眼睛"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db666),1472,<span class="string">"["</span><span class="string">"伞车"</span><span class="string">","</span><span class="string">"推车"</span><span class="string">","</span><span class="string">"婴儿伞车"</span><span class="string">","</span><span class="string">"婴儿推车"</span><span class="string">","</span><span class="string">"优点"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db669),1474,<span class="string">"["</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"味觉发育"</span><span class="string">","</span><span class="string">"口味"</span><span class="string">","</span><span class="string">"食盐"</span><span class="string">","</span><span class="string">"饮食"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db674),1490,<span class="string">"["</span><span class="string">"患病"</span><span class="string">","</span><span class="string">"父母"</span><span class="string">","</span><span class="string">"指甲"</span><span class="string">","</span><span class="string">"健康"</span><span class="string">","</span><span class="string">"打呼噜"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db67a),1500,<span class="string">"["</span><span class="string">"睡眠"</span><span class="string">","</span><span class="string">"疾病"</span><span class="string">","</span><span class="string">"父母"</span><span class="string">","</span><span class="string">"症状"</span><span class="string">","</span><span class="string">"医院"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db68c),1513,<span class="string">"["</span><span class="string">"声音"</span><span class="string">","</span><span class="string">"奶睡"</span><span class="string">","</span><span class="string">"美国"</span><span class="string">","</span><span class="string">"摇晃"</span><span class="string">","</span><span class="string">"宝宝睡觉"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db6a0),1535,<span class="string">"["</span><span class="string">"安全"</span><span class="string">","</span><span class="string">"清洗"</span><span class="string">","</span><span class="string">"坐便器"</span><span class="string">","</span><span class="string">"马桶"</span><span class="string">","</span><span class="string">"优点"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db746),2732,<span class="string">"["</span><span class="string">"荔枝"</span><span class="string">","</span><span class="string">"进食"</span><span class="string">","</span><span class="string">"葡萄糖"</span><span class="string">","</span><span class="string">"上火"</span><span class="string">","</span><span class="string">"症状"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db749),2733,<span class="string">"["</span><span class="string">"宝宝喂养"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"母乳"</span><span class="string">","</span><span class="string">"饮食"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db752),2742,<span class="string">"["</span><span class="string">"乳头"</span><span class="string">","</span><span class="string">"喂奶"</span><span class="string">","</span><span class="string">"乳头皲裂"</span><span class="string">","</span><span class="string">"哺乳"</span><span class="string">","</span><span class="string">"乳房"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db758),2745,<span class="string">"["</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"挑食"</span><span class="string">","</span><span class="string">"偏食"</span><span class="string">","</span><span class="string">"爸爸"</span><span class="string">","</span><span class="string">"菠菜"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db75b),2746,<span class="string">"["</span><span class="string">"吃饭"</span><span class="string">","</span><span class="string">"爸爸"</span><span class="string">","</span><span class="string">"咀嚼"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"时间"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db75f),2747,<span class="string">"["</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"小宝"</span><span class="string">","</span><span class="string">"核桃油"</span><span class="string">","</span><span class="string">"健康"</span><span class="string">","</span><span class="string">"亚麻酸"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db761),2748,<span class="string">"["</span><span class="string">"油炸"</span><span class="string">","</span><span class="string">"健康"</span><span class="string">","</span><span class="string">"食品"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"油脂"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db768),2751,<span class="string">"["</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"膳食纤维"</span><span class="string">","</span><span class="string">"消化不良"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"肠道"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db76d),2753,<span class="string">"["</span><span class="string">"吃饭"</span><span class="string">","</span><span class="string">"饮食习惯"</span><span class="string">","</span><span class="string">"帮助"</span><span class="string">","</span><span class="string">"习惯"</span><span class="string">","</span><span class="string">"爸爸"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db770),2754,<span class="string">"["</span><span class="string">"微波炉"</span><span class="string">","</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"营养"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db773),2755,<span class="string">"["</span><span class="string">"葡萄糖"</span><span class="string">","</span><span class="string">"营养"</span><span class="string">","</span><span class="string">"习惯"</span><span class="string">","</span><span class="string">"家长"</span><span class="string">","</span><span class="string">"宝宝生病"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db775),2756,<span class="string">"["</span><span class="string">"祛湿"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"帮助"</span><span class="string">","</span><span class="string">"食谱"</span><span class="string">","</span><span class="string">"红豆"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db778),2757,<span class="string">"["</span><span class="string">"水果"</span><span class="string">","</span><span class="string">"蔬菜"</span><span class="string">","</span><span class="string">"果汁"</span><span class="string">","</span><span class="string">"配方奶"</span><span class="string">","</span><span class="string">"母乳"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db77e),2759,<span class="string">"["</span><span class="string">"挑食"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">","</span><span class="string">"营养"</span><span class="string">","</span><span class="string">"宝宝挑食"</span><span class="string">","</span><span class="string">"缺锌"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db781),2760,<span class="string">"["</span><span class="string">"吃肉"</span><span class="string">","</span><span class="string">"健康"</span><span class="string">","</span><span class="string">"水果"</span><span class="string">","</span><span class="string">"饱和脂肪酸"</span><span class="string">","</span><span class="string">"便秘"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db784),2761,<span class="string">"["</span><span class="string">"水果"</span><span class="string">","</span><span class="string">"营养"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"胡萝卜素"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db787),2762,<span class="string">"["</span><span class="string">"体重"</span><span class="string">","</span><span class="string">"宝宝瘦"</span><span class="string">","</span><span class="string">"营养不良"</span><span class="string">","</span><span class="string">"原因"</span><span class="string">","</span><span class="string">"父母"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db789),2763,<span class="string">"["</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"营养"</span><span class="string">","</span><span class="string">"宝宝喂养"</span><span class="string">","</span><span class="string">"进食"</span><span class="string">","</span><span class="string">"时间"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db790),2765,<span class="string">"["</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"宝宝断奶"</span><span class="string">","</span><span class="string">"断奶"</span><span class="string">","</span><span class="string">"保存"</span><span class="string">","</span><span class="string">"冰箱"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db792),2766,<span class="string">"["</span><span class="string">"断奶"</span><span class="string">","</span><span class="string">"母乳"</span><span class="string">","</span><span class="string">"环境"</span><span class="string">","</span><span class="string">"夏季"</span><span class="string">","</span><span class="string">"宝宝生病"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db795),2767,<span class="string">"["</span><span class="string">"益生菌"</span><span class="string">","</span><span class="string">"药物"</span><span class="string">","</span><span class="string">"食品"</span><span class="string">","</span><span class="string">"平衡"</span><span class="string">","</span><span class="string">"抗生素"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db798),2768,<span class="string">"["</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"咳嗽"</span><span class="string">","</span><span class="string">"宝宝咳嗽"</span><span class="string">","</span><span class="string">"饮食"</span><span class="string">","</span><span class="string">"辛辣"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db79b),2769,<span class="string">"["</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"饮食"</span><span class="string">","</span><span class="string">"断奶"</span><span class="string">","</span><span class="string">"宝宝断奶"</span><span class="string">","</span><span class="string">"保存"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db7a1),2773,<span class="string">"["</span><span class="string">"补钙"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">","</span><span class="string">"宝宝缺钙"</span><span class="string">","</span><span class="string">"母乳"</span><span class="string">","</span><span class="string">"配方奶"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7a6),2775,<span class="string">"["</span><span class="string">"果泥"</span><span class="string">","</span><span class="string">"水果"</span><span class="string">","</span><span class="string">"维生素"</span><span class="string">","</span><span class="string">"哈密瓜"</span><span class="string">","</span><span class="string">"香蕉"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7a9),2776,<span class="string">"["</span><span class="string">"饮食"</span><span class="string">","</span><span class="string">"食物"</span><span class="string">","</span><span class="string">"辅食"</span><span class="string">","</span><span class="string">"进食"</span><span class="string">","</span><span class="string">"水果"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7ac),2777,<span class="string">"["</span><span class="string">"有机蔬菜"</span><span class="string">","</span><span class="string">"蔬菜"</span><span class="string">","</span><span class="string">"农药"</span><span class="string">","</span><span class="string">"有机"</span><span class="string">","</span><span class="string">"农药残留"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7b4),2780,<span class="string">"["</span><span class="string">"断奶"</span><span class="string">","</span><span class="string">"乳头"</span><span class="string">","</span><span class="string">"乳房"</span><span class="string">","</span><span class="string">"乳腺炎"</span><span class="string">","</span><span class="string">"回奶"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7b8),2783,<span class="string">"["</span><span class="string">"叶黄素"</span><span class="string">","</span><span class="string">"太阳镜"</span><span class="string">","</span><span class="string">"胡萝卜"</span><span class="string">","</span><span class="string">"南瓜"</span><span class="string">","</span><span class="string">"芒果"</span><span class="string">"]"</span></span><br></pre></td></tr></tbody></table></figure><p>就能确定这么执行是没有问题。重点排查<code>--query条件</code>。根据之前报错<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:25:56.341+0800    error validating settings: query <span class="string">'[123 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 58 50 56 44 117 112 100 97 116 101 95 116 105 109 101 58 123 36 103 116 101 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 105 115 95 100 101 108 101 116 101 58 48 125 44 123 99 111 110 116 101 110 116 95 105 100 58 49 44 99 111 110 116 101 110 116 95 116 97 103 115 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line">2019-05-17T13:25:56.341+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information</span><br></pre></td></tr></tbody></table></figure><p></p><p>发现一个点<code>invalid character ',' after top-level value</code>中提示有<code>逗号,</code>的问题，排查一下<code>--query条件</code>发现有<code>'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</code>有一个<code>逗号,</code></p><p>去掉<code>逗号,</code>和后面的<code>逗号之后的条件</code>发现执行成功<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}'</span> --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:41:33.068+0800    connected to: localhost:29001</span><br><span class="line">2019-05-17T13:41:34.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:35.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:36.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:36.656+0800    feeds.content_medium_hismatch  18870</span><br><span class="line">2019-05-17T13:41:36.656+0800    exported 18870 records</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># cat content_medium_hismatch.csv |wc -l</span></span><br><span class="line">18871</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>和开发确认一下这个条件能否却掉，开发确认可以去掉。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>mongoexport</code>在执行有条件的导出文件，<code>--query</code> 条件要写在一个<code>花括号{}</code>里面，如果要有两个<code>花括号{}</code>的条件，中间用<code>逗号,</code>分割，这样是不行的。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;qiong.gif&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>详细的MySQL高性能优化实战总结</title>
    <link href="https://jiemin.wang/2019/05/16/mysql-innodb/"/>
    <id>https://jiemin.wang/2019/05/16/mysql-innodb/</id>
    <published>2019-05-16T09:53:50.000Z</published>
    <updated>2019-05-16T11:59:42.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>努力不一定成功，但是不努力会很舒服的哦!</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL 对于很多 Linux 从业者而言，是一个非常棘手的问题，多数情况都是因为对数据库出现问题的情况和处理思路不清晰。</p><p>在进行 MySQL 的优化之前必须要了解的就是 MySQL 的查询过程，很多的查询优化工作实际上就是遵循一些原则让 MySQL 的优化器能够按照预想的合理方式运行而已。</p><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><img src="http://www.plantuml.com/plantuml/svg/bLDTIm9157sVNx5i3tt0Rk_Bij3NWv15I0-HFKGj4SKgMeH4q4EKbPfbXPPeQub2k4e41Hh-6MTs_HVDxgop7ndHFDsvSywvToxdHjStTjQtP8OD9a9BymmgLurcnUYUwVLBzX0m-8pDx6xBojwuTLbb2KBlv60ZpwxPIQFsZ4fPMAZxCkZfccRwbHFuSg9dJzqmTD_wYIGbUfqyJDrxmESrGqqPcWgJDpwmhn-I97ZOkKEv37qAA4faTffUWub0Q2f8hxnr79sx5afhzBeo5wBnmY8EZm1OZiinHkHNHsBovXelEUCQ128l-RiK6AXLKF93VsrEec8QNgWu2YlzuuTULuNfAqFJm2ZbSzw9O7f2ZeSL_V4TPQf6znO-blHsWIe2VpLkFyf9TlEuylLNxxE1wTOhS5SXY7-AIsGK0eFUL5GyjsL9qdnqMKCWCVOPyEIvpSY1uc0jAmZwRHabis65ve3VGcRBRWPv8kfUNvb8BzTkvNSAxUc76V5FBL_PB8ydHNFMGpaO7LPiiBLTv7zWk5T5KjulBtWg3-5DqBQfpVy2qWNu2qXNmn5tXZJOazz4Y0LzMq02RBPs3fMABYjYzCHm9O5OSi3v1W00"><h3 id="优化的哲学"><a href="#优化的哲学" class="headerlink" title="优化的哲学"></a>优化的哲学</h3><blockquote><p>注：优化有风险，修改需谨慎。</p></blockquote><ul><li>优化可能带来的问题：</li><li>优化不总是对一个单纯的环境进行，还很可能是一个复杂的已投产的系统。</li><li>优化手段本来就有很大的风险，只不过你没能力意识到和预见到。</li><li>任何的技术可以解决一个问题，但必然存在带来一个问题的风险。</li><li>对于优化来说解决问题而带来的问题，控制在可接受的范围内才是有成果。</li><li>保持现状或出现更差的情况都是失败。</li></ul><p>优化的需求：</p><ul><li>稳定性和业务可持续性，通常比性能更重要。</li><li>优化不可避免涉及到变更，变更就有风险。</li><li>优化使性能变好，维持和变差是等概率事件。</li><li>切记优化，应该是各部门协同，共同参与的工作，任何单一部门都不能对数据库进行优化。</li></ul><p>所以优化工作，是由业务需求驱使的!</p><p>优化由谁参与?在进行数据库优化时，应由数据库管理员、业务部门代表、应用程序架构师、应用程序设计人员、应用程序开发人员、硬件及系统管理员、存储管理员等，业务相关人员共同参与。</p><h4 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h4><h4 id="优化什么"><a href="#优化什么" class="headerlink" title="优化什么"></a>优化什么</h4><p>在数据库优化上有两个主要方面：</p><ul><li>安全：数据可持续性。</li><li>性能：数据的高性能访问。</li></ul><h4 id="优化的范围有哪些"><a href="#优化的范围有哪些" class="headerlink" title="优化的范围有哪些"></a>优化的范围有哪些</h4><p>存储、主机和操作系统方面：</p><ul><li>主机架构稳定性</li><li>I/O 规划及配置</li><li>Swap 交换分区</li><li>OS 内核参数和网络问题</li></ul><p>应用程序方面：</p><ul><li>应用程序稳定性</li><li>SQL 语句性能</li><li>串行访问资源</li><li>性能欠佳会话管理</li><li>这个应用适不适合用 MySQL</li></ul><p>数据库优化方面：</p><ul><li>内存</li><li>数据库结构(物理&逻辑)</li><li>实例配置</li></ul><blockquote><p>说明：不管是设计系统、定位问题还是优化，都可以按照这个顺序执行。</p></blockquote><h4 id="优化维度"><a href="#优化维度" class="headerlink" title="优化维度"></a>优化维度</h4><img src="/2019/05/16/mysql-innodb/weidu.jpeg" title="weidu"><p>数据库优化维度有如下四个:</p><ul><li>硬件</li><li>系统配置</li><li>数据库表结构</li><li>SQL 及索引</li></ul><p>优化选择:</p><ul><li>优化成本：硬件>系统配置>数据库表结构>SQL 及索引。</li><li>优化效果：硬件<系统配置<数据库表结构</li></ul><h4 id="优化工具有啥"><a href="#优化工具有啥" class="headerlink" title="优化工具有啥"></a>优化工具有啥</h4><h2 id="数据库层面"><a href="#数据库层面" class="headerlink" title="数据库层面"></a>数据库层面</h2><p>检查问题常用的 12 个工具:</p><ul><li>MySQL</li><li>mysqladmin：MySQL 客户端，可进行管理操作</li><li>mysqlshow：功能强大的查看 shell 命令</li><li>SHOW [SESSION | GLOBAL] variables：查看数据库参数信息</li><li>SHOW [SESSION | GLOBAL] STATUS：查看数据库的状态信息</li><li>information_schema：获取元数据的方法</li><li>SHOW ENGINE INNODB STATUS：Innodb 引擎的所有状态</li><li>SHOW PROCESSLIST：查看当前所有连接的 session 状态</li><li>explain：获取查询语句的执行计划</li><li>show index：查看表的索引信息</li><li>slow-log：记录慢查询语句</li><li>mysqldumpslow：分析 slowlog 文件的工具</li></ul><p>不常用但好用的 7 个工具:</p><ul><li>Zabbix：监控主机、系统、数据库(部署 Zabbix 监控平台)</li><li>pt-query-digest：分析慢日志</li><li>MySQL slap：分析慢日志</li><li>sysbench：压力测试工具</li><li>MySQL profiling：统计数据库整体状态工具</li><li>Performance Schema：MySQL 性能状态统计的数据</li><li>workbench：管理、备份、监控、分析、优化工具(比较费资源)</li></ul><h4 id="数据库层面问题解决思路"><a href="#数据库层面问题解决思路" class="headerlink" title="数据库层面问题解决思路"></a>数据库层面问题解决思路</h4><p>一般应急调优的思路：针对突然的业务办理卡顿，无法进行正常的业务处理，需要马上解决的场景。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show processlist </span><br><span class="line">explain select id ,name from stu <span class="built_in">where</span> name=<span class="string">'clsn'</span>; <span class="comment"># ALL id name age sex </span></span><br><span class="line"> select id,name from stu <span class="built_in">where</span> id=2-1 函数 结果集>30; </span><br><span class="line">　 show index from table; </span><br><span class="line">通过执行计划判断，索引问题（有没有、合不合理）或者语句本身问题 </span><br><span class="line">show status like <span class="string">'%lock%'</span>; <span class="comment"># 查询锁状态 </span></span><br><span class="line"><span class="built_in">kill</span> SESSION_ID; <span class="comment"># 杀掉有问题的session</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>常规调优思路：针对业务周期性的卡顿，例如在每天 10-11 点业务特别慢，但是还能够使用，过了这段时间就好了。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查看slowlog，分析slowlog，分析出查询慢的语句； </span><br><span class="line">按照一定优先级，一个一个排查所有慢语句； </span><br><span class="line">分析top SQL，进行explain调试，查看语句执行时间； </span><br><span class="line">调整索引或语句本身。</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="系统层面"><a href="#系统层面" class="headerlink" title="系统层面"></a>系统层面</h4><p>CPU方面：vmstat、sar top、htop、nmon、mpstat。</p><p>内存：free、ps-aux。</p><p>IO 设备(磁盘、网络)：iostat、ss、netstat、iptraf、iftop、lsof。</p><p>vmstat 命令说明：</p><ul><li>Procs：r 显示有多少进程正在等待 CPU 时间。b 显示处于不可中断的休眠的进程数量。在等待 I/O。</li><li>Memory：swpd 显示被交换到磁盘的数据块的数量。未被使用的数据块，用户缓冲数据块，用于操作系统的数据块的数量。</li><li>Swap：操作系统每秒从磁盘上交换到内存和从内存交换到磁盘的数据块的数量。s1 和 s0 最好是 0。</li><li>IO：每秒从设备中读入 b1 的写入到设备 b0 的数据块的数量。反映了磁盘 I/O。</li><li>System：显示了每秒发生中断的数量(in)和上下文交换(cs)的数量。</li><li>CPU：显示用于运行用户代码，系统代码，空闲，等待 I/O 的 CPU 时间。</li></ul><p>iostat 命令说明：</p><ul><li>实例命令：iostat -dk 1 5;iostat -d -k -x 5 (查看设备使用率(%util)和响应时间(await))。</li><li>TPS：该设备每秒的传输次数。“一次传输”意思是“一次 I/O 请求”。多个逻辑请求可能会被合并为“一次 I/O 请求”。</li><li>iops ：硬件出厂的时候，厂家定义的一个每秒最大的 IO 次数。</li><li>“一次传输”请求的大小是未知的。</li><li>KB_read/s：每秒从设备(drive expressed)读取的数据量。</li><li>KB_wrtn/s：每秒向设备(drive expressed)写入的数据量。</li><li>KB_read：读取的总数据量。</li><li>KB_wrtn：写入的总数量数据量;这些单位都为 Kilobytes。</li></ul><h4 id="系统层面问题解决办法"><a href="#系统层面问题解决办法" class="headerlink" title="系统层面问题解决办法"></a>系统层面问题解决办法</h4><p>你认为到底负载高好，还是低好呢?在实际的生产中，一般认为 CPU 只要不超过 90% 都没什么问题。当然不排除下面这些特殊情况。</p><p>CPU 负载高，IO 负载低：</p><ul><li>内存不够</li><li>磁盘性能差</li><li>SQL 问题：去数据库层，进一步排查 SQL 问题</li><li>IO 出问题了(磁盘到临界了、raid 设计不好、raid 降级、锁、在单位时间内 TPS 过高)</li><li>TPS 过高：大量的小数据 IO、大量的全表扫描</li></ul><p>IO 负载高，CPU 负载低：</p><ul><li>大量小的 IO 写操作</li><li>autocommit，产生大量小 IO;IO/PS，磁盘的一个定值，硬件出厂的时候，厂家定义的一个每秒最大的 IO 次数。</li><li>大量大的 IO 写操作：SQL 问题的几率比较大</li></ul><p>IO和 CPU 负载都很高：</p><ul><li>硬件不够了或 SQL 存在问题</li></ul><h2 id="基础优化"><a href="#基础优化" class="headerlink" title="基础优化"></a>基础优化</h2><h4 id="优化思路-1"><a href="#优化思路-1" class="headerlink" title="优化思路"></a>优化思路</h4><p>定位问题点吮吸：硬件>系统>应用>数据库>架构(高可用、读写分离、分库分表)。</p><p>处理方向：明确优化目标、性能和安全的折中、防患未然。</p><h4 id="硬件优化"><a href="#硬件优化" class="headerlink" title="硬件优化"></a>硬件优化</h4><h5 id="主机方面"><a href="#主机方面" class="headerlink" title="主机方面"></a>主机方面</h5><p>根据数据库类型，主机 CPU 选择、内存容量选择、磁盘选择：</p><ul><li>平衡内存和磁盘资源</li><li>随机的 I/O 和顺序的 I/O</li><li>主机 RAID 卡的 BBU(Battery Backup Unit)关闭</li></ul><h5 id="CPU-的选择"><a href="#CPU-的选择" class="headerlink" title="CPU 的选择"></a>CPU 的选择</h5><p>CPU 的两个关键因素：核数、主频。根据不同的业务类型进行选择：</p><ul><li>CPU 密集型：计算比较多，OLTP 主频很高的 CPU、核数还要多。</li><li>IO 密集型：查询比较，OLAP 核数要多，主频不一定高的。</li></ul><h5 id="内存的选择"><a href="#内存的选择" class="headerlink" title="内存的选择"></a>内存的选择</h5><p>OLAP 类型数据库，需要更多内存，和数据获取量级有关。OLTP 类型数据一般内存是 CPU 核心数量的 2 倍到 4 倍，没有最佳实践。</p><h5 id="存储方面"><a href="#存储方面" class="headerlink" title="存储方面"></a>存储方面</h5><p>根据存储数据种类的不同，选择不同的存储设备，配置合理的 RAID 级别(raid5、raid10、热备盘)。</p><p>对于操作系统来讲，不需要太特殊的选择，最好做好冗余(raid1)(ssd、sas、sata)。</p><p>主机 raid 卡选择：</p><ul><li>实现操作系统磁盘的冗余(raid1)</li><li>平衡内存和磁盘资源</li><li>随机的 I/O 和顺序的 I/O</li><li>主机 raid 卡的 BBU(Battery Backup Unit)要关闭</li></ul><h5 id="网络设备方面"><a href="#网络设备方面" class="headerlink" title="网络设备方面"></a>网络设备方面</h5><p>使用流量支持更高的网络设备(交换机、路由器、网线、网卡、HBA 卡)。注意：以上这些规划应该在初始设计系统时就应该考虑好。</p><h4 id="服务器硬件优化"><a href="#服务器硬件优化" class="headerlink" title="服务器硬件优化"></a>服务器硬件优化</h4><p>服务器硬件优化关键点：</p><ul><li>物理状态灯</li><li>自带管理设备：远程控制卡(FENCE设备：ipmi ilo idarc)、开关机、硬件监控。</li><li>第三方的监控软件、设备(snmp、agent)对物理设施进行监控。</li><li>存储设备：自带的监控平台。EMC2(HP 收购了)、 日立(HDS)、IBM 低端 OEM HDS、高端存储是自己技术，华为存储。</li></ul><h4 id="系统优化"><a href="#系统优化" class="headerlink" title="系统优化"></a>系统优化</h4><p>CPU：基本不需要调整，在硬件选择方面下功夫即可。</p><p>内存：基本不需要调整，在硬件选择方面下功夫即可。</p><p>SWAP：MySQL 尽量避免使用 Swap。阿里云的服务器中默认 swap 为 0。</p><p>IO ：raid、no lvm、ext4 或 xfs、ssd、IO 调度策略。</p><p>Swap 调整(不使用 swap 分区)：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm/swappiness的内容改成0(临时)，/etc/sysctl. conf上添加vm.swappiness=0(永久)</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个参数决定了 Linux 是倾向于使用 Swap，还是倾向于释放文件系统 Cache。在内存紧张的情况下，数值越低越倾向于释放文件系统 Cache。</p><p>当然，这个参数只能减少使用 Swap 的概率，并不能避免 Linux 使用 Swap。</p><p>修改 MySQL 的配置参数 innodb_flush_ method，开启 O_DIRECT 模式。</p><p>这种情况下，InnoDB 的 buffer pool 会直接绕过文件系统 Cache 来访问磁盘，但是 redo log 依旧会使用文件系统 Cache。</p><p>值得注意的是，Redo log 是覆写模式的，即使使用了文件系统的 Cache，也不会占用太多。</p><p>IO 调度策略：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#echo deadline>/sys/block/sda/queue/scheduler 临时修改为deadline</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>永久修改<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /boot/grub/grub.conf </span><br><span class="line">更改到如下内容: </span><br><span class="line">kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="系统参数调整"><a href="#系统参数调整" class="headerlink" title="系统参数调整"></a>系统参数调整</h4><p>Linux 系统内核参数优化<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/sysctl.conf </span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535：<span class="comment"># 用户端口范围 </span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096 </span><br><span class="line">net.ipv4.tcp_fin_timeout = 30 </span><br><span class="line">fs.file-max=65535：<span class="comment"># 系统最大文件句柄，控制的是能打开文件最大数量</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>用户限制参数(MySQL 可以不设置以下配置)：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/security/limits.conf </span><br><span class="line">* soft nproc 65535 </span><br><span class="line">* hard nproc 65535 </span><br><span class="line">* soft nofile 65535 </span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="应用优化"><a href="#应用优化" class="headerlink" title="应用优化"></a>应用优化</h2><p>业务应用和数据库应用独立。</p><p>防火墙：iptables、selinux 等其他无用服务(关闭)：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 23456 acpid off </span><br><span class="line">chkconfig --level 23456 anacron off </span><br><span class="line">chkconfig --level 23456 autofs off </span><br><span class="line">chkconfig --level 23456 avahi-daemon off </span><br><span class="line">chkconfig --level 23456 bluetooth off </span><br><span class="line">chkconfig --level 23456 cups off </span><br><span class="line">chkconfig --level 23456 firstboot off </span><br><span class="line">chkconfig --level 23456 haldaemon off </span><br><span class="line">chkconfig --level 23456 hplip off </span><br><span class="line">chkconfig --level 23456 ip6tables off </span><br><span class="line">chkconfig --level 23456 iptables off </span><br><span class="line">chkconfig --level 23456 isdn off </span><br><span class="line">chkconfig --level 23456 pcscd off </span><br><span class="line">chkconfig --level 23456 sendmail off </span><br><span class="line">chkconfig --level 23456 yum-updatesd off</span><br></pre></td></tr></tbody></table></figure><p></p><p>安装图形界面的服务器不要启动图形界面 runlevel 3。</p><p>另外，思考将来我们的业务是否真的需要 MySQL，还是使用其他种类的数据库。用数据库的最高境界就是不用数据库。</p><h2 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h2><p>SQL 优化方向：</p><ul><li>执行计划</li><li>索引</li><li>SQL 改写</li></ul><p>架构优化方向：</p><ul><li>高可用架构</li><li>高性能架构</li><li>分库分表</li></ul><h4 id="数据库参数优化"><a href="#数据库参数优化" class="headerlink" title="数据库参数优化"></a>数据库参数优化</h4><h5 id="调整"><a href="#调整" class="headerlink" title="调整"></a>调整</h5><p>实例整体(高级优化，扩展)：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thread_concurrency：<span class="comment"># 并发线程数量个数 </span></span><br><span class="line">sort_buffer_size：<span class="comment"># 排序缓存 </span></span><br><span class="line">read_buffer_size：<span class="comment"># 顺序读取缓存 </span></span><br><span class="line">read_rnd_buffer_size：<span class="comment"># 随机读取缓存 </span></span><br><span class="line">key_buffer_size：<span class="comment"># 索引缓存 </span></span><br><span class="line">thread_cache_size：<span class="comment"># (1G—>8, 2G—>16, 3G—>32, >3G—>64)</span></span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="连接层-基础优化"><a href="#连接层-基础优化" class="headerlink" title="连接层(基础优化)"></a>连接层(基础优化)</h5><p>设置合理的连接客户和连接方式：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">max_connections <span class="comment"># 最大连接数，看交易笔数设置 </span></span><br><span class="line">max_connect_errors <span class="comment"># 最大错误连接数，能大则大 </span></span><br><span class="line">connect_timeout <span class="comment"># 连接超时 </span></span><br><span class="line">max_user_connections <span class="comment"># 最大用户连接数 </span></span><br><span class="line">skip-name-resolve <span class="comment"># 跳过域名解析 </span></span><br><span class="line">wait_timeout <span class="comment"># 等待超时 </span></span><br><span class="line">back_log <span class="comment"># 可以在堆栈中的连接数量 </span></span><br><span class="line">```      </span><br><span class="line"><span class="comment">##### SQL 层(基础优化)</span></span><br><span class="line">query_cache_size： 查询缓存 >>> OLAP 类型数据库，需要重点加大此内存缓存，但是一般不会超过 GB。</span><br><span class="line"></span><br><span class="line">对于经常被修改的数据，缓存会马上失效。我们可以使用内存数据库(redis、memecache)，替代它的功能。</span><br><span class="line"></span><br><span class="line"><span class="comment">##### 存储引擎层优化</span></span><br><span class="line">innodb 基础优化参数：</span><br><span class="line">```bash</span><br><span class="line">default-storage-engine </span><br><span class="line">innodb_buffer_pool_size <span class="comment"># 没有固定大小，50%测试值，看看情况再微调。但是尽量设置不要超过物理内存70% </span></span><br><span class="line">innodb_file_per_table=(1,0) </span><br><span class="line">innodb_flush_log_at_trx_commit=(0,1,2) <span class="comment"># 1是最安全的，0是性能最高，2折中 </span></span><br><span class="line">binlog_sync </span><br><span class="line">Innodb_flush_method=(O_DIRECT, fdatasync) </span><br><span class="line">innodb_log_buffer_size <span class="comment"># 100M以下 </span></span><br><span class="line">innodb_log_file_size <span class="comment"># 100M 以下 </span></span><br><span class="line">innodb_log_files_in_group <span class="comment"># 5个成员以下,一般2-3个够用（iblogfile0-N） </span></span><br><span class="line">innodb_max_dirty_pages_pct <span class="comment"># 达到百分之75的时候刷写 内存脏页到磁盘。 </span></span><br><span class="line">log_bin </span><br><span class="line">max_binlog_cache_size <span class="comment"># 可以不设置 </span></span><br><span class="line">max_binlog_size <span class="comment"># 可以不设置 </span></span><br><span class="line">innodb_additional_mem_pool_size <span class="comment">#小于2G内存的机器，推荐值是20M。32G内存以上100M</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>51CTO传媒: <a href="https://www.toutiao.com/i6647024189007987208/?tt_from=weixin&utm_campaign=client_share&wxshare_count=2&from=singlemessage&timestamp=1555614491&app=news_article&utm_source=weixin&isappinstalled=0&utm_medium=toutiao_ios&req_id=201904190308110100230720231370496&group_id=6647024189007987208&pbid=6691541599112283651" target="_blank" rel="noopener">一份超详细的MySQL高性能优化实战总结</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiiii.jpg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>pt-table-checksum fails on older MySQL without utf8mb4-support</title>
    <link href="https://jiemin.wang/2019/05/14/PT-0/"/>
    <id>https://jiemin.wang/2019/05/14/PT-0/</id>
    <published>2019-05-14T02:45:11.000Z</published>
    <updated>2019-05-14T03:30:30.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="bs.png" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>“别再抱怨你此生找不到一个对的人，当初的数学选择题就四个，你也找不到对的答案啊”</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天帮同事解决主从同步的问题。</p><p>原因是同事使用<code>Django</code>开发了一套运维平台。但是里面的表使用了<code>FOREIGN KEY</code>，在插入的是报错。造成了<code>主从同步错误</code>，数据量不大，使用<code>pt-table-checksum</code>来校验主从数据</p><h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>一、先跳过主从错误，主从同步关系恢复正常。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE sql_thread;</span><br><span class="line">SET GLOBAL sql_slave_skip_counter = 1;</span><br><span class="line">START SLAVE sql_thread;</span><br><span class="line">SHOW SLAVE STATUS\G</span><br></pre></td></tr></tbody></table></figure><p></p><p>二、使用 pt-table-checksum<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-checksum --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password=<span class="string">'*****'</span> --recursion-method=<span class="string">'processlist'</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Error setting innodb_lock_wait_timeout: DBD::mysql::db <span class="keyword">do</span> failed: Variable <span class="string">'innodb_lock_wait_timeout'</span> is a <span class="built_in">read</span> only variable [<span class="keyword">for</span> Statement <span class="string">"SET SESSION innodb_lock_wait_timeout=1"</span>].  The current value <span class="keyword">for</span> innodb_lock_wait_timeout is 50.  If the variable is <span class="built_in">read</span> only (not dynamic), specify --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=50 to avoid this warning, <span class="keyword">else</span> manually <span class="built_in">set</span> the variable and restart MySQL.</span><br><span class="line"></span><br><span class="line">Checking <span class="keyword">if</span> all tables can be checksummed ...</span><br><span class="line">Starting checksum ...</span><br><span class="line">Error setting innodb_lock_wait_timeout: DBD::mysql::db <span class="keyword">do</span> failed: Variable <span class="string">'innodb_lock_wait_timeout'</span> is a <span class="built_in">read</span> only variable [<span class="keyword">for</span> Statement <span class="string">"SET SESSION innodb_lock_wait_timeout=1"</span>].  The current value <span class="keyword">for</span> innodb_lock_wait_timeout is 50.  If the variable is <span class="built_in">read</span> only (not dynamic), specify --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=50 to avoid this warning, <span class="keyword">else</span> manually <span class="built_in">set</span> the variable and restart MySQL.</span><br><span class="line"></span><br><span class="line">05-13T18:42:19 Error executing EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(<span class="string">'#'</span>, `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/: DBD::mysql::st execute failed: Unknown character <span class="built_in">set</span>: <span class="string">'utf8mb4'</span> [<span class="keyword">for</span> Statement <span class="string">"EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/"</span>] at /usr/bin/pt-table-checksum line 12302.</span><br><span class="line"></span><br><span class="line">05-13T18:42:19 Error checksumming table bportal.server_basic_info: Error executing checksum query: DBD::mysql::st execute failed: Unknown character <span class="built_in">set</span>: <span class="string">'utf8mb4'</span> [<span class="keyword">for</span> Statement <span class="string">"REPLACE INTO `test`.`checksums` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT ?, ?, ?, ?, ?, ?, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*checksum table*/"</span> with ParamValues: 0=<span class="string">'bportal'</span>, 1=<span class="string">'server_basic_info'</span>, 2=1, 3=undef, 4=undef, 5=undef] at /usr/bin/pt-table-checksum line 11691.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            TS ERRORS  DIFFS     ROWS  DIFF_ROWS  CHUNKS SKIPPED    TIME TABLE</span><br><span class="line">05-13T18:42:19      2      0        0          0       1       0   0.008 bportal.server_basic_info</span><br></pre></td></tr></tbody></table></figure><h4 id="于是排除问题："><a href="#于是排除问题：" class="headerlink" title="于是排除问题："></a>于是排除问题：</h4><ol><li>查看MySQL 版本</li><li>查看MySQL 字符集</li><li>查看数据库和表的字符集<h4 id="google查找问题原因"><a href="#google查找问题原因" class="headerlink" title="google查找问题原因"></a>google查找问题原因</h4>发现篇文章和该错误几乎一致。说到pt-table-checksum已经不支持MySQL 5.1版本。<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thank you <span class="keyword">for</span> the report.</span><br><span class="line"></span><br><span class="line">The error is expected since  character <span class="built_in">set</span> utf8mb4 Unknown to the MySQL 5.1</span><br><span class="line"></span><br><span class="line">MySQL 5.1 is not a supported version: https://www.percona.com/services/support/mysql-support/percona-toolkit-supported-platforms-and-versions</span><br></pre></td></tr></tbody></table></figure></li></ol><p>写了一个<a href="./pt-table-checksum.utf8mb4.patch">patch</a></p><h4 id="pt-table-checksum打补丁"><a href="#pt-table-checksum打补丁" class="headerlink" title="pt-table-checksum打补丁"></a>pt-table-checksum打补丁</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patch pt-table-checksum < pt-table-checksum.utf8mb4.patch</span><br></pre></td></tr></tbody></table></figure><h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-checksum --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password=<span class="string">'*****'</span> --recursion-method=<span class="string">'processlist'</span></span><br></pre></td></tr></tbody></table></figure><p>发现没有上面的问题，一切都正常。在执行<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-sync --replicate=test.checksums --databases=***** --charset=utf8 h=****,P=****,u=****,p=<span class="string">'****'</span> --execute</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用MySQL 5.1版本的数据库赶快升级吧。太折腾人了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>Percona: <a href="https://jira.percona.com/browse/PT-1552" target="_blank" rel="noopener">jira</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;bs.png&quot; class=&quot;full-image&quot; alt=&quot;alt
      
    
    </summary>
    
      <category term="Toolkit" scheme="https://jiemin.wang/categories/Toolkit/"/>
    
    
      <category term="Toolkit" scheme="https://jiemin.wang/tags/Toolkit/"/>
    
  </entry>
  
  <entry>
    <title>图解Go的channel底层原理</title>
    <link href="https://jiemin.wang/2019/05/05/go-channal-graphic/"/>
    <id>https://jiemin.wang/2019/05/05/go-channal-graphic/</id>
    <published>2019-05-05T05:33:49.000Z</published>
    <updated>2019-05-05T06:13:58.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>努力不一定成功，但是不努力会很舒服的哦!</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>channel的整体结构图<br><img src="/2019/05/05/go-channal-graphic/hchan.png" title="hchan"></p><p>简单说明：</p><ul><li><code>buf</code>是有缓冲的channel所特有的结构，用来存储缓存数据。是个循环链表</li><li><code>sendx</code>和<code>recvx</code>用于记录<code>buf</code>这个循环链表中的~发送或者接收的~index</li><li><code>lock</code>是个互斥锁。</li><li><code>recvq</code>和<code>sendq</code>分别是接收(<-channel)或者发送(channel <- xxx)的goroutine抽象出来的结构体(sudog)的队列。是个双向链表</li></ul><p>源码位于<code>/runtime/chan.go</code>中(目前版本：1.11)。结构体为<code>hchan</code>。<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> {</span><br><span class="line">    qcount   <span class="keyword">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">    dataqsiz <span class="keyword">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">    buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">    elemsize <span class="keyword">uint16</span></span><br><span class="line">    closed   <span class="keyword">uint32</span></span><br><span class="line">    elemtype *_type <span class="comment">// element type</span></span><br><span class="line">    sendx    <span class="keyword">uint</span>   <span class="comment">// send index</span></span><br><span class="line">    recvx    <span class="keyword">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">    recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">    sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lock protects all fields in hchan, as well as several</span></span><br><span class="line">    <span class="comment">// fields in sudogs blocked on this channel.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Do not change another G's status while holding this lock</span></span><br><span class="line">    <span class="comment">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class="line">    <span class="comment">// with stack shrinking.</span></span><br><span class="line">    lock mutex</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>下面我们来详细介绍<code>hchan</code>中各部分是如何使用的。</p><h2 id="详细介绍"><a href="#详细介绍" class="headerlink" title="详细介绍"></a>详细介绍</h2><p>先从创建开始</p><p>我们首先创建一个channel。<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/05/05/go-channal-graphic/hchan1.png" title="hchan1"><p>创建channel实际上就是在内存中实例化了一个<code>hchan</code>的结构体，并返回一个ch指针，我们使用过程中channel在函数之间的传递都是用的这个指针，这就是为什么函数传递中无需使用channel的指针，而直接用channel就行了，因为channel本身就是一个指针。</p><h4 id="channel中发送send-ch-lt-xxx-和recv-lt-ch-接收"><a href="#channel中发送send-ch-lt-xxx-和recv-lt-ch-接收" class="headerlink" title="channel中发送send(ch <- xxx)和recv(<- ch)接收"></a>channel中发送send(ch <- xxx)和recv(<- ch)接收</h4><p>先考虑一个问题，如果你想让goroutine以先进先出(FIFO)的方式进入一个结构体中，你会怎么操作？<br>加锁！对的！channel就是用了一个锁。hchan本身包含一个互斥锁<code>mutex</code></p><h4 id="channel中队列是如何实现的"><a href="#channel中队列是如何实现的" class="headerlink" title="channel中队列是如何实现的"></a>channel中队列是如何实现的</h4><p>channel中有个缓存buf，是用来缓存数据的(假如实例化了带缓存的channel的话)队列。我们先来看看是如何实现“队列”的。<br>还是刚才创建的那个channel<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/05/05/go-channal-graphic/hchan_gif1.png" title="hchan_gif1"><p>当使用<code>send (ch <- xx)</code>或者<code>recv ( <-ch)</code>的时候，首先要锁住<code>hchan</code>这个结构体。</p><img src="/2019/05/05/go-channal-graphic/hchan_gif2.png" title="hchan_gif2"><p>然后开始<code>send (ch <- xx)</code>数据。</p><p>一<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>二<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>三<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这时候满了，队列塞不进去了</p><p>动态图表示为：<br><img src="/2019/05/05/go-channal-graphic/send.gif" title="send"><br>然后是取<code>recv ( <-ch)</code>的过程，是个逆向的操作，也是需要加锁。<br><img src="/2019/05/05/go-channal-graphic/hchan_gif6.png" title="hchan_gif6"></p><p>然后开始<code>recv (<-ch)</code>数据。<br>一<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>二<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>三<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>图为：<br><img src="/2019/05/05/go-channal-graphic/recv.gif" title="recv"><br>注意以上两幅图中<code>buf</code>和<code>recvx</code>以及<code>sendx</code>的变化，<code>recvx</code>和<code>sendx</code>是根据循环链表<code>buf</code>的变动而改变的。</p><p>至于为什么<code>channel</code>会使用<code>循环链表</code>作为缓存结构，我个人认为是在缓存列表在动态的<code>send</code>和<code>recv</code>过程中，定位当前<code>send</code>或者<code>recvx</code>的位置、选择<code>send</code>的和<code>recvx</code>的位置比较方便吧，只要顺着链表顺序一直旋转操作就好。</p><p>缓存中按链表顺序存放，取数据的时候按链表顺序读取，符合FIFO的原则。</p><h4 id="send-recv的细化操作"><a href="#send-recv的细化操作" class="headerlink" title="send/recv的细化操作"></a>send/recv的细化操作</h4><p>注意：缓存链表中以上每一步的操作，都是需要加锁操作的！</p><p>每一步的操作的细节可以细化为：</p><ul><li>第一，加锁</li><li>第二，把数据从goroutine中copy到“队列”中(或者从队列中copy到goroutine中）。</li><li>第三，释放锁</li></ul><p>每一步的操作总结为动态图为：(发送过程)<br><img src="/2019/05/05/go-channal-graphic/send_single.gif" title="send_single"></p><p>或者为：(接收过程)<br><img src="/2019/05/05/go-channal-graphic/recv_single.gif" title="recv_single"></p><p>所以不难看出，Go中那句经典的话：<code>Do not communicate by sharing memory; instead, share memory by communicating.</code>的具体实现就是利用channel把数据从一端copy到了另一端！</p><p>还真是符合<code>channel</code>的英文含义：<br><img src="/2019/05/05/go-channal-graphic/hchan_channl.gif" title="hchan_channl"></p><h4 id="当channel缓存满了之后会发生什么？这其中的原理是怎样的？"><a href="#当channel缓存满了之后会发生什么？这其中的原理是怎样的？" class="headerlink" title="当channel缓存满了之后会发生什么？这其中的原理是怎样的？"></a>当channel缓存满了之后会发生什么？这其中的原理是怎样的？</h4><p>使用的时候，我们都知道，当channel缓存满了，或者没有缓存的时候，我们继续send(ch <- xxx)或者recv(<- ch)会阻塞当前goroutine，但是，是如何实现的呢？</p><p>我们知道，Go的goroutine是用户态的线程(<code>user-space threads</code>)，用户态的线程是需要自己去调度的，Go有运行时的scheduler去帮我们完成调度这件事情。关于Go的调度模型GMP模型我在此不做赘述，如果不了解，可以看我另一篇文章(<a href="https://i6448038.github.io/2017/12/04/golang-concurrency-principle/" target="_blank" rel="noopener">Go并发原理</a>)</p><p>goroutine的阻塞操作，实际上是调用<code>send (ch <- xx)</code>或者<code>recv ( <-ch)</code>的时候主动触发的，具体请看以下内容：</p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//goroutine1 中，记做G1</span></span><br><span class="line"></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">ch <- <span class="number">1</span></span><br><span class="line">ch <- <span class="number">1</span></span><br><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><img src="/2019/05/05/go-channal-graphic/hchan_block.png" title="hchan_block"><img src="/2019/05/05/go-channal-graphic/hchan_block1.png" title="hchan_block1"><p>这个时候G1正在正常运行,当再次进行send操作(ch<-1)的时候，会主动调用Go的调度器,让G1等待，并从让出M，让其他G去使用<br><img src="/2019/05/05/go-channal-graphic/hchan_block2.png" title="hchan_block2"></p><p>同时G1也会被抽象成含有G1指针和send元素的<code>sudog</code>结构体保存到hchan的<code>sendq</code>中等待被唤醒。<br><img src="/2019/05/05/go-channal-graphic/hchan_blok3.gif" title="hchan_blok3"></p><p>那么，G1什么时候被唤醒呢？这个时候G2隆重登场。<br><img src="/2019/05/05/go-channal-graphic/hchan_block4.png" title="hchan_block4"></p><p>G2执行了recv操作<code>p := <-ch</code>，于是会发生以下的操作：<br><img src="/2019/05/05/go-channal-graphic/hchan_block5.gif" title="hchan_block5"></p><p>G2从缓存队列中取出数据，channel会将等待队列中的G1推出，将G1当时send的数据推到缓存中，然后调用Go的scheduler，唤醒G1，并把G1放到可运行的Goroutine队列中。<br><img src="/2019/05/05/go-channal-graphic/hchan_block6.gif" title="hchan_block6"></p><h4 id="假如是先进行执行recv操作的G2会怎么样？"><a href="#假如是先进行执行recv操作的G2会怎么样？" class="headerlink" title="假如是先进行执行recv操作的G2会怎么样？"></a>假如是先进行执行recv操作的G2会怎么样？</h4><p>你可能会顺着以上的思路反推。首先：<br><img src="/2019/05/05/go-channal-graphic/hchan_block7_1.png" title="hchan_block7_1"></p><p>这个时候G2会主动调用Go的调度器,让G2等待，并从让出M，让其他G去使用。</p><p>G2还会被抽象成含有G2指针和recv空元素的<code>sudog</code>结构体保存到hchan的<code>recvq</code>中等待被唤醒<br><img src="/2019/05/05/go-channal-graphic/hchan_block7.gif" title="hchan_block7"></p><p>此时恰好有个goroutine G1开始向channel中推送数据 <code>ch <- 1</code>。</p><p>此时，非常有意思的事情发生了：<br><img src="/2019/05/05/go-channal-graphic/hchan_block8.gif" title="hchan_block8"></p><p>G1并没有锁住channel，然后将数据放到缓存中，而是直接把数据从G1直接copy到了G2的栈中。</p><p>这种方式非常的赞！在唤醒过程中，G2无需再获得channel的锁，然后从缓存中取数据。减少了内存的copy，提高了效率。</p><p>之后的事情显而易见：<br><img src="/2019/05/05/go-channal-graphic/hchan_block9.gif" title="hchan_block9"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.youtube.com/watch?v=KBZlN0izeiY" target="_blank" rel="noopener">youtube</a></li><li><a href="https://zhuanlan.zhihu.com/p/27917262" target="_blank" rel="noopener">深入理解Golang Channel</a></li></ul><h2 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h2><ul><li><a href="https://i6448038.github.io/2019/04/11/go-channel/" target="_blank" rel="noopener">图解Go的channel底层实现(RyuGou)</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiii.jpg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="Golang" scheme="https://jiemin.wang/categories/Golang/"/>
    
    
      <category term="Golang" scheme="https://jiemin.wang/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>最全Oracle DBA日常维护SQL脚本命令</title>
    <link href="https://jiemin.wang/2019/04/26/oracle-ops-sql/"/>
    <id>https://jiemin.wang/2019/04/26/oracle-ops-sql/</id>
    <published>2019-04-26T01:23:59.000Z</published>
    <updated>2019-04-26T02:54:17.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaa.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>“原谅他们是上帝的事，我们的任务是负责送他们见上帝。”</strong></p></blockquote><h2 id="SQL-语句"><a href="#SQL-语句" class="headerlink" title="SQL 语句"></a>SQL 语句</h2><h4 id="查询碎片程度高（实际使用率小于30-）的表"><a href="#查询碎片程度高（实际使用率小于30-）的表" class="headerlink" title="查询碎片程度高（实际使用率小于30%）的表"></a>查询碎片程度高（实际使用率小于30%）的表</h4><p>可以收缩的表条件为什么<code>block>100</code>，因为一些很小的表，只有几行数据实际大小很小，但是block一次性分配就是5个（11g开始默认一次性分配1M的block大小了，见create table storged的NEXT参数），5个block相对于几行小表数据来说就相差太大了。</p><p>算法中<code>/0.9</code>是因为块的<code>pfree</code>一般为<code>10%</code>，所以一个块最多只用了<code>90%</code>，而且一行数据大于<code>8KB</code>时容易产生行链接，把一行分片存储，一样的一个块连<code>90%</code>都用不满 ，<code>AVG_ROW_LEN</code>还是比较准的，比如个人实验情况一表6个字段，一个<code>numbe</code>r，其他5个都是<code>char(100)</code>但是实际数据都是’1111111’7位，AVG_ROW_LEN显示依然为513 。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT TABLE_NAME,</span><br><span class="line">        (BLOCKS * 8192/1024/1024) <span class="string">"理论大小M"</span>,</span><br><span class="line">         (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9) <span class="string">"实际大小M"</span>,</span><br><span class="line">         ROUND((NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024),</span><br><span class="line">         3) * 100|| <span class="string">'%'</span> <span class="string">"实际使用率%"</span></span><br><span class="line">FROM USER_TABLES</span><br><span class="line">WHERE blocks > 100</span><br><span class="line">        AND (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) < 0.3</span><br><span class="line">ORDER BY  (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) DESC</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查询索引碎片的比例"><a href="#查询索引碎片的比例" class="headerlink" title="查询索引碎片的比例"></a>查询索引碎片的比例</h4><p>索引删除行数除以索引总行数的百分比>30%即认为索引碎片大，也就是需要重建的索引<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT name,</span><br><span class="line">         del_lf_rows,</span><br><span class="line">         lf_rows,</span><br><span class="line">         ROUND(del_lf_rows/decode(lf_rows,</span><br><span class="line">         0,</span><br><span class="line">         1,</span><br><span class="line">         lf_rows) * 100,</span><br><span class="line">        0)||<span class="string">'%'</span> frag_pct</span><br><span class="line">FROM index_stats</span><br><span class="line">WHERE ROUND(del_lf_rows/decode(lf_rows, 0, 1, lf_rows) * 100,0) > 30;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="集群因子clustering-factor高的表"><a href="#集群因子clustering-factor高的表" class="headerlink" title="集群因子clustering_factor高的表"></a>集群因子clustering_factor高的表</h4><p>集群因子越接近块数越好，接近行数则说明索引列的列值相等的行分布极度散列，可能不走索引扫描而走全表扫描 ：</p><h5 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT tab.table_name,</span><br><span class="line">         tab.blocks,</span><br><span class="line">         tab.num_rows,</span><br><span class="line">         ind.index_name,</span><br><span class="line">         ind.clustering_factor,</span><br><span class="line">         ROUND(nvl(ind.clustering_factor,</span><br><span class="line">         1)/decode(tab.num_rows,</span><br><span class="line">         0,</span><br><span class="line">         1,</span><br><span class="line">         tab.num_rows),</span><br><span class="line">         3) * 100||<span class="string">'%'</span> <span class="string">"集群因子接近行数"</span></span><br><span class="line">FROM user_tables tab, user_indexes ind</span><br><span class="line">WHERE tab.table_name = ind.table_name</span><br><span class="line">        AND tab.blocks>100</span><br><span class="line">        AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows)</span><br><span class="line">    BETWEEN 0.35</span><br><span class="line">        AND 3</span><br></pre></td></tr></tbody></table></figure><h5 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SELECT tab.owner,</span><br><span class="line">         tab.table_name,</span><br><span class="line">         tab.blocks,</span><br><span class="line">         tab.num_rows,</span><br><span class="line">         ind.index_name,</span><br><span class="line">         ind.clustering_factor,</span><br><span class="line">         round(nvl(ind.clustering_factor,</span><br><span class="line">        1)/decode(tab.num_rows,</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        tab.num_rows),</span><br><span class="line">        3)*100||<span class="string">'%'</span> <span class="string">"集群因子接近行数"</span></span><br><span class="line">FROM dba_tables tab, dba_indexes ind</span><br><span class="line">WHERE tab.table_name=ind.table_name</span><br><span class="line">        AND tab.owner NOT IN (<span class="string">'SYS'</span>, <span class="string">'SYSTEM'</span>, <span class="string">'WMSYS'</span>, <span class="string">'DBSNMP'</span>, <span class="string">'CTXSYS'</span>, <span class="string">'XDB'</span>, <span class="string">'ORDDATA'</span>, <span class="string">'SYSMAN'</span>, <span class="string">'CATALOG'</span>, <span class="string">'APEX_030200'</span>, <span class="string">'MDSYS'</span>, <span class="string">'OLAPSYS'</span>, <span class="string">'EXFSYS'</span>)</span><br><span class="line">        AND tab.blocks > 100</span><br><span class="line">        AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows)</span><br><span class="line">    BETWEEN 0.35</span><br><span class="line">        AND 3</span><br></pre></td></tr></tbody></table></figure><h4 id="根据sid查spid或根据spid查sid"><a href="#根据sid查spid或根据spid查sid" class="headerlink" title="根据sid查spid或根据spid查sid"></a>根据sid查spid或根据spid查sid</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         p.spid,</span><br><span class="line">         s.terminal,</span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.status,</span><br><span class="line">         s.PROGRAM,</span><br><span class="line">         s.CLIENT_IDENTIFIER,</span><br><span class="line">         s.machine,</span><br><span class="line">         s.action,</span><br><span class="line">         s.MODULE,</span><br><span class="line">         s.PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         s.osuser</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.sid=XX</span><br><span class="line">        OR p.spid=YY</span><br></pre></td></tr></tbody></table></figure><h4 id="根据sid查看具体的sql语句，不要加条件v-session-status-39-ACTIVE-39-，比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select-from-v-session时会发现另一个窗口在v-session-status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql-id对应的语句就是select-from-v-session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。"><a href="#根据sid查看具体的sql语句，不要加条件v-session-status-39-ACTIVE-39-，比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select-from-v-session时会发现另一个窗口在v-session-status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql-id对应的语句就是select-from-v-session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。" class="headerlink" title="根据sid查看具体的sql语句，不要加条件v$session.status='ACTIVE'，比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select * from v$session时会发现另一个窗口在v$session.status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql_id对应的语句就是select * from v$session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。"></a>根据<code>sid</code>查看具体的<code>sql语句</code>，不要加条件<code>v$session.status='ACTIVE'</code>，比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询<code>select * from v$session</code>时会发现另一个窗口在<code>v$session.status</code>是<code>INACTIVE</code>，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql_id对应的语句就是<code>select * from v$session</code>而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。</h4><p>一个sid可能执行过很多个sql，所以有时需要的sql通过如下查不到是正常的，比如查询到某死锁源sid，通过如下查询可能只是个<code>select语句</code>，而真正引起死锁的sql却查不到，是因为可能这个sid持续了很长时间，这个sid之前执行的一些sql在<code>v$sql</code>可能已经被清除了。</p><h5 id="方法一：-1"><a href="#方法一：-1" class="headerlink" title="方法一："></a>方法一：</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SELECT username,</span><br><span class="line">         sid,</span><br><span class="line">        SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">        action,</span><br><span class="line">         PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         osuser,</span><br><span class="line">         sql_text</span><br><span class="line">FROM v<span class="variable">$session</span> a, v<span class="variable">$sqltext_with_newlines</span> b</span><br><span class="line">WHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value</span><br><span class="line">        AND a.sid=&sid</span><br><span class="line">ORDER BY  piece; </span><br><span class="line">``` </span><br><span class="line"><span class="comment">##### 方法二:</span></span><br><span class="line">```bash</span><br><span class="line">SELECT username,</span><br><span class="line">         sid,</span><br><span class="line">        SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         sql_fulltext,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">         a.action,</span><br><span class="line">         PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         osuser</span><br><span class="line">FROM v<span class="variable">$session</span> a, v<span class="variable">$sql</span> b</span><br><span class="line">WHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value</span><br><span class="line">        AND a.sid=&sid</span><br></pre></td></tr></tbody></table></figure><h5 id="如果上面语句执行太慢，则按如下两步"><a href="#如果上面语句执行太慢，则按如下两步" class="headerlink" title="如果上面语句执行太慢，则按如下两步"></a>如果上面语句执行太慢，则按如下两步</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT sql_hash_value,</span><br><span class="line">         prev_hash_value,</span><br><span class="line">         username,</span><br><span class="line">         sid.SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">         action,</span><br><span class="line">         PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         osuser</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE sid=&sidSELECT sql_fulltext</span><br><span class="line">FROM v<span class="variable">$sql</span></span><br><span class="line">WHERE hash_value=XX</span><br></pre></td></tr></tbody></table></figure><blockquote><ul><li>XX为上面 <code>sql_hash_value</code>，如果 <code>sql_hash_value为0</code>，则XX为上面 <code>prev_hash_value</code></li></ul></blockquote><h4 id="根据spid查询具体的sql语句-不要加条件v-session-status-’-ACTIVE’-比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select-from-v-session时会发现另一个窗口在v-session-status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql-id对应的语句就是select-from-v-session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。"><a href="#根据spid查询具体的sql语句-不要加条件v-session-status-’-ACTIVE’-比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select-from-v-session时会发现另一个窗口在v-session-status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql-id对应的语句就是select-from-v-session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。" class="headerlink" title="根据spid查询具体的sql语句(不要加条件v$session.status=’ ACTIVE’,比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select  from v$session时会发现另一个窗口在v$session.status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql_id对应的语句就是select  from v$session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。)"></a>根据spid查询具体的sql语句(不要加条件v$session.status=’ ACTIVE’,比如toad对同一数据库开两个连接会话，都执行了一些语句，其中一个窗口查询select <em> from v$session时会发现另一个窗口在v$session.status是INACTIVE，并不代表另一个窗口没有执行过sql语句，而当前窗口是active状态，对应的sql_id对应的语句就是select </em> from v$session而不是之前执行过的sql语句，ACTIVE表示当前正在执行sql。)</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT ss.SID,</span><br><span class="line">         ss.SERIAL<span class="comment">#,</span></span><br><span class="line">         ss.LOGON_TIME,</span><br><span class="line">         pr.SPID,</span><br><span class="line">         sa.SQL_FULLTEXT,</span><br><span class="line">         ss.machine,</span><br><span class="line">         ss.TERMINAL,</span><br><span class="line">         ss.PROGRAM,</span><br><span class="line">         ss.USERNAME,</span><br><span class="line">         ss.CLIENT_IDENTIFIER,</span><br><span class="line">         ss.action,</span><br><span class="line">         ss.PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         ss.STATUS,</span><br><span class="line">         ss.OSUSER,</span><br><span class="line">         ss.status,</span><br><span class="line">         ss.last_call_et,</span><br><span class="line">         sa.sql_text</span><br><span class="line">FROM v<span class="variable">$process</span> pr, v<span class="variable">$session</span> ss, v<span class="variable">$sql</span> sa</span><br><span class="line">WHERE pr.ADDR = ss.PADDR</span><br><span class="line">        AND DECODE(ss.sql_hash_value, 0, prev_hash_value, sql_hash_value)=sa.hash_value</span><br><span class="line">        AND pr.spid=&spid</span><br></pre></td></tr></tbody></table></figure><h4 id="查看历史session-id的SQL来自哪个IP"><a href="#查看历史session-id的SQL来自哪个IP" class="headerlink" title="查看历史session_id的SQL来自哪个IP"></a>查看历史session_id的SQL来自哪个IP</h4><p>查看trace文件名就可以知道spid,trace文件里面有sid和具体sql，如果trace存在incident，那trace就看不到具体sql，但是可以在incident文件中看到具体的sql，如DW_ora_17751.trc中17751就是spid，里面有这样的内容Incident 115 created, dump file: /XX/incident/incdir_115/DW_ora_17751_i115.trc，那么在DW_ora_17751_i115.trc就可以看到具体的sql语句)</p><p>DB_ora_29349.trc中出现<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*** SESSION ID:(5057.12807) 2016-10-26 14:45:52.726</span><br></pre></td></tr></tbody></table></figure><p></p><p>通过表<code>V$ACTIVE_SESSION_HISTORY</code>来查<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.sql_id,</span><br><span class="line">         a.machine,</span><br><span class="line">         a.*</span><br><span class="line">FROM V<span class="variable">$ACTIVE_SESSION_HISTORY</span> a</span><br><span class="line">WHERE a.session_id=5057</span><br><span class="line">        AND a.SESSION_SERIAL<span class="comment">#=12807</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查询上面的machine的IP"><a href="#查询上面的machine的IP" class="headerlink" title="查询上面的machine的IP"></a>查询上面的machine的IP</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.machine,</span><br><span class="line">         p.spid,</span><br><span class="line">         p.terminal</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.machine=<span class="string">'localhost'</span></span><br></pre></td></tr></tbody></table></figure><p>通过上面的<code>spid</code>在oracle服务器上执行<code>netstat -anp |grep spid</code>即可<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@dwdb trace]$ netstat -anp |grep 17630 </span><br><span class="line">tcp      210      0 192.168.64.228:11095        192.168.21.16:1521          ESTABLISHED 17630/oracleDB </span><br><span class="line">tcp        0      0 ::ffff:192.168.64.228:1521  ::ffff:192.168.64.220:59848 ESTABLISHED 17630/oracleDB</span><br></pre></td></tr></tbody></table></figure><p></p><p>出现两个，说明来自220，连接了228数据库服务器，但是又通过228服务器的dblink去连接了16服务器 </p><h4 id="查询死锁堵塞的会话sid"><a href="#查询死锁堵塞的会话sid" class="headerlink" title="查询死锁堵塞的会话sid"></a>查询死锁堵塞的会话sid</h4><p>最简单的一个SQL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from V<span class="variable">$SESSION_BLOCKERS</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from dba_waiters</span><br></pre></td></tr></tbody></table></figure><p></p><p>最常用的一个SQL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT sid,</span><br><span class="line">         status,</span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         sql_id,</span><br><span class="line">         blocking_session <span class="string">"死锁直接源"</span>,</span><br><span class="line">         FINAL_BLOCKING_SESSION <span class="string">"死锁最终源"</span>,</span><br><span class="line">         event,</span><br><span class="line">        seconds_in_wait <span class="string">"会话锁住时间_S"</span>,</span><br><span class="line">         LAST_CALL_ET <span class="string">"会话STATUS持续时间_S"</span></span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE state=<span class="string">'WAITING'</span></span><br><span class="line">        AND BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br><span class="line">        AND FINAL_BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>可以把两者<code>SID</code>放入<code>v$session</code>，发现<code>LOGON_TIME</code>字段<code>FINAL_BLOCKING_SESSION</code>比<code>SID</code>要早 </p><blockquote><p>BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if BLOCKING_SESSION_STATUS has the value VALID. </p></blockquote><blockquote><p>FINAL_BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if FINAL_BLOCKING_SESSION_STATUS has the value VALID. </p></blockquote><p>如果遇到<code>RAC环境</code>，一定要用<code>gv$</code>来查，并且执行<code>alter system kill session 'sid,serial#'</code>要到<code>RAC</code>对应的实例上去执行   </p><p>把上面被堵塞会话的<code>sid</code>代入如下语句，可以发现锁住的对象和对象的哪一行(如果<code>sid</code>是堵塞源的会话，则 <code>row_wait_obj#=-1</code>，表示锁持有者，就是死锁源了 )<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.username,</span><br><span class="line">         d.owner,</span><br><span class="line">         d.object_name,</span><br><span class="line">         s.row_wait_obj<span class="comment">#,</span></span><br><span class="line">         s.row_wait_row<span class="comment">#,</span></span><br><span class="line">         s.row_wait_file<span class="comment">#,</span></span><br><span class="line">         s.row_wait_block<span class="comment">#</span></span><br><span class="line">FROM v<span class="variable">$session</span> s, dba_objects d</span><br><span class="line">WHERE s.row_wait_obj<span class="comment"># = d.object_id</span></span><br><span class="line">        AND s.sid <span class="keyword">in</span>(XX,XX)</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查询锁住的DDL对象"><a href="#查询锁住的DDL对象" class="headerlink" title="查询锁住的DDL对象"></a>查询锁住的DDL对象</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT d.session_id,</span><br><span class="line">         s.SERIAL<span class="comment">#,</span></span><br><span class="line">         d.name</span><br><span class="line">FROM dba_ddl_locks d, v<span class="variable">$session</span> s</span><br><span class="line">WHERE d.owner = <span class="string">'MKLMIGEM'</span></span><br><span class="line">        AND d.SESSION_ID=s.sid</span><br></pre></td></tr></tbody></table></figure><h4 id="查询超过两个小时的不活动会话"><a href="#查询超过两个小时的不活动会话" class="headerlink" title="查询超过两个小时的不活动会话"></a>查询超过两个小时的不活动会话</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         p.spid,</span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.LAST_CALL_ET,</span><br><span class="line">         s.status,</span><br><span class="line">         s.PROGRAM,</span><br><span class="line">         s.CLIENT_IDENTIFIER,</span><br><span class="line">         s.machine,</span><br><span class="line">         s.terminal,</span><br><span class="line">         s.action,</span><br><span class="line">         s.PROCESS <span class="string">"客户端机器进程号"</span>,</span><br><span class="line">         s.osuser</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.sid IN </span><br><span class="line">    (SELECT sid</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE machine <> &DB服务器名称</span><br><span class="line">            AND status=<span class="string">'INACTIVE'</span></span><br><span class="line">            AND sql_id is null</span><br><span class="line">            AND LAST_CALL_ET > 7200 )</span><br></pre></td></tr></tbody></table></figure><h4 id="查询堵塞别的会话超过30分钟且自身是不活动的会话"><a href="#查询堵塞别的会话超过30分钟且自身是不活动的会话" class="headerlink" title="查询堵塞别的会话超过30分钟且自身是不活动的会话"></a>查询堵塞别的会话超过30分钟且自身是不活动的会话</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT username,</span><br><span class="line">        sid,</span><br><span class="line">        serial<span class="comment">#,</span></span><br><span class="line">        status,</span><br><span class="line">        seconds_in_wait,</span><br><span class="line">        LAST_CALL_ET</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE sid IN </span><br><span class="line">    (SELECT FINAL_BLOCKING_SESSION</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE state=<span class="string">'WAITING'</span></span><br><span class="line">            AND BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br><span class="line">            AND FINAL_BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span>)</span><br><span class="line">        AND status=<span class="string">'INACTIVE'</span></span><br><span class="line">        AND sql_id is null</span><br><span class="line">        AND seconds_in_wait>1800</span><br></pre></td></tr></tbody></table></figure><h4 id="查询可能存在连接池空闲初始配置过大的连接（来自同一台机器的同一个程序的状态为INACTIVE的连接非常多）"><a href="#查询可能存在连接池空闲初始配置过大的连接（来自同一台机器的同一个程序的状态为INACTIVE的连接非常多）" class="headerlink" title="查询可能存在连接池空闲初始配置过大的连接（来自同一台机器的同一个程序的状态为INACTIVE的连接非常多）"></a>查询可能存在连接池空闲初始配置过大的连接（来自同一台机器的同一个程序的状态为INACTIVE的连接非常多）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT count(ss.SID),</span><br><span class="line">        ss.machine,</span><br><span class="line">        ss.status,</span><br><span class="line">        ss.TERMINAL,</span><br><span class="line">        ss.PROGRAM,</span><br><span class="line">        ss.USERNAME,</span><br><span class="line">        ss.CLIENT_IDENTIFIER</span><br><span class="line">FROM v<span class="variable">$session</span> ss</span><br><span class="line">GROUP BY  ss.machine,ss.status,ss.TERMINAL,ss.PROGRAM,ss.USERNAME,ss.CLIENT_IDENTIFIER</span><br><span class="line">HAVING count(ss.SID)>10</span><br></pre></td></tr></tbody></table></figure><h4 id="查询当前正在执行的sql"><a href="#查询当前正在执行的sql" class="headerlink" title="查询当前正在执行的sql"></a>查询当前正在执行的sql</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.username,</span><br><span class="line">        spid,</span><br><span class="line">        v<span class="variable">$sql</span>.sql_id,</span><br><span class="line">        machine,</span><br><span class="line">        s.terminal,</span><br><span class="line">        s.program,</span><br><span class="line">        sql_text</span><br><span class="line">FROM v<span class="variable">$process</span>,v<span class="variable">$session</span> s,v<span class="variable">$sql</span></span><br><span class="line">WHERE addr=paddr</span><br><span class="line">        AND s.sql_id=v<span class="variable">$sql</span>.sql_id</span><br><span class="line">        AND sql_hash_value=hash_value</span><br><span class="line">        AND s.STATUS=<span class="string">'ACTIVE'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="查询正在执行的SCHEDULER-JOB"><a href="#查询正在执行的SCHEDULER-JOB" class="headerlink" title="查询正在执行的SCHEDULER_JOB"></a>查询正在执行的SCHEDULER_JOB</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT owner,</span><br><span class="line">        job_name,</span><br><span class="line">        sid,</span><br><span class="line">        b.SERIAL<span class="comment">#,</span></span><br><span class="line">        b.username,</span><br><span class="line">        spid</span><br><span class="line">FROM ALL_SCHEDULER_RUNNING_JOBS,v<span class="variable">$session</span> b,v<span class="variable">$process</span></span><br><span class="line">WHERE session_id=sid</span><br><span class="line">        AND paddr=addr</span><br></pre></td></tr></tbody></table></figure><h4 id="查询正在执行的dbms-job"><a href="#查询正在执行的dbms-job" class="headerlink" title="查询正在执行的dbms_job"></a>查询正在执行的dbms_job</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT job,</span><br><span class="line">        b.sid,</span><br><span class="line">        b.SERIAL<span class="comment">#,</span></span><br><span class="line">        b.username,</span><br><span class="line">        spid</span><br><span class="line">FROM DBA_JOBS_RUNNING a ,v<span class="variable">$session</span> b,v<span class="variable">$process</span></span><br><span class="line">WHERE a.sid=b.sid</span><br><span class="line">        AND paddr=addr</span><br></pre></td></tr></tbody></table></figure><h4 id="查询一个会话session、process平均消耗多少PGA内存，查看下面avg-used-M值"><a href="#查询一个会话session、process平均消耗多少PGA内存，查看下面avg-used-M值" class="headerlink" title="查询一个会话session、process平均消耗多少PGA内存，查看下面avg_used_M值"></a>查询一个会话session、process平均消耗多少PGA内存，查看下面avg_used_M值</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT round(sum(pga_used_mem)/1024/1024,</span><br><span class="line">        0) total_used_M,</span><br><span class="line">         round(sum(pga_used_mem)/count(1)/1024/1024,</span><br><span class="line">        0) avg_used_M,</span><br><span class="line">         round(sum(pga_alloc_mem)/1024/1024,</span><br><span class="line">        0) total_alloc_M,</span><br><span class="line">         round(sum(pga_alloc_mem)/count(1)/1024/1024,</span><br><span class="line">        0) avg_alloc_M</span><br><span class="line">FROM v<span class="variable">$process</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="TOP-10-执行次数排序"><a href="#TOP-10-执行次数排序" class="headerlink" title="TOP 10 执行次数排序"></a>TOP 10 执行次数排序</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT executions,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  executions desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><h4 id="TOP-10-物理读排序（消耗IO排序，即最差性能SQL、低效SQL排序）"><a href="#TOP-10-物理读排序（消耗IO排序，即最差性能SQL、低效SQL排序）" class="headerlink" title="TOP 10 物理读排序（消耗IO排序，即最差性能SQL、低效SQL排序）"></a>TOP 10 物理读排序（消耗IO排序，即最差性能SQL、低效SQL排序）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT DISK_READS,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  DISK_READS desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：不要使用DISK_READS/ EXECUTIONS来排序，因为任何一条语句不管执行几次都会耗逻辑读和cpu，可能不会耗物理读（遇到LRU还会耗物理读，LRU规则是执行最不频繁的且最后一次执行时间距离现在最久远的就会被交互出buffer cache），是因为buffer cache存放的是数据块，去数据块里找行一定会消耗cpu和逻辑读的。Shared pool执行存放sql的解析结果，sql执行的时候只是去share pool中找hash value，如果有匹配的就是软解析。所以物理读逻辑读是在buffer cache中，软解析硬解析是在shared pool</p></blockquote><h4 id="TOP-10-逻辑读排序（消耗内存排序）"><a href="#TOP-10-逻辑读排序（消耗内存排序）" class="headerlink" title="TOP 10 逻辑读排序（消耗内存排序）"></a>TOP 10 逻辑读排序（消耗内存排序）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT BUFFER_GETS,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  BUFFER_GETS desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：不要使用BUFFER_GETS/ EXECUTIONS来排序，因为任何一条语句不管执行几次都会耗逻辑读和cpu，可能不会耗物理读（遇到LRU还会耗物理读，LRU规则是执行最不频繁的且最后一次执行时间距离现在最久远的就会被交互出buffer cache），是因为buffer cache存放的是数据块，去数据块里找行一定会消耗cpu和逻辑读的。Shared pool执行存放sql的解析结果，sql执行的时候只是去share pool中找hash value，如果有匹配的就是软解析。所以物理读逻辑读是在buffer cache中，软解析硬解析是在shared pool）</p></blockquote><h4 id="TOP-10-CPU排序-单位秒-cpu-time-1000000"><a href="#TOP-10-CPU排序-单位秒-cpu-time-1000000" class="headerlink" title="TOP 10 CPU排序(单位秒=cpu_time/1000000)"></a>TOP 10 CPU排序(单位秒=cpu_time/1000000)</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT CPU_TIME/1000000,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  CPU_TIME/1000000 desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：不要使用CPU_TIME/ EXECUTIONS来排序，因为任何一条语句不管执行几次都会耗逻辑读和cpu，可能不会耗物理读（遇到LRU还会耗物理读，LRU规则是执行最不频繁的且最后一次执行时间距离现在最久远的就会被交互出buffer cache），是因为buffer cache存放的是数据块，去数据块里找行一定会消耗cpu和逻辑读的。Shared pool执行存放sql的解析结果，sql执行的时候只是去share pool中找hash value，如果有匹配的就是软解析。所以物理读逻辑读是在buffer cache中，软解析硬解析是在shared pool。</p></blockquote><h4 id="查询等待事件"><a href="#查询等待事件" class="headerlink" title="查询等待事件"></a>查询等待事件</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT event,</span><br><span class="line">        sum(decode(wait_time,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        1)) <span class="string">"之前等待次数"</span>,</span><br><span class="line">         sum(decode(wait_time,</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        0)) <span class="string">"正在等待次数"</span>,</span><br><span class="line">        count(*)</span><br><span class="line">FROM v<span class="variable">$session_wait</span></span><br><span class="line">GROUP BY  event</span><br><span class="line">ORDER BY  4 DESC </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### 查询当前等待事件对应的对象</span></span><br><span class="line">```bash</span><br><span class="line">SELECT DISTINCT wait_class<span class="comment">#,</span></span><br><span class="line">        wait_class</span><br><span class="line">FROM v<span class="variable">$session_wait_class</span></span><br><span class="line">ORDER BY  1</span><br></pre></td></tr></tbody></table></figure><h4 id="以上sql发现wait-class-6的是空闲等待"><a href="#以上sql发现wait-class-6的是空闲等待" class="headerlink" title="以上sql发现wait_class#=6的是空闲等待"></a>以上sql发现wait_class#=6的是空闲等待</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT sid,</span><br><span class="line">        event,</span><br><span class="line">        p1text,</span><br><span class="line">        p1,</span><br><span class="line">        p2text,</span><br><span class="line">        p2,</span><br><span class="line">        p3text,</span><br><span class="line">        p3,</span><br><span class="line">        WAIT_TIME,</span><br><span class="line">        SECONDS_IN_WAIT,</span><br><span class="line">        wait_class<span class="comment">#</span></span><br><span class="line">    FROM v<span class="variable">$session_wait</span></span><br><span class="line">    WHERE wait_class<span class="comment"># <> 6</span></span><br><span class="line">    ORDER BY  wait_time desc)</span><br><span class="line">WHERE rownum <=10;</span><br></pre></td></tr></tbody></table></figure><h4 id="能查出等待的对象是否来自数据文件（如果以上查到p1text是file-或file-number）"><a href="#能查出等待的对象是否来自数据文件（如果以上查到p1text是file-或file-number）" class="headerlink" title="能查出等待的对象是否来自数据文件（如果以上查到p1text是file#或file number）"></a>能查出等待的对象是否来自数据文件（如果以上查到p1text是file#或file number）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT owner,</span><br><span class="line">        segment_name,</span><br><span class="line">        segment_type,</span><br><span class="line">        block_id,</span><br><span class="line">        bytes</span><br><span class="line">    FROM dba_extents</span><br><span class="line">    WHERE file_id=p1</span><br><span class="line">            AND block_id<p2 order=<span class="string">""</span> by=<span class="string">""</span> block_id=<span class="string">""</span> desc)</span><br><span class="line">WHERE rownum<2</span><br></pre></td></tr></tbody></table></figure><p>把上面第二个sql结果的p1、p2值代入上述sql的file_id、block_id</p><p>通过<code>AWR</code>的<code>top sql</code>或<code>v$sql.sql_text</code>查看是否有该对象的语句，检查该语句的执行计划就可以查出问题所在。</p><h4 id="查询当前正在消耗临时空间的sql语句"><a href="#查询当前正在消耗临时空间的sql语句" class="headerlink" title="查询当前正在消耗临时空间的sql语句"></a>查询当前正在消耗临时空间的sql语句</h4><h5 id="方法一：-2"><a href="#方法一：-2" class="headerlink" title="方法一："></a>方法一：</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT se.username,</span><br><span class="line">         se.sid,</span><br><span class="line">         su.blocks * to_number(rtrim(p.value))/1024/1024 AS space_G,</span><br><span class="line">         su.tablespace,</span><br><span class="line">         sql_text</span><br><span class="line">FROM V<span class="variable">$TEMPSEG_USAGE</span> su, v<span class="variable">$parameter</span> p, v<span class="variable">$session</span> se, v<span class="variable">$sql</span> s</span><br><span class="line">WHERE p.name = <span class="string">'db_block_size'</span></span><br><span class="line">        AND su.session_addr=se.saddr</span><br><span class="line">        AND su.sqlhash=s.hash_value</span><br><span class="line">        AND su.sqladdr=s.address</span><br><span class="line">        AND se.STATUS=<span class="string">'ACTIVE'</span></span><br><span class="line">``` </span><br><span class="line"><span class="comment">##### 方法二：</span></span><br><span class="line">```bash</span><br><span class="line">SELECT v<span class="variable">$sql</span>.sql_id,</span><br><span class="line">        v<span class="variable">$sql</span>.sql_fulltext,</span><br><span class="line">        swa.TEMPSEG_SIZE/1024/1024 TEMPSEG_M,</span><br><span class="line">         swa.*</span><br><span class="line">FROM v<span class="variable">$sql_workarea_active</span> swa,v<span class="variable">$sql</span></span><br><span class="line">WHERE swa.sql_id=v<span class="variable">$sql</span>.sql_id</span><br><span class="line">        AND swa.NUMBER_PASSES>0</span><br></pre></td></tr></tbody></table></figure><h4 id="查询因PGA不足而使用临时表空间的最频繁的10条SQL语句"><a href="#查询因PGA不足而使用临时表空间的最频繁的10条SQL语句" class="headerlink" title="查询因PGA不足而使用临时表空间的最频繁的10条SQL语句"></a>查询因PGA不足而使用临时表空间的最频繁的10条SQL语句</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT OPERATION_TYPE,</span><br><span class="line">        ESTIMATED_OPTIMAL_SIZE,</span><br><span class="line">        ESTIMATED_ONEPASS_SIZE,</span><br><span class="line">         sum(OPTIMAL_EXECUTIONS) optimal_cnt,</span><br><span class="line">        sum(ONEPASS_EXECUTIONS) AS onepass_cnt,</span><br><span class="line">         sum(MULTIPASSES_EXECUTIONS) AS mpass_cnt,</span><br><span class="line">        s.sql_text</span><br><span class="line">    FROM V<span class="variable">$SQL_WORKAREA</span> swa, v<span class="variable">$sql</span> s</span><br><span class="line">    WHERE swa.sql_id=s.sql_id</span><br><span class="line">    GROUP BY  OPERATION_TYPE,ESTIMATED_OPTIMAL_SIZE,ESTIMATED_ONEPASS_SIZE,sql_text</span><br><span class="line">    HAVING sum(ONEPASS_EXECUTIONS+MULTIPASSES_EXECUTIONS)>0</span><br><span class="line">    ORDER BY  sum(ONEPASS_EXECUTIONS) DESC )</span><br><span class="line">WHERE rownum<10</span><br></pre></td></tr></tbody></table></figure><h4 id="查询正在消耗PGA的SQL"><a href="#查询正在消耗PGA的SQL" class="headerlink" title="查询正在消耗PGA的SQL"></a>查询正在消耗PGA的SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sql_text,</span><br><span class="line">         sw.EXPECTED_SIZE,</span><br><span class="line">         sw.ACTUAL_MEM_USED,</span><br><span class="line">        sw.NUMBER_PASSES,</span><br><span class="line">         sw.TEMPSEG_SIZE</span><br><span class="line">FROM v<span class="variable">$sql_workarea_active</span> sw, v<span class="variable">$sql</span> s</span><br><span class="line">WHERE sw.sql_id=s.sql_id;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询需要使用绑定变量的sql，10G以后推荐第二种"><a href="#查询需要使用绑定变量的sql，10G以后推荐第二种" class="headerlink" title="查询需要使用绑定变量的sql，10G以后推荐第二种"></a>查询需要使用绑定变量的sql，10G以后推荐第二种</h4><blockquote><p>注意：任何一条执行过的语句不管执行了几次在V$SQL中都只有一条记录，V$SQL中会记录执行了几次。两条一模一样的语句但是在不同的schema下执行的两种结果，如select <em> from t1.test在sye、system下执行则V$SQL只有一条记录(谁先执行则PARSING_SCHEMA_NAME显示谁)。如在sys和system都执行select </em> from test则V$SQL中有两条记录，两条记录的CHILD_NUMBER和PARSING_SCHEMA_NAME不一样。</p></blockquote><p>同一个用户下执行一样的语句如果大小写不一样或加了hint的话则会出现多个V$SQL记录，说明V$SQL对应的sql语句必须一模一样，如果alter system flush shared_pool（主站慎用）后再执行一样的语句，发现语句在V$SQL中的SQL_ID和HASH_VALUE与之前的一样，说明SQL_ID和HASH_VALUE应该是oracle自己的一套算法来的，只是根据sql语句内容来进行转换，sql语句不变则SQL_ID和HASH_VALUE也不变。</p><h5 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT count(*),</span><br><span class="line">        sql_id,</span><br><span class="line">         substr(sql_text,</span><br><span class="line">        1,</span><br><span class="line">        40)</span><br><span class="line">    FROM v<span class="variable">$sql</span></span><br><span class="line">    GROUP BY  sql_id, substr(sql_text,1,40)</span><br><span class="line">    HAVING count(*) > 10</span><br><span class="line">    ORDER BY  count(*) desc)</span><br><span class="line">WHERE rownum<10</span><br></pre></td></tr></tbody></table></figure><h5 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">count(1)>10表示类语句运行了10次以上SELECT sql_id,</span><br><span class="line">         FORCE_MATCHING_SIGNATURE,</span><br><span class="line">         sql_text</span><br><span class="line">FROM v<span class="variable">$SQL</span></span><br><span class="line">WHERE FORCE_MATCHING_SIGNATURE IN </span><br><span class="line">    (SELECT /*+ unnest */ FORCE_MATCHING_SIGNATURE</span><br><span class="line">    FROM v<span class="variable">$sql</span></span><br><span class="line">    WHERE FORCE_MATCHING_SIGNATURE > 0</span><br><span class="line">            AND FORCE_MATCHING_SIGNATURE != EXACT_MATCHING_SIGNATURE</span><br><span class="line">    GROUP BY  FORCE_MATCHING_SIGNATURE</span><br><span class="line">    HAVING count(1) > 10)</span><br></pre></td></tr></tbody></table></figure><h4 id="查看数据文件可用百分比"><a href="#查看数据文件可用百分比" class="headerlink" title="查看数据文件可用百分比"></a>查看数据文件可用百分比</h4><p><code>dba_free_space</code>并不会包含所有<code>file_id</code>，如果该数据文件满了，则 <code>dba_free_space.file_id</code>没有该数据文件，所以以下sql中 <code>a.file_id=b.file_id</code>的条件过滤后是不会有所有file_id的<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.file_id,</span><br><span class="line">        b.tablespace_name,</span><br><span class="line">        b.file_name,</span><br><span class="line">        b.AUTOEXTENSIBLE,</span><br><span class="line">         ROUND(b.MAXBYTES/1024/1024/1024,</span><br><span class="line">        2) ||<span class="string">'G'</span> <span class="string">"文件最大可用总容量"</span>, ROUND(b.bytes/1024/1024/1024,2) ||<span class="string">'G'</span> <span class="string">"文件总容量"</span>, ROUND((b.bytes-sum(nvl(a.bytes,0)))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"文件已用容量"</span>, ROUND(sum(nvl(a.bytes,0))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"文件可用容量"</span>, ROUND(sum(nvl(a.bytes,0))/(b.bytes),2)*100||<span class="string">'%'</span> <span class="string">"文件可用百分比"</span></span><br><span class="line">FROM dba_free_space a,dba_data_files b</span><br><span class="line">WHERE a.file_id=b.file_id</span><br><span class="line">GROUP BY  b.tablespace_name,b.file_name,b.file_id,b.bytes,b.AUTOEXTENSIBLE,b.MAXBYTES</span><br><span class="line">ORDER BY  b.tablespace_name;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>如下为标准版<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.file_id,</span><br><span class="line">        b.tablespace_name,</span><br><span class="line">        b.file_name,</span><br><span class="line">        b.AUTOEXTENSIBLE,</span><br><span class="line">         ROUND(b.MAXBYTES/1024/1024/1024,</span><br><span class="line">        2) ||<span class="string">'G'</span> <span class="string">"文件最大可用总容量"</span>, ROUND(b.bytes/1024/1024/1024,2) ||<span class="string">'G'</span> <span class="string">"文件当前总容量"</span>, ROUND((b.bytes-sum(nvl(a.bytes,0)))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"文件当前已用容量"</span>, ROUND((decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes)/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"文件可用容量"</span>, ROUND((decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes)/(decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)),2)*100||<span class="string">'%'</span> <span class="string">"文件可用百分比"</span></span><br><span class="line">FROM dba_free_space a,dba_data_files b</span><br><span class="line">WHERE a.file_id=b.file_id</span><br><span class="line">GROUP BY  b.tablespace_name,b.file_name,b.file_id,b.bytes,b.AUTOEXTENSIBLE,b.MAXBYTES</span><br><span class="line">ORDER BY  decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="查看数据库文件的实际总量，单位G"><a href="#查看数据库文件的实际总量，单位G" class="headerlink" title="查看数据库文件的实际总量，单位G"></a>查看数据库文件的实际总量，单位G</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.datafile_size+b.tempfile_size-c.free_size</span><br><span class="line">FROM </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) datafile_size</span><br><span class="line">    FROM dba_data_files ) a, </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) tempfile_size</span><br><span class="line">    FROM dba_temp_files ) b, </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) free_size</span><br><span class="line">    FROM dba_free_space ) c</span><br></pre></td></tr></tbody></table></figure><h4 id="查看表空间可用百分比（-dba-free-space不会包含所有tablespace，如果一个表空间的数据文件都满了，则这个表空间不会出现在dba-free-space中-）"><a href="#查看表空间可用百分比（-dba-free-space不会包含所有tablespace，如果一个表空间的数据文件都满了，则这个表空间不会出现在dba-free-space中-）" class="headerlink" title="查看表空间可用百分比（ dba_free_space不会包含所有tablespace，如果一个表空间的数据文件都满了，则这个表空间不会出现在dba_free_space中 ）"></a>查看表空间可用百分比（ dba_free_space不会包含所有tablespace，如果一个表空间的数据文件都满了，则这个表空间不会出现在dba_free_space中 ）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.tablespace_name,</span><br><span class="line">        a.maxsize max_M,</span><br><span class="line">        a.total total_M,</span><br><span class="line">        b.free free_M,</span><br><span class="line">        round((b.free/a.total)*100) <span class="string">"% Free"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         sum(bytes/(1024*1024)) total ,</span><br><span class="line">        sum(MAXBYTES/(1024*1024)) maxsize</span><br><span class="line">    FROM dba_data_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         round(sum(bytes/(1024*1024))) free</span><br><span class="line">    FROM dba_free_space</span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">ORDER BY  <span class="string">"% Free"</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>如下为标准版 <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.tablespace_name,</span><br><span class="line">        a.maxsize max_M,</span><br><span class="line">        a.total total_M,</span><br><span class="line">        b.free free_M,</span><br><span class="line">        round(((a.maxsize+b.free-a.total)/a.maxsize)*100) <span class="string">"% Free"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         sum(bytes/(1024*1024)) total ,</span><br><span class="line">        sum((decode(AUTOEXTENSIBLE,</span><br><span class="line">        <span class="string">'NO'</span>,BYTES,MAXBYTES))/(1024*1024)) maxsize</span><br><span class="line">    FROM dba_data_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         round(sum(bytes/(1024*1024))) free</span><br><span class="line">    FROM dba_free_space</span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">ORDER BY  <span class="string">"% Free"</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="查看临时表空间使用率"><a href="#查看临时表空间使用率" class="headerlink" title="查看临时表空间使用率"></a>查看临时表空间使用率</h4><h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT temp_used.tablespace_name,</span><br><span class="line">        round(total),</span><br><span class="line">        used,</span><br><span class="line">         round(total - used) AS <span class="string">"Free"</span>,</span><br><span class="line">         round(nvl(total-used,</span><br><span class="line">         0) * 100/total,</span><br><span class="line">        1) <span class="string">"Free percent"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM(bytes_used)/1024/1024 used</span><br><span class="line">    FROM GV<span class="variable">$TEMP_SPACE_HEADER</span></span><br><span class="line">    GROUP BY  tablespace_name) temp_used, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM(decode(autoextensible,</span><br><span class="line">        <span class="string">'YES'</span>,MAXBYTES,bytes))/1024/1024 total</span><br><span class="line">    FROM dba_temp_files</span><br><span class="line">    GROUP BY  tablespace_name) temp_total</span><br><span class="line">WHERE temp_used.tablespace_name = temp_total.tablespace_name</span><br></pre></td></tr></tbody></table></figure><h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.tablespace_name,</span><br><span class="line">         round(a.BYTES/1024/1024) total_M,</span><br><span class="line">         round(a.bytes/1024/1024 - nvl(b.bytes/1024/1024,</span><br><span class="line">         0)) free_M,</span><br><span class="line">         round(b.bytes/1024/1024) used,</span><br><span class="line">        round(b.using/1024/1024) using</span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM (decode(autoextensible,</span><br><span class="line">        <span class="string">'YES'</span>,MAXBYTES,bytes)) bytes</span><br><span class="line">    FROM dba_temp_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM (bytes_cached) bytes,</span><br><span class="line">        sum(bytes_used) using</span><br><span class="line">    FROM v<span class="variable">$temp_extent_pool</span></span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name(+)</span><br></pre></td></tr></tbody></table></figure><h4 id="查询undo表空间使用情况"><a href="#查询undo表空间使用情况" class="headerlink" title="查询undo表空间使用情况"></a>查询undo表空间使用情况</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT tablespace_name,</span><br><span class="line">        status,</span><br><span class="line">        sum(bytes)/1024/1024 M</span><br><span class="line">FROM dba_undo_extents</span><br><span class="line">GROUP BY  tablespace_name,status</span><br></pre></td></tr></tbody></table></figure><h4 id="查询使用undo比较多的SQL"><a href="#查询使用undo比较多的SQL" class="headerlink" title="查询使用undo比较多的SQL"></a>查询使用undo比较多的SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT *from </span><br><span class="line">    (SELECT maxqueryid,</span><br><span class="line">         round(sum(undoblks )*8/1024) consumed_size_MB</span><br><span class="line">    FROM v<span class="variable">$undostat</span></span><br><span class="line">    GROUP BY  maxqueryid</span><br><span class="line">    ORDER BY  consumed_size_MB DESC )</span><br><span class="line">WHERE rownum<10;</span><br></pre></td></tr></tbody></table></figure><h4 id="估计undo需要多大"><a href="#估计undo需要多大" class="headerlink" title="估计undo需要多大"></a>估计undo需要多大</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT (UR * (UPS * DBS)) AS <span class="string">"Bytes"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT max(tuned_undoretention) AS UR</span><br><span class="line">    FROM v<span class="variable">$undostat</span>), </span><br><span class="line">    (SELECT undoblks/((end_time-begin_time)*86400) AS UPS</span><br><span class="line">    FROM v<span class="variable">$undostat</span></span><br><span class="line">    WHERE undoblks = </span><br><span class="line">        (SELECT MAX(undoblks)</span><br><span class="line">        FROM v<span class="variable">$undostat</span>)), </span><br><span class="line">        (SELECT block_size AS DBS</span><br><span class="line">        FROM dba_tablespaces</span><br><span class="line">        WHERE tablespace_name = </span><br><span class="line">            (SELECT UPPER(value)</span><br><span class="line">            FROM v<span class="variable">$parameter</span></span><br><span class="line">            WHERE name = <span class="string">'undo_tablespace'</span>));</span><br></pre></td></tr></tbody></table></figure><h4 id="产生undo的当前活动会话是哪些"><a href="#产生undo的当前活动会话是哪些" class="headerlink" title="产生undo的当前活动会话是哪些"></a>产生undo的当前活动会话是哪些</h4><h5 id="方法一-1"><a href="#方法一-1" class="headerlink" title="方法一"></a>方法一</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.inst_id,</span><br><span class="line">         a.sid,</span><br><span class="line">         c.username,</span><br><span class="line">         c.osuser,</span><br><span class="line">         c.program,</span><br><span class="line">         b.name,</span><br><span class="line">         a.value,</span><br><span class="line">         d.used_urec,</span><br><span class="line">         d.used_ublk</span><br><span class="line">FROM gv<span class="variable">$sesstat</span> a, v<span class="variable">$statname</span> b, gv<span class="variable">$session</span> c, gv<span class="variable">$transaction</span> d</span><br><span class="line">WHERE a.statistic<span class="comment"># = b.statistic#</span></span><br><span class="line">        AND a.inst_id = c.inst_id</span><br><span class="line">        AND a.sid = c.sid</span><br><span class="line">        AND c.inst_id = d.inst_id</span><br><span class="line">        AND c.saddr = d.ses_addr</span><br><span class="line">        AND b.name = <span class="string">'undo change vector size'</span></span><br><span class="line">        AND a.value>0</span><br><span class="line">ORDER BY  a.value DESC</span><br></pre></td></tr></tbody></table></figure><h5 id="方法二-1"><a href="#方法二-1" class="headerlink" title="方法二"></a>方法二</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.sql_id,</span><br><span class="line">        v.usn,</span><br><span class="line">        r.status,</span><br><span class="line">         v.rssize/1024/1024 mb</span><br><span class="line">FROM dba_rollback_segs r, v<span class="variable">$rollstat</span> v,v<span class="variable">$transaction</span> t,v<span class="variable">$session</span> s</span><br><span class="line">WHERE r.segment_id = v.usn</span><br><span class="line">        AND v.usn=t.xidusn</span><br><span class="line">        AND t.addr=s.taddr</span><br><span class="line">ORDER BY  6 desc;</span><br></pre></td></tr></tbody></table></figure><h4 id="查看ASM磁盘组使用率"><a href="#查看ASM磁盘组使用率" class="headerlink" title="查看ASM磁盘组使用率"></a>查看ASM磁盘组使用率</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT name,</span><br><span class="line">        round(total_mb/1024) <span class="string">"总容量"</span>,</span><br><span class="line">        round(free_mb/1024) <span class="string">"空闲空间"</span>,</span><br><span class="line">        round((free_mb/total_mb)*100) <span class="string">"可用空间比例"</span></span><br><span class="line">FROM gv<span class="variable">$asm_diskgroup</span></span><br></pre></td></tr></tbody></table></figure><h4 id="统计每个用户使用表空间率"><a href="#统计每个用户使用表空间率" class="headerlink" title="统计每个用户使用表空间率"></a>统计每个用户使用表空间率</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SELECT c.owner <span class="string">"用户"</span>,</span><br><span class="line">         a.tablespace_name <span class="string">"表空间名"</span>,</span><br><span class="line">         total/1024/1024 <span class="string">"表空间大小M"</span>,</span><br><span class="line">         free/1024/1024 <span class="string">"表空间剩余大小M"</span>,</span><br><span class="line">         ( total - free )/1024/1024 <span class="string">"表空间使用大小M"</span>,</span><br><span class="line">         Round(( total - free ) / total,</span><br><span class="line">         4) * 100 <span class="string">"表空间总计使用率 %"</span>,</span><br><span class="line">         c.schemas_use/1024/1024 <span class="string">"用户使用表空间大小M"</span>,</span><br><span class="line">         round((schemas_use)/total,</span><br><span class="line">        4)*100 <span class="string">"用户使用表空间率 %"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         Sum(bytes) free</span><br><span class="line">    FROM DBA_FREE_SPACE</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         Sum(bytes) total</span><br><span class="line">    FROM DBA_DATA_FILES</span><br><span class="line">    GROUP BY  tablespace_name) b, </span><br><span class="line">    (SELECT owner ,</span><br><span class="line">        Tablespace_Name,</span><br><span class="line">         Sum(bytes) schemas_use</span><br><span class="line">    FROM Dba_Segments</span><br><span class="line">    GROUP BY  owner,Tablespace_Name) c</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">        AND a.tablespace_name =c.Tablespace_Name</span><br><span class="line">ORDER BY  <span class="string">"用户"</span>,<span class="string">"表空间名"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="查看闪回区-快速恢复区空间使用率"><a href="#查看闪回区-快速恢复区空间使用率" class="headerlink" title="查看闪回区\快速恢复区空间使用率"></a>查看闪回区\快速恢复区空间使用率</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT sum(percent_space_used)||<span class="string">'%'</span> <span class="string">"已使用空间比例"</span></span><br><span class="line">FROM V<span class="variable">$RECOVERY_AREA_USAGE</span> </span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">SELECT round(100*(a.space_used/space_limit),</span><br><span class="line">        2)||<span class="string">'%'</span> <span class="string">"已使用空间比例"</span>,a.*</span><br><span class="line">FROM v<span class="variable">$recovery_file_dest</span> a;</span><br></pre></td></tr></tbody></table></figure><h4 id="查看僵死进程，分两种（一种是会话不在的，另一种是会话标记为killed的但是会话还在的）"><a href="#查看僵死进程，分两种（一种是会话不在的，另一种是会话标记为killed的但是会话还在的）" class="headerlink" title="查看僵死进程，分两种（一种是会话不在的，另一种是会话标记为killed的但是会话还在的）"></a>查看僵死进程，分两种（一种是会话不在的，另一种是会话标记为killed的但是会话还在的）</h4><p><code>alter system kill session</code>一执行则<code>session</code>即标记为<code>KILLED</code>，但是如果会话产生的数据量大则这个kill可能会比较久，在这个过程中session标记为KILLED但是这个会话还在<code>V$session</code>中，则<code>V$session.paddr</code>还在，所以可以匹配到<code>V$process.addr</code>，所以process进程还在；当kill过程执行完毕，则这个会话即不在<code>V$session</code>中</p><h5 id="会话不在的"><a href="#会话不在的" class="headerlink" title="会话不在的"></a>会话不在的</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$process</span></span><br><span class="line">WHERE addr NOT IN </span><br><span class="line">    (SELECT paddr</span><br><span class="line">    FROM v<span class="variable">$session</span>)</span><br><span class="line">        AND pid NOT IN (1,17,18)</span><br></pre></td></tr></tbody></table></figure><h5 id="会话还在的，但是会话标记为killed"><a href="#会话还在的，但是会话标记为killed" class="headerlink" title="会话还在的，但是会话标记为killed"></a>会话还在的，但是会话标记为killed</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$process</span></span><br><span class="line">WHERE addr IN </span><br><span class="line">    (SELECT paddr</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE status=<span class="string">'KILLED'</span>)</span><br></pre></td></tr></tbody></table></figure><p>再根据上述结果中的SPID通过如下命令可以查看到process的启动时间<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|grep SPID</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查看行迁移或行链接的表"><a href="#查看行迁移或行链接的表" class="headerlink" title="查看行迁移或行链接的表"></a>查看行迁移或行链接的表</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_tables</span><br><span class="line">WHERE nvl(chain_cnt,0)<>0 chain_cnt ：Number of rows IN the table that are chained</span><br><span class="line">FROM one data block to another</span><br><span class="line">        OR that have migrated to a new block, requiring a link to preserve the old rowid. This column is updated only after you analyze the table.</span><br></pre></td></tr></tbody></table></figure><h4 id="数据缓冲区命中率（百分比小于90就要加大db-cache-size）"><a href="#数据缓冲区命中率（百分比小于90就要加大db-cache-size）" class="headerlink" title="数据缓冲区命中率（百分比小于90就要加大db_cache_size）"></a>数据缓冲区命中率（百分比小于90就要加大db_cache_size）</h4><h5 id="方法一-2"><a href="#方法一-2" class="headerlink" title="方法一"></a>方法一</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.VALUE+b.VALUE logical_reads,</span><br><span class="line">         c.VALUE phys_reads,</span><br><span class="line">         round(100*(1-c.value/(a.value+b.value)),</span><br><span class="line">        2)||<span class="string">'%'</span> hit_ratio</span><br><span class="line">FROM v<span class="variable">$sysstat</span> a,v<span class="variable">$sysstat</span> b,v<span class="variable">$sysstat</span> c</span><br><span class="line">WHERE a.NAME=<span class="string">'db block gets'</span></span><br><span class="line">        AND b.NAME=<span class="string">'consistent gets'</span></span><br><span class="line">        AND c.NAME=<span class="string">'physical reads'</span>;</span><br></pre></td></tr></tbody></table></figure><h5 id="方法二-2"><a href="#方法二-2" class="headerlink" title="方法二"></a>方法二</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT DB_BLOCK_GETS+CONSISTENT_GETS Logical_reads,</span><br><span class="line">        PHYSICAL_READS phys_reads,</span><br><span class="line">         round(100*(1-(PHYSICAL_READS/(DB_BLOCK_GETS+CONSISTENT_GETS))),</span><br><span class="line">        2)||<span class="string">'%'</span> <span class="string">"Hit Ratio"</span></span><br><span class="line">FROM V<span class="variable">$BUFFER_POOL_STATISTICS</span></span><br><span class="line">WHERE NAME=<span class="string">'DEFAULT'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="共享池命中率（百分比小于90就要加大shared-pool-size）"><a href="#共享池命中率（百分比小于90就要加大shared-pool-size）" class="headerlink" title="共享池命中率（百分比小于90就要加大shared_pool_size）"></a>共享池命中率（百分比小于90就要加大shared_pool_size）</h4><p>以下两者可以根据个人理解运用<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT sum(pinhits)/sum(pins)*100</span><br><span class="line">FROM v<span class="variable">$librarycache</span>;</span><br><span class="line"></span><br><span class="line">SELECT sum(pinhits-reloads)/sum(pins)*100</span><br><span class="line">FROM v<span class="variable">$librarycache</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查询归档日志切换频率"><a href="#查询归档日志切换频率" class="headerlink" title="查询归档日志切换频率"></a>查询归档日志切换频率</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SELECT sequence<span class="comment">#,</span></span><br><span class="line">        to_char(first_time,</span><br><span class="line">        <span class="string">'yyyymmdd_hh24:mi:ss'</span>) firsttime,round((first_time-lag(first_time) over(order by first_time))*24*60,2) minutes</span><br><span class="line">FROM v<span class="variable">$log_history</span></span><br><span class="line">WHERE first_time > sysdate - 3</span><br><span class="line">ORDER BY  first_time,</span><br><span class="line">        minutes; </span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">SELECT sequence<span class="comment">#,</span></span><br><span class="line">        to_char(first_time,</span><br><span class="line">        <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) First_time,First_change<span class="comment">#,switch_change#</span></span><br><span class="line">FROM v<span class="variable">$loghist</span></span><br><span class="line">WHERE first_time>sysdate-3</span><br><span class="line">ORDER BY  1;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">SELECT TO_CHAR(first_time,</span><br><span class="line">         <span class="string">'MM/DD'</span>) DAY, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'00'</span>, 1, 0)) H00, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'01'</span>, 1, 0)) H01, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'02'</span>, 1, 0)) H02, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'03'</span>, 1, 0)) H03, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'04'</span>, 1, 0)) H04, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'05'</span>, 1, 0)) H05, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'06'</span>, 1, 0)) H06, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'07'</span>, 1, 0)) H07, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'08'</span>, 1, 0)) H08, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'09'</span>, 1, 0)) H09, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'10'</span>, 1, 0)) H10, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'11'</span>, 1, 0)) H11, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'12'</span>, 1, 0)) H12, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'13'</span>, 1, 0)) H13, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'14'</span>, 1, 0)) H14, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'15'</span>, 1, 0)) H15, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'16'</span>, 1, 0)) H16, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'17'</span>, 1, 0)) H17, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'18'</span>, 1, 0)) H18, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'19'</span>, 1, 0)) H19, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'20'</span>, 1, 0)) H20, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'21'</span>, 1, 0)) H21, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'22'</span>, 1, 0)) H22, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'23'</span>, 1, 0)) H23, COUNT(*) TOTAL</span><br><span class="line">FROM </span><br><span class="line">    (SELECT ROWNUM RN,</span><br><span class="line">         FIRST_TIME</span><br><span class="line">    FROM V<span class="variable">$LOG_HISTORY</span></span><br><span class="line">    WHERE first_time>sysdate-18</span><br><span class="line">            AND FIRST_TIME>ADD_MONTHS(SYSDATE,-1)</span><br><span class="line">    ORDER BY  FIRST_TIME)</span><br><span class="line">GROUP BY  TO_CHAR(first_time, <span class="string">'MM/DD'</span>)</span><br><span class="line">ORDER BY  MIN(RN);</span><br></pre></td></tr></tbody></table></figure><h4 id="查询lgwr进程写日志时每执行一次lgwr需要多少秒，在state是waiting的情况下，某个等待编号seq-下，seconds-in-wait达多少秒，就是lgwr进程写一次IO需要多少秒"><a href="#查询lgwr进程写日志时每执行一次lgwr需要多少秒，在state是waiting的情况下，某个等待编号seq-下，seconds-in-wait达多少秒，就是lgwr进程写一次IO需要多少秒" class="headerlink" title="查询lgwr进程写日志时每执行一次lgwr需要多少秒，在state是waiting的情况下，某个等待编号seq#下，seconds_in_wait达多少秒，就是lgwr进程写一次IO需要多少秒"></a>查询lgwr进程写日志时每执行一次lgwr需要多少秒，在state是waiting的情况下，某个等待编号seq#下，seconds_in_wait达多少秒，就是lgwr进程写一次IO需要多少秒</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT event,</span><br><span class="line">        state,</span><br><span class="line">        seq<span class="comment">#,</span></span><br><span class="line">        seconds_in_wait,</span><br><span class="line">        program</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE program LIKE <span class="string">'%LGWR%'</span></span><br><span class="line">        AND state=<span class="string">'WAITING'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="查询没有索引的表"><a href="#查询没有索引的表" class="headerlink" title="查询没有索引的表"></a>查询没有索引的表</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT table_name</span><br><span class="line">FROM user_tables</span><br><span class="line">WHERE table_name NOT IN </span><br><span class="line">    (SELECT table_name</span><br><span class="line">    FROM user_indexes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT table_name</span><br><span class="line">FROM user_tables</span><br><span class="line">WHERE table_name NOT IN </span><br><span class="line">    (SELECT table_name</span><br><span class="line">    FROM user_ind_columns)</span><br></pre></td></tr></tbody></table></figure><h4 id="查询一个AWR周期内的平均session数、OS平均负载、平均db-time、平均每秒多少事务"><a href="#查询一个AWR周期内的平均session数、OS平均负载、平均db-time、平均每秒多少事务" class="headerlink" title="查询一个AWR周期内的平均session数、OS平均负载、平均db time、平均每秒多少事务"></a>查询一个AWR周期内的平均session数、OS平均负载、平均db time、平均每秒多少事务</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT to_char(max(BEGIN_TIME),</span><br><span class="line">        <span class="string">'yyyy-mm-dd hh24:mi'</span>)||to_char(max(end_time),<span class="string">'* hh24:mi'</span>) time, snap_id, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Session Count'</span> THEN</span><br><span class="line">    average end),2) sessions, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Current OS Load'</span> THEN</span><br><span class="line">    average end),2) OS_LOAD, (trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Database Time Per Sec'</span> THEN</span><br><span class="line">    average end),2)/100)*(ceil((max(end_time)-max(BEGIN_TIME))*24*60*60)) Database_Time_second, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'User Transaction Per Sec'</span> THEN</span><br><span class="line">    average end),2) User_Transaction_Per_Sec</span><br><span class="line">FROM dba_hist_sysmetric_summary</span><br><span class="line">GROUP BY  snap_id</span><br><span class="line">ORDER BY  snap_id;</span><br></pre></td></tr></tbody></table></figure><ul><li>Database Time Per Sec对应值的单位是百分一秒/每秒 </li><li>(/100)<em>(ceil((max(end_time)-max(BEGIN_TIME))</em>24<em>60</em>60))是代表每个snap周期内的总秒数，oracle 两个时间相减默认的是天数,<em>24</em>60*60 为相差的秒数 </li><li>这个SQL查到的DB TIME比较准确，和awr上面的db time比较一致 </li></ul><h4 id="查询产生热块较多的对象"><a href="#查询产生热块较多的对象" class="headerlink" title="查询产生热块较多的对象"></a>查询产生热块较多的对象</h4><p>x$bh .tch(Touch)表示访问次数越高，热点快竞争问题就存在<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT e.owner,</span><br><span class="line">         e.segment_name,</span><br><span class="line">         e.segment_type</span><br><span class="line">FROM dba_extents e, </span><br><span class="line">    (SELECT *</span><br><span class="line">    FROM </span><br><span class="line">        (SELECT addr,</span><br><span class="line">        ts<span class="comment">#,</span></span><br><span class="line">        file<span class="comment">#,</span></span><br><span class="line">        dbarfil,</span><br><span class="line">        dbablk,</span><br><span class="line">        tch</span><br><span class="line">        FROM x<span class="variable">$bh</span></span><br><span class="line">        ORDER BY  tch DESC)</span><br><span class="line">        WHERE ROWNUM < 11) b</span><br><span class="line">    WHERE e.relative_fno = b.dbarfil</span><br><span class="line">        AND e.block_id <= b.dbablk</span><br><span class="line">        AND e.block_id + e.blocks > b.dbablk;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="手工创建快照的语句"><a href="#手工创建快照的语句" class="headerlink" title="手工创建快照的语句"></a>手工创建快照的语句</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> dbms_workload_repository.create_snapshot;</span><br></pre></td></tr></tbody></table></figure><h4 id="AWR设置每隔30分钟收集一次报告，保留14天的报告"><a href="#AWR设置每隔30分钟收集一次报告，保留14天的报告" class="headerlink" title="AWR设置每隔30分钟收集一次报告，保留14天的报告"></a>AWR设置每隔30分钟收集一次报告，保留14天的报告</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(retention=>14*24*60, interval=>30); </span><br><span class="line"></span><br><span class="line">select * from dba_hist_wr_control;</span><br></pre></td></tr></tbody></table></figure><h4 id="AWR基线查看和创建"><a href="#AWR基线查看和创建" class="headerlink" title="AWR基线查看和创建"></a>AWR基线查看和创建</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from dba_hist_baseline; </span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE(start_snap_id=>7550,end_snap_id=>7660,baseline_name=><span class="string">'am_baseline'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="导出AWR报告的SQL语句"><a href="#导出AWR报告的SQL语句" class="headerlink" title="导出AWR报告的SQL语句"></a>导出AWR报告的SQL语句</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_hist_snapshot</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM table(dbms_workload_repository.awr_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid))</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM TABLE(DBMS_WORKLOAD_REPOSITORY.awr_diff_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid, DBID, INSTANCE_NUMBER, startsnapid,endsnapid));</span><br></pre></td></tr></tbody></table></figure><h4 id="导出最新ADDM的报告（需要sys用户）"><a href="#导出最新ADDM的报告（需要sys用户）" class="headerlink" title="导出最新ADDM的报告（需要sys用户）"></a>导出最新ADDM的报告（需要sys用户）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT dbms_advisor.get_task_report(task_name)</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">WHERE task_id =</span><br><span class="line">    (SELECT max(t.task_id)</span><br><span class="line">    FROM dba_advisor_tasks t, dba_advisor_log l</span><br><span class="line">    WHERE t.task_id=l.task_id</span><br><span class="line">            AND t.advisor_name=<span class="string">'ADDM'</span></span><br><span class="line">            AND l.status=<span class="string">'COMPLETED'</span> );SELECT task_id,</span><br><span class="line">        task_name,</span><br><span class="line">        description</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">ORDER BY  1 DESCSELECT dbms_advisor.get_task_report(task_name)</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">WHERE task_id =XX</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某个SQL的执行计划"><a href="#查询某个SQL的执行计划" class="headerlink" title="查询某个SQL的执行计划"></a>查询某个SQL的执行计划</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table(dbms_xplan.display_cursor(<span class="string">'sql_id'</span>,0,<span class="string">' advanced '</span>));</span><br></pre></td></tr></tbody></table></figure><p>上面的0表示<code>v$sql.child_number</code>为0，如果一个sql_id在v$sql中有多行说明有多个child_number，要看哪儿child_number的执行计划，就写哪个的值，比如要看child_number为2的执行计划，就把上面sql的0改为2 。</p><h4 id="官方文档对display-cursor这个函数的说明里面没有advanced这个参数值，只有BASIC、TYPICAL、ALL这几个，不过实践中发现advanced这个参数值显示的内容比这几个参数值显示的都多。"><a href="#官方文档对display-cursor这个函数的说明里面没有advanced这个参数值，只有BASIC、TYPICAL、ALL这几个，不过实践中发现advanced这个参数值显示的内容比这几个参数值显示的都多。" class="headerlink" title="官方文档对display_cursor这个函数的说明里面没有advanced这个参数值，只有BASIC、TYPICAL、ALL这几个，不过实践中发现advanced这个参数值显示的内容比这几个参数值显示的都多。"></a>官方文档对display_cursor这个函数的说明里面没有advanced这个参数值，只有BASIC、TYPICAL、ALL这几个，不过实践中发现advanced这个参数值显示的内容比这几个参数值显示的都多。</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table(xplan.display_cursor(<span class="string">'v$sql.sql_id'</span>,0,<span class="string">'advanced'</span>));</span><br></pre></td></tr></tbody></table></figure><h4 id="创建xplan包，再执行"><a href="#创建xplan包，再执行" class="headerlink" title="创建xplan包，再执行"></a>创建xplan包，再执行</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL> CREATE PUBLIC SYNONYM XPLAN FOR SYS.XPLAN; </span><br><span class="line">SQL> grant execute on sys.xplan to public;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询Rman的配置信息"><a href="#查询Rman的配置信息" class="headerlink" title="查询Rman的配置信息"></a>查询Rman的配置信息</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT NAME,</span><br><span class="line">        VALUE</span><br><span class="line">FROM V<span class="variable">$RMAN_CONFIGURATION</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询Rman备份集详细信息（未过期的，过期并已删除的查不到）"><a href="#查询Rman备份集详细信息（未过期的，过期并已删除的查不到）" class="headerlink" title="查询Rman备份集详细信息（未过期的，过期并已删除的查不到）"></a>查询Rman备份集详细信息（未过期的，过期并已删除的查不到）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT B.RECID BackupSet_ID,</span><br><span class="line">        </span><br><span class="line">         A.SET_STAMP,</span><br><span class="line">        </span><br><span class="line">         DECODE (B.INCREMENTAL_LEVEL,</span><br><span class="line">        </span><br><span class="line">         <span class="string">''</span>, DECODE (BACKUP_TYPE, <span class="string">'L'</span>, <span class="string">'Archivelog'</span>, <span class="string">'Full'</span>), 1, <span class="string">'Incr-1级'</span>, 0, <span class="string">'Incr-0级'</span>, B.INCREMENTAL_LEVEL) <span class="string">"Type LV"</span>, B.CONTROLFILE_INCLUDED <span class="string">"包含CTL"</span>, DECODE (A.STATUS, <span class="string">'A'</span>, <span class="string">'AVAILABLE'</span>, <span class="string">'D'</span>, <span class="string">'DELETED'</span>, <span class="string">'X'</span>, <span class="string">'EXPIRED'</span>, <span class="string">'ERROR'</span>) <span class="string">"STATUS"</span>, A.DEVICE_TYPE <span class="string">"Device Type"</span>, A.START_TIME <span class="string">"Start Time"</span>, A.COMPLETION_TIME <span class="string">"Completion Time"</span>, A.ELAPSED_SECONDS <span class="string">"Elapsed Seconds"</span>, A.BYTES/1024/1024/1024 <span class="string">"Size(G)"</span>, A.COMPRESSED, A.TAG <span class="string">"Tag"</span>, A.HANDLE <span class="string">"Path"</span></span><br><span class="line">FROM GV<span class="variable">$BACKUP_PIECE</span> A,</span><br><span class="line">         GV<span class="variable">$BACKUP_SET</span> B</span><br><span class="line">WHERE A.SET_STAMP = B.SET_STAMP</span><br><span class="line">        AND A.DELETED = <span class="string">'NO'</span></span><br><span class="line">ORDER BY  A.COMPLETION_TIME DESC;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询Rman备份进度"><a href="#查询Rman备份进度" class="headerlink" title="查询Rman备份进度"></a>查询Rman备份进度</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT SID,</span><br><span class="line">         SERIAL<span class="comment">#,</span></span><br><span class="line">         opname,</span><br><span class="line">        ROUND(SOFAR/TOTALWORK*100)||<span class="string">'%'</span> <span class="string">"%_COMPLETE"</span>, TRUNC(elapsed_seconds/60) || <span class="string">':'</span> || MOD(elapsed_seconds,60) elapsed, TRUNC(time_remaining/60) || <span class="string">':'</span> || MOD(time_remaining,60) remaining, CONTEXT,target,SOFAR, TOTALWORK</span><br><span class="line">FROM V<span class="variable">$SESSION_LONGOPS</span></span><br><span class="line">WHERE OPNAME LIKE <span class="string">'RMAN%'</span></span><br><span class="line">        AND OPNAME NOT LIKE <span class="string">'%aggregate%'</span></span><br><span class="line">        AND TOTALWORK != 0</span><br><span class="line">        AND SOFAR <> TOTALWORK;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询执行过全表扫描的sql语句的SQL-ID和sql-fulltext"><a href="#查询执行过全表扫描的sql语句的SQL-ID和sql-fulltext" class="headerlink" title="查询执行过全表扫描的sql语句的SQL_ID和sql_fulltext"></a>查询执行过全表扫描的sql语句的SQL_ID和sql_fulltext</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.inst_id,</span><br><span class="line">        s.sql_id,</span><br><span class="line">        s.username,</span><br><span class="line">        s.target,</span><br><span class="line">        s.ELAPSED_SECONDS,</span><br><span class="line">        s.START_TIME,</span><br><span class="line">        s.LAST_UPDATE_TIME,</span><br><span class="line">        v.sql_fulltext</span><br><span class="line">FROM gv<span class="variable">$session_longops</span> s,gv<span class="variable">$sql</span> v</span><br><span class="line">WHERE s.OPNAME = <span class="string">'Table Scan'</span></span><br><span class="line">        AND s.SQL_PLAN_OPERATION = <span class="string">'TABLE ACCESS'</span></span><br><span class="line">        AND s.SQL_PLAN_OPTIONS = <span class="string">'FULL'</span></span><br><span class="line">        AND s.sql_id=v.sql_id</span><br><span class="line">ORDER BY  s.LAST_UPDATE_TIME DESC</span><br></pre></td></tr></tbody></table></figure><h4 id="查询死事务需要多长的回滚时间"><a href="#查询死事务需要多长的回滚时间" class="headerlink" title="查询死事务需要多长的回滚时间"></a>查询死事务需要多长的回滚时间</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X<span class="variable">$KTUXE</span>：[K]ernel [T]ransaction [U]ndo Transa[x]tion [E]ntry (table)`</span><br></pre></td></tr></tbody></table></figure><p><code>X$KTUXE</code>表的一个重要功能是，可以获得无法通过<code>v$transaction</code>来观察的死事务信息，当一个数据库发生异常中断，或者进行延迟事务恢复时，数据库启动后，无法通过V$TRANSACTION来观察事务信息，但是<code>X$KTUXE</code>可以帮助我们获得这些信息。该表中的KTUXECFL代表了事务的Flag标记，通过这个标记可以找到那些Dead事务：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL> select distinct KTUXECFL,count(*) from x<span class="variable">$ktuxe</span> group by KTUXECFL; </span><br><span class="line">    KTUXECFL                  COUNT(*) </span><br><span class="line">    ------------------------ ---------- </span><br><span class="line">    DEAD                              1 </span><br><span class="line">NONE                          2393</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="KTUXESIZ用来记录事务使用的回滚段块数，可以通过观察这个字段来评估恢复进度-例如如下事务回滚经过测算需要大约3小时"><a href="#KTUXESIZ用来记录事务使用的回滚段块数，可以通过观察这个字段来评估恢复进度-例如如下事务回滚经过测算需要大约3小时" class="headerlink" title="KTUXESIZ用来记录事务使用的回滚段块数，可以通过观察这个字段来评估恢复进度,例如如下事务回滚经过测算需要大约3小时"></a>KTUXESIZ用来记录事务使用的回滚段块数，可以通过观察这个字段来评估恢复进度,例如如下事务回滚经过测算需要大约3小时</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXECFL =<span class="string">'DEAD'</span>; </span><br><span class="line">    ADDR              KTUXEUSN  KTUXESLT  KTUXESQN  KTUXESIZ </span><br><span class="line">    ---------------- ---------- ---------- ---------- ---------- </span><br><span class="line">FFFFFFFF7D07B91C        10        39    2567412    1086075 </span><br><span class="line"></span><br><span class="line">SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXECFL =<span class="string">'DEAD'</span>; </span><br><span class="line">    ADDR              KTUXEUSN  KTUXESLT  KTUXESQN  KTUXESIZ </span><br><span class="line">    ---------------- ---------- ---------- ---------- ---------- </span><br><span class="line">    FFFFFFFF7D07B91C        10        39    2567412    1086067 </span><br><span class="line"></span><br><span class="line">SQL> <span class="built_in">declare</span> </span><br><span class="line">   l_start number; </span><br><span class="line">   l_end    number; </span><br><span class="line">   begin </span><br><span class="line">    select ktuxesiz into l_start from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXEUSN=10 and KTUXESLT=39; </span><br><span class="line">    dbms_lock.sleep(60); </span><br><span class="line">    select ktuxesiz into l_end from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXEUSN=10 and KTUXESLT=39; </span><br><span class="line">    dbms_output.put_line(<span class="string">'time_H:'</span>|| round(l_end/(l_start -l_end)/60,2)); </span><br><span class="line">  end; </span><br><span class="line">  / </span><br><span class="line"></span><br><span class="line">time_H:3</span><br></pre></td></tr></tbody></table></figure><h4 id="把XXX用户下面的某些YYY表赋权给user-XXX-YYY要大写"><a href="#把XXX用户下面的某些YYY表赋权给user-XXX-YYY要大写" class="headerlink" title="把XXX用户下面的某些YYY表赋权给user,XXX\YYY要大写"></a>把XXX用户下面的某些YYY表赋权给user,XXX\YYY要大写</h4><ul><li>XXX要大写<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> tablename varchar2(200);     </span><br><span class="line">    begin </span><br><span class="line">    <span class="keyword">for</span> x IN (SELECT * FROM dba_tables <span class="built_in">where</span> owner=<span class="string">'XXX'</span> and table_name like <span class="string">'%YYY%'</span>) loop   </span><br><span class="line">    tablename:=x.table_name; </span><br><span class="line">    dbms_output.put_line(<span class="string">'GRANT SELECT ON XXX.'</span>||tablename||<span class="string">' to user'</span>); </span><br><span class="line">    EXECUTE IMMEDIATE <span class="string">'GRANT SELECT ON XXX.'</span>||tablename||<span class="string">' TO user'</span>;  </span><br><span class="line">    end loop; </span><br><span class="line">end;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="Oracle查出一个用户具有的所有系统权限和对象权限"><a href="#Oracle查出一个用户具有的所有系统权限和对象权限" class="headerlink" title="Oracle查出一个用户具有的所有系统权限和对象权限"></a>Oracle查出一个用户具有的所有系统权限和对象权限</h4><p>系统权限（和用户自己查询<code>select * from session_privs</code>的结果一致）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM DBA_SYS_PRIVS</span><br><span class="line">WHERE GRANTEE = <span class="string">'用户名'</span></span><br><span class="line">UNION</span><br><span class="line">ALLSELECT *</span><br><span class="line">FROM DBA_SYS_PRIVS</span><br><span class="line">WHERE GRANTEE IN </span><br><span class="line">    (SELECT GRANTED_ROLE</span><br><span class="line">    FROM DBA_ROLE_PRIVS</span><br><span class="line">    WHERE GRANTEE = <span class="string">'用户名'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="对象权限（和用户自己查询select-FROM-TABLE-PRIVILEGES-where-GRANTEE-39-当前用户-39-的结果一致）"><a href="#对象权限（和用户自己查询select-FROM-TABLE-PRIVILEGES-where-GRANTEE-39-当前用户-39-的结果一致）" class="headerlink" title="对象权限（和用户自己查询select * FROM TABLE_PRIVILEGES where GRANTEE='当前用户'的结果一致）"></a>对象权限（和用户自己查询<code>select * FROM TABLE_PRIVILEGES where GRANTEE='当前用户'</code>的结果一致）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM DBA_TAB_PRIVS</span><br><span class="line">WHERE GRANTEE = <span class="string">'用户名'</span></span><br><span class="line">UNION</span><br><span class="line">ALLSELECT *</span><br><span class="line">FROM DBA_TAB_PRIVS</span><br><span class="line">WHERE GRANTEE IN </span><br><span class="line">    (SELECT GRANTED_ROLE</span><br><span class="line">    FROM DBA_ROLE_PRIVS</span><br><span class="line">    WHERE GRANTEE = <span class="string">'用户名'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某个用户拥有的角色"><a href="#查询某个用户拥有的角色" class="headerlink" title="查询某个用户拥有的角色"></a>查询某个用户拥有的角色</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_role_privs</span><br><span class="line">WHERE GRANTEE=<span class="string">'用户名'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询拥有DBA角色权限的用户"><a href="#查询拥有DBA角色权限的用户" class="headerlink" title="查询拥有DBA角色权限的用户"></a>查询拥有DBA角色权限的用户</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_role_privs</span><br><span class="line">WHERE GRANTED_ROLE=<span class="string">'DBA'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某个角色拥有的系统权限"><a href="#查询某个角色拥有的系统权限" class="headerlink" title="查询某个角色拥有的系统权限"></a>查询某个角色拥有的系统权限</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM ROLE_SYS_PRIVS</span><br><span class="line">WHERE role=<span class="string">'角色名'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="清除某个SQL的执行计划"><a href="#清除某个SQL的执行计划" class="headerlink" title="清除某个SQL的执行计划"></a>清除某个SQL的执行计划</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exec DBMS_SHARED_POOL.PURGE(<span class="string">'v$sqlarea.ADDRESS,v$sqlarea.HASH_VALUE'</span>,<span class="string">'c'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="查询密码是否有过期限制，默认是180天，一般修改为unlimited"><a href="#查询密码是否有过期限制，默认是180天，一般修改为unlimited" class="headerlink" title="查询密码是否有过期限制，默认是180天，一般修改为unlimited"></a>查询密码是否有过期限制，默认是180天，一般修改为unlimited</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_profiles</span><br><span class="line">WHERE profile=<span class="string">'DEFAULT'</span></span><br><span class="line">        AND RESOURCE_NAME LIKE <span class="string">'PASSWORD%'</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED</span><br></pre></td></tr></tbody></table></figure><h4 id="查询和修改隐含参数（必须在sysdba权限下操作）"><a href="#查询和修改隐含参数（必须在sysdba权限下操作）" class="headerlink" title="查询和修改隐含参数（必须在sysdba权限下操作）"></a>查询和修改隐含参数（必须在sysdba权限下操作）</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.ksppinm name,</span><br><span class="line">         b.ksppstvl value,</span><br><span class="line">         a.ksppdesc description</span><br><span class="line">FROM x<span class="variable">$ksppi</span> a, x<span class="variable">$ksppcv</span> b</span><br><span class="line">WHERE a.indx = b.indx</span><br><span class="line">        AND a.ksppinm LIKE <span class="string">'%_small_table_threshold%'</span></span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">alter system <span class="built_in">set</span> <span class="string">"_small_table_threshold"</span>=value scope=both sid=<span class="string">'*'</span>;</span><br></pre></td></tr></tbody></table></figure><p>不加sid则说明在默认在RAC的所有实例中修改 </p><p>需要注意的是一定要加上双引号, 另外引号内不能有空格, 只能包含参数的名字 </p><h4 id="评估SGA该设置多少"><a href="#评估SGA该设置多少" class="headerlink" title="评估SGA该设置多少"></a>评估SGA该设置多少</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT SGA_SIZE</span><br><span class="line">FROM </span><br><span class="line">    (SELECT *</span><br><span class="line">    FROM V<span class="variable">$SGA_TARGET_ADVICE</span></span><br><span class="line">    WHERE ESTD_DB_TIME_FACTOR=1</span><br><span class="line">    ORDER BY  1)</span><br><span class="line">WHERE rownum=1;</span><br></pre></td></tr></tbody></table></figure><h4 id="查看shared-pool还剩多少"><a href="#查看shared-pool还剩多少" class="headerlink" title="查看shared pool还剩多少"></a>查看shared pool还剩多少</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$sgastat</span></span><br><span class="line">WHERE name=<span class="string">'free memory'</span></span><br><span class="line">        AND pool=<span class="string">'shared pool'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="统计所有表的容量大小-含分区字段、LOB字段"><a href="#统计所有表的容量大小-含分区字段、LOB字段" class="headerlink" title="统计所有表的容量大小(含分区字段、LOB字段)"></a>统计所有表的容量大小(含分区字段、LOB字段)</h4><p>一般先执行<code>select distinct SEGMENT_TYPE from dba_segments where owner<>'SYS' and tablespace_name<>'SYSAUX'</code>查看到所有的<code>segment_type</code><br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">SELECT owner,</span><br><span class="line">        table_name,</span><br><span class="line">         TRUNC(sum(bytes)/1024/1024) Meg</span><br><span class="line">FROM </span><br><span class="line">    (SELECT segment_name table_name,</span><br><span class="line">         owner,</span><br><span class="line">         bytes</span><br><span class="line">    FROM dba_segments</span><br><span class="line">    WHERE segment_type = <span class="string">'TABLE'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT s.segment_name table_name,</span><br><span class="line">         pt.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_segments s, dba_part_tables pt</span><br><span class="line">    WHERE s.segment_name = pt.table_name</span><br><span class="line">            AND s.owner = pt.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'TABLE PARTITION'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT i.table_name,</span><br><span class="line">         i.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_indexes i, dba_segments s</span><br><span class="line">    WHERE s.segment_name = i.index_name</span><br><span class="line">            AND s.owner = i.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'INDEX'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT pi.table_name,</span><br><span class="line">         pi.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_part_indexes pi, dba_segments s</span><br><span class="line">    WHERE s.segment_name = pi.index_name</span><br><span class="line">            AND s.owner = pi.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'INDEX PARTITION'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.segment_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOBSEGMENT'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.index_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOBINDEX'</span></span><br><span class="line">    UNION</span><br><span class="line">    allSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.segment_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOB PARTITION'</span> )</span><br><span class="line">GROUP BY  owner,table_name</span><br><span class="line">HAVING SUM(bytes)/1024/1024 > 10</span><br><span class="line">ORDER BY  SUM(bytes) DESC</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="查看当前会话的SID"><a href="#查看当前会话的SID" class="headerlink" title="查看当前会话的SID"></a>查看当前会话的SID</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM V<span class="variable">$MYSTAT</span></span><br><span class="line">WHERE rownum<2</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某个SID的某个统计信息，比如consistent-gets一致性读"><a href="#查询某个SID的某个统计信息，比如consistent-gets一致性读" class="headerlink" title="查询某个SID的某个统计信息，比如consistent gets一致性读"></a>查询某个SID的某个统计信息，比如consistent gets一致性读</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT A.SID,</span><br><span class="line">        A.STATISTIC<span class="comment">#,</span></span><br><span class="line">        A.VALUE SID_VALUE,</span><br><span class="line">        B.NAME,</span><br><span class="line">        B.VALUE ALL_SID_VALUE</span><br><span class="line">FROM V<span class="variable">$SESSTAT</span> A ,V<span class="variable">$SYSSTAT</span> B</span><br><span class="line">WHERE A.STATISTIC<span class="comment">#=B.STATISTIC#</span></span><br><span class="line">        AND A.SID=1187</span><br><span class="line">        AND B.NAME=<span class="string">'consistent gets'</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>V$SYSSTAT</code>统计整个DB的统计信息，<code>V$SYSSTAT</code>已经取代了<code>V$STATNAME</code>，并且多了VALUE这一列 <code>V$SESSTAT</code>统计每个用户的统计信息 </li></ul><h4 id="查询某个SID的某个等待事件的信息，比如log-file-sync"><a href="#查询某个SID的某个等待事件的信息，比如log-file-sync" class="headerlink" title="查询某个SID的某个等待事件的信息，比如log file sync"></a>查询某个SID的某个等待事件的信息，比如log file sync</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT A.SID,</span><br><span class="line">        A.EVENT,</span><br><span class="line">        C.NAME,</span><br><span class="line">        C.PARAMETER1,</span><br><span class="line">        C.PARAMETER2,</span><br><span class="line">        C.PARAMETER3,</span><br><span class="line">         A.TIME_WAITED SID_TIMEWAITED,</span><br><span class="line">        B.TIME_WAITED ALL_SID_TIMEWAITED,</span><br><span class="line">        A.TOTAL_WAITS SID_TOTALWAITS,</span><br><span class="line">        B.TOTAL_WAITS ALL_SID_TOTALWAITS</span><br><span class="line">FROM V<span class="variable">$SESSION_EVENT</span> A ,V<span class="variable">$SYSTEM_EVENT</span> B,V<span class="variable">$EVENT_NAME</span> C</span><br><span class="line">WHERE A.EVENT=B.EVENT</span><br><span class="line">        AND A.EVENT=C.NAME</span><br><span class="line">        AND A.SID=1</span><br><span class="line">        AND C.NAME=<span class="string">'log file sync'</span> V<span class="variable">$SESSION_EVENT</span>描述每个用户的等待事件信息 V<span class="variable">$SYSTEM_EVENT</span>描述整个DB等待事件信息 V<span class="variable">$EVENT_NAME</span>描述等待事件信本身的信息(比如V<span class="variable">$ACTIVE_SESSION_HISTORY</span>的P1TEXT、P2TEXT、P2TEXT匹配V<span class="variable">$EVENT_NAME</span>的PARAMETER1、PARAMETER2、PARAMETER3)</span><br></pre></td></tr></tbody></table></figure><h4 id="RAC跨节点杀会话"><a href="#RAC跨节点杀会话" class="headerlink" title="RAC跨节点杀会话"></a>RAC跨节点杀会话</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter system <span class="built_in">kill</span> session <span class="string">'SID,serial#,@1'</span>  --杀掉1节点的进程 </span><br><span class="line">alter system <span class="built_in">kill</span> session <span class="string">'SID,serial#,@2'</span>  --杀掉2节点的进程</span><br></pre></td></tr></tbody></table></figure><h4 id="Truncate-分区的SQL"><a href="#Truncate-分区的SQL" class="headerlink" title="Truncate 分区的SQL"></a>Truncate 分区的SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name TRUNCATE PARTITION p1 DROP STORAGE UPDATE GLOBAL INDEXES;</span><br></pre></td></tr></tbody></table></figure><h4 id="Drop分区的SQL"><a href="#Drop分区的SQL" class="headerlink" title="Drop分区的SQL"></a>Drop分区的SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name DROP PARTITION p1 UPDATE GLOBAL INDEXES;</span><br></pre></td></tr></tbody></table></figure><h4 id="DATAGUARD主备延迟多少时间的查询方法"><a href="#DATAGUARD主备延迟多少时间的查询方法" class="headerlink" title="DATAGUARD主备延迟多少时间的查询方法"></a>DATAGUARD主备延迟多少时间的查询方法</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">备 库sqlplus></span><br><span class="line">SELECT value</span><br><span class="line">FROM v<span class="variable">$dataguard_stats</span></span><br><span class="line">WHERE name=<span class="string">'apply lag'</span> </span><br><span class="line">或 </span><br><span class="line">备库sqlplus></span><br><span class="line">SELECT ceil((sysdate-next_time)*24*60) <span class="string">"M"</span></span><br><span class="line">FROM v<span class="variable">$archived_log</span></span><br><span class="line">WHERE applied=<span class="string">'YES'</span></span><br><span class="line">        AND SEQUENCE<span class="comment">#=</span></span><br><span class="line">    (SELECT MAX(SEQUENCE<span class="comment">#)</span></span><br><span class="line">    FROM V<span class="variable">$ARCHIVED_LOG</span></span><br><span class="line">    WHERE applied=<span class="string">'YES'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="查看某个包或存储过程是否正在被调用-如果如下有结果，则此时不能编译，否则会锁住"><a href="#查看某个包或存储过程是否正在被调用-如果如下有结果，则此时不能编译，否则会锁住" class="headerlink" title="查看某个包或存储过程是否正在被调用,如果如下有结果，则此时不能编译，否则会锁住"></a>查看某个包或存储过程是否正在被调用,如果如下有结果，则此时不能编译，否则会锁住</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM V<span class="variable">$DB_OBJECT_CACHE</span></span><br><span class="line">WHERE pin>0</span><br><span class="line">        AND name=upper(<span class="string">'XX'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="查询数据库打补丁的记录"><a href="#查询数据库打补丁的记录" class="headerlink" title="查询数据库打补丁的记录"></a>查询数据库打补丁的记录</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_registry_history;</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某表的索引字段的distinct行数和CLUSTERING-FACTOR信息"><a href="#查询某表的索引字段的distinct行数和CLUSTERING-FACTOR信息" class="headerlink" title="查询某表的索引字段的distinct行数和CLUSTERING_FACTOR信息"></a>查询某表的索引字段的distinct行数和CLUSTERING_FACTOR信息</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.table_name,</span><br><span class="line">        a.index_name,</span><br><span class="line">        b.COLUMN_NAME,</span><br><span class="line">        a.blevel,</span><br><span class="line">        a.distinct_keys,</span><br><span class="line">        A.CLUSTERING_FACTOR,</span><br><span class="line">        A.NUM_ROWS,</span><br><span class="line">        trunc((a.distinct_keys/A.NUM_ROWS),</span><br><span class="line">        2)*100||<span class="string">'%'</span> <span class="string">"distinct%"</span>,trunc((a.CLUSTERING_FACTOR/A.NUM_ROWS),2)*100||<span class="string">'%'</span> <span class="string">"CLUSTERING_FACTOR%"</span></span><br><span class="line">FROM DBA_IND_STATISTICS a,DBA_IND_COLUMNS b</span><br><span class="line">WHERE a.table_name=<span class="string">'XX'</span></span><br><span class="line">        AND a.INDEX_NAME=b.index_name</span><br><span class="line">ORDER BY  5 desc</span><br></pre></td></tr></tbody></table></figure><h4 id="查询某表的所有字段的distinct行数"><a href="#查询某表的所有字段的distinct行数" class="headerlink" title="查询某表的所有字段的distinct行数"></a>查询某表的所有字段的distinct行数</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.table_name,</span><br><span class="line">        b.num_rows,</span><br><span class="line">        a.column_name,</span><br><span class="line">        a.data_type,</span><br><span class="line">        a.data_length,</span><br><span class="line">        a.num_distinct,</span><br><span class="line">        trunc((a.num_distinct/b.num_rows),</span><br><span class="line">        2)*100||<span class="string">'%'</span></span><br><span class="line">FROM dba_TAB_COLS a,dba_tables b</span><br><span class="line">WHERE a.table_name=<span class="string">'XX'</span></span><br><span class="line">        AND a.table_name=b.table_name</span><br><span class="line">ORDER BY  6 DESC</span><br></pre></td></tr></tbody></table></figure><h4 id="查询5G以上空闲空间可以进行收缩的数据文件"><a href="#查询5G以上空闲空间可以进行收缩的数据文件" class="headerlink" title="查询5G以上空闲空间可以进行收缩的数据文件"></a>查询5G以上空闲空间可以进行收缩的数据文件</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">'alter database datafile '</span><span class="string">''</span> || a.file_name || <span class="string">''</span><span class="string">' resize '</span> || round(a.filesize -(a.filesize - c.hwmsize) * 0.8) || <span class="string">'M;'</span>, a.filesize || <span class="string">'M'</span> AS <span class="string">"数据文件的总大小"</span>, c.hwmsize || <span class="string">'M'</span> AS <span class="string">"数据文件的实用大小"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT file_id,</span><br><span class="line">         file_name,</span><br><span class="line">         round(bytes / 1024 / 1024) AS filesize</span><br><span class="line">    FROM dba_data_files) a, </span><br><span class="line">    (SELECT file_id,</span><br><span class="line">         round(max(block_id) * 8 / 1024) AS HWMsize</span><br><span class="line">    FROM dba_extents</span><br><span class="line">    GROUP BY  file_id) c</span><br><span class="line">WHERE a.file_id = c.file_id</span><br><span class="line">        AND a.filesize - c.hwmsize > 5000;</span><br></pre></td></tr></tbody></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>廖学强,<a href="http://blog.itpub.net/30126024/viewspace-2057474/" target="_blank" rel="noopener">DBA日常维护SQL脚本</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaa.jpeg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="Oracle" scheme="https://jiemin.wang/categories/Oracle/"/>
    
    
      <category term="Oracle" scheme="https://jiemin.wang/tags/Oracle/"/>
    
  </entry>
  
  <entry>
    <title>数据库拆分</title>
    <link href="https://jiemin.wang/2019/04/24/databaseSplitting/"/>
    <id>https://jiemin.wang/2019/04/24/databaseSplitting/</id>
    <published>2019-04-24T10:19:28.000Z</published>
    <updated>2019-04-24T10:28:11.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaaa.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>童话里灰姑娘都很穷，但都很漂亮，你漂亮吗？</strong></p></blockquote><h2 id="数据库水平垂直拆分"><a href="#数据库水平垂直拆分" class="headerlink" title="数据库水平垂直拆分"></a>数据库水平垂直拆分</h2><p>当数据库量非常大的时候，DB 已经成为系统瓶颈时就可以考虑进行水平垂直拆分了。</p><h2 id="水平拆分"><a href="#水平拆分" class="headerlink" title="水平拆分"></a>水平拆分</h2><p>一般水平拆分是根据表中的某一字段(通常是主键 ID )取模处理，将一张表的数据拆分到多个表中。这样每张表的表结构是相同的但是数据不同。</p><p>不但可以通过 ID 取模分表还可以通过时间分表，比如每月生成一张表。<br>按照范围分表也是可行的:一张表只存储 <code>0~1000W</code>的数据，超过只就进行分表，这样分表的优点是扩展灵活，但是存在热点数据。</p><p>按照取模分表拆分之后我们的查询、修改、删除也都是取模。比如新增一条数据的时候往往需要一张临时表来生成 ID,然后根据生成的 ID 取模计算出需要写入的是哪张表(也可以使用<a href="https://jiemin.wang/2019/04/24/Distributed-ID-Generation/">分布式 ID 生成器</a>来生成 ID)。</p><p>分表之后不能避免的就是查询要比以前复杂，通常不建议 <code>join</code> ，一般的做法是做两次查询。</p><h2 id="垂直拆分"><a href="#垂直拆分" class="headerlink" title="垂直拆分"></a>垂直拆分</h2><p>当一张表的字段过多时则可以考虑垂直拆分。<br>通常是将一张表的字段才分为主表以及扩展表，使用频次较高的字段在一张表，其余的在一张表。</p><p>这里的多表查询也不建议使用 <code>join</code> ，依然建议使用两次查询。</p><h2 id="拆分之后带来的问题"><a href="#拆分之后带来的问题" class="headerlink" title="拆分之后带来的问题"></a>拆分之后带来的问题</h2><p>拆分之后由一张表变为了多张表，一个库变为了多个库。最突出的一个问题就是事务如何保证。</p><h3 id="两段提交"><a href="#两段提交" class="headerlink" title="两段提交"></a>两段提交</h3><h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><p>如果业务对强一致性要求不是那么高那么最终一致性则是一种比较好的方案。</p><p>通常的做法就是补偿，比如 一个业务是 A 调用 B，两个执行成功才算最终成功，当 A 成功之后，B 执行失败如何来通知 A 呢。</p><p>比较常见的做法是 失败时 B 通过 MQ 将消息告诉 A，A 再来进行回滚。这种的前提是 A 的回滚操作得是幂等的，不然 B 重复发消息就会出现问题。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaaa.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>分布式 ID 生成策略</title>
    <link href="https://jiemin.wang/2019/04/24/Distributed-ID-Generation/"/>
    <id>https://jiemin.wang/2019/04/24/Distributed-ID-Generation/</id>
    <published>2019-04-24T09:49:09.000Z</published>
    <updated>2019-04-24T10:28:38.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="images.png" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>胸小的姑娘一般脾气都特大，胸大的姑娘一般脾气都特好，因为古语有云：穷凶极恶有容乃大！</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于系统中的一组数据而言，必不可少地对应有唯一标识。简单的单体应用可以使用数据库的自增 ID 作为唯一标识。而在复杂的分布式系统中，就需要一些特定的策略去生成对应的分布式 ID。</p><p>常见的项目中 ID 会有以下两个特点：</p><ol><li>全局唯一性。</li><li>趋势递增（对于使用 MySQL 的项目而言）。</li><li><blockquote><p>因为一般 ID 会作为数据库的主键存储，而在 MySQL InnoDB 中使用的是聚簇索引，使用有序的 ID 可以保证写入性能。</p></blockquote></li></ol><p>一般在分布式系统中，会有一个单独的服务来生成 ID。而这个服务则需要保证高可用性、高QPS 与安全性。另外生成的 ID 是不应该对外暴露的，如果非要对外展示，最好是无规则、不规律的编码。</p><h2 id="生成策略"><a href="#生成策略" class="headerlink" title="生成策略"></a>生成策略</h2><h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4><p>UUID (Universally Unique Identifier) 生成的是一个长度为 32 的 16 进制格式的字符串。UUID 有多个版本，各版本算法不同。但核心思想是一致的，基本上都是结合机器的网卡、当前时间、一个随机数来生成特定长度的字符串。</p><p>优点：性能好、高可扩展性：本地生成，无网络消耗，不需要考虑性能瓶颈。</p><p>缺点：</p><ul><li>无法保证趋势递增。</li><li>UUID 过长，如果需要在数据库存储，作为主键建立索引效率低。</li></ul><p>适用场景：不需要考虑空间占用，不需要生成有递增趋势，且不在 MySQL 中存储。</p><h4 id="Snowflake"><a href="#Snowflake" class="headerlink" title="Snowflake"></a>Snowflake</h4><p>snowflake 是 Twitter 开源的一个 ID 生成算法。<br><img src="/2019/04/24/Distributed-ID-Generation/640.webp" width="640"></p><ul><li>首位符号位：因为 ID 一般为正数，该值为 0。</li><li>41 位时间戳（毫秒级）：</li><li><blockquote><p>时间戳不是当前时间的时间戳，而是存储时间戳的差值（当前时间戳 - 起始时间戳（起始时间戳需要程序指定））理论上可以最多使用 <code>(1 << 41) / (1000x60x60x24x365) = 69年</code>。</p></blockquote></li><li><p>10 位数据机器位：包括 5 位数据标识位和 5 位机器标识位，也就是说最多可以部署节点数为：<code>1 << 10 = 1024</code>。</p></li><li>12 位毫秒内的序列：同一节点、同一时刻最多生成 ID 数 <code>1 << 12 = 4096</code>。</li></ul><p>最后生成结果为 64 位 Long 型数值。</p><p>优点</p><ul><li>趋势递增，且按照时间有序。</li><li>性能高、稳定性高、不依赖数据库等第三方系统。</li><li>可以按照自身业务特性灵活分配 bit 位。</li></ul><p>缺点</p><ul><li>依赖于机器时钟，时钟回拨会造成暂不可用或重复发号。<blockquote><p>在分布式系统中，每台机器上的时钟不可能完全同步。在同步各个服务器的时间时，有一定几率发生时钟回拨。</p></blockquote></li></ul><p>适用场景：要求高性能，可以不连续，数据类型为 long 型。</p><h4 id="Flicker"><a href="#Flicker" class="headerlink" title="Flicker"></a>Flicker</h4><p>Flicker 方案主要思路是设计单独的库表，利用数据库的自增 ID 来生成全局 ID。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE ticket_center (  </span><br><span class="line">    id bigint(20) unsigned NOT NULL auto_increment,  </span><br><span class="line">    stub char(1) NOT NULL default <span class="string">''</span>,  </span><br><span class="line">    PRIMARY KEY (id),  </span><br><span class="line">    UNIQUE KEY unq_stub (stub)  </span><br><span class="line">)ENGINE=MyISAM;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li><blockquote><p>stub: 票根，对应需要生成 Id 的业务方编码，可以是项目名、表名甚至是服务器 IP 地址。</p></blockquote></li><li><blockquote><p>MyISAM：默认表类型，基于传统的 ISAM 类型。ISAM是 Indexed Sequential Access Method (有索引的顺序访问方法) 的缩写，它是存储记录和文件的标准方法。不是事务安全的，而且不支持外键。如果执行大量的 select，MySql 存储引擎选用 MyISAM 比较适合。</p></blockquote></li></ul><p>可以使用下面的SQL 获取 ID:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPLACE INTO ticket_center (stub) VALUES (<span class="string">'test'</span>);  </span><br><span class="line">SELECT LAST_INSERT_ID();</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p><code>Replace into</code> 先尝试插入数据到表中，如果发现表中已经有此行数据（根据主键或者唯一索引判断）则先删除此行数据，然后插入新的数据， 否则直接插入新数据</p></blockquote><p>为了解决单点故障问题：Flicker 方案启用了两台数据库服务器来生成 ID，通过区分 auto_increment 的起始值和步长来生成奇偶数的 ID。（也可以根据情况部署多台服务器）</p><p>优点</p><p>充分利用了数据库自增 ID 机制，生成的 ID 有序递增。</p><p>缺点</p><p>依赖于数据库，可用性低</p><p>水平扩展困难：定义好了起始值、步长和机器台数之后，如果要添加机器就比较麻烦了。</p><p>适用场景：数据量不多，并发量不大。</p><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><p>因为 Redis 中的所有命令都是单线程的，可以利用 Incrby命令来模拟 ID 的递增。并且可以通过使用集群来提升吞吐量。我们可以为不同的 Redis 节点设置不同的初始值并统一步长，这样就能利用 Redis 生成唯一且趋势递增的 ID 了。例如有 3 个 Redis 节点，分别设置初始值为 1、2、3 ，这时步长就应该定为 3 。这样每个节点不会生成重复的 ID。</p><blockquote><p>Incrby ：将 key 中储存的数字加上指定的增量值。这是一个 “INCR AND GET” 的原子操作, 业务方可以定义一个自己的 key 值，通过 INCR 命令来获取对应的 ID。</p></blockquote><p>优点：<br>不依赖数据库，且性能优于依赖数据库的 Flicker 方案。</p><p>缺点：</p><ul><li>扩展性低，Redis 集群需要设置好初始值与步长。</li><li>Reids 宕机可能会生成重复的Id。</li></ul><p>适用场景：Redis 集群高可用，并发量高。</p><h4 id="Leaf"><a href="#Leaf" class="headerlink" title="Leaf"></a>Leaf</h4><p>上面提到的这些常见的 ID 生成策略，有时并不能完全满足实际生产中的需求，在实际项目中会对其做一些改造和优化。</p><p>美团的 Leaf 分布式 ID 生成系统 ，在 Flicker 策略 与 Snowflake 算法的基础上做了两套优化的方案。下文会简单介绍一下 Leaf 方案做的一些优化，并不会深入分析。详细方案大家可以查看这里：《Leaf 分布式 ID 生成系统 》</p><p>Leaf-segment 数据库方案</p><p>相比于 Flicker 方案每次都需要读取数据库，Leaf-segment 改为了利用 proxy server 批量获取，且做了双 buffer 的优化。设计图如下：<br><img src="/2019/04/24/Distributed-ID-Generation/640_1.webp" title="640_1"></p><blockquote><p>双 buffer：ID 分号段加载，且当号段消费到某个点时就异步的把下一个号段加载到内存中。而不需要等到号段用尽的时候才去更新号段。</p></blockquote><p>Leaf-snowflake 方案</p><p>主要是针对时钟回拨问题做了特殊处理。 若发生时钟回拨则拒绝发号，并进行告警。<br><img src="/2019/04/24/Distributed-ID-Generation/640_2.webp" title="640_2"></p><p>适用场景：服务规模较大，调用频繁。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>关于分布式 ID 的生成策略暂且介绍到这里。其实还有一些优秀的解决方案，比如百度的 uid-generator，微信的 SEQSVR。基本上都是都上面一些方案的优化，这里就不做详细介绍了。在实际使用中，需要根据自身业务场景来选取合适的方案，也并非大而全的方案就是好的方案。</p><h2 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h2><p>牛在舒，<a href="https://mp.weixin.qq.com/s/h8dphDS4D36nWyhPCLC7ag" target="_blank" rel="noopener">分布式 ID 生成策略</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;images.png&quot; class=&quot;full-image&quot; alt=
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 水平拆分表的一次踩坑</title>
    <link href="https://jiemin.wang/2019/04/24/mysql-sharding/"/>
    <id>https://jiemin.wang/2019/04/24/mysql-sharding/</id>
    <published>2019-04-24T09:43:37.000Z</published>
    <updated>2019-04-24T09:56:53.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="cbC80KVt.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>胸小的姑娘一般脾气都特大，胸大的姑娘一般脾气都特好，因为古语有云：穷凶极恶有容乃大！</strong></p></blockquote><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前不少人问我”能否分享一些分库分表相关的实践”，其实不是我不分享，而是真的经验不多🤣；和大部分人一样都是停留在理论阶段。</p><p>不过这次多少有些可以说道了。</p><p>先谈谈背景，我们生产数据库随着业务发展量也逐渐起来；好几张单表已经突破<strong>亿级</strong>数据，并且保持每天 200+W 的数据量增加。</p><p>而我们有些业务需要进行关联查询、或者是报表统计；在这样的背景下大表的问题更加突出（比如一个查询功能需要跑好几分钟）。</p><a id="more"></a><blockquote><p>可能很多人会说：为啥单表都过亿了才想方案解决？其实不是不想，而是由于历史原因加上错误预估了数据增长才导致这个局面。总之原因比较复杂，也不是本次讨论的重点。</p></blockquote><h1 id="临时方案"><a href="#临时方案" class="headerlink" title="临时方案"></a>临时方案</h1><p>由于需求紧、人手缺的情况下，整个处理的过程分为几个阶段。</p><p>第一阶段应该是去年底，当时运维反应 <code>MySQL</code> 所在的主机内存占用很高，整体负载也居高不下，导致整个 MySQL 的吞吐量明显降低（写入、查询数据都明显减慢）。</p><p>为此我们找出了数据量最大的几张表，发现大部分数据量在7/8000W 左右，少数的已经突破一亿。</p><p>通过业务层面进行分析发现，这些数据多数都是用户产生的一些<strong>日志型数据</strong>，而且这些数据在业务上并不是强相关的，甚至两三个月前的数据其实已经不需要实时查询了。</p><p>因为接近年底，尽可能的不想去动应用，考虑是否可以在运维层面缓解压力；主要的目的就是把单表的数据量降低。</p><p>原本是想把两个月之前的数据直接迁移出来放到备份表中，但在准备实施的过程中发现一个大坑。</p><blockquote><p>表中没有一个可以排序的索引，导致我们无法快速的筛选出一部分数据！这真是一个深坑，为后面的一些优化埋了个地雷；即便是加索引也需要花几个小时（具体多久没敢在生产测试）。</p></blockquote><p>如果我们强行按照时间进行筛选，可能查询出 4000W 的数据就得花上好几个小时；这显然是行不通的。</p><p>于是我们便想到了一个大胆的想法：这部分数据是否可以直接不要了？</p><p>这可能是最有效及最快的方式了，和产品沟通后得知这部分数据真的只是日志型的数据，即便是报表出不来今后补上也是可以的。</p><p>于是我们就简单粗暴的做了以下事情：</p><ul><li>修改原有表的表名，比如加上(<code>_190416bak</code>)。</li><li>再新建一张和原有表名称相同的表。</li></ul><p>这样新的数据就写到了新表，同时业务上也是使用的这个数据量较小的新表。</p><p>虽说过程不太优雅，但至少是解决了问题同时也给我们做技术改造预留了时间。</p><h1 id="分表方案"><a href="#分表方案" class="headerlink" title="分表方案"></a>分表方案</h1><p>之前的方案虽说可以缓解压力，但不能根本解决问题。</p><p>有些业务必须得查询之前的数据，导致之前那招行不通了，所以正好我们就借助这个机会把表分了。</p><p>我相信大部分人虽说没有做过实际做过分表，但也见过猪跑；网上一搜各种方案层出不穷。</p><p>我认为最重要的一点是要结合实际业务找出需要 sharding 的字段，同时还有上线阶段的数据迁移也非常重要。</p><h2 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h2><p>可能大家都会说用 hash 的方式分配得最均匀，但我认为这还是需要使用历史数据的场景才用哈希分表。</p><p>而对于不需要历史数据的场景，比如业务上只查询近三个月的数据。</p><p>这类需求完成可以采取时间分表，按照月份进行划分，这样改动简单，同时对历史数据也比较好迁移。</p><p>于是我们首先将这类需求的表筛选出来，按照月份进行拆分，只是在查询的时候拼接好表名即可；也比较好理解。</p><h2 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h2><p>刚才也提到了：需要根据业务需求进行分表策略。</p><p>而一旦所有的数据都有可能查询时，按照时间分表也就行不通了。（也能做，只是如果不是按照时间进行查询时需要遍历所有的表）</p><p>因此我们计划采用 <code>hash</code> 的方式分表，这算是业界比较主流的方式就不再赘述。</p><p>采用哈希时需要将 <code>sharding</code> 字段选好，由于我们的业务比较单纯；是一个物联网应用，所有的数据都包含有物联网设备的唯一标识（IMEI），并且这个字段天然的就保持了唯一性；大多数的业务也都是根据这个字段来的，所以它非常适合来做这个 <code>sharding</code> 字段。</p><p>在做分表之前也调研过 <code>MyCAT</code> 及 <code>sharding-jdbc</code>(现已升级为 <code>shardingsphere</code>)，最终考虑到对开发的友好性及不增加运维复杂度还是决定在 jdbc 层 sharding 的方式。</p><p>但由于历史原因我们并不太好集成 <code>sharding-jdbc</code>，但基于 <code>sharding</code> 的特点自己实现了一个分表策略。</p><p>这个简单也好理解：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> index = hash(sharding字段) % 分表数量 ;</span><br><span class="line"></span><br><span class="line">select xx from <span class="string">'busy_'</span>+index where sharding字段 = xxx;</span><br></pre></td></tr></tbody></table></figure><p>其实就是算出了表名，然后路由过去查询即可。</p><p>只是我们实现的非常简单：修改了所有的底层查询方法，每个方法都里都做了这样的一个判断。</p><p>并没有像 <code>sharding-jdbc</code> 一样，代理了数据库的查询方法；其中还要做 <code>SQL解析-->SQL路由-->执行SQL-->合并结果</code> 这一系列的流程。</p><p>如果自己再做一遍无异于重新造了一个轮子，并且并不专业，只是在现有的技术条件下选择了一个快速实现达成效果的方法。</p><p>不过这个过程中我们节省了将 sharding 字段哈希的过程，因为每一个 IMEI 号其实都是一个唯一的整型，直接用它做 mod 运算即可。</p><p>还有一个是需要一个统一的组件生成规则，分表后不能再依赖于单表的字段自增了；方法还是挺多的：</p><ul><li>比如时间戳+随机数可满足大部分业务。</li><li>UUID，生成简单，但没法做排序。</li><li>雪花算法统一生成主键ID。</li></ul><p>大家可以根据自己的实际情况做选择。</p><h1 id="业务调整"><a href="#业务调整" class="headerlink" title="业务调整"></a>业务调整</h1><p>因为我们并没有使用第三方的 sharding-jdbc 组件，所有没有办法做到对代码的低侵入性；每个涉及到分表的业务代码都需要做底层方法的改造（也就是路由到正确的表）。</p><p>考虑到后续业务的发展，我们决定将拆分的表分为 64 张；加上后续引入大数据平台足以应对几年的数据增长。</p><blockquote><p>这里还有个小细节需要注意：分表的数量需要为 2∧N 次方，因为在取模的这种分表方式下，即便是今后再需要分表影响的数据也会尽量的小。</p></blockquote><p>再修改时只能将表名称进行全局搜索，然后加以修改，同时根据修改的方法倒推到表现的业务并记录下来，方便后续回归测试。</p><hr><p>当然无法避免查询时利用非 sharding 字段导致的全表扫描，这是所有分片后都会遇到的问题。</p><p>因此我们在修改分表方法的底层查询时同时也会查看是否有走分片字段，如果不是，那是否可以调整业务。</p><p>比如对于一个上亿的数据是否还有必要存在按照分页查询、日期查询？这样的业务是否真的具有意义？</p><p>我们尽可能的引导产品按照这样的方式来设计产品或者做出调整。</p><p>但对于报表这类的需求确实也没办法，比如统计表中某种类型的数据；这种我们也可以利用多线程的方式去并行查询然后汇总统计来提高查询效率。</p><p>有时也有一些另类场景：</p><blockquote><p>比如一个千万表中有某一特殊类型的数据只占了很小一部分，比如说几千上万条。</p></blockquote><p>这时页面上需要对它进行分页查询是比较正常的（比如某种投诉消息，客户需要一条一条的单独处理），但如果我们按照 IMEI 号或者是主键进行分片后再分页查询那就比较蛋疼了。</p><p>所以这类型的数据建议单独新建一张表来维护，不要和其他数据混合在一起，这样不管是做分页还是 like 都比较简单和独立。</p><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>代码改完，开发也单测完成后怎么来验证分表的业务是否正常也比较麻烦。</p><p>一个是测试麻烦，再一个是万一哪里改漏了还是查询的原表，但这样在测试环境并不会有异常，一旦上线产生了生产数据到新的 64 张表后想要再修复就比较麻烦了。</p><p>所以我们取了个巧，直接将原表的表名修改，比如加一个后缀；这样在测试过程中观察前后台有无报错就比较容易提前发现这个问题。</p><h1 id="上线流程"><a href="#上线流程" class="headerlink" title="上线流程"></a>上线流程</h1><p>测试验收通过后只是分表这个需求的80%，剩下如何上线也是比较头疼。</p><p>一旦应用上线后所有的查询、写入、删除都会先走路由然后到达新表；而老数据在原表里是不会发生改变的。</p><h2 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h2><p>所以我们上线前的第一步自然是需要将原有的数据进行迁移，迁移的目的是要分片到新的 64 张表中，这样才会对原有的业务无影响。</p><p>因此我们需要额外准备一个程序，它需要将老表里的数据按照分片规则复制到新表中；</p><p>在我们这个场景下，生产数据有些已经上亿了，这个迁移过程我们在测试环境模拟发现耗时是非常久的。而且我们老表中对于 <code>create_time</code> 这样用于筛选数据的字段没有索引（以前的技术债），所以查询起来就更加慢了。</p><p>最后没办法，我们只能和产品协商告知用户对于之前产生的数据短期可能会查询不到，这个时间最坏可能会持续几天（我们只能在凌晨迁移，白天会影响到数据库负载）。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这便是我们这次的分表实践，虽说不少过程都不优雅，但受限于条件也只能折中处理。</p><p>但我们后续的计划是，修改我们底层的数据连接（目前是自己封装的一个 jar 包，导致集成 sharding-jdbc 比较麻烦）最终逐渐迁移到 <code>sharding-jdbc</code> .</p><p>最后得出了几个结论：</p><ul><li>一个好的产品规划非常有必要，可以在合理的时间对数据处理（不管是分表还是切入归档）。</li><li>每张表都需要一个可以用于排序查询的字段（自增ID、创建时间），整个过程由于没有这个字段导致耽搁了很长时间。</li><li>分表字段需要谨慎，要全盘的考虑业务情况，尽量避免出现查询扫表的情况。</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;cbC80KVt.gif&quot; class=&quot;full-image&quot; alt=&quot;alt&quot; title=&quot;title&quot;&gt;&lt;meta itemprop=&quot;width&quot; content=&quot;auto&quot;&gt;&lt;meta itemprop=&quot;height&quot; content=&quot;auto&quot;&gt;&lt;/span&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;p&gt;&lt;strong&gt;胸小的姑娘一般脾气都特大，胸大的姑娘一般脾气都特好，因为古语有云：穷凶极恶有容乃大！&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;之前不少人问我”能否分享一些分库分表相关的实践”，其实不是我不分享，而是真的经验不多🤣；和大部分人一样都是停留在理论阶段。&lt;/p&gt;
&lt;p&gt;不过这次多少有些可以说道了。&lt;/p&gt;
&lt;p&gt;先谈谈背景，我们生产数据库随着业务发展量也逐渐起来；好几张单表已经突破&lt;strong&gt;亿级&lt;/strong&gt;数据，并且保持每天 200+W 的数据量增加。&lt;/p&gt;
&lt;p&gt;而我们有些业务需要进行关联查询、或者是报表统计；在这样的背景下大表的问题更加突出（比如一个查询功能需要跑好几分钟）。&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL5.7 GTID原理与实战</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-GTID/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-GTID/</id>
    <published>2019-04-22T06:14:52.000Z</published>
    <updated>2019-04-22T07:33:26.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaa.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>工作多年，当人家问你是不是初入社会，不是因为你看起来年轻，而是因为觉得你怎么这么笨。</strong></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h4 id="GTID是什么？"><a href="#GTID是什么？" class="headerlink" title="GTID是什么？"></a>GTID是什么？</h4><p>GTID 是<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html" target="_blank" rel="noopener">Global Transaction Identifiers</a>的缩写，简称GTID</p><h4 id="GTID组成和架构"><a href="#GTID组成和架构" class="headerlink" title="GTID组成和架构"></a>GTID组成和架构</h4><p>1) <code>GTID = source_id:transaction_id</code><br>2) server_uuid 来源于 auto.cnf<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3E11FA47-71CA-11E1-9E33-C80AA9429562</span><br></pre></td></tr></tbody></table></figure><p></p><p>3) GTID: 在一组复制中，全局唯一</p><p>The syntax for a GTID set is as follows:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gtid_set:</span><br><span class="line">    uuid_set [, uuid_set] ...</span><br><span class="line">    | <span class="string">''</span></span><br><span class="line"></span><br><span class="line">uuid_set:</span><br><span class="line">    uuid:interval[:interval]...</span><br><span class="line"></span><br><span class="line">uuid:</span><br><span class="line">    hhhhhhhh-hhhh-hhhh-hhhh-hhhhhhhhhhhh</span><br><span class="line"></span><br><span class="line">h:</span><br><span class="line">    [0-9|A-F]</span><br><span class="line"></span><br><span class="line">interval:</span><br><span class="line">    n[-n]</span><br><span class="line"></span><br><span class="line">    (n >= 1)</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>mysql.gtid_executed表</code>的压缩由名为<code>thread</code>/<code>sql</code>/<code>compress_gtid_table</code>的专用前台线程执行。 此线程未在<code>SHOW PROCESSLIST</code>的输出中列出，但可以将其视为线程表中的一行，如下所示：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql> SELECT * FROM performance_schema.threads WHERE NAME LIKE <span class="string">'%gtid%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">          THREAD_ID: 26</span><br><span class="line">               NAME: thread/sql/compress_gtid_table</span><br><span class="line">               TYPE: FOREGROUND</span><br><span class="line">     PROCESSLIST_ID: 1</span><br><span class="line">   PROCESSLIST_USER: NULL</span><br><span class="line">   PROCESSLIST_HOST: NULL</span><br><span class="line">     PROCESSLIST_DB: NULL</span><br><span class="line">PROCESSLIST_COMMAND: Daemon</span><br><span class="line">   PROCESSLIST_TIME: 1509</span><br><span class="line">  PROCESSLIST_STATE: Suspending</span><br><span class="line">   PROCESSLIST_INFO: NULL</span><br><span class="line">   PARENT_THREAD_ID: 1</span><br><span class="line">               ROLE: NULL</span><br><span class="line">       INSTRUMENTED: YES</span><br><span class="line">            HISTORY: YES</span><br><span class="line">    CONNECTION_TYPE: NULL</span><br><span class="line">       THREAD_OS_ID: 18677</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="GTID和Binlog的关系"><a href="#GTID和Binlog的关系" class="headerlink" title="GTID和Binlog的关系"></a>GTID和Binlog的关系</h5><ul><li><p>GTID在binlog中的结构</p><img src="/2019/04/22/mysql-GTID/binlog_gtid.jpg" title="binlog_gtid"></li><li><p>GTID event 结构</p></li><li><p>Previous_gtid_log_event</p></li></ul><ol><li><code>Previous_gtid_log_event</code> 在每个binlog 头部都会有</li><li>每次<code>binlog rotate</code>的时候存储在binlog头部</li><li><code>Previous-GTIDs</code>在binlog中只会存储在这台机器上执行过的所有binlog，不包括手动设置<code>gtid_purged</code>值。</li><li>换句话说，如果你手动<code>set global gtid_purged=xx;</code> 那么xx是不会记录在<code>Previous_gtid_log_event</code>中的。</li></ol><ul><li>GTID和Binlog之间的关系是怎么对应的呢<br>  如何才能找到GTID=?对应的binlog文件呢？<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 假设有4个binlog: bin.001,bin.002,bin.003,bin.004</span><br><span class="line">* bin.001 : Previous-GTIDs=empty; binlog_event有：1-40  </span><br><span class="line">* bin.002 : Previous-GTIDs=1-40;  binlog_event有：41-80 </span><br><span class="line">* bin.003 : Previous-GTIDs=1-80;  binlog_event有：81-120  </span><br><span class="line">* bin.004 : Previous-GTIDs=1-120;  binlog_event有：121-160  </span><br><span class="line">    1. 假设现在我们要找GTID=<span class="variable">$A</span>，那么MySQL的扫描顺序为： 从最后一个binlog开始扫描（即：bin.004）      </span><br><span class="line">    2. bin.004的Previous-GTIDs=1-120，如果<span class="variable">$A</span>=140 > Previous-GTIDs,那么肯定在bin.004中  </span><br><span class="line">    3. bin.004的Previous-GTIDs=1-120，如果<span class="variable">$A</span>=88 包含在Previous-GTIDs中,那么继续对比上一个binlog文件 bin.003,然后再循环前面2个步骤，直到找到为止</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="重要参数的持久化"><a href="#重要参数的持久化" class="headerlink" title="重要参数的持久化"></a>重要参数的持久化</h5><ul><li>GTID相关参数</li></ul><table><thead><tr><th style="text-align:center">variables</th><th style="text-align:center">comment</th></tr></thead><tbody><tr><td style="text-align:center">gtid_executed</td><td style="text-align:center">执行过的所有GTID</td></tr><tr><td style="text-align:center">gtid_purged</td><td style="text-align:center">丢弃掉的GTID</td></tr><tr><td style="text-align:center">gtid_mode</td><td style="text-align:center">gtid模式</td></tr><tr><td style="text-align:center">gtid_next</td><td style="text-align:center">session级别的变量，下一个gtid</td></tr><tr><td style="text-align:center">gtid_owned</td><td style="text-align:center">正在运行的gtid</td></tr><tr><td style="text-align:center">enforce_gtid_consistency</td><td style="text-align:center">保证GTID安全的参数</td></tr></tbody></table><ul><li>重要参数如何持久化</li></ul><ol><li>如何持久化<code>gtid_executed</code> <code>[ log-bin=on,log_slave_update=on ]</code><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gtid_executed = mysql.gtid_executed <span class="comment">#[normal]</span></span><br><span class="line">or</span><br><span class="line">gtid_executed = mysql.gtid_executed + last_binlog 中最后没写到mysql.gtid_executed中的gtid_event  <span class="comment">#[recover]</span></span><br></pre></td></tr></tbody></table></figure></li></ol><ul><li>如何持久化重置的gtid_purged值?<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reset master;</span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">'$A:a-b'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 由于有可能手动设置过gtid_purged=<span class="variable">$A</span>:a-b, binlog.index中，last_binlog的Previous-GTIDs并不会包含<span class="variable">$A</span>:a-b  </span><br><span class="line">2. 由于有可能手动设置过gtid_purged=<span class="variable">$A</span>:a-b, binlog.index中，first_binlog的Previous-GTIDs肯定不会出现<span class="variable">$A</span>:a-b  </span><br><span class="line">3. 重置的gtid_purged = @@global.gtid_executed(mysql.gtid_executed:注意，考虑到这个表的更新触发条件，所以这里用@@global.gtid_executed代替) - last_binlog的Previous-GTIDs  - last_binlog所有的gtid_event  </span><br><span class="line">4. 下面就用 <span class="variable">$reset_gtid_purged</span> 来表示重置的gtid</span><br></pre></td></tr></tbody></table></figure><ul><li>如何持久化<code>gtid_purged</code> <code>[ log-bin=on,log_slave_update=on ]</code><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gtid_purged=binlog.index:first_binlog的Previous-GTIDs  + <span class="variable">$reset_gtid_purged</span></span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="开启GTID的必备条件"><a href="#开启GTID的必备条件" class="headerlink" title="开启GTID的必备条件"></a>开启GTID的必备条件</h5><ul><li><p>MySQL 5.6</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (必选)    </span><br><span class="line">log_bin=ON                  (必选)    </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        (必选)    </span><br><span class="line">enforce-gtid-consistency    (必选)</span><br></pre></td></tr></tbody></table></figure></li><li><p>MySQL 5.7</p><blockquote><p>MySQL5.7.13 or higher</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (必选)  </span><br><span class="line">enforce-gtid-consistency    （必选）</span><br><span class="line">log_bin=ON                  （可选）--高可用切换，最好设置ON  </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        （可选）--高可用切换，最好设置ON</span><br></pre></td></tr></tbody></table></figure></blockquote></li></ul><h5 id="新的复制协议-COM-BINLOG-DUMP-GTID"><a href="#新的复制协议-COM-BINLOG-DUMP-GTID" class="headerlink" title="新的复制协议 COM_BINLOG_DUMP_GTID"></a>新的复制协议 COM_BINLOG_DUMP_GTID</h5><ul><li><p>slave会将已经执行过的gtid，以及以及接受到relay log中的gtid的并集发送给master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* http://dev.mysql.com/doc/refman/5.7/en/change-master-to.html</span><br><span class="line">UNION(@@global.gtid_executed, Retrieved_gtid_set - last_received_GTID)</span><br></pre></td></tr></tbody></table></figure></li><li><p>Master send all other transactions to slave</p></li><li>同样的GTID不能被执行两次，如果有同样的GTID，会自动被skip掉。</li></ul><img src="/2019/04/22/mysql-GTID/com_binlog_dump_gtid.jpg" title="com_binlog_dump_gtid"><pre><code>- slave1 : 将自身的UUID1:1 发送给 master，然后接收到了 UUID1:2,UUID1:3 event- slave2 : 将自身的UUID1:1,UUID1:2 发送给 master，然后接收到了UUID1:3 event</code></pre><h5 id="GTID重要函数和新语法"><a href="#GTID重要函数和新语法" class="headerlink" title="GTID重要函数和新语法"></a>GTID重要函数和新语法</h5><ul><li>重要函数</li></ul><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">GTID_SUBSET(subset, set)</td><td style="text-align:center">returns true (1) if all GTIDs in subset are also in set</td></tr><tr><td style="text-align:center">GTID_SUBTRACT(set,subset)</td><td style="text-align:center">returns only those GTIDs from set that are not in subset</td></tr><tr><td style="text-align:center">WAIT_FOR_EXECUTED_GTID_SET(gtid_set[, timeout])</td><td style="text-align:center">Wait until the given GTIDs have executed on slave.</td></tr><tr><td style="text-align:center">WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS(gtid_set[, timeout][,channel])</td><td style="text-align:center">Wait until the given GTIDs have executed on slave.</td></tr></tbody></table><ul><li><p>新语法</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">START SLAVE [thread_types] [until_option] [connection_options]</span><br><span class="line">thread_types:</span><br><span class="line">    [thread_type [, thread_type] ... ]</span><br><span class="line">thread_type: </span><br><span class="line">    IO_THREAD | SQL_THREAD</span><br><span class="line">until_option:</span><br><span class="line">    UNTIL {   {SQL_BEFORE_GTIDS | SQL_AFTER_GTIDS} = gtid_set</span><br><span class="line">          |   MASTER_LOG_FILE = <span class="string">'log_name'</span>, MASTER_LOG_POS = log_pos</span><br><span class="line">          |   RELAY_LOG_FILE = <span class="string">'log_name'</span>, RELAY_LOG_POS = log_pos</span><br><span class="line">          |   SQL_AFTER_MTS_GAPS  }</span><br></pre></td></tr></tbody></table></figure></li><li><p>举个栗子: </p></li></ul><ol><li><p>START SLAVE SQL_THREAD UNTIL SQL_BEFORE_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56   </p><blockquote><p>表示，当SQL_thread 执行到3E11FA47-71CA-11E1-9E33-C80AA9429562:10 的时候停止，下一个事务是11  </p></blockquote></li><li><p>START SLAVE SQL_THREAD UNTIL SQL_AFTER_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56  </p><blockquote><p>表示，当SQL_thread 执行到3E11FA47-71CA-11E1-9E33-C80AA9429562:56 的时候停止，56是最后一个提交的事务。</p></blockquote></li></ol><h4 id="GTID有什么好处"><a href="#GTID有什么好处" class="headerlink" title="GTID有什么好处"></a>GTID有什么好处</h4><h5 id="classic-replication-运维之伤"><a href="#classic-replication-运维之伤" class="headerlink" title="classic replication [运维之伤]"></a>classic replication [运维之伤]</h5><img src="/2019/04/22/mysql-GTID/classic_rpl.jpg" title="classic_rpl"><h5 id="GTID-replication-so-easy"><a href="#GTID-replication-so-easy" class="headerlink" title="GTID replication [so easy]"></a>GTID replication [so easy]</h5><img src="/2019/04/22/mysql-GTID/GTID_rpl.jpg" title="GTID_rpl"><h4 id="GTID的Limitation"><a href="#GTID的Limitation" class="headerlink" title="GTID的Limitation"></a>GTID的Limitation</h4><ul><li>不安全的事务<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置enforce-gtid-consistency=ON</span><br></pre></td></tr></tbody></table></figure></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. CREATE TABLE ... SELECT statements  </span><br><span class="line">2. CREATE TEMPORARY TABLE or DROP TEMPORARY TABLE statements inside transactions</span><br><span class="line">3. 同时更新 事务引擎 和 非事务引擎。</span><br></pre></td></tr></tbody></table></figure><h4 id="MySQL5-7-GTID-crash-safe"><a href="#MySQL5-7-GTID-crash-safe" class="headerlink" title="MySQL5.7 GTID crash-safe"></a>MySQL5.7 GTID crash-safe</h4><p><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-solutions-unexpected-slave-halt.html" target="_blank" rel="noopener">关于 GTID crash safe 可以参考官方文档列出的安全配置</a></p><ul><li>单线程复制<br>Non-GTID 推荐配置:<ul><li>relay_log_recovery=1</li><li>relay_log_info_repository=TABLE</li><li>master_info_repository=TABLE</li></ul></li></ul><p>GTID 推荐配置:</p><pre><code>* MASTER_AUTO_POSITION=on* relay_log_recovery=0</code></pre><img src="/2019/04/22/mysql-GTID/replication_slave_halt.jpg" title="replication_slave_halt"><ul><li>多线程复制<br>Non-GTID 推荐配置:<ul><li>relay_log_recovery=1</li><li>sync_relay_log=1</li><li>relay_log_info_repository=TABLE</li><li>master_info_repository=TABLE<br>GTID 推荐配置:</li><li>MASTER_AUTO_POSITION=on</li><li>relay_log_recovery=0</li></ul></li></ul><img src="/2019/04/22/mysql-GTID/replication_slave_halt_duoble.jpg" title="replication_slave_halt_duoble"><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h4 id="使用GTID搭建Replication"><a href="#使用GTID搭建Replication" class="headerlink" title="使用GTID搭建Replication"></a>使用GTID搭建Replication</h4><h5 id="从0开始搭建"><a href="#从0开始搭建" class="headerlink" title="从0开始搭建"></a>从0开始搭建</h5><ul><li><p>step 1: 让所有server处于同一个点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@global.read_only = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 2: 关闭所有MySQL</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell> mysqladmin -uusername -p shutdown</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: 重启所有MySQL，并开启GTID</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell> mysqld --gtid-mode=ON --<span class="built_in">log</span>-bin --enforce-gtid-consistency &</span><br></pre></td></tr></tbody></table></figure></li></ul><blockquote><p>当然，在my.cnf中配置好最佳</p></blockquote><ul><li><p>step 4: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line">mysql> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 5: 让master 可读可写</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@global.read_only = OFF;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="从备份中恢复-amp-搭建"><a href="#从备份中恢复-amp-搭建" class="headerlink" title="从备份中恢复&搭建"></a>从备份中恢复&搭建</h5><ul><li><p>step 1: 备份</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqldump xx 获取并且记录gtid_purged值  </span><br><span class="line">or</span><br><span class="line">冷备份 --获取并且记录gtid_executed值，这个就相当于mysqldump中得到的gtid_purged</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 2: 在新服务器上reset master，导入备份</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reset master; --清空gtid信息  </span><br><span class="line">导入备份； --如果是逻辑导入，请设置sql_log_bin=off  </span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">'xx'</span>;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line">mysql> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="如何从classic-replication-升级成-GTID-replication"><a href="#如何从classic-replication-升级成-GTID-replication" class="headerlink" title="如何从classic replication 升级成 GTID replication"></a>如何从classic replication 升级成 GTID replication</h4><h5 id="offline-方式升级"><a href="#offline-方式升级" class="headerlink" title="offline 方式升级"></a>offline 方式升级</h5><p>offline 的方式升级最简单。全部关机，然后配置好GTID，重启，<code>CHANGE MASTER TO MASTER_AUTO_POSITION=1</code>。</p><h5 id="online-方式升级"><a href="#online-方式升级" class="headerlink" title="online 方式升级"></a>online 方式升级</h5><p>这里先介绍几个重要<code>GTID_MODE</code>的<code>value</code></p><ul><li>GTID_MODE = OFF               不产生Normal_GTID，只接受来自master的ANONYMOUS_GTID</li><li>GTID_MODE = OFF_PERMISSIVE    不产生Normal_GTID，可以接受来自master的ANONYMOUS_GTID & Normal_GTID</li><li>GTID_MODE = ON_PERMISSIVE     产生Normal_GTID，可以接受来自master的ANONYMOUS_GTID & Normal_GTID</li><li>GTID_MODE = ON                产生Normal_GTID，只接受来自master的Normal_GTID</li></ul><p>master和slave的gtid_mode 组合搭配矩阵图</p><blockquote><p>水平的GTID_MODE为：master</p></blockquote><blockquote><p>垂直的GTID_MODE为：slave</p></blockquote><table><thead><tr><th style="text-align:left">gtid_mode</th><th style="text-align:left">OFF(master)</th><th style="text-align:left">OFF_PERMISSIVE(master)</th><th style="text-align:left">ON_PERMISSIVE(master)</th><th style="text-align:left">ON(master)</th></tr></thead><tbody><tr><td style="text-align:left">OFF(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">N</td><td style="text-align:left">N</td></tr><tr><td style="text-align:left">OFF_PERMISSIVE(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_position可以开启)</td></tr><tr><td style="text-align:left">ON_PERMISSIVE(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_position可以开启)</td></tr><tr><td style="text-align:left">ON(slave)</td><td style="text-align:left">N</td><td style="text-align:left">N</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_position可以开启)</td></tr></tbody></table><p>归纳总结：</p><ol><li>当master产生Normal_GTID的时候（ON_PERMISSIVE，ON），如果slave的gtid_mode（OFF）不能接受Normal_GTID，那么就会报错</li><li>当master产生ANONYMOUS_GTID的时候（OFF_PERMISSIVE，OFF），如果slave的gtid_mode（ON）不能接受ANONYMOUS_GTID，那么就会报错</li><li>设置auto_position的条件： 当master gtid_mode=ON时，slave可以为OFF_PERMISSIVE，ON_PERMISSIVE，ON。除此之外，都不能设置auto_position = on</li></ol><p>下面罗列下，如何online 升级为GTID模式。</p><ul><li><p>step 1: 每台server执行</p><blockquote><p>检查错误日志，直到没有错误出现，才能进行下一步</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 2: 每台server执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: 每台server执行</p><blockquote><p>不用关心一组复制集群的server的执行顺序，只需要保证每个Server都执行了，才能进行下一步</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 4: 每台server执行</p><blockquote><p>不用关心一组复制集群的server的执行顺序，只需要保证每个Server都执行了，才能进行下一步</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 5: 在每台server上执行，如果ONGOING_ANONYMOUS_TRANSACTION_COUNT=0就可以</p><blockquote><p>不需要一直为0，只要出现过0一次，就ok</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE <span class="string">'ONGOING_ANONYMOUS_TRANSACTION_COUNT'</span>;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 6： 确保所有anonymous事务传递到slave上了</p></li></ul><ul><li><p>master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS;</span><br></pre></td></tr></tbody></table></figure></li><li><p>每个slave  </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT MASTER_POS_WAIT(file, position);</span><br></pre></td></tr></tbody></table></figure></li></ul><p>或者，等一段时间，只要不是大的延迟，一般都没问题</p><ul><li><p>step 7: 每台Server上执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 8: 在每台server上将my.cnf中添加好gtid配置</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (必选) </span><br><span class="line">enforce-gtid-consistency    (必选)</span><br><span class="line">log_bin=ON                  (可选)--高可用切换，最好设置ON  </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        (可选)--高可用切换，最好设置ON</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 9: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;  </span><br><span class="line">CHANGE MASTER TO MASTER_AUTO_POSITION = 1;  </span><br><span class="line">START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="GTID-failover"><a href="#GTID-failover" class="headerlink" title="GTID failover"></a>GTID failover</h4><h5 id="MySQL-crash"><a href="#MySQL-crash" class="headerlink" title="MySQL crash"></a>MySQL crash</h5><pre><code>> 配置好loss-less semi-sync replication，可以更可靠的保证数据零丢失。  以下说的都是crash 后，起不来的情况</code></pre><ul><li>binlog 在master还有日志没有传递到 slave<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 选取最新的slave, CHANGE MASTER TO maseter_auto_position 同步好  </span><br><span class="line">2. mysqlbinlog 将没传递过来的binlog在新master上replay  </span><br><span class="line">3. 打开新 master 的 SET GLOBAL surper_read_only=off;</span><br><span class="line">``` </span><br><span class="line">* binlog 已经传递到slave</span><br><span class="line">```bash</span><br><span class="line">1. 选取最新的slave, CHANGE MASTER TO maseter_auto_position同步好  </span><br><span class="line">2. 打开新master的 SET GLOBAL surper_read_only=off;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="OS-crash"><a href="#OS-crash" class="headerlink" title="OS crash"></a>OS crash</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 选取最新的slave, CHANGE MASTER TO maseter_auto_position同步好  </span><br><span class="line">2. 打开新master的 SET GLOBAL surper_read_only=off;</span><br></pre></td></tr></tbody></table></figure><blockquote><blockquote><p>以上操作，在传统模式复制下，只能通过MHA来实现，MHA比较复杂。<br>   现在，在GTID模式下，实现起来非常简单，且非常方便。</p></blockquote></blockquote><h4 id="GTID-运维和错误处理"><a href="#GTID-运维和错误处理" class="headerlink" title="GTID 运维和错误处理"></a>GTID 运维和错误处理</h4><ol><li>使用GTID后，对原来传统的运维有不同之处了，需要调整过来。</li><li>使用Row模式且复制配置正确的情况下，基本上很少发现有复制出错的情况。</li><li>slave 设置 super_read_only=on</li></ol><h5 id="错误场景-Errant-transaction"><a href="#错误场景-Errant-transaction" class="headerlink" title="错误场景: Errant transaction"></a>错误场景: Errant transaction</h5><p>出现这种问题基本有两种情况</p><blockquote><ol><li>复制参数没有配置正确，当slave crash后，会出现重复键问题</li><li>DBA操作不正确，不小心在slave上执行了事务</li></ol></blockquote><p>对于第一个重复键问题</p><ul><li><p>对于第一个重复键问题</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* skip transation; </span><br><span class="line">SQL> SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1;</span><br><span class="line">SQL> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li><li><p>GTID模式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL> SET GTID_NEXT=<span class="string">'b9b4712a-df64-11e3-b391-60672090eb04:7'</span>;   --设置需要跳过的gtid event</span><br><span class="line">SQL> BEGIN;COMMIT;</span><br><span class="line">SQL> SET GTID_NEXT=<span class="string">'AUTOMATIC'</span>;</span><br><span class="line">SQL> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><p>对于第二种不小心多执行了事务</p><blockquote><p>这种情况就比较难了，这样已经导致了数据不一致，大多数情况，建议slave重做<br>  如何避免： slave 设置 super_read_only=on;</p></blockquote><p><strong><em>重点： 当发生inject empty transction后，有可能会丢失事务</em></strong></p><pre><code>这里说下inject empty transction的隐患    当slave上inject empty transction，说明有一个master的事务被忽略了（这里假设是 $uuid:100）    事务丢失一：如果此时此刻master挂了，这个slave被选举为新master，那么其他的slave如果还没有执行到$uuid:100,就会丢失掉$uuid:100这个事务。    事务丢失二：如果从备份中重新搭建一个slave，需要重新执行之前的所有事务，而此时，master挂了， 又回到了事务丢失一的场景。</code></pre><h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><h4 id="如何重置gtid-executed，gtid-purged。"><a href="#如何重置gtid-executed，gtid-purged。" class="headerlink" title="如何重置gtid_executed，gtid_purged。"></a>如何重置gtid_executed，gtid_purged。</h4><ul><li><p>设置gtid_executed</p><blockquote><p>现在只能执行:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> reset master;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>设置gtid_purged</p></li><li>当gtid_executed 非空的时候，不能设置gtid_purged</li><li>当gtid_executed 为空的时候(即刚刚备份好的镜像，刚搭建的mysql)<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@GLOBAL.GTID_PURGED=<span class="string">'0ad6eae9-2d66-11e6-864f-ecf4bbf1f42c:1-3'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="如果auto-cnf-被删掉了，对于GTID的复制会有什么影响？"><a href="#如果auto-cnf-被删掉了，对于GTID的复制会有什么影响？" class="headerlink" title="如果auto.cnf 被删掉了，对于GTID的复制会有什么影响？"></a>如果auto.cnf 被删掉了，对于GTID的复制会有什么影响？</h5><pre><code>> 如果被删掉，重启后，server-uuid 会变</code></pre><h5 id="手动设置-set-gtid-purged-xx-yy-mysql会去主动修改binlog的头么"><a href="#手动设置-set-gtid-purged-xx-yy-mysql会去主动修改binlog的头么" class="headerlink" title="手动设置 set @@gtid_purged = xx:yy, mysql会去主动修改binlog的头么"></a>手动设置 set @@gtid_purged = xx:yy, mysql会去主动修改binlog的头么</h5><pre><code>> 不会</code></pre><h5 id="GTID和复制过滤规则之间如何协同工作？MySQL，test还能愉快的过滤掉吗？"><a href="#GTID和复制过滤规则之间如何协同工作？MySQL，test还能愉快的过滤掉吗？" class="headerlink" title="GTID和复制过滤规则之间如何协同工作？MySQL，test还能愉快的过滤掉吗？"></a>GTID和复制过滤规则之间如何协同工作？MySQL，test还能愉快的过滤掉吗？</h5><pre><code>> 可以，改过滤的会自己过滤，不用担心</code></pre><h2 id="Automatic-failover-with-mysqlfailover-GTID"><a href="#Automatic-failover-with-mysqlfailover-GTID" class="headerlink" title="Automatic failover with mysqlfailover+GTID"></a>Automatic failover with mysqlfailover+GTID</h2><p><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-solutions-switch.html" target="_blank" rel="noopener">mysqlfailover+GTID</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaa.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL查询重复记录,删除重复记录方法</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-duplicate/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-duplicate/</id>
    <published>2019-04-22T05:55:23.000Z</published>
    <updated>2019-04-22T06:05:32.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>善良没用，因为只有你先漂亮，别人才能看到你的善良。</strong></p></blockquote><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>查找全部重复记录<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM 表 WHERE 重复字段 IN (SELECT 重复字段 FROM 表 GROUP BY 重复字段 HAVING COUNT(*)>1);</span><br></pre></td></tr></tbody></table></figure><p></p><p>过滤重复记录(只显示一条)<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM 表 WHERE ID IN (SELECT MAX(ID) FROM 表 GROUP BY Title);     <span class="comment">#显示ID最大一条记录</span></span><br><span class="line">SELECT * FROM 表 WHERE ID IN (SELECT MIN(ID) FROM 表 GROUP BY Title);     <span class="comment">#显示ID最小一条记录</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>删除全部重复记录<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE 表 WHERE 重复字段 IN (SELECT 重复字段 FROM 表 GROUP BY 重复字段 HAVING COUNT(*)>1);</span><br></pre></td></tr></tbody></table></figure><p></p><p>删除全部重复记录保留最大ID最大一条记录<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM 表 WHERE ID NOT IN (SELECT MAX(ID) FROM 表 GROUP BY Title)    <span class="comment">#保留ID最大一条记录</span></span><br><span class="line">DELETE FROM 表 WHERE ID NOT IN (SELECT MIN(ID) FROM 表 GROUP BY Title)    <span class="comment">#保留ID最小一条记录</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>删除表中多余的重复记录（多个字段），只留有rowid最小的记录<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1)</span><br></pre></td></tr></tbody></table></figure><p></p><p>查找表中多余的重复记录（多个字段），不包含rowid最小的记录<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1)</span><br></pre></td></tr></tbody></table></figure><p></p><p>查找表中多余的重复记录（多个字段）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1)</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>说明：</p><ul><li>单表的唯一查询用：distinct</li><li>多表的唯一查询用：group by</li><li>distinct 查询多表时，left join 还有效，全连接无效</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL修改表、字段、库的字符集及字符集</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-character/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-character/</id>
    <published>2019-04-22T05:48:55.000Z</published>
    <updated>2019-04-22T06:06:52.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>一直对发型和身材不满意的人，有一个共同点：不肯承认这是脸的问题。</strong></p></blockquote><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>修改数据库字符集<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE db_name DEFAULT CHARACTER SET character_name [COLLATE ...];</span><br></pre></td></tr></tbody></table></figure><p></p><p>把表默认的字符集和所有字符列（CHAR,VARCHAR,TEXT）改为新的字符集：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name CONVERT TO CHARACTER SET character_name [COLLATE ...]</span><br><span class="line">如：ALTER TABLE logtest CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>只是修改表的默认字符集<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name DEFAULT CHARACTER SET character_name [COLLATE...];</span><br><span class="line">如：ALTER TABLE logtest DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>修改字段的字符集<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name CHANGE c_name c_name CHARACTER SET character_name [COLLATE ...];</span><br><span class="line">如：ALTER TABLE logtest CHANGE title title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看字段编码<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW FULL COLUMNS FROM tbl_name;</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看系统的编码字符<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES WHERE Variable_name LIKE <span class="string">'character\_set\_%'</span> OR Variable_name LIKE <span class="string">'collation%'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="MySQL字符集设置"><a href="#MySQL字符集设置" class="headerlink" title="MySQL字符集设置"></a>MySQL字符集设置</h2><p>系统变量：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">– character_set_server：默认的内部操作字符集</span><br><span class="line">– character_set_client：客户端来源数据使用的字符集</span><br><span class="line">– character_set_connection：连接层字符集</span><br><span class="line">– character_set_results：查询结果字符集</span><br><span class="line">– character_set_database：当前选中数据库的默认字符集</span><br><span class="line">– character_set_system：系统元数据(字段名等)字符集</span><br><span class="line">– 还有以collation_开头的同上面对应的变量，用来描述字符序。</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="用introducer指定文本字符串的字符集"><a href="#用introducer指定文本字符串的字符集" class="headerlink" title="用introducer指定文本字符串的字符集"></a>用introducer指定文本字符串的字符集</h2><p>格式为：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[_charset] ‘string’ [COLLATE collation]</span><br></pre></td></tr></tbody></table></figure><p></p><p>例子:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT _latin1 ‘string’;</span><br><span class="line">• SELECT _utf8 ‘你好’ COLLATE utf8_general_ci;</span><br><span class="line">– 由introducer修饰的文本字符串在请求过程中不经过多余的转码，直接转换为内部字符集处理。</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="MySQL中的字符集转换过程"><a href="#MySQL中的字符集转换过程" class="headerlink" title="MySQL中的字符集转换过程"></a>MySQL中的字符集转换过程</h2><ol><li>MySQL Server收到请求时将请求数据从character_set_client转换为character_set_connection；</li><li>进行内部操作前将请求数据从character_set_connection转换为内部操作字符集，其确定方法如下：<ul><li>使用每个数据字段的CHARACTER SET设定值；</li><li>若上述值不存在，则使用对应数据表的DEFAULT CHARACTER SET设定值(MySQL扩展，非SQL标准)；</li><li>若上述值不存在，则使用对应数据库的DEFAULT CHARACTER SET设定值；</li><li>若上述值不存在，则使用character_set_server设定值。</li></ul></li><li>将操作结果从内部操作字符集转换为character_set_results</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.gif&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Linux Systemd详解</title>
    <link href="https://jiemin.wang/2019/04/22/linux-systemd/"/>
    <id>https://jiemin.wang/2019/04/22/linux-systemd/</id>
    <published>2019-04-22T05:15:48.000Z</published>
    <updated>2019-04-22T06:08:00.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>一场说走就走的旅行，回来等着你的就是一段吃土的日子。</strong></p></blockquote><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Systemd是Linux系统工具，用来启动守护进程，已成为大多数发行版的标配，PID为1最先启动；</p><p>历史上，Linux 的启动一直采用init进程。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/apache2 start</span><br><span class="line">或者</span><br><span class="line">$ service apache2 start</span><br></pre></td></tr></tbody></table></figure><p></p><p>这种方法有两个缺点。</p><ul><li>一是启动时间长。init进程是串行启动，只有前一个进程启动完，才会启动下一个进程。</li><li>二是启动脚本复杂。init进程只是执行启动脚本，不管其他事情。脚本需要自己处理各种情况，这往往使得脚本变得很长。</li></ul><p>Systemd 就是为了解决这些问题而诞生的。它的设计目标是，为系统的启动和管理提供一套完整的解决方案。<br>根据 Linux 惯例，字母d是守护进程（daemon）的缩写。 Systemd 这个名字的含义，就是它要守护整个系统。<br>CentOS/RHEL7 以上版本中Systemd 取代了initd，成为系统的第一个进程（PID 等于 1），其他进程都是它的子进程。<br>查看版本：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl --version</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/04/22/linux-systemd/systemd.png" title="systemd"><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h4 id="systemctl-命令"><a href="#systemctl-命令" class="headerlink" title="systemctl 命令"></a>systemctl 命令</h4><p>重启系统<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reboot</span><br></pre></td></tr></tbody></table></figure><p></p><p>关闭系统，切断电源<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl poweroff</span><br></pre></td></tr></tbody></table></figure><p></p><p>CPU停止工作<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl halt</span><br></pre></td></tr></tbody></table></figure><p></p><p>暂停系统<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">suspend</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>让系统进入冬眠状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl hibernate</span><br></pre></td></tr></tbody></table></figure><p></p><p>让系统进入交互式休眠状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl hybrid-sleep</span><br></pre></td></tr></tbody></table></figure><p></p><p>启动进入救援状态（单用户状态）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl rescue</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>systemd-analyze</code> 是查看启动耗时</p><p>查看启动耗时<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看每个服务的启动耗时<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze blame</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示瀑布状的启动过程流<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze critical-chain</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示指定服务的启动流<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze critical-chain atd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="hostnamectl命令用于查看当前主机的信息。"><a href="#hostnamectl命令用于查看当前主机的信息。" class="headerlink" title="hostnamectl命令用于查看当前主机的信息。"></a><code>hostnamectl</code>命令用于查看当前主机的信息。</h4><p>显示当前主机的信息<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl</span><br><span class="line">```bash</span><br><span class="line">设置主机名。</span><br><span class="line">```bash</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname rhel7</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="localectl命令用于查看本地化设置。"><a href="#localectl命令用于查看本地化设置。" class="headerlink" title="localectl命令用于查看本地化设置。"></a><code>localectl</code>命令用于查看本地化设置。</h4><p>查看本地化设置<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localectl</span><br></pre></td></tr></tbody></table></figure><p></p><p>设置本地化参数。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localectl <span class="built_in">set</span>-locale LANG=en_GB.utf8</span><br><span class="line">localectl <span class="built_in">set</span>-keymap en_GB</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="timedatectl命令用于查看当前时区设置。"><a href="#timedatectl命令用于查看当前时区设置。" class="headerlink" title="timedatectl命令用于查看当前时区设置。"></a><code>timedatectl</code>命令用于查看当前时区设置。</h4><p>查看当前时区设置<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示所有可用的时区<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones</span><br></pre></td></tr></tbody></table></figure><p></p><p>设置当前时区<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timedatectl <span class="built_in">set</span>-timezone America/New_York</span><br><span class="line">timedatectl <span class="built_in">set</span>-time YYYY-MM-DD</span><br><span class="line">timedatectl <span class="built_in">set</span>-time HH:MM:SS</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="loginctl命令用于查看当前登录的用户。"><a href="#loginctl命令用于查看当前登录的用户。" class="headerlink" title="loginctl命令用于查看当前登录的用户。"></a><code>loginctl</code>命令用于查看当前登录的用户。</h4><p>列出当前session<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl list-sessions</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出当前登录用户<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl list-users</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出显示指定用户的信息<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl show-user ruanyf</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p><code>Systemd</code> 可以管理所有系统资源。不同的资源统称为 Unit（单位）。</p><p><code>Unit</code> 一共分成12种。</p><ul><li><code>Service unit</code>：系统服务</li><li><code>Target unit</code>：多个 Unit 构成的一个组</li><li><code>Device Unit</code>：硬件设备</li><li><code>Mount Unit</code>：文件系统的挂载点</li><li><code>Automount Unit</code>：自动挂载点</li><li><code>Path Unit</code>：文件或路径</li><li><code>Scope Unit</code>：不是由 Systemd 启动的外部进程</li><li><code>Slice Unit</code>：进程组</li><li><code>Snapshot Unit</code>：Systemd 快照，可以切回某个快照</li><li><code>Socket Unit</code>：进程间通信的 socket</li><li><code>Swap Unit</code>：swap 文件</li><li><code>Timer Unit</code>：定时器</li></ul><p><code>systemctl list-units</code>命令可以查看当前系统的所有 Unit 。</p><p>列出正在运行的 Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出所有Unit，包括没有找到配置文件的或者启动失败的<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --all</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出所有没有运行的 Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --all --state=inactive</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出所有加载失败的 Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --failed</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出所有正在运行的、类型为 service 的 Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --<span class="built_in">type</span>=service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-的状态"><a href="#Unit-的状态" class="headerlink" title="Unit 的状态"></a><code>Unit</code> 的状态</h4><p><code>systemctl status</code>命令用于查看系统状态和单个 Unit 的状态。</p><p>显示系统状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示单个 Unit 的状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysystemctl status bluetooth.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示远程主机的某个 Unit 的状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl -H root@rhel7.example.com status httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>除了<code>status</code>命令，<code>systemctl</code>还提供了三个查询状态的简单方法，主要供脚本内部的判断语句使用。</p><p>显示某个 Unit 是否正在运行<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-active application.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示某个 Unit 是否处于启动失败状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-failed application.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示某个 Unit 服务是否建立了启动链接<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-enabled application.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-管理"><a href="#Unit-管理" class="headerlink" title="Unit 管理"></a><code>Unit</code> 管理</h4><p>对于用户来说，最常用的是下面这些命令，用于启动和停止 Unit（主要是 service）。</p><p>立即启动一个服务<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>立即停止一个服务<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>重启一个服务<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>杀死一个服务的所有子进程<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">kill</span> apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>重新加载一个服务的配置文件<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>重载所有修改过的配置文件<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示某个 Unit 的所有底层参数<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示某个 Unit 的指定属性的值<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show -p CPUShares httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>设置某个 Unit 的指定属性<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">set</span>-property httpd.service CPUShares=500</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h4><p><code>Unit</code> 之间存在依赖关系：A 依赖于 B，就意味着 Systemd 在启动 A 的时候，同时会去启动 B。</p><p><code>systemctl list-dependencies</code>命令列出一个 Unit 的所有依赖。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-dependencies nginx.service</span><br><span class="line">```bash</span><br><span class="line">上面命令的输出结果之中，有些依赖是 Target 类型（详见下文），默认不会展开显示。如果要展开 Target，就需要使用--all参数。</span><br><span class="line">```bash</span><br><span class="line">systemctl list-dependencies --all nginx.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-的配置文件"><a href="#Unit-的配置文件" class="headerlink" title="Unit 的配置文件"></a>Unit 的配置文件</h4><p>每一个 Unit 都有一个配置文件，告诉 Systemd 怎么启动这个 Unit 。</p><p><code>Systemd</code> 默认从目录/etc/systemd/system/读取配置文件。但是，里面存放的大部分文件都是符号链接，指向目录/usr/lib/systemd/system/，真正的配置文件存放在那个目录。</p><p><code>systemctl enable</code>命令用于在上面两个目录之间，建立符号链接关系。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> clamd@scan.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>等同于<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s <span class="string">'/usr/lib/systemd/system/clamd@scan.service'</span> <span class="string">'/etc/systemd/system/multi-user.target.wants/clamd@scan.service'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>如果配置文件里面设置了开机启动，systemctl enable命令相当于激活开机启动。</p><p>与之对应的，systemctl disable命令用于在两个目录之间，撤销符号链接关系，相当于撤销开机启动。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> clamd@scan.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>配置文件的后缀名，就是该 Unit 的种类，比如sshd.socket。如果省略，Systemd 默认后缀名为.service，所以sshd会被理解成sshd.service。</p><p>配置文件的状态<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files命令用于列出所有配置文件。</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出所有配置文件<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files</span><br></pre></td></tr></tbody></table></figure><p></p><p>列出指定类型的配置文件<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=service</span><br><span class="line">这个命令会输出一个列表。</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files</span><br></pre></td></tr></tbody></table></figure><h4 id="UNIT-FILE-STATE"><a href="#UNIT-FILE-STATE" class="headerlink" title="UNIT FILE STATE"></a>UNIT FILE STATE</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chronyd.service enabled</span><br><span class="line">clamd@.service static</span><br><span class="line">clamd@scan.service disabled</span><br></pre></td></tr></tbody></table></figure><p>这个列表显示每个配置文件的状态，一共有四种。</p><ul><li>enabled：已建立启动链接</li><li>disabled：没建立启动链接</li><li>static：该配置文件没有[Install]部分（无法执行），只能作为其他配置文件的依赖</li><li>masked：该配置文件被禁止建立启动链接<blockquote><p>注意，从配置文件的状态无法看出，该 Unit 是否正在运行。这必须执行前面提到的systemctl status命令。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status bluetooth.service</span><br></pre></td></tr></tbody></table></figure></blockquote></li></ul><p>一旦修改配置文件，就要让 SystemD 重新加载配置文件，然后重新启动，否则修改不会生效。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="配置文件的格式"><a href="#配置文件的格式" class="headerlink" title="配置文件的格式"></a>配置文件的格式</h4><p>配置文件就是普通的文本文件，可以用文本编辑器打开。</p><p><code>systemctl cat</code>命令可以查看配置文件的内容。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl cat atd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="unit-配置文件"><a href="#unit-配置文件" class="headerlink" title="unit 配置文件"></a>unit 配置文件</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ATD daemon</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/bin/atd</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">从上面的输出可以看到，配置文件分成几个区块。每个区块的第一行，是用方括号表示的区别名，比如[Unit]。注意，配置文件的区块名和字段名，都是大小写敏感的。</span><br><span class="line">每个区块内部是一些等号连接的键值对。</span><br><span class="line"></span><br><span class="line">[Section]</span><br><span class="line">Directive1=value</span><br><span class="line">Directive2=value</span><br><span class="line"></span><br><span class="line">. . .</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意，键值对的等号两侧不能有空格。</p></blockquote><h4 id="配置文件的区域"><a href="#配置文件的区域" class="headerlink" title="配置文件的区域"></a>配置文件的区域</h4><p><code>[Unit]</code>区块通常是配置文件的第一个区块，用来定义 Unit 的元数据，以及配置与其他 Unit 的关系。它的主要字段如下。</p><ul><li>Description：简短描述</li><li>Documentation：文档地址</li><li>Requires：当前 Unit 依赖的其他 Unit，如果它们没有运行，当前 Unit 会启动失败</li><li>Wants：与当前 Unit 配合的其他 Unit，如果它们没有运行，当前 Unit 不会启动失败</li><li>BindsTo：与Requires类似，它指定的 Unit 如果退出，会导致当前 Unit 停止运行</li><li>Before：如果该字段指定的 Unit 也要启动，那么必须在当前 Unit 之后启动</li><li>After：如果该字段指定的 Unit 也要启动，那么必须在当前 Unit 之前启动</li><li>Conflicts：这里指定的 Unit 不能与当前 Unit 同时运行</li><li>Condition…：当前 Unit 运行必须满足的条件，否则不会运行</li><li>Assert…：当前 Unit 运行必须满足的条件，否则会报启动失败</li></ul><p><code>[Install]</code>通常是配置文件的最后一个区块，用来定义如何启动，以及是否开机启动。它的主要字段如下。</p><ul><li>WantedBy：它的值是一个或多个 Target，当前 Unit 激活时（enable）符号链接会放入/etc/systemd/system目录下面以 Target 名 + .wants后缀构成的子目录中</li><li>RequiredBy：它的值是一个或多个 Target，当前 Unit 激活时，符号链接会放入/etc/systemd/system目录下面以 Target 名 + .required后缀构成的子目录中</li><li>Alias：当前 Unit 可用于启动的别名</li><li>Also：当前 Unit 激活（enable）时，会被同时激活的其他 Unit</li></ul><p><code>[Service]</code>区块用来 Service 的配置，只有 Service 类型的 Unit 才有这个区块。它的主要字段如下。</p><ul><li>Type：定义启动时的进程行为。它有以下几种值。</li><li>Type=simple：默认值，执行ExecStart指定的命令，启动主进程</li><li>Type=forking：以 fork 方式从父进程创建子进程，创建后父进程会立即退出</li><li>Type=oneshot：一次性进程，Systemd 会等当前服务退出，再继续往下执行</li><li>Type=dbus：当前服务通过D-Bus启动</li><li>Type=notify：当前服务启动完毕，会通知Systemd，再继续往下执行</li><li>Type=idle：若有其他任务执行完毕，当前服务才会运行</li><li>ExecStart：启动当前服务的命令</li><li>ExecStartPre：启动当前服务之前执行的命令</li><li>ExecStartPost：启动当前服务之后执行的命令</li><li>ExecReload：重启当前服务时执行的命令</li><li>ExecStop：停止当前服务时执行的命令</li><li>ExecStopPost：停止当其服务之后执行的命令</li><li>RestartSec：自动重启当前服务间隔的秒数</li><li>Restart：定义何种情况 Systemd 会自动重启当前服务，可能的值包括always（总是重启）、on-success、on-failure、on-abnormal、on-abort、on-watchdog</li><li>TimeoutSec：定义 Systemd 停止当前服务之前等待的秒数</li><li>Environment：指定环境变量</li></ul><blockquote><p>Unit 配置文件的完整字段清单，请参考官方文档。</p></blockquote><h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p>启动计算机的时候，需要启动大量的 Unit。如果每一次启动，都要一一写明本次启动需要哪些 Unit，显然非常不方便。Systemd 的解决方案就是 Target。<br>简单说，Target 就是一个 Unit 组，包含许多相关的 Unit 。启动某个 Target 的时候，Systemd 就会启动里面所有的 Unit。从这个意义上说，Target 这个概念类似于”状态点”，启动某个 Target 就好比启动到某种状态。<br>传统的init启动模式里面，有 RunLevel 的概念，跟 Target 的作用很类似。不同的是，RunLevel 是互斥的，不可能多个 RunLevel 同时启动，但是多个 Target 可以同时启动。</p><p>查看当前系统的所有 Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=target</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看一个 Target 包含的所有 Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-dependencies multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看启动时的默认 Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl get-default</span><br></pre></td></tr></tbody></table></figure><p></p><p>设置启动时的默认 Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">set</span>-default multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>切换 Target 时，默认不关闭前一个 Target 启动的进程，<code>systemctl isolate</code> 命令改变这种行为，关闭前一个 Target 里面所有不属于后一个 Target 的进程<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl isolate multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>Target 与 传统 RunLevel 的对应关系如下。<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Traditional runlevel New target name Symbolically linked to...</span><br><span class="line"></span><br><span class="line">Runlevel 0 | runlevel0.target -> poweroff.target</span><br><span class="line">Runlevel 1 | runlevel1.target -> rescue.target</span><br><span class="line">Runlevel 2 | runlevel2.target -> multi-user.target</span><br><span class="line">Runlevel 3 | runlevel3.target -> multi-user.target</span><br><span class="line">Runlevel 4 | runlevel4.target -> multi-user.target</span><br><span class="line">Runlevel 5 | runlevel5.target -> graphical.target</span><br><span class="line">Runlevel 6 | runlevel6.target -> reboot.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>它与init进程的主要差别如下:</p><ol><li>默认的 RunLevel（在/etc/inittab文件设置）现在被默认的 Target 取代，位置是/etc/systemd/system/default.target，通常符号链接到graphical.target（图形界面）或者multi-user.target（多用户命令行）。</li><li>启动脚本的位置，以前是/etc/init.d目录，符号链接到不同的 RunLevel 目录 （比如/etc/rc3.d、/etc/rc5.d等），现在则存放在/lib/systemd/system和/etc/systemd/system目录。</li><li>配置文件的位置，以前init进程的配置文件是/etc/inittab，各种服务的配置文件存放在/etc/sysconfig目录。现在的配置文件主要存放在/lib/systemd目录，在/etc/systemd目录里面的修改可以覆盖原始设置。</li></ol><h4 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h4><p>Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用journalctl一个命令，查看所有日志（内核日志和应用日志）。日志的配置文件是/etc/systemd/journald.conf。</p><p><code>journalctl</code>功能强大，用法非常多。</p><p>查看所有日志（默认情况下 ，只保存本次启动的日志）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看内核日志（不显示应用日志）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -k</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看系统本次启动的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b</span><br><span class="line">journalctl -b -0</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看上一次启动的日志（需更改设置）<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -1</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看指定时间的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">journalctl --since=<span class="string">"2012-10-30 18:17:16"</span></span><br><span class="line">journalctl --since <span class="string">"20 min ago"</span></span><br><span class="line">journalctl --since yesterday</span><br><span class="line">journalctl --since <span class="string">"2015-01-10"</span> --until <span class="string">"2015-01-11 03:00"</span></span><br><span class="line">journalctl --since 09:00 --until <span class="string">"1 hour ago"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>显示尾部的最新10行日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -n</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示尾部指定行数的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -n 20</span><br></pre></td></tr></tbody></table></figure><p></p><p>实时滚动显示最新日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -f</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看指定服务的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl /usr/lib/systemd/systemd</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看指定进程的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl _PID=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看某个路径的脚本的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl /usr/bin/bash</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看指定用户的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl _UID=33 --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看某个 Unit 的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service</span><br><span class="line">journalctl -u nginx.service --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>实时滚动显示某个 Unit 的最新日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service -f</span><br></pre></td></tr></tbody></table></figure><p></p><p>合并显示多个 Unit 的日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service -u php-fpm.service --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看指定优先级（及其以上级别）的日志，共有8级</p><ol start="0"><li>0:emerg</li><li>1:alert</li><li>2:crit</li><li>3:err</li><li>4:warning</li><li>5:notice</li><li>6:info</li><li>7:debug<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -p err -b</span><br></pre></td></tr></tbody></table></figure></li></ol><p>日志默认分页输出，–no-pager 改为正常的标准输出<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --no-pager</span><br></pre></td></tr></tbody></table></figure><p></p><p>以 JSON 格式（单行）输出<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -u nginx.service -o json</span><br></pre></td></tr></tbody></table></figure><p></p><p>以 JSON 格式（多行）输出，可读性更好<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -u nginx.serviceqq -o json-pretty</span><br></pre></td></tr></tbody></table></figure><p></p><p>显示日志占据的硬盘空间<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --disk-usage</span><br></pre></td></tr></tbody></table></figure><p></p><p>指定日志文件占据的最大空间<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --vacuum-size=1G</span><br></pre></td></tr></tbody></table></figure><p></p><p>指定日志文件保存多久<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --vacuum-time=1years</span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux查看最消耗CPU和内存的进程</title>
    <link href="https://jiemin.wang/2019/04/22/cpu-memory/"/>
    <id>https://jiemin.wang/2019/04/22/cpu-memory/</id>
    <published>2019-04-22T05:11:18.000Z</published>
    <updated>2019-04-22T06:12:12.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>真正努力过的人才知道，智商上的差距是不可逾越的。</strong></p></blockquote><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ol><li><p>CPU占用最多的前10个进程： </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k3|head -10</span><br></pre></td></tr></tbody></table></figure></li><li><p>内存消耗最多的前10个进程 </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k4|head -10</span><br></pre></td></tr></tbody></table></figure></li><li><p>虚拟内存使用最多的前10个进程 </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k5|head -10</span><br></pre></td></tr></tbody></table></figure></li></ol><p>几个参数含义:</p><ul><li>%MEM 进程的内存占用率</li><li>VSZ 进程所使用的虚存的大小</li><li>RSS 进程使用的驻留集大小或者是实际内存的大小(RSS is the “resident set size” meaning physical memory used)</li><li>TTY 与进程关联的终端（tty）</li><li>串行端口终端（/dev/ttySn）</li><li>伪终端（/dev/pty/）</li><li>控制终端（/dev/tty）</li><li>控制台终端（/dev/ttyn, /dev/console）</li><li>虚拟终端(/dev/pts/n)</li><li>STAT 检查的状态：进程状态使用字符表示的，如R（running正在运行或准备运行）、S（sleeping睡眠）、I（idle空闲）、Z (僵死)、D（不可中断的睡眠，通常是I/O）、P（等待交换页）、W（换出,表示当前页面不在内存）、N（低优先级任务）T(terminate终止)、W has no resident pages</li><li>D 不可中断 Uninterruptible sleep (usually IO)</li><li>R 正在运行，或在队列中的进程</li><li>S 处于休眠状态</li><li>T 停止或被追踪</li><li>Z 僵尸进程</li><li>W 进入内存交换（从内核2.6开始无效）</li><li>X 死掉的进程</li><li>< 高优先级</li><li>N 低优先级</li><li>L 有些页被锁进内存</li><li>s 包含子进程</li></ul><p>位于后台的进程组</p><ul><li>l 多线程</li><li>克隆线程 multi-threaded (using CLONE_THREAD, like NPTL pthreads do)</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Nginx查看截取切割日志</title>
    <link href="https://jiemin.wang/2019/04/22/nginx-log/"/>
    <id>https://jiemin.wang/2019/04/22/nginx-log/</id>
    <published>2019-04-22T05:07:39.000Z</published>
    <updated>2019-04-22T06:11:27.000Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="AAA.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>这个世界没有错，谁让你长得不好看又没钱。</strong></p></blockquote><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>nginx日志最好实现每天定时切割下，特别是在访问量比较大的时候，方便查看与处理，如果没切割，可以用sed直接切割</p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>查找7月17日访问log导出到17.log文件中<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat gelin_web_access.log | egrep <span class="string">"17/Jul/2017"</span> | sed  -n <span class="string">'/00:00:00/,/23:59:59/p'</span> > /tmp/17.log</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看访问量前10的IP<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> 17.log | sort | uniq -c | sort -nr | head -n 10</span><br></pre></td></tr></tbody></table></figure><p></p><p>查看访问前10的URL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $11}'</span> gelin_web_access.log | sort | uniq -c | sort -nr | head -n 10</span><br></pre></td></tr></tbody></table></figure><p></p><p>查询访问最频繁的URL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $7}'</span> gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more</span><br></pre></td></tr></tbody></table></figure><p></p><p>查询访问最频繁的IP<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more</span><br></pre></td></tr></tbody></table></figure><p></p><p>根据访问IP统计UV<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> gelin_web_access.log | sort | uniq -c | wc -l</span><br></pre></td></tr></tbody></table></figure><p></p><p>统计访问URL统计PV<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $7}'</span> gelin_web_access.log | wc -l</span><br></pre></td></tr></tbody></table></figure><p></p><p>根据时间段统计查看日志<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat gelin_web_access.log | sed -n <span class="string">'/17\/Jul\/2017:12/,/17\/Jul\/2017:13/p'</span> | more</span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;AAA.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
</feed>
