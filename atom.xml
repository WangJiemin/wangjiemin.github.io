<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jamin Blog</title>
  <icon>https://www.gravatar.com/avatar/fca0f49342f608d216999d4b41d5ba65</icon>
  <subtitle>ä¸€ä¸ªä¸èŠæŠ€æœ¯çš„ DBA ä¸æ˜¯ä¸€ä¸ªå¥½å¨å­...</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jiemin.wang/"/>
  <updated>2019-04-15T11:23:47.799Z</updated>
  <id>https://jiemin.wang/</id>
  
  <author>
    <name>Wang Jiemin</name>
    <email>278667010@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MongoDB å®ç° MySQL çš„ INSERT INTO SELECT</title>
    <link href="https://jiemin.wang/2019/04/15/mongodb-inset-into-select/"/>
    <id>https://jiemin.wang/2019/04/15/mongodb-inset-into-select/</id>
    <published>2019-04-15T09:08:35.000Z</published>
    <updated>2019-04-15T11:23:47.799Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>è¯´é‡‘é’±æ˜¯ç½ªæ¶ï¼Œéƒ½åœ¨æï¼›è¯´ç¾å¥³æ˜¯ç¥¸æ°´ï¼Œéƒ½æƒ³è¦ï¼›è¯´é«˜å¤„ä¸èƒœå¯’ï¼Œéƒ½åœ¨çˆ¬ï¼›è¯´çƒŸé…’ä¼¤èº«ä½“ï¼Œéƒ½ä¸æˆ’ï¼›è¯´å¤©å ‚æœ€ç¾å¥½ï¼Œéƒ½ä¸å»ï¼</strong></p></blockquote><h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p>å…¬å¸ä¸šåŠ¡æœ‰è¦å°†ä¸€ä¸ªé›†åˆéœ€è¦æ›´æ”¹åç§°ï¼Œéœ€è¦DBAåšé…åˆ</p><h2 id="æ“ä½œæµç¨‹"><a href="#æ“ä½œæµç¨‹" class="headerlink" title="æ“ä½œæµç¨‹"></a>æ“ä½œæµç¨‹</h2><ol><li>åœæ­¢å…¥åº“</li><li>ç¡®è®¤å·²ç»æŠŠåº“å…¥æ•°æ®å®¡å®Œ</li><li>é‡å‘½åcollections</li><li>åˆ›å»ºæ–°é›†åˆç´¢å¼•<br><code>db.antispam_resource.renameCollection("antispam_resource_20190415");</code><br><code>db.createCollection("antispam_resource");</code><br><code>db.antispam_resource.ensureIndex({createTs: 1, groupId: 1});</code><br><code>db.antispam_resource.ensureIndex({handleTs: 1, opUserId: 1});</code><br><code>db.antispam_resource.getIndexes();</code></li><li>æ–°æ•°æ®å…¥åº“</li><li>çœ‹å®¡æ ¸åå°æ˜¯å¦æœ‰æ–°æ•°æ®å…¥åº“å¹¶å®¡æ ¸</li><li>æŠŠæœ€è¿‘1ä¸ªæœˆæ•°æ®(antispam_resource_20190415)å¯¼å…¥åˆ°antispam_resource</li><li>å®Œæ¯•</li></ol><h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><p>æŸ¥çœ‹ä¸€ä¸‹åŸé›†åˆæ•°æ®é‡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_resource.find().count();</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿›è¡Œæ›´æ”¹åç§°æ“ä½œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_resource.renameCollection(<span class="string">"antispam_resource_20190415"</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿›è¡Œåˆ›å»ºç´¢å¼•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_resource.ensureIndex({createTs: 1, groupId: 1});</span><br><span class="line">db.antispam_resource.ensureIndex({handleTs: 1, opUserId: 1});</span><br><span class="line">db.antispam_resource.getIndexes();</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿›è¡Œæ“ä½œ MongoDB ç‰ˆæœ¬çš„ INSERT INTO SELECT<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹:</span><br><span class="line">db.antispam_resource.find().forEach(<span class="keyword">function</span>(doc){</span><br><span class="line"> <span class="built_in">print</span>(doc._id);</span><br><span class="line">    db.antispam_resource.insert(doc)}</span><br><span class="line">  );</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ“ä½œè¯¦ç»†æ­¥éª¤"><a href="#æ“ä½œè¯¦ç»†æ­¥éª¤" class="headerlink" title="æ“ä½œè¯¦ç»†æ­¥éª¤"></a>æ“ä½œè¯¦ç»†æ­¥éª¤</h2><p>æŸ¥çœ‹åŸé›†åˆå¤§äº4æœˆ1å·çš„æ•°æ®<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { <span class="variable">$gte</span>: NumberLong(1554048000) }}).count()</span><br><span class="line">2726271</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { <span class="variable">$lte</span>: NumberLong(1554048000) }}).count()</span><br><span class="line">22264682</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource.find().count()</span><br><span class="line">27824</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { <span class="variable">$gte</span>: NumberLong(1554048000) }}).count()</span><br><span class="line">27861</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { <span class="variable">$lte</span>: NumberLong(1554048000) }}).count()</span><br><span class="line">0</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { <span class="variable">$gte</span>: NumberLong(1554048000) }}).count()</span><br><span class="line">28074</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿›è¡Œæ“ä½œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mgset-11469021:PRIMARY> var docs = db.antispam_resource_20190415.find({createTs: { <span class="variable">$gte</span>: NumberLong(1554048000) }});</span><br><span class="line">mgset-11469021:PRIMARY> docs.forEach( <span class="keyword">function</span>(d){ db.antispam_resource.insert(d) });</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/04/15/mongodb-inset-into-select/inset_into_select.png" title="inset_into_select"><p>æ•°æ®åœ¨æ…¢æ…¢æ’å…¥åˆ°æ–°çš„é›†åˆä¸­</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { <span class="variable">$gte</span>:1554048000, <span class="variable">$lte</span>:1555311600}}).count()</span><br><span class="line">2726271</span><br><span class="line">mgset-11469021:PRIMARY> db.antispam_resource.find({createTs: { <span class="variable">$gte</span>:1554048000, <span class="variable">$lte</span>:1555311600}}).count()</span><br><span class="line">2726271</span><br></pre></td></tr></tbody></table></figure><p>ç»ˆäºå¯¼å®Œ</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>MySQL BINLOG Server</title>
    <link href="https://jiemin.wang/2019/04/03/mysql-binlog-server/"/>
    <id>https://jiemin.wang/2019/04/03/mysql-binlog-server/</id>
    <published>2019-04-03T08:02:33.000Z</published>
    <updated>2019-04-03T08:14:41.076Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>é›·é”‹åšäº†å¥½äº‹ä¸ç•™åï¼Œä½†æ˜¯æ¯ä¸€ä»¶äº‹æƒ…éƒ½è®°åˆ°æ—¥è®°é‡Œé¢ã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>MySQL Binlog Server: å®ƒä½¿ç”¨ <code>mysqlbinlog</code> å‘½ä»¤ä»¥ <code>daemon</code> è¿›ç¨‹çš„æ–¹å¼æ¨¡æ‹Ÿä¸€ä¸ª <code>slave</code> çš„ <code>IO</code> çº¿ç¨‹ä¸ä¸»åº“è¿æ¥ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å³æ—¶åŒæ­¥ä¸»åº“çš„ <code>binlog</code>ï¼Œä»¥ä¾¿å¼¥è¡¥å®šæ—¶å¤‡ä»½ç­–ç•¥ä¸­æœ€è¿‘ä¸€æ¬¡å¤‡ä»½åˆ°ä¸‹ä¸€æ¬¡å¤‡ä»½å®Œæˆä¹‹å‰è¿™æ®µæ—¶é—´å†…çš„æ•°æ®å®¹æ˜“ä¸¢å¤±çš„é—®é¢˜ã€‚</p><p>åšå¥½ MySQL æ—¥å¿—çš„å¤‡ä»½ï¼Œæ˜¯æ•°æ®å®‰å…¨çš„ä¸€ä¸ªé‡è¦ä¿è¯ã€‚ä»¥å‰é€šè¿‡å†™ç¨‹åºæ¥å®ç°ï¼Œä» MySQL 5.6 å‡ºç°ä»¥åï¼Œå¯ä»¥ä½¿ç”¨ <code>mysqlbinlog</code> å‘½ä»¤å®ç°ï¼Œä¸ç”¨å†™ç¨‹åºäº†ã€‚</p><h2 id="æƒé™"><a href="#æƒé™" class="headerlink" title="æƒé™"></a>æƒé™</h2><p>åˆ›å»ºå¤åˆ¶è´¦å·<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'repl'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql 5.7</span><br><span class="line">CREATE USER <span class="string">'repl'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'repl'</span>;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'%'</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ›å»ºBINLOG-SERVER"><a href="#åˆ›å»ºBINLOG-SERVER" class="headerlink" title="åˆ›å»ºBINLOG SERVER"></a>åˆ›å»ºBINLOG SERVER</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysqlbinlog -R --raw --host='192.168.199.230' --port=3306 --user='repl' --password='unixfbi' --stop-never --stop-never-slave-server-id=2313306 mysql-bin.000001 --result-file=/data/mysql/mysql3306/logs/ &</span></span><br></pre></td></tr></tbody></table></figure><p>å‘½ä»¤å‚æ•°ä»‹ç»ï¼š</p><ul><li><strong>-R â€“read-from-remote-server</strong> :è¡¨ç¤ºä»è¿œç¨‹æœºå™¨ä¸Šè¯»å– binlog,è¦ç¡®ä¿è¿œç¨‹ mysql å­˜å‚¨ï¼Œéœ€è¦æä¾›â€“host, â€“user, â€“password å‚æ•°; ä½¿ç”¨è¯¥é€‰é¡¹æ—¶ï¼Œmysqlbinlog ä¼šä¼ªè£…æˆä¸€ä¸ª slaveï¼Œè¿æ¥è¯»å–ï¼Œè¯·æ±‚æŒ‡å®šçš„ binlog fileï¼Œä¸»åº“è·å–æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä¹‹åå°±åˆ›å»ºä¸€ä¸ª binlog dump çº¿ç¨‹æ¨é€ binlog ç»™ mysqlbinlog serverã€‚</li><li><strong>â€“raw</strong>: ä»¥ binlog æ ¼å¼å­˜å‚¨æ—¥å¿—ï¼Œæ–¹ä¾¿åæœŸä½¿ç”¨;</li><li><strong>â€“host</strong>: è¿œç¨‹åº“çš„ä¸»æœº IP æˆ–è€…ä¸»æœºå;</li><li><strong>â€“port</strong>: è¿œç«¯åº“çš„ç«¯å£å·;</li><li><strong>â€“user</strong>: è¿œç¨‹åº“ä¸Šç”¨äºå¤åˆ¶çš„è´¦å·;</li><li><strong>â€“password</strong>: è¿œç«¯åº“ä¸Šå¤åˆ¶è´¦å·çš„å¯†ç ;</li><li><strong>â€“stop-never</strong>: ä¸€ç›´è¿æ¥åˆ°è¿œç¨‹çš„ server ä¸Šè¯»å– binlog æ—¥å¿—ï¼Œç›´æ¥åˆ°è¿œç¨‹çš„ server å…³é—­åæ‰ä¼šé€€å‡ºã€‚æˆ–æ˜¯è¢« pkill æ‰;</li><li><strong>â€“stop-never-slave-server-id</strong>: å¦‚æœéœ€è¦å¯åŠ¨å¤šä¸ª binlog server ï¼Œéœ€è¦ç»™ binlog server æŒ‡å®š server-id ã€‚å¦‚æœéœ€è¦å¯åŠ¨å¤šä¸ª binlog server,éœ€è¦ç»™ binlog server æŒ‡å®š server-id(é»˜è®¤æ˜¯ 65535)ï¼Œå¯ä»¥åˆ©ç”¨ â€“stop-never-slave-server-id å˜æ›´;</li><li><strong>mysql-bin.0000001</strong> è¿™ä¸ªæ—¥å¿—åè¡¨ç¤ºä»é‚£ä¸ªæ—¥å¿—å¼€å§‹è¯»å–;</li><li><strong>â€“result-file</strong>: æŒ‡å®šå­˜å‚¨åˆ°æœ¬åœ°çš„ç›®å½•ï¼Œæ³¨æ„åç¼€éœ€è¦åŠ ä¸Š/ï¼Œå¦åˆ™ mysqlbinlog å‘½ä»¤ä¼šè®¤ä¸ºæ˜¯ä¿å­˜æ–‡ä»¶çš„å‰ç¼€ã€‚è‹¥æŒ‡å®šäº†â€“raw å‚æ•°ï¼Œ-r çš„å€¼æŒ‡å®š binlog çš„å­˜æ”¾ç›®å½•å’Œæ–‡ä»¶åå‰ç¼€ï¼›è‹¥æ²¡æœ‰æŒ‡å®šâ€“raw å‚æ•°ï¼Œ-r çš„å€¼æŒ‡å®šæ–‡æœ¬å­˜æ”¾çš„ç›®å½•å’Œæ–‡ä»¶åã€‚</li></ul><blockquote><p>æ³¨æ„ï¼š<br>  ä½¿ç”¨â€“raw è¿æ¥ master æ—¶ï¼Œä»¥ 4k ä¸ºå•ä½å†™å…¥ç£ç›˜ã€‚å¹¶ä¸èƒ½å®æ—¶å†™å…¥ç£ç›˜ã€‚é‚£ä¹ˆä¸å¤Ÿ 4k æ—¶ï¼Œbinlog server ä»€ä¹ˆæ—¶å€™æ‰ä¼šæŠŠæ—¥å¿—å†™å…¥ç£ç›˜å‘¢ï¼Ÿ</p></blockquote><blockquote><p>æœ‰ä¸¤ç§æƒ…å†µï¼š</p></blockquote><blockquote><pre><code>ç¬¬ä¸€ï¼šbinlog server å’Œä¸»åº“æ–­å¼€æ—¶ï¼Œç¬¬äºŒï¼šmaster æ‰§è¡Œ flush logs éƒ½ä¼šå®æ—¶æŠŠæ—¥å¿—å†™å…¥ç£ç›˜ã€‚</code></pre><p>mysqlbinlog raw æœ‰ä¸€ä¸ª 4k çš„ Buffer ï¼Œå¤Ÿ 4k å°±å‘è½¦ã€‚</p></blockquote><h2 id="è®¾ç½®-mysqlbinlog-ä¸ºå®ˆæŠ¤è¿›ç¨‹"><a href="#è®¾ç½®-mysqlbinlog-ä¸ºå®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="è®¾ç½® mysqlbinlog ä¸ºå®ˆæŠ¤è¿›ç¨‹"></a>è®¾ç½® mysqlbinlog ä¸ºå®ˆæŠ¤è¿›ç¨‹</h2><p>å¦‚æœ master é‡å¯çš„è¯ï¼Œbinlog server ä¸Šçš„ mysqlbinlog è¿›ç¨‹å°±ä¼šé€€å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å†™ä¸ªè„šæœ¬æŠŠ mysqlbinlog è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">BACKUP_BIN=/usr/<span class="built_in">local</span>/mysql/bin/mysqlbinlog</span><br><span class="line">LOCAL_BACKUP_DIR=/data/mysql/mysql3306/logs/</span><br><span class="line">BACKUP_LOG=/tmp/backup.log</span><br><span class="line">REMOTE_HOST=192.168.199.230</span><br><span class="line">REMOTE_PORT=3306</span><br><span class="line">REMOTE_USER=repl</span><br><span class="line">REMOTE_PASS=unixfbi</span><br><span class="line">FIRST_BINLOG=mysql-bin.000001</span><br><span class="line">SLAVE_SERVER_ID=2313306</span><br><span class="line"><span class="comment"># wait for 10s</span></span><br><span class="line">SLEEP_SECONDS=10</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">${LOCAL_BACKUP_DIR}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> :</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ `ls -A <span class="string">"<span class="variable">${LOCAL_BACKUP_DIR}</span>"</span> |wc -l` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">     LAST_FILE=<span class="variable">${FIRST_BINLOG}</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">     LAST_FILE=`ls -l <span class="variable">${LOCAL_BACKUP_DIR}</span> |tail -n 1 |awk <span class="string">'{print $NF}'</span>`</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="variable">${BACKUP_BIN}</span> --raw -R --stop-never --host=<span class="variable">${REMOTE_HOST}</span> --port=<span class="variable">${REMOTE_PORT}</span> --user=<span class="variable">${REMOTE_USER}</span> --password=<span class="variable">${REMOTE_PASS}</span>  --stop-never --stop-never-slave-server-id=<span class="variable">${SLAVE_SERVER_ID}</span> <span class="variable">${LAST_FILE}</span> --result-file=<span class="variable">${LOCAL_BACKUP_DIR}</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y/%m/%d %H:%M:%S<span class="string">"` mysqlbinlog is stoped,return code: $?"</span> | tee -a <span class="variable">${BACKUP_LOG}</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">${SLEEP_SECONDS}</span>s will continue !"</span> | tee -a <span class="variable">${BACKUP_LOG}</span>  </span><br><span class="line">  sleep <span class="variable">${SLEEP_SECONDS}</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>æ‰§è¡Œè„šæœ¬<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nohup binlog_cp.sh &</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.unixfbi.com/291.html" target="_blank" rel="noopener">UnixFBI è¿ç»´ç‰¹å·¥</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL Innodbè¡¨ç©ºé—´ä¼ è¾“</title>
    <link href="https://jiemin.wang/2019/04/03/innodb-tablespace-copying/"/>
    <id>https://jiemin.wang/2019/04/03/innodb-tablespace-copying/</id>
    <published>2019-04-03T07:52:46.000Z</published>
    <updated>2019-04-03T08:01:04.077Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ä¸åƒé¥±å“ªæœ‰åŠ›æ°”å‡è‚¥å•Šã€‚</strong></p></blockquote><p>innodbè¡¨ç©ºé—´ä¼ è¾“ï¼Œæ˜¯MySQL5.6å¼€å§‹åŠ å…¥çš„æ–°ç‰¹æ€§ï¼Œæ”¯æŒæ™®é€šè¡¨ç©ºé—´æ‹·è´åˆ°å…¶ä»–å®ä¾‹ä¸‹ï¼ŒMySQL5.7æ”¯æŒåˆ†åŒºè¡¨çš„è¡¨ç©ºé—´ä¼ è¾“ï¼Œä½¿innodbè¡¨çš„æ‹·è´å˜å¾—æ›´åŠ ç®€å•å®¹æ˜“ã€‚</p><p>æ–¹ä¾¿æ˜¯æ–¹ä¾¿äº†ï¼Œä½†ä¹Ÿè¦éœ€è¦æ³¨æ„:</p><ul><li>innodbè¡¨ç©ºé—´ä¼ è¾“ä¸è¦ç”¨æ¥åšä¸»ä»å¤åˆ¶ï¼Œå¦åˆ™ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜;</li><li>ä½¿ç”¨ä¹‹å‰ï¼Œè¦ç¡®è®¤ä½¿ç”¨äº†innodb_file_per_tableå³ç‹¬ç«‹è¡¨ç©ºé—´;</li><li>åœ¨è¡¨ç©ºé—´å¯¼å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡ä¸èƒ½è¿›è¡Œå†™æ“ä½œ, åº”è¯¥æ³¨æ„é€‰æ‹©æ“ä½œæ—¶é—´, åº”è¯¥é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ“ä½œ;</li><li>é»˜è®¤ä¸æ”¯æŒå¯¼å‡ºæœ‰å¤–é”®çš„è¡¨, å¯ä»¥é€šè¿‡set foreign_key_checks=0å¼ºåˆ¶å¿½ç•¥, ä½†ä»…é™äºæ™®é€šè¡¨, è€Œåˆ†åŒºè¡¨æš‚æ—¶ä¸æ”¯æŒè¿™æ ·æ“ä½œã€‚</li></ul><p>æˆ‘ä»¬çŸ¥é“äº†innodbè¡¨ç©ºé—´ä¼ è¾“çš„ç‰¹ç‚¹å’Œä½¿ç”¨æ³¨æ„äº‹é¡¹, ç°åœ¨è€ƒè™‘ä¸€ä¸‹åº”ç”¨åœºæ™¯ã€‚å› ä¸ºä¸åšä¸»ä»å¤åˆ¶ï¼Œå°±åªèƒ½åšä¸€äº›ç¦»çº¿æ–¹é¢çš„ä½¿ç”¨ï¼Œæ¯”å¦‚æŠŠçº¿ä¸ŠæŸä¸ªç”Ÿäº§è¡¨æ‹¿åˆ°ç¦»çº¿ç¯å¢ƒåšç»Ÿè®¡åˆ†æç­‰ç­‰ã€‚</p><p>ä¸‹é¢ä»‹ç»innodbæ™®é€šè¡¨ç©ºé—´ä¼ è¾“å’Œåˆ†åŒºè¡¨ç©ºé—´ä¼ è¾“çš„æ“ä½œè¿‡ç¨‹<br>1.innodbæ™®é€šè¡¨ç©ºé—´ä¼ è¾“</p><p>1.1ç›®æ ‡åº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql> create table t2(id int auto_increment, name varchar(20), primary key(id));</span><br><span class="line">mysql> insert into t2(name) values(<span class="string">'aa'</span>),(<span class="string">'bb'</span>),(<span class="string">'cc'</span>);</span><br><span class="line">mysql> alter table t2 discard tablespace;</span><br></pre></td></tr></tbody></table></figure><p></p><p>1.2 æºåº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql> flush tables t2 <span class="keyword">for</span> <span class="built_in">export</span>;</span><br><span class="line"></span><br><span class="line">shell> scp -P2222 /data/mysql/mysql_3306/data/db1/t2.{cfg,ibd} 172.16.123.103:/data/mysql/mysql_3306/data/<span class="built_in">test</span>/</span><br><span class="line"></span><br><span class="line">mysql> unlock tables;</span><br></pre></td></tr></tbody></table></figure><p></p><p>1.3 ç›®æ ‡åº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell> chown mysql.mysql /data/mysql/mysql_3306/data/<span class="built_in">test</span>/t2.*</span><br><span class="line"></span><br><span class="line">mysql> alter table t2 import tablespace;</span><br></pre></td></tr></tbody></table></figure><p></p><p>2.innodbåˆ†åŒºè¡¨ç©ºé—´ä¼ è¾“<br>æµ‹è¯•åˆ†åŒºè¡¨ç»“æ„<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> create table t3(id int auto_increment, name varchar(20), primary key(id)) partition by key(id) partitions 4;</span><br></pre></td></tr></tbody></table></figure><p></p><p>2.1 ç›®æ ‡åº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> create table t3(id int auto_increment, name varchar(20), primary key(id)) partition by key(id) partitions 4;</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ’å…¥æµ‹è¯•æ•°æ®(çœç•¥)<br>2.2 æºåº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql> flush tables t3 <span class="keyword">for</span> <span class="built_in">export</span>; <span class="comment">#å¯¼å‡ºæ•´ä¸ªåˆ†åŒºè¡¨</span></span><br><span class="line"></span><br><span class="line">shell> cp -a /data/mysql/mysql_3306/data/db1/t3* /var/tmp/</span><br><span class="line"></span><br><span class="line">mysql> unlock tables;</span><br></pre></td></tr></tbody></table></figure><p></p><p>2.3 ç›®æ ‡åº“</p><p>2.3.1 å¯¼å…¥å…¨æ•°åˆ†åŒº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡åº“</span><br><span class="line">mysql> alter table t3 discard tablespace;</span><br><span class="line">æˆ–</span><br><span class="line">mysql> alter table t3 discard partition all tablespace;</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æºåº“</span><br><span class="line">shell> scp -P2222 -r t3* 172.16.123.103:/data/mysql/mysql_3306/data/<span class="built_in">test</span>/</span><br><span class="line">shell> chown mysql.mysql /data/mysql/mysql_3306/data/<span class="built_in">test</span>/ -R</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡åº“</span><br><span class="line">mysql> alter table t3 import tablespace;</span><br></pre></td></tr></tbody></table></figure><p>2.3.2 å¯¼å…¥æŒ‡å®šåˆ†åŒº<br>åªå¯¼p1åˆ†åŒº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡åº“</span><br><span class="line">mysql> alter table t3 discard partition p1 tablespace;</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æºåº“</span><br><span class="line">shell> scp -P2222 -r t3p1 172.16.123.103:/data/mysql/mysql_3306/data/<span class="built_in">test</span>/</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡åº“</span><br><span class="line">mysql> alter table t3 import partition p1 tablespace;</span><br></pre></td></tr></tbody></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æºåº“ä¸Š<br><code>flush tables tbname for export;</code>â€”><code>æ‹·è´æ–‡ä»¶</code>â€“><code>unlock tables;</code></p><p>ç›®æ ‡åº“ä¸Š<br><code>alter table tbname discard [partition partition_names | ALL] tablespace;</code>â€“><code>æ‹·è´æ–‡ä»¶è¿‡æ¥,æ”¹æƒé™</code>â€“><code>alter table tbname IMPORT [PARTITION partition_names | ALL] TABLESPACE;</code></p><p>å†æ¬¡æé†’</p><p>åš<code>flush tables xx discard tablespace</code>ä¹‹å‰ï¼Œ<strong><em>åŠ¡å¿…ä¸‰æ€</em></strong>, ä¸€å®šè¦ææ¸…æ¥šåœ¨å“ªä¸ªåº“æ“ä½œ, ä¸‡ä¸€åœ¨ç”Ÿäº§åº“ä¸Šæ“ä½œï¼Œè¿™å°±æ‚²å‰§äº†!</p><h2 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h2><p><a href="https://hzkeung.com/2017/06/07/innodb-tablespace-copying" target="_blank" rel="noopener">Huang Jinqiang</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ä»MySQLæºç å­¦ä¹ è¿ç»´Innodb bufferå‘½ä¸­ç‡è®¡ç®—</title>
    <link href="https://jiemin.wang/2019/04/03/mysql-innodb-buffer-pool-hit/"/>
    <id>https://jiemin.wang/2019/04/03/mysql-innodb-buffer-pool-hit/</id>
    <published>2019-04-03T07:34:53.000Z</published>
    <updated>2019-04-03T07:51:40.125Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>å¤©æ²¡é™å¤§ä»»äºæˆ‘ï¼Œç…§æ ·è‹¦æˆ‘å¿ƒæ™ºï¼ŒåŠ³æˆ‘ç­‹éª¨ã€‚</strong></p></blockquote><h2 id="è®¡ç®—å…¬å¼"><a href="#è®¡ç®—å…¬å¼" class="headerlink" title="è®¡ç®—å…¬å¼"></a>è®¡ç®—å…¬å¼</h2><p>æŒ‰å®˜æ–¹æ‰‹å†Œæ¨è<code>Innodb buffer Hit Ratios</code>çš„è®¡ç®—æ˜¯:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">100-((iReads / iReadRequests)*100)</span><br><span class="line">iReads : mysql->status->Innodb_buffer_pool_reads</span><br><span class="line">iReadRequests: mysql->status->Innodb_buffer_pool_read_requests</span><br></pre></td></tr></tbody></table></figure><p></p><p>mysqlsqlreportä¸­å…³äº<code>buffer</code>å‘½ä¸­è®¡ç®—æ˜¯:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ib_bp_hit=100-(Innodb_buffer_pool_reads/Innodb_buffer_pool_read_requests)*100</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦å¤–æˆ‘ä»¬çŸ¥é“æŸ¥çœ‹<code>Innodb Buffer Hit Ratios</code>çš„åœ°æ–¹æ˜¯:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show engine innodb status\G;</span><br><span class="line">Buffer pool hit rate : XXXX/1000;</span><br></pre></td></tr></tbody></table></figure><p></p><p>é‚£ä¸ªXXX/1000å³æ˜¯<code>buffer pool hit ratios</code>çš„å‘½ä¸­.</p><p><code>innodb buffer hit Ratios</code>çš„å‘½ä¸­è®¡ç®—éœ€è¦æœ¬æ¬¡å–çš„å€¼å’Œä¸Šæ¬¡å€¼åšä¸€ä¸ªå‡æ³•å…¬å¼åº”è¯¥ä¸º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ib_bp_hit=1000 â€“ (t2.iReads â€“ t1.iReads)/(t2.iReadRequest â€“ t1.iReadRequest)*1000</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>t(n): æ—¶é—´ç‚¹ ä¸¤ä¸ªæ—¶é—´é—´éš”æœ€å°‘æ˜¯30ç§’ä»¥ä¸Š,åœ¨å°æ„ä¹‰ä¸å¤§.</li><li>iReads: Innodb_buffer_pool_reads</li><li>iReadRequest: Innodb_buffer_pool_read_requests</li></ul><p>æ€è€ƒ:<br>å¯¹äºinnodb_buffer_pool_read_requests, innodb_buffer_pool_readsè¿™ç§ç´¯åŠ å€¼,å½“å¾ˆå¤§æ—¶è¿›è¡Œ: innodb_buffer_pool_reads/innodb_buffer_pool_read_requests ç›¸æ¥è®²åªèƒ½å¾—åˆ°ä»å¼€å§‹åˆ°ç°åœ¨çš„å‘½ä¸­ç‡çš„è¡¨ç°äº†. å¦‚æœæƒ³å¾—åˆ°ç°åœ¨è¿‘äº”åˆ†é’Ÿ,è¿‘ä¸€åˆ†é’Ÿæˆ–æ˜¯8ç‚¹åˆ°9ç‚¹æ¯åˆ†é’Ÿçš„å‘½ä¸­ç‡æƒ…å†µ,å¦‚æœè¿˜æ˜¯æŒ‰ç€innodb_buffer_pool_reads/innodb_buffer_pool_read_requests è¿›è¡Œè®¡ç®—,åªèƒ½å¾—åˆ°mysqldå¼€èµ·ç´¯è®¡åœ¨8ç‚¹-9ç‚¹çš„æ¯åˆ†é’Ÿçš„ç´¯è®¡å¹³å‡å‘½ä¸­æƒ…å†µ.</p><p>æ‰€ä»¥å¦‚æœæƒ³åˆ°æ¯(äº”)åˆ†é’Ÿçš„å‘½ä¸­æƒ…å†µ,å°±éœ€è¦æœ¬æ¬¡å–å¾—çš„å€¼å’Œä¸€(äº”)åˆ†é’Ÿå‰çš„å€¼è¿›è¡Œç›¸å‡,ç„¶åè¿›è¡Œè¿ç®—.è¿™æ ·æ‰èƒ½å¾—åˆ°ä¸€ä¸ªå½“ä¸‹çš„bpå‘½ä¸­æƒ…å†µ.</p><p>ä¸¤ç§æ–¹æ³•æ²¡å®è´¨çš„å¯¹é”™çš„é—®é¢˜,ä½†ç›¸å¯¹äºæºç ä¸­çš„é‚£ç§è®¡ç®—æ–¹å¼æ›´å®¹è®©å‘ç°æ•°æ®åº“çš„æŠ–åŠ¨é—®é¢˜.</p><p>èƒ½è§£å†³çš„é—®é¢˜:</p><p>å¶è€Œçš„æ•°æ®åº“æ€§èƒ½æŠ–åŠ¨èƒ½ç›´è§‚çš„ååº”å‡ºæ¥.</p><h2 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h2><p><a href="http://wubx.net/mysql_innodb_buffer_pool_hit/" target="_blank" rel="noopener">å´ ç‚³é”¡(æ•°æ®åº“æ¶æ„å¸ˆ):ä»MySQLæºç å­¦ä¹ è¿ç»´Innodb bufferå‘½ä¸­ç‡è®¡ç®—</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Linuxä¸­SHELLå†…ç½®getoptså‘½ä»¤è·å–å‘½ä»¤è¡Œå‚æ•°</title>
    <link href="https://jiemin.wang/2019/04/03/shell-getopts/"/>
    <id>https://jiemin.wang/2019/04/03/shell-getopts/</id>
    <published>2019-04-03T07:14:55.000Z</published>
    <updated>2019-04-03T07:33:23.920Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>åšäººå¦‚æœæ²¡æœ‰æ¢¦æƒ³ï¼Œé‚£å’Œå’¸é±¼æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å†™ç¨‹åºçš„æ—¶å€™ç»å¸¸è¦å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œæœ¬æ–‡æè¿°åœ¨Bashä¸‹çš„å‘½ä»¤è¡Œå¤„ç†æ–¹å¼ã€‚</p><p>é€‰é¡¹ä¸å‚æ•°:</p><p>å¦‚ä¸‹ä¸€ä¸ªå‘½ä»¤è¡Œ:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test.sh -f config.conf -v --prefix=/home</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬ç§°-fä¸ºé€‰é¡¹ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå³config.conf, -v ä¹Ÿæ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œä½†å®ƒä¸éœ€è¦å‚æ•°ã€‚</p><p>â€“prefixæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ªé•¿é€‰é¡¹ï¼Œå³é€‰é¡¹æœ¬èº«å¤šäºä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒä¹Ÿéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œç”¨ç­‰å·è¿æ¥ï¼Œå½“ç„¶ç­‰å·ä¸æ˜¯å¿…é¡»çš„ï¼Œ/homeå¯ä»¥ç›´æ¥å†™åœ¨â€“prefixåé¢ï¼Œå³â€“prefix/home,æ›´å¤šçš„é™åˆ¶åé¢å…·ä½“ä¼šè®²åˆ°ã€‚</p><p>åœ¨bashä¸­ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹ä¸‰ç§æ–¹å¼æ¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œæ¯ç§æ–¹å¼éƒ½æœ‰è‡ªå·±çš„åº”ç”¨åœºæ™¯ã€‚</p><ul><li>æ‰‹å·¥å¤„ç†æ–¹å¼</li><li>getopts</li><li>getopt</li></ul><p>ç”±äºshellå‘½ä»¤è¡Œçš„çµæ´»æ€§ï¼Œè‡ªå·±ç¼–å†™ä»£ç åˆ¤æ–­æ—¶ï¼Œå¤æ‚åº¦ä¼šæ¯”è¾ƒé«˜ã€‚ä½¿ç”¨å†…éƒ¨å‘½ä»¤ getopts å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚ä¸€èˆ¬æ ¼å¼ä¸ºï¼š</p><p><strong>è°ƒç”¨æ ¼å¼ï¼š</strong><br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getopts</span> options variable</span><br></pre></td></tr></tbody></table></figure><p></p><p>getopts çš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨å¾ªç¯ä¸­è¿è¡Œï¼Œæ¯æ¬¡æ‰§è¡Œå¾ªç¯ï¼Œgetopts å°±æ£€æŸ¥ä¸‹ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦åˆæ³•ã€‚å³æ£€æŸ¥å‚æ•°æ˜¯å¦ä»¥ - å¼€å¤´ï¼Œåé¢è·Ÿä¸€ä¸ªåŒ…å«åœ¨ options ä¸­çš„å­—æ¯ã€‚å¦‚æœæ˜¯ï¼Œå°±æŠŠåŒ¹é…çš„é€‰é¡¹å­—æ¯å­˜åœ¨æŒ‡å®šçš„å˜é‡ variable ä¸­ï¼Œå¹¶è¿”å›é€€å‡ºçŠ¶æ€0ï¼›å¦‚æœ - åé¢çš„å­—æ¯æ²¡æœ‰åŒ…å«åœ¨ options ä¸­ï¼Œå°±åœ¨ variable ä¸­å­˜å…¥ä¸€ä¸ª ï¼Ÿï¼Œå¹¶è¿”å›é€€å‡ºçŠ¶æ€0ï¼›å¦‚æœå‘½ä»¤è¡Œä¸­å·²ç»æ²¡æœ‰å‚æ•°ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªå‚æ•°ä¸ä»¥ - å¼€å¤´ï¼Œå°±è¿”å›ä¸ä¸º0çš„é€€å‡ºçŠ¶æ€ã€‚</p><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ul><li>option_string é€‰é¡¹åç§° </li><li>variable é€‰é¡¹çš„å€¼ </li></ul><blockquote><p>é€‰é¡¹ä¹‹é—´ä½¿ç”¨<strong>å†’å·:</strong>åˆ†éš”ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿æ¥ï¼Œ <strong>:</strong> è¡¨ç¤ºé€‰é¡¹åé¢æœ‰ä¼ å€¼ã€‚<br>  å½“getoptså‘½ä»¤å‘ç°å†’å·åï¼Œä¼šä»å‘½ä»¤è¡Œè¯¥é€‰é¡¹åè¯»å–è¯¥å€¼ã€‚å¦‚è¯¥å€¼å­˜åœ¨ï¼Œå°†ä¿å­˜åœ¨ç‰¹æ®Šçš„å˜é‡OPTARGä¸­ã€‚</p></blockquote><p>å½“option_stringç”¨<strong>:</strong>å¼€å¤´ï¼Œgetoptsä¼šåŒºåˆ†invalid optioné”™è¯¯å’Œmiss option argumenté”™è¯¯ã€‚</p><p>invalid optionæ—¶, varnameä¼šè¢«è®¾æˆ? </p><p>miss option argumentæ—¶ï¼Œvarnameä¼šè¢«è®¾æˆ:</p><p>å¦‚æœoption_stringä¸ç”¨:å¼€å¤´ï¼Œinvalid optioné”™è¯¯å’Œmiss option argumenté”™è¯¯éƒ½ä¼šä½¿varnameè¢«è®¾æˆ?ã€‚</p><p><strong>getoptsåŒ…å«ä¸¤ä¸ªå†…ç½®å˜é‡ï¼ŒOPTARGå’ŒOPTIND</strong></p><ul><li>OPTARG ä¿å­˜é€‰é¡¹åçš„å‚æ•°å€¼ </li><li>OPTIND è¡¨ç¤ºå‘½ä»¤è¡Œä¸‹ä¸€ä¸ªé€‰é¡¹æˆ–å‚æ•°çš„ç´¢å¼• </li></ul><h2 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><p>ä¾‹å­1: ä½¿ç”¨getoptså‘½ä»¤è·å–å‚æ•°<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> a:b:c:d opts; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opts</span> <span class="keyword">in</span></span><br><span class="line">        a) a=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        b) b=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        c) c=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        d) d=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        ?) ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"a=<span class="variable">$a</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"b=<span class="variable">$b</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"c=<span class="variable">$c</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"d=<span class="variable">$d</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ‰§è¡Œè¾“å‡º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./test.sh -a 1 -b 2 -c 3 -d 4</span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line">c=3</span><br><span class="line">d=</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>option_string a<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f171.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f171.png?v8">ğŸ…±</span>c:d </p></blockquote><blockquote><p>a,b,cåéƒ½æœ‰:</p></blockquote><blockquote><p>dåæ²¡æœ‰: </p></blockquote><blockquote><p>æ‰€ä»¥å¯ä»¥è·å–åˆ°a,b,cçš„å€¼ </p></blockquote><p>ä¾‹å­2: option_stringå‰åŠ :<br>ä¸Šä¾‹ä¸­ï¼Œå¦‚æœa,b,cä»»æ„ä¸€ä¸ªæ²¡æœ‰ä¼ å€¼ï¼Œå°†ä¼šæç¤ºå‡ºé”™ã€‚ä¾‹å¦‚ -c ä¸ä¼ å€¼ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./test.sh -a 1 -b 2 -c</span><br><span class="line">./test.sh: option requires an argument -- c</span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line">c=</span><br><span class="line">d=</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬åœ¨option_stringå‰åŠ ä¸Š:ï¼Œåˆ™å¯ä»¥å±è”½è¿™ä¸ªé”™è¯¯<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> :a:b:c:d opts; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opts</span> <span class="keyword">in</span></span><br><span class="line">        a) a=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        b) b=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        c) c=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        d) d=<span class="variable">$OPTARG</span> ;;</span><br><span class="line">        ?) ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"a=<span class="variable">$a</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"b=<span class="variable">$b</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"c=<span class="variable">$c</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"d=<span class="variable">$d</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ‰§è¡Œè¾“å‡º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./test.sh -a 1 -b 2 -c</span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line">c=</span><br><span class="line">d=</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>åœ¨option_stringå‰åŠ ä¸Š:ï¼Œå¯ä»¥å±è”½ç¼ºå¤±ä¼ å€¼çš„é”™è¯¯ï¼Œä½†å¦‚æœç¼ºå¤±çš„æ˜¯å‰é¢é€‰é¡¹çš„å€¼ï¼Œé‚£ä¹ˆè·å–åˆ°çš„å€¼å°†ä¼šé”™è¯¯ã€‚</strong></p><p>ä¾‹å¦‚ç¼ºå¤±açš„ä¼ å€¼ï¼Œå‘½ä»¤ä¼šæŠŠ-aåçš„-bä½œä¸ºäº†-açš„å€¼ï¼Œå¯¼è‡´é”™è¯¯ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./test.sh -a -b 2 -c 3</span><br><span class="line">a=-b</span><br><span class="line">b=</span><br><span class="line">c=</span><br><span class="line">d=</span><br></pre></td></tr></tbody></table></figure><p></p><p>å› æ­¤ä½¿ç”¨getoptså‘½ä»¤æ—¶ï¼Œå¯¹äºæ²¡æœ‰ä¼ å€¼çš„é€‰é¡¹ï¼Œé€‰é¡¹åç§°ä¹Ÿä¸è¦åŠ å…¥å‘½ä»¤è¡Œä¸­ã€‚<br>ä¾‹å¦‚aä¸ä¼ å€¼ï¼Œåˆ™-aä¸è¦åŠ å…¥å‘½ä»¤è¡Œã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./test.sh -b 2 -c 3</span><br><span class="line">a=</span><br><span class="line">b=2</span><br><span class="line">c=3</span><br><span class="line">d=</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="SHELL-ä»£ç "><a href="#SHELL-ä»£ç " class="headerlink" title="SHELL ä»£ç "></a>SHELL ä»£ç </h2><p>ä»¥ä¸Šæ˜¯ç¤ºä¾‹ï¼Œä¸‹é¢è´´ä¸Šæˆ‘å†™çš„è„šæœ¬ä»£ç ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: Created by jiemin.wang</span></span><br><span class="line"><span class="comment"># QQ: 278667010</span></span><br><span class="line"><span class="comment"># E-mail: 278661010@qq.com or wangjiemin880228@gmail.com</span></span><br><span class="line"><span class="comment"># Created Time: Wed Apr  3 14:15:12 CST 2019</span></span><br><span class="line"><span class="comment"># function: This is tcpdump grabs SQL executed by MySQL</span></span><br><span class="line"><span class="comment"># version: 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>(){</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage:"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">" <span class="variable">$(basename $0)</span> [OPTION]:"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"-n net"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"-P port"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq <span class="string">"0"</span> ];<span class="keyword">then</span></span><br><span class="line">usage</span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> :n:P: arg</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$arg</span> <span class="keyword">in</span></span><br><span class="line">n)</span><br><span class="line">net=<span class="variable">$OPTARG</span></span><br><span class="line">;;</span><br><span class="line">P)</span><br><span class="line">port=<span class="variable">$OPTARG</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tcpdump -i "$net" -s 0 -l -w - dst port "$port" | strings | perl -e '</span></span><br><span class="line">tcpdump -i <span class="string">"<span class="variable">$net</span>"</span> -s 0 -l -w file dst port <span class="string">"<span class="variable">$port</span>"</span> | strings | perl -e <span class="string">'</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">while(<>) { chomp; next if /^[^ ]+[ ]*$/;</span></span><br><span class="line"><span class="string">if(/^(SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL)/i) {</span></span><br><span class="line"><span class="string">if (defined $q) { print "$q\n"; }</span></span><br><span class="line"><span class="string">$q=$_;</span></span><br><span class="line"><span class="string">} else {</span></span><br><span class="line"><span class="string">$_ =~ s/^[ \t]+//; $q.=" $_";</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="å…¶ä»–ç¤ºä¾‹"><a href="#å…¶ä»–ç¤ºä¾‹" class="headerlink" title="å…¶ä»–ç¤ºä¾‹"></a>å…¶ä»–ç¤ºä¾‹</h2><p>åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªç¤ºä¾‹,è´´ä¸Šæ¥,ä»…ä¾›å‚è€ƒ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">QUIET=</span><br><span class="line">VERBOSE=</span><br><span class="line">DEVICE=</span><br><span class="line">LOGFILE=/tmp/default</span><br><span class="line"></span><br><span class="line">usage()</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Usage: `basename <span class="variable">$0</span>` [-qv] [-l LOGFILE] -d DEVICE input_file [input_file2...]"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">[ <span class="variable">$#</span> -eq 0 ] && usage</span><br><span class="line"></span><br><span class="line"><span class="comment">#option_stringä»¥å†’å·å¼€å¤´è¡¨ç¤ºå±è”½è„šæœ¬çš„ç³»ç»Ÿæç¤ºé”™è¯¯ï¼Œè‡ªå·±å¤„ç†é”™è¯¯æç¤ºã€‚</span></span><br><span class="line"><span class="comment">#åé¢æ¥åˆæ³•çš„å•å­—æ¯é€‰é¡¹ï¼Œé€‰é¡¹åè‹¥æœ‰å†’å·ï¼Œåˆ™è¡¨ç¤ºè¯¥é€‰é¡¹å¿…é¡»æ¥å…·ä½“çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> :qvd:l: OPTION</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$OPTION</span> <span class="keyword">in</span></span><br><span class="line">        q)</span><br><span class="line">            QUIET=y</span><br><span class="line">            ;;</span><br><span class="line">        v)</span><br><span class="line">            VERBOSE=y</span><br><span class="line">            ;;</span><br><span class="line">        d)</span><br><span class="line">            DEVICE=<span class="variable">$OPTARG</span>        <span class="comment">#$OPTARGä¸ºç‰¹æ®Šå˜é‡ï¼Œè¡¨ç¤ºé€‰é¡¹çš„å…·ä½“å‚æ•°</span></span><br><span class="line">            ;;</span><br><span class="line">        l)</span><br><span class="line">            LOGFILE=<span class="variable">$OPTARG</span></span><br><span class="line">            ;;</span><br><span class="line">        \?)                       <span class="comment">#å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™è§£æä¸º?</span></span><br><span class="line">            usage</span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#$OPTINDä¸ºç‰¹æ®Šå˜é‡ï¼Œè¡¨ç¤ºç¬¬å‡ ä¸ªé€‰é¡¹ï¼Œåˆå§‹å€¼ä¸º1</span></span><br><span class="line"><span class="built_in">shift</span> $((<span class="variable">$OPTIND</span> - 1))      <span class="comment">#é™¤äº†é€‰é¡¹ä¹‹å¤–ï¼Œè¯¥è„šæœ¬å¿…é¡»æ¥è‡³å°‘ä¸€ä¸ªå‚æ•°</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    usage</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DEVICE</span>"</span> ]; <span class="keyword">then</span>   <span class="comment">#è¯¥è„šæœ¬å¿…é¡»æä¾›-dé€‰é¡¹</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"You must specify DEVICE with -d option"</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"you chose the following options.."</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Quiet=<span class="variable">$QUIET</span> VERBOSE=<span class="variable">$VERBOSE</span> DEVICE=<span class="variable">$DEVICE</span> LOGFILE=<span class="variable">$LOGFILE</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$@</span>          <span class="comment">#ä¾æ¬¡å¤„ç†å‰©ä½™çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Processing <span class="variable">$file</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>linux æŠ€å·§ï¼šä½¿ç”¨ screen ç®¡ç†ä½ çš„è¿œç¨‹ä¼šè¯</title>
    <link href="https://jiemin.wang/2019/04/02/linux-screen/"/>
    <id>https://jiemin.wang/2019/04/02/linux-screen/</id>
    <published>2019-04-02T10:33:06.000Z</published>
    <updated>2019-04-02T11:04:10.233Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æœ‰æœ¬äº‹ï¼Œä½ æ¥é¡ºç€ç½‘çº¿çˆ¬è¿‡æ¥ï¼Œä½ æ¥å’¬æˆ‘å‘€</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä½ æ˜¯ä¸æ˜¯ç»å¸¸éœ€è¦ SSH æˆ–è€… telent è¿œç¨‹ç™»å½•åˆ° Linux æœåŠ¡å™¨ï¼Ÿä½ æ˜¯ä¸æ˜¯ç»å¸¸ä¸ºä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è€Œå¤´ç–¼ï¼Œæ¯”å¦‚ç³»ç»Ÿå¤‡ä»½ã€ftp ä¼ è¾“ç­‰ç­‰ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä¸ºæ¯ä¸€ä¸ªè¿™æ ·çš„ä»»åŠ¡å¼€ä¸€ä¸ªè¿œç¨‹ç»ˆç«¯çª—å£ï¼Œå› ä¸ºä»–ä»¬æ‰§è¡Œçš„æ—¶é—´å¤ªé•¿äº†ã€‚å¿…é¡»ç­‰å¾…å®ƒæ‰§è¡Œå®Œæ¯•ï¼Œåœ¨æ­¤æœŸé—´å¯ä¸èƒ½å…³æ‰çª—å£æˆ–è€…æ–­å¼€è¿æ¥ï¼Œå¦åˆ™è¿™ä¸ªä»»åŠ¡å°±ä¼šè¢«æ€æ‰ï¼Œä¸€åˆ‡åŠé€”è€ŒåºŸäº†ã€‚</p><h4 id="å…ƒå‡¶ï¼šSIGHUP-ä¿¡å·"><a href="#å…ƒå‡¶ï¼šSIGHUP-ä¿¡å·" class="headerlink" title="å…ƒå‡¶ï¼šSIGHUP ä¿¡å·"></a>å…ƒå‡¶ï¼šSIGHUP ä¿¡å·</h4><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆå…³æ‰çª—å£/æ–­å¼€è¿æ¥ä¼šä½¿å¾—æ­£åœ¨è¿è¡Œçš„ç¨‹åºæ­»æ‰ã€‚</p><p>åœ¨Linux/Unixä¸­ï¼Œæœ‰è¿™æ ·å‡ ä¸ªæ¦‚å¿µ:</p><ul><li>è¿›ç¨‹ç»„ï¼ˆprocess groupï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹çš„é›†åˆï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ç»„æœ‰å”¯ä¸€ä¸€ä¸ªè¿›ç¨‹ç»„IDï¼Œå³è¿›ç¨‹ç»„é•¿è¿›ç¨‹çš„IDã€‚</li><li>ä¼šè¯æœŸï¼ˆsessionï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ç»„çš„é›†åˆï¼Œæœ‰å”¯ä¸€ä¸€ä¸ªä¼šè¯æœŸé¦–è¿›ç¨‹ï¼ˆsession leaderï¼‰ã€‚ä¼šè¯æœŸIDä¸ºé¦–è¿›ç¨‹çš„IDã€‚</li><li>ä¼šè¯æœŸå¯ä»¥æœ‰ä¸€ä¸ªå•ç‹¬çš„æ§åˆ¶ç»ˆç«¯ï¼ˆcontrolling terminalï¼‰ã€‚ä¸æ§åˆ¶ç»ˆç«¯è¿æ¥çš„ä¼šè¯æœŸé¦–è¿›ç¨‹å«åšæ§åˆ¶è¿›ç¨‹ï¼ˆcontrolling processï¼‰ã€‚å½“å‰ä¸ç»ˆç«¯äº¤äº’çš„è¿›ç¨‹ç§°ä¸ºå‰å°è¿›ç¨‹ç»„ã€‚å…¶ä½™è¿›ç¨‹ç»„ç§°ä¸ºåå°è¿›ç¨‹ç»„ã€‚</li></ul><p>æ ¹æ®POSIX.1å®šä¹‰:</p><ul><li>æŒ‚æ–­ä¿¡å·ï¼ˆSIGHUPï¼‰é»˜è®¤çš„åŠ¨ä½œæ˜¯ç»ˆæ­¢ç¨‹åºã€‚</li><li>å½“ç»ˆç«¯æ¥å£æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥æ–­å¼€ï¼Œå°†æŒ‚æ–­ä¿¡å·å‘é€ç»™æ§åˆ¶è¿›ç¨‹ï¼ˆä¼šè¯æœŸé¦–è¿›ç¨‹ï¼‰ã€‚</li><li>å¦‚æœä¼šè¯æœŸé¦–è¿›ç¨‹ç»ˆæ­¢ï¼Œåˆ™è¯¥ä¿¡å·å‘é€åˆ°è¯¥ä¼šè¯æœŸå‰å°è¿›ç¨‹ç»„ã€‚</li><li>ä¸€ä¸ªè¿›ç¨‹é€€å‡ºå¯¼è‡´ä¸€ä¸ªå­¤å„¿è¿›ç¨‹ç»„ä¸­äº§ç”Ÿæ—¶ï¼Œå¦‚æœä»»æ„ä¸€ä¸ªå­¤å„¿è¿›ç¨‹ç»„è¿›ç¨‹å¤„äºSTOPçŠ¶æ€ï¼Œå‘é€SIGHUPå’ŒSIGCONTä¿¡å·åˆ°è¯¥è¿›ç¨‹ç»„ä¸­æ‰€æœ‰è¿›ç¨‹ã€‚</li></ul><p>å› æ­¤å½“ç½‘ç»œæ–­å¼€æˆ–ç»ˆç«¯çª—å£å…³é—­åï¼Œæ§åˆ¶è¿›ç¨‹æ”¶åˆ°SIGHUPä¿¡å·é€€å‡ºï¼Œä¼šå¯¼è‡´è¯¥ä¼šè¯æœŸå†…å…¶ä»–è¿›ç¨‹é€€å‡ºã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚æ‰“å¼€ä¸¤ä¸ªSSHç»ˆç«¯çª—å£ï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªè¿è¡Œtopå‘½ä»¤ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># top</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæ‰¾åˆ°topçš„è¿›ç¨‹IDä¸º15371ï¼Œå…¶çˆ¶è¿›ç¨‹IDä¸º10034ï¼Œå³ç™»å½•shellã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># ps -ef|grep top</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root         5     2  0 Apr01 ?        00:00:00 [stopper/0]</span><br><span class="line">root         8     2  0 Apr01 ?        00:00:00 [stopper/1]</span><br><span class="line">root     15371 10034  0 18:37 pts/1    00:00:00 top</span><br><span class="line">root     15380 15352  0 18:37 pts/2    00:00:00 grep --colour=auto top</span><br><span class="line">test_dbs2 ~ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨pstreeå‘½ä»¤å¯ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸ªå…³ç³»ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># pstree -H 15371|grep top    </span></span><br><span class="line">     |      |-sshd---sshd---bash---sudo---bash---sudo---bash---top</span><br><span class="line">test_dbs2 ~ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨ps-xjå‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œç™»å½•shellï¼ˆPID 15371ï¼‰å’Œtopåœ¨åŒä¸€ä¸ªä¼šè¯æœŸï¼Œshellä¸ºä¼šè¯æœŸé¦–è¿›ç¨‹ï¼Œæ‰€åœ¨è¿›ç¨‹ç»„PGIDä¸º15371ï¼Œtopæ‰€åœ¨è¿›ç¨‹ç»„PGIDä¸º9410ï¼Œä¸ºå‰å°è¿›ç¨‹ç»„ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># ps -xj|grep 15371</span></span><br><span class="line">Warning: bad syntax, perhaps a bogus <span class="string">'-'</span>? See /usr/share/doc/procps-3.2.8/FAQ</span><br><span class="line"> 9410 10020 10020  9410 pts/1    15371 S        0   0:00 sudo bash</span><br><span class="line">10020 10021 10021  9410 pts/1    15371 S        0   0:00 bash</span><br><span class="line">10021 10033 10033  9410 pts/1    15371 S        0   0:00 sudo bash</span><br><span class="line">10033 10034 10034  9410 pts/1    15371 S        0   0:00 bash</span><br><span class="line">10034 15371 15371  9410 pts/1    15371 S+       0   0:00 top</span><br><span class="line">15352 15485 15484 15327 pts/2    15484 R+       0   0:00 grep --colour=auto 15371</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…³é—­ç¬¬ä¸€ä¸ªSSHçª—å£ï¼Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯ä»¥çœ‹åˆ°topä¹Ÿè¢«æ€æ‰äº†ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># ps -ef|grep 15371</span></span><br><span class="line">root     15511 15352  0 18:42 pts/2    00:00:00 grep --colour=auto 15371</span><br><span class="line">test_dbs2 ~ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥å¿½ç•¥SIGHUPä¿¡å·ï¼Œå…³æ‰çª—å£åº”è¯¥å°±ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œäº†ã€‚nohupå‘½ä»¤å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå¦‚æœç¨‹åºçš„æ ‡å‡†è¾“å‡º/æ ‡å‡†é”™è¯¯æ˜¯ç»ˆç«¯ï¼Œnohupé»˜è®¤å°†å…¶é‡å®šå‘åˆ°nohup.outæ–‡ä»¶ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯nohupå‘½ä»¤åªæ˜¯ä½¿å¾—ç¨‹åºå¿½ç•¥SIGHUPä¿¡å·ï¼Œè¿˜éœ€è¦ä½¿ç”¨æ ‡è®°&æŠŠå®ƒæ”¾åœ¨åå°è¿è¡Œã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <<span class="built_in">command</span>> [argumentâ€¦] &</span><br></pre></td></tr></tbody></table></figure><p></p><p>è™½ç„¶nohupå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æ¯”è¾ƒâ€œç®€é™‹â€çš„ï¼Œå¯¹äºç®€å•çš„å‘½ä»¤èƒ½å¤Ÿåº”ä»˜è¿‡æ¥ï¼Œå¯¹äºå¤æ‚çš„éœ€è¦äººæœºäº¤äº’çš„ä»»åŠ¡å°±éº»çƒ¦äº†ã€‚</p><p>å…¶å®æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ›´ä¸ºå¼ºå¤§çš„å®ç”¨ç¨‹åºscreenã€‚æµè¡Œçš„Linuxå‘è¡Œç‰ˆï¼ˆä¾‹å¦‚Red Hat Enterprise Linux ï¼‰</p><p>é€šå¸¸ä¼šè‡ªå¸¦screenå®ç”¨ç¨‹åºï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥ä»<a href="https://www.gnu.org/software/screen/" target="_blank" rel="noopener">GNU screençš„å®˜æ–¹ç½‘ç«™</a>ä¸‹è½½ã€‚</p><h2 id="å¼€å§‹ä½¿ç”¨Screen"><a href="#å¼€å§‹ä½¿ç”¨Screen" class="headerlink" title="å¼€å§‹ä½¿ç”¨Screen"></a>å¼€å§‹ä½¿ç”¨Screen</h2><p>ç®€å•æ¥è¯´ï¼ŒScreenæ˜¯ä¸€ä¸ªå¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å¤šè·¯å¤ç”¨ä¸€ä¸ªç‰©ç†ç»ˆç«¯çš„çª—å£ç®¡ç†å™¨ã€‚Screenä¸­æœ‰ä¼šè¯çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸€ä¸ªscreenä¼šè¯ä¸­åˆ›å»ºå¤šä¸ªscreençª—å£ï¼Œåœ¨æ¯ä¸€ä¸ªscreençª—å£ä¸­å°±åƒæ“ä½œä¸€ä¸ªçœŸå®çš„telnet/SSHè¿æ¥çª—å£é‚£æ ·ã€‚åœ¨screenä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£æœ‰è¿™æ ·å‡ ç§æ–¹å¼ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># yum install -y screen</span></span><br><span class="line">test_dbs2 ~ <span class="comment"># </span></span><br><span class="line">test_dbs2 ~ <span class="comment"># screen --help</span></span><br><span class="line">Use: screen [-opts] [cmd [args]]</span><br><span class="line"> or: screen -r [host.tty]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">-4            Use IPv4.</span><br><span class="line">-6            Use IPv6.</span><br><span class="line">-a            Force all capabilities into each window<span class="string">'s termcap.</span></span><br><span class="line"><span class="string">-A -[r|R]     Adapt all windows to the new display width & height.</span></span><br><span class="line"><span class="string">-c file       Read configuration file instead of '</span>.screenrc<span class="string">'.</span></span><br><span class="line"><span class="string">-d (-r)       Detach the elsewhere running screen (and reattach here).</span></span><br><span class="line"><span class="string">-dmS name     Start as daemon: Screen session in detached mode.</span></span><br><span class="line"><span class="string">-D (-r)       Detach and logout remote (and reattach here).</span></span><br><span class="line"><span class="string">-D -RR        Do whatever is needed to get a screen session.</span></span><br><span class="line"><span class="string">-e xy         Change command characters.</span></span><br><span class="line"><span class="string">-f            Flow control on, -fn = off, -fa = auto.</span></span><br><span class="line"><span class="string">-h lines      Set the size of the scrollback history buffer.</span></span><br><span class="line"><span class="string">-i            Interrupt output sooner when flow control is on.</span></span><br><span class="line"><span class="string">-l            Login mode on (update /var/run/utmp), -ln = off.</span></span><br><span class="line"><span class="string">-list         or -ls. Do nothing, just list our SockDir.</span></span><br><span class="line"><span class="string">-L            Turn on output logging.</span></span><br><span class="line"><span class="string">-m            ignore $STY variable, do create a new screen session.</span></span><br><span class="line"><span class="string">-O            Choose optimal output rather than exact vt100 emulation.</span></span><br><span class="line"><span class="string">-p window     Preselect the named window if it exists.</span></span><br><span class="line"><span class="string">-q            Quiet startup. Exits with non-zero return code if unsuccessful.</span></span><br><span class="line"><span class="string">-r            Reattach to a detached screen process.</span></span><br><span class="line"><span class="string">-R            Reattach if possible, otherwise start a new session.</span></span><br><span class="line"><span class="string">-s shell      Shell to execute rather than $SHELL.</span></span><br><span class="line"><span class="string">-S sockname   Name this session <pid>.sockname instead of <pid>.<tty>.<host>.</span></span><br><span class="line"><span class="string">-t title      Set title. (window'</span>s name).</span><br><span class="line">-T term       Use term as <span class="variable">$TERM</span> <span class="keyword">for</span> windows, rather than <span class="string">"screen"</span>.</span><br><span class="line">-U            Tell screen to use UTF-8 encoding.</span><br><span class="line">-v            Print <span class="string">"Screen version 4.00.03 (FAU) 23-Oct-06"</span>.</span><br><span class="line">-wipe         Do nothing, just clean up SockDir.</span><br><span class="line">-x            Attach to a not detached screen. (Multi display mode).</span><br><span class="line">-X            Execute <cmd> as a screen <span class="built_in">command</span> <span class="keyword">in</span> the specified session.</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="ç›´æ¥åœ¨å‘½ä»¤è¡Œé”®å…¥screenå‘½ä»¤"><a href="#ç›´æ¥åœ¨å‘½ä»¤è¡Œé”®å…¥screenå‘½ä»¤" class="headerlink" title="ç›´æ¥åœ¨å‘½ä»¤è¡Œé”®å…¥screenå‘½ä»¤"></a>ç›´æ¥åœ¨å‘½ä»¤è¡Œé”®å…¥screenå‘½ä»¤</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># screen</span></span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…æ·»åŠ ä¸€ä¸ªåç§°ä¸ºmysqldump<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># screen -S mysqldump</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¹‹åæˆ‘ä»¬æƒ³æš‚æ—¶é€€å‡ºåšç‚¹åˆ«çš„äº‹æƒ…ï¼Œæ¯”å¦‚å‡ºå»æ•£æ•£æ­¥ï¼Œé‚£ä¹ˆåœ¨screençª—å£é”®å…¥C-a dï¼ŒScreenä¼šç»™å‡ºdetachedæç¤ºï¼š</p><p>æš‚æ—¶ä¸­æ–­ä¼šè¯</p><p>åŠä¸ªå°æ—¶ä¹‹åå›æ¥äº†ï¼Œæ‰¾åˆ°è¯¥screenä¼šè¯ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># screen -ls</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>é‡æ–°è¿æ¥ä¼šè¯ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># screen -r -S mysqldump</span></span><br><span class="line"><span class="comment">#æˆ–è€…</span></span><br><span class="line">test_dbs2 ~ <span class="comment"># screen -r 16582</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>çœ‹çœ‹å‡ºç°ä»€ä¹ˆäº†ï¼Œå¤ªæ£’äº†ï¼Œä¸€åˆ‡éƒ½åœ¨ã€‚ç»§ç»­å¹²å§ã€‚</p><p>ä½ å¯èƒ½æ³¨æ„åˆ°ç»™screenå‘é€å‘½ä»¤ä½¿ç”¨äº†ç‰¹æ®Šçš„é”®ç»„åˆC-aã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šé”®å…¥çš„ä¿¡æ¯æ˜¯ç›´æ¥å‘é€ç»™å½“å‰screençª—å£ï¼Œå¿…é¡»ç”¨å…¶ä»–æ–¹å¼å‘screençª—å£ç®¡ç†å™¨å‘å‡ºå‘½ä»¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œscreenæ¥æ”¶ä»¥C-aå¼€å§‹çš„å‘½ä»¤ã€‚è¿™ç§å‘½ä»¤å½¢å¼åœ¨screenä¸­å«åšé”®ç»‘å®šï¼ˆkey bindingï¼‰ï¼ŒC-aå«åšå‘½ä»¤å­—ç¬¦ï¼ˆcommand characterï¼‰ã€‚</p><p>å¯ä»¥é€šè¿‡C-a ?æ¥æŸ¥çœ‹æ‰€æœ‰çš„é”®ç»‘å®šï¼Œå¸¸ç”¨çš„é”®ç»‘å®šæœ‰ï¼š</p><table><thead><tr><th style="text-align:center">C-a ?</th><th style="text-align:center">æ˜¾ç¤ºæ‰€æœ‰é”®ç»‘å®šä¿¡æ¯</th></tr></thead><tbody><tr><td style="text-align:center">C-a w</td><td style="text-align:center">æ˜¾ç¤ºæ‰€æœ‰çª—å£åˆ—è¡¨</td></tr><tr><td style="text-align:center">C-a C-a</td><td style="text-align:center">åˆ‡æ¢åˆ°ä¹‹å‰æ˜¾ç¤ºçš„çª—å£</td></tr><tr><td style="text-align:center">C-a c</td><td style="text-align:center">åˆ›å»ºä¸€ä¸ªæ–°çš„è¿è¡Œshellçš„çª—å£å¹¶åˆ‡æ¢åˆ°è¯¥çª—å£</td></tr><tr><td style="text-align:center">C-a n</td><td style="text-align:center">åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçª—å£</td></tr><tr><td style="text-align:center">C-a p</td><td style="text-align:center">åˆ‡æ¢åˆ°å‰ä¸€ä¸ªçª—å£(ä¸C-a nç›¸å¯¹)</td></tr><tr><td style="text-align:center">C-a 0..9</td><td style="text-align:center">åˆ‡æ¢åˆ°çª—å£0..9</td></tr><tr><td style="text-align:center">C-a a</td><td style="text-align:center">å‘é€ C-aåˆ°å½“å‰çª—å£</td></tr><tr><td style="text-align:center">C-a d</td><td style="text-align:center">æš‚æ—¶æ–­å¼€screenä¼šè¯</td></tr><tr><td style="text-align:center">C-a k</td><td style="text-align:center">æ€æ‰å½“å‰çª—å£</td></tr><tr><td style="text-align:center">C-a [</td><td style="text-align:center">è¿›å…¥æ‹·è´/å›æ»šæ¨¡å¼</td></tr></tbody></table><p>ä½¿ç”¨é”®ç»‘å®šC-a ?å‘½ä»¤å¯ä»¥çœ‹åˆ°, é»˜è®¤çš„å‘½ä»¤å­—ç¬¦ï¼ˆCommand keyï¼‰ä¸ºC-aï¼Œè½¬ä¹‰C-aï¼ˆliteral ^aï¼‰çš„å­—ç¬¦ä¸ºaï¼š</p><p>å¦‚æœç”±äºæŸç§åŸå› å…¶ä¸­ä¸€ä¸ªä¼šè¯æ­»æ‰äº†ï¼ˆä¾‹å¦‚äººä¸ºæ€æ‰è¯¥ä¼šè¯ï¼‰ï¼Œè¿™æ—¶screen -listä¼šæ˜¾ç¤ºè¯¥ä¼šè¯ä¸ºdeadçŠ¶æ€ã€‚ä½¿ç”¨screen -wipeå‘½ä»¤æ¸…é™¤è¯¥ä¼šè¯ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># kill -9 8462</span></span><br><span class="line">test_dbs2 ~ <span class="comment"># screen -wipe</span></span><br><span class="line">test_dbs2 ~ <span class="comment"># screen -ls</span></span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>MySQL ä¼˜åŒ–åŸç†(ä¸‰)</title>
    <link href="https://jiemin.wang/2019/03/29/mysql-optimization-principle-3/"/>
    <id>https://jiemin.wang/2019/03/29/mysql-optimization-principle-3/</id>
    <published>2019-03-29T06:57:29.000Z</published>
    <updated>2019-03-29T08:33:32.356Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æˆ´ä¸Šå®ƒã€‚éƒ½å‡ åå²çš„äººäº†ï¼Œä½ çœ‹ä½ å¤šè´±ï¼Œä½ æ²¡å°Šä¸¥å•Šï¼Ÿæˆ‘ä¸æƒ³çœ‹è§ä½ ï¼Œå¿«ç‚¹æˆ´ä¸Šï¼Œç„¶åå»çœ‹åŒ»ç”Ÿã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>èŠèŠ MySQL é…ç½®ã€‚</p><p>å¤§å¤šæ•°å¼€å‘è€…å¯èƒ½ä¸å¤ªä¼šå…³æ³¨ MySQL çš„é…ç½®ï¼Œæ¯•ç«Ÿåœ¨åŸºæœ¬é…ç½®æ²¡æœ‰é—®é¢˜çš„æƒ…å†µä¸‹ï¼ŒæŠŠæ›´å¤šçš„ç²¾åŠ›æ”¾åœ¨ schema è®¾è®¡ã€ç´¢å¼•ä¼˜åŒ–å’Œ SQL ä¼˜åŒ–ä¸Šï¼Œæ˜¯éå¸¸åŠ¡å®çš„ç­–ç•¥ã€‚è¿™æ—¶ï¼Œå¦‚æœå†èŠ±åŠ›æ°”å»ä¼˜åŒ–é…ç½®é¡¹ï¼Œè·å¾—çš„æ”¶ç›Šé€šå¸¸éƒ½æ¯”è¾ƒå°ã€‚æ›´å¤šçš„æ—¶å€™ï¼ŒåŸºäºå®‰å…¨å› ç´ çš„è€ƒé‡ï¼Œæ™®é€šå¼€å‘è€…å¾ˆå°‘èƒ½å¤Ÿæ¥è§¦åˆ°ç”Ÿäº§ç¯å¢ƒçš„ MySQL é…ç½®ã€‚æ­£æ˜¯è¿™æ ·ï¼Œå¯¼è‡´å¼€å‘è€…ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰å¯¹ MySQL çš„é…ç½®ä¸ç”šäº†è§£ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¸®ä½ æ›´å¥½çš„äº†è§£ MySQL é…ç½®ã€‚</p><p>å¦‚æœè®©ä½ åœ¨æŸç§ç¯å¢ƒä¸Šå®‰è£…é…ç½® MySQLï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿå®‰è£…åï¼Œç›´æ¥ copy ä¿®æ”¹ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯å¤§å¤šæ•°äººçš„åšæ³•ã€‚ä½†å¼ºçƒˆå»ºè®®ä¸è¦æ€ä¹ˆåšï¼Œé¦–å…ˆï¼Œç¤ºä¾‹é…ç½®æ–‡ä»¶æœ‰éå¸¸å¤šæ³¨é‡Šæ‰çš„é…ç½®é¡¹ï¼Œå®ƒå¯èƒ½ä¼šè¯±ä½¿ä½ æ‰“å¼€ä¸€ä¸ªä½ å¹¶ä¸äº†è§£çš„é…ç½®ï¼Œè€Œä¸”è¿™äº›æ³¨é‡Šè¿˜ä¸ä¸€å®šå‡†ç¡®ã€‚å…¶æ¬¡ï¼ŒMySQL çš„ä¸€äº›é…ç½®å¯¹äºç°ä»£åŒ–çš„ç¡¬ä»¶å’Œå·¥ä½œè´Ÿè½½æ¥è¯´ï¼Œæœ‰ç‚¹è¿‡æ—¶äº†ã€‚</p><p>MySQL æœ‰éå¸¸å¤šçš„é…ç½®é¡¹å¯ä»¥ä¿®æ”¹ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ éƒ½ä¸åº”è¯¥éšä¾¿ä¿®æ”¹å®ƒï¼Œå› ä¸ºé”™è¯¯æˆ–è€…æ²¡ç”¨çš„é…ç½®å¯¼è‡´çš„æ½œåœ¨é£é™©éå¸¸å¤§ï¼Œè€Œä¸”è¿˜å¾ˆéš¾å®šä½é—®é¢˜ã€‚ç¡®ä¿åŸºæœ¬é…ç½®æ­£ç¡®ï¼Œç„¶åå°å¿ƒè¯Šæ–­é—®é¢˜ï¼Œç¡®è®¤é—®é¢˜æ°å¥½å¯ä»¥é€šè¿‡æŸä¸ªé…ç½®é¡¹è§£å†³ï¼Œç´§æ¥ç€å†ä¿®æ”¹è¿™ä¸ªé…ç½®å§ã€‚</p><p>å…¶å®ï¼Œåˆ›å»ºä¸€ä¸ªå¥½çš„é…ç½®ï¼Œæœ€å¿«æ–¹æ³•ä¸æ˜¯ä»å­¦ä¹ é…ç½®é¡¹å¼€å§‹ï¼Œä¹Ÿä¸æ˜¯é—®å“ªä¸ªé…ç½®é¡¹åº”è¯¥æ€ä¹ˆè®¾ç½®æˆ–è€…æ€ä¹ˆä¿®æ”¹å¼€å§‹ï¼Œæ›´ä¸æ˜¯ä»æ£€æŸ¥æœåŠ¡å™¨è¡Œä¸ºå’Œè¯¢é—®å“ªä¸ªé…ç½®é¡¹å¯ä»¥æå‡æ€§èƒ½å¼€å§‹ã€‚æœ€å¥½æ˜¯ä»ç†è§£ MySQL å†…æ ¸å’Œè¡Œä¸ºå¼€å§‹ï¼Œç„¶ååˆ©ç”¨è¿™äº›çŸ¥è¯†æ¥æŒ‡å¯¼ä½ é…ç½® MySQLã€‚</p><p>å°±ä»ç†è§£ MySQL é…ç½®çš„å·¥ä½œåŸç†å¼€å§‹å§ã€‚</p><h2 id="MySQL-é…ç½®çš„å·¥ä½œåŸç†"><a href="#MySQL-é…ç½®çš„å·¥ä½œåŸç†" class="headerlink" title="MySQL é…ç½®çš„å·¥ä½œåŸç†"></a>MySQL é…ç½®çš„å·¥ä½œåŸç†</h2><p>MySQL ä»å“ªå„¿è·å¾—é…ç½®ä¿¡æ¯ï¼šå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶ã€‚ç±» Unix ç³»ç»Ÿä¸­ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬ä½äº /etc/my.cnf æˆ–è€… /etc/mysql/my.cnfã€‚åœ¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå½“ç„¶å‘½ä»¤è¡Œä¸­ä¹Ÿå¯ä»¥æŒ‡å®šå…¶å®ƒå‚æ•°ï¼ŒæœåŠ¡å™¨ä¼šè¯»å–é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œåˆ é™¤æ‰€æœ‰æ³¨é‡Šå’Œæ¢è¡Œï¼Œç„¶åå’Œå‘½ä»¤è¡Œé€‰é¡¹ä¸€èµ·å¤„ç†ã€‚</p><p>ä»»ä½•æ‰“ç®—é•¿æœŸä½¿ç”¨çš„é…ç½®é¡¹éƒ½åº”è¯¥å†™å…¥é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šã€‚ä¸€å®šè¦æ¸…æ¥šçš„çŸ¥é“ MySQL ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä½ç½®ï¼Œåœ¨ä¿®æ”¹æ—¶ä¸èƒ½æƒ³å½“ç„¶ï¼Œæ¯”å¦‚ï¼Œä¿®æ”¹äº† /etc/my.cnf çš„é…ç½®é¡¹ï¼Œä½† MySQL å®é™…å¹¶æœªä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚å¦‚æœä½ ä¸çŸ¥é“å½“å‰ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥å°è¯•ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> mysqld</span><br><span class="line">/usr/sbin/mysqld</span><br><span class="line">$ /usr/sbin/mysqld --verbose --<span class="built_in">help</span> |grep -A 1 <span class="string">'Default options'</span></span><br><span class="line">Default options are <span class="built_in">read</span> from the following files <span class="keyword">in</span> the given order:</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸€ä¸ªå…¸å‹çš„é…ç½®æ–‡ä»¶åŒ…å«å¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†çš„å¼€å¤´æ˜¯ä¸€ä¸ªæ–¹æ‹¬å·æ‹¬èµ·æ¥çš„åˆ†æ®µåç§°ã€‚MySQL ç¨‹åºé€šå¸¸è¯»å–è·Ÿå®ƒåŒåçš„åˆ†æ®µéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼Œè®¸å¤šå®¢æˆ·ç«¯ç¨‹åºè¯»å–[client]éƒ¨åˆ†ã€‚æœåŠ¡å™¨é€šå¸¸è¯»å–[mysqld]è¿™ä¸€æ®µï¼Œä¸€å®šè¦ç¡®è®¤é…ç½®é¡¹æ”¾åœ¨äº†æ–‡ä»¶æ­£ç¡®çš„åˆ†æ®µä¸­ï¼Œå¦åˆ™é…ç½®æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚</p><p>MySQL æ¯ä¸€ä¸ªé…ç½®é¡¹å‡ä½¿ç”¨å°å†™ï¼Œå•è¯ä¹‹é—´ç”¨ä¸‹åˆ’çº¿æˆ–è€…æ¨ªçº¿éš”å¼€ï¼Œè™½ç„¶æˆ‘ä»¬å¸¸ç”¨çš„åˆ†éš”ç¬¦æ˜¯ä¸‹åˆ’çº¿ï¼Œä½†å¦‚æœåœ¨å‘½ä»¤è¡Œæˆ–è€…é…ç½®æ–‡ä»¶ä¸­è§åˆ°å¦‚ä¸‹é…ç½®ï¼Œä½ è¦çŸ¥é“ï¼Œå®ƒä»¬å…¶å®æ˜¯ç­‰ä»·çš„ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">max_connections=5000</span><br><span class="line">max-connections=5000</span><br><span class="line"><span class="comment"># å‘½ä»¤è¡Œ</span></span><br><span class="line">/usr/sbin/mysqld --max_connections=5000</span><br><span class="line">/usr/sbin/mysqld --max-connections=5000</span><br></pre></td></tr></tbody></table></figure><p></p><p>é…ç½®é¡¹å¯ä»¥æœ‰å¤šä¸ªä½œç”¨åŸŸï¼šå…¨å±€ä½œç”¨åŸŸã€ä¼šè¯ä½œç”¨åŸŸ (æ¯ä¸ªè¿æ¥ä½œç”¨ä¸åŒ)ã€å¯¹è±¡ä½œç”¨åŸŸã€‚å¾ˆå¤šä¼šè¯çº§é…ç½®é¡¹è·Ÿå…¨å±€é…ç½®ç›¸ç­‰ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯é»˜è®¤å€¼ï¼Œå¦‚æœæ”¹å˜ä¼šè¯çº§é…ç½®é¡¹ï¼Œå®ƒåªå½±å“æ”¹åŠ¨çš„å½“å‰è¿æ¥ï¼Œå½“è¿æ¥å…³é—­æ—¶ï¼Œæ‰€æœ‰çš„å‚æ•°å˜æ›´éƒ½ä¼šå¤±æ•ˆã€‚ä¸‹é¢æœ‰å‡ ä¸ªç¤ºä¾‹é…ç½®é¡¹ï¼š</p><ul><li><code>query-cache-size</code> å…¨å±€é…ç½®é¡¹</li><li><code>sort-buffer-size</code> é»˜è®¤å…¨å±€ç›¸åŒï¼Œä½†æ¯ä¸ªçº¿ç¨‹é‡Œä¹Ÿå¯ä»¥è®¾ç½®</li><li><code>join-buffer-size</code> é»˜è®¤å…¨å±€ï¼Œä¸”æ¯ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥è®¾ç½®ã€‚ä½†è‹¥ä¸€ä¸ªæŸ¥è¯¢ä¸­å…³è”å¤šå¼ è¡¨ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå…³è”åˆ†é…ä¸€ä¸ªå…³è”ç¼“å­˜ (join-buffer)ï¼Œæ‰€ä»¥ä¸€ä¸ªæŸ¥è¯¢å¯èƒ½æœ‰å¤šä¸ªå…³è”ç¼“å†²ã€‚</li></ul><p>é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡ (é…ç½®é¡¹) æœ‰å¾ˆå¤š (ä½†ä¸æ˜¯æ‰€æœ‰) å¯ä»¥åœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ä¿®æ”¹ï¼ŒMySQL æŠŠè¿™äº›å½’ä¸ºåŠ¨æ€é…ç½®å˜é‡ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-- è®¾ç½®å…¨å±€å˜é‡ï¼ŒGLOBALå’Œ@@globalä½œç”¨æ˜¯ä¸€æ ·çš„</span><br><span class="line"><span class="built_in">set</span>   GLOBAL   sort-buffer-size  = <value></span><br><span class="line"><span class="built_in">set</span>   @@global.sort-buffer-size := <value></span><br><span class="line"></span><br><span class="line">-- è®¾ç½®ä¼šè¯çº§å˜é‡ï¼Œä¸‹é¢6ç§æ–¹å¼ä½œç”¨æ˜¯ä¸€æ ·çš„</span><br><span class="line">-- å³ï¼šæ²¡æœ‰ä¿®é¥°ç¬¦ã€SESSIONã€LOCALç­‰ä¿®é¥°ç¬¦ä½œç”¨æ˜¯ä¸€è‡´çš„</span><br><span class="line"><span class="built_in">set</span>  SESSION   sort-buffer-size  = <value></span><br><span class="line"><span class="built_in">set</span>  @@session.sort-buffer-size := <value></span><br><span class="line"><span class="built_in">set</span>          @@sort-buffer-size  = <value></span><br><span class="line"><span class="built_in">set</span>  LOCAL     sort-buffer-size  = <value></span><br><span class="line"><span class="built_in">set</span>     @@ocal.sort-buffer-size := <value></span><br><span class="line"><span class="built_in">set</span>            sort-buffer-size  = <value></span><br><span class="line"></span><br><span class="line">-- <span class="built_in">set</span>å‘½ä»¤å¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªå˜é‡ï¼Œä½†å…¶ä¸­åªè¦æœ‰ä¸€ä¸ªå˜é‡è®¾ç½®å¤±è´¥ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½æœªç”Ÿæ•ˆ</span><br><span class="line">SET GLOBAL sort-buffer-size = 100, SESSION sort-buffer-size = 1000;</span><br><span class="line">SET GLOBAL max-connections = 1000, sort-buffer-size = 1000000;</span><br></pre></td></tr></tbody></table></figure><p></p><p>åŠ¨æ€çš„è®¾ç½®å˜é‡ï¼ŒMySQL å…³é—­æ—¶è¿™äº›å˜é‡éƒ½ä¼šå¤±æ•ˆã€‚å¦‚æœåœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ä¿®æ”¹äº†å˜é‡çš„å…¨å±€å€¼ï¼Œè¿™ä¸ªå€¼å¯¹å½“å‰ä¼šè¯å’Œå…¶ä»–ä»»ä½•å·²ç»å­˜åœ¨çš„ä¼šè¯éƒ½ä¸èµ·æ•ˆæœï¼Œè¿™æ˜¯å› ä¸ºä¼šè¯çš„å˜é‡å€¼æ˜¯åœ¨è¿æ¥åˆ›å»ºæ—¶ä»å…¨å±€å€¼åˆå§‹åŒ–è€Œæ¥çš„ã€‚æ³¨æ„ï¼Œåœ¨é…ç½®ä¿®æ”¹åï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦ä¿®æ”¹æˆåŠŸã€‚</p><p>ä½ å¯èƒ½æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰äº›ä½¿ç”¨ â€˜=â€™ï¼Œæœ‰äº›ä½¿ç”¨ â€˜:=â€™ã€‚å¯¹äº set å‘½ä»¤æœ¬èº«æ¥è¯´ï¼Œä¸¤ç§èµ‹å€¼è¿ç®—ç¬¦æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ä»»ä¸€è¿ç®—ç¬¦ç¬¦ï¼Œå‡å¯ä»¥ç”Ÿæ•ˆã€‚è€Œåœ¨å…¶ä»–è¯­å¥ä¸­ï¼Œèµ‹å€¼è¿ç®—ç¬¦å¿…é¡»æ˜¯ â€˜:=â€™ï¼Œå› ä¸ºåœ¨é set è¯­å¥ä¸­ â€˜=â€™ è¢«è§†ä¸ºæ¯”è¾ƒè¿ç®—ç¬¦ã€‚å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼š</p><p>è¯¦ç»†ç¤ºä¾‹å¯ä»¥å‚è€ƒï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- @exp è¡¨ç¤ºç”¨æˆ·å˜é‡ï¼Œä¸Šé¢çš„ç¤ºä¾‹å‡æ˜¯ç³»ç»Ÿå˜é‡</span><br><span class="line">-- é”™è¯¯</span><br><span class="line"><span class="built_in">set</span> @user = 123456;</span><br><span class="line"><span class="built_in">set</span> @group = select GROUP from USER <span class="built_in">where</span> User = @user;</span><br><span class="line">select * from USER <span class="built_in">where</span> GROUP = @group;</span><br><span class="line"></span><br><span class="line">-- æ­£ç¡®</span><br><span class="line">SET @user := 123456;</span><br><span class="line">SELECT @group := `group` FROM user WHERE user = @user;</span><br><span class="line">SELECT * FROM user WHERE `group` = @group;</span><br></pre></td></tr></tbody></table></figure><p></p><p>æœ‰ä¸€äº›é…ç½®ä½¿ç”¨äº†ä¸åŒçš„å•ä½ï¼Œæ¯”å¦‚table-cacheå˜é‡æŒ‡å®šè¡¨å¯ä»¥è¢«ç¼“å­˜çš„æ•°é‡ï¼Œè€Œä¸æ˜¯è¡¨å¯ä»¥è¢«ç¼“å­˜çš„å­—èŠ‚æ•°ã€‚è€Œ<code>key-buffer-size</code>åˆ™æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</p><p>è¿˜æœ‰ä¸€äº›é…ç½®å¯ä»¥æŒ‡å®šåç¼€å•ä½ï¼Œæ¯”å¦‚1M=1024<em>1024å­—èŠ‚ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™åªèƒ½åœ¨é…ç½®æ–‡ä»¶æˆ–è€…ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°æ—¶æœ‰æ•ˆã€‚å½“ä½¿ç”¨ SQL çš„ SET å‘½ä»¤æ—¶ï¼Œå¿…é¡»ä½¿ç”¨æ•°å­—å€¼ 1048576 æˆ–è€… 1024</em>1024 è¿™æ ·çš„è¡¨è¾¾å¼ï¼Œä½†åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸èƒ½ä½¿ç”¨è¡¨è¾¾å¼ã€‚</p><p><strong>å°å¿ƒç¿¼ç¿¼çš„é…ç½® MySQL</strong><br>æˆ‘ä»¬å¸¸å¸¸åŠ¨æ€çš„ä¿®æ”¹é…ç½®ï¼Œä½†è¯·åŠ¡å¿…å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å¯¼è‡´æ•°æ®åº“åšå¤§é‡è€—æ—¶çš„å·¥ä½œï¼Œä»è€Œå½±å“æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚æ¯”å¦‚ä»ç¼“å­˜ä¸­åˆ·æ–°è„å—ï¼Œä¸åŒçš„åˆ·æ–°æ–¹å¼å¯¹ I/O çš„å½±å“å·®åˆ«å¾ˆå¤§ (åæ–‡ä¼šå…·ä½“è¯´æ˜)ã€‚æœ€å¥½æŠŠä¸€äº›å¥½çš„ä¹ æƒ¯ä½œä¸ºè§„èŒƒåˆå¹¶åˆ°å·¥ä½œæµç¨‹ä¸­å»ï¼Œå°±æ¯”å¦‚ï¼š</p><p><strong>å¥½ä¹ æƒ¯ 1ï¼šä¸è¦é€šè¿‡é…ç½®é¡¹çš„åç§°æ¥æ¨æ–­ä¸€ä¸ªå˜é‡çš„ä½œç”¨</strong></p><p>ä¸è¦é€šè¿‡é…ç½®é¡¹çš„åç§°æ¥æ¨æ–­ä¸€ä¸ªå˜é‡çš„ä½œç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½è·Ÿä½ æƒ³è±¡çš„å®Œå…¨ä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼š</p><ul><li><code>read-buffer-size</code>ï¼šå½“ MySQL éœ€è¦é¡ºåºè¯»å–æ•°æ®æ—¶ï¼Œå¦‚æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå…¶å°†è¿›è¡Œå…¨è¡¨æ‰«ææˆ–è€…å…¨ç´¢å¼•æ‰«æã€‚è¿™æ—¶ï¼ŒMySQL æŒ‰ç…§æ•°æ®çš„å­˜å‚¨é¡ºåºä¾æ¬¡è¯»å–æ•°æ®å—ï¼Œæ¯æ¬¡è¯»å–çš„æ•°æ®å—é¦–å…ˆä¼šæš‚å­˜åœ¨ç¼“å­˜ä¸­ï¼Œå½“ç¼“å­˜ç©ºé—´è¢«å†™æ»¡æˆ–è€…å…¨éƒ¨æ•°æ®è¯»å–ç»“æŸåï¼Œå†å°†ç¼“å­˜ä¸­çš„æ•°æ®è¿”å›ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œä»¥æé«˜æ•ˆç‡ã€‚</li><li><code>read-rnd-buffer-size</code>ï¼šå’Œé¡ºåºè¯»å–ç›¸å¯¹åº”ï¼Œå½“ MySQL è¿›è¡Œéé¡ºåºè¯»å–ï¼ˆéšæœºè¯»å–ï¼‰æ•°æ®å—çš„æ—¶å€™ï¼Œä¼šåˆ©ç”¨è¿™ä¸ªç¼“å†²åŒºæš‚å­˜è¯»å–çš„æ•°æ®ã€‚æ¯”å¦‚ï¼šæ ¹æ®ç´¢å¼•ä¿¡æ¯è¯»å–è¡¨æ•°æ®ã€æ ¹æ®æ’åºåçš„ç»“æœé›†ä¸è¡¨è¿›è¡Œ Join ç­‰ç­‰ã€‚æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å½“æ•°æ®å—çš„è¯»å–éœ€è¦æ»¡è¶³ä¸€å®šçš„é¡ºåºçš„æƒ…å†µä¸‹ï¼ŒMySQL å°±éœ€è¦äº§ç”Ÿéšæœºè¯»å–ï¼Œè¿›è€Œä½¿ç”¨åˆ°read-rnd-buffer-sizeå‚æ•°æ‰€è®¾ç½®çš„å†…å­˜ç¼“å†²åŒºã€‚</li></ul><p>è¿™ä¸¤ä¸ªé…ç½®éƒ½æ˜¯åœ¨æ‰«æ MyISAM è¡¨æ—¶æœ‰æ•ˆï¼Œä¸” MySQL ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…å†…å­˜ã€‚å¯¹äºå‰è€…ï¼ŒMySQL åªä¼šåœ¨æŸ¥è¯¢éœ€è¦ä½¿ç”¨æ—¶æ‰ä¼šä¸ºè¯¥ç¼“å­˜åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§åˆ†é…è¯¥å‚æ•°æŒ‡å®šå¤§å°çš„å…¨éƒ¨å†…å­˜ï¼Œè€Œåè€…åŒæ ·æ˜¯éœ€è¦æ—¶æ‰åˆ†é…å†…å­˜ï¼Œä½†åªåˆ†é…éœ€è¦çš„å†…å­˜å¤§å°è€Œä¸æ˜¯å‚æ•°æŒ‡å®šçš„æ•°å€¼ï¼Œmax-read-rnd-buffer-size(å®é™…ä¸Šæ²¡æœ‰è¿™ä¸ªé…ç½®é¡¹) è¿™ä¸ªåå­—æ›´èƒ½è¡¨è¾¾è¿™ä¸ªå˜é‡çš„å®é™…å«ä¹‰ã€‚</p><p><strong>å¥½ä¹ æƒ¯ 2ï¼šä¸è¦è½»æ˜“åœ¨å…¨å±€ä¿®æ”¹ä¼šè¯çº§åˆ«çš„é…ç½®</strong></p><p>å¯¹äºæŸäº›ä¼šè¯çº§åˆ«çš„è®¾ç½®ï¼Œä¸è¦è½»æ˜“çš„åœ¨å…¨å±€å¢åŠ å®ƒä»¬çš„å€¼ï¼Œé™¤éä½ ç¡®è®¤è¿™æ ·åšæ˜¯å¯¹çš„ã€‚æ¯”å¦‚ï¼š<code>sort-buffer-size</code>ï¼Œè¯¥å‚æ•°æ§åˆ¶æ’åºæ“ä½œçš„ç¼“å­˜å¤§å°ï¼ŒMySQL åªä¼šåœ¨æŸ¥è¯¢éœ€è¦åšæ’åºæ“ä½œæ—¶æ‰ä¼šä¸ºè¯¥ç¼“å†²åˆ†é…å†…å­˜ï¼Œä¸€æ—¦éœ€è¦æ’åºï¼Œå°±ä¼šä¸€æ¬¡æ€§åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜ï¼Œå³ä½¿æ˜¯éå¸¸å°çš„æ’åºæ“ä½œã€‚å› æ­¤åœ¨é…ç½®æ–‡ä»¶ä¸­åº”è¯¥é…ç½®çš„å°ä¸€äº›ï¼Œç„¶ååœ¨æŸäº›æŸ¥è¯¢éœ€è¦æ’åºæ—¶ï¼Œå†åœ¨è¿æ¥ä¸­æŠŠå®ƒè°ƒå¤§ã€‚æ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SET @@seession.sort-buffer-size := <value></span><br><span class="line">-- æ‰§è¡ŒæŸ¥è¯¢çš„sql</span><br><span class="line">SET @@seession.sort-buffer-size := DEFAULT -- æ¢å¤é»˜è®¤å€¼</span><br><span class="line">-- å¯ä»¥å°†ç±»ä¼¼çš„ä»£ç å°è£…åœ¨å‡½æ•°ä¸­æ–¹ä¾¿ä½¿ç”¨ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>å¥½ä¹ æƒ¯ 3ï¼šé…ç½®å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å€¼è¶Šå¤§è¶Šå¥½</strong><br>é…ç½®å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å€¼è¶Šå¤§è¶Šå¥½ï¼Œè€Œä¸”å¦‚æœè®¾ç½®çš„å€¼å¤ªé«˜ï¼Œå¯èƒ½æ›´å®¹æ˜“å¯¼è‡´å†…å­˜é—®é¢˜ã€‚åœ¨ä¿®æ”¹å®Œæˆåï¼Œåº”è¯¥é€šè¿‡ç›‘æ§æ¥ç¡®è®¤å˜é‡çš„ä¿®æ”¹å¯¹æœåŠ¡å™¨æ•´ä½“æ€§èƒ½çš„å½±å“ã€‚</p><p><strong>å¥½ä¹ æƒ¯ 4ï¼šè§„èŒƒæ³¨é‡Šï¼Œç‰ˆæœ¬æ§åˆ¶</strong><br>åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¥½æ³¨é‡Šï¼Œå¯èƒ½ä¼šèŠ‚çœè‡ªå·±å’ŒåŒäº‹å¤§é‡çš„å·¥ä½œï¼Œä¸€ä¸ªæ›´å¥½çš„ä¹ æƒ¯æ˜¯æŠŠé…ç½®æ–‡ä»¶ç½®äºç‰ˆæœ¬æ§åˆ¶ä¹‹ä¸‹ã€‚</p><p>è¯´å®Œäº†å¥½ä¹ æƒ¯ï¼Œå†æ¥è¯´è¯´ä¸å¥½çš„ä¹ æƒ¯ã€‚</p><p><strong>åä¹ æƒ¯ 1ï¼šæ ¹æ®ä¸€äº› â€œæ¯”ç‡â€ æ¥è°ƒä¼˜</strong><br>ä¸€ä¸ªç»å…¸çš„æŒ‰ â€œæ¯”ç‡â€ è°ƒä¼˜çš„ç»éªŒæ³•åˆ™æ˜¯ï¼Œç¼“å­˜çš„å‘½ä¸­ç‡åº”è¯¥é«˜äºæŸä¸ªç™¾åˆ†æ¯”ï¼Œå¦‚æœå‘½ä¸­ç‡è¿‡ä½ï¼Œåˆ™åº”è¯¥å¢åŠ ç¼“å­˜çš„å¤§å°ã€‚è¿™æ˜¯éå¸¸é”™è¯¯çš„æ„è§ï¼Œå¤§å®¶å¯ä»¥ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼šç¼“å­˜çš„å‘½ä¸­ç‡è·Ÿç¼“å­˜å¤§å°æœ‰å¿…ç„¶è”ç³»å—ï¼Ÿ(åˆ†æ¯å˜å¤§ï¼Œå€¼å°±å˜å¤§äº†ï¼Ÿ) é™¤éç¡®å®æ˜¯ç¼“å­˜å¤ªå°äº†ã€‚å…³äº MyISAM é”®ç¼“å†²å‘½ä¸­ç‡ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è¯´æ˜ã€‚</p><p><strong>åä¹ æƒ¯ 2ï¼šéšä¾¿ä½¿ç”¨è°ƒä¼˜è„šæœ¬</strong><br>å°½é‡ä¸è¦ä½¿ç”¨è°ƒä¼˜è„šæœ¬ï¼ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€ä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒå¯¹ MySQL çš„æ€§èƒ½è¦æ±‚æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚æœ‰äº›ä¸šåŠ¡å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚è¾ƒé«˜ï¼Œé‚£ä¹ˆå°±ä¸€å®šè¦ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå‡ºç°æ•…éšœåå¯æ¢å¤æ•°æ®ï¼Œè€Œæœ‰äº›ä¸šåŠ¡å´å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚æ²¡é‚£ä¹ˆé«˜ï¼Œä½†å¯¹æ€§èƒ½è¦æ±‚æ›´é«˜ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œåœ¨è¿™ä¸¤ä¸ªä¸åŒåœºæ™¯ä¸‹ï¼Œå…¶é…ç½®çš„å€¼ä¹Ÿåº”è¯¥æ˜¯ä¸åŒçš„ã€‚é‚£ä½ è¿˜èƒ½æ”¾å¿ƒçš„ä½¿ç”¨ç½‘ä¸Šæ‰¾åˆ°çš„è„šæœ¬å— ï¼Ÿ</p><blockquote><p>æœ¬å°èŠ‚ç¤ºä¾‹çš„å‡ ä¸ªé…ç½®é¡¹ï¼Œä»…ç”¨äºä¸¾ä¾‹è¯´æ˜ï¼Œå¹¶ä¸ä»£è¡¨å®ƒä»¬æœ‰å¤šä¹ˆé‡è¦ï¼Œè¯·æ ¹æ®å®é™…åº”ç”¨åœºæ™¯é…ç½®å®ƒä»¬ã€‚å°±æ¯”å¦‚<code>sort-buffer-size</code>ï¼Œä½ çœŸçš„éœ€è¦ 100M å†…å­˜æ¥ç¼“å­˜ 10 è¡Œæ•°æ®ï¼Ÿ</p></blockquote><h4 id="åˆ†æ®µ"><a href="#åˆ†æ®µ" class="headerlink" title="åˆ†æ®µ"></a>åˆ†æ®µ</h4><p>MySQL é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸ºé›†ä¸­å¼ï¼Œé€šå¸¸ä¼šåˆ†æˆå¥½å‡ éƒ¨åˆ†ï¼Œå¯ä»¥ä¸ºå¤šä¸ªç¨‹åºæä¾›é…ç½®ï¼Œå¦‚<code>[client]</code>ã€<code>[mysqld]</code>ã€<code>[mysql]</code>ç­‰ç­‰ã€‚MySQL ç¨‹åºé€šå¸¸æ˜¯è¯»å–ä¸å®ƒåŒåçš„åˆ†æ®µéƒ¨åˆ†ã€‚</p><ul><li><code>[client]</code>å®¢æˆ·ç«¯é»˜è®¤è®¾ç½®å†…å®¹</li><li><code>[mysql]</code>ä½¿ç”¨ mysql å‘½ä»¤ç™»å½• MySQL æ•°æ®åº“æ—¶çš„é»˜è®¤è®¾ç½®</li><li><code>[mysqld]</code>æ•°æ®åº“æœ¬èº«çš„é»˜è®¤è®¾ç½®</li></ul><p>ä¾‹å¦‚æœåŠ¡å™¨ mysqld é€šå¸¸è¯»å–<code>[mysqld]</code>åˆ†æ®µä¸‹çš„ç›¸å…³é…ç½®é¡¹ã€‚å¦‚æœé…ç½®é¡¹ä½ç½®ä¸æ­£ç¡®ï¼Œè¯¥é…ç½®æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚</p><h4 id="GENERAL"><a href="#GENERAL" class="headerlink" title="GENERAL"></a>GENERAL</h4><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ· mysql æ¥è¿è¡Œ mysqld è¿›ç¨‹ï¼Œè¯·ç¡®ä¿è¿™ä¸ªç”¨æˆ·æ‹¥æœ‰æ“ä½œæ•°æ®ç›®å½•çš„æƒé™ã€‚è®¾ç½®é»˜è®¤ç«¯å£ä¸º 3306ï¼Œæœ‰æ—¶ä¸ºäº†å®‰å…¨ï¼Œå¯èƒ½ä¼šä¿®æ”¹ä¸€ä¸‹ã€‚é»˜è®¤é€‰æ‹© Innodb å­˜å‚¨å¼•æ“ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ä½†å¦‚æœé»˜è®¤æ˜¯ InnoDBï¼Œå´éœ€è¦ä½¿ç”¨ MyISAM å­˜å‚¨å¼•æ“ï¼Œè¯·æ˜¾å¼åœ°è¿›è¡Œé…ç½®ã€‚è®¸å¤šç”¨æˆ·è®¤ä¸ºå…¶æ•°æ®åº“ä½¿ç”¨äº†æŸç§å­˜å‚¨å¼•æ“ä½†å®é™…ä¸Šå´ä½¿ç”¨çš„æ˜¯å¦å¤–ä¸€ç§ï¼Œå°±æ˜¯å› ä¸ºé»˜è®¤é…ç½®çš„é—®é¢˜ã€‚</p><p>æ¥ç€è®¾ç½®æ•°æ®æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™é‡ŒæŠŠ pid æ–‡ä»¶å’Œ socket æ–‡ä»¶æ”¾åˆ°ç›¸åŒçš„ä½ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶å®ƒä½ç½®ï¼Œä½†è¦æ³¨æ„çš„æ˜¯ä¸è¦å°† socket æ–‡ä»¶å’Œ pid æ–‡ä»¶æ”¾åˆ° MySQL ç¼–è¯‘çš„é»˜è®¤ä½ç½®ï¼Œå› ä¸ºä¸åŒç‰ˆæœ¬çš„ MySQLï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„é»˜è®¤è·¯å¾„å¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œæœ€å¥½æ˜ç¡®åœ°è®¾ç½®è¿™äº›æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å…ç‰ˆæœ¬å‡çº§æ—¶å‡ºç°é—®é¢˜ã€‚</p><blockquote><p>åœ¨ç±» UNIX ç³»ç»Ÿä¸‹æœ¬åœ°è¿æ¥ MySQL å¯ä»¥é‡‡ç”¨ UNIX åŸŸå¥—æ¥å­—æ–¹å¼ï¼Œè¿™ç§æ–¹å¼éœ€è¦ä¸€ä¸ªå¥—æ¥å­—ï¼ˆsocketï¼‰æ–‡ä»¶ï¼Œå³é…ç½®ä¸­çš„mysql.sockæ–‡ä»¶ã€‚</p></blockquote><blockquote><p>å½“ MySQL å®ä¾‹å¯åŠ¨æ—¶ï¼Œä¼šå°†è‡ªå·±çš„è¿›ç¨‹ ID å†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”è¯¥æ–‡ä»¶å³ä¸º pid æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ç”±å‚æ•°pid-fileæ§åˆ¶ï¼Œé»˜è®¤ä½äºæ•°æ®åº“ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ºä¸»æœºå.pidã€‚</p></blockquote><h4 id="DATA-STORAGE"><a href="#DATA-STORAGE" class="headerlink" title="DATA STORAGE"></a>DATA STORAGE</h4><p>datadirç”¨äºé…ç½®æ•°æ®æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ã€‚</p><p><strong>ä¸ºç¼“å­˜åˆ†é…å†…å­˜</strong><br>æ¥ä¸‹æ¥æœ‰è®¸å¤šæ¶‰åŠåˆ°ç¼“å­˜çš„é…ç½®é¡¹ï¼Œç¼“å­˜è®¾ç½®å¤šå¤§ï¼Œæœ€ç›´æ¥çš„å› ç´ è‚¯å®šæ˜¯æœåŠ¡å™¨å†…å­˜çš„å¤§å°ã€‚å¦‚æœæœåŠ¡å™¨åªè¿è¡Œ MySQLï¼Œæ‰€æœ‰ä¸éœ€è¦ä¸º OS ä»¥åŠæŸ¥è¯¢å¤„ç†ä¿ç•™çš„å†…å­˜éƒ½å¯ä»¥ç”¨åœ¨ MySQL ç¼“å­˜ã€‚ä¸º MySQL ç¼“å­˜åˆ†é…æ›´å¤šå†…å­˜ï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…ç£ç›˜è®¿é—®ï¼Œæå‡æ•°æ®åº“æ€§èƒ½ã€‚å¤§éƒ¨åˆ†æƒ…å†µæ¥è¯´æœ€ä¸ºé‡è¦çš„ç¼“å­˜ï¼š</p><ul><li>InnoDB ç¼“å†²æ± </li><li>InnoDB æ—¥å¿—æ–‡ä»¶å’Œ MyISAM æ•°æ®çš„æ“ä½œç³»ç»Ÿç¼“å­˜ (MyISAM ä¾èµ–äº OS ç¼“å­˜æ•°æ®)</li><li>MyISAM é”®ç¼“å­˜</li><li>æŸ¥è¯¢ç¼“å­˜</li><li>æ— æ³•é…ç½®çš„ç¼“å­˜ï¼Œæ¯”å¦‚ï¼šbin-log æˆ–è€…è¡¨å®šä¹‰æ–‡ä»¶çš„ OS ç¼“å­˜</li></ul><p>è¿˜æœ‰ä¸€äº›å…¶ä»–ç¼“å­˜ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸ä¼šä½¿ç”¨å¤ªå¤šå†…å­˜ã€‚å…³äºæŸ¥è¯¢ç¼“å­˜ï¼Œå‰é¢æ–‡ç«  (å‚è€ƒæœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡) å·²æœ‰ä»‹ç»ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ä¸å»ºè®®å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼Œå› æ­¤ä¸Šæ–‡çš„é…ç½®ä¸­query-cache-type=0è¡¨ç¤ºç¦ç”¨äº†æŸ¥è¯¢ç¼“å­˜ï¼Œç›¸åº”çš„æŸ¥è¯¢ç¼“å­˜å¤§å°query-cache-size=0ã€‚é™¤å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå‰©ä¸‹å…³äº InnoDB å’Œ MyISAM çš„ç›¸å…³ç¼“å­˜ï¼Œåœ¨æ¥ä¸‹æ¥ä¼šåšè¯¦ç»†ä»‹ç»ã€‚</p><p>å¦‚æœåªä½¿ç”¨å•ä¸€å­˜å‚¨å¼•æ“ï¼Œé…ç½®æœåŠ¡å™¨å°±ä¼šç®€å•è®¸å¤šã€‚å¦‚æœåªä½¿ç”¨ MyISAM è¡¨ï¼Œå°±å¯ä»¥å®Œå…¨å…³é—­ InnoDBï¼Œè€Œå¦‚æœåªä½¿ç”¨ InnoDBï¼Œå°±åªéœ€è¦åˆ†é…æœ€å°‘çš„èµ„æºç»™ MyISAMï¼ˆMySQL å†…éƒ¨ç³»ç»Ÿè¡¨ä½¿ç”¨ MyISAM å¼•æ“ï¼‰ã€‚ä½†å¦‚æœæ˜¯æ··åˆä½¿ç”¨å„ç§å­˜å‚¨å¼•æ“ï¼Œå°±å¾ˆéš¾åœ¨ä»–ä»¬ä¹‹é—´æ‰¾åˆ°æ°å½“çš„å¹³è¡¡ï¼Œå› æ­¤åªèƒ½æ ¹æ®ä¸šåŠ¡åšä¸€ä¸ªçŒœæµ‹ï¼Œç„¶ååœ¨è¿è¡Œä¸­è§‚å¯ŸæœåŠ¡å™¨è¿è¡ŒçŠ¶å†µååšå‡ºè°ƒæ•´ã€‚</p><h4 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h4><p><strong>key-buffer-size</strong></p><p><code>key-buffer-size</code>ç”¨äºé…ç½® <code>MyISAM</code>é”®ç¼“å­˜å¤§å°ï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ªé”®ç¼“å­˜ï¼Œä½†æ˜¯å¯ä»¥åˆ›å»ºå¤šä¸ªã€‚MyISAM è‡ªèº«åªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜æ•°æ® (ä¾èµ– OS ç¼“å­˜æ•°æ®)ã€‚å¦‚æœå¤§éƒ¨åˆ†è¡¨éƒ½æ˜¯ <code>MyISAM</code>ï¼Œé‚£ä¹ˆåº”è¯¥ä¸ºé”®ç¼“å­˜è®¾ç½®è¾ƒå¤šçš„å†…å­˜ã€‚ä½†å¦‚ä½•ç¡®å®šè¯¥è®¾ç½®å¤šå¤§ï¼Ÿ<br>å‡è®¾æ•´ä¸ªæ•°æ®åº“ä¸­è¡¨çš„ç´¢å¼•å¤§å°ä¸º Xï¼Œè‚¯å®šä¸éœ€è¦æŠŠç¼“å­˜è®¾ç½®å¾—æ¯” X è¿˜å¤§ï¼Œæ‰€ä»¥å½“å‰çš„ç´¢å¼•å¤§å°å°±æˆä¸ºè¿™ä¸ªé…ç½®é¡¹çš„é‡è¦ä¾æ®ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼æ¥æŸ¥è¯¢å½“å‰ç´¢å¼•çš„å¤§å°ï¼š</p><p>1.é€šè¿‡ SQL è¯­å¥æŸ¥è¯¢<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUM(INDEX_LENGTH) FROM INFORMATION_SCHEMA.TABLES WHERE ENGINE = <span class="string">'MYISAM'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>2.ç»Ÿè®¡ç´¢å¼•æ–‡ä»¶çš„å¤§å°<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ du -sch `find /path/to/mysql/data/directory/ -name <span class="string">"*.MYI"</span>`</span><br><span class="line">æ¯”å¦‚ï¼š</span><br><span class="line">root@dev-msc3:<span class="comment"># du -sch `find /var/lib/mysql -name "*.MYI"`</span></span><br><span class="line">72K        /var/lib/mysql/static/t_global_region.MYI</span><br><span class="line">40K        /var/lib/mysql/mysql/db.MYI</span><br><span class="line">12K        /var/lib/mysql/mysql/proxies_priv.MYI</span><br><span class="line">12K        /var/lib/mysql/mysql/tables_priv.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/func.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/columns_priv.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/proc.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/event.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/user.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/procs_priv.MYI</span><br><span class="line">4.0K       /var/lib/mysql/mysql/ndb_binlog_index.MYI</span><br><span class="line">164K       total</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œåˆšåˆ›å»ºå¥½çš„æ•°æ®åº“ï¼Œæ ¹æœ¬å°±æ²¡ä»€ä¹ˆæ•°æ®ï¼Œç´¢å¼•æ–‡ä»¶å¤§å°ä¸º 0ï¼Œé‚£å¦‚ä½•é…ç½®é”®ç¼“å­˜å¤§å°ï¼Ÿè¿™æ—¶å€™åªèƒ½æ ¹æ®ç»éªŒå€¼ï¼šä¸è¶…è¿‡ä¸ºæ“ä½œç³»ç»Ÿç¼“å­˜ä¿ç•™å†…å­˜çš„ 25% ~ 50%ã€‚è®¾ç½®ä¸€ä¸ªåŸºæœ¬å€¼ï¼Œç­‰è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ ¹æ®è¿è¡Œæƒ…å†µæ¥è°ƒæ•´é”®ç¼“å­˜å¤§å°ã€‚æ€»ç»“æ¥è¯´ï¼Œç´¢å¼•å¤§å°ä¸ OS ç¼“å­˜çš„ 25%~50% ä¸¤è€…é—´å–å°è€…ã€‚å½“ç„¶è¿˜å¯ä»¥è®¡ç®—é”®ç¼“å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœä¸€æ®µæ—¶é—´åè¿˜æ˜¯æ²¡æœ‰ä½¿ç”¨å®Œæ‰€æœ‰çš„é”®ç¼“å­˜ï¼Œå°±å¯ä»¥æŠŠç¼“å†²åŒºè°ƒå°ä¸€ç‚¹ï¼Œè®¡ç®—ç¼“å­˜åŒºçš„ä½¿ç”¨ç‡å¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼ï¼š<br><strong>(key_blocks_unused * key_cache_block_size) / key_buffer_size</strong></p><blockquote><p>è¯´æ˜ï¼š</p></blockquote><blockquote><p>key_blocks_unused çš„å€¼å¯ä»¥é€šè¿‡ SHOW STATUS è·å–</p></blockquote><blockquote><p>key_cache_block_size çš„å€¼å¯ä»¥é€šè¿‡ SHOW VARIABLES è·å–</p></blockquote><p>é”®ç¼“å­˜å—å¤§å°æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å€¼ï¼Œå› ä¸ºå®ƒå½±å“ MyISAMã€OS ç¼“å­˜ä»¥åŠæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„äº¤äº’ã€‚å¦‚æœç¼“å­˜å—å¤ªå°ï¼Œå¯èƒ½ä¼šç¢°åˆ°å†™æ—¶è¯»å– (OS åœ¨å†™æ•°æ®ä¹‹å‰å¿…é¡»å…ˆä»ç£ç›˜ä¸Šè¯»å–ä¸€äº›æ•°æ®)ï¼Œå…³äºå†™æ—¶è¯»å–çš„ç›¸å…³çŸ¥è¯†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p><p>å…³äºç¼“å­˜å‘½ä¸­ç‡ï¼Œè¿™é‡Œå†è¯´ä¸€ç‚¹ã€‚ç¼“å­˜å‘½ä¸­ç‡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿå…¶å®è¿™ä¸ªæ•°å­—æ²¡å¤ªå¤§çš„ä½œç”¨ã€‚æ¯”å¦‚ 99% å’Œ 99.9% ä¹‹é—´çœ‹èµ·æ¥å·®è·å¾ˆå°ï¼Œä½†å®é™…ä¸Šä»£è¡¨äº† 10 å€çš„å·®è·ã€‚ç¼“å­˜å‘½ä¸­ç‡çš„å®é™…æ„ä¹‰ä¸åº”ç”¨ä¹Ÿæœ‰å¾ˆå¤§å…³ç³»ï¼Œæœ‰äº›åº”ç”¨å¯ä»¥åœ¨å‘½ä¸­ç‡ 99% ä¸‹è‰¯å¥½çš„å·¥ä½œï¼Œæœ‰äº› I/O å¯†é›†å‹åº”ç”¨ï¼Œå¯èƒ½éœ€è¦ 99.99%ã€‚æ‰€ä»¥ä»ç»éªŒä¸Šæ¥è¯´ï¼Œæ¯ç§’æœªå‘½ä¸­æ¬¡æ•°è¿™ä¸ªæŒ‡æ ‡å®é™…ä¸Šä¼šæ›´æœ‰ç”¨ä¸€äº›ã€‚æ¯”å¦‚æ¯ç§’ 5 æ¬¡æœªå‘½ä¸­å¯èƒ½ä¸ä¼šå¯¼è‡´ IO ç¹å¿™ï¼Œä½†æ¯ç§’ 100 æ¬¡ç¼“å­˜æœªå‘½ä¸­åˆ™å¯èƒ½å‡ºç°é—®é¢˜ã€‚</p><p>MyISAM é”®ç¼“å­˜çš„æ¯ç§’æœªå‘½ä¸­æ¬¡æ•°å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç›‘æ§ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—æ¯éš”10sç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°çš„å¢é‡</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ­¤å‘½ä»¤æ—¶è¯·å¸¦ä¸Šç”¨æˆ·å’Œå¯†ç å‚æ•°ï¼šmysqladmin -uroot -pxxx extended-status -r -i 10 | grep Key_reads</span></span><br><span class="line">$ mysqladmin extended-status -r -i 10 | grep Key_reads</span><br></pre></td></tr></tbody></table></figure><p></p><p>æœ€åï¼Œå³ä½¿æ²¡æœ‰ä½¿ç”¨ä»»ä½• MyISAM è¡¨ï¼Œä¾ç„¶éœ€è¦å°†key-buffer-sizeè®¾ç½®ä¸ºè¾ƒå°å€¼ï¼Œæ¯”å¦‚ 32Mï¼Œå› ä¸º MySQL å†…éƒ¨ä¼šä½¿ç”¨ MyISAM è¡¨ï¼Œæ¯”å¦‚ GROUP BY è¯­å¥å¯èƒ½ä¼šåˆ›å»º MyISAM ä¸´æ—¶è¡¨ã€‚</p><h4 id="myisam-recover"><a href="#myisam-recover" class="headerlink" title="myisam-recover"></a>myisam-recover</h4><p>myisam-recoveré€‰é¡¹ç”¨äºé…ç½® MyISAM æ€æ ·å¯»æ‰¾å’Œä¿®å¤é”™è¯¯ã€‚æ‰“å¼€è¿™ä¸ªé€‰é¡¹ä¼šé€šçŸ¥ MySQL åœ¨æ‰“å¼€è¡¨æ—¶ï¼Œæ£€æŸ¥è¡¨æ˜¯å¦æŸåï¼Œå¹¶åœ¨æ‰¾åˆ°é—®é¢˜æ—¶è¿›è¡Œä¿®å¤ï¼Œå®ƒå¯ä»¥è®¾ç½®å¦‚ä¸‹å€¼ï¼š    </p><ul><li>DEFAULTï¼šè¡¨ç¤ºä¸è®¾ç½®ï¼Œä¼šå°è¯•ä¿®å¤å´©æºƒæˆ–è€…æœªå®Œå…¨å…³é—­çš„è¡¨ï¼Œä½†åœ¨æ¢å¤æ•°æ®æ—¶ä¸ä¼šæ‰§è¡Œå…¶å®ƒåŠ¨ä½œ</li><li>BACKUPï¼šå°†æ•°æ®æ–‡ä»¶å¤‡ä»½åˆ°. bak æ–‡ä»¶ï¼Œä»¥ä¾¿éšåè¿›è¡Œæ£€æŸ¥</li><li>FORCEï¼šå³ä½¿. myd æ–‡ä»¶ä¸­ä¸¢å¤±çš„æ•°æ®è¶…è¿‡ 1 è¡Œï¼Œä¹Ÿè®©æ¢å¤åŠ¨ä½œç»§ç»­æ‰§è¡Œ</li><li>QUICKï¼šé™¤éæœ‰åˆ é™¤å—ï¼Œå¦åˆ™è·³è¿‡æ¢å¤</li></ul><p>å¯ä»¥è®¾ç½®å¤šä¸ªå€¼ï¼Œæ¯ä¸ªå€¼ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚é…ç½®æ–‡ä»¶ä¸­çš„BACKUP,FORCEä¼šå¼ºåˆ¶æ¢å¤å¹¶ä¸”åˆ›å»ºå¤‡ä»½ï¼Œè¿™æ ·é…ç½®åœ¨åªæœ‰ä¸€äº›å°çš„ MyISAM è¡¨æ—¶æœ‰ç”¨ï¼Œå› ä¸ºæœåŠ¡å™¨è¿è¡Œç€ä¸€äº›æŸåçš„ MyISAM è¡¨æ˜¯éå¸¸å±é™©çš„ï¼Œå®ƒä»¬æœ‰æ—¶å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šæ•°æ®æŸåï¼Œç”šè‡³æœåŠ¡å™¨å´©æºƒã€‚ç„¶è€Œå¦‚æœæœ‰å¾ˆå¤§çš„è¡¨ï¼Œå®ƒä¼šå¯¼è‡´æœåŠ¡å™¨æ‰“å¼€æ‰€æœ‰çš„ MyISAM è¡¨æ—¶éƒ½æ£€æŸ¥å’Œä¿®å¤ï¼Œå¤§è¡¨çš„æ£€æŸ¥å’Œä¿®å¤å¯èƒ½ä¼šè€—è´¹å¤§é‡æ—¶é—´ï¼Œä¸”åœ¨è¿™æ®µæ—¶é—´é‡Œï¼ŒMySQL ä¼šé˜»æ­¢è¿™ä¸ªè¿æ¥åšå…¶å®ƒä»»ä½•æ“ä½œï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆ‡å®é™…çš„ã€‚</p><p>å› æ­¤ï¼Œåœ¨é»˜è®¤ä½¿ç”¨ InnoDB å­˜å‚¨å¼•æ“æ—¶ï¼Œæ•°æ®åº“ä¸­åªæœ‰éå¸¸å°çš„ MyISAM è¡¨æ—¶ï¼Œåªéœ€è¦é…ç½®key-buffe-sizeäºä¸€ä¸ªå¾ˆå°çš„å€¼ (32M) ä»¥åŠmyisam-recover=BACKUP,FORCEã€‚å½“æ•°æ®åº“ä¸­å¤§éƒ¨åˆ†è¡¨ä¸º MyISAM è¡¨æ—¶ï¼Œè¯·æ ¹æ®ä¸Šæ–‡çš„å…¬å¼åˆç†é…ç½®key-buffer-sizeï¼Œè€Œmyisam-recoveråˆ™å¯ä»¥å…³é—­ï¼Œåœ¨å¯åŠ¨åä½¿ç”¨CHECK TABLESå’ŒREPAIR TABLESå‘½ä»¤æ¥åšæ£€æŸ¥å’Œä¿®å¤ï¼Œè¿™æ ·å¯¹æœåŠ¡å™¨çš„å½±å“æ¯”è¾ƒå°ã€‚</p><h4 id="SAFETY"><a href="#SAFETY" class="headerlink" title="SAFETY"></a>SAFETY</h4><p>åŸºæœ¬é…ç½®è®¾ç½®åˆ°ä½åï¼ŒMySQL å·²ç»æ¯”è¾ƒå®‰å…¨äº†ï¼Œè¿™é‡Œä»…ä»…åˆ—å‡ºä¸¤ä¸ªéœ€è¦æ³¨æ„çš„é…ç½®é¡¹ï¼Œå¦‚æœéœ€è¦å¯ç”¨ä¸€äº›ä½¿æœåŠ¡å™¨æ›´å®‰å…¨å’Œå¯é çš„è®¾ç½®ï¼Œå¯ä»¥å‚è€ƒ MySQL å®˜æ–¹æ‰‹å†Œï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬å…¶ä¸­çš„ä¸€äº›é€‰é¡¹å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œæ¯•ç«Ÿä¿è¯å®‰å…¨å’Œå¯é éœ€è¦ä»˜å‡ºä¸€äº›ä»£ä»·ã€‚</p><p><strong>max-allowed-packet</strong><br><code>max-allowed-packet</code>é˜²æ­¢æœåŠ¡å™¨å‘é€å¤ªå¤§çš„æ•°æ®åŒ…ï¼Œä¹Ÿæ§åˆ¶æœåŠ¡å™¨å¯ä»¥æ¥æ”¶å¤šå¤§çš„åŒ…ã€‚é»˜è®¤å€¼ 4Mï¼Œå¯èƒ½ä¼šæ¯”è¾ƒå°ã€‚å¦‚æœè®¾ç½®å¤ªå°ï¼Œæœ‰æ—¶å¤åˆ¶ä¸Šä¼šå‡ºé—®é¢˜ï¼Œè¡¨ç°ä¸ºä»åº“ä¸èƒ½æ¥æ”¶ä¸»åº“å‘è¿‡æ¥çš„å¤åˆ¶æ•°æ®ã€‚å¦‚æœè¡¨ä¸­æœ‰ Blob æˆ–è€… Text å­—æ®µï¼Œä¸”æ•°æ®é‡è¾ƒå¤§çš„è¯ï¼Œè¦å°å¿ƒï¼Œå¦‚æœæ•°æ®é‡è¶…è¿‡è¿™ä¸ªå˜é‡çš„å¤§å°ï¼Œå®ƒä»¬å¯èƒ½è¢«æˆªæ–­æˆ–è€…ç½®ä¸º NULLï¼Œè¿™é‡Œå»ºè®®è®¾ç½®ä¸º 16Mã€‚</p><p><strong>max-connect-errors</strong><br>è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ª MySQL ä¸­ä¸å®‰å…¨ç›¸å…³çš„è®¡æ•°å™¨å€¼ï¼Œå®ƒä¸»è¦é˜²æ­¢å®¢æˆ·ç«¯æš´åŠ›ç ´è§£å¯†ç ã€‚å¦‚æœæŸä¸€ä¸ªå®¢æˆ·ç«¯å°è¯•è¿æ¥ MySQL æœåŠ¡å™¨å¤±è´¥è¶…è¿‡ n æ¬¡ï¼Œåˆ™ MySQL ä¼šæ— æ¡ä»¶å¼ºåˆ¶é˜»æ­¢æ­¤å®¢æˆ·ç«¯è¿æ¥ï¼Œç›´åˆ°å†æ¬¡åˆ·æ–°ä¸»æœºç¼“å­˜æˆ–è€…é‡å¯ MySQL æœåŠ¡å™¨ã€‚</p><p>è¿™ä¸ªå€¼é»˜è®¤ä¸º 10ï¼Œå¤ªå°äº†ï¼Œæœ‰æ—¶å€™ç½‘ç»œæŠ½é£æˆ–è€…åº”ç”¨é…ç½®å‡ºç°é”™è¯¯å¯¼è‡´çŸ­æ—¶é—´å†…ä¸æ–­å°è¯•é‡è¿æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å°±ä¼šè¢«åˆ—å…¥é»‘åå•ï¼Œå¯¼è‡´æ— æ³•è¿æ¥ã€‚å¦‚æœåœ¨å†…ç½‘ç¯å¢ƒï¼Œå¯ä»¥ç¡®è®¤æ²¡æœ‰å®‰å…¨é—®é¢˜å¯ä»¥æŠŠè¿™ä¸ªå€¼è®¾ç½®çš„å¤§ä¸€ç‚¹ï¼Œé»˜è®¤å€¼å¤ªå®¹æ˜“å¯¼è‡´é—®é¢˜ã€‚</p><h4 id="LOGGING"><a href="#LOGGING" class="headerlink" title="LOGGING"></a>LOGGING</h4><p>æ¥ä¸‹æ¥çœ‹ä¸‹æ—¥å¿—çš„é…ç½®ï¼Œå¯¹äº MySQL æ¥è¯´ï¼Œæ…¢æ—¥å¿—å’Œ bin-log æ˜¯éå¸¸é‡è¦çš„ä¸¤ç§æ—¥å¿—ï¼Œå‰è€…å¯ä»¥å¸®åŠ©åº”ç”¨ç¨‹åºç›‘æ§æ€§èƒ½é—®é¢˜ï¼Œåè€…åœ¨æ•°æ®åŒæ­¥ã€å¤‡ä»½ç­‰æ–¹é¢å‘æŒ¥ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p><p>å…³äº bin-log çš„ 3 ä¸ªé…ç½®ï¼Œlog-binç”¨äºé…ç½®æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼Œexpire_logs_daysè®©æœåŠ¡å™¨åœ¨æŒ‡å®šå¤©æ•°ä¹‹åæ¸…ç†æ—§çš„æ—¥å¿—ï¼Œå³é…ç½®ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„æ—¥å¿—ã€‚é™¤éæœ‰è¿ç»´æ‰‹åŠ¨å¤‡ä»½æ¸…ç† bin-logï¼Œå¦åˆ™å¼ºçƒˆå»ºè®®æ‰“å¼€æ­¤é…ç½®ï¼Œå¦‚æœä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨ç©ºé—´æœ€ç»ˆå°†ä¼šè¢«è€—å°½ï¼Œå¯¼è‡´æœåŠ¡å™¨å¡ä½æˆ–è€…å´©æºƒã€‚</p><h4 id="sync-binlog"><a href="#sync-binlog" class="headerlink" title="sync-binlog"></a>sync-binlog</h4><p><code>sync-binlog</code>æ§åˆ¶å½“äº‹åŠ¡æäº¤ä¹‹åï¼ŒMySQL æ˜¯å¦å°† bin-log åˆ·æ–°åˆ°ç£ç›˜ã€‚å¦‚æœå…¶å€¼ç­‰äº 0 æˆ–è€…å¤§äº 1 æ—¶ï¼Œå½“äº‹åŠ¡æäº¤ä¹‹åï¼ŒMySQL ä¸ä¼šå°† bin-log åˆ·æ–°åˆ°ç£ç›˜ï¼Œå…¶æ€§èƒ½æœ€é«˜ï¼Œä½†å­˜åœ¨çš„é£é™©ä¹Ÿæ˜¯æœ€å¤§çš„ï¼Œå› ä¸ºä¸€æ—¦ç³»ç»Ÿå´©æºƒï¼Œbin-log å°†ä¼šä¸¢å¤±ã€‚è€Œå½“å…¶å€¼ç­‰äº 1 æ—¶ï¼Œæ˜¯æœ€å®‰å…¨çš„ï¼Œè¿™æ—¶å€™å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œæœ€å¤šä¹Ÿå°±ä¸¢å¤±æœ¬æ¬¡æœªå®Œæˆçš„äº‹åŠ¡ï¼Œå¯¹å®é™…çš„æ•°æ®æ²¡æœ‰å®è´¨æ€§çš„å½±å“ï¼Œä½†æ€§èƒ½è¾ƒå·®ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ 5.7.7 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªé€‰æ‹©çš„é»˜è®¤å€¼ä¸º 0ï¼Œè€Œä¹‹åçš„ç‰ˆæœ¬é»˜è®¤å€¼ä¸º 1ï¼Œä¹Ÿå°±æ˜¯æœ€å®‰å…¨çš„ç­–ç•¥ã€‚å¯¹äºé«˜å¹¶å‘çš„æ€§èƒ½ï¼Œéœ€è¦å…³æ³¨è¿™ä¸€ç‚¹ï¼Œé˜²æ­¢ç‰ˆæœ¬å‡çº§åå‡ºç°æ€§èƒ½é—®é¢˜ã€‚</p><p>å‰©ä¸‹çš„ 4 ä¸ªé…ç½®é¡¹å°±æ²¡å¤ªå¤šè¦è¯´çš„ã€‚</p><ul><li>log-errorï¼šç”¨äºé…ç½®é”™è¯¯æ—¥å¿—çš„å­˜æ”¾ç›®å½•</li><li>slow-query-logï¼šæ‰“å¼€æ…¢æ—¥å¿—ï¼Œé»˜è®¤å…³é—­</li><li>slow-query-log-fileï¼šé…ç½®æ…¢æ—¥å¿—çš„å­˜æ”¾ç›®å½•</li><li>log-queries-not-using-indexesï¼šå¦‚æœè¯¥ sql æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œä¼šå°†å…¶å†™å…¥åˆ°æ…¢æ—¥å¿—ï¼Œä½†æ˜¯å¦çœŸçš„æ‰§è¡Œå¾ˆæ…¢ï¼Œéœ€è¦åŒºåˆ†ï¼Œé»˜è®¤å…³é—­ã€‚</li></ul><h4 id="CACHES-AND-LIMITS"><a href="#CACHES-AND-LIMITS" class="headerlink" title="CACHES AND LIMITS"></a>CACHES AND LIMITS</h4><p><strong>tmp-table-size && max-heap-table-size</strong><br>è¿™ä¸¤ä¸ªé…ç½®æ§åˆ¶ä½¿ç”¨ Memory å¼•æ“çš„å†…å­˜ä¸´æ—¶è¡¨å¯ä»¥ä½¿ç”¨å¤šå¤§çš„å†…å­˜ã€‚å¦‚æœéšå¼å†…å­˜ä¸´æ—¶è¡¨çš„å¤§å°è¶…è¿‡è¿™ä¸¤ä¸ªå€¼ï¼Œå°†ä¼šè¢«è½¬ä¸ºç£ç›˜ MyISAM è¡¨ (éšå¼ä¸´æ—¶è¡¨ç”±æœåŠ¡å™¨åˆ›å»ºï¼Œç”¨æˆ·ä¿å­˜æ‰§è¡Œä¸­çš„æŸ¥è¯¢çš„ä¸­é—´ç»“æœ)ã€‚</p><p>å¦‚æœæŸ¥è¯¢è¯­å¥æ²¡æœ‰åˆ›å»ºåºå¤§çš„ä¸´æ—¶è¡¨ (é€šè¿‡åˆç†çš„ç´¢å¼•å’ŒæŸ¥è¯¢è®¾è®¡æ¥é¿å…)ï¼Œå¯ä»¥æŠŠè¿™ä¸ªå€¼è®¾å¤§ä¸€ç‚¹ï¼Œä»¥å…éœ€è¦æŠŠå†…å­˜ä¸´æ—¶è¡¨è½¬æ¢ä¸ºç£ç›˜ä¸´æ—¶è¡¨ã€‚ä½†è¦è°¨é˜²è¿™ä¸ªå€¼è®¾ç½®å¾—è¿‡å¤§ï¼Œå¦‚æœæŸ¥è¯¢ç¡®å®ä¼šåˆ›å»ºå¾ˆå¤§çš„ä¸´æ—¶è¡¨ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ç£ç›˜æ¯”è¾ƒå¥½ï¼Œæ¯•ç«Ÿå¹¶å‘æ•°ä¸€èµ·æ¥ï¼Œæ‰€éœ€è¦çš„å†…å­˜å°±ä¼šæ€¥å‰§å¢é•¿ã€‚</p><p>åº”è¯¥ç®€å•çš„æŠŠè¿™ä¸¤ä¸ªå˜é‡è®¾ä¸ºåŒæ ·çš„å€¼ï¼Œè¿™é‡Œé€‰æ‹©äº† 32Mï¼Œå¯ä»¥é€šè¿‡ä»”ç»†æ£€æŸ¥created-tmp-disk-tableså’Œcreated-tmp-tablesä¸¤ä¸ªå˜é‡æ¥æŒ‡å¯¼ä½ è®¾ç½®ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å€¼å°†å±•ç¤ºä¸´æ—¶è¡¨çš„åˆ›å»ºæœ‰å¤šé¢‘ç¹ã€‚</p><p><strong>max-connections</strong></p><p>ç”¨äºè®¾ç½®ç”¨æˆ·çš„æœ€å¤§è¿æ¥æ•°ï¼Œä¿è¯æœåŠ¡å™¨ä¸ä¼šåº”ä¸ºåº”ç”¨ç¨‹åºæ¿€å¢çš„è¿æ¥è€Œä¸å ªé‡è´Ÿã€‚å¦‚æœåº”ç”¨ç¨‹åºæœ‰é—®é¢˜ï¼Œæˆ–è€…æœåŠ¡å™¨é‡åˆ°è¿æ¥å»¶è¿Ÿé—®é¢˜ï¼Œä¼šåˆ›å»ºå¾ˆå¤šæ–°è¿æ¥ã€‚ä½†å¦‚æœè¿™äº›è¿æ¥ä¸èƒ½æ‰§è¡ŒæŸ¥è¯¢ï¼Œé‚£æ‰“å¼€ä¸€ä¸ªè¿æ¥æ²¡ä»€ä¹ˆå¥½å¤„ï¼Œæ‰€ä»¥è¢« â€œå¤ªå¤šçš„è¿æ¥â€ é”™è¯¯æ‹’ç»æ˜¯ä¸€ç§å¿«é€Ÿè€Œä¸”ä»£ä»·å°çš„å¤±è´¥æ–¹å¼ã€‚</p><p>åœ¨æœåŠ¡å™¨èµ„æºå…è®¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æŠŠ<code>max-connections</code>è®¾ç½®çš„è¶³å¤Ÿå¤§ï¼Œä»¥å®¹çº³æ­£å¸¸å¯èƒ½è¾¾åˆ°çš„è´Ÿè½½ã€‚è‹¥è®¤ä¸ºæ­£å¸¸æƒ…å†µå°†æœ‰ <code>300</code> æˆ–è€…æ›´å¤šè¿æ¥ï¼Œå¯ä»¥è®¾ç½®ä¸º <code>500</code> æˆ–è€…æ›´å¤š (åº”å¯¹é«˜å³°æœŸ)ã€‚é»˜è®¤å€¼æ˜¯ <code>100</code>ï¼Œå¤ªå°äº†ï¼Œè¿™é‡Œè®¾ç½®ä¸º <code>500</code>ï¼Œä½†å¹¶ä¸æ„å‘³ç€å…¶æ˜¯ä¸€ä¸ªåˆç†çš„å€¼ï¼Œåº”è¯¥ç›‘æ§åº”ç”¨æœ‰å¤šå°‘è¿æ¥ï¼Œç„¶åæ ¹æ®ç›‘æ§å€¼ (è§‚å¯Ÿ<code>max_used_connections</code>éšæ—¶é—´çš„å˜åŒ–) æ¥è®¾ç½®ã€‚</p><p><strong>thread-cache-size</strong></p><p>çº¿ç¨‹ç¼“å­˜ä¿å­˜é‚£äº›å½“å‰æ²¡æœ‰ä¸è¿æ¥å…³è”ä½†æ˜¯å‡†å¤‡ä¸ºåé¢æ–°è¿æ¥æœåŠ¡çš„çº¿ç¨‹ã€‚å½“ä¸€ä¸ªæ–°çš„è¿æ¥åˆ›å»ºæ—¶ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰çº¿ç¨‹å­˜åœ¨ï¼ŒMySQL åˆ™ä»ç¼“å­˜ä¸­åˆ é™¤ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”æŠŠå®ƒåˆ†é…ç»™è¿™ä¸ªæ–°è¿æ¥ã€‚å½“è¿æ¥å…³é—­æ—¶ï¼Œå¦‚æœçº¿ç¨‹ç¼“å­˜è¿˜æœ‰ç©ºé—´çš„è¯ï¼ŒMySQL åˆä¼šæŠŠçº¿ç¨‹æ”¾å›ç¼“å­˜ã€‚å¦‚æœæ²¡æœ‰ç©ºé—´çš„è¯ï¼ŒMySQL ä¼šé”€æ¯è¿™ä¸ªçº¿ç¨‹ã€‚åªè¦ MySQL åœ¨ç¼“å­˜é‡Œè¿˜æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œå®ƒå°±å¯ä»¥è¿…é€Ÿå“åº”è¿æ¥è¯·æ±‚ï¼Œå› ä¸ºè¿™æ ·å°±ä¸ç”¨ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºæ–°çº¿ç¨‹ã€‚<code>thread-cache-size</code>æŒ‡å®š MySQL å¯ä»¥ä¿å­˜åœ¨ç¼“å­˜ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚å¦‚æœæœåŠ¡å™¨æ²¡æœ‰å¾ˆå¤šçš„è¿æ¥è¯·æ±‚ï¼Œä¸€èˆ¬ä¸éœ€è¦é…ç½®è¿™ä¸ªå€¼ã€‚</p><p>å¦‚ä½•åˆ¤æ–­è¿™ä¸ªå€¼è¯¥è®¾ç½®å¤šå¤§ï¼Ÿ</p><p>è§‚å¯Ÿthreads-connectedå˜é‡ï¼Œå¦‚æœthreads-connectedåœ¨ 100-120ï¼Œé‚£ä¹ˆthread-cache-sizeè®¾ç½®ä¸º 20ã€‚å¦‚æœå®ƒä¿æŒåœ¨ 500-700ï¼Œ200 çš„çº¿ç¨‹ç¼“å­˜åº”è¯¥è¶³å¤Ÿå¤§äº†ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼šå½“åŒæ—¶æœ‰ 700 ä¸ªè¿æ¥æ—¶ï¼Œå¯èƒ½ç¼“å­˜ä¸­æ²¡æœ‰çº¿ç¨‹ã€‚åœ¨ 500 ä¸ªè¿æ¥æ—¶ï¼Œæœ‰ 200 ä¸ªç¼“å­˜çš„çº¿ç¨‹å‡†å¤‡ä¸ºè´Ÿè½½å†æ¬¡å¢åŠ åˆ° 700 ä¸ªè¿æ¥æ—¶ä½¿ç”¨ã€‚</p><p><strong>open-files-limit</strong></p><p>åœ¨ç±» Uinux ç³»ç»Ÿä¸Šæˆ‘ä»¬æŠŠå®ƒè®¾ç½®å¾—å°½å¯èƒ½å¤§ã€‚ç°ä»£ OS ä¸­æ‰“å¼€å¥æŸ„å¼€é”€éƒ½å¾ˆå°ï¼Œå¦‚æœæ­¤å‚æ•°è®¾ç½®è¿‡å°ï¼Œå¯èƒ½ä¼šé‡åˆ° â€œæ‰“å¼€çš„æ–‡ä»¶å¤ªå¤š (too many open files)â€ é”™è¯¯ã€‚</p><p><strong>table_cache_size</strong></p><p>è¡¨ç¼“å­˜è·Ÿçº¿ç¨‹ç¼“å­˜ç±»ä¼¼ï¼Œä½†å­˜å‚¨çš„å¯¹è±¡æ˜¯è¡¨ï¼Œå…¶åŒ…å«è¡¨. frm æ–‡ä»¶çš„è§£æç»“æœå’Œä¸€äº›å…¶ä»–æ•°æ®ã€‚å‡†ç¡®çš„è¯´ï¼Œç¼“å­˜çš„æ•°æ®ä¾èµ–äºå­˜å‚¨å¼•æ“ï¼Œæ¯”å¦‚ï¼Œå¯¹äº MyISAMï¼Œç¼“å­˜è¡¨çš„æ•°æ®å’Œç´¢å¼•çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¡¨ç¼“å­˜å¯¹ InnoDB çš„å­˜å‚¨å¼•æ“æ¥è¯´ï¼Œé‡è¦æ€§ä¼šå°å¾ˆå¤šï¼Œå› ä¸º InnoDB ä¸ä¾èµ–å®ƒæ¥åšé‚£ä¹ˆå¤šçš„äº‹ã€‚</p><p>ä» 5.1 ç‰ˆæœ¬åŠä»¥åï¼Œè¡¨ç¼“å­˜å°±è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ‰“å¼€è¡¨ç¼“å­˜å’Œå®šä¹‰è¡¨ç¼“å­˜ï¼Œåˆ†åˆ«é€šè¿‡table-open-cache-sizeå’Œtable-definition-cache-sizeå˜é‡æ¥é…ç½®ã€‚é€šå¸¸å¯ä»¥æŠŠtable-definition-cache-sizeè®¾ç½®å¾—è¶³å¤Ÿé«˜ï¼Œä»¥ç¼“å­˜æ‰€æœ‰çš„è¡¨å®šä¹‰ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å­˜å‚¨å¼•æ“éƒ½èƒ½ä»table-definition-cacheè·ç›Šã€‚</p><p><strong>InnoDB</strong></p><p>InnoDB åº”è¯¥æ˜¯ä½¿ç”¨æœ€å¹¿å‘çš„å­˜å‚¨å¼•æ“ï¼Œæœ€é‡è¦çš„é…ç½®é€‰é¡¹æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªï¼šinnodb-buffer-pool-sizeä¸innodb-log-file-sizeï¼Œè§£å†³è¿™ä¸¤ä¸ªé…ç½®åŸºæœ¬ä¸Šå°±è§£å†³äº†çœŸå®åœºæ™¯ä¸‹çš„å¤§éƒ¨åˆ†é…ç½®é—®é¢˜ã€‚</p><p><strong>innodb-buffer-pool-size</strong></p><p>å¦‚æœå¤§éƒ¨åˆ†æ˜¯ InnoDB è¡¨ï¼Œé‚£ä¹ˆ InnoDB ç¼“å†²æ± æˆ–è®¸æ¯”å…¶ä»–ä»»ä½•ä¸œè¥¿éƒ½æ›´éœ€è¦å†…å­˜ï¼ŒInnoDB ç¼“å†²æ± ç¼“å†²çš„æ•°æ®ï¼šç´¢å¼•ã€è¡Œæ•°æ®ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€æ’å…¥ç¼“å†²ã€é”ä»¥åŠå…¶ä»–å†…éƒ¨æ•°æ®ç»“æ„ã€‚InnoDB è¿˜ä½¿ç”¨ç¼“å†²æ± æ¥å¸®åŠ©å»¶è¿Ÿå†™å…¥ï¼Œè¿™æ ·å°±å¯ä»¥åˆå¹¶å¤šä¸ªå†™å…¥æ“ä½œï¼Œç„¶åä¸€èµ·é¡ºåºå†™å…¥ï¼Œæå‡æ€§èƒ½ã€‚æ€»ä¹‹ï¼ŒInnoDB ä¸¥é‡ä¾èµ–ç¼“å†²æ± ï¼Œå¿…é¡»ä¸ºå…¶åˆ†é…è¶³å¤Ÿçš„å†…å­˜ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœæ•°æ®é‡ä¸å¤§ä¸”ä¸ä¼šå¿«é€Ÿå¢é•¿ï¼Œå°±æ²¡æœ‰å¿…è¦ä¸ºç¼“å†²æ± åˆ†é…è¿‡å¤šçš„å†…å­˜ï¼ŒæŠŠç¼“å†²æ± é…ç½®å¾—æ¯”éœ€è¦ç¼“å­˜çš„è¡¨å’Œç´¢å¼•è¿˜è¦å¤§å¾ˆå¤šï¼Œå®é™…ä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚å¾ˆå¤§çš„ç¼“å†²æ± ä¹Ÿä¼šå¸¦æ¥ä¸€äº›æŒ‘æˆ˜ï¼Œä¾‹å¦‚ï¼Œé¢„çƒ­å’Œå…³é—­éƒ½ä¼šèŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚å¦‚æœæœ‰å¾ˆå¤šè„é¡µåœ¨ç¼“å†²æ± é‡Œï¼ŒInnoDB å…³é—­æ—¶å¯èƒ½ä¼šèŠ±å¾ˆé•¿æ—¶é—´æ¥æŠŠè„é¡µå†™å›æ•°æ®æ–‡ä»¶ã€‚è™½ç„¶å¯ä»¥å¿«é€Ÿå…³é—­ï¼Œä½†æ˜¯åœ¨å¯åŠ¨æ—¶éœ€è¦åšæ›´å¤šçš„æ¢å¤å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•åŒæ—¶åŠ é€Ÿå…³é—­å’Œé‡å¯ä¸¤ä¸ªæ“ä½œã€‚å½“æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼“å†²æ± ï¼Œé‡å¯æœåŠ¡éœ€è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼ˆå‡ å°æ—¶æˆ–è€…å‡ å¤©ï¼‰æ¥é¢„çƒ­ï¼Œå°¤å…¶æ˜¯ç£ç›˜å¾ˆæ…¢çš„æ—¶å€™ï¼Œå¦‚æœæƒ³åŠ å¿«é¢„çƒ­æ—¶é—´ï¼Œå¯ä»¥åœ¨é‡å¯åç«‹åˆ»è¿›è¡Œå…¨è¡¨æ‰«ææˆ–è€…ç´¢å¼•æ‰«æï¼ŒæŠŠç´¢å¼•è½½å…¥ç¼“å†²æ± ã€‚</p><p>å¯ä»¥çœ‹åˆ°ç¤ºä¾‹çš„é…ç½®æ–‡ä»¶ä¸­æŠŠè¿™ä¸ªå€¼é…ç½®ä¸º 12Gï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†é…ç½®ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„ç¡¬ä»¶æ¥ä¼°ç®—ã€‚é‚£å¦‚ä½•ä¼°ç®—ï¼Ÿ</p><p>å‰é¢çš„å°èŠ‚ï¼Œæˆ‘ä»¬è¯´åˆ°ï¼ŒMySQL ä¸­æœ€é‡è¦çš„ç¼“å­˜æœ‰ 5 ç§ï¼Œå¯ä»¥ç®€å•çš„ä½¿ç”¨ä¸‹é¢çš„å…¬å¼è®¡ç®—ï¼š</p><p><em><strong>InnoDB ç¼“å†²æ±  = æœåŠ¡å™¨æ€»å†…å­˜ - OS é¢„ç•™ - æœåŠ¡å™¨ä¸Šçš„å…¶ä»–åº”ç”¨å ç”¨å†…å­˜ - MySQL è‡ªèº«éœ€è¦çš„å†…å­˜ - InnoDB æ—¥å¿—æ–‡ä»¶å ç”¨å†…å­˜ - å…¶å®ƒå†…å­˜ (MyISAM é”®ç¼“å­˜ã€æŸ¥è¯¢ç¼“å­˜ç­‰)</strong></em></p><p>å…·ä½“æ¥çœ‹ï¼Œè‡³å°‘éœ€è¦ä¸º OS ä¿ç•™ 1~2G å†…å­˜ï¼Œå¦‚æœæœºå™¨å†…å­˜å¤§çš„è¯å¯ä»¥é¢„ç•™å¤šä¸€äº›ï¼Œå»ºè®® 2GB å’Œæ€»å†…å­˜çš„ 5% ä¸ºåŸºå‡†ï¼Œä»¥è¾ƒå¤§è€…ä¸ºå‡†ï¼Œå¦‚æœæœºå™¨ä¸Šè¿˜è¿è¡Œç€ä¸€äº›å†…å­˜å¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼Œå¤‡ä»½ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ä¸º OS å†é¢„ç•™å¤šä¸€äº›å†…å­˜ã€‚ä¸è¦ä¸º OS ç¼“å­˜å¢åŠ ä»»ä½•å†…å­˜ï¼Œå› ä¸º OS é€šå¸¸ä¼šåˆ©ç”¨æ‰€æœ‰å‰©ä¸‹çš„å†…å­˜æ¥åšæ–‡ä»¶ç¼“å­˜ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿è¡Œ MySQL çš„æœåŠ¡å™¨å¾ˆå°‘ä¼šè¿è¡Œå…¶ä»–åº”ç”¨ç¨‹åºï¼Œä½†å¦‚æœæœ‰çš„è¯ï¼Œè¯·ä¸ºè¿™äº›åº”ç”¨ç¨‹åºé¢„ç•™è¶³å¤Ÿå¤šçš„å†…å­˜ã€‚</p><p>MySQL è‡ªèº«è¿è¡Œè¿˜éœ€è¦ä¸€äº›å†…å­˜ï¼Œä½†é€šå¸¸éƒ½ä¸ä¼šå¤ªå¤§ã€‚éœ€è¦è€ƒè™‘ MySQL æ¯ä¸ªè¿æ¥éœ€è¦çš„å†…å­˜ï¼Œè™½ç„¶æ¯ä¸ªè¿æ¥éœ€è¦çš„å†…å­˜éƒ½å¾ˆå°‘ï¼Œä½†å®ƒè¿˜è¦æ±‚ä¸€ä¸ªåŸºæœ¬é‡çš„å†…å­˜æ¥æ‰§è¡Œä»»ä½•ç»™å®šçš„æŸ¥è¯¢ï¼Œè€Œä¸”æŸ¥è¯¢è¿‡ç¨‹ä¸­è¿˜éœ€è¦ä¸ºæ’åºã€GROUP BY ç­‰æ“ä½œåˆ†é…ä¸´æ—¶è¡¨å†…å­˜ï¼Œå› æ­¤éœ€è¦ä¸ºé«˜å³°æœŸæ‰§è¡Œå¤§é‡çš„æŸ¥è¯¢é¢„ç•™è¶³å¤Ÿçš„å†…å­˜ã€‚è¿™ä¸ªå†…å­˜æœ‰å¤šå¤§ï¼Ÿåªèƒ½åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç›‘æ§ã€‚</p><p>å¦‚æœå¤§éƒ¨åˆ†è¡¨éƒ½æ˜¯ InnoDBï¼ŒMyISAM é”®ç¼“å­˜é…ç½®ä¸€ä¸ªå¾ˆå°å€¼è¶³çŸ£ï¼ŒæŸ¥è¯¢ç¼“å­˜ä¹Ÿå»ºè®®å…³é—­ã€‚</p><p>å…¬å¼ä¸­å°±å‰©ä¸‹ InnoDB æ—¥å¿—æ–‡ä»¶äº†ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è¯´çš„ã€‚</p><p><strong>innodb-log-file-size && innodb-log-files-in-group</strong></p><p>å¦‚æœå¯¹ InnoDB æ•°æ®è¡¨æœ‰å¤§é‡çš„å†™å…¥æ“ä½œï¼Œé‚£ä¹ˆé€‰æ‹©åˆé€‚çš„innodb-log-file-sizeå€¼å¯¹æå‡ MySQL æ€§èƒ½å¾ˆé‡è¦ã€‚InnoDB ä½¿ç”¨æ—¥å¿—æ¥å‡å°‘æäº¤äº‹åŠ¡æ—¶çš„å¼€é”€ã€‚æ—¥å¿—ä¸­è®°å½•äº†äº‹åŠ¡ï¼Œå°±æ— é¡»åœ¨æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶æŠŠç¼“å†²æ± çš„è„å— (ç¼“å­˜ä¸­ä¸ç£ç›˜ä¸Šæ•°æ®ä¸ä¸€è‡´çš„é¡µ) åˆ·æ–°åˆ°ç£ç›˜ã€‚äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®å’Œç´¢å¼•é€šå¸¸ä¼šæ˜ å°„åˆ°è¡¨ç©ºé—´çš„éšæœºä½ç½®ï¼Œæ‰€ä»¥åˆ·æ–°è¿™äº›å˜æ›´åˆ°ç£ç›˜éœ€è¦å¾ˆå¤šéšæœº I/Oã€‚ä¸€æ—¦æ—¥å¿—å®‰å…¨çš„å†™å…¥ç£ç›˜ï¼Œäº‹åŠ¡å°±æŒä¹…åŒ–äº†ï¼Œå³ä½¿å˜æ›´è¿˜æ²¡æœ‰å†™åˆ°æ•°æ®æ–‡ä»¶ï¼Œåœ¨ä¸€äº›æ„å¤–æƒ…å†µå‘ç”Ÿæ—¶ (æ¯”å¦‚æ–­ç”µäº†)ï¼ŒInnoDB å¯ä»¥é‡æ”¾æ—¥å¿—å¹¶ä¸”æ¢å¤å·²ç»æäº¤çš„äº‹åŠ¡ã€‚</p><p>InnoDB ä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹æ™ºèƒ½åœ°åˆ·æ–°è¿™äº›å˜æ›´åˆ°æ•°æ®æ–‡ä»¶ã€‚å®é™…ä¸Šï¼Œäº‹åŠ¡æ—¥å¿—æŠŠæ•°æ®æ–‡ä»¶çš„éšæœº I/O è½¬æ¢ä¸ºå‡ ä¹é¡ºåºåœ°æ—¥å¿—æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶ I/Oï¼Œè®©åˆ·æ–°æ“ä½œåœ¨åå°å¯ä»¥æ›´å¿«çš„å®Œæˆï¼Œå¹¶ä¸”ç¼“å­˜ I/O å‹åŠ›ã€‚</p><p>æ•´ä½“çš„æ—¥å¿—æ–‡ä»¶å¤§å°å—æ§äº<code>innodb-log-file-size</code>å’Œ<code>innodb-log-files-in-group</code>ä¸¤ä¸ªå‚æ•°ï¼Œè¿™å¯¹å†™æ€§èƒ½éå¸¸é‡è¦ã€‚æ—¥å¿—æ–‡ä»¶çš„æ€»å¤§å°æ˜¯æ¯ä¸ªæ–‡ä»¶çš„å¤§å°ä¹‹å’Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ª 5M çš„æ–‡ä»¶ï¼Œæ€»å…± 10Mï¼Œå¯¹é«˜æ€§èƒ½å·¥ä½œæ¥è¯´å¤ªå°äº†ï¼Œè‡³å°‘éœ€è¦å‡ ç™¾ M æˆ–è€…ä¸Š G çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™é‡Œè¦æ³¨æ„<code>innodb-log-files-in-group</code>è¿™ä¸ªå‚æ•°ï¼Œå®ƒæ§åˆ¶æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼Œä»åå­—ä¸Šçœ‹å¥½ä¼¼é…ç½®ä¸€ä¸ªæ—¥å¿—ç»„æœ‰å‡ ä¸ªæ–‡ä»¶ï¼Œå®é™…ä¸Šï¼Œlog groupè¡¨ç¤ºä¸€ä¸ªé‡åšæ—¥å¿—çš„æ–‡ä»¶é›†åˆï¼Œæ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰å¿…è¦é…ç½®æœ‰å¤šå°‘ä¸ªæ—¥å¿—ç»„ã€‚</p><p>ä¿®æ”¹æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œéœ€è¦å®Œå…¨å…³é—­ MySQLï¼Œç„¶åå°†æ—§çš„æ—¥å¿—æ–‡ä»¶è¿ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œé‡æ–°é…ç½®å‚æ•°ï¼Œç„¶åé‡å¯ã€‚é‡å¯æ—¶éœ€è¦å°†æ—§çš„æ—¥å¿—è¿ç§»å›æ¥ï¼Œç„¶åç­‰å¾… MySQL æ¢å¤æ•°æ®åï¼Œå†åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œè¯·ä¸€å®šè¦æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¡®è®¤ MySQL é‡å¯æˆåŠŸåå†åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ã€‚</p><p>æƒ³è¦ç¡®å®šç†æƒ³çš„æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œéœ€è¦æƒè¡¡æ­£å¸¸æ•°æ®å˜æ›´çš„å¼€é”€ï¼Œä»¥åŠå´©æºƒæ—¶æ¢å¤éœ€è¦çš„æ—¶é—´ã€‚å¦‚æœæ—¥å¿—å¤ªå°ï¼ŒInnoDB å°†å¿…é¡»è¦åšæ›´å¤šçš„æ£€æŸ¥ç‚¹ï¼Œå¯¼è‡´æ›´å¤šçš„æ—¥å¿—å†™ï¼Œåœ¨æä¸ªåˆ«æƒ…å†µä¸‹ï¼Œå†™è¯­å¥è¿˜ä¼šè¢«æ‹–ç´¯ï¼Œåœ¨æ—¥å¿—æ²¡æœ‰ç©ºé—´ç»§ç»­å†™å…¥å‰ï¼Œå¿…é¡»ç­‰å¾…å˜æ›´è¢«åˆ·æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ—¥å¿—å¤ªå¤§ï¼Œåœ¨å´©æºƒæ—¶æ¢å¤å°±å¾—åšå¤§é‡çš„å·¥ä½œï¼Œè¿™å¯èƒ½å¢å¤§æ¢å¤æ—¶é—´ã€‚InnoDB ä¼šé‡‡ç”¨ checkpoint æœºåˆ¶æ¥åˆ·æ–°å’Œæ¢å¤æ•°æ®ï¼Œè¿™ä¼šåŠ å¿«æ¢å¤æ•°æ®çš„æ—¶é—´ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š</p><ul><li><a href="http://www.cnblogs.com/cuisi/p/6590281.html" target="_blank" rel="noopener">MySQL-checkpoint æŠ€æœ¯</a></li><li><a href="https://www.xaprb.com/blog/2011/01/29/how-innodb-performs-a-checkpoint/" target="_blank" rel="noopener">How InnoDB performs a checkpoint</a></li></ul><p><strong>innodb-flush-log-at-trx-commit</strong></p><p>å‰é¢è®¨è®ºäº†å¾ˆå¤šç¼“å­˜ï¼ŒInnoDB æ—¥å¿—ä¹Ÿæ˜¯æœ‰ç¼“å­˜çš„ã€‚å½“ InnoDB å˜æ›´ä»»ä½•æ•°æ®æ—¶ï¼Œä¼šå†™ä¸€æ¡å˜æ›´è®°å½•åˆ°æ—¥å¿—ç¼“å­˜åŒºã€‚åœ¨ç¼“å†²æ…¢çš„æ—¶å€™ã€äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œæˆ–è€…æ¯ä¸€ç§’é’Ÿï¼ŒInnoDB éƒ½ä¼šå°†ç¼“å†²åŒºçš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœæœ‰å¤§äº‹åŠ¡ï¼Œå¢åŠ æ—¥å¿—ç¼“å†²åŒºå¤§å°å¯ä»¥å¸®åŠ©å‡å°‘ I/Oï¼Œå˜é‡innodb-log-buffer-sizeå¯ä»¥æ§åˆ¶æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°ã€‚é€šå¸¸ä¸éœ€è¦æŠŠæ—¥å¿—ç¼“å†²åŒºè®¾ç½®çš„éå¸¸å¤§ï¼Œæ¯•ç«Ÿä¸Šè¿° 3 ä¸ªæ¡ä»¶ï¼Œä»»ä¸€æ¡ä»¶å…ˆè§¦å‘éƒ½ä¼šæŠŠç¼“å†²åŒºçš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ‰€ä»¥ç¼“å†²åŒºçš„æ•°æ®è‚¯å®šä¸ä¼šå¤ªå¤šï¼Œå‡ºå…¥ä½ çš„æ•°æ®ä¸­æœ‰å¾ˆå¤šç›¸å½“å¤§çš„ BLOB è®°å½•ã€‚é€šå¸¸æ¥è¯´ï¼Œé…ç½® 1M~8M å³å¯ã€‚</p><p>æ—¢ç„¶å­˜åœ¨ç¼“å†²åŒºï¼Œæ€æ ·åˆ·æ–°æ—¥å¿—ç¼“å†²å°±æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚æ—¥å¿—ç¼“å†²å¿…é¡»åˆ·æ–°åˆ°ç£ç›˜ï¼Œä»¥ç¡®ä¿æäº¤çš„äº‹åŠ¡å®Œå…¨è¢«æŒä¹…åŒ–ã€‚å¦‚æœå’ŒæŒä¹…åŒ–ç›¸æ¯”ï¼Œæ›´åœ¨ä¹æ€§èƒ½ï¼Œå¯ä»¥ä¿®æ”¹ innodb-flush-log-at-trx-commit å˜é‡æ¥æ§åˆ¶æ—¥å¿—ç¼“å†²åˆ·æ–°çš„é¢‘ç‡ã€‚</p><ul><li>0ï¼šæ¯ 1 ç§’é’Ÿå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶å¹¶åˆ·æ–°åˆ°ç£ç›˜ï¼Œäº‹åŠ¡æäº¤æ—¶ä¸åšä»»ä½•å¤„ç†</li><li>1ï¼šæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶å¹¶åˆ·æ–°åˆ°ç£ç›˜</li><li>2ï¼šæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åæ¯ç§’åˆ·æ–°ä¸€æ¬¡åˆ°ç£ç›˜</li></ul><blockquote><p>1  æ˜¯æœ€å®‰å…¨çš„è®¾ç½®ï¼Œä¿è¯ä¸ä¼šä¸¢å¤±ä»»ä½•å·²ç»æäº¤çš„äº‹åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„è®¾ç½®ã€‚</p></blockquote><blockquote><p>0 å’Œ 2 æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œå¦‚æœ MySQL æŒ‚äº†ï¼Œ2 ä¸ä¼šä¸¢å¤±äº‹åŠ¡ï¼Œä½† 0 æœ‰å¯èƒ½ï¼Œ</p></blockquote><blockquote><p>2 åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œè‡³å°‘å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œè€Œ 0 åˆ™ä¸ä¼šã€‚å¦‚æœæ•´ä¸ªæœåŠ¡å™¨æŒ‚äº†æˆ–è€…æ–­ç”µäº†ï¼Œåˆ™è¿˜æ˜¯å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›äº‹åŠ¡ã€‚</p></blockquote><p><strong>innodb-flush-method</strong></p><p>å‰é¢éƒ½åœ¨è®¨è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„ç­–ç•¥åˆ·æ–°ã€ä»¥åŠä½•æ—¶åˆ·æ–°æ—¥å¿—æˆ–è€…æ•°æ®ï¼Œé‚£ InnoDB å…·ä½“æ˜¯æ€æ ·åˆ·æ–°æ•°æ®çš„ï¼Ÿä½¿ç”¨innodb-flush-methodé€‰é¡¹å¯ä»¥é…ç½® InnoDB å¦‚ä½•è·Ÿæ–‡ä»¶ç³»ç»Ÿç›¸äº’ä½œç”¨ã€‚ä»åå­—ä¸Šçœ‹ï¼Œä¼šä»¥ä¸ºåªèƒ½å½±å“ InnoDB æ€ä¹ˆå†™æ•°æ®ï¼Œå®é™…ä¸Šè¿˜å½±å“äº† InnoDB Windows å’Œé Windows æ“ä½œç³»ç»Ÿä¸‹è¿™ä¸ªé€‰é¡¹çš„å€¼æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº›å€¼åªèƒ½ Windows ä¸‹ä½¿ç”¨ï¼Œæœ‰äº›åªèƒ½åœ¨é Windows ä¸‹ä½¿ç”¨ï¼Œå…¶ä¸­ Windows ä¸‹å¯å–å€¼ï¼šasync_unbufferedã€unbufferedã€normalã€Nosyncä¸littlesyncï¼Œé Windows å–å€¼ï¼šfdatasyncã€0_DIRECTã€ 0_DSYNCã€‚</p><p>è¿™ä¸ªé€‰é¡¹æ—¢ä¼šå½±å“æ—¥å¿—æ–‡ä»¶ï¼Œä¹Ÿä¼šå½±å“æ•°æ®æ–‡ä»¶ï¼Œè€Œä¸”æœ‰æ—¶å€™å¯¹ä¸åŒç±»å‹çš„æ–‡ä»¶çš„å¤„ç†ä¹Ÿä¸ä¸€æ ·ï¼Œå¯¼è‡´è¿™ä¸ªé€‰é¡¹æœ‰äº›éš¾ä»¥ç†è§£ã€‚å¦‚æœæœ‰ä¸€ä¸ªé€‰é¡¹æ¥é…ç½®æ—¥å¿—æ–‡ä»¶ï¼Œä¸€ä¸ªé€‰é¡¹æ¥é…ç½®æ•°æ®æ–‡ä»¶ï¼Œåº”è¯¥ä¼šæ›´å¥½ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ··åˆåœ¨åŒä¸€ä¸ªé…ç½®é¡¹ä¸­ã€‚è¿™é‡Œåªä»‹ç»ç±» Unix æ“ä½œç³»ç»Ÿä¸‹çš„é€‰é¡¹ã€‚</p><p><strong>fdatasync</strong></p><p>InnoDB è°ƒç”¨fsync()å’Œfdatasync()å‡½æ•°æ¥åˆ·æ–°æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶ï¼Œå…¶ä¸­fdatasync()åªåˆ·æ–‡ä»¶çš„æ•°æ®ï¼Œä½†ä¸åŒ…å«å…ƒæ•°æ® (æ¯”å¦‚ï¼šè®¿é—®æƒé™ã€æ–‡ä»¶æ‹¥æœ‰è€…ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰æè¿°æ–‡ä»¶ç‰¹å¾çš„ç³»ç»Ÿæ•°æ®)ï¼Œå› æ­¤fsync()ç›¸æ¯”fdatasync()ä¼šäº§ç”Ÿæ›´å¤šçš„ I/Oï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹fdatasync()ä¼šå¯¼è‡´æ•°æ®æŸåï¼Œå› æ­¤ InnoDB å¼€å‘è€…å†³å®šç”¨fsync()æ¥ä»£æ›¿fdatasync()ã€‚</p><p>fsync()çš„ç¼ºç‚¹æ˜¯æ“ä½œç³»ç»Ÿä¼šåœ¨è‡ªå·±çš„ç¼“å­˜ä¸­ç¼“å†²ä¸€äº›æ•°æ®ï¼Œç†è®ºä¸ŠåŒé‡ç¼“å†²æ˜¯æµªè´¹çš„ï¼Œå› ä¸º InnoDB è‡ªå·±ä¼šç®¡ç†ç¼“å†²ï¼Œè€Œä¸”æ¯”æ“ä½œç³»ç»Ÿæ›´åŠ æ™ºèƒ½ã€‚ä½†å¦‚æœæ–‡ä»¶ç³»ç»Ÿèƒ½æœ‰æ›´æ™ºèƒ½çš„ I/O è°ƒåº¦å’Œæ‰¹é‡æ“ä½œï¼ŒåŒé‡ç¼“å†²ä¹Ÿå¹¶ä¸ä¸€å®šæ˜¯åäº‹ï¼š</p><ul><li>æœ‰çš„æ–‡ä»¶ç³»ç»Ÿå’Œ os å¯ä»¥ç´¯ç§¯å†™æ“ä½œååˆå¹¶æ‰§è¡Œï¼Œé€šè¿‡å¯¹ I/O çš„é‡æ’åºæ¥æå‡æ•ˆç‡ã€æˆ–è€…å¹¶å‘å†™å…¥å¤šä¸ªè®¾å¤‡</li><li>æœ‰çš„è¿˜å¯ä»¥åšé¢„è¯»ä¼˜åŒ–ï¼Œæ¯”å¦‚è¿ç»­è¯·æ±‚å‡ ä¸ªé¡ºåºçš„å—ï¼Œå®ƒä¼šé€šçŸ¥ç¡¬ç›˜é¢„è¯»ä¸‹ä¸€ä¸ªå—</li></ul><p>è¿™äº›ä¼˜åŒ–åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹æ‰ä¼šèµ·ä½œç”¨ï¼Œfdatasyncä¸ºinnodb-flush-methodçš„é»˜è®¤å€¼ã€‚</p><p><strong>0_DIRCET</strong></p><p>è¿™ä¸ªè®¾ç½®ä¸å½±å“æ—¥å¿—æ–‡ä»¶å¹¶ä¸”ä¸æ˜¯æ‰€æœ‰çš„ç±» Unix ç³»ç»Ÿéƒ½æœ‰æ•ˆï¼Œä½†è‡³å°‘åœ¨ Linuxã€FreeBSD ä»¥åŠ Solaris æ˜¯æ”¯æŒçš„ã€‚è¿™ä¸ªè®¾ç½®ä¾ç„¶ä½¿ç”¨ fsync æ¥åˆ·æ–°æ–‡ä»¶åˆ°ç£ç›˜ï¼Œä½†æ˜¯å®ƒå®Œå…¨å…³é—­äº†æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œå¹¶ä¸”æ˜¯æ‰€æœ‰çš„è¯»å’Œå†™éƒ½ç›´æ¥é€šè¿‡å­˜å‚¨è®¾ç½®ï¼Œé¿å…äº†åŒé‡ç¼“å†²ã€‚å¦‚æœå­˜å‚¨è®¾å¤‡æ”¯æŒå†™ç¼“å†²æˆ–é¢„è¯»ï¼Œé‚£ä¹ˆè¿™ä¸ªé€‰é¡¹å¹¶ä¸ä¼šå½±å“åˆ°è®¾å¤‡çš„è®¾ç½®ï¼Œæ¯”å¦‚ RAID å¡ã€‚</p><p><strong>0_DSYNC</strong></p><p>è¿™ä¸ªé€‰é¡¹ä½¿å¾—æ‰€æœ‰çš„å†™åŒæ­¥ï¼Œå³åªæœ‰æ•°æ®å†™åˆ°ç£ç›˜åå†™æ“ä½œæ‰è¿”å›ï¼Œä½†å®ƒåªå½±å“æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸å½±å“æ•°æ®æ–‡ä»¶ã€‚</p><p>è¯´å®Œäº†æ¯ä¸ªé…ç½®çš„ä½œç”¨ï¼Œæœ€åæ˜¯ä¸€äº›å»ºè®®ï¼šå¦‚æœä½¿ç”¨ç±» Unix æ“ä½œç³»ç»Ÿå¹¶ä¸” RAID æ§åˆ¶å™¨å¸¦æœ‰ç”µæ± ä¿æŠ¤çš„å†™ç¼“å­˜ï¼Œå»ºè®®ä½¿ç”¨ 0_DIRECTï¼Œå¦‚æœä¸æ˜¯ï¼Œé»˜è®¤å€¼æˆ–è€… 0_DIRECT éƒ½å¯èƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p><p><strong>innodb-file-per-table</strong></p><p>æœ€åä¸€ä¸ªé…ç½®ï¼Œè¯´è¯´ InnoDB è¡¨ç©ºé—´ï¼ŒInnoDB æŠŠæ•°æ®ä¿å­˜åœ¨è¡¨ç©ºé—´å†…ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªç£ç›˜æ–‡ä»¶ç»„æˆçš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚InnoDB è¡¨ç©ºé—´å¹¶ä¸åªæ˜¯å­˜å‚¨è¡¨å’Œç´¢å¼•ï¼Œå®ƒè¿˜ä¿å­˜äº†å›æ»šæ—¥å¿—ã€æ’å…¥ç¼“å†²ã€åŒå†™ç¼“å†²ä»¥åŠå…¶ä»–å†…éƒ¨æ•°æ®ç»“æ„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¡¨ç©ºé—´è¿˜å®ç°äº†å¾ˆå¤šå…¶å®ƒçš„åŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡ innodb-data-file-path é…ç½®é¡¹å®šåˆ¶è¡¨ç©ºé—´æ–‡ä»¶ï¼Œinnodb-data-home-diré…ç½®è¡¨ç©ºé—´æ–‡ä»¶å­˜æ”¾çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb-data-home-dir = /var/lib/mysql</span><br><span class="line">innodb-data-file-path = ibdata1:1G;ibdata2:1G;ibdata3:1G</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™é‡Œåœ¨ 3 ä¸ªæ–‡ä»¶ä¸­åˆ›å»ºäº† 3G è¡¨ç©ºé—´ï¼Œä¸ºäº†å…è®¸è¡¨ç©ºé—´åœ¨è¶…è¿‡äº†åˆ†é…çš„ç©ºé—´æ—¶è¿˜èƒ½å¢é•¿ï¼Œå¯ä»¥åƒè¿™æ ·é…ç½®æœ€åä¸€ä¸ªæ–‡ä»¶è‡ªåŠ¨æ‰©å±•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb-data-file-path = ibdata1:1G;ibdata2:1G;ibdata3:1G:autoextend</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>innodb-file-per-table</code>é€‰é¡¹è®© InnoDB ä¸ºæ¯å¼ è¡¨ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä½¿å¾—åœ¨åˆ é™¤ä¸€å¼ è¡¨æ—¶å›æ”¶ç©ºé—´å®¹æ˜“å¾ˆå¤šï¼Œè€Œä¸”ç‰¹åˆ«å®¹æ˜“ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡ä»¶å¤§å°æ¥ç¡®å®šè¡¨å¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®æ‰“å¼€è¿™ä¸ªé…ç½®ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>MySQL æœ‰å¤ªå¤šçš„é…ç½®é¡¹ï¼Œè¿™é‡Œæ²¡æœ‰åŠæ³•ä¸€ä¸€åˆ—ä¸¾ï¼Œé‡è¦çš„æ˜¯äº†è§£æ¯ä¸ªé…ç½®çš„å·¥ä½œåŸç†ï¼Œä»ä¸€ä¸ªåŸºç¡€é…ç½®æ–‡ä»¶å¼€å§‹ï¼Œè®¾ç½®ç¬¦åˆæœåŠ¡å™¨è½¯ç¡¬ä»¶ç¯å¢ƒä¸å·¥ä½œè´Ÿè½½çš„åŸºæœ¬é€‰é¡¹ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ)</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL ä¼˜åŒ–åŸç†(äºŒ)</title>
    <link href="https://jiemin.wang/2019/03/29/mysql-optimization-principle-2/"/>
    <id>https://jiemin.wang/2019/03/29/mysql-optimization-principle-2/</id>
    <published>2019-03-29T06:57:26.000Z</published>
    <updated>2019-03-29T09:52:11.444Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="img.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æˆ‘æ‰“ä½ åº”è¯¥ï¼Œä¸æ‰“ä½ æ‚²å“€~</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¦‚æœæœ‰åŒå­¦çœ‹å®Œ<a href="https://jiemin.wang/2019/03/29/mysql-optimization-principle-1/">ä¸Šä¸€ç¯‡å…³äº MySQL æ–‡ç« </a>ï¼Œæ–‡æœ«ç•™æœ‰ä¸¤ä¸ªå¾ˆå¼€æ”¾çš„é—®é¢˜ï¼Œå¦‚æœ‰å…´è¶£å¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ã€‚æœ¬æ–‡ä¹Ÿä¼šè¯•ç€å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå¸Œæœ›èƒ½ç»™ä½ ä¸€äº›å‚è€ƒã€‚ç°åœ¨å¯ä»¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡éå¸¸å¤§çš„æƒ…å†µä¸‹ï¼Œæ‚¨æ ¹æ®ä¸šåŠ¡é€‰æ‹©äº†åˆé€‚çš„å­—æ®µï¼Œç²¾å¿ƒè®¾è®¡äº†è¡¨å’Œç´¢å¼•ï¼Œè¿˜ä»”ç»†çš„æ£€æŸ¥äº†æ‰€æœ‰çš„ SQLï¼Œå¹¶ç¡®è®¤å·²ç»æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ€§èƒ½ä»ç„¶ä¸èƒ½æ»¡è¶³æ‚¨çš„è¦æ±‚ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿˜æœ‰å…¶ä»–ä¼˜åŒ–ç­–ç•¥å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¥ä¸‹æ¥ç»§ç»­å’Œæ‚¨è®¨è®ºä¸€äº›å¸¸ç”¨çš„ MySQL é«˜çº§ç‰¹æ€§ä»¥åŠå…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚</p><h4 id="åˆ†åŒºè¡¨"><a href="#åˆ†åŒºè¡¨" class="headerlink" title="åˆ†åŒºè¡¨"></a>åˆ†åŒºè¡¨</h4><p>åˆç†çš„ä½¿ç”¨ç´¢å¼•å¯ä»¥æå¤§æå‡ MySQL çš„æŸ¥è¯¢æ€§èƒ½ï¼Œä½†å¦‚æœå•è¡¨æ•°æ®é‡è¾¾åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œç´¢å¼•å°±æ— æ³•èµ·ä½œç”¨ï¼Œå› ä¸ºåœ¨æ•°æ®é‡è¶…å¤§çš„æƒ…å†µä¸‹ï¼Œé™¤éè¦†ç›–ç´¢å¼•ï¼Œå› å›è¡¨æŸ¥è¯¢ä¼šäº§ç”Ÿå¤§é‡çš„éšæœº I/Oï¼Œæ•°æ®åº“çš„å“åº”æ—¶é—´å¯èƒ½ä¼šè¾¾åˆ°ä¸å¯æ¥å—çš„ç¨‹åº¦ã€‚è€Œä¸”ç´¢å¼•ç»´æŠ¤ï¼ˆç£ç›˜ç©ºé—´ã€I/O æ“ä½œï¼‰çš„ä»£ä»·ä¹Ÿä¼šéå¸¸å¤§ã€‚</p><p>å› æ­¤ï¼Œå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼ˆåœ¨ MySQL4.x æ—¶ä»£ï¼ŒMyISAM å­˜å‚¨å¼•æ“ä¸šå†…å…¬è®¤çš„æ€§èƒ½æ‹ç‚¹æ˜¯ 500W è¡Œï¼ŒMySQL5.x æ—¶ä»£çš„æ€§èƒ½æ‹ç‚¹åˆ™ä¸º 1KW ~ 2KW è¡Œçº§åˆ«ï¼Œå…·ä½“éœ€æ ¹æ®å®é™…æƒ…å†µæµ‹è¯•ï¼‰ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œæœ€ä¸ºå¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯åˆ†è¡¨ã€‚åˆ†è¡¨çš„ç­–ç•¥å¯ä»¥æ˜¯å‚ç›´æ‹†åˆ†ï¼ˆæ¯”å¦‚ï¼šä¸åŒè®¢å•çŠ¶æ€çš„è®¢å•æ‹†åˆ†åˆ°ä¸åŒçš„è¡¨ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ°´å¹³æ‹†åˆ†ï¼ˆæ¯”å¦‚ï¼šæŒ‰æœˆå°†è®¢å•æ‹†åˆ†åˆ°ä¸åŒè¡¨ï¼‰ã€‚ä½†æ€»çš„æ¥è¯´ï¼Œåˆ†è¡¨å¯ä»¥çœ‹ä½œæ˜¯ä»ä¸šåŠ¡è§’åº¦æ¥è§£å†³å¤§æ•°æ®é‡é—®é¢˜ï¼Œå®ƒåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æå‡æ€§èƒ½ï¼Œä½†ä¹Ÿå¤§å¤§æå‡äº†ç¼–ç çš„å¤æ‚åº¦ï¼Œæœ‰è¿‡è¿™ç§ç»å†çš„åŒå­¦å¯èƒ½æ·±æœ‰ä½“ä¼šã€‚</p><p>åœ¨ä¸šåŠ¡å±‚åˆ†è¡¨å¤§å¤§å¢åŠ äº†ç¼–ç çš„å¤æ‚ç¨‹åº¦ï¼Œè€Œä¸”å¤„ç†æ•°æ®åº“çš„ç›¸å…³ä»£ç ä¼šå¤§é‡æ•£è½åœ¨åº”ç”¨å„å¤„ï¼Œç»´æŠ¤å›°éš¾ã€‚é‚£æ˜¯å¦å¯ä»¥å°†åˆ†è¡¨çš„é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼Œç»Ÿä¸€å¤„ç†ï¼Œè¿™æ ·ä¸šåŠ¡å±‚å°±ä¸ç”¨å…³å¿ƒåº•å±‚æ˜¯å¦åˆ†è¡¨ï¼Œåªéœ€è¦ä¸“æ³¨åœ¨ä¸šåŠ¡å³å¯ã€‚ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œç›®å‰æœ‰éå¸¸å¤šçš„æ•°æ®åº“ä¸­é—´ä»¶éƒ½å¯ä»¥å±è”½åˆ†è¡¨åçš„ç»†èŠ‚ï¼Œè®©ä¸šåŠ¡å±‚åƒæŸ¥è¯¢å•è¡¨ä¸€æ ·æŸ¥è¯¢åˆ†è¡¨åçš„æ•°æ®ã€‚å¦‚æœå†å°†æŠ½è±¡çš„é€»è¾‘ä¸‹ç§»åˆ°æ•°æ®åº“çš„æœåŠ¡å±‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„åˆ†åŒºè¡¨ã€‚</p><p>åˆ†åŒºå¯ä»¥çœ‹ä½œæ˜¯ä»æŠ€æœ¯å±‚é¢è§£å†³å¤§æ•°æ®é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ï¼Œç®€å•çš„ç†è§£ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ MySQL åº•å±‚å¸®æˆ‘ä»¬å®ç°åˆ†è¡¨ï¼Œåˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘è¡¨ï¼Œåº•å±‚ç”±å¤šä¸ªç‰©ç†å­è¡¨ç»„æˆã€‚å­˜å‚¨å¼•æ“ç®¡ç†åˆ†åŒºçš„å„ä¸ªåº•å±‚è¡¨å’Œç®¡ç†æ™®é€šè¡¨ä¸€æ ·ï¼ˆæ‰€æœ‰åº•å±‚è¡¨å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ï¼‰ï¼Œåˆ†åŒºè¡¨çš„ç´¢å¼•ä¹Ÿæ˜¯åœ¨å„ä¸ªåº•å±‚è¡¨ä¸Šå„è‡ªåŠ ä¸Šä¸€ä¸ªå®Œå…¨ç›¸åŒçš„ç´¢å¼•ã€‚ä»å­˜å‚¨å¼•æ“çš„è§’åº¦æ¥çœ‹ï¼Œåº•å±‚è¡¨å’Œæ™®é€šè¡¨æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œå­˜å‚¨å¼•æ“ä¹Ÿæ— é¡»çŸ¥é“ã€‚åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®åˆ†åŒºçš„å®šä¹‰è¿‡æ»¤é‚£äº›æ²¡æœ‰æˆ‘ä»¬éœ€è¦æ•°æ®çš„åˆ†åŒºï¼Œè¿™æ ·æŸ¥è¯¢å°±æ— éœ€æ‰«ææ‰€æœ‰åˆ†åŒºï¼Œåªéœ€è¦æŸ¥æ‰¾åŒ…å«éœ€è¦æ•°æ®çš„åˆ†åŒºå°±å¯ä»¥äº†ã€‚</p><p>æ›´å¥½çš„ç†è§£åˆ†åŒºè¡¨ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªç¤ºä¾‹å…¥æ‰‹ï¼šä¸€å¼ è®¢å•è¡¨ï¼Œæ•°æ®é‡å¤§æ¦‚æœ‰ 10TBï¼Œå¦‚ä½•è®¾è®¡æ‰èƒ½ä½¿æ€§èƒ½è¾¾åˆ°æœ€ä¼˜ï¼Ÿ</p><p>é¦–å…ˆå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œå› ä¸ºæ•°æ®é‡å·¨å¤§ï¼Œè‚¯å®šä¸èƒ½èµ°å…¨è¡¨æ‰«æã€‚ä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œä½ ä¼šå‘ç°æ•°æ®å¹¶ä¸æ˜¯æŒ‰ç…§æƒ³è¦çš„æ–¹å¼èšé›†ï¼Œè€Œä¸”ä¼šäº§ç”Ÿå¤§é‡çš„ç¢ç‰‡ï¼Œæœ€ç»ˆä¼šå¯¼è‡´ä¸€ä¸ªæŸ¥è¯¢äº§ç”Ÿæˆåƒä¸Šä¸‡çš„éšæœº I/Oï¼Œåº”ç”¨éšä¹‹åƒµæ­»ã€‚æ‰€ä»¥éœ€è¦é€‰æ‹©ä¸€äº›æ›´ç²—ç²’åº¦å¹¶ä¸”æ¶ˆè€—æ›´å°‘çš„æ–¹å¼æ¥æ£€ç´¢æ•°æ®ã€‚æ¯”å¦‚å…ˆæ ¹æ®ç´¢å¼•æ‰¾åˆ°ä¸€å¤§å—æ•°æ®ï¼Œç„¶åå†åœ¨è¿™å—æ•°æ®ä¸Šé¡ºåºæ‰«æã€‚</p><p>è¿™æ­£æ˜¯åˆ†åŒºè¦åšçš„äº‹æƒ…ï¼Œç†è§£åˆ†åŒºæ—¶è¿˜å¯ä»¥å°†å…¶å½“ä½œç´¢å¼•çš„æœ€åˆå½¢æ€ï¼Œä»¥ä»£ä»·éå¸¸å°çš„æ–¹å¼å®šä½åˆ°éœ€è¦çš„æ•°æ®åœ¨å“ªä¸€ç‰‡ â€œåŒºåŸŸâ€ï¼Œåœ¨è¿™ç‰‡ â€œåŒºåŸŸâ€ ä¸­ï¼Œä½ å¯ä»¥é¡ºåºæ‰«æï¼Œå¯ä»¥å»ºç´¢å¼•ï¼Œè¿˜å¯ä»¥å°†æ•°æ®éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚å› ä¸ºåˆ†åŒºæ— é¡»é¢å¤–çš„æ•°æ®ç»“æ„è®°å½•æ¯ä¸ªåˆ†åŒºæœ‰å“ªäº›æ•°æ®ï¼Œæ‰€ä»¥å…¶ä»£ä»·éå¸¸ä½ã€‚åªéœ€è¦ä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼å°±å¯ä»¥è¡¨è¾¾æ¯ä¸ªåˆ†åŒºå­˜æ”¾çš„æ˜¯ä»€ä¹ˆæ•°æ®ã€‚</p><p>å¯¹è¡¨åˆ†åŒºï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨æ—¶ï¼Œä½¿ç”¨å¦‚ä¸‹è¯­å¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE sales {</span><br><span class="line">    order_date DATETIME NOT NULL</span><br><span class="line">    -- other columns</span><br><span class="line">} ENGINE=InnoDB PARTITION BY RANGE(YEAR(order_date)) (</span><br><span class="line">    PARTITION p_2014 VALUES LESS THAN (2014),</span><br><span class="line">    PARTITION p_2015 VALUES LESS THAN (2015)</span><br><span class="line">    PARTITION p_2016 VALUES LESS THAN (2016)</span><br><span class="line">    PARTITION p_2017 VALUES LESS THAN (2017)</span><br><span class="line">    PARTITION p_catchall VALUES LESS THAN MAXVALUE</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ†åŒºå­å¥ä¸­å¯ä»¥ä½¿ç”¨å„ç§å‡½æ•°ï¼Œä½†è¡¨è¾¾å¼çš„è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•´æ•°ï¼Œä¸”ä¸èƒ½æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚MySQL è¿˜æ”¯æŒä¸€äº›å…¶ä»–åˆ†åŒºï¼Œæ¯”å¦‚é”®å€¼ã€å“ˆå¸Œã€åˆ—è¡¨åˆ†åŒºï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå°‘è§åˆ°ã€‚åœ¨ MySQL5.5 ä»¥åå¯ä»¥ä½¿ç”¨ RANGE COLUMNS ç±»å‹åˆ†åŒºï¼Œè¿™æ ·å³ä½¿æ˜¯åŸºäºæ—¶é—´åˆ†åŒºï¼Œä¹Ÿæ— éœ€å†å°†å…¶è½¬åŒ–æˆä¸€ä¸ªæ•´æ•°ã€‚</p><p>æ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹åˆ†åŒºè¡¨ä¸Šçš„å„ç§æ“ä½œé€»è¾‘ï¼š</p><ul><li><code>SELECT</code>ï¼šå½“æŸ¥è¯¢ä¸€ä¸ªåˆ†åŒºè¡¨æ—¶ï¼Œåˆ†åŒºå±‚<strong>å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨</strong>ï¼Œä¼˜åŒ–å™¨å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥è¿‡æ»¤éƒ¨åˆ†åˆ†åŒºï¼Œç„¶ååœ¨è°ƒç”¨å¯¹åº”çš„å­˜å‚¨å¼•æ“æ¥å£è®¿é—®å„ä¸ªåˆ†åŒºçš„æ•°æ®</li><li><code>INSERT</code>ï¼šå½“æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ†åŒºå±‚<strong>å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨</strong>ï¼Œç„¶åç¡®å®šå“ªä¸ªåˆ†åŒºæ¥æ”¶è¿™æ¡è®°å½•ï¼Œå†å°†è®°å½•å†™å…¥å¯¹åº”çš„åº•å±‚è¡¨ï¼ŒDELETEæ“ä½œä¸å…¶ç±»ä¼¼</li><li><code>UPDATE</code>ï¼šå½“æ›´æ–°ä¸€æ¡æ•°æ®æ—¶ï¼Œåˆ†åŒºå±‚<strong>å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨</strong>ï¼Œç„¶åç¡®å®šæ•°æ®å¯¹åº”çš„åˆ†åŒºï¼Œç„¶åå–å‡ºæ•°æ®å¹¶æ›´æ–°ï¼Œå†åˆ¤æ–­æ›´æ–°åçš„æ•°æ®åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªåˆ†åŒºï¼Œæœ€åå¯¹åº•å±‚è¡¨è¿›è¡Œå†™å…¥æ“ä½œï¼Œå¹¶å¯¹åŸæ•°æ®æ‰€åœ¨çš„åº•å±‚è¡¨è¿›è¡Œåˆ é™¤æ“ä½œ</li></ul><p>æœ‰äº›æ“ä½œæ˜¯æ”¯æŒæ¡ä»¶è¿‡æ»¤çš„ã€‚ä¾‹å¦‚ï¼Œå½“åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼ŒMySQL éœ€è¦å…ˆæ‰¾åˆ°è¿™æ¡è®°å½•ï¼Œå¦‚æœWHEREæ¡ä»¶æ°å¥½å’Œåˆ†åŒºè¡¨è¾¾å¼åŒ¹é…ï¼Œå°±å¯ä»¥å°†æ‰€æœ‰ä¸åŒ…å«è¿™æ¡è®°å½•çš„åˆ†åŒºéƒ½è¿‡æ»¤æ‰ï¼Œè¿™å¯¹UPDATEè¯­å¥åŒæ ·æœ‰æ•ˆã€‚å¦‚æœæ˜¯INSERTæ“ä½œï¼Œæœ¬èº«å°±åªå‘½ä¸­ä¸€ä¸ªåˆ†åŒºï¼Œå…¶ä»–åˆ†åŒºéƒ½ä¼šè¢«è¿‡æ»¤ã€‚</p><p>è™½ç„¶æ¯ä¸ªæ“ä½œéƒ½ä¼š â€œå…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨â€ï¼Œä½†è¿™å¹¶ä¸æ˜¯è¯´åˆ†åŒºè¡¨åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ˜¯é”ä½å…¨è¡¨çš„ã€‚å¦‚æœå­˜å‚¨å¼•æ“èƒ½å¤Ÿè‡ªå·±å®ç°è¡Œçº§é”ï¼Œä¾‹å¦‚ InnoDBï¼Œåˆ™ä¼šåœ¨åˆ†åŒºå±‚é‡Šæ”¾å¯¹åº”è¡¨é”ã€‚è¿™ä¸ªåŠ é”å’Œè§£é”çš„æ“ä½œè¿‡ç¨‹ä¸æ™®é€š InnoDB ä¸Šçš„æŸ¥è¯¢ç±»ä¼¼ã€‚</p><p>åœ¨ä½¿ç”¨åˆ†åŒºè¡¨æ—¶ï¼Œä¸ºäº†ä¿è¯å¤§æ•°æ®é‡çš„å¯æ‰©å±•æ€§ï¼Œä¸€èˆ¬æœ‰ä¸¤ä¸ªç­–ç•¥ï¼š</p><ul><li>å…¨é‡æ‰«ææ•°æ®ï¼Œä¸ç”¨ç´¢å¼•ã€‚å³åªè¦èƒ½å¤Ÿæ ¹æ® WHERE æ¡ä»¶å°†éœ€è¦æŸ¥è¯¢çš„æ•°æ®é™åˆ¶åœ¨å°‘æ•°åˆ†åŒºä¸­ï¼Œæ•ˆç‡æ˜¯ä¸é”™çš„</li><li>ç´¢å¼•æ•°æ®ï¼Œåˆ†ç¦»çƒ­ç‚¹ã€‚å¦‚æœæ•°æ®æœ‰æ˜æ˜¾çš„ â€œçƒ­ç‚¹â€ï¼Œè€Œä¸”é™¤äº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œå…¶ä»–æ•°æ®å¾ˆå°‘è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™éƒ¨åˆ†çƒ­ç‚¹æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºä¸­ï¼Œè®©è¿™ä¸ªåˆ†åŒºçš„æ•°æ®èƒ½å¤Ÿæœ‰æœºä¼šéƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚è¿™æ ·æŸ¥è¯¢å°±å¯ä»¥åªè®¿é—®ä¸€ä¸ªå¾ˆå°çš„åˆ†åŒºè¡¨ï¼Œèƒ½å¤Ÿä½¿ç”¨ç´¢å¼•ï¼Œä¹Ÿèƒ½å¤Ÿæœ‰æ•ˆçš„åˆ©ç”¨ç¼“å­˜ã€‚</li></ul><p>åˆ†åŒºè¡¨çš„ä¼˜ç‚¹æ˜¯ä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®åˆ†åŒºå‡½æ•°æ¥è¿‡æ»¤ä¸€äº›åˆ†åŒºï¼Œä½†å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯è¦åœ¨WHEREæ¡ä»¶ä¸­å¸¦å…¥åˆ†åŒºåˆ—ï¼Œæœ‰æ—¶å€™å³ä½¿çœ‹ä¼¼å¤šä½™çš„ä¹Ÿè¦å¸¦ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥è®©ä¼˜åŒ–å™¨èƒ½å¤Ÿè¿‡æ»¤æ‰æ— é¡»è®¿é—®çš„åˆ†åŒºï¼Œå¦‚æœæ²¡æœ‰è¿™äº›æ¡ä»¶ï¼ŒMySQL å°±éœ€è¦è®©å¯¹åº”çš„å­˜å‚¨å¼•æ“è®¿é—®è¿™ä¸ªè¡¨çš„æ‰€æœ‰åˆ†åŒºï¼Œå¦‚æœè¡¨éå¸¸å¤§çš„è¯ï¼Œå°±å¯èƒ½ä¼šéå¸¸æ…¢ã€‚</p><p>ä¸Šé¢ä¸¤ä¸ªåˆ†åŒºç­–ç•¥åŸºäºä¸¤ä¸ªéå¸¸é‡è¦çš„å‰æï¼šæŸ¥è¯¢éƒ½èƒ½å¤Ÿè¿‡æ»¤æ‰å¾ˆå¤šé¢å¤–çš„åˆ†åŒºï¼Œåˆ†åŒºæœ¬èº«å¹¶ä¸ä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„ä»£ä»·ã€‚è€Œè¿™ä¸¤ä¸ªå‰æåœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚ï¼š</p><p><strong>1ã€NULL å€¼ä¼šä½¿åˆ†åŒºè¿‡æ»¤æ— æ•ˆ</strong></p><p>å‡è®¾æŒ‰ç…§<code>PARTITION BY RANGE YEAR(order_date)</code>åˆ†åŒºï¼Œé‚£ä¹ˆæ‰€æœ‰<code>order_date</code>ä¸º <code>NULL</code> æˆ–è€…éæ³•å€¼æ—¶ï¼Œè®°å½•éƒ½ä¼šè¢«å­˜æ”¾åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºã€‚æ‰€ä»¥<code>WHERE order_date BETWEEN '2017-05-01' AND '2017-05-31'</code>ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šæ£€æŸ¥ä¸¤ä¸ªåˆ†åŒºï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„ 2017 å¹´è¿™ä¸ªåˆ†åŒºï¼ˆä¼šé¢å¤–çš„æ£€æŸ¥ç¬¬ä¸€ä¸ªåˆ†åŒºï¼‰ï¼Œæ˜¯å› ä¸ºYEAR()åœ¨æ¥æ”¶éæ³•å€¼æ—¶ä¼šè¿”å› <code>NULL</code>ã€‚å¦‚æœç¬¬ä¸€ä¸ªåˆ†åŒºçš„æ•°æ®é‡éå¸¸å¤§ï¼Œè€Œä¸”ä½¿ç”¨å…¨è¡¨æ‰«æçš„ç­–ç•¥æ—¶ï¼Œä»£ä»·ä¼šéå¸¸å¤§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ— ç”¨çš„åˆ†åŒºï¼Œæ¯”å¦‚ï¼š<code>PARTITION p_null values less than (0)</code>ã€‚å¦‚æœæ’å…¥çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¯ï¼Œç¬¬ä¸€ä¸ªåˆ†åŒºå°±æ˜¯ç©ºçš„ã€‚</p><blockquote><p>åœ¨ MySQL5.5 ä»¥åå°±ä¸éœ€è¦è¿™ä¸ªæŠ€å·§äº†ï¼Œå› ä¸ºå¯ä»¥ç›´æ¥ä½¿ç”¨åˆ—æœ¬èº«è€Œä¸æ˜¯åŸºäºåˆ—çš„å‡½æ•°è¿›è¡Œåˆ†åŒºï¼šPARTITION BY RANGE COLUMNS(order_date)ã€‚ç›´æ¥ä½¿ç”¨è¿™ä¸ªè¯­æ³•å¯é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><p><strong>2ã€åˆ†åŒºåˆ—å’Œç´¢å¼•åˆ—ä¸åŒ¹é…</strong></p><p>å½“åˆ†åŒºåˆ—å’Œç´¢å¼•åˆ—ä¸åŒ¹é…æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢æ— æ³•è¿›è¡Œåˆ†åŒºè¿‡æ»¤ï¼Œé™¤éæ¯ä¸ªæŸ¥è¯¢æ¡ä»¶ä¸­éƒ½åŒ…å«åˆ†åŒºåˆ—ã€‚å‡è®¾åœ¨åˆ— a ä¸Šå®šä¹‰äº†ç´¢å¼•ï¼Œè€Œåœ¨åˆ— b ä¸Šè¿›è¡Œåˆ†åŒºã€‚å› ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½æœ‰å…¶ç‹¬ç«‹çš„ç´¢å¼•ï¼Œæ‰€ä»¥åœ¨æ‰«æåˆ— b ä¸Šçš„ç´¢å¼•å°±éœ€è¦æ‰«ææ¯ä¸€ä¸ªåˆ†åŒºå†…å¯¹åº”çš„ç´¢å¼•ï¼Œå½“ç„¶è¿™ç§é€Ÿåº¦ä¸ä¼šå¤ªæ…¢ï¼Œä½†æ˜¯èƒ½å¤Ÿè·³è¿‡ä¸åŒ¹é…çš„åˆ†åŒºè‚¯å®šä¼šæ›´å¥½ã€‚è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥å¾ˆå®¹æ˜“é¿å…ï¼Œä½†éœ€è¦æ³¨æ„ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œå…³è”æŸ¥è¯¢ã€‚å¦‚æœåˆ†åŒºè¡¨æ˜¯å…³è”é¡ºåºçš„ç¬¬ 2 å¼ è¡¨ï¼Œå¹¶ä¸”å…³è”ä½¿ç”¨çš„ç´¢å¼•ä¸åˆ†åŒºæ¡ä»¶å¹¶ä¸åŒ¹é…ï¼Œé‚£ä¹ˆå…³è”æ—¶å¯¹ç¬¬ä¸€å¼ è¡¨ä¸­ç¬¦åˆæ¡ä»¶çš„æ¯ä¸€è¡Œéƒ½éœ€è¦è®¿é—®å¹¶æœç´¢ç¬¬äºŒå¼ è¡¨çš„æ‰€æœ‰åˆ†åŒºï¼ˆå…³è”æŸ¥è¯¢åŸç†ï¼Œè¯·å‚è€ƒå‰ä¸€ç¯‡æ–‡ç« ï¼‰</p><p><strong>3ã€é€‰æ‹©åˆ†åŒºçš„æˆæœ¬å¯èƒ½å¾ˆé«˜</strong></p><p>åˆ†åŒºæœ‰å¾ˆå¤šç§ç±»å‹ï¼Œä¸åŒç±»å‹çš„åˆ†åŒºå®ç°æ–¹å¼ä¹Ÿä¸åŒï¼Œæ‰€ä»¥å®ƒä»¬çš„æ€§èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œå°¤å…¶æ˜¯èŒƒå›´åˆ†åŒºï¼Œåœ¨ç¡®è®¤è¿™ä¸€è¡Œå±äºå“ªä¸ªåˆ†åŒºæ—¶ä¼šæ‰«ææ‰€æœ‰çš„åˆ†åŒºå®šä¹‰ï¼Œè¿™æ ·çš„çº¿æ€§æ‰«ææ•ˆç‡å¹¶ä¸é«˜ï¼Œæ‰€ä»¥éšç€åˆ†åŒºæ•°çš„å¢é•¿ï¼Œæˆæœ¬ä¼šè¶Šæ¥è¶Šé«˜ã€‚ç‰¹åˆ«æ˜¯åœ¨æ‰¹é‡æ’å…¥æ•°æ®æ—¶ï¼Œç”±äºæ¯æ¡è®°å½•åœ¨æ’å…¥å‰ï¼Œéƒ½éœ€è¦ç¡®è®¤å…¶å±äºå“ªä¸€ä¸ªåˆ†åŒºï¼Œå¦‚æœåˆ†åŒºæ•°å¤ªå¤§ï¼Œä¼šé€ æˆæ’å…¥æ€§èƒ½çš„æ€¥å‰§ä¸‹é™ã€‚å› æ­¤æœ‰å¿…è¦é™åˆ¶åˆ†åŒºæ•°é‡ï¼Œä½†ä¹Ÿä¸ç”¨å¤ªè¿‡æ‹…å¿ƒï¼Œå¯¹äºå¤§å¤šæ•°ç³»ç»Ÿï¼Œ100 ä¸ªå·¦å³çš„åˆ†åŒºæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><p><strong>4ã€æ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨çš„æˆæœ¬åœ¨æŸäº›æ—¶å€™ä¼šå¾ˆé«˜</strong></p><p>å‰é¢è¯´è¿‡ï¼Œæ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨å¹¶ä¸ä¼šå¯¹æ€§èƒ½æœ‰å¤ªå¤§çš„å½±å“ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åªéœ€è¦æŸ¥è¯¢ä¸»é”®ï¼Œé‚£ä¹ˆé”ä½çš„æˆæœ¬ç›¸å¯¹äºä¸»é”®çš„æŸ¥è¯¢æ¥è¯´ï¼Œæˆæœ¬å°±ç•¥é«˜ã€‚</p><p><strong>5ã€ç»´æŠ¤åˆ†åŒºçš„æˆæœ¬å¯èƒ½ä¼šå¾ˆé«˜</strong></p><p>æ–°å¢å’Œåˆ é™¤åˆ†åŒºçš„é€Ÿåº¦éƒ½å¾ˆå¿«ï¼Œä½†æ˜¯ä¿®æ”¹åˆ†åŒºä¼šé€ æˆæ•°æ®çš„å¤åˆ¶ï¼Œè¿™ä¸ALTER TABLEçš„åŸç†ç±»ä¼¼ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå†å²åˆ†åŒºï¼Œç„¶åå°†æ•°æ®å¤åˆ¶åˆ°å…¶ä¸­ï¼Œæœ€ååˆ é™¤åŸåˆ†åŒºã€‚å› æ­¤ï¼Œè®¾è®¡æ•°æ®åº“æ—¶ï¼Œè€ƒè™‘ä¸šåŠ¡çš„å¢é•¿éœ€è¦ï¼Œåˆç†çš„åˆ›å»ºåˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚åœ¨ MySQL5.6 ä»¥åçš„ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ALTER TABLE EXCHAGE PARTITIONè¯­å¥æ¥ä¿®æ”¹åˆ†åŒºï¼Œå…¶æ€§èƒ½ä¼šæœ‰å¾ˆå¤§æå‡ã€‚</p><p>åˆ†åŒºè¡¨è¿˜æœ‰ä¸€äº›å…¶ä»–é™åˆ¶ï¼Œæ¯”å¦‚æ‰€æœ‰çš„åº•å±‚è¡¨å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ï¼ŒæŸäº›å­˜å‚¨å¼•æ“ä¹Ÿä¸æ”¯æŒåˆ†åŒºã€‚åˆ†åŒºä¸€èˆ¬åº”ç”¨äºä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä½†ä¸€å°æœåŠ¡å™¨çš„ç‰©ç†èµ„æºæ€»æ˜¯æœ‰é™çš„ï¼Œå½“æ•°æ®è¾¾åˆ°è¿™ä¸ªæé™æ—¶ï¼Œå³ä½¿åˆ†åŒºï¼Œæ€§èƒ½ä¹Ÿå¯èƒ½ä¼šå¾ˆä½ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™åˆ†åº“æ˜¯å¿…é¡»çš„ã€‚ä½†ä¸ç®¡æ˜¯åˆ†åŒºã€åˆ†åº“è¿˜æ˜¯åˆ†è¡¨ï¼Œå®ƒä»¬çš„æ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¤§å®¶å¯ä»¥å¥½å¥½ä½“ä¼šä¸‹ã€‚</p><h4 id="è§†å›¾"><a href="#è§†å›¾" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h4><p>å¯¹äºä¸€äº›å…³è”è¡¨çš„å¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨è§†å›¾æœ‰æ—¶å€™ä¼šå¤§å¤§ç®€åŒ–é—®é¢˜ï¼Œå› æ­¤åœ¨è®¸å¤šåœºåˆä¸‹éƒ½å¯ä»¥çœ‹åˆ°è§†å›¾çš„èº«å½±ï¼Œä½†è§†å›¾çœŸå¦‚æˆ‘ä»¬æ‰€æƒ³é‚£æ ·ç®€å•å—ï¼Ÿå®ƒå’Œç›´æ¥ä½¿ç”¨JOINçš„ SQL è¯­å¥æœ‰ä½•åŒºåˆ«ï¼Ÿè§†å›¾èƒŒåçš„åŸç†åˆäº†è§£å¤šå°‘ï¼Ÿ</p><p>è§†å›¾æœ¬èº«æ˜¯ä¸€ä¸ªè™šæ‹Ÿè¡¨ï¼Œä¸å­˜æ”¾ä»»ä½•æ•°æ®ï¼ŒæŸ¥è¯¢è§†å›¾çš„æ•°æ®é›†ç”±å…¶ä»–è¡¨ç”Ÿæˆã€‚MySQL åº•å±‚é€šè¿‡ä¸¤ç§ç®—æ³•æ¥å®ç°è§†å›¾ï¼šä¸´æ—¶è¡¨ç®—æ³•ï¼ˆTEMPTABLEï¼‰å’Œåˆå¹¶ç®—æ³•ï¼ˆMERGEï¼‰ã€‚æ‰€è°“ä¸´æ—¶è¡¨ç®—æ³•å°±æ˜¯å°† SELECT è¯­å¥çš„ç»“æœå­˜æ”¾åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œå½“éœ€è¦è®¿é—®è§†å›¾çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®è¿™ä¸ªä¸´æ—¶è¡¨å³å¯ã€‚è€Œåˆå¹¶ç®—æ³•åˆ™æ˜¯é‡å†™åŒ…å«è§†å›¾çš„æŸ¥è¯¢ï¼Œå°†è§†å›¾å®šä¹‰çš„ SQL ç›´æ¥åŒ…å«è¿›æŸ¥è¯¢ SQL ä¸­ã€‚é€šè¿‡ä¸¤ä¸ªç®€å•çš„ç¤ºä¾‹æ¥ä½“ä¼šä¸¤ä¸ªç®—æ³•çš„å·®å¼‚ï¼Œåˆ›å»ºå¦‚ä¸‹è§†å›¾ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- è§†å›¾çš„ä½œç”¨æ˜¯æŸ¥è¯¢æœªæ”¯ä»˜è®¢å•</span><br><span class="line">CREATE VIEW unpay_order AS</span><br><span class="line">SELECT * FROM sales WHERE status = <span class="string">'new'</span></span><br><span class="line">WITH CHECK OPTION;   -- å…¶ä½œç”¨ä¸‹æ–‡ä¼šè®²</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç°è¦ä»æœªæ”¯ä»˜è®¢å•ä¸­æŸ¥è¯¢è´­ä¹°è€…ä¸ºcscçš„è®¢å•ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŸ¥è¯¢ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- æŸ¥è¯¢è´­ä¹°è€…ä¸ºcscä¸”æœªæ”¯ä»˜çš„è®¢å•</span><br><span class="line">SELECT order_id,order_amount,buyer FROM unpay_order WHERE buyer = <span class="string">'csc'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨ä¸´æ—¶è¡¨æ¥æ¨¡æ‹Ÿè§†å›¾ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE tmp_order_unpay AS SELECT * FROM sales WHERE status = <span class="string">'new'</span>;</span><br><span class="line">SELECT order_id,order_amount,buyer FROM tmp_order_unpay WHERE buyer = <span class="string">'csc'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨åˆå¹¶ç®—æ³•å°†è§†å›¾å®šä¹‰çš„ SQL åˆå¹¶è¿›æŸ¥è¯¢ SQL åçš„æ ·å­ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT order_id,order_amount,buyer FROM sales WHERE status = <span class="string">'new'</span> AND buyer = <span class="string">'csc'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>MySQL å¯ä»¥åµŒå¥—å®šä¹‰è§†å›¾ï¼Œå³åœ¨ä¸€ä¸ªè§†å›¾ä¸Šåœ¨å®šä¹‰å¦ä¸€ä¸ªè§†å›¾ï¼Œå¯ä»¥åœ¨EXPLAIN EXTENDEDä¹‹åä½¿ç”¨SHOW WARNINGSæ¥æŸ¥çœ‹ä½¿ç”¨è§†å›¾çš„æŸ¥è¯¢é‡å†™åçš„ç»“æœã€‚å¦‚æœé‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ï¼ŒEXPLAINä¸­ä¼šæ˜¾ç¤ºä¸ºæ´¾ç”Ÿè¡¨ï¼ˆDERIVEDï¼‰ï¼Œæ³¨æ„EXPLAINæ—¶éœ€è¦å®é™…æ‰§è¡Œå¹¶äº§ç”Ÿä¸´æ—¶è¡¨ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šå¾ˆæ…¢ã€‚</p><p>æ˜æ˜¾åœ°ï¼Œä¸´æ—¶è¡¨ä¸Šæ²¡æœ‰ä»»ä½•ç´¢å¼•ï¼Œè€Œä¸”ä¼˜åŒ–å™¨ä¹Ÿå¾ˆéš¾ä¼˜åŒ–ä¸´æ—¶è¡¨ä¸Šçš„æŸ¥è¯¢ï¼Œå› æ­¤ï¼Œå¦‚æœ‰å¯èƒ½ï¼Œå°½é‡ä½¿ç”¨åˆå¹¶ç®—æ³•ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šåˆå¹¶ç®—æ³•ï¼ˆç±»ä¼¼äºç›´æ¥æŸ¥è¯¢ï¼‰æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨è§†å›¾ï¼Ÿ</p><p>é¦–å…ˆè§†å›¾å¯ä»¥ç®€åŒ–åº”ç”¨ä¸Šå±‚çš„æ“ä½œï¼Œè®©åº”ç”¨æ›´ä¸“æ³¨äºå…¶æ‰€å…³å¿ƒçš„æ•°æ®ã€‚å…¶æ¬¡ï¼Œè§†å›¾èƒ½å¤Ÿå¯¹æ•æ„Ÿæ•°æ®æä¾›å®‰å…¨ä¿æŠ¤ï¼Œæ¯”å¦‚ï¼šå¯¹ä¸åŒçš„ç”¨æˆ·å®šä¹‰ä¸åŒçš„è§†å›¾ï¼Œå¯ä»¥ä½¿æ•æ„Ÿæ•°æ®ä¸å‡ºç°åœ¨ä¸åº”è¯¥çœ‹åˆ°è¿™äº›æ•°æ®çš„ç”¨æˆ·è§†å›¾ä¸Šï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨è§†å›¾å®ç°åŸºäºåˆ—çš„æƒé™æ§åˆ¶ï¼Œè€Œä¸éœ€è¦çœŸæ­£çš„åœ¨æ•°æ®åº“ä¸­åˆ›å»ºåˆ—æƒé™ã€‚å†è€…ï¼Œè§†å›¾å¯ä»¥æ–¹ä¾¿ç³»ç»Ÿè¿ç»´ï¼Œæ¯”å¦‚ï¼šåœ¨é‡æ„ schema çš„æ—¶å€™ä½¿ç”¨è§†å›¾ï¼Œä½¿å¾—åœ¨ä¿®æ”¹è§†å›¾åº•å±‚è¡¨ç»“æ„çš„æ—¶å€™ï¼Œåº”ç”¨ä»£ç è¿˜å¯ä»¥ç»§ç»­è¿è¡Œä¸æŠ¥é”™ã€‚</p><p>åŸºäºæ­¤ï¼Œä½¿ç”¨è§†å›¾å…¶å®æ›´å¤šçš„æ˜¯åŸºäºä¸šåŠ¡æˆ–è€…ç»´æŠ¤æˆæœ¬ä¸Šçš„è€ƒè™‘ï¼Œå…¶æœ¬èº«å¹¶ä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå¤§ä½œç”¨ï¼ˆæ³¨æ„ï¼šæ­¤å¤„åªæ˜¯åŸºäº MySQL è€ƒè™‘ï¼Œå…¶ä»–å…³ç³»æ€§æ•°æ®åº“ä¸­è§†å›¾å¯èƒ½ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæ¯”å¦‚ORACLEå’ŒMS SQL SERVERéƒ½æ”¯æŒç‰©åŒ–è§†å›¾ï¼Œå®ƒä»¬éƒ½æ¯” MySQL è§†å›¾æœ‰æ›´å¥½çš„æ€§èƒ½ï¼‰ã€‚è€Œä¸”ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ï¼Œåœ¨æŸäº›æ—¶å€™æ€§èƒ½å¯èƒ½ä¼šéå¸¸ç³Ÿç³•ï¼Œæ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- è§†å›¾çš„ä½œç”¨æ˜¯ç»Ÿè®¡æ¯æ—¥æ”¯å‡ºé‡‘é¢ï¼ŒDATE(<span class="string">'2017-06-15 12:00:23'</span>) = 2017-06-15</span><br><span class="line">CREATE VIEW cost_per_day AS</span><br><span class="line">SELECT DATE(create_time) AS date,SUM(cost) AS cost FROM costs GROUP BY date;</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç°è¦ç»Ÿè®¡æ¯æ—¥çš„æ”¶å…¥ä¸æ”¯å‡ºï¼Œæœ‰ç±»ä¼¼äºä¸Šé¢çš„æ”¶å…¥è¡¨ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ SQLï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT c.date,c.cost,s.amount</span><br><span class="line">FROM cost_per_day AS c</span><br><span class="line">JOIN sale_per_day AS s USING(date)</span><br><span class="line">WHERE date BETWEEN <span class="string">'2017-06-01'</span> AND <span class="string">'2017-06-30'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼ŒMySQL å…ˆæ‰§è¡Œè§†å›¾çš„ SQLï¼Œç”Ÿæˆä¸´æ—¶è¡¨ï¼Œç„¶åå†å°†sale_per_dayè¡¨å’Œä¸´æ—¶è¡¨è¿›è¡Œå…³è”ã€‚è¿™é‡ŒWHEREå­—å¥ä¸­çš„BETWEENæ¡ä»¶å¹¶ä¸èƒ½ä¸‹æ¨åˆ°è§†å›¾ä¸­ï¼Œå› è€Œè§†å›¾åœ¨åˆ›å»ºæ—¶ï¼Œä¼šå°†æ‰€æœ‰çš„æ•°æ®æ”¾åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæœˆæ•°æ®ï¼Œå¹¶ä¸”è¿™ä¸ªä¸´æ—¶è¡¨ä¹Ÿä¸ä¼šæœ‰ç´¢å¼•ã€‚</p><p>å½“ç„¶è¿™ä¸ªç¤ºä¾‹ä¸­çš„ä¸´æ—¶è¡¨æ•°æ®ä¸ä¼šå¤ªå¤§ï¼Œæ¯•ç«Ÿæ—¥æœŸçš„æ•°é‡ä¸ä¼šå¤ªå¤šï¼Œä½†ä»ç„¶è¦è€ƒè™‘ç”Ÿæˆä¸´æ—¶è¡¨çš„æ€§èƒ½ï¼ˆå¦‚æœ costs è¡¨æ•°æ®è¿‡å¤§ï¼ŒGROUP BYæœ‰å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼‰ã€‚è€Œä¸”æœ¬ç¤ºä¾‹ä¸­ç´¢å¼•ä¹Ÿä¸æ˜¯é—®é¢˜ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœ MySQL å°†ä¸´æ—¶è¡¨ä½œä¸ºå…³è”é¡ºåºä¸­çš„ç¬¬ä¸€å¼ è¡¨ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨sale_per_dayä¸­çš„ç´¢å¼•ã€‚ä½†å¦‚æœæ˜¯å¯¹ä¸¤ä¸ªè§†å›¾åšå…³è”çš„è¯ï¼Œä¼˜åŒ–å™¨å°±æ²¡æœ‰ä»»ä½•ç´¢å¼•å¯ä»¥ä½¿ç”¨ï¼Œè¿™æ—¶å°±éœ€è¦ä¸¥æ ¼æµ‹è¯•åº”ç”¨çš„æ€§èƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚ã€‚</p><p>æˆ‘ä»¬å¾ˆå°‘ä¼šåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­å»æ›´æ–°è§†å›¾ï¼Œå› æ­¤å°è±¡ä¸­ï¼Œè§†å›¾æ˜¯ä¸èƒ½æ›´æ–°çš„ã€‚ä½†å®é™…ä¸Šï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè§†å›¾æ˜¯å¯ä»¥æ›´æ–°çš„ã€‚å¯æ›´æ–°è§†å›¾æ˜¯æŒ‡é€šè¿‡æ›´æ–°è¿™ä¸ªè§†å›¾æ¥æ›´æ–°è§†å›¾æ¶‰åŠçš„ç›¸å…³è¡¨ï¼Œåªè¦æŒ‡å®šäº†åˆé€‚çš„æ¡ä»¶ï¼Œå°±å¯ä»¥æ›´æ–°ã€åˆ é™¤ç”šè‡³æ˜¯å‘è§†å›¾ä¸­æ’å…¥æ•°æ®ã€‚é€šè¿‡ä¸Šæ–‡çš„äº†è§£ï¼Œä¸éš¾æ¨æ–­å‡ºï¼šæ›´æ–°è§†å›¾çš„å®è´¨å°±æ˜¯æ›´æ–°è§†å›¾å…³è”çš„è¡¨ï¼Œå°†åˆ›å»ºè§†å›¾çš„WHEREå­å¥è½¬åŒ–ä¸ºUPDATEè¯­å¥çš„WHEREå­å¥ï¼Œåªæœ‰ä½¿ç”¨åˆå¹¶ç®—æ³•çš„è§†å›¾æ‰èƒ½æ›´æ–°ï¼Œå¹¶ä¸”æ›´æ–°çš„åˆ—å¿…é¡»æ¥è‡ªåŒä¸€ä¸ªè¡¨ä¸­ã€‚å›é¡¾ä¸Šæ–‡åˆ›å»ºè§†å›¾çš„ SQL è¯­å¥ï¼Œå…¶ä¸­æœ‰ä¸€å¥ï¼šWITH CHECK OPTIONï¼Œå…¶ä½œç”¨å°±æ˜¯è¡¨ç¤ºé€šè¿‡è§†å›¾æ›´æ–°çš„è¡Œï¼Œéƒ½å¿…é¡»ç¬¦åˆè§†å›¾æœ¬èº«çš„WHEREæ¡ä»¶å®šä¹‰ï¼Œä¸èƒ½æ›´æ–°è§†å›¾å®šä¹‰åˆ—ä»¥å¤–çš„åˆ—ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºcheck option failedé”™è¯¯ã€‚</p><p>è§†å›¾è¿˜æœ‰ä¸€ä¸ªå®¹æ˜“é€ æˆè¯¯è§£çš„åœ°æ–¹ï¼šâ€œå¯¹äºä¸€äº›ç®€å•çš„æŸ¥è¯¢ï¼Œè§†å›¾ä¼šä½¿ç”¨åˆå¹¶ç®—æ³•ï¼Œè€Œå¯¹äºä¸€äº›æ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢ï¼Œè§†å›¾å°±ä¼šä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•â€ã€‚ä½†å®é™…ä¸Šï¼Œè§†å›¾çš„å®ç°ç®—æ³•æ˜¯è§†å›¾æœ¬èº«çš„å±æ€§å†³å®šçš„ï¼Œè·Ÿä½œç”¨åœ¨è§†å›¾ä¸Šçš„ SQL æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚é‚£ä»€ä¹ˆæ—¶å€™è§†å›¾é‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•ï¼Œä»€ä¹ˆæ—¶å€™é‡‡ç”¨åˆå¹¶ç®—æ³•å‘¢ï¼Ÿä¸€èˆ¬æ¥è¯´ï¼Œåªè¦åŸè¡¨è®°å½•å’Œè§†å›¾ä¸­çš„è®°å½•æ— æ³•å»ºç«‹ä¸€ä¸€æ˜ å°„çš„å…³ç³»æ—¶ï¼ŒMySQL éƒ½å°†ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•æ¥å®ç°è§†å›¾ã€‚æ¯”å¦‚åˆ›å»ºè§†å›¾çš„ SQL ä¸­åŒ…å«GROUP BYã€DISTINCTã€UNIONã€èšåˆå‡½æ•°ã€å­æŸ¥è¯¢çš„æ—¶å€™ï¼Œè§†å›¾éƒ½å°†é‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•ï¼ˆè¿™äº›è§„åˆ™åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå…·ä½“è¯·å‚è€ƒå®˜æ–¹æ‰‹å†Œï¼‰ã€‚</p><p>ç›¸æ¯”äºå…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„è§†å›¾ï¼ŒMySQL çš„è§†å›¾åœ¨åŠŸèƒ½ä¸Šä¼šå¼±å¾ˆå¤šï¼Œæ¯”å¦‚ORACLEå’ŒMS SQL SERVERéƒ½æ”¯æŒç‰©åŒ–è§†å›¾ã€‚ç‰©åŒ–è§†å›¾æ˜¯æŒ‡å°†è§†å›¾ç»“æœæ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ªå¯ä»¥æŸ¥è¯¢çš„è¡¨ä¸­ï¼Œå¹¶å®šæœŸä»åŸå§‹è¡¨ä¸­åˆ·æ–°æ•°æ®åˆ°è¿™å¼ è¡¨ä¸­ï¼Œè¿™å¼ è¡¨å’Œæ™®é€šç‰©ç†è¡¨ä¸€æ ·ï¼Œå¯ä»¥åˆ›å»ºç´¢å¼•ã€ä¸»é”®çº¦æŸç­‰ç­‰ï¼Œæ€§èƒ½ç›¸æ¯”äºä¸´æ—¶è¡¨ä¼šæœ‰è´¨çš„æå‡ã€‚ä½†é—æ†¾çš„æ˜¯ MySQL ç›®å‰å¹¶ä¸æ”¯æŒç‰©åŒ–è§†å›¾ï¼Œå½“ç„¶ MySQL ä¹Ÿä¸æ”¯æŒåœ¨è§†å›¾ä¸­åˆ›å»ºç´¢å¼•ã€‚</p><h4 id="å­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨"><a href="#å­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨" class="headerlink" title="å­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨"></a>å­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨</h4><p>å›åˆ°ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæœ‰éå¸¸å¤šçš„äººåœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ</p><p>å¦‚æœæœ‰æ·±å…¥äº†è§£è¿‡å­˜å‚¨è¿‡ç¨‹ï¼Œå°±ä¼šå‘ç°å­˜å‚¨è¿‡ç¨‹å¹¶æ²¡æœ‰å¤§å®¶æè¿°çš„é‚£ä¹ˆä¸å ªã€‚æˆ‘æ›¾ç»ç»å†è¿‡ä¸€äº›é‡åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹çš„äº§å“ï¼Œä¾èµ–åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå°±è¿™ä¹ˆè¯´å§ï¼Œä¸Šå±‚çš„åº”ç”¨åŸºæœ¬ä¸Šåªå¤„ç†äº¤äº’ä¸åŠ¨æ•ˆçš„é€»è¾‘ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œç”šè‡³æ˜¯å‚æ•°çš„æ ¡éªŒå‡åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°ã€‚æ›¾ç»æœ‰å‡ºç°è¿‡ä¸€ä¸ªè¶…å¤§çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå…¶æ–‡ä»¶å¤§å°è¾¾åˆ°æƒŠäººçš„ 80Kï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œå…¶ä¸šåŠ¡é€»è¾‘æœ‰å¤šä¹ˆå¤æ‚ã€‚åœ¨å¤§å¤šæ•°äººçœ¼ä¸­ï¼Œè¿™æ ·çš„æŠ€æœ¯æ¶æ„ç®€ç›´æœ‰ç‚¹ä¸å¯ç†å–»ï¼Œä½†å®é™…ä¸Šè¿™æ¬¾äº§å“éå¸¸æˆåŠŸã€‚</p><p>å…¶æˆåŠŸçš„åŸå› åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¾—ç›Šäºå­˜å‚¨è¿‡ç¨‹çš„ä¼˜ç‚¹ï¼Œç”±äºä¸šåŠ¡å±‚ä»£ç æ²¡æœ‰ä»»ä½•ä¾µå…¥ä¸šåŠ¡çš„ä»£ç ï¼Œåœ¨ä¸æ”¹å˜å‰ç«¯å±•ç¤ºæ•ˆæœçš„åŒæ—¶ï¼Œå¯ä»¥éå¸¸å¿«é€Ÿçš„ä¿®å¤ BUGã€å¼€å‘æ–°åŠŸèƒ½ã€‚ç”±äºè¿™æ¬¾äº§å“éœ€è¦éƒ¨ç½²åœ¨å®¢æˆ·çš„ç§æœ‰ç¯å¢ƒä¸Šï¼Œå¿«é€Ÿå“åº”å®¢æˆ·çš„éœ€æ±‚å°±å˜å¾—å°¤ä¸ºé‡è¦ï¼Œæ­£æ˜¯å¾—ç›Šäºè¿™ç§æ¶æ„ï¼Œå¯ä»¥åœ¨å®¢æˆ·å‡ºç°é—®é¢˜æˆ–è€…æå‡ºæ–°éœ€æ±‚æ—¶ï¼Œå¿«é€Ÿå“åº”ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ 1 å°æ—¶å†…ä¿®å¤å®¢æˆ·é‡åˆ°çš„é—®é¢˜ã€‚æ­£æ˜¯è¿™ç§å¿«é€Ÿå“åº”æœºåˆ¶ï¼Œè®©æˆ‘ä»¬è·å¾—å¤§é‡çš„å®¢æˆ·ã€‚</p><p>å½“ç„¶å­˜å‚¨è¿‡ç¨‹è¿˜æœ‰å…¶ä»–çš„ä¼˜ç‚¹ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„åŠ å¯†å­˜å‚¨è¿‡ç¨‹ä»£ç ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåº”ç”¨éƒ¨ç½²åˆ°ç§æœ‰ç¯å¢ƒé€ æˆæºä»£ç æ³„éœ²ã€å¯ä»¥åƒè°ƒè¯•å…¶ä»–åº”ç”¨ç¨‹åºä¸€æ ·è°ƒè¯•å­˜å‚¨è¿‡ç¨‹ã€å¯ä»¥è®¾å®šå­˜å‚¨è¿‡ç¨‹çš„ä½¿ç”¨æƒé™æ¥ä¿è¯æ•°æ®å®‰å…¨ç­‰ç­‰ã€‚ä¸€åˆ‡éƒ½éå¸¸ç¾å¥½ï¼Œä½†æˆ‘ä»¬çš„äº§å“æ˜¯åŸºäºMS SQL SERVERå®ç°çš„ï¼Œå…¶å¯ä»¥é€šè¿‡T-SQLéå¸¸æ–¹ä¾¿çš„å®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚ä½ å¯ä»¥æŠŠT-SQLçœ‹åšæ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œå…¶åŒ…å«SQLçš„æ‰€æœ‰åŠŸèƒ½ï¼Œè¿˜å…·å¤‡æµç¨‹æ§åˆ¶ã€æ‰¹å¤„ç†ã€å®šæ—¶ä»»åŠ¡ç­‰èƒ½åŠ›ï¼Œä½ ç”šè‡³å¯ä»¥ç”¨å…¶æ¥è§£æ XML æ•°æ®ã€‚å…³äºT-SQLçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒMSDNï¼Œä¸»æµçš„å…³ç³»å‹æ•°æ®åº“ç›®å‰åªæœ‰MS SQL SERVERæ”¯æŒT-SQLï¼Œå› æ­¤ï¼ŒMySQL å¹¶ä¸å…·å¤‡ä¸Šæ–‡æè¿°çš„ä¸€äº›èƒ½åŠ›ï¼Œæ¯”å¦‚ï¼ŒMySQL çš„å­˜å‚¨è¿‡ç¨‹è°ƒè¯•éå¸¸ä¸æ–¹ä¾¿ï¼ˆå½“ç„¶å¯ä»¥é€šè¿‡ä»˜è´¹è½¯ä»¶æ¥è·å¾—å¾ˆå¥½çš„æ”¯æŒï¼‰ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒMySQL å­˜å‚¨è¿‡ç¨‹è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é™åˆ¶ï¼š</p><ul><li>ä¼˜åŒ–å™¨æ— æ³•è¯„ä¼°å­˜å‚¨è¿‡ç¨‹çš„æ‰§è¡Œæˆæœ¬</li><li>æ¯ä¸ªè¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œè®¡åˆ’ç¼“å­˜ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿æ¥éœ€è¦è°ƒç”¨åŒä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œå°†ä¼šæµªè´¹ç¼“å­˜ç©ºé—´æ¥ç¼“å­˜ç›¸åŒçš„æ‰§è¡Œè®¡åˆ’</li></ul><p>å› æ­¤ï¼Œåœ¨ MySQL ä¸­ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªå¤ªå¥½ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº›å¤§æ•°æ®ã€é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå°†å¤æ‚çš„é€»è¾‘äº¤ç»™ä¸Šå±‚åº”ç”¨å®ç°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰©å±•å·²æœ‰èµ„æºä»¥ä¾¿è·å¾—æ›´é«˜çš„è®¡ç®—èƒ½åŠ›ã€‚è€Œä¸”å¯¹äºç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€ï¼Œå…¶å¯è¯»æ€§ä¼šæ¯”å­˜å‚¨è¿‡ç¨‹æ›´å¥½ä¸€äº›ï¼Œä¹Ÿæ›´åŠ çµæ´»ã€‚ä¸è¿‡ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœå­˜å‚¨è¿‡ç¨‹æ¯”å…¶ä»–å®ç°ä¼šå¿«å¾ˆå¤šï¼Œå¹¶ä¸”æ˜¯ä¸€äº›è¾ƒå°çš„æ“ä½œï¼Œå¯ä»¥é€‚å½“è€ƒè™‘ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€‚</p><p>å’Œå­˜å‚¨è¿‡ç¨‹ç±»ä¼¼çš„ï¼Œè¿˜æœ‰è§¦å‘å™¨ï¼Œè§¦å‘å™¨å¯ä»¥è®©ä½ åœ¨æ‰§è¡ŒINSERTã€UPDATEå’ŒDELETEæ—¶ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œã€‚åœ¨ MySQL ä¸­å¯ä»¥é€‰æ‹©åœ¨ SQL æ‰§è¡Œä¹‹å‰è§¦å‘è¿˜æ˜¯åœ¨ SQL æ‰§è¡Œåè§¦å‘ã€‚è§¦å‘å™¨ä¸€èˆ¬ç”¨äºå®ç°ä¸€äº›å¼ºåˆ¶çš„é™åˆ¶ï¼Œè¿™äº›é™åˆ¶å¦‚æœåœ¨åº”ç”¨ç¨‹åºä¸­å®ç°ä¼šè®©ä¸šåŠ¡ä»£ç å˜å¾—éå¸¸å¤æ‚ï¼Œè€Œä¸”å®ƒä¹Ÿå¯ä»¥å‡å°‘å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ã€‚MySQL è§¦å‘å™¨çš„å®ç°éå¸¸ç®€å•ï¼Œæ‰€ä»¥åŠŸèƒ½éå¸¸æœ‰é™ï¼Œå¦‚æœä½ åœ¨å…¶ä»–æ•°æ®åº“äº§å“ä¸­å·²ç»é‡åº¦ä¾èµ–è§¦å‘å™¨ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ MySQL è§¦å‘å™¨æ—¶å€™éœ€è¦æ³¨æ„ï¼Œå› ä¸º MySQL è§¦å‘å™¨çš„è¡¨ç°å’Œé¢„æƒ³çš„ä¸ä¸€è‡´ã€‚</p><p>é¦–å…ˆå¯¹ä¸€å¼ è¡¨çš„æ¯ä¸€ä¸ªäº‹ä»¶ï¼Œæœ€å¤šåªèƒ½å®šä¹‰ä¸€ä¸ªè§¦å‘å™¨ï¼Œè€Œä¸”å®ƒåªæ”¯æŒ â€œåŸºäºè¡Œçš„è§¦å‘â€ï¼Œä¹Ÿå°±æ˜¯è§¦å‘å™¨å§‹ç»ˆæ˜¯é’ˆå¯¹ä¸€æ¡è®°å½•çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ•´ä¸ª SQL è¯­å¥ã€‚å¦‚æœæ˜¯æ‰¹é‡æ›´æ–°çš„è¯ï¼Œæ•ˆç‡å¯èƒ½ä¼šå¾ˆä½ã€‚å…¶æ¬¡ï¼Œè§¦å‘å™¨å¯ä»¥æ©ç›–æœåŠ¡å™¨æœ¬è´¨å·¥ä½œï¼Œä¸€ä¸ªç®€å•çš„ SQL è¯­å¥èƒŒåï¼Œå› ä¸ºè§¦å‘å™¨ï¼Œå¯èƒ½åŒ…å«äº†å¾ˆå¤šçœ‹ä¸è§çš„å·¥ä½œã€‚å†è€…ï¼Œè§¦å‘å™¨å‡ºç°é—®é¢˜æ—¶å¾ˆéš¾æ’æŸ¥ã€‚æœ€åï¼Œè§¦å‘å™¨å¹¶ä¸ä¸€å®šèƒ½ä¿è¯åŸå­æ€§ï¼Œæ¯”å¦‚MyISAMå¼•æ“ä¸‹è§¦å‘å™¨æ‰§è¡Œå¤±è´¥äº†ï¼Œä¹Ÿä¸èƒ½å›æ»šã€‚åœ¨InnoDBè¡¨ä¸Šçš„è§¦å‘å™¨æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå®Œæˆçš„ï¼Œæ‰€ä»¥ä»–ä»¬çš„æ‰§è¡Œæ˜¯åŸå­çš„ï¼ŒåŸæ“ä½œå’Œè§¦å‘å™¨æ“ä½œä¼šåŒæ—¶å¤±è´¥æˆ–è€…æˆåŠŸã€‚</p><p>è™½ç„¶è§¦å‘å™¨æœ‰è¿™ä¹ˆå¤šé™åˆ¶ï¼Œä½†å®ƒä»æœ‰é€‚ç”¨çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼Œå½“ä½ éœ€è¦è®°å½• MySQL æ•°æ®çš„å˜æ›´æ—¥å¿—ï¼Œè¿™æ—¶è§¦å‘å™¨å°±éå¸¸æ–¹ä¾¿äº†ã€‚</p><h4 id="å¤–é”®çº¦æŸ"><a href="#å¤–é”®çº¦æŸ" class="headerlink" title="å¤–é”®çº¦æŸ"></a>å¤–é”®çº¦æŸ</h4><p>ç›®å‰åœ¨å¤§å¤šæ•°äº’è”ç½‘é¡¹ç›®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§æ•°æ®çš„åœºæ™¯ä¸‹ï¼Œå·²ç»ä¸å»ºè®®ä½¿ç”¨å¤–é”®äº†ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°å¤–é”®çš„ä½¿ç”¨æˆæœ¬ï¼š</p><ul><li>å¤–é”®é€šå¸¸è¦æ±‚æ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶éƒ½è¦åœ¨å¦å¤–ä¸€å¼ è¡¨ä¸­æ‰§è¡Œä¸€æ¬¡æŸ¥æ‰¾æ“ä½œã€‚åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ä¼šå¼ºåˆ¶å¤–é”®ä½¿ç”¨ç´¢å¼•ï¼Œä½†åœ¨å¤§æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ä¸èƒ½å¿½ç•¥å¤–é”®æ£€æŸ¥å¸¦æ¥çš„å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å½“å¤–é”®çš„é€‰æ‹©æ€§å¾ˆä½æ—¶ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªéå¸¸å¤§ä¸”é€‰æ‹©æ€§ä½çš„ç´¢å¼•ã€‚</li><li>å¦‚æœå‘å­è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œå¤–é”®çº¦æŸä¼šè®© InnoDB æ£€æŸ¥å¯¹åº”çš„çˆ¶è¡¨çš„è®°å½•ï¼Œä¹Ÿå°±éœ€è¦å¯¹çˆ¶è¡¨å¯¹åº”è®°å½•è¿›è¡ŒåŠ é”æ“ä½œï¼Œæ¥ç¡®ä¿è¿™æ¡è®°å½•ä¸ä¼šåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆä¹‹æ—¶å°±è¢«åˆ é™¤äº†ã€‚è¿™ä¼šå¯¼è‡´é¢å¤–çš„é”ç­‰å¾…ï¼Œç”šè‡³ä¼šå¯¼è‡´ä¸€äº›æ­»é”ã€‚</li><li>é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ•°æ®åº“å¾ˆå®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œè‡ªç„¶è€Œç„¶çš„å°±å¸Œæœ›æ•°æ®åº“å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œè¿™æ—¶å°±éœ€è¦æŠŠæ•°æ®çš„ä¸€è‡´æ€§æ§åˆ¶æ”¾åˆ°åº”ç”¨å±‚ï¼Œä¹Ÿå°±æ˜¯è®©åº”ç”¨æœåŠ¡å™¨å¯ä»¥æ‰¿æ‹…å‹åŠ›ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®åº“å±‚é¢å°±ä¸èƒ½ä½¿ç”¨å¤–é”®ã€‚</li></ul><p>å› æ­¤ï¼Œå½“ä¸ç”¨è¿‡å¤šè€ƒè™‘æ•°æ®åº“çš„æ€§èƒ½é—®é¢˜æ—¶ï¼Œæ¯”å¦‚ä¸€äº›å†…éƒ¨é¡¹ç›®æˆ–ä¼ ç»Ÿè¡Œä¸šé¡¹ç›®ï¼ˆå…¶ä½¿ç”¨äººæ•°æœ‰é™ï¼Œè€Œä¸”æ•°æ®é‡ä¸€èˆ¬ä¸ä¼šå¤ªå¤§ï¼‰ï¼Œä½¿ç”¨å¤–é”®æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ¯•ç«Ÿæƒ³è¦ç¡®ä¿ç›¸å…³è¡¨å§‹ç»ˆæœ‰ä¸€è‡´çš„æ•°æ®ï¼Œä½¿ç”¨å¤–é”®è¦æ¯”åœ¨åº”ç”¨ç¨‹åºä¸­æ£€æŸ¥ä¸€è‡´æ€§æ–¹ä¾¿ç®€å•è®¸å¤šï¼Œæ­¤å¤–ï¼Œå¤–é”®åœ¨ç›¸å…³æ•°æ®çš„åˆ é™¤å’Œæ›´æ–°æ“ä½œä¸Šä¹Ÿä¼šæ¯”åœ¨åº”ç”¨ä¸­è¦é«˜æ•ˆã€‚</p><h4 id="ç»‘å®šå˜é‡"><a href="#ç»‘å®šå˜é‡" class="headerlink" title="ç»‘å®šå˜é‡"></a>ç»‘å®šå˜é‡</h4><p>å¯èƒ½å¤§å®¶çœ‹åˆ° â€œç»‘å®šå˜é‡â€ è¿™ä¸ªè¯æ—¶ï¼Œä¼šæœ‰ä¸€ç‚¹é™Œç”Ÿï¼Œæ¢ä¸ªè¯´æ³•å¯èƒ½ä¼šç†Ÿæ‚‰ä¸€äº›ï¼šprepared statementã€‚ç»‘å®šå˜é‡çš„ SQLï¼Œä½¿ç”¨é—®å·æ ‡è®°å¯ä»¥æ¥æ”¶å‚æ•°çš„ä½ç½®ï¼Œå½“çœŸæ­£éœ€è¦æ‰§è¡Œå…·ä½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨å…·ä½“çš„æ•°å€¼ä»£æ›¿è¿™äº›é—®å·ï¼Œæ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT order_no, order_amount FROM sales WHERE order_status = ? and buyer = ?</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç»‘å®šå˜é‡ï¼Ÿæ€»æ‰€å‘¨çŸ¥çš„åŸå› æ˜¯å¯ä»¥é¢„å…ˆç¼–è¯‘ï¼Œå‡å°‘ SQL æ³¨å…¥çš„é£é™©ï¼Œé™¤äº†è¿™äº›å‘¢ï¼Ÿ</span><br><span class="line"></span><br><span class="line">å½“åˆ›å»ºä¸€ä¸ªç»‘å®šå˜é‡ SQL æ—¶ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ª SQL è¯­å¥åŸå‹ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ª SQL è¯­å¥çš„æ¡†æ¶åï¼Œè§£æå¹¶å­˜å‚¨è¿™ä¸ª SQL è¯­å¥çš„éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ª SQL è¯­å¥å¤„ç†å¥æŸ„ï¼Œä»æ­¤ä»¥åï¼Œå®¢æˆ·ç«¯é€šè¿‡å‘æœåŠ¡å™¨å‘é€å„ä¸ªé—®å·çš„å–å€¼å’Œè¿™ä¸ªå¥æŸ„æ¥æ‰§è¡Œä¸€ä¸ªå…·ä½“æŸ¥è¯¢ï¼Œè¿™æ ·å°±å¯ä»¥æ›´é«˜æ•ˆåœ°æ‰§è¡Œå¤§é‡é‡å¤è¯­å¥ï¼Œå› ä¸ºï¼š</span><br><span class="line">* æœåŠ¡å™¨åªéœ€è¦è§£æä¸€æ¬¡ SQL è¯­å¥</span><br><span class="line">* æœåŠ¡å™¨æŸäº›ä¼˜åŒ–å™¨çš„ä¼˜åŒ–å·¥ä½œä¹Ÿåªéœ€è¦åšä¸€æ¬¡ï¼Œå› ä¸º MySQL ä¼šç¼“å­˜éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’</span><br><span class="line">* é€šä¿¡ä¸­ä»…ä»…å‘é€çš„æ˜¯å‚æ•°ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè¯­å¥ï¼Œç½‘ç»œå¼€é”€ä¹Ÿä¼šæ›´å°ï¼Œè€Œä¸”ä»¥äºŒè¿›åˆ¶å‘é€å‚æ•°å’Œå¥æŸ„è¦æ¯”å‘é€ ASCII æ–‡æœ¬çš„æ•ˆç‡æ›´é«˜</span><br><span class="line"></span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQL å¹¶ä¸æ˜¯æ€»èƒ½ç¼“å­˜æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚æœæŸäº›æ‰§è¡Œè®¡åˆ’éœ€è¦æ ¹æ®å‚å…¥çš„å‚æ•°æ¥è®¡ç®—æ—¶ï¼ŒMySQL å°±æ— æ³•ç¼“å­˜è¿™éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ã€‚æ¯”å¦‚ï¼š</span><br><span class="line">```bash</span><br><span class="line">-- è¿™é‡Œå‡è£…æœ‰ä¸€ä¸ªä¾‹å­ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ€è€ƒä¸€ä¸‹</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨ç»‘å®šå˜é‡çš„æœ€å¤§é™·é˜±æ˜¯ï¼šä½ çŸ¥é“å…¶åŸç†ï¼Œä½†ä¸çŸ¥é“å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚æœ‰æ—¶å€™ï¼Œå¾ˆéš¾è§£é‡Šå¦‚ä¸‹ 3 ç§ç»‘å®šå˜é‡ç±»å‹ä¹‹é—´çš„åŒºåˆ«ï¼š</p><ol><li>å®¢æˆ·ç«¯æ¨¡æ‹Ÿçš„ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯çš„é©±åŠ¨ç¨‹åºæ¥æ”¶ä¸€ä¸ªå¸¦å‚æ•°çš„ SQLï¼Œå†å°†å‚æ•°çš„å€¼å¸¦å…¥å…¶ä¸­ï¼Œæœ€åå°†å®Œæ•´çš„æŸ¥è¯¢å‘é€åˆ°æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯ä½¿ç”¨ç‰¹æ®Šçš„äºŒè¿›åˆ¶åè®®å°†å¸¦å‚æ•°çš„ SQL è¯­å¥å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œç„¶åä½¿ç”¨äºŒè¿›åˆ¶åè®®å°†å…·ä½“çš„å‚æ•°å€¼å‘é€ç»™æœåŠ¡å™¨å¹¶æ‰§è¡Œã€‚</li><li>SQL æ¥å£çš„ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯å…ˆå‘é€ä¸€ä¸ªå¸¦å‚æ•°çš„ SQL è¯­å¥åˆ°æœåŠ¡å™¨ç«¯ï¼Œè¿™ç±»ä¼¼äºä½¿ç”¨preparedçš„ SQL è¯­å¥ï¼Œç„¶åå‘é€è®¾ç½®çš„å‚æ•°ï¼Œæœ€ååœ¨å‘é€executeæŒ‡ä»¤æ¥æ‰§è¡Œ SQLï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯ç”¨æ™®é€šçš„æ–‡æœ¬ä¼ è¾“åè®®ã€‚</li></ol><p>æ¯”å¦‚æŸäº›ä¸æ”¯æŒé¢„ç¼–è¯‘çš„ JDBC é©±åŠ¨ï¼Œåœ¨è°ƒç”¨<code>connection.prepareStatement(sql)</code>æ—¶ï¼Œå¹¶ä¸ä¼šæŠŠ <code>SQL</code> è¯­å¥å‘é€ç»™æ•°æ®åº“åšé¢„å¤„ç†ï¼Œè€Œæ˜¯ç­‰åˆ°è°ƒç”¨<code>executeQuery</code>æ–¹æ³•æ—¶æ‰æŠŠæ•´ä¸ªè¯­å¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œè¿™ç§æ–¹å¼å°±ç±»ä¼¼äºç¬¬ 1 ç§æƒ…å†µã€‚å› æ­¤ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨ç»‘å®šå˜é‡æ—¶ï¼Œç†è§£ä½ ä½¿ç”¨çš„é©±åŠ¨é€šè¿‡å“ªç§æ–¹å¼æ¥å®ç°å°±æ˜¾å¾—å¾ˆæœ‰å¿…è¦ã€‚å»¶ä¼¸å¼€æ¥è¯´ï¼Œå¯¹äºè‡ªå·±ä½¿ç”¨çš„æ¡†æ¶ã€å¼€æºå·¥å…·ï¼Œä¸åº”ä»…ä»…åœç•™åœ¨ä¼šä½¿ç”¨è¿™ä¸ªå±‚é¢ï¼Œæœ‰æ—¶é—´å¯ä»¥æ·±å…¥äº†è§£å…¶åŸç†å’Œå®ç°ï¼Œä¸ç„¶æœ‰å¯èƒ½è¢«éª—äº†éƒ½ä¸çŸ¥é“å“¦ã€‚</p><h4 id="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"><a href="#ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"></a>ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h4><p>MySQL æœ¬èº«å†…ç½®äº†éå¸¸å¤šçš„å‡½æ•°ï¼Œæ¯”å¦‚SUMã€COUNTã€AVGç­‰ç­‰ï¼Œå¯å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ›´å¤šã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ›´å¼ºå¤§çš„åŠŸèƒ½éƒ½æ˜¯åœ¨åº”ç”¨å±‚é¢å®ç°ï¼Œä½†å®é™…ä¸Š MySQL ä¹Ÿæä¾›äº†æœºä¼šè®©æˆ‘ä»¬å¯ä»¥å»æ‰©å±• MySQL å‡½æ•°ï¼Œè¿™å°±æ˜¯ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•° (user-defined function)ï¼Œä¹Ÿç§°ä¸ºï¼šUDFã€‚éœ€è¦æ³¨æ„UDFä¸å­˜å‚¨è¿‡ç¨‹å’Œé€šè¿‡ SQL åˆ›å»ºå‡½æ•°çš„åŒºåˆ«ï¼Œå­˜å‚¨è¿‡ç¨‹åªèƒ½ä½¿ç”¨ SQL æ¥ç¼–å†™ï¼Œè€ŒUDFæ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨æ”¯æŒ C è¯­è¨€è°ƒç”¨çº¦å®šçš„ä»»ä½•ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€‚</p><p>UDFå¿…é¡»äº‹å…ˆç¼–è¯‘å¥½å¹¶åŠ¨æ€é“¾æ¥åˆ°æœåŠ¡å™¨ä¸Šï¼Œè¿™ç§å¹³å°ç›¸å…³æ€§ä½¿å¾—UDFåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¾ˆå¼ºå¤§ï¼ŒUDFé€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”å¯ä»¥è®¿é—®å¤§é‡æ“ä½œç³»ç»ŸåŠŸèƒ½ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¤§é‡åº“å‡½æ•°ã€‚å¦‚æœéœ€è¦ä¸€ä¸ª MySQL ä¸æ”¯æŒçš„ç»Ÿè®¡èšåˆå‡½æ•°ï¼Œå¹¶ä¸”æ— æ³•ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ¥å®ç°ï¼Œè€Œä¸”è¿˜æƒ³ä¸åŒçš„è¯­è¨€éƒ½å¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆUDFæ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œè‡³å°‘ä¸éœ€è¦æ¯ç§è¯­è¨€éƒ½æ¥å®ç°ç›¸åŒçš„é€»è¾‘ã€‚</p><p>æ‰€è°“èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»ä¹Ÿå°±è¶Šå¤§ï¼ŒUDFä¸­çš„ä¸€ä¸ªé”™è¯¯å¯èƒ½ç›´æ¥è®©æœåŠ¡å™¨å´©æºƒï¼Œç”šè‡³æ‰°ä¹±æœåŠ¡å™¨çš„å†…å­˜å’Œæ•°æ®ï¼Œå› æ­¤ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„å…¶æ½œåœ¨çš„é£é™©ã€‚åœ¨ MySQL ç‰ˆæœ¬å‡çº§æ—¶ä¹Ÿéœ€è¦æ³¨æ„ï¼Œå› ä¸ºä½ å¯èƒ½éœ€è¦é‡æ–°ç¼–è¯‘æˆ–è€…ä¿®æ”¹è¿™äº›UDFï¼Œä»¥ä¾¿è®©å®ƒä»¬èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­å·¥ä½œã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥å±•ç¤ºå¦‚ä½•åˆ›å»ºUDFï¼šå°†ç»“æœé›†è½¬åŒ–ä¸º JSONï¼Œå…·ä½“çš„ä»£ç è¯·å‚è€ƒï¼šlib_mysqludf_jsonã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-- 1ã€é¦–å…ˆä½¿ç”¨cè¯­è¨€å®ç°åŠŸèƒ½</span><br><span class="line">-- 2ã€ç¼–è¯‘</span><br><span class="line">-- è¿™é‡Œçœç•¥ç¬¬1ã€2æ­¥ï¼Œå®ç°å¹¶ç¼–è¯‘æˆ.so</span><br><span class="line">-- 3ã€ä½¿ç”¨SQLåˆ›å»ºå‡½æ•°</span><br><span class="line">DROP FUNCTION json_array;</span><br><span class="line">CREATE FUNCTION json_array RETURNS string soname <span class="string">'lib_mysqludf_json.so'</span>;</span><br><span class="line">-- 4ã€ä½¿ç”¨å‡½æ•°</span><br><span class="line">SELECT</span><br><span class="line">  json_array(</span><br><span class="line">    customer_id,</span><br><span class="line">    first_name,</span><br><span class="line">    last_name,</span><br><span class="line">    last_update</span><br><span class="line">  ) as customer</span><br><span class="line">FROM</span><br><span class="line">  customer</span><br><span class="line">WHERE</span><br><span class="line">  customer_id = 1;</span><br><span class="line">/*</span><br><span class="line">5ã€å¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| customer                                 |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| [1,<span class="string">"MARY"</span>,<span class="string">"SMITH"</span>,<span class="string">"2006-02-15 04:57:20"</span>] |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">*/</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…¶å¤§è‡´çš„å®ç°æµç¨‹ï¼šä½¿ç”¨ C è¯­è¨€å®ç°é€»è¾‘ -> ç¼–è¯‘æˆ.soæ–‡ä»¶ -> åˆ›å»ºå‡½æ•° -> ä½¿ç”¨å‡½æ•°ã€‚UDFåœ¨å®é™…å·¥ä½œä¸­å¯èƒ½å¾ˆå°‘ä½¿ç”¨ï¼Œä½†ä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬ï¼Œäº†è§£è¿™ä¹ˆä¸€æ¬¾å¼ºå¤§çš„å·¥å…·ï¼Œåœ¨è§£å†³æ£˜æ‰‹é—®é¢˜æ—¶ï¼Œä¹Ÿè®©æˆ‘ä»¬æœ‰äº†æ›´å¤šçš„é€‰æ‹©ã€‚</p><h4 id="å­—ç¬¦é›†"><a href="#å­—ç¬¦é›†" class="headerlink" title="å­—ç¬¦é›†"></a>å­—ç¬¦é›†</h4><p>æœ€åè¯´è¯´å­—ç¬¦é›†ã€‚</p><p>å…³äºå­—ç¬¦é›†å¤§å¤šæ•°äººçš„ç¬¬ä¸€å°è±¡å¯èƒ½å°±æ˜¯ï¼šæ•°æ®åº“å­—ç¬¦é›†å°½é‡ä½¿ç”¨<code>UTF8</code>ï¼Œå› ä¸º<code>UTF8</code>å­—ç¬¦é›†æ˜¯ç›®å‰æœ€é€‚åˆäºå®ç°å¤šç§ä¸åŒå­—ç¬¦é›†ä¹‹é—´çš„è½¬æ¢çš„å­—ç¬¦é›†ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šé¿å…ä¹±ç é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿ä»¥åçš„æ•°æ®è¿ç§»ã€‚But whyï¼Ÿ</p><p>å­—ç¬¦é›†æ˜¯æŒ‡ä¸€ç§ä»<strong>äºŒè¿›åˆ¶ç¼–ç åˆ°æŸç±»å­—ç¬¦ç¬¦å·</strong>çš„æ˜ å°„ï¼Œå¯ä»¥å‚è€ƒå¦‚ä½•ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºè‹±æ–‡å­—æ¯ã€‚æ ¡å¯¹è§„åˆ™æ˜¯æŒ‡ä¸€ç»„<strong>ç”¨äºæŸä¸ªå­—ç¬¦é›†çš„æ’åºè§„åˆ™</strong>ï¼Œå³é‡‡ç”¨ä½•ç§è§„åˆ™å¯¹æŸç±»å­—ç¬¦è¿›è¡Œæ’åºã€‚MySQL æ¯ä¸€ç±»ç¼–ç å­—ç¬¦éƒ½æœ‰å…¶å¯¹åº”çš„å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ã€‚MySQL å¯¹å„ç§å­—ç¬¦é›†çš„æ”¯æŒéƒ½éå¸¸å®Œå–„ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥ä¸€äº›å¤æ‚æ€§ï¼ŒæŸäº›åœºæ™¯ä¸‹ç”šè‡³ä¼šæœ‰ä¸€äº›æ€§èƒ½ç‰ºç‰²ã€‚</p><p>ä¸€ç§å­—ç¬¦é›†å¯èƒ½å¯¹åº”å¤šç§æ ¡å¯¹è§„åˆ™ï¼Œä¸”éƒ½æœ‰ä¸€ä¸ªé»˜è®¤æ ¡å¯¹è§„åˆ™ï¼Œé‚£åœ¨ MySQL ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨å­—ç¬¦é›†çš„ï¼Ÿåœ¨ MySQL ä¸­å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è®¾ç½®å­—ç¬¦é›†ï¼šåˆ›å»ºå¯¹è±¡æ—¶è®¾ç½®é»˜è®¤å€¼ã€å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ—¶æ˜¾å¼è®¾ç½®ã€‚</p><p>MySQL é‡‡ç”¨ â€œé˜¶æ¢¯â€ å¼çš„æ–¹å¼æ¥è®¾å®šå­—ç¬¦é›†é»˜è®¤å€¼ï¼Œæ¯ä¸ªæ•°æ®åº“ï¼Œæ¯å¼ è¡¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤å€¼ï¼Œå®ƒä»¬é€å±‚ç»§æ‰¿ï¼Œæœ€ç»ˆæœ€é åº•å±‚çš„é»˜è®¤è®¾ç½®å°†å½±å“ä½ åˆ›å»ºçš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œåˆ›å»ºæ•°æ®åº“æ—¶ï¼Œå°†æ ¹æ®æœåŠ¡å™¨ä¸Šçš„character_set_serveræ¥è®¾ç½®æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†ï¼ŒåŒæ ·çš„é“ç†ï¼Œæ ¹æ®databaseçš„å­—ç¬¦é›†æ¥æŒ‡å®šåº“ä¸­æ‰€æœ‰è¡¨çš„å­—ç¬¦é›†â€¦â€¦ ä¸ç®¡æ˜¯å¯¹æ•°æ®åº“ï¼Œè¿˜æ˜¯è¡¨å’Œåˆ—ï¼Œåªæœ‰å½“å®ƒä»¬æ²¡æœ‰æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†æ—¶ï¼Œé»˜è®¤å­—ç¬¦é›†æ‰ä¼šèµ·ä½œç”¨ã€‚</p><p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨ä¸åŒçš„å­—ç¬¦é›†ï¼Œè¿™æ—¶å€™æœåŠ¡å™¨å°†è¿›è¡Œå¿…è¦çš„è½¬æ¢å·¥ä½œã€‚å½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæ•°æ®ä»¥character_set_clientè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ï¼›è€Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ SQL æˆ–è€…æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§character_set_connectionè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œè½¬æ¢ï¼›å½“æœåŠ¡å™¨å°†è¦è¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰æ“ä½œå‰ä¼šå†æ¬¡å°†æ•°æ®è½¬æ¢æˆcharacter_set_database(æ•°æ®åº“é‡‡ç”¨çš„å­—ç¬¦é›†ï¼Œæ²¡æœ‰å•ç‹¬é…ç½®å³ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œå…·ä½“å‚è€ƒä¸Šæ–‡)ï¼Œæœ€åå½“æœåŠ¡å™¨è¿”å›æ•°æ®æˆ–è€…é”™è¯¯ä¿¡æ¯æ—¶ï¼Œåˆ™å°†æ•°æ®æŒ‰character_set_resultè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ã€‚æœåŠ¡å™¨ç«¯å¯ä»¥ä½¿ç”¨SET CHARACTER SETæ¥æ”¹å˜ä¸Šé¢çš„é…ç½®ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ ¹æ®å¯¹åº”çš„ API æ¥æ”¹å˜å­—ç¬¦é›†é…ç½®ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½ä½¿ç”¨æ­£ç¡®çš„å­—ç¬¦é›†æ‰èƒ½é¿å…åœ¨é€šä¿¡ä¸­å‡ºç°é—®é¢˜ã€‚</p><h4 id="é‚£å¦‚ä½•é€‰æ‹©å­—ç¬¦é›†"><a href="#é‚£å¦‚ä½•é€‰æ‹©å­—ç¬¦é›†" class="headerlink" title="é‚£å¦‚ä½•é€‰æ‹©å­—ç¬¦é›†"></a>é‚£å¦‚ä½•é€‰æ‹©å­—ç¬¦é›†</h4><p>åœ¨è€ƒè™‘ä½¿ç”¨ä½•ç§å­—ç¬¦é›†æ—¶ï¼Œæœ€ä¸»è¦çš„è¡¡é‡å› ç´ æ˜¯å­˜å‚¨çš„å†…å®¹ï¼Œåœ¨èƒ½å¤Ÿæ»¡è¶³å­˜å‚¨å†…å®¹çš„å‰æä¸‹ï¼Œå°½é‡ä½¿ç”¨è¾ƒå°çš„å­—ç¬¦é›†ã€‚å› ä¸ºæ›´å°çš„å­—ç¬¦é›†æ„å‘³ç€æ›´å°‘ç©ºé—´å ç”¨ã€ä»¥åŠæ›´é«˜çš„ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼Œä¹Ÿé—´æ¥æé«˜äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚å¦‚æœå­˜å‚¨çš„å†…å®¹æ˜¯è‹±æ–‡å­—ç¬¦ç­‰æ‹‰ä¸è¯­ç³»å­—ç¬¦çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„latin1å­—ç¬¦é›†å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼ˆMySQL 8 é»˜è®¤utf8mb4ï¼‰ï¼Œå¦‚æœéœ€è¦å­˜å‚¨æ±‰å­—ã€ä¿„æ–‡ã€é˜¿æ‹‰ä¼¯è¯­ç­‰éæ‹‰ä¸è¯­ç³»å­—ç¬¦ï¼Œåˆ™å»ºè®®ä½¿ç”¨UTF8å­—ç¬¦é›†ã€‚å½“ç„¶ä¸åŒå­—ç¬¦åœ¨ä½¿ç”¨UTF8å­—ç¬¦é›†æ‰€å ç”¨çš„ç©ºé—´æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚è‹±æ–‡å­—ç¬¦åœ¨UTF8å­—ç¬¦é›†ä¸­åªä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œä¸€ä¸ªæ±‰å­—åˆ™å ç”¨ 3 ä¸ªå­—èŠ‚ã€‚</p><p>é™¤äº†å­—ç¬¦é›†ï¼Œæ ¡å¯¹è§„åˆ™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¯¹äºæ ¡å¯¹è§„åˆ™ï¼Œä¸€èˆ¬æ¥è¯´åªéœ€è¦è€ƒè™‘æ˜¯å¦ä»¥å¤§å°å†™æ•æ„Ÿçš„æ–¹å¼æ¯”è¾ƒå­—ç¬¦ä¸²æˆ–è€…æ˜¯å¦ç”¨å­—ç¬¦ä¸²ç¼–ç çš„äºŒè¿›åˆ¶æ¥æ¯”è¾ƒå¤§å°ï¼Œå…¶å¯¹åº”çš„æ ¡å¯¹è§„åˆ™çš„åç¼€åˆ†åˆ«æ˜¯_csã€_ciå’Œ_binã€‚å¤§å°å†™æ•æ„Ÿå’ŒäºŒè¿›åˆ¶æ ¡å¯¹è§„åˆ™çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒäºŒè¿›åˆ¶æ ¡å¯¹è§„åˆ™ç›´æ¥ä½¿ç”¨å­—ç¬¦çš„å­—èŠ‚è¿›è¡Œæ¯”è¾ƒï¼Œè€Œå¤§å°å†™æ•æ„Ÿçš„æ ¡å¯¹è§„åˆ™åœ¨å¤šå­—èŠ‚å­—ç¬¦é›†æ—¶ï¼Œå¦‚å¾·è¯­ï¼Œæœ‰æ›´å¤æ‚çš„æ¯”è¾ƒè§„åˆ™ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ŒUTF8å­—ç¬¦é›†å¯¹åº”æ ¡å¯¹è§„åˆ™æœ‰ä¸‰ç§ï¼š</p><ul><li>utf8_binå°†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ç”¨äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨ï¼ŒåŒºåˆ†å¤§å°å†™</li><li>utf8_general_ciä¸åŒºåˆ†å¤§å°å†™ï¼Œciä¸ºcase insensitiveçš„ç¼©å†™ï¼Œå³å¤§å°å†™ä¸æ•æ„Ÿ</li><li>utf8_general_csåŒºåˆ†å¤§å°å†™ï¼Œcsä¸ºcase sensitiveçš„ç¼©å†™ï¼Œå³å¤§å°å†™æ•æ„Ÿ</li></ul><p>æ¯”å¦‚ï¼Œåˆ›å»ºä¸€å¼ è¡¨ï¼Œä½¿ç”¨UTF8ç¼–ç ï¼Œä¸”å¤§å°å†™æ•æ„Ÿæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE sales (</span><br><span class="line">    order_no VARCHAR(32) NOT NULL PRIMARY KEY,</span><br><span class="line">    order_amount INT NOT NULL DEFAULT 0,</span><br><span class="line">    ......</span><br><span class="line">) ENGINE=InnoDB COLLATE=utf8_general_cs;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å› æ­¤ï¼Œåœ¨é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨UTF8å­—ç¬¦é›†æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†éœ€è¦è®°ä½çš„æ˜¯ä¸è¦åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ä½¿ç”¨å¤šä¸ªä¸åŒçš„å­—ç¬¦é›†ï¼Œä¸åŒå­—ç¬¦é›†ä¹‹é—´çš„ä¸å…¼å®¹é—®é¢˜å¾ˆéš¾ç¼ ã€‚æœ‰æ—¶å€™ï¼Œçœ‹èµ·æ¥ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯å½“æŸä¸ªç‰¹æ®Šå­—ç¬¦å‡ºç°æ—¶ï¼Œä¸€åˆ‡æ“ä½œéƒ½ä¼šå‡ºé”™ï¼Œè€Œä¸”ä½ å¾ˆéš¾å‘ç°é”™è¯¯çš„åŸå› ã€‚</p><h4 id="å­—ç¬¦é›†å¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰å½±å“å—"><a href="#å­—ç¬¦é›†å¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰å½±å“å—" class="headerlink" title="å­—ç¬¦é›†å¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰å½±å“å—"></a>å­—ç¬¦é›†å¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰å½±å“å—</h4><p>æŸäº›å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™å¯èƒ½ä¼šéœ€è¦å¤šä¸ªçš„ CPU æ“ä½œï¼Œå¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ç©ºé—´ï¼Œè¿™ç‚¹åœ¨å‰æ–‡å·²ç»è¯´è¿‡ã€‚ç‰¹åˆ«æ˜¯åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ä½¿ç”¨ä¸åŒçš„å­—ç¬¦é›†ï¼Œé€ æˆçš„å½±å“å¯èƒ½ä¼šæ›´å¤§ã€‚</p><p>ä¸åŒå­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ä¹‹é—´çš„è½¬æ¢å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿå¼€é”€ï¼Œæ¯”å¦‚ï¼Œæ•°æ®è¡¨salesåœ¨buyerå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼Œåˆ™å¯ä»¥åŠ é€Ÿä¸‹é¢çš„ORDER BYæ“ä½œï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT order_no,order_amount FROM sales ORDER BY buyer;</span><br></pre></td></tr></tbody></table></figure><p></p><p>åªæœ‰å½“ SQL æŸ¥è¯¢ä¸­æ’åºè¦æ±‚çš„å­—ç¬¦é›†ä¸æœåŠ¡å™¨æ•°æ®çš„å­—ç¬¦é›†ç›¸åŒæ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™ä¸æ˜¯åºŸè¯å—ï¼Ÿå…¶å®ä¸ç„¶ï¼ŒMySQL æ˜¯å¯ä»¥å•ç‹¬æŒ‡å®šæ’åºæ—¶ä½¿ç”¨çš„æ ¡å¯¹è§„åˆ™çš„ï¼Œæ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- ä½ è¯´ï¼Œè¿™ä¸æ˜¯åƒé¥±äº†æ’‘çš„å—ï¼Ÿæˆ‘è§‰å¾—ä¹Ÿæ˜¯ï¼Œä¹Ÿè®¸ä¼šæœ‰å…¶é€‚ç”¨çš„åœºæ™¯å§</span><br><span class="line">-- è¿™æ—¶å€™å°±ä¸èƒ½ä½¿ç”¨ç´¢å¼•æ’åºå‘¢ï¼Œåªèƒ½ä½¿ç”¨æ–‡ä»¶æ’åº</span><br><span class="line">SELECT order_no,order_amount FROM sales ORDER BY buyer COLLATE utf8_bin;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å½“ä½¿ç”¨ä¸¤ä¸ªå­—ç¬¦é›†ä¸åŒçš„åˆ—æ¥å…³è”ä¸¤å¼ è¡¨æ—¶ï¼ŒMySQL ä¼šå°è¯•è½¬æ¢å…¶ä¸­ä¸€ä¸ªåˆ—çš„å­—ç¬¦é›†ã€‚è¿™å’Œåœ¨æ•°æ®åˆ—å¤–é¢å°è£…ä¸€ä¸ªå‡½æ•°ä¸€æ ·ï¼Œä¼šè®© MySQL æ— æ³•ä½¿ç”¨è¿™ä¸ªåˆ—ä¸Šçš„ç´¢å¼•ã€‚å…³äº MySQL å­—ç¬¦é›†è¿˜æœ‰ä¸€äº›å‘ï¼Œä½†åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­é‡åˆ°çš„å­—ç¬¦é›†é—®é¢˜ï¼Œå…¶å®ä¸æ˜¯ç‰¹åˆ«çš„å¤šï¼Œæ‰€ä»¥å°±æ­¤æ‰“ä½ã€‚</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>MySQL è¿˜æœ‰ä¸€äº›å…¶ä»–é«˜çº§ç‰¹æ€§ï¼Œä½†åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬å¾ˆå°‘ä¼šä½¿ç”¨ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæ²¡æœ‰è®¨è®ºï¼Œä½†å¤šäº†è§£ä¸€äº›æ€»æ˜¯å¥½çš„ï¼Œè‡³å°‘åœ¨éœ€è¦çš„æ—¶å€™ï¼Œä½ çŸ¥é“æœ‰è¿™æ ·ä¸€ä¸ªä¸œè¥¿ã€‚æˆ‘ä»¬éå¸¸å¤šçš„äººï¼Œ<strong>æ€»æ˜¯ä¼šè®¤ä¸ºè‡ªå·±æ‰€å­¦çš„çŸ¥è¯†å°±åƒç¢ç‰‡ä¸€æ ·ä¸æˆä½“ç³»ï¼Œåˆæ‰¾ä¸åˆ°è§£å†³åŠæ³•ï¼Œé‚£ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¹Ÿè®¸æ˜¯ç¢ç‰‡ä¸å¤Ÿå¤šçš„ç¼˜æ•…ï¼Ÿç‚¹å¤ªå°‘ï¼Œè‡ªç„¶ä¸èƒ½è¿æ¥æˆçº¿ï¼Œçº¿å¤ªå°‘ï¼Œè‡ªç„¶ä¸èƒ½ç»“æˆç½‘</strong>ã€‚å› è€Œï¼Œæ²¡æœ‰å…¶ä»–åŠæ³•ï¼Œ<strong>ä¿æŒå¥½å¥‡å¿ƒã€å¤šå­¦ä¹ ã€å¤šç§¯ç´¯ï¼Œé‡å˜æ€»æœ‰ä¸€å¤©ä¼šè´¨å˜</strong>ã€‚</p><p>å‰é¢æˆ‘å†™çš„ä¸€äº›æ–‡ç« é‡Œé¢ä¼šæœ‰æåˆ°è¿‡ï¼Œæ¶æ„è®¾è®¡æ˜¯ä¸€ç§å¹³è¡¡çš„è‰ºæœ¯ï¼Œå…¶å®è´¨åº”è¯¥æ˜¯ä¸€ç§å¦¥åï¼Œæ˜¯å¯¹ç°æœ‰èµ„æºçš„ä¸€ç§å¦¥åã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¼šä¸è‡ªè§‰çš„é™·å…¥æŸä¸€ä¸ªç‚¹ï¼Œæ¯”å¦‚ï¼Œä¸ºäº†è¿½æ±‚æ•°æ®çš„æ‰©å±•æ€§ï¼Œå¾ˆå¤šäººä¸€ä¸Šæ¥å°±å¼€å§‹åˆ†åº“åˆ†è¡¨ï¼Œç„¶åæŠŠåº”ç”¨æå¾—éå¸¸å¤æ‚ï¼Œåˆ°æœ€åè¡¨é‡Œè¿˜æ²¡æœ‰è£…æ»¡æ•°æ®ï¼Œé¡¹ç›®å°±å·²ç»æ­»äº†ã€‚æ‰€ä»¥åœ¨èµ„æºæœ‰é™æˆ–è€…æœªæ¥è¿˜ä¸å¯çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨æ•°æ®åº“ã€è¯­è¨€æœ¬èº«çš„ç‰¹æ€§æ¥å®Œæˆç›¸åº”çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯ä¼šæ›´å¥½ä¸€ç‚¹ã€‚è§£å†³å¤§æ•°æ®é—®é¢˜ï¼Œä¹Ÿä¸åªæ˜¯åˆ†åº“åˆ†è¡¨ï¼Œä½ è¿˜åº”è¯¥è¿˜å¯ä»¥æƒ³åˆ°åˆ†åŒºï¼›æœ‰äº›ä¸šåŠ¡å³ä½¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¹Ÿä¸ä¸€å®šéè¦åœ¨ä¸šåŠ¡å±‚å®Œæˆï¼Œåˆç†ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨æˆ–è€…ä½¿ç”¨è‡ªå·±æ ¹æ®åˆ†è¡¨åˆ†åº“è§„åˆ™çš„å°å·¥å…·ä¹Ÿè®¸ä¼šè®©ä½ æ›´è½»æ¾â€¦â€¦</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ)</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;img.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL ä¼˜åŒ–åŸç†(ä¸€)</title>
    <link href="https://jiemin.wang/2019/03/29/mysql-optimization-principle-1/"/>
    <id>https://jiemin.wang/2019/03/29/mysql-optimization-principle-1/</id>
    <published>2019-03-29T06:57:21.000Z</published>
    <updated>2019-03-29T07:42:23.911Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æ‰«åœ°åªä¸è¿‡æ˜¯æˆ‘diè¡¨é¢å·¥ä½œï¼Œæˆ‘çœŸæ­£dièº«ä»½æ˜¯ä¸€ä½ç ”ç©¶â€”â€”åƒ§ã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¯´èµ· MySQL çš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶æ”¶è—äº†ä¸€å †å¥‡æŠ€æ·«å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨ NULL å­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦â€¦ ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿæˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚</p><h4 id="MySQL-é€»è¾‘æ¶æ„"><a href="#MySQL-é€»è¾‘æ¶æ„" class="headerlink" title="MySQL é€»è¾‘æ¶æ„"></a>MySQL é€»è¾‘æ¶æ„</h4><p>å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹… MySQL å„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£ MySQL æœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº† MySQL çš„é€»è¾‘æ¶æ„å›¾ã€‚<br><span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="img.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span></p><p>MySQL é€»è¾‘æ¶æ„æ•´ä½“åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€ä¸Šå±‚ä¸ºå®¢æˆ·ç«¯å±‚ï¼Œå¹¶é MySQL æ‰€ç‹¬æœ‰ï¼Œè¯¸å¦‚ï¼šè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€å®‰å…¨ç­‰åŠŸèƒ½å‡åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚</p><p>MySQL å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡å‡åœ¨ä¸­é—´è¿™ä¸€å±‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢è§£æã€åˆ†æã€ä¼˜åŒ–ã€ç¼“å­˜ã€å†…ç½®å‡½æ•° (æ¯”å¦‚ï¼šæ—¶é—´ã€æ•°å­¦ã€åŠ å¯†ç­‰å‡½æ•°)ã€‚æ‰€æœ‰çš„è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼šå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚</p><p>æœ€ä¸‹å±‚ä¸ºå­˜å‚¨å¼•æ“ï¼Œå…¶è´Ÿè´£ MySQL ä¸­çš„æ•°æ®å­˜å‚¨å’Œæå–ã€‚å’Œ Linux ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¯ç§å­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ä¸­é—´çš„æœåŠ¡å±‚é€šè¿‡ API ä¸å­˜å‚¨å¼•æ“é€šä¿¡ï¼Œè¿™äº› API æ¥å£å±è”½äº†ä¸åŒå­˜å‚¨å¼•æ“é—´çš„å·®å¼‚ã€‚</p><h4 id="MySQL-æŸ¥è¯¢è¿‡ç¨‹"><a href="#MySQL-æŸ¥è¯¢è¿‡ç¨‹" class="headerlink" title="MySQL æŸ¥è¯¢è¿‡ç¨‹"></a>MySQL æŸ¥è¯¢è¿‡ç¨‹</h4><p>æˆ‘ä»¬æ€»æ˜¯å¸Œæœ› MySQL èƒ½å¤Ÿè·å¾—æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å¼„æ¸…æ¥š MySQL æ˜¯å¦‚ä½•ä¼˜åŒ–å’Œæ‰§è¡ŒæŸ¥è¯¢çš„ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°ï¼š<strong>å¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®© MySQL çš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²</strong>ã€‚</p><p>å½“å‘ MySQL å‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒMySQL åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ<br><img src="/2019/03/29/mysql-optimization-principle-1/SQLluoji.jpg" title="SQLluoji"></p><h4 id="å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡åè®®"><a href="#å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡åè®®" class="headerlink" title="å®¢æˆ·ç«¯ / æœåŠ¡ç«¯é€šä¿¡åè®®"></a>å®¢æˆ·ç«¯ / æœåŠ¡ç«¯é€šä¿¡åè®®</h4><p>MySQL å®¢æˆ·ç«¯ / æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯ â€œåŠåŒå·¥â€ çš„ï¼šåœ¨ä»»ä¸€æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚</p><p>å®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®<code>max_allowed_packet</code>å‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>ä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨<code>SELECT *</code>ä»¥åŠåŠ ä¸Š<code>LIMIT</code>é™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚</p><h4 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h4><p>åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆ MySQL ä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚</p><p>MySQL å°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆä¸è¦ç†è§£æˆ<code>table</code>ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç±»ä¼¼äº<code>HashMap</code>çš„æ•°æ®ç»“æ„ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚</p><p>å¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€MySQL åº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°<code>NOW()</code>æˆ–è€…<code>CURRENT_DATE()</code>ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«<code>CURRENT_USER</code>æˆ–è€…<code>CONNECION_ID()</code>çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚</p><p>æ—¢ç„¶æ˜¯ç¼“å­˜ï¼Œå°±ä¼šå¤±æ•ˆï¼Œé‚£æŸ¥è¯¢ç¼“å­˜ä½•æ—¶å¤±æ•ˆå‘¢ï¼ŸMySQL çš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQL å¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ï¼š</p><ul><li>ä»»ä½•çš„æŸ¥è¯¢è¯­å¥åœ¨å¼€å§‹ä¹‹å‰éƒ½å¿…é¡»ç»è¿‡æ£€æŸ¥ï¼Œå³ä½¿è¿™æ¡ SQL è¯­å¥æ°¸è¿œä¸ä¼šå‘½ä¸­ç¼“å­˜</li><li>å¦‚æœæŸ¥è¯¢ç»“æœå¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—</li></ul><p>åŸºäºæ­¤ï¼Œæˆ‘ä»¬è¦çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†è¦å¦‚ä½•è¯„ä¼°æ‰“å¼€ç¼“å­˜æ˜¯å¦èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½æå‡æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…ï¼Œä¹Ÿä¸åœ¨æœ¬æ–‡è®¨è®ºçš„èŒƒç•´å†…ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p><ol><li>ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡</li><li>æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥</li><li>åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚</li><li>å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜</li></ol><p>æœ€åçš„å¿ å‘Šæ˜¯ä¸è¦è½»æ˜“æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯å†™å¯†é›†å‹åº”ç”¨ã€‚å¦‚æœä½ å®åœ¨æ˜¯å¿ä¸ä½ï¼Œå¯ä»¥å°†<code>query_cache_type</code>è®¾ç½®ä¸º<code>DEMAND</code>ï¼Œè¿™æ—¶åªæœ‰åŠ å…¥<code>SQL_CACHE</code>çš„æŸ¥è¯¢æ‰ä¼šèµ°ç¼“å­˜ï¼Œå…¶ä»–æŸ¥è¯¢åˆ™ä¸ä¼šï¼Œè¿™æ ·å¯ä»¥éå¸¸è‡ªç”±åœ°æ§åˆ¶å“ªäº›æŸ¥è¯¢éœ€è¦è¢«ç¼“å­˜ã€‚</p><p>å½“ç„¶æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿæœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œè®¨è®ºçš„ä¹Ÿåªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–æ›´æ·±å…¥çš„è¯é¢˜ï¼Œæ¯”å¦‚ï¼šç¼“å­˜æ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„ï¼Ÿå¦‚ä½•æ§åˆ¶å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Ÿäº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜æœ‰ä½•å½±å“ç­‰ç­‰ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæƒå½“æŠ›ç –å¼•ç‰å§ã€‚</p><h4 id="è¯­æ³•è§£æå’Œé¢„å¤„ç†"><a href="#è¯­æ³•è§£æå’Œé¢„å¤„ç†" class="headerlink" title="è¯­æ³•è§£æå’Œé¢„å¤„ç†"></a>è¯­æ³•è§£æå’Œé¢„å¤„ç†</h4><p>MySQL é€šè¿‡å…³é”®å­—å°† SQL è¯­å¥è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æã€‚æ¯”å¦‚ SQL ä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ® MySQL è§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ã€‚æ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ç­‰ã€‚</p><h4 id="æŸ¥è¯¢ä¼˜åŒ–"><a href="#æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–"></a>æŸ¥è¯¢ä¼˜åŒ–</h4><p>ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>MySQL ä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨ MySQL å¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql> select * from t_message <span class="built_in">limit</span> 10;</span><br><span class="line">...çœç•¥ç»“æœé›†</span><br><span class="line"></span><br><span class="line">mysql> show status like <span class="string">'last_query_cost'</span>;</span><br><span class="line">+-----------------+-------------+</span><br><span class="line">| Variable_name   | Value       |</span><br><span class="line">+-----------------+-------------+</span><br><span class="line">| Last_query_cost | 6391.799000 |</span><br><span class="line">+-----------------+-------------+</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç¤ºä¾‹ä¸­çš„ç»“æœè¡¨ç¤ºä¼˜åŒ–å™¨è®¤ä¸ºå¤§æ¦‚éœ€è¦åš 6391 ä¸ªæ•°æ®é¡µçš„éšæœºæŸ¥æ‰¾æ‰èƒ½å®Œæˆä¸Šé¢çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç»“æœæ˜¯æ ¹æ®ä¸€äº›åˆ—çš„ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å¾—æ¥çš„ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼šæ¯å¼ è¡¨æˆ–è€…ç´¢å¼•çš„é¡µé¢ä¸ªæ•°ã€ç´¢å¼•çš„åŸºæ•°ã€ç´¢å¼•å’Œæ•°æ®è¡Œçš„é•¿åº¦ã€ç´¢å¼•çš„åˆ†å¸ƒæƒ…å†µç­‰ç­‰ã€‚</p><p>æœ‰éå¸¸å¤šçš„åŸå› ä¼šå¯¼è‡´ MySQL é€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ã€ä¸ä¼šè€ƒè™‘ä¸å—å…¶æ§åˆ¶çš„æ“ä½œæˆæœ¬ï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€MySQL è®¤ä¸ºçš„æœ€ä¼˜è·Ÿæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼ˆæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½† MySQL åªé€‰æ‹©å®ƒè®¤ä¸ºæˆæœ¬å°çš„ï¼Œä½†æˆæœ¬å°å¹¶ä¸æ„å‘³ç€æ‰§è¡Œæ—¶é—´çŸ­ï¼‰ç­‰ç­‰ã€‚</p><p>MySQL çš„æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éƒ¨ä»¶ï¼Œå®ƒä½¿ç”¨äº†éå¸¸å¤šçš„ä¼˜åŒ–ç­–ç•¥æ¥ç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼š</p><ul><li>é‡æ–°å®šä¹‰è¡¨çš„å…³è”é¡ºåºï¼ˆå¤šå¼ è¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œå¹¶ä¸ä¸€å®šæŒ‰ç…§ SQL ä¸­æŒ‡å®šçš„é¡ºåºè¿›è¡Œï¼Œä½†æœ‰ä¸€äº›æŠ€å·§å¯ä»¥æŒ‡å®šå…³è”é¡ºåºï¼‰</li><li>ä¼˜åŒ–MIN()å’ŒMAX()å‡½æ•°ï¼ˆæ‰¾æŸåˆ—çš„æœ€å°å€¼ï¼Œå¦‚æœè¯¥åˆ—æœ‰ç´¢å¼•ï¼Œåªéœ€è¦æŸ¥æ‰¾ B+Tree ç´¢å¼•æœ€å·¦ç«¯ï¼Œåä¹‹åˆ™å¯ä»¥æ‰¾åˆ°æœ€å¤§å€¼ï¼Œå…·ä½“åŸç†è§ä¸‹æ–‡ï¼‰</li><li>æå‰ç»ˆæ­¢æŸ¥è¯¢ï¼ˆæ¯”å¦‚ï¼šä½¿ç”¨ Limit æ—¶ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ•°é‡çš„ç»“æœé›†åä¼šç«‹å³ç»ˆæ­¢æŸ¥è¯¢ï¼‰</li><li>ä¼˜åŒ–æ’åºï¼ˆåœ¨è€ç‰ˆæœ¬ MySQL ä¼šä½¿ç”¨ä¸¤æ¬¡ä¼ è¾“æ’åºï¼Œå³å…ˆè¯»å–è¡ŒæŒ‡é’ˆå’Œéœ€è¦æ’åºçš„å­—æ®µåœ¨å†…å­˜ä¸­å¯¹å…¶æ’åºï¼Œç„¶åå†æ ¹æ®æ’åºç»“æœå»è¯»å–æ•°æ®è¡Œï¼Œè€Œæ–°ç‰ˆæœ¬é‡‡ç”¨çš„æ˜¯å•æ¬¡ä¼ è¾“æ’åºï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡è¯»å–æ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç„¶åæ ¹æ®ç»™å®šçš„åˆ—æ’åºã€‚å¯¹äº I/O å¯†é›†å‹åº”ç”¨ï¼Œæ•ˆç‡ä¼šé«˜å¾ˆå¤šï¼‰</li></ul><p>éšç€ MySQL çš„ä¸æ–­å‘å±•ï¼Œä¼˜åŒ–å™¨ä½¿ç”¨çš„ä¼˜åŒ–ç­–ç•¥ä¹Ÿåœ¨ä¸æ–­çš„è¿›åŒ–ï¼Œè¿™é‡Œä»…ä»…ä»‹ç»å‡ ä¸ªéå¸¸å¸¸ç”¨ä¸”å®¹æ˜“ç†è§£çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå…¶ä»–çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¤§å®¶è‡ªè¡ŒæŸ¥é˜…å§ã€‚</p><h4 id="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"><a href="#æŸ¥è¯¢æ‰§è¡Œå¼•æ“" class="headerlink" title="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"></a>æŸ¥è¯¢æ‰§è¡Œå¼•æ“</h4><p>åœ¨å®Œæˆè§£æå’Œä¼˜åŒ–é˜¶æ®µä»¥åï¼ŒMySQL ä¼šç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œå¼•æ“æ ¹æ®æ‰§è¡Œè®¡åˆ’ç»™å‡ºçš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œå¾—å‡ºç»“æœã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„å¤§éƒ¨åˆ†æ“ä½œå‡æ˜¯é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£æ¥å®Œæˆï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸º<code>handler API</code>ã€‚æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ¯ä¸€å¼ è¡¨ç”±ä¸€ä¸ª<code>handler</code>å®ä¾‹è¡¨ç¤ºã€‚å®é™…ä¸Šï¼ŒMySQL åœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µå°±ä¸ºæ¯ä¸€å¼ è¡¨åˆ›å»ºäº†ä¸€ä¸ª<code>handler</code>å®ä¾‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®è¿™äº›å®ä¾‹çš„æ¥å£æ¥è·å–è¡¨çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„æ‰€æœ‰åˆ—åã€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚å­˜å‚¨å¼•æ“æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å…¶åº•å±‚ä»…æœ‰å‡ åä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£åƒæ­ç§¯æœ¨ä¸€æ ·å®Œæˆäº†ä¸€æ¬¡æŸ¥è¯¢çš„å¤§éƒ¨åˆ†æ“ä½œã€‚</p><h4 id="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"><a href="#è¿”å›ç»“æœç»™å®¢æˆ·ç«¯" class="headerlink" title="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"></a>è¿”å›ç»“æœç»™å®¢æˆ·ç«¯</h4><p>æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼ŒMySQL ä»ç„¶ä¼šè¿”å›è¿™ä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚è¯¥æŸ¥è¯¢å½±å“åˆ°çš„è¡Œæ•°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰ç­‰ã€‚</p><p>å¦‚æœæŸ¥è¯¢ç¼“å­˜è¢«æ‰“å¼€ä¸”è¿™ä¸ªæŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼ŒMySQL ä¹Ÿä¼šå°†ç»“æœå­˜æ”¾åˆ°ç¼“å­˜ä¸­ã€‚</p><p>ç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ä¸”é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚æœ‰å¯èƒ½ MySQL åœ¨ç”Ÿæˆç¬¬ä¸€æ¡ç»“æœæ—¶ï¼Œå°±å¼€å§‹å‘å®¢æˆ·ç«¯é€æ­¥è¿”å›ç»“æœé›†äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±æ— é¡»å­˜å‚¨å¤ªå¤šç»“æœè€Œæ¶ˆè€—è¿‡å¤šå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®©å®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›ç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œéƒ½ä¼šä»¥ä¸€ä¸ªæ»¡è¶³ â‘  ä¸­æ‰€æè¿°çš„é€šä¿¡åè®®çš„æ•°æ®åŒ…å‘é€ï¼Œå†é€šè¿‡ TCP åè®®è¿›è¡Œä¼ è¾“ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¹ MySQL çš„æ•°æ®åŒ…è¿›è¡Œç¼“å­˜ç„¶åæ‰¹é‡å‘é€ã€‚</p><p>å›å¤´æ€»ç»“ä¸€ä¸‹ MySQL æ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘ MySQL æœåŠ¡å™¨å‘é€ä¸€æ¡æŸ¥è¯¢è¯·æ±‚</li><li>æœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç«‹åˆ»è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœã€‚å¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</li><li>æœåŠ¡å™¨è¿›è¡Œ SQL è§£æã€é¢„å¤„ç†ã€å†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’</li><li>MySQL æ ¹æ®æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„ API æ¥æ‰§è¡ŒæŸ¥è¯¢</li><li>å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ç¼“å­˜æŸ¥è¯¢ç»“æœ</li></ol><h4 id="æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>æ€§èƒ½ä¼˜åŒ–å»ºè®®</h4><p>çœ‹äº†è¿™ä¹ˆå¤šï¼Œä½ å¯èƒ½ä¼šæœŸå¾…ç»™å‡ºä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œæ˜¯çš„ï¼Œä¸‹é¢ä¼šä» 3 ä¸ªä¸åŒæ–¹é¢ç»™å‡ºä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ä½†è¯·ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€å¥å¿ å‘Šè¦å…ˆé€ç»™ä½ ï¼šä¸è¦å¬ä¿¡ä½ çœ‹åˆ°çš„å…³äºä¼˜åŒ–çš„ â€œç»å¯¹çœŸç†â€ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ‰€è®¨è®ºçš„å†…å®¹ï¼Œè€Œåº”è¯¥æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸‹é€šè¿‡æµ‹è¯•æ¥éªŒè¯ä½ å…³äºæ‰§è¡Œè®¡åˆ’ä»¥åŠå“åº”æ—¶é—´çš„å‡è®¾ã€‚</p><p><strong>Scheme è®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ–</strong></p><p>é€‰æ‹©æ•°æ®ç±»å‹åªè¦éµå¾ªå°è€Œç®€å•çš„åŸåˆ™å°±å¥½ï¼Œè¶Šå°çš„æ•°æ®ç±»å‹é€šå¸¸ä¼šæ›´å¿«ï¼Œå ç”¨æ›´å°‘çš„ç£ç›˜ã€å†…å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„ CPU å‘¨æœŸä¹Ÿæ›´å°‘ã€‚è¶Šç®€å•çš„æ•°æ®ç±»å‹åœ¨è®¡ç®—æ—¶éœ€è¦æ›´å°‘çš„ CPU å‘¨æœŸï¼Œæ¯”å¦‚ï¼Œæ•´å‹å°±æ¯”å­—ç¬¦æ“ä½œä»£ä»·ä½ï¼Œå› è€Œä¼šä½¿ç”¨æ•´å‹æ¥å­˜å‚¨ IP åœ°å€ï¼Œä½¿ç”¨DATETIMEæ¥å­˜å‚¨æ—¶é—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ã€‚</p><p>è¿™é‡Œæ€»ç»“å‡ ä¸ªå¯èƒ½å®¹æ˜“ç†è§£é”™è¯¯çš„æŠ€å·§ï¼š</p><ol><li>é€šå¸¸æ¥è¯´æŠŠå¯ä¸º<code>NULL</code>çš„åˆ—æ”¹ä¸º<code>NOT NULL</code>ä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå°‘å¸®åŠ©ï¼Œåªæ˜¯å¦‚æœè®¡åˆ’åœ¨åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå°±åº”è¯¥å°†è¯¥åˆ—è®¾ç½®ä¸º<code>NOT NULL</code>ã€‚</li><li>å¯¹æ•´æ•°ç±»å‹æŒ‡å®šå®½åº¦ï¼Œæ¯”å¦‚<code>INT(11)</code>ï¼Œæ²¡æœ‰ä»»ä½•åµç”¨ã€‚<code>INT</code>ä½¿ç”¨ <code>32</code> ä½ï¼ˆ<code>4</code> ä¸ªå­—èŠ‚ï¼‰å­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒçš„è¡¨ç¤ºèŒƒå›´å·²ç»ç¡®å®šï¼Œæ‰€ä»¥<code>INT(1)</code>å’Œ<code>INT(20)</code>å¯¹äºå­˜å‚¨å’Œè®¡ç®—æ˜¯ç›¸åŒçš„ã€‚</li><li><code>UNSIGNED</code>è¡¨ç¤ºä¸å…è®¸è´Ÿå€¼ï¼Œå¤§è‡´å¯ä»¥ä½¿æ­£æ•°çš„ä¸Šé™æé«˜ä¸€å€ã€‚æ¯”å¦‚<code>TINYINT</code>å­˜å‚¨èŒƒå›´æ˜¯ <code>-128 ~ 127</code>ï¼Œè€Œ<code>UNSIGNED TINYINT</code>å­˜å‚¨çš„èŒƒå›´å´æ˜¯ <code>0 - 255</code>ã€‚</li><li>é€šå¸¸æ¥è®²ï¼Œæ²¡æœ‰å¤ªå¤§çš„å¿…è¦ä½¿ç”¨<code>DECIMAL</code>æ•°æ®ç±»å‹ã€‚å³ä½¿æ˜¯åœ¨éœ€è¦å­˜å‚¨è´¢åŠ¡æ•°æ®æ—¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨<code>BIGINT</code>ã€‚æ¯”å¦‚éœ€è¦ç²¾ç¡®åˆ°ä¸‡åˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ•°æ®ä¹˜ä»¥ä¸€ç™¾ä¸‡ç„¶åä½¿ç”¨<code>BIGINT</code>å­˜å‚¨ã€‚è¿™æ ·å¯ä»¥é¿å…æµ®ç‚¹æ•°è®¡ç®—ä¸å‡†ç¡®å’Œ<code>DECIMAL</code>ç²¾ç¡®è®¡ç®—ä»£ä»·é«˜çš„é—®é¢˜ã€‚</li><li><code>TIMESTAMP</code>ä½¿ç”¨ 4 ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ï¼Œ<code>DATETIME</code>ä½¿ç”¨ <code>8</code> ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ã€‚å› è€Œï¼Œ<code>TIMESTAMP</code>åªèƒ½è¡¨ç¤º <code>1970 - 2038</code> å¹´ï¼Œæ¯”<code>DATETIME</code>è¡¨ç¤ºçš„èŒƒå›´å°å¾—å¤šï¼Œè€Œä¸”<code>TIMESTAMP</code>çš„å€¼å› æ—¶åŒºä¸åŒè€Œä¸åŒã€‚</li><li>å¤§å¤šæ•°æƒ…å†µä¸‹æ²¡æœ‰ä½¿ç”¨æšä¸¾ç±»å‹çš„å¿…è¦ï¼Œå…¶ä¸­ä¸€ä¸ªç¼ºç‚¹æ˜¯æšä¸¾çš„å­—ç¬¦ä¸²åˆ—è¡¨æ˜¯å›ºå®šçš„ï¼Œæ·»åŠ å’Œåˆ é™¤å­—ç¬¦ä¸²ï¼ˆæšä¸¾é€‰é¡¹ï¼‰å¿…é¡»ä½¿ç”¨<code>ALTER TABLE</code>ï¼ˆå¦‚æœåªåªæ˜¯åœ¨åˆ—è¡¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œä¸éœ€è¦é‡å»ºè¡¨ï¼‰ã€‚</li><li><code>schema</code> çš„åˆ—ä¸è¦å¤ªå¤šã€‚åŸå› æ˜¯å­˜å‚¨å¼•æ“çš„ API å·¥ä½œæ—¶éœ€è¦åœ¨æœåŠ¡å™¨å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¹‹é—´é€šè¿‡è¡Œç¼“å†²æ ¼å¼æ‹·è´æ•°æ®ï¼Œç„¶ååœ¨æœåŠ¡å™¨å±‚å°†ç¼“å†²å†…å®¹è§£ç æˆå„ä¸ªåˆ—ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚å¦‚æœåˆ—å¤ªå¤šè€Œå®é™…ä½¿ç”¨çš„åˆ—åˆå¾ˆå°‘çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ <code>CPU</code> å ç”¨è¿‡é«˜ã€‚</li><li>å¤§è¡¨<code>ALTER TABLE</code>éå¸¸è€—æ—¶ï¼ŒMySQL æ‰§è¡Œå¤§éƒ¨åˆ†ä¿®æ”¹è¡¨ç»“æœæ“ä½œçš„æ–¹æ³•æ˜¯ç”¨æ–°çš„ç»“æ„åˆ›å»ºä¸€ä¸ªå¼ ç©ºè¡¨ï¼Œä»æ—§è¡¨ä¸­æŸ¥å‡ºæ‰€æœ‰çš„æ•°æ®æ’å…¥æ–°è¡¨ï¼Œç„¶åå†åˆ é™¤æ—§è¡¨ã€‚å°¤å…¶å½“å†…å­˜ä¸è¶³è€Œè¡¨åˆå¾ˆå¤§ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤§ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè€—æ—¶æ›´ä¹…ã€‚å½“ç„¶æœ‰ä¸€äº›å¥‡æŠ€æ·«å·§å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…ã€‚</li></ol><p><strong>åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•</strong><br>ç´¢å¼•æ˜¯æé«˜ MySQL æŸ¥è¯¢æ€§èƒ½çš„ä¸€ä¸ªé‡è¦é€”å¾„ï¼Œä½†è¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šå¯¼è‡´è¿‡é«˜çš„ç£ç›˜ä½¿ç”¨ç‡ä»¥åŠè¿‡é«˜çš„å†…å­˜å ç”¨ï¼Œä»è€Œå½±å“åº”ç”¨ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚åº”å½“å°½é‡é¿å…äº‹åæ‰æƒ³èµ·æ·»åŠ ç´¢å¼•ï¼Œå› ä¸ºäº‹åå¯èƒ½éœ€è¦ç›‘æ§å¤§é‡çš„ SQL æ‰èƒ½å®šä½åˆ°é—®é¢˜æ‰€åœ¨ï¼Œè€Œä¸”æ·»åŠ ç´¢å¼•çš„æ—¶é—´è‚¯å®šæ˜¯è¿œå¤§äºåˆå§‹æ·»åŠ ç´¢å¼•æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯è§ç´¢å¼•çš„æ·»åŠ ä¹Ÿæ˜¯éå¸¸æœ‰æŠ€æœ¯å«é‡çš„ã€‚</p><p>æ¥ä¸‹æ¥å°†å‘ä½ å±•ç¤ºä¸€ç³»åˆ—åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•çš„ç­–ç•¥ï¼Œä»¥åŠæ¯æ¡ç­–ç•¥å…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸ç´¢å¼•ç›¸å…³çš„ä¸€äº›ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå°†æœ‰åŠ©äºæ›´å¥½çš„ç†è§£åæ–‡çš„å†…å®¹ã€‚</p><p><strong>ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³•</strong></p><p>é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„ç´¢å¼•æ˜¯æŒ‡<code>B-Tree</code>ç´¢å¼•ï¼Œå®ƒæ˜¯ç›®å‰å…³ç³»å‹æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®æœ€ä¸ºå¸¸ç”¨å’Œæœ‰æ•ˆçš„ç´¢å¼•ï¼Œå¤§å¤šæ•°å­˜å‚¨å¼•æ“éƒ½æ”¯æŒè¿™ç§ç´¢å¼•ã€‚ä½¿ç”¨<code>B-Tree</code>è¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯å› ä¸º MySQL åœ¨<code>CREATE TABLE</code>æˆ–å…¶å®ƒè¯­å¥ä¸­ä½¿ç”¨äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½†å®é™…ä¸Šä¸åŒçš„å­˜å‚¨å¼•æ“å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ InnoDB å°±æ˜¯ä½¿ç”¨çš„æ˜¯å®ƒçš„å˜ç§B+Treeã€‚</p><p><code>B+Tree</code>ä¸­çš„ B æ˜¯æŒ‡<code>balance</code>ï¼Œæ„ä¸ºå¹³è¡¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒB + æ ‘ç´¢å¼•å¹¶ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªç»™å®šé”®å€¼çš„å…·ä½“è¡Œï¼Œå®ƒæ‰¾åˆ°çš„åªæ˜¯è¢«æŸ¥æ‰¾æ•°æ®è¡Œæ‰€åœ¨çš„é¡µï¼Œæ¥ç€æ•°æ®åº“ä¼šæŠŠé¡µè¯»å…¥åˆ°å†…å­˜ï¼Œå†åœ¨å†…å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œæœ€åå¾—åˆ°è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚</p><p>åœ¨ä»‹ç»<code>B+Tree</code>å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œå…¶å·¦å­æ ‘çš„å€¼æ€»æ˜¯å°äºæ ¹çš„å€¼ï¼Œå³å­æ ‘çš„å€¼æ€»æ˜¯å¤§äºæ ¹çš„å€¼ï¼Œå¦‚ä¸‹å›¾ â‘ ã€‚å¦‚æœè¦åœ¨è¿™è¯¾æ ‘ä¸­æŸ¥æ‰¾å€¼ä¸º 5 çš„è®°å½•ï¼Œå…¶å¤§è‡´æµç¨‹ï¼šå…ˆæ‰¾åˆ°æ ¹ï¼Œå…¶å€¼ä¸º 6ï¼Œå¤§äº 5ï¼Œæ‰€ä»¥æŸ¥æ‰¾å·¦å­æ ‘ï¼Œæ‰¾åˆ° 3ï¼Œè€Œ 5 å¤§äº 3ï¼Œæ¥ç€æ‰¾ 3 çš„å³å­æ ‘ï¼Œæ€»å…±æ‰¾äº† 3 æ¬¡ã€‚åŒæ ·çš„æ–¹æ³•ï¼Œå¦‚æœæŸ¥æ‰¾å€¼ä¸º 8 çš„è®°å½•ï¼Œä¹Ÿéœ€è¦æŸ¥æ‰¾ 3 æ¬¡ã€‚æ‰€ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸º (3 + 3 + 3 + 2 + 2 + 1) / 6 = 2.3 æ¬¡ï¼Œè€Œé¡ºåºæŸ¥æ‰¾çš„è¯ï¼ŒæŸ¥æ‰¾å€¼ä¸º 2 çš„è®°å½•ï¼Œä»…éœ€è¦ 1 æ¬¡ï¼Œä½†æŸ¥æ‰¾å€¼ä¸º 8 çš„è®°å½•åˆ™éœ€è¦ 6 æ¬¡ï¼Œæ‰€ä»¥é¡ºåºæŸ¥æ‰¾çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸ºï¼š(1 + 2 + 3 + 4 + 5 + 6) / 6 = 3.3 æ¬¡ï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾é€Ÿåº¦æ¯”é¡ºåºæŸ¥æ‰¾è¦å¿«ã€‚</p><p>ç”±äºäºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥ä»»æ„æ„é€ ï¼ŒåŒæ ·çš„å€¼ï¼Œå¯ä»¥æ„é€ å‡ºå¦‚å›¾ â‘¡ çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¾ç„¶è¿™æ£µäºŒå‰æ ‘çš„æŸ¥è¯¢æ•ˆç‡å’Œé¡ºåºæŸ¥æ‰¾å·®ä¸å¤šã€‚è‹¥æƒ³äºŒå‰æŸ¥æ‰¾æ•°çš„æŸ¥è¯¢æ€§èƒ½æœ€é«˜ï¼Œéœ€è¦è¿™æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ï¼Œä¹Ÿå³å¹³è¡¡äºŒå‰æ ‘ï¼ˆAVL æ ‘ï¼‰ã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/shu.jpg" title="shu"></p><p>å¹³è¡¡äºŒå‰æ ‘é¦–å…ˆéœ€è¦ç¬¦åˆäºŒå‰æŸ¥æ‰¾æ ‘çš„å®šä¹‰ï¼Œå…¶æ¬¡å¿…é¡»æ»¡è¶³ä»»ä½•èŠ‚ç‚¹çš„ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®ä¸èƒ½å¤§äº 1ã€‚æ˜¾ç„¶å›¾ â‘¡ ä¸æ»¡è¶³å¹³è¡¡äºŒå‰æ ‘çš„å®šä¹‰ï¼Œè€Œå›¾ â‘  æ˜¯ä¸€è¯¾å¹³è¡¡äºŒå‰æ ‘ã€‚å¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ€§èƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼ˆæ€§èƒ½æœ€å¥½çš„æ˜¯æœ€ä¼˜äºŒå‰æ ‘ï¼‰ï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå¥½ï¼Œç»´æŠ¤çš„æˆæœ¬å°±è¶Šå¤§ã€‚æ¯”å¦‚å›¾ â‘  çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œå½“ç”¨æˆ·éœ€è¦æ’å…¥ä¸€ä¸ªæ–°çš„å€¼ 9 çš„èŠ‚ç‚¹æ—¶ï¼Œå°±éœ€è¦åšå‡ºå¦‚ä¸‹å˜åŠ¨ã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/ershu.jpg" title="ershu"></p><p>é€šè¿‡ä¸€æ¬¡å·¦æ—‹æ“ä½œå°±å°†æ’å…¥åçš„æ ‘é‡æ–°å˜ä¸ºå¹³è¡¡äºŒå‰æ ‘æ˜¯æœ€ç®€å•çš„æƒ…å†µäº†ï¼Œå®é™…åº”ç”¨åœºæ™¯ä¸­å¯èƒ½éœ€è¦æ—‹è½¬å¤šæ¬¡ã€‚è‡³æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ•ˆç‡è¿˜ä¸é”™ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œç›¸åº”çš„ç»´æŠ¤æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œä¸ºä»€ä¹ˆ MySQL ç´¢å¼•ä¸ç›´æ¥ä½¿ç”¨å¹³è¡¡äºŒå‰æ ‘ï¼Ÿ</p><p>éšç€æ•°æ®åº“ä¸­æ•°æ®çš„å¢åŠ ï¼Œç´¢å¼•æœ¬èº«å¤§å°éšä¹‹å¢åŠ ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜ I/O æ¶ˆè€—ï¼Œç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/O å­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§ã€‚å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€æ£µå‡ ç™¾ä¸‡èŠ‚ç‚¹çš„äºŒå‰æ ‘çš„æ·±åº¦æ˜¯å¤šå°‘ï¼Ÿå¦‚æœå°†è¿™ä¹ˆå¤§æ·±åº¦çš„ä¸€é¢—äºŒå‰æ ‘æ”¾ç£ç›˜ä¸Šï¼Œæ¯è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä¸€æ¬¡ç£ç›˜çš„ I/O è¯»å–ï¼Œæ•´ä¸ªæŸ¥æ‰¾çš„è€—æ—¶æ˜¾ç„¶æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ã€‚é‚£ä¹ˆå¦‚ä½•å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„ I/O å­˜å–æ¬¡æ•°ï¼Ÿ</p><p>ä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯å‡å°‘æ ‘çš„æ·±åº¦ï¼Œå°†äºŒå‰æ ‘å˜ä¸º m å‰æ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼‰ï¼Œè€ŒB+Treeå°±æ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘ã€‚ç†è§£B+Treeæ—¶ï¼Œåªéœ€è¦ç†è§£å…¶æœ€é‡è¦çš„ä¸¤ä¸ªç‰¹å¾å³å¯ï¼šç¬¬ä¸€ï¼Œæ‰€æœ‰çš„å…³é”®å­—ï¼ˆå¯ä»¥ç†è§£ä¸ºæ•°æ®ï¼‰éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼ˆLeaf Pageï¼‰ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆIndex Pageï¼‰å¹¶ä¸å­˜å‚¨çœŸæ­£çš„æ•°æ®ï¼Œæ‰€æœ‰è®°å½•èŠ‚ç‚¹éƒ½æ˜¯æŒ‰é”®å€¼å¤§å°é¡ºåºå­˜æ”¾åœ¨åŒä¸€å±‚å¶å­èŠ‚ç‚¹ä¸Šã€‚å…¶æ¬¡ï¼Œæ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ç”±æŒ‡é’ˆè¿æ¥ã€‚å¦‚ä¸‹å›¾ä¸ºé«˜åº¦ä¸º 2 çš„ç®€åŒ–äº†çš„B+Treeã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/erbtree.jpg" title="erbtree"></p><p>æ€ä¹ˆç†è§£è¿™ä¸¤ä¸ªç‰¹å¾ï¼ŸMySQL å°†æ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ç½®ä¸ºä¸€ä¸ªé¡µçš„æ•´æ•°å€ï¼ˆåŸå› ä¸‹æ–‡ä¼šä»‹ç»ï¼‰ï¼Œä¹Ÿå°±æ˜¯åœ¨èŠ‚ç‚¹ç©ºé—´å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šçš„å†…ç»“ç‚¹ï¼Œè¿™æ ·æ¯ä¸ªç»“ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®ã€‚æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆé“¾æ¥çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡ŒåŒºé—´è®¿é—®ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå¦‚æœæŸ¥æ‰¾å¤§äº 20 è€Œå°äº 30 çš„è®°å½•ï¼Œåªéœ€è¦æ‰¾åˆ°èŠ‚ç‚¹ 20ï¼Œå°±å¯ä»¥éå†æŒ‡é’ˆä¾æ¬¡æ‰¾åˆ° 25ã€30ã€‚å¦‚æœæ²¡æœ‰é“¾æ¥æŒ‡é’ˆçš„è¯ï¼Œå°±æ— æ³•è¿›è¡ŒåŒºé—´æŸ¥æ‰¾ã€‚è¿™ä¹Ÿæ˜¯ MySQL ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•å­˜å‚¨ç»“æ„çš„é‡è¦åŸå› ã€‚</p><p>MySQL ä¸ºä½•å°†èŠ‚ç‚¹å¤§å°è®¾ç½®ä¸ºé¡µçš„æ•´æ•°å€ï¼Œè¿™å°±éœ€è¦ç†è§£ç£ç›˜çš„å­˜å‚¨åŸç†ã€‚ç£ç›˜æœ¬èº«å­˜å–å°±æ¯”ä¸»å­˜æ…¢å¾ˆå¤šï¼Œåœ¨åŠ ä¸Šæœºæ¢°è¿åŠ¨æŸè€—ï¼ˆç‰¹åˆ«æ˜¯æ™®é€šçš„æœºæ¢°ç¡¬ç›˜ï¼‰ï¼Œç£ç›˜çš„å­˜å–é€Ÿåº¦å¾€å¾€æ˜¯ä¸»å­˜çš„å‡ ç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œä¸ºäº†å°½é‡å‡å°‘ç£ç›˜ I/Oï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ï¼Œé¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µçš„æ•´æ•°å€ã€‚</p><blockquote><p>é¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠ OS å¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆè®¸å¤š OS ä¸­ï¼Œé¡µçš„å¤§å°é€šå¸¸ä¸º 4Kï¼‰ã€‚ä¸»å­˜å’Œç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚å½“ç¨‹åºè¦è¯»å–çš„æ•°æ®ä¸åœ¨ä¸»å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šå‘ç£ç›˜å‘å‡ºè¯»ç›˜ä¿¡å·ï¼Œç£ç›˜ä¼šæ‰¾åˆ°æ•°æ®çš„èµ·å§‹ä½ç½®å¹¶å‘åè¿ç»­è¯»å–ä¸€é¡µæˆ–å‡ é¡µè½½å…¥å†…å­˜ä¸­ï¼Œç„¶åä¸€èµ·è¿”å›ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚</p></blockquote><p>MySQL å·§å¦™åˆ©ç”¨äº†ç£ç›˜é¢„è¯»åŸç†ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸€æ¬¡ I/O å°±å¯ä»¥å®Œå…¨è½½å…¥ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†è¯»å–ä¸€ä¸ªèŠ‚ç‚¹åªéœ€ä¸€æ¬¡ I/Oã€‚å‡è®¾B+Treeçš„é«˜åº¦ä¸º hï¼Œä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1æ¬¡ I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œå¤æ‚åº¦ O(h) = O(logmN)ã€‚å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼ŒM é€šå¸¸è¾ƒå¤§ï¼Œå¸¸å¸¸è¶…è¿‡ 100ï¼Œå› æ­¤æ ‘çš„é«˜åº¦ä¸€èˆ¬éƒ½æ¯”è¾ƒå°ï¼Œé€šå¸¸ä¸è¶…è¿‡ 3ã€‚</p><p>æœ€åç®€å•äº†è§£ä¸‹B+TreeèŠ‚ç‚¹çš„æ“ä½œï¼Œåœ¨æ•´ä½“ä¸Šå¯¹ç´¢å¼•çš„ç»´æŠ¤æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè™½ç„¶ç´¢å¼•å¯ä»¥å¤§å¤§æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä½†ç»´æŠ¤ç´¢å¼•ä»è¦èŠ±è´¹å¾ˆå¤§çš„ä»£ä»·ï¼Œå› æ­¤åˆç†çš„åˆ›å»ºç´¢å¼•ä¹Ÿå°±å°¤ä¸ºé‡è¦ã€‚</p><p>ä»ä»¥ä¸Šé¢çš„æ ‘ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ 4 ä¸ªå†…èŠ‚ç‚¹ã€‚é¦–å…ˆè¦æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ 28ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/chazhao.jpg" title="chazhao"></p><p>æ¥ç€æ’å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ 70ï¼Œåœ¨ Index Page ä¸­æŸ¥è¯¢åå¾—çŸ¥åº”è¯¥æ’å…¥åˆ° 50 - 70 ä¹‹é—´çš„å¶å­èŠ‚ç‚¹ï¼Œä½†å¶å­èŠ‚ç‚¹å·²æ»¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿›è¡Œä¹Ÿåˆ†è£‚çš„æ“ä½œï¼Œå½“å‰çš„å¶å­èŠ‚ç‚¹èµ·ç‚¹ä¸º 50ï¼Œæ‰€ä»¥æ ¹æ®ä¸­é—´å€¼æ¥æ‹†åˆ†å¶å­èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/pagechazhao.jpg" title="pagechazhao"></p><p>æœ€åæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ 95ï¼Œè¿™æ—¶å€™ Index Page å’Œ Leaf Page éƒ½æ»¡äº†ï¼Œå°±éœ€è¦åšä¸¤æ¬¡æ‹†åˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/zhaodao.jpg" title="zhaodao"></p><p>Leaf Page ä¸ Index Page æ‹†åˆ†åæœ€ç»ˆå½¢æˆäº†è¿™æ ·ä¸€é¢—æ ‘ã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/leaf.jpg" title="leaf"></p><p>B+Treeä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œå¯¹äºæ–°æ’å…¥çš„å€¼éœ€è¦åšå¤§é‡çš„æ‹†åˆ†é¡µæ“ä½œï¼Œè€Œé¡µçš„æ‹†åˆ†éœ€è¦ I/O æ“ä½œï¼Œä¸ºäº†å°½å¯èƒ½çš„å‡å°‘é¡µçš„æ‹†åˆ†æ“ä½œï¼ŒB+Treeä¹Ÿæä¾›äº†ç±»ä¼¼äºå¹³è¡¡äºŒå‰æ ‘çš„æ—‹è½¬åŠŸèƒ½ã€‚å½“ Leaf Page å·²æ»¡ä½†å…¶å·¦å³å…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰æ»¡çš„æƒ…å†µä¸‹ï¼ŒB+Treeå¹¶ä¸æ€¥äºå»åšæ‹†åˆ†æ“ä½œï¼Œè€Œæ˜¯å°†è®°å½•ç§»åˆ°å½“å‰æ‰€åœ¨é¡µçš„å…„å¼ŸèŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå·¦å…„å¼Ÿä¼šè¢«å…ˆæ£€æŸ¥ç”¨æ¥åšæ—‹è½¬æ“ä½œã€‚å°±æ¯”å¦‚ä¸Šé¢ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œå½“æ’å…¥ 70 çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå»åšé¡µæ‹†åˆ†ï¼Œè€Œæ˜¯å·¦æ—‹æ“ä½œã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/zuoxuan.jpg" title="zuoxuan"></p><p>é€šè¿‡æ—‹è½¬æ“ä½œå¯ä»¥æœ€å¤§é™åº¦çš„å‡å°‘é¡µåˆ†è£‚ï¼Œä»è€Œå‡å°‘ç´¢å¼•ç»´æŠ¤è¿‡ç¨‹ä¸­çš„ç£ç›˜çš„ I/O æ“ä½œï¼Œä¹Ÿæé«˜ç´¢å¼•ç»´æŠ¤æ•ˆç‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤èŠ‚ç‚¹è·Ÿæ’å…¥èŠ‚ç‚¹ç±»ä¼¼ï¼Œä»ç„¶éœ€è¦æ—‹è½¬å’Œæ‹†åˆ†æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚</p><p><strong>é«˜æ€§èƒ½ç­–ç•¥</strong><br>é€šè¿‡ä¸Šæ–‡ï¼Œç›¸ä¿¡ä½ å¯¹B+Treeçš„æ•°æ®ç»“æ„å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä½† MySQL ä¸­ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„å­˜å‚¨å‘¢ï¼Ÿä»¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹æ•°æ®è¡¨ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE People(</span><br><span class="line">    last_name varchar(50) not null,</span><br><span class="line">    first_name varchar(50) not null,</span><br><span class="line">    dob date not null,</span><br><span class="line">    gender enum(`m`,`f`) not null,</span><br><span class="line">    key(last_name,first_name,dob)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯¹äºè¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®ï¼Œç´¢å¼•ä¸­åŒ…å«äº† last_nameã€first_nameã€dob åˆ—çš„å€¼ï¼Œä¸‹å›¾å±•ç¤ºäº†ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ã€‚<br><img src="/2019/03/29/mysql-optimization-principle-1/IMG.png" title="IMG"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•é¦–å…ˆæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥æ’åˆ—é¡ºåºï¼Œå½“åå­—ç›¸åŒæ—¶ï¼Œåˆ™æ ¹æ®ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå³å‡ºç”Ÿæ—¥æœŸæ¥æ’åºï¼Œæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæ‰æœ‰äº†ç´¢å¼•çš„ â€œæœ€å·¦åŸåˆ™â€ã€‚</p><p><strong>MySQL ä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ—</strong></p><p>â€œç‹¬ç«‹çš„åˆ—â€ æ˜¯æŒ‡ç´¢å¼•åˆ—ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸èƒ½æ˜¯å‡½æ•°çš„å‚æ•°ã€‚æ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from <span class="built_in">where</span> id + 1 = 5</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºå…¶ç­‰ä»·äº id = 4ï¼Œä½†æ˜¯ MySQL æ— æ³•è‡ªåŠ¨è§£æè¿™ä¸ªè¡¨è¾¾å¼ï¼Œä½¿ç”¨å‡½æ•°æ˜¯åŒæ ·çš„é“ç†ã€‚</p><p><strong>å‰ç¼€ç´¢å¼•</strong><br>å¦‚æœåˆ—å¾ˆé•¿ï¼Œé€šå¸¸å¯ä»¥ç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚</p><p><strong>å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº</strong><br>åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç‹¬ç«‹çš„ç´¢å¼•å¹¶ä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ç†ç”±éå¸¸ç®€å•ï¼ŒMySQL ä¸çŸ¥é“é€‰æ‹©å“ªä¸ªç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡æ›´å¥½ï¼Œæ‰€ä»¥åœ¨è€ç‰ˆæœ¬ï¼Œæ¯”å¦‚ MySQL5.0 ä¹‹å‰å°±ä¼šéšä¾¿é€‰æ‹©ä¸€ä¸ªåˆ—çš„ç´¢å¼•ï¼Œè€Œæ–°çš„ç‰ˆæœ¬ä¼šé‡‡ç”¨åˆå¹¶ç´¢å¼•çš„ç­–ç•¥ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸€å¼ ç”µå½±æ¼”å‘˜è¡¨ä¸­ï¼Œåœ¨ actor_id å’Œ film_id ä¸¤ä¸ªåˆ—ä¸Šéƒ½å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•ï¼Œç„¶åæœ‰å¦‚ä¸‹æŸ¥è¯¢ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select film_id,actor_id from film_actor <span class="built_in">where</span> actor_id = 1 or film_id = 1</span><br></pre></td></tr></tbody></table></figure><p>è€ç‰ˆæœ¬çš„ MySQL ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä½†æ–°ç‰ˆæœ¬åšå¦‚ä¸‹çš„ä¼˜åŒ–ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select film_id,actor_id from film_actor <span class="built_in">where</span> actor_id = 1</span><br><span class="line">union all</span><br><span class="line">select film_id,actor_id from film_actor <span class="built_in">where</span> film_id = 1 and actor_id <> 1</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>å½“å‡ºç°å¤šä¸ªç´¢å¼•åšç›¸äº¤æ“ä½œæ—¶ï¼ˆå¤šä¸ª AND æ¡ä»¶ï¼‰ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„ç´¢å¼•è¦ä¼˜äºå¤šä¸ªç‹¬ç«‹ç´¢å¼•ã€‚</li><li>å½“å‡ºç°å¤šä¸ªç´¢å¼•åšè”åˆæ“ä½œæ—¶ï¼ˆå¤šä¸ª OR æ¡ä»¶ï¼‰ï¼Œå¯¹ç»“æœé›†çš„åˆå¹¶ã€æ’åºç­‰æ“ä½œéœ€è¦è€—è´¹å¤§é‡çš„ CPU å’Œå†…å­˜èµ„æºï¼Œç‰¹åˆ«æ˜¯å½“å…¶ä¸­çš„æŸäº›ç´¢å¼•çš„é€‰æ‹©æ€§ä¸é«˜ï¼Œéœ€è¦è¿”å›åˆå¹¶å¤§é‡æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢æˆæœ¬æ›´é«˜ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¿˜ä¸å¦‚èµ°å…¨è¡¨æ‰«æã€‚</li></ul><p>å› æ­¤explainæ—¶å¦‚æœå‘ç°æœ‰ç´¢å¼•åˆå¹¶ï¼ˆExtra å­—æ®µå‡ºç°Using unionï¼‰ï¼Œåº”è¯¥å¥½å¥½æ£€æŸ¥ä¸€ä¸‹æŸ¥è¯¢å’Œè¡¨ç»“æ„æ˜¯ä¸æ˜¯å·²ç»æ˜¯æœ€ä¼˜çš„ï¼Œå¦‚æœæŸ¥è¯¢å’Œè¡¨éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£åªèƒ½è¯´æ˜ç´¢å¼•å»ºçš„éå¸¸ç³Ÿç³•ï¼Œåº”å½“æ…é‡è€ƒè™‘ç´¢å¼•æ˜¯å¦åˆé€‚ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„å¤šåˆ—ç´¢å¼•æ›´é€‚åˆã€‚</p><p>å‰é¢æˆ‘ä»¬æåˆ°è¿‡ç´¢å¼•å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¤šåˆ—ç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„é¡ºåºå¯¹äºæŸ¥è¯¢æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¾ˆæ˜æ˜¾åº”è¯¥æŠŠé€‰æ‹©æ€§æ›´é«˜çš„å­—æ®µæ”¾åˆ°ç´¢å¼•çš„å‰é¢ï¼Œè¿™æ ·é€šè¿‡ç¬¬ä¸€ä¸ªå­—æ®µå°±å¯ä»¥è¿‡æ»¤æ‰å¤§å¤šæ•°ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</p><blockquote><p>ç´¢å¼•é€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼å’Œæ•°æ®è¡¨çš„æ€»è®°å½•æ•°çš„æ¯”å€¼ï¼Œé€‰æ‹©æ€§è¶Šé«˜æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œå› ä¸ºé€‰æ‹©æ€§è¶Šé«˜çš„ç´¢å¼•å¯ä»¥è®© MySQL åœ¨æŸ¥è¯¢æ—¶è¿‡æ»¤æ‰æ›´å¤šçš„è¡Œã€‚å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯ 1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚</p></blockquote><p>ç†è§£ç´¢å¼•é€‰æ‹©æ€§çš„æ¦‚å¿µåï¼Œå°±ä¸éš¾ç¡®å®šå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§è¾ƒé«˜äº†ï¼ŒæŸ¥ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæ¯”å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM payment <span class="built_in">where</span> staff_id = 2 and customer_id = 584</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¯åº”è¯¥åˆ›å»º<code>(staff_id,customer_id)</code>çš„ç´¢å¼•è¿˜æ˜¯åº”è¯¥é¢ å€’ä¸€ä¸‹é¡ºåºï¼Ÿæ‰§è¡Œä¸‹é¢çš„æŸ¥è¯¢ï¼Œå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§æ›´æ¥è¿‘ 1 å°±æŠŠå“ªä¸ªå­—æ®µç´¢å¼•å‰é¢å°±å¥½ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct staff_id)/count(*) as staff_id_selectivity,</span><br><span class="line">       count(distinct customer_id)/count(*) as customer_id_selectivity,</span><br><span class="line">       count(*) from payment</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªåŸåˆ™æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä»ç„¶æ³¨æ„ä½ çš„æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚è¦æŸ¥è¯¢æŸä¸ªç”¨æˆ·ç»„ä¸‹æœ‰è¿‡äº¤æ˜“çš„ç”¨æˆ·ä¿¡æ¯ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select user_id from trade <span class="built_in">where</span> user_group_id = 1 and trade_amount > 0</span><br></pre></td></tr></tbody></table></figure><p></p><p>MySQL ä¸ºè¿™ä¸ªæŸ¥è¯¢é€‰æ‹©äº†ç´¢å¼•<code>(user_group_id,trade_amount)</code>ï¼Œå¦‚æœä¸è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼Œè¿™çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å®é™…æƒ…å†µæ˜¯è¿™å¼ è¡¨çš„å¤§å¤šæ•°æ•°æ®éƒ½æ˜¯ä»è€ç³»ç»Ÿä¸­è¿ç§»è¿‡æ¥çš„ï¼Œç”±äºæ–°è€ç³»ç»Ÿçš„æ•°æ®ä¸å…¼å®¹ï¼Œæ‰€ä»¥å°±ç»™è€ç³»ç»Ÿè¿ç§»è¿‡æ¥çš„æ•°æ®èµ‹äºˆäº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·ç»„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ç´¢å¼•æ‰«æçš„è¡Œæ•°è·Ÿå…¨è¡¨æ‰«æåŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œç´¢å¼•ä¹Ÿå°±èµ·ä¸åˆ°ä»»ä½•ä½œç”¨ã€‚</p><p>æ¨å¹¿å¼€æ¥è¯´ï¼Œç»éªŒæ³•åˆ™å’Œæ¨è®ºåœ¨å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œå¯ä»¥æŒ‡å¯¼æˆ‘ä»¬å¼€å‘å’Œè®¾è®¡ï¼Œä½†å®é™…æƒ…å†µå¾€å¾€ä¼šæ›´å¤æ‚ï¼Œå®é™…ä¸šåŠ¡åœºæ™¯ä¸‹çš„æŸäº›ç‰¹æ®Šæƒ…å†µå¯èƒ½ä¼šæ‘§æ¯ä½ çš„æ•´ä¸ªè®¾è®¡ã€‚</p><p><strong>é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶</strong></p><p>å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨å¤šä¸ªèŒƒå›´æ¡ä»¶ï¼Œæ¯”å¦‚æƒ³æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…ç™»å½•è¿‡çš„ç”¨æˆ·ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select user.* from user <span class="built_in">where</span> login_time > <span class="string">'2017-04-01'</span> and age between 18 and 30;</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™ä¸ªæŸ¥è¯¢æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå®ƒæœ‰ä¸¤ä¸ªèŒƒå›´æ¡ä»¶ï¼Œlogin_time åˆ—å’Œ age åˆ—ï¼ŒMySQL å¯ä»¥ä½¿ç”¨ login_time åˆ—çš„ç´¢å¼•æˆ–è€… age åˆ—çš„ç´¢å¼•ï¼Œä½†æ— æ³•åŒæ—¶ä½¿ç”¨å®ƒä»¬ã€‚</p><p><strong>è¦†ç›–ç´¢å¼•</strong></p><p>å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å†å›è¡¨æŸ¥è¯¢ï¼Œè¿™å°±ç§°ä¸ºè¦†ç›–ç´¢å¼•ã€‚è¦†ç›–ç´¢å¼•æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æå¤§çš„æé«˜æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢åªéœ€è¦æ‰«æç´¢å¼•ä¼šå¸¦æ¥è®¸å¤šå¥½å¤„ï¼š</p><ul><li>ç´¢å¼•æ¡ç›®è¿œå°äºæ•°æ®è¡Œå¤§å°ï¼Œå¦‚æœåªè¯»å–ç´¢å¼•ï¼Œæå¤§å‡å°‘æ•°æ®è®¿é—®é‡</li><li>ç´¢å¼•æ˜¯æœ‰æŒ‰ç…§åˆ—å€¼é¡ºåºå­˜å‚¨çš„ï¼Œå¯¹äº I/O å¯†é›†å‹çš„èŒƒå›´æŸ¥è¯¢è¦æ¯”éšæœºä»ç£ç›˜è¯»å–æ¯ä¸€è¡Œæ•°æ®çš„ IO è¦å°‘çš„å¤š</li></ul><p><strong>ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº</strong></p><p>MySQL æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”Ÿäº§æœ‰åºçš„ç»“æœé›†ï¼Œå…¶ä¸€æ˜¯å¯¹ç»“æœé›†è¿›è¡Œæ’åºçš„æ“ä½œï¼Œå…¶äºŒæ˜¯æŒ‰ç…§ç´¢å¼•é¡ºåºæ‰«æå¾—å‡ºçš„ç»“æœè‡ªç„¶æ˜¯æœ‰åºçš„ã€‚å¦‚æœ explain çš„ç»“æœä¸­typeåˆ—çš„å€¼ä¸ºindexè¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•æ‰«ææ¥åšæ’åºã€‚</p><p>æ‰«æç´¢å¼•æœ¬èº«å¾ˆå¿«ï¼Œå› ä¸ºåªéœ€è¦ä»ä¸€æ¡ç´¢å¼•è®°å½•ç§»åŠ¨åˆ°ç›¸é‚»çš„ä¸‹ä¸€æ¡è®°å½•ã€‚ä½†å¦‚æœç´¢å¼•æœ¬èº«ä¸èƒ½è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„åˆ—ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ¯æ‰«æä¸€æ¡ç´¢å¼•è®°å½•å°±å›è¡¨æŸ¥è¯¢ä¸€æ¬¡å¯¹åº”çš„è¡Œã€‚è¿™ä¸ªè¯»å–æ“ä½œåŸºæœ¬ä¸Šæ˜¯éšæœº I/Oï¼Œå› æ­¤æŒ‰ç…§ç´¢å¼•é¡ºåºè¯»å–æ•°æ®çš„é€Ÿåº¦é€šå¸¸è¦æ¯”é¡ºåºåœ°å…¨è¡¨æ‰«æè¦æ…¢ã€‚</p><p>åœ¨è®¾è®¡ç´¢å¼•æ—¶ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•æ—¢èƒ½å¤Ÿæ»¡è¶³æ’åºï¼Œåˆæ»¡è¶³æŸ¥è¯¢ï¼Œæ˜¯æœ€å¥½çš„ã€‚</p><p>åªæœ‰å½“ç´¢å¼•çš„åˆ—é¡ºåºå’ŒORDER BYå­å¥çš„é¡ºåºå®Œå…¨ä¸€è‡´ï¼Œå¹¶ä¸”æ‰€æœ‰åˆ—çš„æ’åºæ–¹å‘ä¹Ÿä¸€æ ·æ—¶ï¼Œæ‰èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•æ¥å¯¹ç»“æœåšæ’åºã€‚å¦‚æœæŸ¥è¯¢éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œåˆ™åªæœ‰ORDER BYå­å¥å¼•ç”¨çš„å­—æ®µå…¨éƒ¨ä¸ºç¬¬ä¸€å¼ è¡¨æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•åšæ’åºã€‚ORDER BYå­å¥å’ŒæŸ¥è¯¢çš„é™åˆ¶æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦æ»¡è¶³æœ€å·¦å‰ç¼€çš„è¦æ±‚ï¼ˆæœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯æœ€å·¦çš„åˆ—è¢«æŒ‡å®šä¸ºå¸¸æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼‰ï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½éœ€è¦æ‰§è¡Œæ’åºæ“ä½œï¼Œè€Œæ— æ³•åˆ©ç”¨ç´¢å¼•æ’åºã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- æœ€å·¦åˆ—ä¸ºå¸¸æ•°ï¼Œç´¢å¼•ï¼š(date,staff_id,customer_id)</span><br><span class="line">select  staff_id,customer_id from demo <span class="built_in">where</span> date = <span class="string">'2015-06-01'</span> order by staff_id,customer_id</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>å†—ä½™å’Œé‡å¤ç´¢å¼•</strong></p><p>å†—ä½™ç´¢å¼•æ˜¯æŒ‡åœ¨ç›¸åŒçš„åˆ—ä¸ŠæŒ‰ç…§ç›¸åŒçš„é¡ºåºåˆ›å»ºçš„ç›¸åŒç±»å‹çš„ç´¢å¼•ï¼Œåº”å½“å°½é‡é¿å…è¿™ç§ç´¢å¼•ï¼Œå‘ç°åç«‹å³åˆ é™¤ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç´¢å¼•<code>(A,B)</code>ï¼Œå†åˆ›å»ºç´¢å¼•<code>(A)</code>å°±æ˜¯å†—ä½™ç´¢å¼•ã€‚å†—ä½™ç´¢å¼•ç»å¸¸å‘ç”Ÿåœ¨ä¸ºè¡¨æ·»åŠ æ–°ç´¢å¼•æ—¶ï¼Œæ¯”å¦‚æœ‰äººæ–°å»ºäº†ç´¢å¼•<code>(A,B)</code>ï¼Œä½†è¿™ä¸ªç´¢å¼•ä¸æ˜¯æ‰©å±•å·²æœ‰çš„ç´¢å¼•<code>(A)</code>ã€‚</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½åº”è¯¥å°½é‡æ‰©å±•å·²æœ‰çš„ç´¢å¼•è€Œä¸æ˜¯åˆ›å»ºæ–°ç´¢å¼•ã€‚ä½†æœ‰æå°‘æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–¹é¢çš„è€ƒè™‘éœ€è¦å†—ä½™ç´¢å¼•ï¼Œæ¯”å¦‚æ‰©å±•å·²æœ‰ç´¢å¼•è€Œå¯¼è‡´å…¶å˜å¾—è¿‡å¤§ï¼Œä»è€Œå½±å“åˆ°å…¶ä»–ä½¿ç”¨è¯¥ç´¢å¼•çš„æŸ¥è¯¢ã€‚</p><p><strong>åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•</strong></p><p>å®šæœŸåˆ é™¤ä¸€äº›é•¿æ—¶é—´æœªä½¿ç”¨è¿‡çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚</p><p>å…³äºç´¢å¼•è¿™ä¸ªè¯é¢˜æ‰“ç®—å°±æ­¤æ‰“ä½ï¼Œæœ€åè¦è¯´ä¸€å¥ï¼Œç´¢å¼•å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„å·¥å…·ï¼Œåªæœ‰å½“ç´¢å¼•å¸®åŠ©æé«˜æŸ¥è¯¢é€Ÿåº¦å¸¦æ¥çš„å¥½å¤„å¤§äºå…¶å¸¦æ¥çš„é¢å¤–å·¥ä½œæ—¶ï¼Œç´¢å¼•æ‰æ˜¯æœ‰æ•ˆçš„ã€‚å¯¹äºéå¸¸å°çš„è¡¨ï¼Œç®€å•çš„å…¨è¡¨æ‰«ææ›´é«˜æ•ˆã€‚å¯¹äºä¸­åˆ°å¤§å‹çš„è¡¨ï¼Œç´¢å¼•å°±éå¸¸æœ‰æ•ˆã€‚å¯¹äºè¶…å¤§å‹çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·éšä¹‹å¢é•¿ï¼Œè¿™æ—¶å€™å…¶ä»–æŠ€æœ¯ä¹Ÿè®¸æ›´æœ‰æ•ˆï¼Œæ¯”å¦‚åˆ†åŒºè¡¨ã€‚æœ€åçš„æœ€åï¼Œ<strong>explainåå†ææµ‹æ˜¯ä¸€ç§ç¾å¾·</strong>ã€‚</p><p><strong>ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ–</strong></p><p><strong>ä¼˜åŒ– COUNT() æŸ¥è¯¢</strong></p><p><code>COUNT()</code>å¯èƒ½æ˜¯è¢«å¤§å®¶è¯¯è§£æœ€å¤šçš„å‡½æ•°äº†ï¼Œå®ƒæœ‰ä¸¤ç§ä¸åŒçš„ä½œç”¨ï¼Œå…¶ä¸€æ˜¯ç»Ÿè®¡æŸä¸ªåˆ—å€¼çš„æ•°é‡ï¼Œå…¶äºŒæ˜¯ç»Ÿè®¡è¡Œæ•°ã€‚ç»Ÿè®¡åˆ—å€¼æ—¶ï¼Œè¦æ±‚åˆ—å€¼æ˜¯éç©ºçš„ï¼Œå®ƒä¸ä¼šç»Ÿè®¡ NULLã€‚å¦‚æœç¡®è®¤æ‹¬å·ä¸­çš„è¡¨è¾¾å¼ä¸å¯èƒ½ä¸ºç©ºæ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç»Ÿè®¡è¡Œæ•°ã€‚æœ€ç®€å•çš„å°±æ˜¯å½“ä½¿ç”¨<code>COUNT(*)</code>æ—¶ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³è±¡çš„é‚£æ ·æ‰©å±•æˆæ‰€æœ‰çš„åˆ—ï¼Œå®é™…ä¸Šï¼Œå®ƒä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—è€Œç›´æ¥ç»Ÿè®¡è¡Œæ•°ã€‚</p><p>æˆ‘ä»¬æœ€å¸¸è§çš„è¯¯è§£ä¹Ÿå°±åœ¨è¿™å„¿ï¼Œåœ¨æ‹¬å·å†…æŒ‡å®šäº†ä¸€åˆ—å´å¸Œæœ›ç»Ÿè®¡ç»“æœæ˜¯è¡Œæ•°ï¼Œè€Œä¸”è¿˜å¸¸å¸¸è¯¯ä»¥ä¸ºå‰è€…çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ä½†å®é™…å¹¶éè¿™æ ·ï¼Œå¦‚æœè¦ç»Ÿè®¡è¡Œæ•°ï¼Œç›´æ¥ä½¿ç”¨<code>COUNT(*)</code>ï¼Œæ„ä¹‰æ¸…æ™°ï¼Œä¸”æ€§èƒ½æ›´å¥½ã€‚</p><p>æœ‰æ—¶å€™æŸäº›ä¸šåŠ¡åœºæ™¯å¹¶ä¸éœ€è¦å®Œå…¨ç²¾ç¡®çš„<code>COUNT</code>å€¼ï¼Œå¯ä»¥ç”¨è¿‘ä¼¼å€¼æ¥ä»£æ›¿ï¼Œ<code>EXPLAIN</code> å‡ºæ¥çš„è¡Œæ•°å°±æ˜¯ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè€Œä¸”æ‰§è¡Œ <code>EXPLAIN</code> å¹¶ä¸éœ€è¦çœŸæ­£åœ°å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥æˆæœ¬éå¸¸ä½ã€‚é€šå¸¸æ¥è¯´ï¼Œæ‰§è¡Œ<code>COUNT()</code>éƒ½éœ€è¦æ‰«æå¤§é‡çš„è¡Œæ‰èƒ½è·å–åˆ°ç²¾ç¡®çš„æ•°æ®ï¼Œå› æ­¤å¾ˆéš¾ä¼˜åŒ–ï¼ŒMySQL å±‚é¢è¿˜èƒ½åšå¾—ä¹Ÿå°±åªæœ‰è¦†ç›–ç´¢å¼•äº†ã€‚å¦‚æœä¸è¿˜èƒ½è§£å†³é—®é¢˜ï¼Œåªæœ‰ä»æ¶æ„å±‚é¢è§£å†³äº†ï¼Œæ¯”å¦‚æ·»åŠ æ±‡æ€»è¡¨ï¼Œæˆ–è€…ä½¿ç”¨ <code>redis</code> è¿™æ ·çš„å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿã€‚</p><p><strong>ä¼˜åŒ–å…³è”æŸ¥è¯¢</strong></p><p>åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œè¡¨ä¸è¡¨ä¹‹é—´é€šè¿‡ä¸€ä¸ªå†—ä½™å­—æ®µæ¥å…³è”ï¼Œè¦æ¯”ç›´æ¥ä½¿ç”¨JOINæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å¦‚æœç¡®å®éœ€è¦ä½¿ç”¨å…³è”æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>ç¡®ä¿<code>ON</code>å’Œ<code>USING</code>å­—å¥ä¸­çš„åˆ—ä¸Šæœ‰ç´¢å¼•ã€‚åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°å…³è”çš„é¡ºåºã€‚å½“è¡¨ <code>A</code> å’Œè¡¨ <code>B</code> ç”¨åˆ— <code>c</code> å…³è”çš„æ—¶å€™ï¼Œå¦‚æœä¼˜åŒ–å™¨å…³è”çš„é¡ºåºæ˜¯ <code>A</code>ã€<code>B</code>ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨ <code>A</code> è¡¨çš„å¯¹åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚æ²¡æœ‰ç”¨åˆ°çš„ç´¢å¼•ä¼šå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé™¤éæœ‰å…¶ä»–ç†ç”±ï¼Œåªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆå…·ä½“åŸå› ä¸‹æ–‡åˆ†æï¼‰ã€‚</li><li>ç¡®ä¿ä»»ä½•çš„<code>GROUP BY</code>å’Œ<code>ORDER BY</code>ä¸­çš„è¡¨è¾¾å¼åªæ¶‰åŠåˆ°ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ · MySQL æ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ã€‚</li></ul><p>è¦ç†è§£ä¼˜åŒ–å…³è”æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªæŠ€å·§ï¼Œå°±éœ€è¦ç†è§£ MySQL æ˜¯å¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢çš„ã€‚å½“å‰ MySQL å…³è”æ‰§è¡Œçš„ç­–ç•¥éå¸¸ç®€å•ï¼Œå®ƒå¯¹ä»»ä½•çš„å…³è”éƒ½<strong>æ‰§è¡ŒåµŒå¥—å¾ªç¯å…³è”æ“ä½œ</strong>ï¼Œå³å…ˆåœ¨ä¸€ä¸ªè¡¨ä¸­å¾ªç¯å–å‡ºå•æ¡æ•°æ®ï¼Œç„¶ååœ¨åµŒå¥—å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªè¡¨ä¸­å¯»æ‰¾åŒ¹é…çš„è¡Œï¼Œä¾æ¬¡ä¸‹å»ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰è¡¨ä¸­åŒ¹é…çš„è¡Œä¸ºä¸ºæ­¢ã€‚ç„¶åæ ¹æ®å„ä¸ªè¡¨åŒ¹é…çš„è¡Œï¼Œè¿”å›æŸ¥è¯¢ä¸­éœ€è¦çš„å„ä¸ªåˆ—ã€‚</p><p>å¤ªæŠ½è±¡äº†ï¼Ÿä»¥ä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œæ¯”å¦‚æœ‰è¿™æ ·çš„ä¸€ä¸ªæŸ¥è¯¢ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT A.xx,B.yy FROM A INNER JOIN B USING(c) WHERE A.xx IN (5,6)</span><br></pre></td></tr></tbody></table></figure><p></p><p>å‡è®¾ MySQL æŒ‰ç…§æŸ¥è¯¢ä¸­çš„å…³è”é¡ºåº Aã€B æ¥è¿›è¡Œå…³è”æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¸‹é¢çš„ä¼ªä»£ç è¡¨ç¤º MySQL å¦‚ä½•å®Œæˆè¿™ä¸ªæŸ¥è¯¢ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">outer_iterator = SELECT A.xx,A.c FROM A WHERE A.xx IN (5,6);</span><br><span class="line">outer_row = outer_iterator.next;</span><br><span class="line"><span class="keyword">while</span>(outer_row) {</span><br><span class="line">    inner_iterator = SELECT B.yy FROM B WHERE B.c = outer_row.c;</span><br><span class="line">    inner_row = inner_iterator.next;</span><br><span class="line">    <span class="keyword">while</span>(inner_row) {</span><br><span class="line">        output[inner_row.yy,outer_row.xx];</span><br><span class="line">        inner_row = inner_iterator.next;</span><br><span class="line">    }</span><br><span class="line">    outer_row = outer_iterator.next;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤–å±‚çš„æŸ¥è¯¢æ˜¯æ ¹æ®A.xxåˆ—æ¥æŸ¥è¯¢çš„ï¼ŒA.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œæ•´ä¸ªå…³è”æŸ¥è¯¢ä¹Ÿä¸ä¼šä½¿ç”¨ã€‚å†çœ‹å†…å±‚çš„æŸ¥è¯¢ï¼Œå¾ˆæ˜æ˜¾B.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œèƒ½å¤ŸåŠ é€ŸæŸ¥è¯¢ï¼Œå› æ­¤åªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•å³å¯ã€‚</p><p><strong>ä¼˜åŒ– LIMIT åˆ†é¡µ</strong></p><p>å½“éœ€è¦åˆ†é¡µæ“ä½œæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨LIMITåŠ ä¸Šåç§»é‡çš„åŠæ³•å®ç°ï¼ŒåŒæ—¶åŠ ä¸Šåˆé€‚çš„ORDER BYå­—å¥ã€‚å¦‚æœæœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œé€šå¸¸æ•ˆç‡ä¼šä¸é”™ï¼Œå¦åˆ™ï¼ŒMySQL éœ€è¦åšå¤§é‡çš„æ–‡ä»¶æ’åºæ“ä½œã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å½“åç§»é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼šLIMIT 10000 20è¿™æ ·çš„æŸ¥è¯¢ï¼ŒMySQL éœ€è¦æŸ¥è¯¢ 10020 æ¡è®°å½•ç„¶ååªè¿”å› 20 æ¡è®°å½•ï¼Œå‰é¢çš„ 10000 æ¡éƒ½å°†è¢«æŠ›å¼ƒï¼Œè¿™æ ·çš„ä»£ä»·éå¸¸é«˜ã€‚</p><p>ä¼˜åŒ–è¿™ç§æŸ¥è¯¢ä¸€ä¸ªæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨è¦†ç›–ç´¢å¼•æ‰«æï¼Œè€Œä¸æ˜¯æŸ¥è¯¢æ‰€æœ‰çš„åˆ—ã€‚ç„¶åæ ¹æ®éœ€è¦åšä¸€æ¬¡å…³è”æŸ¥è¯¢å†è¿”å›æ‰€æœ‰çš„åˆ—ã€‚å¯¹äºåç§»é‡å¾ˆå¤§æ—¶ï¼Œè¿™æ ·åšçš„æ•ˆç‡ä¼šæå‡éå¸¸å¤§ã€‚è€ƒè™‘ä¸‹é¢çš„æŸ¥è¯¢ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT film_id,description FROM film ORDER BY title LIMIT 50,5;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœè¿™å¼ è¡¨éå¸¸å¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT film.film_id,film.description</span><br><span class="line">FROM film INNER JOIN (</span><br><span class="line">    SELECT film_id FROM film ORDER BY title LIMIT 50,5</span><br><span class="line">) AS tmp USING(film_id);</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™é‡Œçš„å»¶è¿Ÿå…³è”å°†å¤§å¤§æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œè®© MySQL æ‰«æå°½å¯èƒ½å°‘çš„é¡µé¢ï¼Œè·å–éœ€è¦è®¿é—®çš„è®°å½•ååœ¨æ ¹æ®å…³è”åˆ—å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„åˆ—ã€‚</p><p>æœ‰æ—¶å€™å¦‚æœå¯ä»¥ä½¿ç”¨ä¹¦ç­¾è®°å½•ä¸Šæ¬¡å–æ•°æ®çš„ä½ç½®ï¼Œé‚£ä¹ˆä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»è¯¥ä¹¦ç­¾è®°å½•çš„ä½ç½®å¼€å§‹æ‰«æï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä½¿ç”¨OFFSETï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT id FROM t LIMIT 10000, 10;</span><br><span class="line">-- æ”¹ä¸ºï¼š</span><br><span class="line">SELECT id FROM t WHERE id > 10000 LIMIT 10;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…¶ä»–ä¼˜åŒ–çš„åŠæ³•è¿˜åŒ…æ‹¬ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„æ±‡æ€»è¡¨ï¼Œæˆ–è€…å…³è”åˆ°ä¸€ä¸ªå†—ä½™è¡¨ï¼Œå†—ä½™è¡¨ä¸­åªåŒ…å«ä¸»é”®åˆ—å’Œéœ€è¦åšæ’åºçš„åˆ—ã€‚</p><p><strong>ä¼˜åŒ– UNION</strong><br>MySQL å¤„ç†UNIONçš„ç­–ç•¥æ˜¯å…ˆåˆ›å»ºä¸´æ—¶è¡¨ï¼Œç„¶åå†æŠŠå„ä¸ªæŸ¥è¯¢ç»“æœæ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œæœ€åå†æ¥åšæŸ¥è¯¢ã€‚å› æ­¤å¾ˆå¤šä¼˜åŒ–ç­–ç•¥åœ¨UNIONæŸ¥è¯¢ä¸­éƒ½æ²¡æœ‰åŠæ³•å¾ˆå¥½çš„æ—¶å€™ã€‚ç»å¸¸éœ€è¦æ‰‹åŠ¨å°†WHEREã€LIMITã€ORDER BYç­‰å­—å¥ â€œä¸‹æ¨â€ åˆ°å„ä¸ªå­æŸ¥è¯¢ä¸­ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨å¯ä»¥å……åˆ†åˆ©ç”¨è¿™äº›æ¡ä»¶å…ˆä¼˜åŒ–ã€‚</p><p>é™¤éç¡®å®éœ€è¦æœåŠ¡å™¨å»é‡ï¼Œå¦åˆ™å°±ä¸€å®šè¦ä½¿ç”¨UNION ALLï¼Œå¦‚æœæ²¡æœ‰ALLå…³é”®å­—ï¼ŒMySQL ä¼šç»™ä¸´æ—¶è¡¨åŠ ä¸ŠDISTINCTé€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªä¸´æ—¶è¡¨çš„æ•°æ®åšå”¯ä¸€æ€§æ£€æŸ¥ï¼Œè¿™æ ·åšçš„ä»£ä»·éå¸¸é«˜ã€‚å½“ç„¶å³ä½¿ä½¿ç”¨ ALL å…³é”®å­—ï¼ŒMySQL æ€»æ˜¯å°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå†è¯»å‡ºï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è™½ç„¶å¾ˆå¤šæ—¶å€™æ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯ä»¥ç›´æ¥æŠŠæ¯ä¸ªå­æŸ¥è¯¢çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ç†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œä»¥åŠæ—¶é—´éƒ½æ¶ˆè€—åœ¨å“ªäº›åœ°æ–¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¼˜åŒ–è¿‡ç¨‹çš„çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ MySQLï¼Œç†è§£å¸¸è§ä¼˜åŒ–æŠ€å·§èƒŒåçš„åŸç†ã€‚å¸Œæœ›æœ¬æ–‡ä¸­çš„åŸç†ã€ç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½çš„å°†ç†è®ºå’Œå®è·µè”ç³»èµ·æ¥ï¼Œæ›´å¤šçš„å°†ç†è®ºçŸ¥è¯†è¿ç”¨åˆ°å®è·µä¸­ã€‚</p><p>å…¶ä»–ä¹Ÿæ²¡å•¥è¯´çš„äº†ï¼Œç»™å¤§å®¶ç•™ä¸¤ä¸ªæ€è€ƒé¢˜å§ï¼Œå¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ç­”æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„ï¼Œä½†å¾ˆå°‘æœ‰äººä¼šæ€è€ƒä¸ºä»€ä¹ˆï¼Ÿ</p><ol><li>æœ‰éå¸¸å¤šçš„ç¨‹åºå‘˜åœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ</li><li>JOINæœ¬èº«ä¹ŸæŒºæ–¹ä¾¿çš„ï¼Œç›´æ¥æŸ¥è¯¢å°±å¥½äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è§†å›¾å‘¢ï¼Ÿ</li></ol><p>å‚è€ƒèµ„æ–™</p><ul><li><a href="https://segmentfault.com/a/1190000004690721" target="_blank" rel="noopener">ç”± B-/B+æ ‘çœ‹ MySQLç´¢å¼•ç»“æ„</a></li><li>MySQL æŠ€æœ¯å†…å¹•ï¼šInnoDB å­˜å‚¨å¼•æ“(ç¬¬ 2 ç‰ˆ)</li><li>é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ)</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL ä¼˜åŒ–ä¹‹ Covering Index</title>
    <link href="https://jiemin.wang/2019/03/29/CoveringIndex/"/>
    <id>https://jiemin.wang/2019/03/29/CoveringIndex/</id>
    <published>2019-03-29T05:22:16.000Z</published>
    <updated>2019-03-29T09:59:50.159Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="hehe.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ä¸ºä»€ä¹ˆæˆ‘è€çˆ¸ä¸æ˜¯æå˜‰è¯šï¼Œä¸ºä»€ä¹ˆæˆ‘é•¿çš„è¿™ä¹ˆå¸…ï¼Œä½†æ˜¯è¦æ‰å¤´å‘å‘¢ï¼Œä½ ä»¬é•¿è¿™ä¹ˆä¸‘ï¼Œå´ä¸æ‰å¤´å‘å‘¢ï¼Ÿ</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ç½‘ä¸Šéšä¾¿æœæœï¼Œå°±èƒ½æ‰¾åˆ°å¤§æŠŠçš„å…³äº MySQL ä¼˜åŒ–çš„æ–‡ç« ï¼Œä¸è¿‡é‡Œé¢å¾ˆå¤šéƒ½ä¸å‡†ç¡®ï¼Œè¯´ä¸ªå¸¸è§çš„ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT a FROM ... WHERE b = ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¾ˆå¤šæ–‡ç« ä¼šå‘Šè¯«ä½ ç±»ä¼¼è¿™æ ·çš„æŸ¥è¯¢ï¼Œä¸è¦åœ¨ â€œaâ€ å­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼Œè€Œåº”è¯¥åœ¨ â€œbâ€ ä¸Šå»ºç«‹ç´¢å¼•ã€‚è¿™æ ·åšç¡®å®ä¸é”™ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™è¿™å¹¶ä¸æ˜¯æœ€ä½³ç»“æœã€‚ä¸ºä»€ä¹ˆè¿™æ ·è¯´ï¼Ÿè¿™è¿˜å¾—å…ˆä»ç´¢å¼•æ¥è¯´èµ·ã€‚</p><h4 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h4><p>MySQL å®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆIndexï¼‰æ˜¯å¸®åŠ© MySQL é«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚æå–å¥å­ä¸»å¹²ï¼Œå°±å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚</p><p>åœ¨ MySQL ä¸­ï¼Œç´¢å¼•å±äºå­˜å‚¨å¼•æ“çº§åˆ«çš„æ¦‚å¿µï¼Œä¸åŒå­˜å‚¨å¼•æ“å¯¹ç´¢å¼•çš„å®ç°æ–¹å¼æ˜¯ä¸åŒçš„ï¼Œæœ¬æ–‡è®¨è®ºçš„ä¸»è¦æ˜¯ InnoDB çš„ B+Tree ç´¢å¼•ï¼Œå®ƒåˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>èšç°‡ç´¢å¼•</li><li>éèšç°‡ç´¢å¼•</li></ul><p>èšç°‡ç´¢å¼•åˆç§°ä¸ºèšé›†ç´¢å¼•æˆ–ä¸»é”®ç´¢å¼•ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ç§å•ç‹¬çš„ç´¢å¼•ç±»å‹ï¼Œè€Œæ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ã€‚åœ¨ InnoDB ä¸­ï¼Œè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™æ£µæ ‘çš„å¶å­èŠ‚ç‚¹ç§°ä¸º leaf pageï¼Œå…¶ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚ä¹Ÿå³æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®è¡Œå³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®ã€‚<br><img src="/2019/03/29/CoveringIndex/Primary_key.jpg" title="Primary_key"></p><p>éèšç°‡ç´¢å¼•æ˜¯ç›¸å¯¹äºèšç°‡ç´¢å¼•æ¥è¯´çš„ï¼Œæˆ‘ä»¬åˆç§°ä¸ºè¾…åŠ©ç´¢å¼•æˆ–äºŒçº§ç´¢å¼•ã€‚ InnoDB çš„äºŒçº§ç´¢å¼• data åŸŸå­˜å‚¨çš„æ˜¯ç›¸åº”è®°å½•ä¸»é”®çš„å€¼è€Œä¸æ˜¯ç‰©ç†ä½ç½®çš„æŒ‡é’ˆã€‚<br><img src="/2019/03/29/CoveringIndex/Secoudary_key.jpg" title="Secoudary_key"></p><h4 id="å›è¡¨"><a href="#å›è¡¨" class="headerlink" title="å›è¡¨"></a>å›è¡¨</h4><p>äº†è§£äº† InnoDB ç´¢å¼•çš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¾ˆå®¹æ˜“ç†è§£ â€œå›è¡¨â€ è¿™ä¸ªæ¦‚å¿µäº†ã€‚</p><p>èšç°‡ç´¢å¼•è¿™ç§å®ç°æ–¹å¼ä½¿å¾—æŒ‰ä¸»é”®çš„æœç´¢ååˆ†é«˜æ•ˆï¼Œä½†æ˜¯äºŒçº§ç´¢å¼•æœç´¢éœ€è¦æ£€ç´¢ä¸¤éç´¢å¼•ï¼šé¦–å…ˆæ£€ç´¢äºŒçº§ç´¢å¼•è·å¾—ä¸»é”®ï¼Œç„¶åç”¨ä¸»é”®åˆ°ä¸»ç´¢å¼•ä¸­æ£€ç´¢è·å¾—è®°å½•ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°å¼€å¤´è¯´çš„é‚£ä¸ªä¾‹å­ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT a FROM ... WHERE b = ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹æŸ¥è¯¢çš„å¤„ç†è¿‡ç¨‹ï¼šåœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šæŸ¥è¯¢ â€œbâ€ ç´¢å¼•è¿›è¡Œå®šä½ï¼Œç„¶åå›è¡¨æŸ¥è¯¢éœ€è¦çš„æ•°æ® â€œaâ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ä¸¤æ¬¡æŸ¥è¯¢ï¼Œä¸€æ¬¡æ˜¯æŸ¥è¯¢ç´¢å¼•ï¼Œå¦ä¸€æ¬¡æ˜¯æŸ¥è¯¢è¡¨ã€‚</p><p>é‚£æœ‰æ²¡æœ‰åŠæ³•ç”¨ä¸€æ¬¡æŸ¥è¯¢æå®šé—®é¢˜å‘¢ï¼Ÿæœ‰ï¼Œå°±æ˜¯ Covering Indexï¼</p><blockquote><p>è¯´åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³èµ·æ¥ MySQL5.6 ä¸­å¼•å…¥çš„ MRRï¼ˆMulti-Range Readï¼Œå¤šèŒƒå›´è¯»ï¼‰ï¼Œå®ƒæ˜¯ä¸“é—¨æ¥ä¼˜åŒ–äºŒçº§ç´¢å¼•çš„èŒƒå›´æ‰«æå¹¶ä¸”éœ€è¦å›è¡¨çš„æƒ…å†µã€‚å®ƒçš„åŸç†æ˜¯ï¼Œå°†å¤šä¸ªéœ€è¦å›è¡¨çš„äºŒçº§ç´¢å¼•æ ¹æ®ä¸»é”®è¿›è¡Œæ’åºï¼Œç„¶åä¸€èµ·å›è¡¨ï¼Œå°†åŸæ¥çš„å›è¡¨æ—¶è¿›è¡Œçš„éšæœº IOï¼Œè½¬å˜æˆé¡ºåº IOã€‚MRR çš„ä¼˜åŠ¿æ˜¯å°†å¤šä¸ªéšæœº IO è½¬æ¢æˆè¾ƒå°‘æ•°é‡çš„é¡ºåº IOï¼Œæ‰€ä»¥å¯¹äº SSD æ¥è¯´ä»·å€¼è¿˜æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ç›¸æ¯”æœºæ¢°ç£ç›˜æ¥è¯´æ„ä¹‰å°ä¸€äº›ã€‚</p></blockquote><h2 id="Covering-Index"><a href="#Covering-Index" class="headerlink" title="Covering Index"></a>Covering Index</h2><p>æ‰€è°“ Covering Indexï¼Œå°±æ˜¯è¯´ä¸å¿…æŸ¥è¯¢è¡¨æ–‡ä»¶ï¼Œå•é æŸ¥è¯¢ç´¢å¼•æ–‡ä»¶å³å¯å®Œæˆã€‚ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„å¥½å¤„æ˜¯è¾…åŠ©ç´¢å¼•ä¸åŒ…å«æ•´è¡Œè®°å½•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ•…å…¶å¤§å°è¦è¿œå°äºèšé›†ç´¢å¼•ï¼Œå› æ­¤å¯ä»¥å‡å°‘å¤§é‡çš„ IO æ“ä½œã€‚</p><p>å…·ä½“åˆ°ä¸Šè¾¹çš„ä¾‹å­ä¸­å°±æ˜¯å»ºç«‹ä¸€ä¸ªå¤åˆç´¢å¼• (b, a)ï¼Œå½“æŸ¥è¯¢è¿›è¡Œæ—¶ï¼Œé€šè¿‡å¤åˆç´¢å¼•çš„ â€œbâ€ éƒ¨åˆ†å»å®šä½ï¼Œè‡³äºéœ€è¦çš„æ•°æ® â€œaâ€ï¼Œç«‹åˆ»å°±å¯ä»¥åœ¨ç´¢å¼•é‡Œå¾—åˆ°ï¼Œä»è€Œçœç•¥äº†è¡¨æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚</p><p>å¦‚æœä½ æƒ³åˆ©ç”¨ Covering Indexï¼Œé‚£ä¹ˆå°±è¦æ³¨æ„ SELECT æ–¹å¼ï¼Œåª SELECT å¿…è¦çš„å­—æ®µï¼Œåƒä¸‡åˆ«SELECT * FROM â€¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¤ªå¯èƒ½æŠŠæ‰€æœ‰çš„å­—æ®µä¸€èµ·åšç´¢å¼•ï¼Œè™½ç„¶å¯ä»¥é‚£æ ·åšï¼Œä½†é‚£æ ·ä¼šè®©ç´¢å¼•æ–‡ä»¶è¿‡å¤§ï¼Œç»“æœåå€’ä¼šå¼„å·§æˆæ‹™ã€‚</p><p>å¦‚ä½•æ‰èƒ½ç¡®è®¤æŸ¥è¯¢ä½¿ç”¨äº† Covering Index å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨ EXPLAIN å³å¯ï¼åªè¦åœ¨ Extra é‡Œå‡ºç°Using indexå°±è¯´æ˜ä½¿ç”¨çš„æ˜¯ Covering Indexã€‚</p><p>è¿™é‡Œå†ä¸¾ä¸¤ä¸ªæ —å­ï¼Œè®©å¤§å®¶å°è±¡æ·±ç‚¹ã€‚</p><p>ä¾‹å­ä¸€</p><p>åœ¨æ–‡ç« ç³»ç»Ÿé‡Œç»Ÿè®¡æ€»æ•°çš„æ—¶å€™ï¼Œä¸€èˆ¬çš„æŸ¥è¯¢æ˜¯è¿™æ ·çš„ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) FROM article WHERE category_id = ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>å½“æˆ‘ä»¬åœ¨<code>category_id</code>å»ºç«‹ç´¢å¼•åï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨çš„å°±æ˜¯ Covering Indexã€‚</p><blockquote><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://www.percona.com/blog/2007/04/10/count-vs-countcol/" target="_blank" rel="noopener">COUNT(*) vs COUNT(col)</a></p></blockquote><p>ä¾‹å­äºŒ<br>åœ¨æ–‡ç« ç³»ç»Ÿé‡Œåˆ†é¡µæ˜¾ç¤ºçš„æ—¶å€™ï¼Œä¸€èˆ¬çš„æŸ¥è¯¢æ˜¯è¿™æ ·çš„ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id, title, content FROM article ORDER BY created DESC LIMIT 10000, 10;</span><br></pre></td></tr></tbody></table></figure><p></p><p>é€šå¸¸è¿™æ ·çš„æŸ¥è¯¢ä¼šæŠŠç´¢å¼•å»ºåœ¨createdå­—æ®µï¼ˆå…¶ä¸­idæ˜¯ä¸»é”®ï¼‰ï¼Œä¸è¿‡å½“LIMITåç§»å¾ˆå¤§æ—¶ï¼ŒæŸ¥è¯¢æ•ˆç‡ä»ç„¶å¾ˆä½ï¼Œè¿™æ—¶è¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT id, title, content FROM article</span><br><span class="line">INNER JOIN (</span><br><span class="line">    SELECT id FROM article ORDER BY created DESC LIMIT 10000, 10</span><br><span class="line">) AS page USING(id);</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ­¤æ—¶ï¼Œå°±å¯ä»¥åœ¨å­æŸ¥è¯¢é‡Œåˆ©ç”¨ä¸Š Covering Indexï¼Œå¿«é€Ÿå®šä½ idï¼ŒæŸ¥è¯¢æ•ˆç‡å—·å—·çš„ã€‚</p><p>åŸºäºæˆ‘çš„æµ‹è¯•æ•°æ®ï¼Œè¿™ä¸¤æ¡è¯­å¥çš„æŸ¥è¯¢è€—æ—¶åˆ†åˆ«æ˜¯ â€œ0.08 ç§’â€ å’Œâ€œ0.01 ç§’ä»¥å†…â€ï¼Œ8 å€çš„å·®è·å•Šï¼ä¸ç”±åˆæƒ³èµ·äº†åœ°ç²¾çš„ç»å…¸è¯­å½•<br></p><blockquote class="blockquote-center"><p>æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œæˆ‘çš„æœ‹å‹ï¼</p></blockquote><p></p><blockquote><p>è¡¥å……ï¼šInnoDB å¼•æ“å±‚æ˜¯ä¼šå¯¹äºŒçº§ç´¢å¼•åšè‡ªåŠ¨æ‰©å±•ï¼Œä¼˜åŒ–å™¨èƒ½è¯†åˆ«å‡ºæ‰©å±•çš„ä¸»é”®ã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="https://blog.51cto.com/huanghualiang/1607496" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p></blockquote><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸¤æ¡è¯­å¥åˆ†åˆ«å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql> EXPLAIN SELECT SQL_NO_CACHE id, title, content FROM article ORDER BY created DESC LIMIT 10000, 10;</span><br><span class="line">+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+</span><br><span class="line">| id | select_type | table   | partitions | <span class="built_in">type</span> | possible_keys | key  | key_len | ref  | rows  | filtered | Extra          |</span><br><span class="line">+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+</span><br><span class="line">|  1 | SIMPLE      | article | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 99210 |   100.00 | Using filesort |</span><br><span class="line">+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 2 warnings (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql> EXPLAIN SELECT SQL_NO_CACHE id, title, content FROM article INNER JOIN ( SELECT id FROM article ORDER BY created DESC LIMIT 10000, 10 ) AS page USING(id);</span><br><span class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+</span><br><span class="line">| id | select_type | table      | partitions | <span class="built_in">type</span>   | possible_keys | key         | key_len | ref     | rows  | filtered | Extra                            |</span><br><span class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+</span><br><span class="line">|  1 | PRIMARY     | <derived2> | NULL       | ALL    | NULL          | NULL        | NULL    | NULL    | 10010 |   100.00 | NULL                             |</span><br><span class="line">|  1 | PRIMARY     | article    | NULL       | eq_ref | PRIMARY       | PRIMARY     | 4       | page.id |     1 |   100.00 | NULL                             |</span><br><span class="line">|  2 | DERIVED     | article    | NULL       | index  | NULL          | idx_created | 5       | NULL    | 10010 |   100.00 | Backward index scan; Using index |</span><br><span class="line">+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span>, 2 warnings (0.00 sec)</span><br></pre></td></tr></tbody></table></figure><p></p><p>é€šè¿‡ EXPLAIN æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºï¼Œç¬¬ä¸€ä¸ªæŸ¥è¯¢æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼ŒExtra é‡Œæ˜¯ â€œUsing filesortâ€ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…çš„æƒ…å†µã€‚è€Œç¬¬äºŒä¸ªçš„ Extra æ˜¯ â€œUsing indexâ€ï¼Œæ‰€ä»¥è¿™ä¸¤è€…é—´æ•ˆç‡ä¸Šçš„å·®è·å°±æ˜¾è€Œæ˜“è§äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Covering Index å¹¶ä¸æ˜¯ä»€ä¹ˆå¾ˆéš¾çš„æ¦‚å¿µï¼Œä½†æ˜¯æœ‰äº›äººè¿˜ä¸äº†è§£å®ƒæˆ–å¿½è§†å®ƒçš„ä»·å€¼ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½ç»™ä½ æä¸ªé†’ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://yq.aliyun.com/articles/62419" target="_blank" rel="noopener">MySQL è¦†ç›–ç´¢å¼•</a></li><li><a href="https://www.jianshu.com/p/fa24238d84a9" target="_blank" rel="noopener">MySQL ç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç†</a></li><li><a href="https://segmentfault.com/a/1190000010264071" target="_blank" rel="noopener">MySQL è®¤è¯†ç´¢å¼•</a></li><li><a href="https://huoding.com/2018/02/27/656" target="_blank" rel="noopener">è°ˆè°ˆ SQL æŸ¥è¯¢ä¸­å›è¡¨å¯¹æ€§èƒ½çš„å½±å“</a></li><li><a href="http://www.cnblogs.com/digdeep/p/4995039.html" target="_blank" rel="noopener">MySQL ä¼˜åŒ–ä¹‹ MRR (Multi-Range Read: äºŒçº§ç´¢å¼•åˆå¹¶å›è¡¨)</a></li><li><a href="https://blog.51cto.com/huanghualiang/1607496" target="_blank" rel="noopener">å…³äº MySQL InnoDB è¡¨çš„äºŒçº§ç´¢å¼•æ˜¯å¦åŠ å…¥ä¸»é”®åˆ—çš„é—®é¢˜è§£é‡Š</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;hehe.jpg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>rsync å‘½ä»¤è¯¦è§£</title>
    <link href="https://jiemin.wang/2019/03/29/rsync/"/>
    <id>https://jiemin.wang/2019/03/29/rsync/</id>
    <published>2019-03-29T04:53:22.000Z</published>
    <updated>2019-03-29T05:18:58.858Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯-Rsync"><a href="#ä»€ä¹ˆæ˜¯-Rsync" class="headerlink" title="ä»€ä¹ˆæ˜¯ Rsync"></a>ä»€ä¹ˆæ˜¯ Rsync</h2><p>Rsyncï¼ˆremote synchronizeï¼‰æ˜¯ä¸€ä¸ªè¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯é€šè¿‡ LAN/WAN å¿«é€ŸåŒæ­¥å¤šå°ä¸»æœºé—´çš„æ–‡ä»¶ã€‚Rsync ä½¿ç”¨æ‰€è°“çš„ â€œRsync ç®—æ³•â€ æ¥ä½¿æœ¬åœ°å’Œè¿œ ç¨‹ä¸¤ä¸ªä¸»æœºä¹‹é—´çš„æ–‡ä»¶è¾¾åˆ°åŒæ­¥ï¼Œè¿™ä¸ªç®—æ³•åªä¼ é€ä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½æ•´ä»½ä¼ é€ï¼Œå› æ­¤é€Ÿåº¦ç›¸å½“å¿«ã€‚</p><p>Rsync æœ¬æ¥æ˜¯ç”¨äºæ›¿ä»£ rcp çš„ä¸€ä¸ªå·¥å…·ï¼Œç›®å‰ç”± <a href="https://rsync.samba.org/" target="_blank" rel="noopener">samba</a> ç»´æŠ¤ï¼Œæ‰€ä»¥ rsync.conf æ–‡ä»¶çš„æ ¼å¼ç±»ä¼¼äº Samba çš„ ä¸»é…ç½®æ–‡ä»¶ã€‚Rsync å¯ä»¥é€šè¿‡ rsh æˆ– ssh ä½¿ç”¨ï¼Œä¹Ÿèƒ½ä»¥ daemon æ¨¡å¼å»è¿è¡Œï¼Œåœ¨ä»¥ daemon æ–¹å¼è¿è¡Œæ—¶ Rsync server ä¼šæ‰“å¼€ä¸€ä¸ª 873 ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯å»è¿æ¥ã€‚è¿æ¥æ—¶ï¼ŒRsync server ä¼šæ£€æŸ¥å£ä»¤æ˜¯å¦ç›¸ç¬¦ï¼Œè‹¥é€šè¿‡å£ä»¤æŸ¥æ ¸ï¼Œåˆ™å¯ä»¥å¼€å§‹è¿›è¡Œæ–‡ä»¶ä¼ è¾“ã€‚ç¬¬ä¸€æ¬¡è¿é€šå®Œæˆæ—¶ï¼Œä¼šæŠŠæ•´ä»½æ–‡ä»¶ä¼ è¾“ä¸€æ¬¡ï¼Œä»¥ååˆ™å°±åªéœ€è¿›è¡Œå¢é‡å¤‡ä»½ã€‚</p><p>Rsync æ”¯æŒå¤§å¤šæ•°çš„ç±» Unix ç³»ç»Ÿï¼Œæ— è®ºæ˜¯ Linuxã€Solaris è¿˜æ˜¯ BSD ä¸Šéƒ½ç»è¿‡äº†è‰¯å¥½çš„æµ‹è¯•ã€‚æ­¤å¤–ï¼Œå®ƒåœ¨ windows å¹³å°ä¸‹ä¹Ÿæœ‰ç›¸åº”çš„ç‰ˆæœ¬ï¼Œå¦‚ cwRsync å’Œ Sync2NAS ç­‰å·¥å…·ã€‚</p><p>Rsync çš„åŸºæœ¬ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>å¯ä»¥é•œåƒä¿å­˜æ•´ä¸ªç›®å½•æ ‘å’Œæ–‡ä»¶ç³»ç»Ÿï¼›</li><li>å¯ä»¥å¾ˆå®¹æ˜“åšåˆ°ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰ï¼›</li><li>æ— é¡»ç‰¹æ®Šæƒé™å³å¯å®‰è£…ï¼›</li><li>ä¼˜åŒ–çš„æµç¨‹ï¼Œæ–‡ä»¶ä¼ è¾“æ•ˆç‡é«˜ï¼›</li><li>å¯ä»¥ä½¿ç”¨ rshã€ssh ç­‰æ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç›´æ¥çš„ socket è¿æ¥ï¼›</li><li>æ”¯æŒåŒ¿åä¼ è¾“ã€‚</li></ol><h2 id="Rsync-åŒæ­¥ç®—æ³•"><a href="#Rsync-åŒæ­¥ç®—æ³•" class="headerlink" title="Rsync åŒæ­¥ç®—æ³•"></a>Rsync åŒæ­¥ç®—æ³•</h2><p>Rsync åªæ‰€ä»¥åŒæ­¥æ–‡ä»¶çš„é€Ÿåº¦ç›¸å½“å¿«ï¼Œæ˜¯å› ä¸º â€œRsync åŒæ­¥ç®—æ³•â€ èƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è®¡ç®—å‡ºéœ€è¦å¤‡ä»½çš„æ•°æ®ï¼Œå…³äº Rsync çš„åŒæ­¥ç®—æ³•æè¿°å¦‚ä¸‹ï¼š</p><p>å‡å®šåœ¨ 1 å·å’Œ 2 å·ä¸¤å°è®¡ç®—æœºä¹‹é—´åŒæ­¥ç›¸ä¼¼çš„æ–‡ä»¶ A ä¸ Bï¼Œå…¶ä¸­ 1 å·å¯¹æ–‡ä»¶ A æ‹¥æœ‰è®¿é—®æƒï¼Œ2 å·å¯¹æ–‡ä»¶ B æ‹¥æœ‰è®¿é—®æƒã€‚å¹¶ä¸”å‡å®šä¸»æœº 1 å·ä¸ 2 å·ä¹‹é—´çš„ç½‘ç»œå¸¦å®½å¾ˆå°ã€‚é‚£ä¹ˆ rsync ç®—æ³•å°†é€šè¿‡ä¸‹é¢çš„äº”ä¸ªæ­¥éª¤æ¥å®Œæˆï¼š</p><ol><li>2 å·å°†æ–‡ä»¶ B åˆ†å‰²æˆä¸€ç»„ä¸é‡å çš„å›ºå®šå¤§å°ä¸º S å­—èŠ‚çš„æ•°æ®å—ï¼Œæœ€åä¸€å—å¯èƒ½ä¼šæ¯” S å°ã€‚</li><li>2 å·å¯¹æ¯ä¸€ä¸ªåˆ†å‰²å¥½çš„æ•°æ®å—æ‰§è¡Œä¸¤ç§æ ¡éªŒï¼šä¸€ç§æ˜¯ 32 ä½çš„æ»šåŠ¨å¼±æ ¡éªŒï¼Œå¦ä¸€ç§æ˜¯ 128 ä½çš„ MD4 å¼ºæ ¡éªŒ</li><li>2 å·å°†è¿™äº›æ ¡éªŒç»“æœå‘ç»™ 1 å·ã€‚</li><li>1 å·é€šè¿‡æœç´¢æ–‡ä»¶ A çš„æ‰€æœ‰å¤§å°ä¸º S çš„æ•°æ®å— (åç§»é‡å¯ä»¥ä»»é€‰ï¼Œä¸ä¸€å®šéè¦æ˜¯ S çš„å€æ•°)ï¼Œæ¥å¯»æ‰¾ä¸æ–‡ä»¶ B çš„æŸä¸€å—æœ‰ç€ç›¸åŒçš„å¼±æ ¡éªŒç å’Œå¼ºæ ¡éªŒç çš„æ•°æ®å—ã€‚è¿™é¡¹å·¥ä½œå¯ä»¥å€ŸåŠ©æ»šåŠ¨æ ¡éªŒçš„ç‰¹æ€§å¾ˆå¿«å®Œæˆã€‚</li><li>1 å·å‘ç»™ 2 å·ä¸€ä¸²æŒ‡ä»¤æ¥ç”Ÿæˆæ–‡ä»¶ A åœ¨ 2 å·ä¸Šçš„å¤‡ä»½ã€‚è¿™é‡Œçš„æ¯ä¸€æ¡æŒ‡ä»¤è¦ä¹ˆæ˜¯å¯¹æ–‡ä»¶ B ç»æ‹¥æœ‰æŸä¸€ä¸ªæ•°æ®å—è€Œä¸é¡»é‡ä¼ çš„è¯æ˜ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªæ•°æ®å—ï¼Œè¿™ä¸ªæ•°æ®å—è‚¯å®šæ˜¯æ²¡æœ‰ä¸æ–‡ä»¶ B çš„ä»»ä½•ä¸€ä¸ªæ•°æ®å—åŒ¹é…ä¸Šçš„ã€‚</li></ol><h2 id="Rsync-å‚æ•°è¯´æ˜"><a href="#Rsync-å‚æ•°è¯´æ˜" class="headerlink" title="Rsync å‚æ•°è¯´æ˜"></a>Rsync å‚æ•°è¯´æ˜</h2><p>é…ç½®æ–‡ä»¶ï¼š<code>rsyncd.conf</code></p><h4 id="å…¨å±€å‚æ•°"><a href="#å…¨å±€å‚æ•°" class="headerlink" title="å…¨å±€å‚æ•°"></a>å…¨å±€å‚æ•°</h4><p>åœ¨æ–‡ä»¶ä¸­ï¼Œ<code>[module]</code>ä¹‹å‰çš„æ‰€æœ‰å‚æ•°éƒ½æ˜¯å…¨å±€å‚æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å…¨å±€å‚æ•°éƒ¨åˆ†å®šä¹‰æ¨¡å—å‚æ•°ï¼Œè¿™æ—¶å€™è¯¥å‚æ•°çš„å€¼å°±æ˜¯æ‰€æœ‰æ¨¡å—çš„é»˜è®¤å€¼ã€‚</p><p><code>port</code>æŒ‡å®šåå°ç¨‹åºä½¿ç”¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º <code>873</code>ã€‚</p><p><code>motd file</code>ç”¨æ¥æŒ‡å®šä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶ï¼Œå½“å®¢æˆ·è¿æ¥æœåŠ¡å™¨æ—¶è¯¥æ–‡ä»¶çš„å†…å®¹æ˜¾ç¤ºç»™å®¢æˆ·ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ <code>motd</code> æ–‡ä»¶çš„ã€‚</p><p><code>log file</code>æŒ‡å®š <code>rsync</code> çš„æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸å°†æ—¥å¿—å‘é€ç»™ <code>syslog</code>ã€‚æ¯”å¦‚å¯æŒ‡å®šä¸º <code>/var/log/rsyncd.log</code>ã€‚</p><p><code>pid file</code>æŒ‡å®š <code>rsync</code> çš„ <code>pid</code> æ–‡ä»¶ï¼Œé€šå¸¸æŒ‡å®šä¸º <code>/var/run/rsyncd.pid</code>ã€‚</p><p><code>syslog facility</code>æŒ‡å®š <code>rsync</code> å‘é€æ—¥å¿—æ¶ˆæ¯ç»™ <code>syslog</code> æ—¶çš„æ¶ˆæ¯çº§åˆ«ï¼Œå¸¸è§çš„æ¶ˆæ¯çº§åˆ«æ˜¯ï¼š</p><ul><li>daemon é»˜è®¤å€¼</li><li>uth</li><li>authpriv</li><li>cron</li><li>daemon</li><li>ftp</li><li>kern</li><li>lpr</li><li>mail</li><li>news</li><li>security</li><li>sys-log</li><li>user</li><li>uucp</li><li>local0</li><li>local1</li><li>local2</li><li>local3</li><li>local4</li><li>local5</li><li>local6</li><li>local7</li></ul><h4 id="æ¨¡å—å‚æ•°"><a href="#æ¨¡å—å‚æ•°" class="headerlink" title="æ¨¡å—å‚æ•°"></a>æ¨¡å—å‚æ•°</h4><p>ä¸»è¦æ˜¯å®šä¹‰æœåŠ¡å™¨å“ªä¸ªç›®å½•è¦è¢«åŒæ­¥ã€‚å…¶æ ¼å¼å¿…é¡»ä¸º<code>â€œ[module]â€</code>å½¢å¼ï¼Œè¿™ä¸ªåå­—å°±æ˜¯åœ¨ <code>rsync</code> å®¢æˆ·ç«¯çœ‹åˆ°çš„åå­—ï¼Œå…¶å®æœ‰ç‚¹è±¡ <code>Samba</code> æœåŠ¡å™¨æä¾›çš„å…±äº«åã€‚è€ŒæœåŠ¡å™¨çœŸæ­£åŒæ­¥çš„æ•°æ®æ˜¯é€šè¿‡ <code>path</code> æ¥æŒ‡å®šçš„ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œæ¥æŒ‡å®šå¤šä¸ªæ¨¡å—ï¼Œæ¨¡å—ä¸­å¯ä»¥å®šä¹‰ä»¥ä¸‹å‚æ•°ï¼š</p><p><code>comment</code>ç»™æ¨¡å—æŒ‡å®šä¸€ä¸ªæè¿°ï¼Œè¯¥æè¿°è¿åŒæ¨¡å—ååœ¨å®¢æˆ·è¿æ¥å¾—åˆ°æ¨¡å—åˆ—è¡¨æ—¶æ˜¾ç¤ºç»™å®¢æˆ·ã€‚é»˜è®¤æ²¡æœ‰æè¿°å®šä¹‰ã€‚</p><p><code>path</code>æŒ‡å®šè¯¥æ¨¡å—çš„ä¾›å¤‡ä»½çš„ç›®å½•æ ‘è·¯å¾„ï¼Œè¯¥å‚æ•°æ˜¯å¿…é¡»æŒ‡å®šçš„ã€‚</p><p><code>use chroot</code>å¦‚æœæŒ‡å®šä¸º <code>true</code>ï¼Œé‚£ä¹ˆ <code>rsync</code> åœ¨ä¼ è¾“æ–‡ä»¶ä»¥å‰é¦–å…ˆ <code>chroot</code> åˆ° <code>path</code> å‚æ•°æ‰€æŒ‡å®šçš„ç›®å½•ä¸‹ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å®ç°é¢å¤–çš„å®‰å…¨é˜²æŠ¤ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯éœ€è¦ä»¥ <code>root</code> æƒé™ï¼Œå¹¶ä¸”ä¸èƒ½å¤‡ä»½æŒ‡å‘å¤–éƒ¨çš„ç¬¦å·è¿æ¥æ‰€æŒ‡å‘çš„ç›®å½•æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º <code>true</code>ã€‚</p><p><code>uid</code>æŒ‡å®šå½“è¯¥æ¨¡å—ä¼ è¾“æ–‡ä»¶æ—¶å®ˆæŠ¤è¿›ç¨‹åº”è¯¥å…·æœ‰çš„ <code>uid</code>ï¼Œé…åˆ <code>gid</code>é€‰é¡¹ä½¿ç”¨å¯ä»¥ç¡®å®šå“ªäº›å¯ä»¥è®¿é—®æ€ä¹ˆæ ·çš„æ–‡ä»¶æƒé™ï¼Œé»˜è®¤å€¼æ˜¯<code>â€nobodyâ€</code>ã€‚</p><p><code>gid</code>æŒ‡å®šå½“è¯¥æ¨¡å—ä¼ è¾“æ–‡ä»¶æ—¶å®ˆæŠ¤è¿›ç¨‹åº”è¯¥å…·æœ‰çš„ <code>gid</code>ã€‚é»˜è®¤å€¼ä¸º<code>â€nobodyâ€</code>ã€‚</p><p><code>max connections</code>æŒ‡å®šè¯¥æ¨¡å—çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°é‡ä»¥ä¿æŠ¤æœåŠ¡å™¨ï¼Œè¶…è¿‡é™åˆ¶çš„è¿æ¥è¯·æ±‚å°†è¢«å‘ŠçŸ¥éšåå†è¯•ã€‚é»˜è®¤å€¼æ˜¯ <code>0</code>ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰é™åˆ¶ã€‚</p><p><code>list</code>è¯¥é€‰é¡¹è®¾å®šå½“å®¢æˆ·è¯·æ±‚å¯ä»¥ä½¿ç”¨çš„æ¨¡å—åˆ—è¡¨æ—¶ï¼Œè¯¥æ¨¡å—æ˜¯å¦åº”è¯¥è¢«åˆ—å‡ºã€‚å¦‚æœè®¾ç½®è¯¥é€‰é¡¹ä¸º <code>false</code>ï¼Œå¯ä»¥åˆ›å»ºéšè—çš„æ¨¡å—ã€‚é»˜è®¤å€¼æ˜¯ <code>true</code>ã€‚</p><p><code>read only</code>è®¾å®šæ˜¯å¦å…è®¸å®¢æˆ·ä¸Šè½½æ–‡ä»¶ã€‚å¦‚æœä¸º <code>true</code> é‚£ä¹ˆä»»ä½•ä¸Šè½½è¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼Œå¦‚æœä¸º <code>false</code> å¹¶ä¸”æœåŠ¡å™¨ç›®å½•è¯»å†™æƒé™å…è®¸é‚£ä¹ˆä¸Šè½½æ˜¯å…è®¸çš„ã€‚é»˜è®¤å€¼ä¸º <code>true</code>ã€‚</p><p><code>exclude</code>ç”¨æ¥æŒ‡å®šå¤šä¸ªç”±ç©ºæ ¼éš”å¼€çš„å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½• (ç›¸å¯¹è·¯å¾„)ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° <code>exclude</code> åˆ—è¡¨ä¸­ã€‚è¿™ç­‰åŒäºåœ¨å®¢æˆ·ç«¯å‘½ä»¤ä¸­ä½¿ç”¨<code>--exclude</code>æ¥æŒ‡å®š æ¨¡å¼ï¼Œä¸€ä¸ªæ¨¡å—åªèƒ½æŒ‡å®šä¸€ä¸ª <code>exclude</code> é€‰é¡¹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¯¥é€‰é¡¹æœ‰ä¸€å®šçš„å®‰å…¨æ€§é—®é¢˜ï¼Œå®¢æˆ·å¾ˆæœ‰å¯èƒ½ç»•è¿‡ <code>exclude</code> åˆ—è¡¨ï¼Œå¦‚æœå¸Œæœ›ç¡®ä¿ç‰¹å®š çš„æ–‡ä»¶ä¸èƒ½è¢«è®¿é—®ï¼Œé‚£å°±æœ€å¥½ç»“åˆ <code>uid/gid</code> é€‰é¡¹ä¸€èµ·ä½¿ç”¨ã€‚</p><p><code>exclude from</code>æŒ‡å®šä¸€ä¸ªåŒ…å« <code>exclude</code> æ¨¡å¼çš„å®šä¹‰çš„æ–‡ä»¶åï¼ŒæœåŠ¡å™¨ä»è¯¥æ–‡ä»¶ä¸­è¯»å– <code>exclude</code> åˆ—è¡¨å®šä¹‰ã€‚</p><p><code>include</code>ç”¨æ¥æŒ‡å®šä¸æ’é™¤ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚è¿™ç­‰åŒäºåœ¨å®¢æˆ·ç«¯å‘½ä»¤ä¸­ä½¿ç”¨<code>â€“include</code> æ¥æŒ‡å®šæ¨¡å¼ï¼Œç»“åˆ <code>include</code> å’Œ <code>exclude</code> å¯ä»¥å®šä¹‰å¤æ‚çš„ <code>exclude/include</code> è§„åˆ™ã€‚</p><p><code>include from</code>æŒ‡å®šä¸€ä¸ªåŒ…å« <code>include</code> æ¨¡å¼çš„å®šä¹‰çš„æ–‡ä»¶åï¼ŒæœåŠ¡å™¨ä»è¯¥æ–‡ä»¶ä¸­è¯»å– <code>include</code> åˆ—è¡¨å®šä¹‰ã€‚</p><p><code>auth users</code>æŒ‡å®šç”±ç©ºæ ¼æˆ–é€—å·åˆ†éš”çš„ç”¨æˆ·ååˆ—è¡¨ï¼Œåªæœ‰è¿™äº›ç”¨æˆ·æ‰å…è®¸è¿æ¥è¯¥æ¨¡å—ã€‚è¿™é‡Œçš„ç”¨æˆ·å’Œç³»ç»Ÿç”¨æˆ·æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚å¦‚æœâ€auth usersâ€ è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘å‡ºå¯¹è¯¥æ¨¡å—çš„è¿æ¥è¯·æ±‚ä»¥åä¼šè¢« <code>rsync</code> è¯·æ±‚ <code>challenged</code> è¿›è¡ŒéªŒè¯èº«ä»½è¿™é‡Œä½¿ç”¨çš„ <code>challenge/response</code> è®¤è¯åè®®ã€‚ç”¨æˆ·çš„åå’Œå¯†ç ä»¥æ˜æ–‡æ–¹å¼å­˜æ”¾åœ¨<code>â€secrets fileâ€</code> é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹æ— éœ€å¯†ç å°±å¯ä»¥è¿æ¥æ¨¡å— (ä¹Ÿå°±æ˜¯åŒ¿åæ–¹å¼)ã€‚</p><p><code>secrets file</code>æŒ‡å®šä¸€ä¸ªåŒ…å«å®šä¹‰ç”¨æˆ·å: å¯†ç å¯¹çš„æ–‡ä»¶ã€‚åªæœ‰åœ¨<code>â€auth usersâ€</code> è¢«å®šä¹‰æ—¶ï¼Œè¯¥æ–‡ä»¶æ‰æœ‰ä½œç”¨ã€‚æ–‡ä»¶æ¯è¡ŒåŒ…å«ä¸€ä¸ª <code>username:passwd</code> å¯¹ã€‚ä¸€èˆ¬æ¥è¯´å¯†ç æœ€å¥½ä¸è¦è¶…è¿‡ <code>8</code> ä¸ªå­—ç¬¦ã€‚æ²¡æœ‰é»˜è®¤çš„ <code>secures file</code>ï¼Œéœ€è¦é™å¼æŒ‡å®šä¸€ä¸ª (ä¾‹å¦‚ï¼š<code>/etc/rsyncd.passwd</code>)ã€‚æ³¨æ„ï¼šè¯¥æ–‡ä»¶çš„æƒé™ä¸€å®šè¦æ˜¯ <code>600</code>ï¼Œå¦åˆ™å®¢æˆ·ç«¯å°†ä¸èƒ½è¿æ¥æœåŠ¡å™¨ã€‚</p><p><code>strict modes</code>æŒ‡å®šæ˜¯å¦ç›‘æµ‹å¯†ç æ–‡ä»¶çš„æƒé™ï¼Œå¦‚æœè¯¥é€‰é¡¹å€¼ä¸º <code>true</code> é‚£ä¹ˆå¯†ç æ–‡ä»¶åªèƒ½è¢« <code>rsync</code> æœåŠ¡å™¨è¿è¡Œèº«ä»½çš„ç”¨æˆ·è®¿é—®ï¼Œå…¶ä»–ä»»ä½•ç”¨æˆ·ä¸å¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º <code>true</code>ã€‚</p><p><code>hosts allow</code>æŒ‡å®šå“ªäº› <code>IP</code> çš„å®¢æˆ·å…è®¸è¿æ¥è¯¥æ¨¡å—ã€‚å®¢æˆ·æ¨¡å¼å®šä¹‰å¯ä»¥æ˜¯ä»¥ä¸‹å½¢å¼ï¼š</p><ul><li>å•ä¸ª IP åœ°å€ï¼Œä¾‹å¦‚ï¼š192.167.0.1</li><li>æ•´ä¸ªç½‘æ®µï¼Œä¾‹å¦‚ï¼š192.168.0.0/24ï¼Œä¹Ÿå¯ä»¥æ˜¯ 192.168.0.0/255.255.255.0</li><li>å¤šä¸ª IP æˆ–ç½‘æ®µéœ€è¦ç”¨ç©ºæ ¼éš”å¼€ï¼Œ<code>â€œ*â€</code> åˆ™è¡¨ç¤ºæ‰€æœ‰ï¼Œé»˜è®¤æ˜¯å…è®¸æ‰€æœ‰ä¸»æœºè¿æ¥ã€‚</li></ul><p><code>hosts deny</code>æŒ‡å®šä¸å…è®¸è¿æ¥ <code>rsync</code> æœåŠ¡å™¨çš„æœºå™¨ï¼Œå¯ä»¥ä½¿ç”¨ <code>hosts allow</code> çš„å®šä¹‰æ–¹å¼æ¥è¿›è¡Œå®šä¹‰ã€‚é»˜è®¤æ˜¯æ²¡æœ‰ <code>hosts deny</code> å®šä¹‰ã€‚</p><p><code>ignore errors</code>æŒ‡å®š <code>rsyncd</code> åœ¨åˆ¤æ–­æ˜¯å¦è¿è¡Œä¼ è¾“æ—¶çš„åˆ é™¤æ“ä½œæ—¶å¿½ç•¥ <code>server</code> ä¸Šçš„ <code>IO</code> é”™è¯¯ï¼Œä¸€èˆ¬æ¥è¯´ <code>rsync</code> åœ¨å‡ºç° <code>IO</code> é”™è¯¯æ—¶å°†å°†è·³è¿‡<code>--delete</code>æ“ä½œï¼Œä»¥é˜²æ­¢å› ä¸ºæš‚æ—¶çš„èµ„æºä¸è¶³æˆ–å…¶å®ƒ <code>IO</code> é”™è¯¯å¯¼è‡´çš„ä¸¥é‡é—®é¢˜ã€‚</p><p><code>ignore nonreadable</code>æŒ‡å®š <code>rysnc</code> æœåŠ¡å™¨å®Œå…¨å¿½ç•¥é‚£äº›ç”¨æˆ·æ²¡æœ‰è®¿é—®æƒé™çš„æ–‡ä»¶ã€‚è¿™å¯¹äºåœ¨éœ€è¦å¤‡ä»½çš„ç›®å½•ä¸­æœ‰äº›æ–‡ä»¶æ˜¯ä¸åº”è¯¥è¢«å¤‡ä»½è€…å¾—åˆ°çš„æƒ…å†µæ˜¯æœ‰æ„ä¹‰çš„ã€‚</p><p><code>lock file</code>æŒ‡å®šæ”¯æŒ <code>max connections</code> å‚æ•°çš„é”æ–‡ä»¶ï¼Œé»˜è®¤å€¼æ˜¯ <code>/var/run/rsyncd.lock</code>ã€‚</p><p><code>transfer logging</code>ä½¿ <code>rsync</code> æœåŠ¡å™¨ä½¿ç”¨ <code>ftp</code> æ ¼å¼çš„æ–‡ä»¶æ¥è®°å½•ä¸‹è½½å’Œä¸Šè½½æ“ä½œåœ¨è‡ªå·±å•ç‹¬çš„æ—¥å¿—ä¸­ã€‚</p><p><code>log format</code>é€šè¿‡è¯¥é€‰é¡¹ç”¨æˆ·åœ¨ä½¿ç”¨ <code>transfer logging</code> å¯ä»¥è‡ªå·±å®šåˆ¶æ—¥å¿—æ–‡ä»¶çš„å­—æ®µã€‚å…¶æ ¼å¼æ˜¯ä¸€ä¸ªåŒ…å«æ ¼å¼å®šä¹‰ç¬¦çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨çš„æ ¼å¼å®šä¹‰ç¬¦å¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%h è¿œç¨‹ä¸»æœºå</span><br><span class="line">%a è¿œç¨‹IPåœ°å€</span><br><span class="line">%l æ–‡ä»¶é•¿åº¦å­—ç¬¦æ•°</span><br><span class="line">%p è¯¥æ¬¡rsyncä¼šè¯çš„è¿›ç¨‹id</span><br><span class="line">%o æ“ä½œç±»å‹ï¼š<span class="string">"send"</span>æˆ–<span class="string">"recv"</span></span><br><span class="line">%f æ–‡ä»¶å</span><br><span class="line">%P æ¨¡å—è·¯å¾„</span><br><span class="line">%m æ¨¡å—å</span><br><span class="line">%t å½“å‰æ—¶é—´</span><br><span class="line">%u è®¤è¯çš„ç”¨æˆ·å(åŒ¿åæ—¶æ˜¯null)</span><br><span class="line">%b å®é™…ä¼ è¾“çš„å­—èŠ‚æ•°</span><br><span class="line">%c å½“å‘é€æ–‡ä»¶æ—¶ï¼Œè¯¥å­—æ®µè®°å½•è¯¥æ–‡ä»¶çš„æ ¡éªŒç </span><br><span class="line">é»˜è®¤<span class="built_in">log</span>æ ¼å¼ä¸ºï¼š`%o %h [%a] %m (%u) %f %l`ï¼Œä¸€èˆ¬æ¥è¯´,åœ¨æ¯è¡Œçš„å¤´ä¸Šä¼šæ·»åŠ `%t [%p]`ã€‚åœ¨æºä»£ç ä¸­åŒæ—¶å‘å¸ƒæœ‰ä¸€ä¸ªå«rsyncstatsçš„perlè„šæœ¬ç¨‹åºæ¥ç»Ÿè®¡è¿™ç§æ ¼å¼çš„æ—¥å¿—æ–‡ä»¶ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>timeout</code>é€šè¿‡è¯¥é€‰é¡¹å¯ä»¥è¦†ç›–å®¢æˆ·æŒ‡å®šçš„ <code>IP</code> è¶…æ—¶æ—¶é—´ã€‚é€šè¿‡è¯¥é€‰é¡¹å¯ä»¥ç¡®ä¿ <code>rsync</code> æœåŠ¡å™¨ä¸ä¼šæ°¸è¿œç­‰å¾…ä¸€ä¸ªå´©æºƒçš„å®¢æˆ·ç«¯ã€‚è¶…æ—¶å•ä½ä¸ºç§’é’Ÿï¼Œ<code>0</code> è¡¨ç¤ºæ²¡æœ‰è¶…æ—¶å®šä¹‰ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚å¯¹äºåŒ¿å <code>rsync</code> æœåŠ¡å™¨æ¥è¯´ï¼Œä¸€ä¸ªç†æƒ³çš„æ•°å­—æ˜¯ <code>600</code>ã€‚</p><p><code>refuse options</code>é€šè¿‡è¯¥é€‰é¡¹å¯ä»¥å®šä¹‰ä¸€äº›ä¸å…è®¸å®¢æˆ·å¯¹è¯¥æ¨¡å—ä½¿ç”¨çš„å‘½ä»¤å‚æ•°åˆ—è¡¨ã€‚è¿™é‡Œå¿…é¡»ä½¿ç”¨å‘½ä»¤å…¨åï¼Œè€Œä¸èƒ½æ˜¯ç®€ç§°ã€‚ä½†å‘ç”Ÿæ‹’ç»æŸä¸ªå‘½ä»¤çš„æƒ…å†µæ—¶æœåŠ¡å™¨å°†æŠ¥å‘Šé”™è¯¯ä¿¡æ¯ç„¶åé€€å‡ºã€‚å¦‚æœè¦é˜²æ­¢ä½¿ç”¨å‹ç¼©ï¼Œåº”è¯¥æ˜¯ï¼š<code>dont compress = *</code>ã€‚</p><p><code>dont compress</code>ç”¨æ¥æŒ‡å®šé‚£äº›ä¸è¿›è¡Œå‹ç¼©å¤„ç†å†ä¼ è¾“çš„æ–‡ä»¶ï¼Œé»˜è®¤å€¼æ˜¯ <code>*.gz</code> <code>*.tgz</code> <code>*.zip</code> <code>*.z</code> <code>*.rpm</code> <code>*.deb</code> <code>*.iso</code> <code>*.bz2</code> <code>*.tbz</code></p><h2 id="Rsync-å‘½ä»¤"><a href="#Rsync-å‘½ä»¤" class="headerlink" title="Rsync å‘½ä»¤"></a>Rsync å‘½ä»¤</h2><p>åœ¨å¯¹ rsync æœåŠ¡å™¨é…ç½®ç»“æŸä»¥åï¼Œä¸‹ä¸€æ­¥å°±éœ€è¦åœ¨å®¢æˆ·ç«¯å‘å‡º rsync å‘½ä»¤æ¥å®ç°å°†æœåŠ¡å™¨ç«¯çš„æ–‡ä»¶å¤‡ä»½åˆ°å®¢æˆ·ç«¯æ¥ã€‚rsync æ˜¯ä¸€ä¸ªåŠŸèƒ½éå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå…¶å‘½ä»¤ä¹Ÿæœ‰å¾ˆå¤šåŠŸèƒ½ç‰¹è‰²é€‰é¡¹ï¼Œä¸‹é¢å°±å¯¹å®ƒçš„é€‰é¡¹ä¸€ä¸€è¿›è¡Œåˆ†æè¯´æ˜ã€‚<br>Rsync çš„å‘½ä»¤æ ¼å¼å¯ä»¥ä¸ºä»¥ä¸‹å…­ç§ï¼š</p><ol><li><code>rsync [OPTION]... SRC DEST</code></li><li><code>rsync [OPTION]... SRC [USER@]HOST:DEST</code></li><li><code>rsync [OPTION]... [USER@]HOST:SRC DEST</code></li><li><code>rsync [OPTION]... [USER@]HOST::SRC DEST</code></li><li><code>rsync [OPTION]... SRC [USER@]HOST::DEST</code></li><li><code>rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</code></li></ol><p>å¯¹åº”äºä»¥ä¸Šå…­ç§å‘½ä»¤æ ¼å¼ï¼Œrsync æœ‰å…­ç§ä¸åŒçš„å·¥ä½œæ¨¡å¼ï¼š</p><ol><li>æ‹·è´æœ¬åœ°æ–‡ä»¶ã€‚å½“ SRC å’Œ DES è·¯å¾„ä¿¡æ¯éƒ½ä¸åŒ…å«æœ‰å•ä¸ªå†’å·â€:â€ åˆ†éš”ç¬¦æ—¶å°±å¯åŠ¨è¿™ç§å·¥ä½œæ¨¡å¼ã€‚å¦‚ï¼šrsync -a /data /backup</li><li>ä½¿ç”¨ä¸€ä¸ªè¿œç¨‹ shell ç¨‹åº (å¦‚ rshã€ssh) æ¥å®ç°å°†æœ¬åœ°æœºå™¨çš„å†…å®¹æ‹·è´åˆ°è¿œç¨‹æœºå™¨ã€‚å½“ DST è·¯å¾„åœ°å€åŒ…å«å•ä¸ªå†’å·â€:â€åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -avz *.c foo:src</li><li>ä½¿ç”¨ä¸€ä¸ªè¿œç¨‹ shell ç¨‹åº (å¦‚ rshã€ssh) æ¥å®ç°å°†è¿œç¨‹æœºå™¨çš„å†…å®¹æ‹·è´åˆ°æœ¬åœ°æœºå™¨ã€‚å½“ SRC åœ°å€è·¯å¾„åŒ…å«å•ä¸ªå†’å·â€:â€åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -avz foo:src/bar /data</li><li>ä»è¿œç¨‹ rsync æœåŠ¡å™¨ä¸­æ‹·è´æ–‡ä»¶åˆ°æœ¬åœ°æœºã€‚å½“ SRC è·¯å¾„ä¿¡æ¯åŒ…å«â€::â€ åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -av <a href="mailto:root@172.16.78.192" target="_blank" rel="noopener">root@172.16.78.192</a>::www /databack</li><li>ä»æœ¬åœ°æœºå™¨æ‹·è´æ–‡ä»¶åˆ°è¿œç¨‹ rsync æœåŠ¡å™¨ä¸­ã€‚å½“ DST è·¯å¾„ä¿¡æ¯åŒ…å«â€::â€ åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -av /databack <a href="mailto:root@172.16.78.192" target="_blank" rel="noopener">root@172.16.78.192</a>::www</li><li>åˆ—è¿œç¨‹æœºçš„æ–‡ä»¶åˆ—è¡¨ã€‚è¿™ç±»ä¼¼äº rsync ä¼ è¾“ï¼Œä¸è¿‡åªè¦åœ¨å‘½ä»¤ä¸­çœç•¥æ‰æœ¬åœ°æœºä¿¡æ¯å³å¯ã€‚å¦‚ï¼šrsync -v rsync://172.16.78.192/www</li></ol><p>rsync å‚æ•°çš„å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose è¯¦ç»†æ¨¡å¼è¾“å‡º</span><br><span class="line">-q, --quiet ç²¾ç®€è¾“å‡ºæ¨¡å¼</span><br><span class="line">-c, --checksum æ‰“å¼€æ ¡éªŒå¼€å…³ï¼Œå¼ºåˆ¶å¯¹æ–‡ä»¶ä¼ è¾“è¿›è¡Œæ ¡éªŒ</span><br><span class="line">-a, --archive å½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§ï¼Œç­‰äº-rlptgoD</span><br><span class="line">-r, --recursive å¯¹å­ç›®å½•ä»¥é€’å½’æ¨¡å¼å¤„ç†</span><br><span class="line">-R, --relative ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿¡æ¯</span><br><span class="line">-b, --backup åˆ›å»ºå¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯å¯¹äºç›®çš„å·²ç»å­˜åœ¨æœ‰åŒæ ·çš„æ–‡ä»¶åæ—¶ï¼Œå°†è€çš„æ–‡ä»¶é‡æ–°å‘½åä¸º~filenameã€‚å¯ä»¥ä½¿ç”¨--suffixé€‰é¡¹æ¥æŒ‡å®šä¸åŒçš„å¤‡ä»½æ–‡ä»¶å‰ç¼€ã€‚</span><br><span class="line">--backup-dir å°†å¤‡ä»½æ–‡ä»¶(å¦‚~filename)å­˜æ”¾åœ¨åœ¨ç›®å½•ä¸‹ã€‚</span><br><span class="line">-suffix=SUFFIX å®šä¹‰å¤‡ä»½æ–‡ä»¶å‰ç¼€</span><br><span class="line">-u, --update ä»…ä»…è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è·³è¿‡æ‰€æœ‰å·²ç»å­˜åœ¨äºDSTï¼Œå¹¶ä¸”æ–‡ä»¶æ—¶é—´æ™šäºè¦å¤‡ä»½çš„æ–‡ä»¶ã€‚(ä¸è¦†ç›–æ›´æ–°çš„æ–‡ä»¶)</span><br><span class="line">-l, --links ä¿ç•™è½¯é“¾ç»“</span><br><span class="line">-L, --copy-links æƒ³å¯¹å¾…å¸¸è§„æ–‡ä»¶ä¸€æ ·å¤„ç†è½¯é“¾ç»“</span><br><span class="line">--copy-unsafe-links ä»…ä»…æ‹·è´æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“</span><br><span class="line">--safe-links å¿½ç•¥æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“</span><br><span class="line">-H, --hard-links ä¿ç•™ç¡¬é“¾ç»“</span><br><span class="line">-p, --perms ä¿æŒæ–‡ä»¶æƒé™</span><br><span class="line">-o, --owner ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯</span><br><span class="line">-g, --group ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯</span><br><span class="line">-D, --devices ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯</span><br><span class="line">-t, --<span class="built_in">times</span> ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯</span><br><span class="line">-S, --sparse å¯¹ç¨€ç–æ–‡ä»¶è¿›è¡Œç‰¹æ®Šå¤„ç†ä»¥èŠ‚çœDSTçš„ç©ºé—´</span><br><span class="line">-n, --dry-runç°å®å“ªäº›æ–‡ä»¶å°†è¢«ä¼ è¾“</span><br><span class="line">-W, --whole-file æ‹·è´æ–‡ä»¶ï¼Œä¸è¿›è¡Œå¢é‡æ£€æµ‹</span><br><span class="line">-x, --one-file-system ä¸è¦è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿè¾¹ç•Œ</span><br><span class="line">-B, --block-size=SIZE æ£€éªŒç®—æ³•ä½¿ç”¨çš„å—å°ºå¯¸ï¼Œé»˜è®¤æ˜¯700å­—èŠ‚</span><br><span class="line">-e, --rsh=COMMAND æŒ‡å®šä½¿ç”¨rshã€sshæ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥</span><br><span class="line">--rsync-path=PATH æŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„rsyncå‘½ä»¤æ‰€åœ¨è·¯å¾„ä¿¡æ¯</span><br><span class="line">-C, --cvs-exclude ä½¿ç”¨å’ŒCVSä¸€æ ·çš„æ–¹æ³•è‡ªåŠ¨å¿½ç•¥æ–‡ä»¶ï¼Œç”¨æ¥æ’é™¤é‚£äº›ä¸å¸Œæœ›ä¼ è¾“çš„æ–‡ä»¶</span><br><span class="line">--existing ä»…ä»…æ›´æ–°é‚£äº›å·²ç»å­˜åœ¨äºDSTçš„æ–‡ä»¶ï¼Œè€Œä¸å¤‡ä»½é‚£äº›æ–°åˆ›å»ºçš„æ–‡ä»¶</span><br><span class="line">--delete åˆ é™¤é‚£äº›DSTä¸­SRCæ²¡æœ‰çš„æ–‡ä»¶</span><br><span class="line">--delete-excluded åŒæ ·åˆ é™¤æ¥æ”¶ç«¯é‚£äº›è¢«è¯¥é€‰é¡¹æŒ‡å®šæ’é™¤çš„æ–‡ä»¶</span><br><span class="line">--delete-after ä¼ è¾“ç»“æŸä»¥åå†åˆ é™¤</span><br><span class="line">--ignore-errors åŠæ—¶å‡ºç°IOé”™è¯¯ä¹Ÿè¿›è¡Œåˆ é™¤</span><br><span class="line">--max-delete=NUM æœ€å¤šåˆ é™¤NUMä¸ªæ–‡ä»¶</span><br><span class="line">--partial ä¿ç•™é‚£äº›å› æ•…æ²¡æœ‰å®Œå…¨ä¼ è¾“çš„æ–‡ä»¶ï¼Œä»¥æ˜¯åŠ å¿«éšåçš„å†æ¬¡ä¼ è¾“</span><br><span class="line">--force å¼ºåˆ¶åˆ é™¤ç›®å½•ï¼Œå³ä½¿ä¸ä¸ºç©º</span><br><span class="line">--numeric-ids ä¸å°†æ•°å­—çš„ç”¨æˆ·å’Œç»„IDåŒ¹é…ä¸ºç”¨æˆ·åå’Œç»„å</span><br><span class="line">--timeout=TIME IPè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’</span><br><span class="line">-I, --ignore-times ä¸è·³è¿‡é‚£äº›æœ‰åŒæ ·çš„æ—¶é—´å’Œé•¿åº¦çš„æ–‡ä»¶</span><br><span class="line">--size-only å½“å†³å®šæ˜¯å¦è¦å¤‡ä»½æ–‡ä»¶æ—¶ï¼Œä»…ä»…å¯Ÿçœ‹æ–‡ä»¶å¤§å°è€Œä¸è€ƒè™‘æ–‡ä»¶æ—¶é—´</span><br><span class="line">--modify-window=NUM å†³å®šæ–‡ä»¶æ˜¯å¦æ—¶é—´ç›¸åŒæ—¶ä½¿ç”¨çš„æ—¶é—´æˆ³çª—å£ï¼Œé»˜è®¤ä¸º0</span><br><span class="line">-T --temp-dir=DIR åœ¨DIRä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶</span><br><span class="line">--compare-dest=DIR åŒæ ·æ¯”è¾ƒDIRä¸­çš„æ–‡ä»¶æ¥å†³å®šæ˜¯å¦éœ€è¦å¤‡ä»½</span><br><span class="line">-P ç­‰åŒäº --partial</span><br><span class="line">--progress æ˜¾ç¤ºå¤‡ä»½è¿‡ç¨‹</span><br><span class="line">-z, --compress å¯¹å¤‡ä»½çš„æ–‡ä»¶åœ¨ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©å¤„ç†</span><br><span class="line">--exclude=PATTERN æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼</span><br><span class="line">--include=PATTERN æŒ‡å®šä¸æ’é™¤è€Œéœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼</span><br><span class="line">--exclude-from=FILE æ’é™¤FILEä¸­æŒ‡å®šæ¨¡å¼çš„æ–‡ä»¶</span><br><span class="line">--include-from=FILE ä¸æ’é™¤FILEæŒ‡å®šæ¨¡å¼åŒ¹é…çš„æ–‡ä»¶</span><br><span class="line">--version æ‰“å°ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">--address ç»‘å®šåˆ°ç‰¹å®šçš„åœ°å€</span><br><span class="line">--config=FILE æŒ‡å®šå…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œä¸ä½¿ç”¨é»˜è®¤çš„rsyncd.confæ–‡ä»¶</span><br><span class="line">--port=PORT æŒ‡å®šå…¶ä»–çš„rsyncæœåŠ¡ç«¯å£</span><br><span class="line">--blocking-io å¯¹è¿œç¨‹shellä½¿ç”¨é˜»å¡IO</span><br><span class="line">-stats ç»™å‡ºæŸäº›æ–‡ä»¶çš„ä¼ è¾“çŠ¶æ€</span><br><span class="line">--progress åœ¨ä¼ è¾“æ—¶ç°å®ä¼ è¾“è¿‡ç¨‹</span><br><span class="line">--<span class="built_in">log</span>-format=formAT æŒ‡å®šæ—¥å¿—æ–‡ä»¶æ ¼å¼</span><br><span class="line">--password-file=FILE ä»FILEä¸­å¾—åˆ°å¯†ç </span><br><span class="line">--bwlimit=KBPS é™åˆ¶I/Oå¸¦å®½ï¼ŒKBytes per second</span><br><span class="line">-h, --<span class="built_in">help</span> æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Rsync-ä½¿ç”¨å®ä¾‹"><a href="#Rsync-ä½¿ç”¨å®ä¾‹" class="headerlink" title="Rsync ä½¿ç”¨å®ä¾‹"></a>Rsync ä½¿ç”¨å®ä¾‹</h2><h4 id="SSH-æ–¹å¼"><a href="#SSH-æ–¹å¼" class="headerlink" title="SSH æ–¹å¼"></a>SSH æ–¹å¼</h4><p>åœ¨æœåŠ¡ç«¯å¯åŠ¨ ssh æœåŠ¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ service sshd start</span><br><span class="line">å¯åŠ¨ sshdï¼š [ç¡®å®š]</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨ rsync è¿›è¡ŒåŒæ­¥</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ rsync å‘½ä»¤æ¥å¤‡ä»½æœåŠ¡ç«¯ä¸Šçš„æ•°æ®äº†ï¼ŒSSH æ–¹å¼æ˜¯é€šè¿‡ç³»ç»Ÿç”¨æˆ·æ¥è¿›è¡Œå¤‡ä»½çš„ï¼Œå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -vzrtopg --progress -e ssh --delete work@172.16.78.192:/www/* /databack/experiment/rsync</span><br><span class="line">work@172.16.78.192<span class="string">'s password:</span></span><br><span class="line"><span class="string">receiving file list ...</span></span><br><span class="line"><span class="string">5 files to consider</span></span><br><span class="line"><span class="string">test/</span></span><br><span class="line"><span class="string">a</span></span><br><span class="line"><span class="string">0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5)</span></span><br><span class="line"><span class="string">b</span></span><br><span class="line"><span class="string">67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5)</span></span><br><span class="line"><span class="string">c</span></span><br><span class="line"><span class="string">0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5)</span></span><br><span class="line"><span class="string">dd</span></span><br><span class="line"><span class="string">100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5)</span></span><br><span class="line"><span class="string">sent 96 bytes received 98190 bytes 11563.06 bytes/sec</span></span><br><span class="line"><span class="string">total size is 100663363 speedup is 1024.19</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸Šé¢çš„ä¿¡æ¯æè¿°äº†æ•´ä¸ªçš„å¤‡ä»½è¿‡ç¨‹ï¼Œä»¥åŠæ€»å…±å¤‡ä»½æ•°æ®çš„å¤§å°ã€‚</p><h4 id="åå°æœåŠ¡æ–¹å¼"><a href="#åå°æœåŠ¡æ–¹å¼" class="headerlink" title="åå°æœåŠ¡æ–¹å¼"></a>åå°æœåŠ¡æ–¹å¼</h4><p><strong>å¯åŠ¨ rsync æœåŠ¡</strong></p><p>ç¼–è¾‘ / etc/xinetd.d/rsync æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„ disable=yes æ”¹ä¸º disable=noï¼Œå¹¶é‡å¯ xinetd æœåŠ¡ï¼Œå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default: off</span></span><br><span class="line"><span class="comment"># description: The rsync server is a good addition to an ftp server, as it \</span></span><br><span class="line"><span class="comment"># allows crc checksumming etc.</span></span><br><span class="line">service rsync</span><br><span class="line">{</span><br><span class="line"><span class="built_in">disable</span> = no</span><br><span class="line">socket_type = stream</span><br><span class="line"><span class="built_in">wait</span> = no</span><br><span class="line">user = root</span><br><span class="line">server = /usr/bin/rsync</span><br><span class="line">server_args = --daemon</span><br><span class="line">log_on_failure += USERID</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/xinetd restart</span><br><span class="line">åœæ­¢ xinetdï¼š [ç¡®å®š]</span><br><span class="line">å¯åŠ¨ xinetdï¼š [ç¡®å®š]</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…è‡ªå·±æ‰‹åŠ¨å¯åŠ¨å¹¶æ·»åŠ è‡ªå¯åŠ¨ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/rsync --daemon --config=/etc/rsyncd.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/bin/rsync --daemon --config=/etc/rsyncd.conf"</span> >> /etc/rc.local</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>åˆ›å»ºé…ç½®æ–‡ä»¶</strong></p><p>é»˜è®¤å®‰è£…å¥½ rsync ç¨‹åºåï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»º rsync çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ‰‹å·¥æ¥åˆ›å»ºï¼Œå…¶ä¸»é…ç½®æ–‡ä»¶ä¸º â€œ/etc/rsyncd.confâ€ï¼Œåˆ›å»ºè¯¥æ–‡ä»¶å¹¶æ’å…¥å¦‚ä¸‹å†…å®¹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Minimal configuration file for rsync daemon</span></span><br><span class="line"><span class="comment"># See rsync(1) and rsyncd.conf(5) man pages for help</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################ ä»¥ä¸‹æ˜¯å…¬å…±å‚æ•°é…ç½® ############################</span></span><br><span class="line"><span class="comment"># This line is required by the /etc/init.d/rsyncd script</span></span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line"><span class="comment"># æœåŠ¡çš„ç«¯å£</span></span><br><span class="line">port = 873</span><br><span class="line"><span class="comment"># æœåŠ¡çš„IP</span></span><br><span class="line">address = 10.44.201.202</span><br><span class="line"><span class="comment"># è¿è¡Œçš„å®¿ä¸»è´¦æˆ·ï¼Œè¿™é‡Œä¸ºç®€å•å°±rootäº†</span></span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"><span class="comment"># æ‰“å¼€ï¼ˆyesï¼‰åæœ‰ä¸ªåŠŸèƒ½æ˜¯è®©ç¬¦å·é“¾æ¥å¯ä»¥åŒæ­¥è¿‡å»ï¼ˆä¸é€šè¿‡ç¬¦å·é“¾æ¥å¯¹åº”çš„å®é™…æ–‡ä»¶ï¼‰</span></span><br><span class="line">use chroot = no</span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯åªè¯»</span></span><br><span class="line"><span class="built_in">read</span> only = yes</span><br><span class="line"><span class="comment">#limit access to private LANs</span></span><br><span class="line">hosts allow=10.51.56.165/255.255.255.0</span><br><span class="line"><span class="comment"># hosts deny=*</span></span><br><span class="line"><span class="comment"># æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">max connections = 5</span><br><span class="line"><span class="comment"># æ¬¢è¿ä¿¡æ¯å¯¹åº”çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># motd file = /etc/rsyncd.motd</span></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯é“¾æ¥çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">timeout = 300</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸‹æ˜¯æ—¥å¿—ç›¸å…³é…ç½®ï¼Œå¯é€‰ä½¿ç”¨ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶å’Œç³»ç»Ÿæ—¥å¿—</span></span><br><span class="line"><span class="comment"># This will give you a separate log file</span></span><br><span class="line"><span class="comment"># log file = /var/log/rsync.log</span></span><br><span class="line"><span class="comment"># This will log every file transferred - up to 85,000+ per user, per sync</span></span><br><span class="line"><span class="comment"># transfer logging = yes</span></span><br><span class="line"><span class="comment"># log format = %t %a %m %f %b</span></span><br><span class="line"><span class="comment"># syslog facility = local3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# åŒæ­¥æ¨¡å—é…ç½® ################################</span></span><br><span class="line">[thrift]</span><br><span class="line"><span class="comment"># éœ€è¦åŒæ­¥çš„è·¯å¾„</span></span><br><span class="line">path = /data/JiemoLucenes</span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨listå‘½ä»¤åˆ—è¡¨æ˜¾ç¤º</span></span><br><span class="line">list=yes</span><br><span class="line"><span class="comment"># å¿½ç•¥é”™è¯¯</span></span><br><span class="line">ignore errors</span><br><span class="line"><span class="comment"># è®¤è¯ç”¨æˆ·</span></span><br><span class="line">auth users = root</span><br><span class="line"><span class="comment"># è®¤è¯ä½¿ç”¨çš„è´¦æˆ·å¯†ç æ–‡ä»¶</span></span><br><span class="line">secrets file = /etc/rsyncd.secrets</span><br><span class="line"><span class="comment"># å¤‡æ³¨ä¿¡æ¯</span></span><br><span class="line">comment = This is nexus data</span><br><span class="line"><span class="comment"># å¦‚æœæœ‰å¿½ç•¥çš„å­ç›®å½•ï¼Œå¯ä»¥é€šè¿‡excludeå®šä¹‰</span></span><br><span class="line"><span class="comment"># exclude = easylife/  samba/</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>åˆ›å»ºå¯†ç æ–‡ä»¶</strong><br>é‡‡ç”¨è¿™ç§æ–¹å¼ä¸èƒ½ä½¿ç”¨ç³»ç»Ÿç”¨æˆ·å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªå¯†ç æ–‡ä»¶ï¼Œå…¶æ ¼å¼ä¸º â€œusername:passwordâ€ï¼Œç”¨æˆ·åå¯ä»¥å’Œå¯†ç å¯ä»¥éšä¾¿å®šä¹‰ï¼Œæœ€å¥½ä¸è¦å’Œç³»ç»Ÿå¸æˆ·ä¸€è‡´ï¼ŒåŒæ—¶è¦æŠŠåˆ›å»ºçš„å¯†ç æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600ï¼Œè¿™åœ¨å‰é¢çš„æ¨¡å—å‚æ•°åšäº†è¯¦ç»†ä»‹ç»ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"work:abc123"</span> > /etc/rsyncd.passwd</span><br><span class="line">chmod 600 /etc/rsyncd.passwd</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>å¤‡ä»½</strong><br>å®Œæˆä»¥ä¸Šå·¥ä½œï¼Œç°åœ¨å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå¤‡ä»½äº†ï¼Œå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -avz --progress --delete work@172.16.78.192::www /databack/experiment/rsync</span><br><span class="line">Password:</span><br><span class="line">receiving file list ...</span><br><span class="line">6 files to consider</span><br><span class="line">./ files...</span><br><span class="line">a</span><br><span class="line">0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)</span><br><span class="line">b</span><br><span class="line">67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)</span><br><span class="line">c</span><br><span class="line">0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)</span><br><span class="line">dd</span><br><span class="line">100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6)</span><br><span class="line">sent 172 bytes received 98276 bytes 17899.64 bytes/sec</span><br><span class="line">total size is 150995011 speedup is 1533.75</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>æ¢å¤</strong><br>å½“æœåŠ¡å™¨çš„æ•°æ®å‡ºç°é—®é¢˜æ—¶ï¼Œé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦é€šè¿‡å®¢æˆ·ç«¯çš„æ•°æ®å¯¹æœåŠ¡ç«¯è¿›è¡Œæ¢å¤ï¼Œä½†å‰ææ˜¯æœåŠ¡ç«¯å…è®¸å®¢æˆ·ç«¯æœ‰å†™å…¥æƒé™ï¼Œå¦åˆ™ä¹Ÿä¸èƒ½åœ¨å®¢æˆ·ç«¯ç›´æ¥å¯¹æœåŠ¡ç«¯è¿›è¡Œæ¢å¤ï¼Œä½¿ç”¨ rsync å¯¹æ•°æ®è¿›è¡Œæ¢å¤çš„æ–¹æ³•å¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -avz --progress /databack/experiment/rsync/ work@172.16.78.192::www</span><br><span class="line">Password:</span><br><span class="line">building file list ...</span><br><span class="line">6 files to consider</span><br><span class="line">./</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)</span><br><span class="line">c</span><br><span class="line">sent 258 bytes received 76 bytes 95.43 bytes/sec</span><br><span class="line">total size is 150995011 speedup is 452080.87</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>ç¤ºä¾‹è„šæœ¬</strong><br>è¿™é‡Œè¿™äº›è„šæœ¬éƒ½æ˜¯ rsync ç½‘ç«™ä¸Šçš„ä¾‹å­ï¼š<br>1ã€æ¯éš”ä¸ƒå¤©å°†æ•°æ®å¾€ä¸­å¿ƒæœåŠ¡å™¨åšå¢é‡å¤‡ä»½<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script does personal backups to a rsync backup server. You will end up</span></span><br><span class="line"><span class="comment"># with a 7 day rotating incremental backup. The incrementals will go</span></span><br><span class="line"><span class="comment"># into subdirectories named after the day of the week, and the current</span></span><br><span class="line"><span class="comment"># full backup goes into a directory called "current"</span></span><br><span class="line"><span class="comment"># tridge@linuxcare.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># directory to backup</span></span><br><span class="line">BDIR=/home/<span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># excludes file - this contains a wildcard pattern per line of files to exclude</span></span><br><span class="line">EXCLUDES=<span class="variable">$HOME</span>/cron/excludes</span><br><span class="line"></span><br><span class="line"><span class="comment"># the name of the backup machine</span></span><br><span class="line">BSERVER=owl</span><br><span class="line"></span><br><span class="line"><span class="comment"># your password on the backup server</span></span><br><span class="line"><span class="built_in">export</span> RSYNC_PASSWORD=XXXXXX</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line"></span><br><span class="line">BACKUPDIR=`date +%A`</span><br><span class="line">OPTS=<span class="string">"--force --ignore-errors --delete-excluded --exclude-from=<span class="variable">$EXCLUDES</span></span></span><br><span class="line"><span class="string">--delete --backup --backup-dir=/<span class="variable">$BACKUPDIR</span> -a"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/bin:/usr/bin:/usr/<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># the following line clears the last weeks incremental directory</span></span><br><span class="line">[ -d <span class="variable">$HOME</span>/emptydir ] || mkdir <span class="variable">$HOME</span>/emptydir</span><br><span class="line">rsync --delete -a <span class="variable">$HOME</span>/emptydir/ <span class="variable">$BSERVER</span>::<span class="variable">$USER</span>/<span class="variable">$BACKUPDIR</span>/</span><br><span class="line">rmdir <span class="variable">$HOME</span>/emptydir</span><br><span class="line"></span><br><span class="line"><span class="comment"># now the actual transfer</span></span><br><span class="line">rsync <span class="variable">$OPTS</span> <span class="variable">$BDIR</span> <span class="variable">$BSERVER</span>::<span class="variable">$USER</span>/current</span><br></pre></td></tr></tbody></table></figure><p></p><p>2ã€å¤‡ä»½è‡³ä¸€ä¸ªç©ºé—²çš„ç¡¬ç›˜<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/bin:/usr/bin:/bin</span><br><span class="line"></span><br><span class="line">LIST=<span class="string">"rootfs usr data data2"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> <span class="variable">$LIST</span>; <span class="keyword">do</span></span><br><span class="line">mount /backup/<span class="variable">$d</span></span><br><span class="line">rsync -ax --exclude fstab --delete /<span class="variable">$d</span>/ /backup/<span class="variable">$d</span>/</span><br><span class="line">umount /backup/<span class="variable">$d</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">DAY=`date <span class="string">"+%A"</span>`</span><br><span class="line"></span><br><span class="line">rsync -a --delete /usr/<span class="built_in">local</span>/apache /data2/backups/<span class="variable">$DAY</span></span><br><span class="line">rsync -a --delete /data/solid /data2/backups/<span class="variable">$DAY</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>3ã€å¯¹ vger.rutgers.edu çš„ cvs æ ‘è¿›è¡Œé•œåƒ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /var/www/cvs/vger/</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/usr/freeware/bin:/usr/bin:/bin</span><br><span class="line"></span><br><span class="line">RUN=`lps x | grep rsync | grep -v grep | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$RUN</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> already running</span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">rsync -az vger.rutgers.edu::cvs/CVSROOT/ChangeLog <span class="variable">$HOME</span>/ChangeLog</span><br><span class="line"></span><br><span class="line">sum1=`sum <span class="variable">$HOME</span>/ChangeLog`</span><br><span class="line">sum2=`sum /var/www/cvs/vger/CVSROOT/ChangeLog`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$sum1</span>"</span> = <span class="string">"<span class="variable">$sum2</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> nothing to <span class="keyword">do</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">rsync -az --delete --force vger.rutgers.edu::cvs/ /var/www/cvs/vger/</span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>Qï¼šå¦‚ä½•é€šè¿‡ ssh è¿›è¡Œ rsyncï¼Œè€Œä¸”æ— é¡»è¾“å…¥å¯†ç ï¼Ÿ</p><p>Aï¼šå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p><pre><code>* é€šè¿‡ ssh-keygen åœ¨ server A ä¸Šå»ºç«‹ SSH keysï¼Œä¸è¦æŒ‡å®šå¯†ç ï¼Œä½ ä¼šåœ¨~/.ssh ä¸‹çœ‹åˆ° identity å’Œ identity.pub æ–‡ä»¶* åœ¨ server B ä¸Šçš„ home ç›®å½•å»ºç«‹å­ç›®å½•. ssh* å°† A çš„ identity.pub æ‹·è´åˆ° server B ä¸Š* å°† identity.pub åŠ åˆ°`~[user b]/.ssh/authorized_keys`* äºæ˜¯ server A ä¸Šçš„ A ç”¨æˆ·ï¼Œå¯é€šè¿‡ä¸‹é¢å‘½ä»¤ä»¥ç”¨æˆ· B ssh åˆ° server B ä¸Šäº† e.g.`ssh -l userB serverB`* è¿™æ ·å°±ä½¿ server A ä¸Šçš„ç”¨æˆ· A å°±å¯ä»¥ ssh ä»¥ç”¨æˆ· B çš„èº«ä»½æ— éœ€å¯†ç ç™»é™†åˆ° server B ä¸Šäº†ã€‚</code></pre><p>Qï¼šå¦‚ä½•é€šè¿‡åœ¨ä¸å±å®³å®‰å…¨çš„æƒ…å†µä¸‹é€šè¿‡é˜²ç«å¢™ä½¿ç”¨ rsync?</p><p>Aï¼šè§£ç­”å¦‚ä¸‹ï¼š</p><p>è¿™é€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æœåŠ¡å™¨åœ¨é˜²ç«å¢™å†…ï¼Œä¸€ç§æ˜¯æœåŠ¡å™¨åœ¨é˜²ç«å¢™å¤–ã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œé€šå¸¸è¿˜æ˜¯ä½¿ç”¨ sshï¼Œè¿™æ—¶æœ€å¥½æ–°å»ºä¸€ä¸ªå¤‡ä»½ç”¨æˆ·ï¼Œå¹¶ä¸”é…ç½® sshd ä»…å…è®¸è¿™ä¸ªç”¨æˆ·é€šè¿‡ RSA è®¤è¯æ–¹å¼è¿›å…¥ã€‚å¦‚æœæœåŠ¡å™¨åœ¨é˜²ç«å¢™å†…ï¼Œåˆ™æœ€å¥½é™å®šå®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œæ‹’ç»å…¶å®ƒæ‰€æœ‰è¿æ¥ã€‚å¦‚æœå®¢æˆ·æœºåœ¨é˜²ç«å¢™å†…ï¼Œåˆ™å¯ä»¥ç®€ å•å…è®¸é˜²ç«å¢™æ‰“å¼€ TCP ç«¯å£ 22 çš„ ssh å¤–å‘è¿æ¥å°± ok äº†ã€‚</p><p>Qï¼šæˆ‘èƒ½å°†æ›´æ”¹è¿‡æˆ–è€…åˆ é™¤çš„æ–‡ä»¶ä¹Ÿå¤‡ä»½ä¸Šæ¥å—ï¼Ÿ</p><p>Aï¼šå½“ç„¶å¯ä»¥ï¼š</p><p>ä½ å¯ä»¥ä½¿ç”¨å¦‚ï¼š<code>rsync -other -options -backupdir = ./backup-2000-2-13 ...</code>è¿™æ ·çš„å‘½ä»¤æ¥å®ç°ã€‚<br>è¿™æ ·å¦‚æœæºæ–‡ä»¶:/path/to/some/file.c æ”¹å˜äº†ï¼Œé‚£ä¹ˆæ—§çš„æ–‡ä»¶å°±ä¼šè¢«ç§»åˆ°./backup-2000-2-13/path/to/some/file.cï¼Œ<br>è¿™é‡Œè¿™ä¸ªç›®å½•éœ€è¦è‡ªå·±æ‰‹å·¥å»ºç«‹èµ·æ¥</p><p>Qï¼šæˆ‘éœ€è¦åœ¨é˜²ç«å¢™ä¸Šå¼€æ”¾å“ªäº›ç«¯å£ä»¥é€‚åº” rsyncï¼Ÿ</p><p>Aï¼šè§†æƒ…å†µè€Œå®š</p><p>rsync å¯ä»¥ç›´æ¥é€šè¿‡ 873 ç«¯å£çš„ tcp è¿æ¥ä¼ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ 22 ç«¯å£çš„ ssh æ¥è¿›è¡Œæ–‡ä»¶ä¼ é€’ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æ”¹å˜å®ƒçš„ç«¯å£ï¼š<br><code>rsync --port 8730 otherhost::</code><br>æˆ–è€…<br><code>rsync -e 'ssh -p 2002' otherhost:</code></p><p>Qï¼šæˆ‘å¦‚ä½•é€šè¿‡ rsync åªå¤åˆ¶ç›®å½•ç»“æ„ï¼Œå¿½ç•¥æ‰æ–‡ä»¶å‘¢ï¼Ÿ</p><p>Aï¼š<code>rsync -av --include '*/' --exclude '*' source-dir dest-dir</code></p><p>Qï¼šä¸ºä»€ä¹ˆæˆ‘æ€»ä¼šå‡ºç° â€œRead-only file systemâ€ çš„é”™è¯¯å‘¢ï¼Ÿ</p><p>Aï¼šçœ‹çœ‹æ˜¯å¦å¿˜äº†è®¾ â€œread only = noâ€ äº†</p><p>Qï¼šä¸ºä»€ä¹ˆæˆ‘ä¼šå‡ºç°â€˜@ERROR: invalid gidâ€™çš„é”™è¯¯å‘¢ï¼Ÿ</p><p>Aï¼šrsync ä½¿ç”¨æ—¶é»˜è®¤æ˜¯ç”¨ uid=nobody;gid=nobody æ¥è¿è¡Œçš„ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿä¸å­˜åœ¨ nobody ç»„çš„è¯ï¼Œå°±ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ï¼Œå¯ä»¥è¯•è¯• gid = nogroup æˆ–è€…å…¶å®ƒ</p><p>Qï¼šç»‘å®šç«¯å£ 873 å¤±è´¥æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p><p>Aï¼šå¦‚æœä½ ä¸æ˜¯ä»¥ root æƒé™è¿è¡Œè¿™ä¸€å®ˆæŠ¤è¿›ç¨‹çš„è¯ï¼Œå› ä¸º 1024 ç«¯å£ä»¥ä¸‹æ˜¯ç‰¹æƒç«¯å£ï¼Œä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ã€‚ä½ å¯ä»¥ç”¨â€“port å‚æ•°æ¥æ”¹å˜ã€‚</p><p>Qï¼šä¸ºä»€ä¹ˆæˆ‘è®¤è¯å¤±è´¥ï¼Ÿ</p><p>Aï¼šä»ä½ çš„å‘½ä»¤è¡Œçœ‹æ¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -a 144.16.251.213::<span class="built_in">test</span> <span class="built_in">test</span></span><br><span class="line">Password:</span><br><span class="line">@ERROR: auth failed on module <span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>åº”è¯¥æ˜¯æ²¡æœ‰ä»¥ä½ çš„ç”¨æˆ·åç™»é™†å¯¼è‡´çš„é—®é¢˜ï¼Œè¯•è¯•<code>rsync -a max@144.16.251.213::test test</code></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»€ä¹ˆæ˜¯-Rsync&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯-Rsync&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ Rsync&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ Rsync&lt;/h2&gt;&lt;p&gt;Rsyncï¼ˆremote synchronizeï¼‰æ˜¯ä¸€ä¸ªè¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯é€šè¿‡ L
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Modules åˆè¯• -- Go åŒ…ç®¡ç†è§£å†³ä¹‹é“</title>
    <link href="https://jiemin.wang/2019/03/29/goModules/"/>
    <id>https://jiemin.wang/2019/03/29/goModules/</id>
    <published>2019-03-29T03:16:13.000Z</published>
    <updated>2019-03-29T04:41:58.770Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Go çš„åŒ…ç®¡ç†æ˜¯ä¸€ç›´æ˜¯ä¸ºäººè¯Ÿç—…ä¹‹å¤„ï¼Œä» Go 1.5 å¼•å…¥çš„ vendor æœºåˆ¶ï¼Œåˆ°å‡†å®˜æ–¹å·¥å…· depï¼Œç›®å‰ä¸ºæ­¢è¿˜æ²¡ä¸€ä¸ªç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆ</p><p>ä¸è¿‡ç°åœ¨ go modules éšç€ golang1.11 çš„å‘å¸ƒè€Œå’Œæˆ‘ä»¬è§é¢äº†ï¼Œè¿™æ˜¯å®˜æ–¹æå€¡çš„æ–°çš„åŒ…ç®¡ç†ï¼Œä¹ƒè‡³é¡¹ç›®ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥ä¸å†éœ€è¦ GOPATH çš„å­˜åœ¨ã€‚<br><img src="/2019/03/29/goModules/go-module.jpg" title="go-module"></p><p>æ¬£å–œä¹‹ä½™ï¼Œèµ¶ç´§ä¸Šæ‰‹æ¥è¯•ä¸€ä¸‹å§~</p><p><strong>Go modules çš„å‰ä¸–ä»Šç”Ÿ</strong></p><p>è¯´èµ· Go çš„åŒ…ä¾èµ–ç®¡ç†ï¼Œä½œä¸º Google è„‘æ®‹ç²‰çš„æˆ‘ä¹Ÿæ˜¯è¿è¿å¹æ°”ã€‚ã€‚ã€‚</p><p>å¦‚æœè¯´ Java(Maven) æ˜¯å¨ shit çš„è¯ï¼Œé‚£ Go çœŸæ˜¯è¿ Java éƒ½ä¸å¦‚ã€‚</p><p>è‡ª 2007 å¹´ â€œä¸‰å·¨å¤´â€ï¼ˆ<a href="https://github.com/griesemer" target="_blank" rel="noopener">Robert Griesemer</a>, <a href="https://en.wikipedia.org/wiki/Rob_Pike" target="_blank" rel="noopener">Rob Pike</a>, <a href="https://en.wikipedia.org/wiki/Ken_Thompson" target="_blank" rel="noopener">Ken Thompson</a>ï¼‰æå‡ºè®¾è®¡å’Œå®ç° <a href="https://golang.org/" target="_blank" rel="noopener">Go è¯­è¨€</a>ä»¥æ¥ï¼Œè¿™é—¨è¯­è¨€å·²ç»å‘å±•å’Œæ¼”åŒ–äº†åä½™å¹´äº†ã€‚</p><p>ä½†æ˜¯è‡ªä» Go è¯­è¨€è¯ç”Ÿä»¥æ¥å§ï¼Œå¤§ä½¬ä»¬å°±è®¤ä¸º<code>go get</code> å·²ç»æŒºå¥½äº†ï¼Œæ²¡å¿…è¦å†é¢å¤–é€ ä¸€ä¸ªè½®å­äº†â€”â€”åŒ…ç®¡ç†å™¨ã€‚</p><p>ä¹Ÿè®¸æ˜¯å¤§ä½¬ä»¬éƒ½ä¸éœ€è¦å›¢é˜Ÿå¼€å‘å§ï¼Œä½†æ˜¯å¤§ä½¬æ¯•ç«Ÿæ˜¯å°‘æ•°ï¼Œäºæ˜¯ï¼Œå„ç§å„æ ·çš„ç¤¾åŒºè§£å†³æ–¹æ¡ˆå°±å‡ºç°äº†ï¼Œå¯è°“æ˜¯ç™¾å®¶äº‰é¸£ã€‚</p><ul><li><a href="https://github.com/golang/dep" target="_blank" rel="noopener">dep</a></li><li><a href="https://github.com/kovetskiy/manul" target="_blank" rel="noopener">manul</a> - Vendor packages using git submodules.</li><li><a href="https://github.com/tools/godep" target="_blank" rel="noopener">Godep</a></li><li><a href="https://github.com/kardianos/govendor" target="_blank" rel="noopener">Govendor</a></li><li><a href="https://github.com/hectorj/godm" target="_blank" rel="noopener">godm</a></li><li><a href="https://github.com/govend/govend" target="_blank" rel="noopener">govend</a> - Manage dependencies like <code>go get</code> but for <code>/vendor</code>.</li><li><a href="https://github.com/Masterminds/glide" target="_blank" rel="noopener">Glide</a> - Manage packages like composer, npm, bundler, or other languages.</li></ul><p>å½“åˆçœ‹åˆ°è¿™ä¸ªåˆ—è¡¨çš„æ—¶å€™ï¼Œæˆ‘ä¸ç¦æ„Ÿæ…¨ï¼šâ€œè¿™ä¹ˆå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œå¯çœŸæ˜¯æŒ‘èŠ±äº†æœ•çš„çœ¼ç›å‘€ã€‚â€</p><p>Go å®˜æ–¹è¯´ï¼šâ€œè«æ€¥ï¼Œè¿™ä»½<a href="https://github.com/golang/go/wiki/PackageManagementTools" target="_blank" rel="noopener">å®˜æ–¹å¯¹æ¯”</a>æ‹¿å¥½ä¸è°¢ã€‚â€</p><p>Go åœ¨æ„å»ºè®¾è®¡æ–¹é¢æ·±å— Google å†…éƒ¨å¼€å‘å®è·µçš„å½±å“ï¼Œæ¯”å¦‚ go get çš„è®¾è®¡å°±æ·±å— <a href="https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/pdf" target="_blank" rel="noopener">Google å†…éƒ¨å•ä¸€ä»£ç ä»“åº“ (single monorepo) å’ŒåŸºäºä¸»å¹² (trunk/mainline based) çš„å¼€å‘æ¨¡å‹</a>çš„å½±å“ï¼šåªè·å– Trunk/mainline ä»£ç å’Œç‰ˆæœ¬æ— æ„ŸçŸ¥ã€‚<br><img src="/2019/03/29/goModules/google-trunk-based-and-release-branch-dev-model.png" title="google-trunk-based-and-release-branch-dev-model"></p><blockquote><p>Google å†…éƒ¨åŸºäºä¸»å¹²çš„å¼€å‘æ¨¡å‹ï¼š</p><ul><li>æ‰€æœ‰å¼€å‘äººå‘˜åŸºäºä¸»å¹² trunk/mainline å¼€å‘ï¼šæäº¤åˆ° trunk æˆ–ä» trunk è·å–æœ€æ–°çš„ä»£ç ï¼ˆåŒæ­¥åˆ°æœ¬åœ° workspaceï¼‰</li><li>ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œå»ºç«‹ Release branchï¼Œrelease branch å®è´¨ä¸Šå°±æ˜¯æŸä¸€ä¸ªæ—¶åˆ»ä¸»å¹²ä»£ç çš„å¿«ç…§</li><li>å¿…é¡»åŒæ­¥åˆ° release branch ä¸Šçš„ bug fix å’Œå¢å¼ºæ”¹è¿›ä»£ç ä¹Ÿé€šå¸¸æ˜¯å…ˆåœ¨ trunk ä¸Šæäº¤ (commit)ï¼Œç„¶åå† cherry-pick åˆ° release branch ä¸Š</li></ul></blockquote><p>æˆ‘ä»¬çŸ¥é“ go get è·å–çš„ä»£ç ä¼šæ”¾åœ¨ $GOPATH/src ä¸‹é¢ï¼Œè€Œ go build ä¼šåœ¨ $GOROOT/src å’Œ \$GOPATH/src ä¸‹é¢æŒ‰ç…§ import path å»æœç´¢ packageï¼Œç”±äº go get è·å–çš„éƒ½æ˜¯å„ä¸ª package repo çš„ trunk/mainline çš„ä»£ç ï¼Œå› æ­¤ï¼ŒGo 1.5 ä¹‹å‰çš„ Go compiler éƒ½æ˜¯åŸºäºç›®æ ‡ Go ç¨‹åºä¾èµ–åŒ…çš„ trunk/mainline ä»£ç å»ç¼–è¯‘çš„ã€‚è¿™æ ·çš„æœºåˆ¶å¸¦æ¥çš„é—®é¢˜æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œè‡³å°‘åŒ…æ‹¬ï¼š</p><ul><li>å› ä¾èµ–åŒ…çš„ trunk çš„å˜åŒ–ï¼Œå¯¼è‡´ä¸åŒäººè·å–å’Œç¼–è¯‘ä½ çš„åŒ… / ç¨‹åºæ—¶å¾—åˆ°çš„ç»“æœå®è´¨æ˜¯ä¸åŒçš„ï¼Œå³ä¸èƒ½å®ç° reproduceable build</li><li>å› ä¾èµ–åŒ…çš„ trunk çš„å˜åŒ–ï¼Œå¼•å…¥ä¸å…¼å®¹çš„å®ç°ï¼Œå¯¼è‡´ä½ çš„åŒ… / ç¨‹åºæ— æ³•é€šè¿‡ç¼–è¯‘</li><li>å› ä¾èµ–åŒ…æ¼”è¿›è€Œæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œå¯¼è‡´ä½ çš„åŒ… / ç¨‹åºæ— æ³•é€šè¿‡ç¼–è¯‘</li></ul><p>ä¸ºäº†å®ç° reporduceable buildï¼ŒGo 1.5 å¼•å…¥äº† Vendor æœºåˆ¶ï¼ŒGo ç¼–è¯‘å™¨ä¼šä¼˜å…ˆåœ¨ vendor ä¸‹æœç´¢ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…ï¼Œè¿™æ ·å¦‚æœå¼€å‘è€…å°†ç‰¹å®šç‰ˆæœ¬çš„ä¾èµ–åŒ…å­˜æ”¾åœ¨ vendor ä¸‹é¢å¹¶æäº¤åˆ° code repoï¼Œé‚£ä¹ˆæ‰€æœ‰äººç†è®ºä¸Šéƒ½ä¼šå¾—åˆ°åŒæ ·çš„ç¼–è¯‘ç»“æœï¼Œä»è€Œå®ç° reporduceable buildã€‚</p><p>åœ¨ Go 1.5 å‘å¸ƒåçš„è‹¥å¹²å¹´ï¼Œgopher ä»¬æŠŠæ³¨æ„åŠ›éƒ½é›†ä¸­åœ¨å¦‚ä½•åˆ©ç”¨ vendor è§£å†³åŒ…ä¾èµ–é—®é¢˜ï¼Œä»æ‰‹å·¥æ·»åŠ ä¾èµ–åˆ° vendorã€æ‰‹å·¥æ›´æ–°ä¾èµ–ï¼Œåˆ°ä¸€ä¼—åŒ…ä¾èµ–ç®¡ç†å·¥å…·çš„è¯ç”Ÿï¼Œæ¯”å¦‚ï¼š<a href="https://github.com/kardianos/govendor" target="_blank" rel="noopener">Govendor</a>ã€<a href="https://github.com/Masterminds/glide" target="_blank" rel="noopener">glide</a> ä»¥åŠå·ç§°å‡†å®˜æ–¹å·¥å…·çš„ <a href="https://github.com/golang/dep" target="_blank" rel="noopener">dep</a>ï¼ŒåŠªåŠ›åœ°å°è¯•ç€æŒ‰ç…§å½“ä»Šä¸»æµæ€è·¯è§£å†³ç€è¯¸å¦‚ â€œé’»çŸ³å‹ä¾èµ–â€ ç­‰éš¾é¢˜ã€‚</p><p>æ­£å½“ gopher è®¤ä¸º dep å°† â€œé¡ºç†æˆç« â€ åœ°å‡çº§ä¸º go toolchain ä¸€éƒ¨åˆ†çš„æ—¶å€™ï¼Œä»Šå¹´å¹´åˆï¼ŒGo æ ¸å¿ƒ Team çš„æŠ€æœ¯ leaderï¼Œä¹Ÿæ˜¯ Go Team æœ€æ—©æœŸæˆå‘˜ä¹‹ä¸€çš„ <a href="https://research.swtch.com/" target="_blank" rel="noopener">Russ Cox</a> åœ¨<a href="https://research.swtch.com/" target="_blank" rel="noopener">ä¸ªäººåšå®¢</a>ä¸Šè¿ç»­å‘è¡¨äº†<a href="https://research.swtch.com/vgo" target="_blank" rel="noopener">ä¸ƒç¯‡æ–‡ç« </a>ï¼Œç³»ç»Ÿé˜è¿°äº† Go team è§£å†³â€ åŒ…ä¾èµ–ç®¡ç†â€ çš„æŠ€æœ¯æ–¹æ¡ˆ: <a href="https://github.com/golang/vgo" target="_blank" rel="noopener">vgo</a> â€”â€” modules çš„å‰èº«ã€‚</p><p>vgo çš„ä¸»è¦æ€è·¯åŒ…æ‹¬ï¼š<a href="https://research.swtch.com/vgo-import" target="_blank" rel="noopener">Semantic Import Versioning</a>ã€<a href="https://research.swtch.com/vgo-mvs" target="_blank" rel="noopener">Minimal Version Selection</a>ã€<a href="https://research.swtch.com/vgo-module" target="_blank" rel="noopener">å¼•å…¥ Go module</a> ç­‰ã€‚è¿™ä¸ƒç¯‡æ–‡ç« çš„å‘å¸ƒå¼•å‘äº† Go ç¤¾åŒºæ¿€çƒˆåœ°äº‰è®ºï¼Œå°¤å…¶æ˜¯ MVS(æœ€å°ç‰ˆæœ¬é€‰æ‹©) ä¸ç›®å‰ä¸»æµçš„ä¾èµ–ç‰ˆæœ¬é€‰æ‹©æ–¹æ³•çš„ç›¸æ‚–è®©å¾ˆå¤šä¼ ç»Ÿ Go åŒ…ç®¡ç†å·¥å…·çš„ç»´æŠ¤è€…â€ ä¸æ»¡â€ï¼Œå°¤å…¶æ˜¯â€ å‡†å®˜æ–¹å·¥å…·â€ï¼šdepã€‚vgo æ–¹æ¡ˆçš„æå‡ºä¹Ÿæ„å‘³ç€ dep é¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸå³å°†è¿›å…¥å°¾å£°ã€‚</p><p>5 æœˆä»½ï¼ŒRuss Cox çš„ <a href="https://github.com/golang/go/issues/24301" target="_blank" rel="noopener">Proposal â€œcmd/go: add package version support to Go toolchainâ€ </a>è¢« acceptedï¼Œè¿™å‘¨äº”æ—©äº›æ—¶å€™ Russ Cox <a href="https://github.com/golang/go/commit/f7248f05946c1804b5519d0b3eb0db054dc9c5d6" target="_blank" rel="noopener">å°† vgo çš„ä»£ç  merge åˆ° Go ä¸»å¹²</a>ï¼Œå¹¶å°†è¿™å¥—æœºåˆ¶æ­£å¼å‘½åä¸ºâ€go modulesâ€ã€‚ç”±äº vgo é¡¹ç›®æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®éªŒåŸå‹ï¼Œmerge åˆ°ä¸»å¹²åï¼Œvgo è¿™ä¸ªæœ¯è¯­ä»¥åŠ vgo é¡¹ç›®çš„ä½¿å‘½ä¹Ÿå°±å°±æ­¤ç»“æŸäº†ã€‚åç»­ Go modules æœºåˆ¶å°†ç›´æ¥åœ¨ Go ä¸»å¹²ä¸Šç»§ç»­æ¼”åŒ–ã€‚</p><p>Go modules æ˜¯ Go team åœ¨è§£å†³åŒ…ä¾èµ–ç®¡ç†æ–¹é¢çš„ä¸€æ¬¡å‹‡æ•¢å°è¯•ï¼Œæ— è®ºå¦‚ä½•ï¼Œå¯¹ Go è¯­è¨€æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªå¥½äº‹ã€‚</p><h2 id="Go-modules-ä¸Šæ‰‹"><a href="#Go-modules-ä¸Šæ‰‹" class="headerlink" title="Go modules ä¸Šæ‰‹"></a>Go modules ä¸Šæ‰‹</h2><p>è¿™é‡Œå°±ç”¨ Gin æ¡†æ¶æ¥å®ç°ä¸¤ä¸ª RESTful API ä½œç¤ºä¾‹å§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œä¸¤ä¸ª handler åˆ†åˆ«å±äº <code>main</code> å’Œ <code>pkg/api/data</code> è¿™ä¸¤ä¸ª package<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mytest</span><br><span class="line">â”œâ”€â”€ main.<span class="keyword">go</span></span><br><span class="line">â””â”€â”€ pkg</span><br><span class="line">    â””â”€â”€ api</span><br><span class="line">        â””â”€â”€ data</span><br><span class="line">            â””â”€â”€ api.<span class="keyword">go</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿›å…¥ myproj ç›®å½•ï¼Œç„¶åä½¿ç”¨ <code>go mod</code> å»ºç«‹ modules<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> mod init github.com/wangjiemin/mytest</span><br><span class="line"><span class="keyword">go</span>: creating <span class="built_in">new</span> <span class="keyword">go</span>.mod: module github.com/wangjiemin/mytest</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ­¤æ—¶ä¼šè‡ªåŠ¨äº§ç”Ÿä¸€ä¸ª go.mod æ–‡ä»¶ï¼Œæ‰“å¼€çœ‹åˆ°é‡Œè¾¹å†…å®¹åªæœ‰ä¸€è¡Œ<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module github.com/wangjiemin/mytest</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç°åœ¨å¼€å§‹å†™æˆ‘ä»¬çš„ä¸¤ä¸ª handler<br>1.pkg/api/data/api.go<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetDataAPIHealthHandler GET /health-dataapi to expose heathy check result of data API</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDataAPIHealthHandler</span><span class="params">(c *gin.Context)</span></span> {</span><br><span class="line">    <span class="comment">// do something to check heathy of data API</span></span><br><span class="line">    c.JSON(http.StatusOK, gin.H{</span><br><span class="line">        <span class="string">"code"</span>:    <span class="number">0</span>,</span><br><span class="line">        <span class="string">"message"</span>: <span class="string">"Data API is alive"</span>,</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>2.main.go<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    dataapi <span class="string">"github.com/wangjiemin/mytest/pkg/api/data"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    router.GET(<span class="string">"/health"</span>, GetHealthHandler)</span><br><span class="line">    router.GET(<span class="string">"/health-dataapi"</span>, dataapi.GetDataAPIHealthHandler)</span><br><span class="line"></span><br><span class="line">    s := &http.Server{</span><br><span class="line">        Addr:    <span class="string">":8000"</span>,</span><br><span class="line">        Handler: router,</span><br><span class="line">    }</span><br><span class="line">    s.ListenAndServe()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetHealthHandler - GET /health to expose service health</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHealthHandler</span><span class="params">(c *gin.Context)</span></span> {</span><br><span class="line">    c.JSON(http.StatusOK, gin.H{</span><br><span class="line">        <span class="string">"code"</span>:    <span class="number">0</span>,</span><br><span class="line">        <span class="string">"message"</span>: <span class="string">"Service is alive!"</span>,</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç„¶åç”¨æˆ‘ä»¬çš„è€æœ‹å‹ <code>go build</code> åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> build -o bin/main main.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">go</span>: finding github.com/gin-gonic/gin v1<span class="number">.3</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">go</span>: downloading github.com/gin-gonic/gin v1<span class="number">.3</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">go</span>: finding github.com/gin-contrib/sse latest</span><br><span class="line"><span class="keyword">go</span>: finding github.com/ugorji/<span class="keyword">go</span>/codec latest</span><br><span class="line"><span class="keyword">go</span>: finding github.com/golang/protobuf/proto latest</span><br><span class="line"><span class="keyword">go</span>: finding github.com/mattn/<span class="keyword">go</span>-isatty v0<span class="number">.0</span><span class="number">.4</span></span><br><span class="line"><span class="keyword">go</span>: finding gopkg.in/yaml.v2 v2<span class="number">.2</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">go</span>: finding gopkg.in/<span class="keyword">go</span>-playground/validator.v8 v8<span class="number">.18</span><span class="number">.2</span></span><br><span class="line"><span class="keyword">go</span>: downloading github.com/gin-contrib/sse v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20170109093832</span><span class="number">-22d</span>885f9ecc7</span><br><span class="line"><span class="keyword">go</span>: downloading github.com/mattn/<span class="keyword">go</span>-isatty v0<span class="number">.0</span><span class="number">.4</span></span><br><span class="line"><span class="keyword">go</span>: downloading github.com/ugorji/<span class="keyword">go</span>/codec v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20181022190402</span>-e5e69e061d4f</span><br><span class="line"><span class="keyword">go</span>: finding github.com/golang/protobuf v1<span class="number">.2</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">go</span>: downloading gopkg.in/yaml.v2 v2<span class="number">.2</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">go</span>: downloading gopkg.in/<span class="keyword">go</span>-playground/validator.v8 v8<span class="number">.18</span><span class="number">.2</span></span><br><span class="line"><span class="keyword">go</span>: downloading github.com/golang/protobuf v1<span class="number">.2</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">go</span>: finding gopkg.in/check.v1 v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20161208181325</span><span class="number">-20d</span>25e280405</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯ä»¥çœ‹åˆ° go compiler ä¸»åŠ¨ä¸‹è½½äº†ç›¸å…³ packageã€‚</p><p>é‚£ä¹ˆè¿™äº› package è¢«ä¸‹è½½åˆ°äº†å“ªé‡Œå‘¢ï¼Œä½ æ‰“å¼€ $GOPATH/pkg/mod å°±å¯ä»¥çœ‹åˆ°äº†ï¼Œå¦å¤– modules æ˜¯å…è®¸åŒ package å¤šç§ç‰ˆæœ¬å¹¶å­˜çš„ã€‚<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~/<span class="keyword">go</span>/pkg/mod</span><br><span class="line">â”œâ”€â”€ cache</span><br><span class="line">â”‚   â”œâ”€â”€ download</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ github.com</span><br><span class="line">â”‚   â”‚   â””â”€â”€ gopkg.in</span><br><span class="line">â”‚   â””â”€â”€ vcs</span><br><span class="line">â”‚       â”œâ”€â”€ <span class="number">37981</span>a5904034a62f98c21341f5422b08cc21ccf1bea734e2aafc91119af6c9b</span><br><span class="line">â”‚       â”œâ”€â”€ <span class="number">37981</span>a5904034a62f98c21341f5422b08cc21ccf1bea734e2aafc91119af6c9b.info</span><br><span class="line">â”‚       â”œâ”€â”€ <span class="number">3</span>cef6ea433a84771f272e076cd77b94bd94828b89b4ccd04fa8622bf2d5d3a3f</span><br><span class="line">â”‚       â”œâ”€â”€ <span class="number">3</span>cef6ea433a84771f272e076cd77b94bd94828b89b4ccd04fa8622bf2d5d3a3f.info</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œ <code>go build</code> å go.mod æ–‡ä»¶çš„å†…å®¹ï¼š<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module github.com/wangjiemin/mytest</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">  github.com/gin-contrib/sse v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20170109093832</span><span class="number">-22d</span>885f9ecc7 <span class="comment">// indirect</span></span><br><span class="line">  github.com/gin-gonic/gin v1<span class="number">.3</span><span class="number">.0</span></span><br><span class="line">  github.com/golang/protobuf v1<span class="number">.2</span><span class="number">.0</span> <span class="comment">// indirect</span></span><br><span class="line">  github.com/mattn/<span class="keyword">go</span>-isatty v0<span class="number">.0</span><span class="number">.4</span> <span class="comment">// indirect</span></span><br><span class="line">  github.com/ugorji/<span class="keyword">go</span>/codec v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20181022190402</span>-e5e69e061d4f <span class="comment">// indirect</span></span><br><span class="line">  gopkg.in/<span class="keyword">go</span>-playground/validator.v8 v8<span class="number">.18</span><span class="number">.2</span> <span class="comment">// indirect</span></span><br><span class="line">  gopkg.in/yaml.v2 v2<span class="number">.2</span><span class="number">.1</span> <span class="comment">// indirect</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬çœ‹åˆ° go modules åˆ†æå‡ºäº† mytest çš„ä¾èµ–ï¼Œå¹¶å°†å…¶æ”¾å…¥ go.mod çš„ require åŒºåŸŸã€‚</p><blockquote><p>go modules æ‹‰å– package çš„åŸåˆ™æ˜¯å…ˆæ‹‰å–æœ€æ–°çš„ release tagï¼Œè‹¥æ—  tag åˆ™æ‹‰æœ€æ–° commit å¹¶ä»¥ Pseudo-versions çš„å½¢å¼è®°å½•ã€‚<br>å› ä¸ºæˆ‘ä»¬çš„ module åªç›´æ¥ä¾èµ–äº† ginï¼Œå…¶ä»–çš„éƒ½æ˜¯éç›´æ¥ä¾èµ–çš„ï¼Œæ‰€ä»¥å®ƒä»¬åè¾¹éƒ½è¢«ä»¥æ³¨é‡Šå½¢å¼æ ‡è®°äº† indirectï¼Œå³ä¼ é€’ä¾èµ–ã€‚<br>go.mod æ–‡ä»¶ä¸€æ—¦åˆ›å»ºåï¼Œå®ƒçš„å†…å®¹å°†ä¼šè¢« go toolchain å…¨é¢æŒæ§ã€‚go toolchain ä¼šåœ¨å„ç±»å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ¯”å¦‚ go getã€go buildã€go mod ç­‰ä¿®æ”¹å’Œç»´æŠ¤ go.mod æ–‡ä»¶ã€‚</p></blockquote><p>åŒæ—¶å‘ç°ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ªæ–‡ä»¶ go.sum<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">github.com/gin-contrib/sse v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20170109093832</span><span class="number">-22d</span>885f9ecc7 h1:AzN37oI0cOS+cougNAV9szl6CVoj2RYwzS3DpUQNtlY=</span><br><span class="line">github.com/gin-contrib/sse v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20170109093832</span><span class="number">-22d</span>885f9ecc7/<span class="keyword">go</span>.mod h1:VJ0WA2NBN22VlZ2dKZQPAPnyWw5XTlK1KymzLKsr59s=</span><br><span class="line">github.com/gin-gonic/gin v1<span class="number">.3</span><span class="number">.0</span> h1:kCmZyPklC0gVdL728E6Aj20uYBJV93nj/TkwBTKhFbs=</span><br><span class="line">github.com/gin-gonic/gin v1<span class="number">.3</span><span class="number">.0</span>/<span class="keyword">go</span>.mod h1:<span class="number">7</span>cKuhb5qV2ggCFctp2fJQ+ErvciLZrIeoOSOm6mUr7Y=</span><br><span class="line">github.com/golang/protobuf v1<span class="number">.2</span><span class="number">.0</span> h1:P3YflyNX/ehuJFLhxviNdFxQPkGK5cDcApsge1SqnvM=</span><br><span class="line">github.com/golang/protobuf v1<span class="number">.2</span><span class="number">.0</span>/<span class="keyword">go</span>.mod h1:<span class="number">6l</span>Qm79b+lXiMfvg/cZm0SGofjICqVBUtrP5yJMmIC1U=</span><br><span class="line">github.com/mattn/<span class="keyword">go</span>-isatty v0<span class="number">.0</span><span class="number">.4</span> h1:bnP0vzxcAdeI1zdubAl5PjU6zsERjGZb7raWodagDYs=</span><br><span class="line">github.com/mattn/<span class="keyword">go</span>-isatty v0<span class="number">.0</span><span class="number">.4</span>/<span class="keyword">go</span>.mod h1:M+lRXTBqGeGNdLjl/ufCoiOlB5xdOkqRJdNxMWT7Zi4=</span><br><span class="line">github.com/ugorji/<span class="keyword">go</span>/codec v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20181022190402</span>-e5e69e061d4f h1:y3Vj7GoDdcBkxFa2RUUFKM25TrBbWVDnjRDI0u975zQ=</span><br><span class="line">github.com/ugorji/<span class="keyword">go</span>/codec v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20181022190402</span>-e5e69e061d4f/<span class="keyword">go</span>.mod h1:VFNgLljTbGfSG7qAOspJ7OScBnGdDN/yBr0sguwnwf0=</span><br><span class="line">gopkg.in/check.v1 v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20161208181325</span><span class="number">-20d</span>25e280405/<span class="keyword">go</span>.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=</span><br><span class="line">gopkg.in/<span class="keyword">go</span>-playground/validator.v8 v8<span class="number">.18</span><span class="number">.2</span> h1:lFB4DoMU6B626w8ny76MV7VX6W2VHct2GVOI3xgiMrQ=</span><br><span class="line">gopkg.in/<span class="keyword">go</span>-playground/validator.v8 v8<span class="number">.18</span><span class="number">.2</span>/<span class="keyword">go</span>.mod h1:RX2a/<span class="number">7</span>Ha8BgOhfk7j780h4/u/RRjR0eouCJSH80/M2Y=</span><br><span class="line">gopkg.in/yaml.v2 v2<span class="number">.2</span><span class="number">.1</span> h1:mUhvW9EsL+naU5Q3cakzfE91YhliOondGd6ZrsDBHQE=</span><br><span class="line">gopkg.in/yaml.v2 v2<span class="number">.2</span><span class="number">.1</span>/<span class="keyword">go</span>.mod h1:hI93XBmqTisBFMUTm0b8Fm+jr3Dg1NNxqwp+<span class="number">5</span>A1VGuI=</span><br></pre></td></tr></tbody></table></figure><p></p><p>å†™è¿‡ node çš„äººåº”è¯¥ä¼šå‘ç°ï¼Œ <code>go.mod/go.sum</code> çš„å…³ç³»è·Ÿ <code>package.json/package-lock.json</code> ç±»ä¼¼ï¼Œå‰è€…å®šä¹‰ dependency rootï¼Œåè€…å°†å…³ç³»å±•å¼€ã€‚</p><p>æœ€åæ‰§è¡Œ <code>bin/main</code> å¯ä»¥çœ‹åˆ° Gin å¾ˆè´´å¿ƒçš„åˆ—å‡ºäº† handler æ‰€å±çš„ package<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/main</span><br><span class="line">[GIN-debug] [WARNING] Now Gin requires Go <span class="number">1.6</span> or later and Go <span class="number">1.7</span> will be required soon.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Running in <span class="string">"debug"</span> mode. Switch to <span class="string">"release"</span> mode in production.</span><br><span class="line"> - using env: export GIN_MODE=release</span><br><span class="line"> - using code: gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] GET    /health                   --> main.GetHealthHandler (<span class="number">3</span> handlers)</span><br><span class="line">[GIN-debug] GET    /health-dataapi           --> github.com/wangjiemin/mytest/pkg/api/data.GetDataAPIHealthHandler (<span class="number">3</span> handlers)</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ°è¿™é‡Œï¼Œä¸€ä¸ª go modules å°±å®Œæˆäº†ã€‚</p><h4 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h4><p>Modules æ˜¯ä½œä¸º experiment feature åŠ å…¥åˆ°ä¸ä¹…å‰æ­£å¼å‘å¸ƒçš„ Go 1.11 ä¸­çš„ã€‚</p><p>æŒ‰ç…§ Go çš„æƒ¯ä¾‹ï¼Œåœ¨æ–°çš„ experiment feature é¦–æ¬¡åŠ å…¥æ—¶ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹æ€§å¼€å…³ï¼Œgo modules ä¹Ÿä¸ä¾‹å¤–ï¼Œ<code>GO111MODULE</code> è¿™ä¸ªä¸´æ—¶çš„ç¯å¢ƒå˜é‡å°±æ˜¯ go modules ç‰¹æ€§çš„ experiment å¼€å…³ã€‚</p><ul><li>off: go modules experiment feature å…³é—­ï¼Œgo compiler ä¼šå§‹ç»ˆä½¿ç”¨ GOPATH modeï¼Œå³æ— è®ºè¦æ„å»ºçš„æºç ç›®å½•æ˜¯å¦åœ¨ GOPATH è·¯å¾„ä¸‹ï¼Œgo compiler éƒ½ä¼šåœ¨ä¼ ç»Ÿçš„ GOPATH å’Œ vendor ç›®å½• (ä»…æ”¯æŒåœ¨ GOPATH ç›®å½•ä¸‹çš„ package) ä¸‹æœç´¢ç›®æ ‡ç¨‹åºä¾èµ–çš„ go packageï¼›</li><li>on: å§‹ç»ˆä½¿ç”¨ module-aware modeï¼Œåªæ ¹æ® go.mod ä¸‹è½½ dependency è€Œå®Œå…¨å¿½ç•¥ GOPATH ä»¥åŠ vendor ç›®å½•</li></ul><ul><li>auto: Golang 1.11 é¢„è®¾å€¼ï¼Œä½¿ç”¨ GOPATH mode è¿˜æ˜¯ module-aware modeï¼Œå–å†³äºè¦æ„å»ºçš„æºç ç›®å½•æ‰€åœ¨ä½ç½®ä»¥åŠæ˜¯å¦åŒ…å« go.mod æ–‡ä»¶ã€‚æ»¡è¶³ä»»ä¸€æ¡ä»¶æ—¶æ‰ä½¿ç”¨ module-aware mode:<ul><li>å½“å‰ç›®å½•ä½äº GOPATH/src ä¹‹å¤–å¹¶ä¸”åŒ…å« go.mod æ–‡ä»¶</li><li>å½“å‰ç›®å½•ä½äºåŒ…å« go.mod æ–‡ä»¶çš„ç›®å½•ä¸‹    </li></ul></li></ul><p><code>go mod</code> å‘½ä»¤<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">download    download modules to local cache (ä¸‹è½½ä¾èµ–çš„ modules åˆ°æœ¬åœ° cache)</span><br><span class="line">edit        edit <span class="keyword">go</span>.mod from tools or scripts (ç¼–è¾‘ <span class="keyword">go</span>.mod æ–‡ä»¶)</span><br><span class="line">graph       <span class="built_in">print</span> module requirement graph (æ‰“å°æ¨¡å—ä¾èµ–å›¾)</span><br><span class="line">init        initialize <span class="built_in">new</span> module in current directory (å†å½“å‰æ–‡ä»¶å¤¹ä¸‹åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ module, åˆ›å»º <span class="keyword">go</span>.mod æ–‡ä»¶)</span><br><span class="line">tidy        add missing and remove unused modules (å¢åŠ ä¸¢å¤±çš„ modulesï¼Œå»æ‰æœªç”¨çš„ modules)</span><br><span class="line">vendor      <span class="built_in">make</span> vendored <span class="built_in">copy</span> of dependencies (å°†ä¾èµ–å¤åˆ¶åˆ° vendor ä¸‹)</span><br><span class="line">verify      verify dependencies have expected content (æ ¡éªŒä¾èµ–)</span><br><span class="line">why         explain why packages or modules are needed (è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–)</span><br></pre></td></tr></tbody></table></figure><p></p><p>çœ‹è¿™äº›å‘½ä»¤çš„å¸®åŠ©å·²ç»æ¯”è¾ƒå®¹æ˜“äº†è§£å‘½ä»¤çš„åŠŸèƒ½ã€‚</p><h4 id="æ—¢æœ‰é¡¹ç›®"><a href="#æ—¢æœ‰é¡¹ç›®" class="headerlink" title="æ—¢æœ‰é¡¹ç›®"></a>æ—¢æœ‰é¡¹ç›®</h4><p>å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª go é¡¹ç›®ï¼Œ æ¯”å¦‚åœ¨<code>$GOPATH/github.com/wangjiemim/mytest</code>ä¸‹ï¼Œ ä½ å¯ä»¥ä½¿ç”¨<code>go mod init github.com/wangjiemim/mytest</code>åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„ go.mod (åªæœ‰ç¬¬ä¸€è¡Œ <code>module github.com/wangjiemim/mytest</code>)ã€‚</p><p>ç„¶åä½ å¯ä»¥é€šè¿‡ <code>go get ./...</code>è®©å®ƒæŸ¥æ‰¾ä¾èµ–ï¼Œå¹¶è®°å½•åœ¨ go.mod æ–‡ä»¶ä¸­ (ä½ è¿˜å¯ä»¥æŒ‡å®š <code>-tags</code>, è¿™æ ·å¯ä»¥æŠŠ tags çš„ä¾èµ–éƒ½æŸ¥æ‰¾åˆ°)ã€‚</p><p>é€šè¿‡<code>go mod tidy</code>ä¹Ÿå¯ä»¥ç”¨æ¥ä¸º go.mod å¢åŠ ä¸¢å¤±çš„ä¾èµ–ï¼Œåˆ é™¤ä¸éœ€è¦çš„ä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä¸ç¡®å®šå®ƒæ€ä¹ˆå¤„ç†<code>tags</code>ã€‚</p><p>æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä¼šæŠŠ go.mod çš„<code>latest</code>ç‰ˆæœ¬æ¢æˆå®é™…çš„æœ€æ–°çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆä¸€ä¸ªgo.sumè®°å½•æ¯ä¸ªä¾èµ–åº“çš„ç‰ˆæœ¬å’Œå“ˆå¸Œå€¼ã€‚</p><h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><p>åœ¨å›½å†…è®¿é—®<code>golang.org/x</code>çš„å„ä¸ªåŒ…éƒ½éœ€è¦æ¢¯å­ï¼Œä½ å¯ä»¥åœ¨ go.mod ä¸­ä½¿ç”¨<code>replace</code>æ›¿æ¢æˆ github ä¸Šå¯¹åº”çš„åº“ã€‚<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">replace (</span><br><span class="line">  golang.org/x/crypto v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20180820150726</span><span class="number">-614d</span>502a4dac => github.com/golang/crypto v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20180820150726</span><span class="number">-614d</span>502a4dac</span><br><span class="line">  golang.org/x/net v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20180821023952</span><span class="number">-922f</span>4815f713 => github.com/golang/net v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20180826012351</span><span class="number">-8</span>a410e7b638d</span><br><span class="line">  golang.org/x/text v0<span class="number">.3</span><span class="number">.0</span> => github.com/golang/text v0<span class="number">.3</span><span class="number">.0</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¾èµ–åº“ä¸­çš„<code>replac</code>eå¯¹ä½ çš„ä¸» go.mod ä¸èµ·ä½œç”¨ï¼Œæ¯”å¦‚<code>github.com/wangjiemin/mytest</code>çš„ go.mod å·²ç»å¢åŠ äº†<code>replace</code>, ä½†æ˜¯ä½ çš„ go.mod è™½ç„¶<code>require</code>äº†<code>rpcx</code>çš„åº“ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®<code>replace</code>çš„è¯ï¼Œ <code>go get</code>è¿˜æ˜¯ä¼šè®¿é—®<code>golang.org/x</code>ã€‚</p><p>æ‰€ä»¥å¦‚æœæƒ³ç¼–è¯‘é‚£ä¸ªé¡¹ç›®ï¼Œå°±åœ¨å“ªä¸ªé¡¹ç›®ä¸­å¢åŠ <code>replace</code>ã€‚</p><h4 id="åŒ…çš„ç‰ˆæœ¬æ§åˆ¶"><a href="#åŒ…çš„ç‰ˆæœ¬æ§åˆ¶" class="headerlink" title="åŒ…çš„ç‰ˆæœ¬æ§åˆ¶"></a>åŒ…çš„ç‰ˆæœ¬æ§åˆ¶</h4><p>ä¸‹é¢çš„ç‰ˆæœ¬éƒ½æ˜¯åˆæ³•çš„ï¼š<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gopkg.in/tomb.v1 v1<span class="number">.0</span><span class="number">.0</span><span class="number">-20141024135613</span>-dd632973f1e7</span><br><span class="line">gopkg.in/vmihailenco/msgpack.v2 v2<span class="number">.9</span><span class="number">.1</span></span><br><span class="line">gopkg.in/yaml.v2 <=v2<span class="number">.2</span><span class="number">.1</span></span><br><span class="line">github.com/tatsushid/<span class="keyword">go</span>-fastping v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20160109021039</span>-d7bb493dee3e</span><br><span class="line">latest</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç‰ˆæœ¬å·éµå¾ªå¦‚ä¸‹è§„å¾‹ï¼š<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vX.Y.Z-pre<span class="number">.0</span>.yyyymmddhhmmss-abcdefabcdef</span><br><span class="line">vX<span class="number">.0</span><span class="number">.0</span>-yyyymmddhhmmss-abcdefabcdef</span><br><span class="line">vX.Y.(Z+<span class="number">1</span>)<span class="number">-0.</span>yyyymmddhhmmss-abcdefabcdef</span><br><span class="line">vX.Y.Z</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¹Ÿå°±æ˜¯ç‰ˆæœ¬å· + æ—¶é—´æˆ³ + hashï¼Œæˆ‘ä»¬è‡ªå·±æŒ‡å®šç‰ˆæœ¬æ—¶åªéœ€è¦åˆ¶å®šç‰ˆæœ¬å·å³å¯ï¼Œæ²¡æœ‰ç‰ˆæœ¬ tag çš„åˆ™éœ€è¦æ‰¾åˆ°å¯¹åº” commit çš„æ—¶é—´å’Œ hash å€¼ã€‚</p><p>å¦å¤–ç‰ˆæœ¬å·æ˜¯æ”¯æŒ query è¡¨è¾¾å¼çš„ï¼Œå…¶æ±‚å€¼ç®—æ³•æ˜¯ â€œé€‰æ‹©æœ€æ¥è¿‘äºæ¯”è¾ƒç›®æ ‡çš„ç‰ˆæœ¬ (tagged version)â€ï¼Œå³ä¸Šæ–‡ä¸­çš„ gopkg.in/yaml.v2 ä¼šæ‰¾ä¸é«˜äº v2.2.1 çš„æœ€é«˜ç‰ˆæœ¬ã€‚</p><p>å¯¹äºå¤æ‚çš„åŒ…ä¾èµ–åœºæ™¯ï¼Œå¯ä»¥å‚è€ƒ Russ Cox åœ¨ <a href="https://research.swtch.com/vgo-mvs" target="_blank" rel="noopener">â€œMinimal Version Selectionâ€</a> ä¸€æ–‡ä¸­ç»™å‡ºçš„å½¢è±¡çš„ç®—æ³•è§£é‡Š (æ³¨æ„ï¼šè¿™ä¸ªç®—æ³•ä»…æ˜¯ä¾¿äºäººç±»ç†è§£ï¼Œä½†æ˜¯æ€§èƒ½ä½ä¸‹ï¼ŒçœŸæ­£çš„å®ç°å¹¶éæŒ‰ç…§è¿™ä¸ªç®—æ³•å®ç°)ã€‚</p><h4 id="go-get-å‡çº§"><a href="#go-get-å‡çº§" class="headerlink" title="go get å‡çº§"></a>go get å‡çº§</h4><ul><li>è¿è¡Œ <code>go get -u</code> å°†ä¼šå‡çº§åˆ°æœ€æ–°çš„æ¬¡è¦ç‰ˆæœ¬æˆ–è€…ä¿®è®¢ç‰ˆæœ¬ (x.y.zï¼Œz æ˜¯ä¿®è®¢ç‰ˆæœ¬å·ï¼Œ y æ˜¯æ¬¡è¦ç‰ˆæœ¬å·)</li><li>è¿è¡Œ <code>go get -u=patch</code> å°†ä¼šå‡çº§åˆ°æœ€æ–°çš„ä¿®è®¢ç‰ˆæœ¬</li><li>è¿è¡Œ <code>go get package@version</code> å°†ä¼šå‡çº§åˆ°æŒ‡å®šçš„ç‰ˆæœ¬å·<code>version</code></li></ul><h4 id="go-modules-ä¸-vendor"><a href="#go-modules-ä¸-vendor" class="headerlink" title="go modules ä¸ vendor"></a>go modules ä¸ vendor</h4><p>åœ¨æœ€åˆçš„è®¾è®¡ä¸­ï¼ŒRuss Cox æ˜¯æƒ³å½»åº•åºŸé™¤æ‰ vendor çš„ï¼Œä½†åœ¨ç¤¾åŒºçš„åé¦ˆä¸‹ï¼Œvendor å¾—ä»¥ä¿ç•™ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†å…¼å®¹ Go 1.11 ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</p><p>Go modules æ”¯æŒé€šè¿‡<code>go mod vendor</code>å‘½ä»¤å°†æŸä¸ª module çš„æ‰€æœ‰ä¾èµ–ä¿å­˜ä¸€ä»½ copy åˆ° root module dir çš„ vendor ä¸‹ï¼Œç„¶ååœ¨æ„å»ºçš„ä½¿ç”¨<code>go build -mod=vendor</code>å³å¯å¿½ç•¥ cache é‡Œçš„åŒ…è€Œåªä½¿ç”¨ vendor ç›®å½•é‡Œçš„ç‰ˆæœ¬ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener">è¯­ä¹‰åŒ–ç‰ˆæœ¬ 2.0.0 | Semantic Versioning</a></li><li><a href="https://golang.google.cn/cmd/go/#hdr-Module_maintenance" target="_blank" rel="noopener">go - The Go Programming Language</a></li><li><a href="https://github.com/golang/go/wiki/Modules" target="_blank" rel="noopener">Modules Â· golang/go Wiki Â· GitHub</a></li><li><a href="https://roberto.selbach.ca/intro-to-go-modules/" target="_blank" rel="noopener">Introduction to Go Modules â€“ Roberto Selbach</a></li><li><a href="https://tonybai.com/2018/07/15/hello-go-module/" target="_blank" rel="noopener">åˆçª¥ Go module | Tony Bai</a></li><li><a href="https://www.lightblue.asia/golang-1-11-new-festures-modules/" target="_blank" rel="noopener">Golang 1.11 æ–°åŠŸèƒ½ä»‹ç´¹ - Modules - LightBlue Essay</a></li><li><a href="https://gocn.vip/article/957" target="_blank" rel="noopener">Golang modules åˆæ¢ - Go ä¸­å›½æŠ€æœ¯ç¤¾åŒº - golang</a></li><li><a href="https://colobu.com/2018/08/27/learn-go-module/" target="_blank" rel="noopener">è·³å‡º Go module çš„æ³¥æ½­ | é¸Ÿçª</a></li><li><a href="https://windmt.com/2018/11/08/first-look-go-modules/" target="_blank" rel="noopener">Go åŒ…ç®¡ç†è§£å†³ä¹‹é“ â€”â€” Modules åˆè¯•</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Go çš„åŒ…ç®¡ç†æ˜¯ä¸€ç›´æ˜¯ä¸ºäººè¯Ÿç—…ä¹‹å¤„ï¼Œä» Go 1.5 å¼•å…¥çš„ vendor æœºåˆ¶ï¼Œåˆ°å‡†å®˜æ–¹å·¥å…· depï¼Œç›®å‰ä¸ºæ­¢è¿˜æ²¡ä¸€ä¸ªç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆ&lt;/p
      
    
    </summary>
    
      <category term="Golang" scheme="https://jiemin.wang/categories/Golang/"/>
    
    
      <category term="Golang" scheme="https://jiemin.wang/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>masterha-master-switch å‚æ•°è¯¦è§£</title>
    <link href="https://jiemin.wang/2019/03/28/masterha-master-switch/"/>
    <id>https://jiemin.wang/2019/03/28/masterha-master-switch/</id>
    <published>2019-03-28T11:45:02.000Z</published>
    <updated>2019-03-28T11:52:40.322Z</updated>
    
    <content type="html"><![CDATA[<h4 id="MHA-å‘½ä»¤-masterha-master-switch"><a href="#MHA-å‘½ä»¤-masterha-master-switch" class="headerlink" title="MHA å‘½ä»¤ masterha_master_switch"></a>MHA å‘½ä»¤ <a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/masterha_master_switch" target="_blank" rel="noopener">masterha_master_switch</a></h4><p>å¸¸ç”¨å‚æ•°ä»‹ç»<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">--master_state=dead</span><br><span class="line">    å¼ºåˆ¶çš„å‚æ•°ï¼Œå‚æ•°å€¼ä¸º<span class="string">"dead"</span> æˆ–è€… <span class="string">"alive"</span> . å¦‚æœ è®¾ç½®ä¸º alive æ¨¡å¼ï¼Œmasterha_master_switch å¼€å§‹åœ¨çº¿ä¸»åº“åˆ‡æ¢æ“ä½œã€‚</span><br><span class="line"> </span><br><span class="line">--dead_master_host=(hostname)</span><br><span class="line">    å¼ºåˆ¶å‚æ•°ï¼Œå®•æœºçš„ä¸»åº“æ‰€åœ¨çš„ä¸»æœºåç§°ã€‚--dead_master_ip å’Œ --dead_master_port æ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœè¿™äº›å‚æ•°æ²¡æœ‰è®¾ç½®ï¼Œ--dead_master_ip å°±æ˜¯ --dead_master_host è§£æçš„IPåœ°å€ã€‚--dead_master_port ä¸º 3306</span><br><span class="line"> </span><br><span class="line">--new_master_host=(hostname)</span><br><span class="line">    æ–°ä¸»æœºåœ°å€ï¼Œå¯é€‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨ä½ æ˜ç¡®æ–°çš„ä¸»åº“çš„ä¸»æœºï¼Œéå¸¸æœ‰ç”¨ã€‚(è¿™å°±æ„å‘³ç€ä½ ä¸éœ€è¦è®©MHAæ¥å†³å®šæ–°çš„ä¸»åº“)ã€‚å¦‚æœä¸è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¼šåˆ©ç”¨è‡ªåŠ¨failoverçš„è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»åº“ã€‚å¦‚æœè®¾ç½®--new_master_hostï¼ŒMHAé€‰æ‹©æ­¤ä¸»æœºä¸ºæ–°çš„ä¸»åº“ï¼Œå¦‚æœä¸èƒ½æˆä¸ºä¸»åº“ï¼ŒMHAå°†ä¼šé€€å‡º</span><br><span class="line"> </span><br><span class="line">--interactive=(0|1)</span><br><span class="line">    å¦‚æœè®¾ç½®ä¸º0ï¼Œåœ¨masterha_master_switchï¼Œå®ƒè‡ªåŠ¨æ‰§è¡Œæ•…éšœè½¬ç§»(éäº¤äº’å¼)ã€‚è¿™å®é™…ä¸Šæ˜¯å’Œmasterha_managerçš„å†…éƒ¨è¿è¡Œæœºåˆ¶ä¸€æ ·ï¼Œè¿™ç§éäº¤äº’å¼æ•…éšœè½¬ç§»æ˜¯æœ‰ç”¨çš„ï¼Œå¦‚æœä½ å·²ç»è¯å®äº†masteræ­»äº†,ä½†ä½ æƒ³å°½å¿«åšæ•…éšœè½¬ç§»ã€‚éäº¤äº’å¼æ•…éšœè½¬ç§»ä¹Ÿæ˜¯æœ‰ç”¨çš„,å¦‚æœä½ ä½¿ç”¨å…¶ä»–ç°æœ‰çš„ä¸»ç›‘æ§è½¯ä»¶å’Œè¦è°ƒç”¨çš„éäº¤äº’å¼æ•…éšœè½¬ç§»å‘½ä»¤è½¯ä»¶ã€‚å…¸å‹çš„ä¾‹å­æ˜¯masterha_master_switchè°ƒç”¨ä»é›†ç¾¤è½¯ä»¶åƒèµ·æå™¨ã€‚</span><br><span class="line"> </span><br><span class="line">--ssh_reachable=(0|1|2)</span><br><span class="line">    æŒ‡å®šmaster ç»è¿‡SSHæ˜¯å¦å¯è¾¾ã€‚0:ä¸å¯è¾¾ã€1:å¯è¾¾ã€2:æœªçŸ¥(é»˜è®¤å€¼)ã€‚ å¦‚æœè®¾ç½®ä¸ºäº†2ï¼Œæ­¤å‘½ä»¤å†…éƒ¨å°†ä¼šæ£€æµ‹é€šè¿‡SSH æ˜¯å¦å¯è¾¾masterï¼Œå¹¶ä¸”è·Ÿæ–°SSH çŠ¶æ€ã€‚å¦‚æœå¯è¾¾ï¼Œä¸”è®¾ç½®master_ip_failover_script æˆ–è€… shutdown_script .å°†ä¼šæ‰§è¡Œ<span class="string">"--command=stopssh"</span>ã€‚å¦åˆ™ï¼Œæ‰§è¡Œ <span class="string">"--command=stop"</span>ã€‚å¦å¤–ï¼Œå¦‚æœå®•æœºçš„masteré€šè¿‡SSHå¯è¾¾ï¼Œfailoverè„šæœ¬è¯•å›¾ä»å®•æœºçš„masteræœºå™¨ä¸Šæ‹·è´æ²¡æœ‰æ²¡æœ‰å‘é€çš„binlogã€‚</span><br><span class="line"> </span><br><span class="line">--skip_change_master</span><br><span class="line">    å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå½“å‘ç”Ÿfailoverçš„æ—¶å€™ï¼ŒMAH åœ¨åº”ç”¨å®Œä¸åŒçš„relay <span class="built_in">log</span>é€€å‡ºï¼Œå¿½ç•¥CHANGE MASTER å’Œ START SLAVE æ“ä½œã€‚æ‰€ä»¥ slaves ä¸ä¼šæŒ‡å‘ æ–°çš„master. å¼€å¯æ­¤å‚æ•°ï¼Œæœ‰åˆ©äºæ‰‹åŠ¨çš„äºŒæ¬¡æ£€æŸ¥slave æ¢å¤æ˜¯å¦æˆåŠŸ</span><br><span class="line"> </span><br><span class="line">--skip_disable_read_only</span><br><span class="line">    è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¸ä¼šåœ¨æ–°çš„ä¸»åº“ä¸Šæ‰§è¡Œ SET GLOBAL read_only =0 æ“ä½œï¼Œæœ‰åˆ©äºæ‰‹åŠ¨æ“ä½œ</span><br><span class="line"> </span><br><span class="line">--last_failover_minute=(minutes)</span><br><span class="line">    å‚è€ƒmaster_manager </span><br><span class="line"> </span><br><span class="line">--ignore_last_failover</span><br><span class="line">    å‚è€ƒmaster_manager</span><br><span class="line"> </span><br><span class="line">--wait_on_failover_error=(seconds)</span><br><span class="line">    ç±»ä¼¼äºmaster_manager, æ­¤å‚æ•°åªç”¨äºè‡ªåŠ¨çš„/éäº¤äº’å¼çš„failoverã€‚å¦‚æœæ²¡æœ‰è®¾ç½®--interval=0ï¼Œwait_on_failover_error å°†ä¼šè¢«å¿½ç•¥ï¼Œåœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ä¸ä¼šsleepã€‚</span><br><span class="line"> </span><br><span class="line">--remove_dead_master_conf</span><br><span class="line">    å‚è€ƒmasterha_manager</span><br><span class="line"> </span><br><span class="line">--wait_until_gtid_in_sync(0|1)</span><br><span class="line">    æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœè®¾ç½®æˆ1ï¼Œå½“åŸºäºGITDçš„failoveræ—¶,MHA ä¼šç­‰å¾…æ‰€æœ‰çš„ä»åº“è¿½ä¸Šæ–°ä¸»åº“çš„GITD</span><br><span class="line"> </span><br><span class="line">--skip_change_master</span><br><span class="line">    æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼ŒMHA è·³è¿‡ CHANGE MASTER çš„æ“ä½œ</span><br><span class="line"> </span><br><span class="line">--skip_disable_read_only</span><br><span class="line">    æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼ŒMHA å°†ä¼šåœ¨æ–°çš„master è·³è¿‡ SET GLOBAL read_only = 0;</span><br><span class="line"> </span><br><span class="line">--ignore_binlog_server_error</span><br><span class="line">    æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼Œå½“æ‰§è¡Œfailoverçš„æ—¶ï¼ŒMHAå¿½ç•¥binlog serverä¸Šä»»ä½•é”™è¯¯</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="ä¸»åœ¨çº¿åˆ‡æ¢æ—¶ç›¸å…³å‚æ•°"><a href="#ä¸»åœ¨çº¿åˆ‡æ¢æ—¶ç›¸å…³å‚æ•°" class="headerlink" title="ä¸»åœ¨çº¿åˆ‡æ¢æ—¶ç›¸å…³å‚æ•°"></a>ä¸»åœ¨çº¿åˆ‡æ¢æ—¶ç›¸å…³å‚æ•°</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--new_master_host=(hostname)</span><br><span class="line">    æ–°ä¸»æœºåœ°å€ï¼Œå¯é€‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨ä½ æ˜ç¡®æ–°çš„ä¸»åº“çš„ä¸»æœºï¼Œéå¸¸æœ‰ç”¨ã€‚(è¿™å°±æ„å‘³ç€ä½ ä¸éœ€è¦è®©MHAæ¥å†³å®šæ–°çš„ä¸»åº“)ã€‚å¦‚æœä¸è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¼šåˆ©ç”¨è‡ªåŠ¨failoverçš„è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»åº“ã€‚å¦‚æœè®¾ç½®--new_master_hostï¼ŒMHAé€‰æ‹©æ­¤ä¸»æœºä¸ºæ–°çš„ä¸»åº“ï¼Œå¦‚æœä¸èƒ½æˆä¸ºä¸»åº“ï¼ŒMHAå°†ä¼šé€€å‡º</span><br><span class="line"> </span><br><span class="line">--orig_master_is_new_slave</span><br><span class="line">    å½“å®Œæˆä¸»åº“åˆ‡æ¢åï¼ŒåŸå…ˆçš„ä¸»åº“å°†ä½œä¸ºç°åœ¨ä¸»åº“çš„slaveè¿è¡Œã€‚é»˜è®¤:ä¸å¼€å¯(åŸå…ˆçš„ä¸»åº“ä¸ä¼šåŠ å…¥åˆ°æ–°çš„å¤åˆ¶ç¯å¢ƒä¸­)ã€‚å¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®repl_passwordå‚æ•°ï¼Œç”±äºå½“æœŸçš„Masterå¹¶ä¸çŸ¥é“æ–°çš„Masterçš„replicationçš„å¯†ç </span><br><span class="line"> </span><br><span class="line">--remove_orig_master_conf</span><br><span class="line">    å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå½“æˆåŠŸfailoveråï¼ŒMHA managerå°†ä¼šè‡ªåŠ¨åˆ é™¤é…ç½®æ–‡ä»¶ä¸­å…³äºdead masterçš„é…ç½®é€‰é¡¹ã€‚</span><br><span class="line"> </span><br><span class="line">--skip_lock_all_tables</span><br><span class="line">    å½“åœ¨åšä¸»åº“åˆ‡æ¢çš„æ—¶å€™ï¼ŒMHAä¼šåœ¨åŸå…ˆçš„ä¸»åº“ä¸Šæ‰§è¡ŒFLUSH TABLES WITH READ LOCK æ“ä½œï¼Œç¡®ä¿æ²¡æœ‰è·Ÿæ–°æ“ä½œï¼Œä½†æ˜¯FLUSH TABLES WITH READ LOCK æ“ä½œæ˜¯éå¸¸è€—è´¹èµ„æºçš„ï¼Œå¹¶ä¸”ä½ å¯ä»¥åœ¨åŸå…ˆçš„ä¸»åº“ç¡®å®šæ²¡æœ‰è·Ÿæ–°æ“ä½œ(é€šè¿‡master_ip_online_change_script ä¸­<span class="built_in">kill</span> all clientsæ“ä½œç­‰)ã€‚å¯ä»¥åˆ©ç”¨æ­¤é€‰é¡¹é¿å…é”è¡¨ã€‚</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;MHA-å‘½ä»¤-masterha-master-switch&quot;&gt;&lt;a href=&quot;#MHA-å‘½ä»¤-masterha-master-switch&quot; class=&quot;headerlink&quot; title=&quot;MHA å‘½ä»¤ masterha_master_switch&quot;&gt;&lt;/a
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
      <category term="MHA" scheme="https://jiemin.wang/categories/MySQL/MHA/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
      <category term="MHA" scheme="https://jiemin.wang/tags/MHA/"/>
    
  </entry>
  
  <entry>
    <title>MHA æ•…éšœåˆ‡æ¢æ¼”ç»ƒ --- masterha_master_switch</title>
    <link href="https://jiemin.wang/2019/03/28/mha-switch/"/>
    <id>https://jiemin.wang/2019/03/28/mha-switch/</id>
    <published>2019-03-28T02:33:34.000Z</published>
    <updated>2019-03-28T11:48:11.513Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ˜¨å¤©å…¬å¸è¦è¿›è¡Œçº¿ä¸ŠMHAé«˜å¯ç”¨é›†ç¾¤æ•…éšœåˆ‡æ¢æ¼”ç»ƒã€‚ç”±äºæˆ‘åˆšå…¥èŒå…¬å¸ã€‚å…¬å¸è¿˜æ²¡æœ‰åšè¿‡å¤ªå¤šçš„ç¾éš¾çº§åˆ«çš„æ•…éšœæ¼”ç»ƒã€‚</p><h5 id="æˆ‘å†™äº†ä¸€äº›æ­¥éª¤ï¼š"><a href="#æˆ‘å†™äº†ä¸€äº›æ­¥éª¤ï¼š" class="headerlink" title="æˆ‘å†™äº†ä¸€äº›æ­¥éª¤ï¼š"></a>æˆ‘å†™äº†ä¸€äº›æ­¥éª¤ï¼š</h5><h6 id="æ•…éšœåˆ‡æ¢"><a href="#æ•…éšœåˆ‡æ¢" class="headerlink" title="æ•…éšœåˆ‡æ¢"></a>æ•…éšœåˆ‡æ¢</h6><ol><li>æŸ¥çœ‹ä¸»ä»å»¶è¿ŸçŠ¶æ€</li><li>ç™»å½•MHAä¸­æ§æœºï¼ŒæŸ¥çœ‹æ¼”ç»ƒåˆ‡æ¢çš„æ•°æ®åº“MHA logæ–‡ä»¶ï¼Œä½¿ç”¨tail -f å‘½ä»¤æ¥è·å–åˆ‡æ¢çš„logæ—¥å¿—ä¿¡æ¯</li><li>ç™»å½•masteræœºå™¨ï¼Œæ‰§è¡Œ /etc/init.d/mysql stop</li><li>æŸ¥çœ‹MHAä¸­æ§æœºæ—¥å¿—ä¿¡æ¯ã€‚</li><li>åˆ‡æ¢æˆåŠŸï¼Œç™»å½•åˆ° new_master ä¸­æŸ¥çœ‹vipæ˜¯å¦å·²ç»ç»‘å®šåˆ°ç½‘å¡ä¸Š</li><li>ç™»å½•slaveï¼ŒæŸ¥çœ‹ show slave status æ˜¯å¦å·²ç»change master to new_master ipä¸Šï¼ŒæŸ¥çœ‹slaveæ­£å¸¸ä¸å¦</li><li>åœ¨ MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹MHAé›†ç¾¤å¯åŠ¨æ˜¯å¦æ­£å¸¸ã€‚(ä¸¤èŠ‚ç‚¹)<br>ç»“æ„å›¾ï¼š<br>new_master: (master)<br>â€”> slave: (slave)</li></ol><h6 id="master-æ•°æ®åº“æ¢å¤"><a href="#master-æ•°æ®åº“æ¢å¤" class="headerlink" title="master æ•°æ®åº“æ¢å¤"></a>master æ•°æ®åº“æ¢å¤</h6><ol><li>ç™»å½•åˆ°old_master æœºå™¨ä¸Šæ‰§è¡Œ /etc/init.d/mysql start æ˜¯å¦æ­£å¸¸å¯åŠ¨æœåŠ¡</li><li>åœ¨MHAä¸­æ§æœºä¸­è·å–åˆ‡æ¢çš„log æ—¥å¿—ä¿¡æ¯æ‰¾å‡º change master to new_master ä¿¡æ¯è¯­å¥</li><li>åœ¨old_master ä¸­æ‰§è¡Œchange master to è¯­å¥ï¼Œå˜ä¸º new_masterçš„slave</li><li>show slave status æŸ¥çœ‹ old_master æ˜¯å¦æ­£å¸¸å˜ä¸º new_master çš„slave</li><li>åœ¨MHA ä¸­æ§æœºèŠ‚ç‚¹ï¼Œæ‰§è¡Œ masterha_stop å‘½ä»¤ç»“æŸ masterha_managerè¿›ç¨‹ã€‚</li><li>åœ¨MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹æ¢å¤å¥½çš„old_masteræ˜¯å¦æ­£å¸¸åŠ å…¥åˆ°MHAèŠ‚ç‚¹ (ä¸‰èŠ‚ç‚¹ï¼‰<br>ç»“æ„å›¾ï¼š<br>new_master: (master)<br>â€”> old_master: (slave)<br>â€”> slave: (slave)</li></ol><h6 id="æ¢å¤-old-masterä¸º-master-è§’è‰²"><a href="#æ¢å¤-old-masterä¸º-master-è§’è‰²" class="headerlink" title="æ¢å¤ old_masterä¸º master è§’è‰²"></a>æ¢å¤ old_masterä¸º master è§’è‰²</h6><ol><li>æŸ¥çœ‹ä¸»ä»å»¶è¿ŸçŠ¶æ€</li><li>ç™»å½•MHAä¸­æ§æœºï¼ŒæŸ¥çœ‹æ¼”ç»ƒåˆ‡æ¢çš„æ•°æ®åº“MHA logæ–‡ä»¶ï¼Œä½¿ç”¨tail -f å‘½ä»¤æ¥è·å–åˆ‡æ¢çš„logæ—¥å¿—ä¿¡æ¯</li><li>ç™»å½•new_masteræœºå™¨ï¼Œæ‰§è¡Œ /etc/init.d/mysql stop</li><li>æŸ¥çœ‹MHAä¸­æ§æœºæ—¥å¿—ä¿¡æ¯ã€‚</li><li>åˆ‡æ¢æˆåŠŸï¼Œç™»å½•åˆ° old_master ä¸­æŸ¥çœ‹vipæ˜¯å¦å·²ç»ç»‘å®šåˆ°ç½‘å¡ä¸Š</li><li>ç™»å½•slaveï¼ŒæŸ¥çœ‹ show slave status æ˜¯å¦å·²ç»change master to old_master ipä¸Šï¼ŒæŸ¥çœ‹slaveæ­£å¸¸ä¸å¦</li><li>åœ¨ MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹MHAé›†ç¾¤å¯åŠ¨æ˜¯å¦æ­£å¸¸ã€‚(ä¸¤èŠ‚ç‚¹)<br>ç»“æ„å›¾ï¼š<br>master(old_master): (master)<br>â€”> slave(new_master): (slave)<br>â€”> slave: (slave)</li></ol><h5 id="ä½†æ˜¯è¿™ä¹ˆæ“ä½œè™½ç„¶èƒ½æ›´è´´è¿‘çœŸå®ç¾éš¾-æš‚æ—¶æ²¡æœ‰æŠŠä¸»ä»æ•°æ®å»¶è¿Ÿè€ƒè™‘è¿›å…¥-ï¼Œéœ€è¦çš„æ—¶é—´ä¼šæ›´å¤šã€‚é¢†å¯¼å»ºè®®æ‰‹åŠ¨æ“ä½œMHA-failoveræµ‹è¯•èƒ½ä¸èƒ½åˆ‡æ¢ã€‚"><a href="#ä½†æ˜¯è¿™ä¹ˆæ“ä½œè™½ç„¶èƒ½æ›´è´´è¿‘çœŸå®ç¾éš¾-æš‚æ—¶æ²¡æœ‰æŠŠä¸»ä»æ•°æ®å»¶è¿Ÿè€ƒè™‘è¿›å…¥-ï¼Œéœ€è¦çš„æ—¶é—´ä¼šæ›´å¤šã€‚é¢†å¯¼å»ºè®®æ‰‹åŠ¨æ“ä½œMHA-failoveræµ‹è¯•èƒ½ä¸èƒ½åˆ‡æ¢ã€‚" class="headerlink" title="ä½†æ˜¯è¿™ä¹ˆæ“ä½œè™½ç„¶èƒ½æ›´è´´è¿‘çœŸå®ç¾éš¾(æš‚æ—¶æ²¡æœ‰æŠŠä¸»ä»æ•°æ®å»¶è¿Ÿè€ƒè™‘è¿›å…¥)ï¼Œéœ€è¦çš„æ—¶é—´ä¼šæ›´å¤šã€‚é¢†å¯¼å»ºè®®æ‰‹åŠ¨æ“ä½œMHA failoveræµ‹è¯•èƒ½ä¸èƒ½åˆ‡æ¢ã€‚"></a>ä½†æ˜¯è¿™ä¹ˆæ“ä½œè™½ç„¶èƒ½æ›´è´´è¿‘çœŸå®ç¾éš¾(æš‚æ—¶æ²¡æœ‰æŠŠä¸»ä»æ•°æ®å»¶è¿Ÿè€ƒè™‘è¿›å…¥)ï¼Œéœ€è¦çš„æ—¶é—´ä¼šæ›´å¤šã€‚é¢†å¯¼å»ºè®®æ‰‹åŠ¨æ“ä½œMHA failoveræµ‹è¯•èƒ½ä¸èƒ½åˆ‡æ¢ã€‚</h5><h2 id="æœåŠ¡å™¨æ¶æ„"><a href="#æœåŠ¡å™¨æ¶æ„" class="headerlink" title="æœåŠ¡å™¨æ¶æ„"></a>æœåŠ¡å™¨æ¶æ„</h2><table><thead><tr><th style="text-align:center">server</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">master</td><td style="text-align:center">old_master</td></tr><tr><td style="text-align:center">slave</td><td style="text-align:center">new_master</td></tr><tr><td style="text-align:center">slave</td><td style="text-align:center">slave</td></tr></tbody></table><h2 id="å…·ä½“æ“ä½œ"><a href="#å…·ä½“æ“ä½œ" class="headerlink" title="å…·ä½“æ“ä½œ"></a>å…·ä½“æ“ä½œ</h2><p>åœ¨MHA ä¸­æ§æœºä¸­æ‰§è¡Œå‘½ä»¤<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># masterha_check_repl --conf=/root/dba/mha/conf/babybi_#1.conf</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">Wed Mar 27 23:28:28 2019 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Reading application default configuration from /root/dba/mha/conf/babybi_<span class="comment">#1.conf..</span></span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Reading server configuration from /root/dba/mha/conf/babybi_<span class="comment">#1.conf..</span></span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] GTID failover mode = 0</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Dead Servers:</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Alive Servers:</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]   10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]   10.25.1.67(10.25.1.67:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]   10.25.1.68(10.25.1.68:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Alive Slaves:</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]   10.25.1.67(10.25.1.67:3306)  Version=5.6.29-76.2-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]     Replicating from 10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]   10.25.1.68(10.25.1.68:3306)  Version=5.6.29-76.2-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]     Replicating from 10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Current Alive Master: 10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Checking slave configurations..</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 10.25.1.67(10.25.1.67:3306).</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 10.25.1.68(10.25.1.68:3306).</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Mar 27 23:28:28 2019 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Mar 27 23:28:29 2019 - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Mar 27 23:28:29 2019 - [info] Checking MHA Node version..</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info]  Version check ok.</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info] HealthCheck: SSH to 10.25.1.66 is reachable.</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info] Master MHA Node version is 0.56.</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info] Checking recovery script configurations on 10.25.1.66(10.25.1.66:3306)..</span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/<span class="built_in">log</span>/mysql/binlog/ --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.004691 </span><br><span class="line">Wed Mar 27 23:28:30 2019 - [info]   Connecting to root@10.25.1.66(10.25.1.66:22).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /<span class="built_in">log</span>/mysql/binlog/, up to mysql-bin.004691</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Binlog setting check <span class="keyword">done</span>.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">'mha'</span> --slave_host=10.25.1.67 --slave_ip=10.25.1.67 --slave_port=3306 --workdir=/var/tmp --target_version=5.6.29-76.2-log --manager_version=0.56 --relay_log_info=/my/data/percona/relay-log.info  --relay_dir=/my/data/percona/  --slave_pass=xxx</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]   Connecting to root@10.25.1.67(10.25.1.67:22).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /my/data/percona/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /<span class="built_in">log</span>/mysql/relaylog, up to relay-log.014072</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /<span class="built_in">log</span>/mysql/relaylog/relay-log.014072</span><br><span class="line">    Testing mysql connection and privileges..Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line"> <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">'mha'</span> --slave_host=10.25.1.68 --slave_ip=10.25.1.68 --slave_port=3306 --workdir=/var/tmp --target_version=5.6.29-76.2-log --manager_version=0.56 --relay_log_info=/my/data/percona/relay-log.info  --relay_dir=/my/data/percona/  --slave_pass=xxx</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]   Connecting to root@10.25.1.68(10.25.1.68:22).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /my/data/percona/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /<span class="built_in">log</span>/mysql/relaylog, up to relay-log.014072</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /<span class="built_in">log</span>/mysql/relaylog/relay-log.014072</span><br><span class="line">    Testing mysql connection and privileges..Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line"> <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Slaves settings check <span class="keyword">done</span>.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] </span><br><span class="line">10.25.1.66(10.25.1.66:3306) (current master)</span><br><span class="line"> +--10.25.1.67(10.25.1.67:3306)</span><br><span class="line"> +--10.25.1.68(10.25.1.68:3306)</span><br><span class="line"></span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Checking replication health on 10.25.1.67..</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Checking replication health on 10.25.1.68..</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]   /root/dba/mha/script/master_ip_failover.sh --<span class="built_in">command</span>=status --ssh_user=root --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info]  OK.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Mar 27 23:28:31 2019 - [info] Got <span class="built_in">exit</span> code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œ masterha_master_switch å‘½ä»¤<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># masterha_master_switch --conf=/root/dba/mha/conf/babybi_#1.conf --master_state=alive --new_master_host=10.25.1.67 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">Wed Mar 27 23:34:27 2019 - [info] MHA::MasterRotate version 0.56.</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] Starting online master switch..</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] </span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] </span><br><span class="line">Wed Mar 27 23:34:27 2019 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] Reading application default configuration from /root/dba/mha/conf/babybi_<span class="comment">#1.conf..</span></span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] Reading server configuration from /root/dba/mha/conf/babybi_<span class="comment">#1.conf..</span></span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] GTID failover mode = 0</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] Current Alive Master: 10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info] Alive Slaves:</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info]   10.25.1.67(10.25.1.67:3306)  Version=5.6.29-76.2-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info]     Replicating from 10.25.1.66(10.25.1.66:3306)</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info]   10.25.1.68(10.25.1.68:3306)  Version=5.6.29-76.2-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Mar 27 23:34:27 2019 - [info]     Replicating from 10.25.1.66(10.25.1.66:3306)</span><br><span class="line"></span><br><span class="line">It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on 10.25.1.66(10.25.1.66:3306)? (YES/no): ---> è¾“å…¥: yes</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take long time..</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] Checking MHA is not monitoring or doing failover..</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] Checking replication health on 10.25.1.67..</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] Checking replication health on 10.25.1.68..</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] 10.25.1.67 can be new master.</span><br><span class="line">Wed Mar 27 23:34:34 2019 - [info] </span><br><span class="line">From:</span><br><span class="line">10.25.1.66(10.25.1.66:3306) (current master)</span><br><span class="line"> +--10.25.1.67(10.25.1.67:3306)</span><br><span class="line"> +--10.25.1.68(10.25.1.68:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">10.25.1.67(10.25.1.67:3306) (new master)</span><br><span class="line"> +--10.25.1.68(10.25.1.68:3306)</span><br><span class="line"> +--10.25.1.66(10.25.1.66:3306)</span><br><span class="line"></span><br><span class="line">Starting master switch from 10.25.1.66(10.25.1.66:3306) to 10.25.1.67(10.25.1.67:3306)? (yes/NO): ---> è¾“å…¥: yes</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] Checking whether 10.25.1.67(10.25.1.67:3306) is ok <span class="keyword">for</span> the new master..</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] 10.25.1.66(10.25.1.66:3306): SHOW SLAVE STATUS returned empty result. To check replication filtering rules, temporarily executing CHANGE MASTER to a dummy host.</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] 10.25.1.66(10.25.1.66:3306): Resetting slave pointing to the dummy host.</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] </span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] * Phase 2: Rejecting updates Phase..</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] </span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info] Executing master ip online change script to <span class="built_in">disable</span> write on the current master:</span><br><span class="line">Wed Mar 27 23:34:37 2019 - [info]   /root/dba/mha/script/master_ip_online_change.sh --<span class="built_in">command</span>=stop --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 --orig_master_user=<span class="string">'mha'</span> --orig_master_password=<span class="string">'mhapassword'</span> --new_master_host=10.25.1.67 --new_master_ip=10.25.1.67 --new_master_port=3306 --new_master_user=<span class="string">'mha'</span> --new_master_password=<span class="string">'mhapassword'</span> --orig_master_ssh_user=root --new_master_ssh_user=root   --orig_master_is_new_slave</span><br><span class="line">2019-03-27 23:34:38 set_mysql_read_only successful!</span><br><span class="line">Stopping keepalived: [  OK  ]</span><br><span class="line">2019-03-27 23:34:38 stop_keepalived successful!</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info] Locking all tables on the orig master to reject updates from everybody (including root):</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info] Executing FLUSH TABLES WITH READ LOCK..</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info]  ok.</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info] Orig master binlog:pos is mysql-bin.004691:854373586.</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info]  Waiting to execute all relay logs on 10.25.1.67(10.25.1.67:3306)..</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info]  master_pos_wait(mysql-bin.004691:854373586) completed on 10.25.1.67(10.25.1.67:3306). Executed 0 events.</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info]   <span class="keyword">done</span>.</span><br><span class="line">Wed Mar 27 23:34:38 2019 - [info] Getting new master<span class="string">'s binlog name and position..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  mysql-bin.000001:120</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='</span>10.25.1.67<span class="string">', MASTER_PORT=3306, MASTER_LOG_FILE='</span>mysql-bin.000001<span class="string">', MASTER_LOG_POS=120, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] Executing master ip online change script to allow write on the new master:</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]   /root/dba/mha/script/master_ip_online_change.sh --command=start --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 --orig_master_user='</span>mha<span class="string">' --orig_master_password='</span>mhapassword<span class="string">' --new_master_host=10.25.1.67 --new_master_ip=10.25.1.67 --new_master_port=3306 --new_master_user='</span>mha<span class="string">' --new_master_password='</span>mhapassword<span class="string">' --orig_master_ssh_user=root --new_master_ssh_user=root   --orig_master_is_new_slave</span></span><br><span class="line"><span class="string">Starting keepalived: [  OK  ]</span></span><br><span class="line"><span class="string">2019-03-27 23:34:38 start_keepalived successful!</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  ok.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] Setting read_only=0 on 10.25.1.67(10.25.1.67:3306)..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  ok.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] * Switching slaves in parallel..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] -- Slave switch on host 10.25.1.68(10.25.1.68:3306) started, pid: 20673</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info] Log messages from 10.25.1.68 ...</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  Waiting to execute all relay logs on 10.25.1.68(10.25.1.68:3306)..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  master_pos_wait(mysql-bin.004691:854373586) completed on 10.25.1.68(10.25.1.68:3306). Executed 0 events.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]   done.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  Resetting slave 10.25.1.68(10.25.1.68:3306) and starting replication from the new master 10.25.1.67(10.25.1.67:3306)..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:38 2019 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] End of log messages from 10.25.1.68 ...</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] -- Slave switch on host 10.25.1.68(10.25.1.68:3306) succeeded.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] Unlocking all tables on the orig master:</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] Executing UNLOCK TABLES..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info]  ok.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] Starting orig master as a new slave..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info]  Resetting slave 10.25.1.66(10.25.1.66:3306) and starting replication from the new master 10.25.1.67(10.25.1.67:3306)..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] All new slave servers switched successfully.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] * Phase 5: New master cleanup phase..</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] </span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info]  10.25.1.67: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Wed Mar 27 23:34:39 2019 - [info] Switching master to 10.25.1.67(10.25.1.67:3306) completed successfully.</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps -ef|grep babybi_#1.conf</span></span><br><span class="line">root      3578     1  0 Jan08 ?        00:42:35 perl /usr/bin/masterha_manager --conf=/root/dba/mha/conf/babybi_<span class="comment">#1.conf --ignore_last_failover</span></span><br><span class="line">root     21082 17518  0 23:35 pts/0    00:00:00 grep --colour=auto babybi_<span class="comment">#1.conf</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>åˆ°new_masteræœºå™¨ä¸­æŸ¥çœ‹VIPæœ‰æ²¡æœ‰ç»‘å®šè¿‡æ¥åˆ°ç½‘å¡ä¸Š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip a</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: em1: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc mq master bond0 state UP qlen 1000</span><br><span class="line">    link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: em2: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc mq master bond0 state UP qlen 1000</span><br><span class="line">    link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: em3: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000</span><br><span class="line">    link/ether 24:6e:96:13:61:34 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: em4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000</span><br><span class="line">    link/ether 24:6e:96:13:61:35 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: bond0: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP </span><br><span class="line">    link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.25.1.67/24 brd 10.25.1.255 scope global bond0</span><br><span class="line">    inet 10.25.1.203/32 scope global bond0</span><br><span class="line">    inet6 fe80::266e:96ff:fe13:6130/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>ç™»å½•åˆ°slaveæœºå™¨ä¸Š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">mysql> show slave status\G</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    2049252955</span><br><span class="line">Current database: *** NONE ***</span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 10.25.1.67</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 62528</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 62691</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 62528</span><br><span class="line">              Relay_Log_Space: 62858</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1673306</span><br><span class="line">                  Master_UUID: ca479c32-fa0d-11e8-bc0f-246e96136130</span><br><span class="line">             Master_Info_File: /my/data/percona/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql></span><br></pre></td></tr></tbody></table></figure><p></p><p>æ­£å¸¸ CHANGE MASTER TO NEW_MASTER </p><p>ç™»å½•åˆ°old_masterä¸­æŸ¥çœ‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">mysql> show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 10.25.1.67</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 66875</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 67038</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 66875</span><br><span class="line">              Relay_Log_Space: 67205</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1673306</span><br><span class="line">                  Master_UUID: ca479c32-fa0d-11e8-bc0f-246e96136130</span><br><span class="line">             Master_Info_File: /my/data/percona/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql></span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ°new_masterä¸ŠæŸ¥çœ‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep keepalived</span><br><span class="line">root     37477     1  0 23:41 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root     37478 37477  0 23:41 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root     37479 37477  0 23:41 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">dbctl    38747 35598  0 23:49 pts/0    00:00:00 grep --colour=auto keepalived</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="åœ¨åˆ‡æ¢å›æ¥åˆ°old-masterææˆä¸ºmaster"><a href="#åœ¨åˆ‡æ¢å›æ¥åˆ°old-masterææˆä¸ºmaster" class="headerlink" title="åœ¨åˆ‡æ¢å›æ¥åˆ°old_masterææˆä¸ºmaster"></a>åœ¨åˆ‡æ¢å›æ¥åˆ°old_masterææˆä¸ºmaster</h5><p>æ­¥éª¤æŒ‰ç…§ä¸Šé¢æ“ä½œï¼Œå°±ä¸é‡å¤æ¬ç –äº†ã€‚</p><h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p>MHA é«˜å¯ç”¨é›†ç¾¤åˆ‡æ¢æˆåŠŸï¼Œè™½ç„¶æ˜¯æ‰‹åŠ¨MHA failoveræµ‹è¯•ï¼Œå¹¶ä¸èƒ½ä»£è¡¨MHAçš„é«˜å¯ç”¨ã€‚ä»¥åè¿˜ä¼šæŒ‰ç…§ä¸Šé¢ç¼©å†™çš„æ­¥éª¤åœ¨åŠ ä¸Šä¸€å®šçš„ä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿæ¥è¿›è¡Œæ¼”ç»ƒã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æ˜¨å¤©å…¬å¸è¦è¿›è¡Œçº¿ä¸ŠMHAé«˜å¯ç”¨é›†ç¾¤æ•…éšœåˆ‡æ¢æ¼”ç»ƒã€‚ç”±äºæˆ‘åˆšå…¥èŒå…¬å¸ã€‚å…¬å¸è¿˜æ²¡æœ‰åšè¿‡å¤ªå¤šçš„ç¾éš¾çº§åˆ«çš„æ•…éšœæ¼”ç»ƒã€‚&lt;/p&gt;
&lt;h5 id=&quot;æˆ‘å†™äº†ä¸€
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
      <category term="MHA" scheme="https://jiemin.wang/categories/MySQL/MHA/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
      <category term="MHA" scheme="https://jiemin.wang/tags/MHA/"/>
    
  </entry>
  
  <entry>
    <title>CentOS Install git Source</title>
    <link href="https://jiemin.wang/2019/03/25/git-install/"/>
    <id>https://jiemin.wang/2019/03/25/git-install/</id>
    <published>2019-03-25T05:07:08.000Z</published>
    <updated>2019-03-25T05:48:46.687Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a href="https://git-scm.com" target="_blank" rel="noopener">Git</a></p><p>åŒç”Ÿæ´»ä¸­çš„è®¸å¤šä¼Ÿå¤§äº‹ä»¶ä¸€æ ·ï¼ŒGit è¯ç”Ÿäºä¸€ä¸ªæå¯Œçº·äº‰å¤§ä¸¾åˆ›æ–°çš„å¹´ä»£ã€‚Linux å†…æ ¸å¼€æºé¡¹ç›®æœ‰ç€ä¸ºæ•°ä¼—å¹¿çš„å‚ä¸è€…ã€‚ç»å¤§å¤šæ•°çš„ Linux å†…æ ¸ç»´æŠ¤å·¥ä½œéƒ½èŠ±åœ¨äº†æäº¤è¡¥ä¸å’Œä¿å­˜å½’æ¡£çš„ç¹çäº‹åŠ¡ä¸Šï¼ˆ1991ï¼2002å¹´é—´ï¼‰ã€‚åˆ° 2002 å¹´ï¼Œæ•´ä¸ªé¡¹ç›®ç»„å¼€å§‹å¯ç”¨åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ BitKeeper æ¥ç®¡ç†å’Œç»´æŠ¤ä»£ç ã€‚<a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p>åˆ°äº† 2005 å¹´ï¼Œå¼€å‘ BitKeeper çš„å•†ä¸šå…¬å¸åŒ Linux å†…æ ¸å¼€æºç¤¾åŒºçš„åˆä½œå…³ç³»ç»“æŸï¼Œä»–ä»¬æ”¶å›äº†å…è´¹ä½¿ç”¨ BitKeeper çš„æƒåŠ›ã€‚è¿™å°±è¿«ä½¿ Linux å¼€æºç¤¾åŒºï¼ˆç‰¹åˆ«æ˜¯ Linux çš„ç¼”é€ è€… Linus Torvalds ï¼‰ä¸å¾—ä¸å¸å–æ•™è®­ï¼Œåªæœ‰å¼€å‘ä¸€å¥—å±äºè‡ªå·±çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ‰ä¸è‡³äºé‡è¹ˆè¦†è¾™ã€‚ä»–ä»¬å¯¹æ–°çš„ç³»ç»Ÿåˆ¶è®¢äº†è‹¥å¹²ç›®æ ‡ï¼š</p><ul><li>é€Ÿåº¦</li><li>ç®€å•çš„è®¾è®¡</li><li>å¯¹éçº¿æ€§å¼€å‘æ¨¡å¼çš„å¼ºåŠ›æ”¯æŒï¼ˆå…è®¸ä¸Šåƒä¸ªå¹¶è¡Œå¼€å‘çš„åˆ†æ”¯ï¼‰</li><li>å®Œå…¨åˆ†å¸ƒå¼</li><li>æœ‰èƒ½åŠ›é«˜æ•ˆç®¡ç†ç±»ä¼¼ Linux å†…æ ¸ä¸€æ ·çš„è¶…å¤§è§„æ¨¡é¡¹ç›®ï¼ˆé€Ÿåº¦å’Œæ•°æ®é‡ï¼‰</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>git æºç å®‰è£…ã€‚<a href="https://github.com/git/git/archive/v2.21.0.zip" target="_blank" rel="noopener">ä¸‹è½½æºç </a><br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/git/git/archive/v2.21.0.zip</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>è§£å‹ç¼©<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar zxvf v2.21.0.zip</span></span><br><span class="line"><span class="comment"># cd git-2.20.1</span></span><br><span class="line"></span><br><span class="line">ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹</span><br><span class="line"><span class="comment"># # make prefix=/usr/local/git all</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœé‡åˆ°è¯¥é”™è¯¯</p><img src="/2019/03/25/git-install/giterror.jpg" title="giterror"><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.h:6:23: warning: curl/curl.h: No such file or directory</span><br><span class="line">http.h:7:23: warning: curl/easy.h: No such file or directory</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ‰§è¡Œå‘½ä»¤</span><br><span class="line"><span class="comment"># yum install -y curl curl-devel</span></span><br></pre></td></tr></tbody></table></figure><p>é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤</p><p>å‘ç°ç¼–è¯‘æŠ¥é”™</p><img src="/2019/03/25/git-install/giterror2.jpg" title="giterror2"><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    CC http.o</span><br><span class="line">    CC http-walker.o</span><br><span class="line">    CC http-fetch.o</span><br><span class="line">    LINK git-http-fetch</span><br><span class="line">    CC http-push.o</span><br><span class="line">http-push.c:22:19: warning: expat.h: No such file or directory</span><br><span class="line">http-push.c:830: warning: <span class="built_in">type</span> defaults to â€˜intâ€™ <span class="keyword">in</span> declaration of â€˜XML_Charâ€™</span><br><span class="line">http-push.c:830: error: expected â€˜;â€™, â€˜,â€™ or â€˜)â€™ before â€˜*â€™ token</span><br><span class="line">http-push.c: In <span class="keyword">function</span> â€˜lock_remoteâ€™:</span><br><span class="line">http-push.c:900: error: â€˜XML_Parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:900: error: (Each undeclared identifier is reported only once</span><br><span class="line">http-push.c:900: error: <span class="keyword">for</span> each <span class="keyword">function</span> it appears <span class="keyword">in</span>.)</span><br><span class="line">http-push.c:900: error: expected â€˜;â€™ before â€˜parserâ€™</span><br><span class="line">http-push.c:907: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_SetUserDataâ€™</span><br><span class="line">http-push.c:907: error: â€˜parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:908: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_SetElementHandlerâ€™</span><br><span class="line">http-push.c:910: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_SetCharacterDataHandlerâ€™</span><br><span class="line">http-push.c:910: error: â€˜xml_cdataâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:911: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_Parseâ€™</span><br><span class="line">http-push.c:916: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_ErrorStringâ€™</span><br><span class="line">http-push.c:917: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_GetErrorCodeâ€™</span><br><span class="line">http-push.c:920: warning: implicit declaration of <span class="keyword">function</span> â€˜XML_ParserFreeâ€™</span><br><span class="line">http-push.c: In <span class="keyword">function</span> â€˜remote_lsâ€™:</span><br><span class="line">http-push.c:1154: error: â€˜XML_Parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:1154: error: expected â€˜;â€™ before â€˜parserâ€™</span><br><span class="line">http-push.c:1161: error: â€˜parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:1164: error: â€˜xml_cdataâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c: In <span class="keyword">function</span> â€˜locking_availableâ€™:</span><br><span class="line">http-push.c:1228: error: â€˜XML_Parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">http-push.c:1228: error: expected â€˜;â€™ before â€˜parserâ€™</span><br><span class="line">http-push.c:1235: error: â€˜parserâ€™ undeclared (first use <span class="keyword">in</span> this <span class="keyword">function</span>)</span><br><span class="line">make: *** [http-push.o] Error 1</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œå‘½ä»¤è§£å†³è¿™ä¸ªé—®é¢˜<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y expat-devel</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å†æ¬¡é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤</p><p>å‘ç°å†æ¬¡æŠ¥é”™</p><img src="/2019/03/25/git-install/giterror3.jpg" title="giterror3"><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GITGUI_VERSION = 0.21.GITGUI</span><br><span class="line">    * new locations or Tcl/Tk interpreter</span><br><span class="line">    GEN git-gui</span><br><span class="line">    INDEX lib/</span><br><span class="line">    * tclsh failed; using unoptimized loading</span><br><span class="line">    MSGFMT    po/bg.msg make[1]: *** [po/bg.msg] Error 127</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œå‘½ä»¤è§£å†³<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y tcl build-essential tk gettext</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å†æ¬¡é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤</p><p>gitæºç ç¼–è¯‘æˆåŠŸæ‰§è¡Œæ‰§è¡Œå‘½ä»¤<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make prefix=/usr/local/git install</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/git/</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin  libexec  share</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cd bin/</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">git  git-cvsserver  gitk  git-receive-pack  git-shell  git-upload-archive  git-upload-pack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ./git --version</span></span><br><span class="line">git version 2.20.1</span><br></pre></td></tr></tbody></table></figure><p>å®‰è£…å®Œæˆã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://git-scm.com&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Git&lt;/a&gt;&lt;/
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux Netcat å‘½ä»¤ - ç½‘ç»œä¸­çš„ç‘å£«å†›åˆ€</title>
    <link href="https://jiemin.wang/2019/03/25/nc/"/>
    <id>https://jiemin.wang/2019/03/25/nc/</id>
    <published>2019-03-25T01:45:29.000Z</published>
    <updated>2019-04-01T03:45:11.879Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a href="http://netcat.sourceforge.net/" target="_blank" rel="noopener">netcat</a>æ˜¯ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå®ƒèƒ½é€šè¿‡TCPå’ŒUDPåœ¨ç½‘ç»œä¸­è¯»å†™æ•°æ®ã€‚é€šè¿‡ä¸å…¶ä»–å·¥å…·ç»“åˆå’Œé‡å®šå‘ï¼Œä½ å¯ä»¥åœ¨è„šæœ¬ä¸­ä»¥å¤šç§æ–¹å¼ä½¿ç”¨å®ƒã€‚ä½¿ç”¨netcatå‘½ä»¤æ‰€èƒ½å®Œæˆçš„äº‹æƒ…ä»¤äººæƒŠè®¶ã€‚å®ƒçš„<a href="http://netcat.sourceforge.net/download.php" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a></p><p>netcatæ‰€åšçš„å°±æ˜¯åœ¨ä¸¤å°ç”µè„‘ä¹‹é—´å»ºç«‹é“¾æ¥å¹¶è¿”å›ä¸¤ä¸ªæ•°æ®æµï¼Œåœ¨è¿™ä¹‹åæ‰€èƒ½åšçš„äº‹å°±çœ‹ä½ çš„æƒ³åƒåŠ›äº†ã€‚ä½ èƒ½å»ºç«‹ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¼ è¾“æ–‡ä»¶ï¼Œä¸æœ‹å‹èŠå¤©ï¼Œä¼ è¾“æµåª’ä½“æˆ–è€…ç”¨å®ƒä½œä¸ºå…¶å®ƒåè®®çš„ç‹¬ç«‹å®¢æˆ·ç«¯ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ nc -h</span><br><span class="line">usage: nc [-46DdhklnrStUuvzC] [-i interval] [-p source_port]</span><br><span class="line">          [-s source_ip_address] [-T ToS] [-w timeout] [-X proxy_version]</span><br><span class="line">          [-x proxy_address[:port]] [hostname] [port[s]]</span><br><span class="line">        Command Summary:</span><br><span class="line">                -4              Use IPv4</span><br><span class="line">                -6              Use IPv6</span><br><span class="line">                -D              Enable the debug socket option</span><br><span class="line">                -d              Detach from stdin</span><br><span class="line">                -h              This <span class="built_in">help</span> text</span><br><span class="line">                -i secs         Delay interval <span class="keyword">for</span> lines sent, ports scanned</span><br><span class="line">                -k              Keep inbound sockets open <span class="keyword">for</span> multiple connects</span><br><span class="line">                -l              Listen mode, <span class="keyword">for</span> inbound connects</span><br><span class="line">                -n              Suppress name/port resolutions</span><br><span class="line">                -p port         Specify <span class="built_in">local</span> port <span class="keyword">for</span> remote connects</span><br><span class="line">                -r              Randomize remote ports</span><br><span class="line">                -S              Enable the TCP MD5 signature option</span><br><span class="line">                -s addr         Local <span class="built_in">source</span> address</span><br><span class="line">                -T ToS          Set IP Type of Service</span><br><span class="line">                -C              Send CRLF as line-ending</span><br><span class="line">                -t              Answer TELNET negotiation</span><br><span class="line">                -U              Use UNIX domain socket</span><br><span class="line">                -u              UDP mode</span><br><span class="line">                -v              Verbose</span><br><span class="line">                -w secs         Timeout <span class="keyword">for</span> connects and final net reads</span><br><span class="line">                -X proto        Proxy protocol: <span class="string">"4"</span>, <span class="string">"5"</span> (SOCKS) or <span class="string">"connect"</span></span><br><span class="line">                -x addr[:port]  Specify proxy address and port</span><br><span class="line">                -z              Zero-I/O mode [used <span class="keyword">for</span> scanning]</span><br><span class="line">        Port numbers can be individual or ranges: lo-hi [inclusive]</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nc</span><br><span class="line">usage: nc [-46DdhklnrStUuvzC] [-i interval] [-p source_port]</span><br><span class="line">          [-s source_ip_address] [-T ToS] [-w timeout] [-X proxy_version]</span><br><span class="line">          [-x proxy_address[:port]] [hostname] [port[s]]</span><br></pre></td></tr></tbody></table></figure><p>nc çš„åŸºæœ¬åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>telnet / è·å–ç³»ç»Ÿ banner ä¿¡æ¯</li><li>ä¼ è¾“æ–‡æœ¬ä¿¡æ¯</li><li>ä¼ è¾“æ–‡ä»¶å’Œç›®å½•</li><li>åŠ å¯†ä¼ è¾“æ–‡ä»¶</li><li>ç«¯å£æ‰«æ</li><li>è¿œç¨‹æ§åˆ¶ / æ­£æ–¹å‘ shell</li><li>æµåª’ä½“æœåŠ¡å™¨</li><li>è¿œç¨‹å…‹éš†ç¡¬ç›˜</li></ul><h2 id="ä½¿ç”¨ä¾‹å­"><a href="#ä½¿ç”¨ä¾‹å­" class="headerlink" title="ä½¿ç”¨ä¾‹å­"></a>ä½¿ç”¨ä¾‹å­</h2><h4 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h4><p>ç«¯å£æ‰«æç»å¸¸è¢«ç³»ç»Ÿç®¡ç†å‘˜å’Œé»‘å®¢ç”¨æ¥å‘ç°åœ¨ä¸€äº›æœºå™¨ä¸Šå¼€æ”¾çš„ç«¯å£ï¼Œå¸®åŠ©ä»–ä»¬è¯†åˆ«ç³»ç»Ÿä¸­çš„æ¼æ´<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -z -v -n 192.168.10.10 10-100</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯ä»¥è¿è¡Œåœ¨TCPæˆ–è€…UDPæ¨¡å¼ï¼Œé»˜è®¤æ˜¯TCPï¼Œ-uå‚æ•°è°ƒæ•´ä¸ºudp.</p><ul><li>z å‚æ•°å‘Šè¯‰netcatä½¿ç”¨0 IO,è¿æ¥æˆåŠŸåç«‹å³å…³é—­è¿æ¥ï¼Œ ä¸è¿›è¡Œæ•°æ®äº¤æ¢</li><li>v å‚æ•°æŒ‡ä½¿ç”¨å†—ä½™é€‰é¡¹ï¼ˆè¯‘è€…æ³¨ï¼šå³è¯¦ç»†è¾“å‡ºï¼‰</li><li>n å‚æ•°å‘Šè¯‰netcat ä¸è¦ä½¿ç”¨DNSåå‘æŸ¥è¯¢IPåœ°å€çš„åŸŸå</li></ul><p>è¿™ä¸ªå‘½ä»¤ä¼šæ‰“å°21åˆ°25 æ‰€æœ‰å¼€æ”¾çš„ç«¯å£ã€‚Banneræ˜¯ä¸€ä¸ªæ–‡æœ¬ï¼ŒBanneræ˜¯ä¸€ä¸ªä½ è¿æ¥çš„æœåŠ¡å‘é€ç»™ä½ çš„æ–‡æœ¬ä¿¡æ¯ã€‚å½“ä½ è¯•å›¾é‰´åˆ«æ¼æ´æˆ–è€…æœåŠ¡çš„ç±»å‹å’Œç‰ˆæœ¬çš„æ—¶å€™ï¼ŒBannerä¿¡æ¯æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå‘é€bannerã€‚</p><p>ä¸€æ—¦ä½ å‘ç°å¼€æ”¾çš„ç«¯å£ï¼Œä½ å¯ä»¥å®¹æ˜“çš„ä½¿ç”¨netcat è¿æ¥æœåŠ¡æŠ“å–ä»–ä»¬çš„bannerã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -v 192.168.10.10 22</span><br></pre></td></tr></tbody></table></figure><p>netcat å‘½ä»¤ä¼šè¿æ¥å¼€æ”¾ç«¯å£21å¹¶ä¸”æ‰“å°è¿è¡Œåœ¨è¿™ä¸ªç«¯å£ä¸ŠæœåŠ¡çš„bannerä¿¡æ¯ã€‚</p><h4 id="C-S-Chat-Server-èŠå¤©"><a href="#C-S-Chat-Server-èŠå¤©" class="headerlink" title="C S(Chat Server) èŠå¤©"></a>C S(Chat Server) èŠå¤©</h4><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -l 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>netcat å‘½ä»¤åœ¨1567ç«¯å£å¯åŠ¨äº†ä¸€ä¸ªtcp æœåŠ¡å™¨ï¼Œæ‰€æœ‰çš„æ ‡å‡†è¾“å‡ºå’Œè¾“å…¥ä¼šè¾“å‡ºåˆ°è¯¥ç«¯å£ã€‚è¾“å‡ºå’Œè¾“å…¥éƒ½åœ¨æ­¤shellä¸­å±•ç¤ºã€‚</p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc 192.168.10.10 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸ç®¡ä½ åœ¨æœºå™¨Bä¸Šé”®å…¥ä»€ä¹ˆéƒ½ä¼šå‡ºç°åœ¨æœºå™¨Aä¸Šã€‚</p><h4 id="æ–‡ä»¶ä¼ è¾“"><a href="#æ–‡ä»¶ä¼ è¾“" class="headerlink" title="æ–‡ä»¶ä¼ è¾“"></a>æ–‡ä»¶ä¼ è¾“</h4><p>å¤§éƒ¨åˆ†æ—¶é—´ä¸­ï¼Œæˆ‘ä»¬éƒ½åœ¨è¯•å›¾é€šè¿‡ç½‘ç»œæˆ–è€…å…¶ä»–å·¥å…·ä¼ è¾“æ–‡ä»¶ã€‚æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œæ¯”å¦‚FTP,SCP,SMBç­‰ç­‰ï¼Œä½†æ˜¯å½“ä½ åªæ˜¯éœ€è¦ä¸´æ—¶æˆ–è€…ä¸€æ¬¡ä¼ è¾“æ–‡ä»¶ï¼ŒçœŸçš„å€¼å¾—æµªè´¹æ—¶é—´æ¥å®‰è£…é…ç½®ä¸€ä¸ªè½¯ä»¶åˆ°ä½ çš„æœºå™¨ä¸Šå˜›ã€‚å‡è®¾ï¼Œä½ æƒ³è¦ä¼ ä¸€ä¸ªæ–‡ä»¶testfile.txt ä»A åˆ°Bã€‚Aæˆ–è€…Béƒ½å¯ä»¥ä½œä¸ºæœåŠ¡å™¨æˆ–è€…å®¢æˆ·ç«¯ï¼Œä»¥ä¸‹ï¼Œè®©Aä½œä¸ºæœåŠ¡å™¨ï¼ŒBä¸ºå®¢æˆ·ç«¯ã€‚</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -l 10010 < testfile.txt</span><br></pre></td></tr></tbody></table></figure><p></p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -n 192.168.10.10 10010 > testfile.txt</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡å™¨åœ¨Aä¸Šå¹¶ä¸”é‡å®šå‘netcatçš„è¾“å…¥ä¸ºæ–‡ä»¶testfile.txtï¼Œé‚£ä¹ˆå½“ä»»ä½•æˆåŠŸè¿æ¥åˆ°è¯¥ç«¯å£ï¼Œnetcatä¼šå‘é€fileçš„æ–‡ä»¶å†…å®¹ã€‚<br>åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬é‡å®šå‘è¾“å‡ºåˆ°testfile.txtï¼Œå½“Bè¿æ¥åˆ°Aï¼ŒAå‘é€æ–‡ä»¶å†…å®¹ï¼ŒBä¿å­˜æ–‡ä»¶å†…å®¹åˆ°testfile.txt.</p><p>æ²¡æœ‰å¿…è¦åˆ›å»ºæ–‡ä»¶æºä½œä¸ºServerï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›¸åçš„æ–¹æ³•ä½¿ç”¨ã€‚åƒä¸‹é¢çš„æˆ‘ä»¬å‘é€æ–‡ä»¶ä»Båˆ°Aï¼Œä½†æ˜¯æœåŠ¡å™¨åˆ›å»ºåœ¨Aä¸Šï¼Œè¿™æ¬¡æˆ‘ä»¬ä»…éœ€è¦é‡å®šå‘netcatçš„è¾“å‡ºå¹¶ä¸”é‡å®šå‘Bçš„è¾“å…¥æ–‡ä»¶ã€‚</p><h4 id="ç›®å½•ä¼ è¾“"><a href="#ç›®å½•ä¼ è¾“" class="headerlink" title="ç›®å½•ä¼ è¾“"></a>ç›®å½•ä¼ è¾“</h4><p>å‘é€ä¸€ä¸ªæ–‡ä»¶å¾ˆç®€å•ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦å‘é€å¤šä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æ•´ä¸ªç›®å½•ï¼Œä¸€æ ·å¾ˆç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨å‹ç¼©å·¥å…·tarï¼Œå‹ç¼©åå‘é€å‹ç¼©åŒ…ã€‚</p><p>å¦‚æœä½ æƒ³è¦é€šè¿‡ç½‘ç»œä¼ è¾“ä¸€ä¸ªç›®å½•ä»Aåˆ°Bã€‚</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -cvf - dir_name | nc -n 192.168.10.10 10010</span><br><span class="line">$ tar -cvf - dir_name | nc 192.168.10.10 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -l 10010 | tar -xvf -</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™é‡Œåœ¨AæœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªtarå½’æ¡£åŒ…å¹¶ä¸”é€šè¿‡-åœ¨æ§åˆ¶å°é‡å®šå‘å®ƒï¼Œç„¶åä½¿ç”¨ç®¡é“ï¼Œé‡å®šå‘ç»™netcatï¼Œnetcatå¯ä»¥é€šè¿‡ç½‘ç»œå‘é€å®ƒã€‚</p><p>åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬ä¸‹è½½è¯¥å‹ç¼©åŒ…é€šè¿‡netcat ç®¡é“ç„¶åæ‰“å¼€æ–‡ä»¶ã€‚</p><p>å¦‚æœæƒ³è¦èŠ‚çœå¸¦å®½ä¼ è¾“å‹ç¼©åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>bzip2</strong>æˆ–è€…å…¶ä»–å·¥å…·å‹ç¼©ã€‚</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar -cvf - dir_name| bzip2 -z | nc -n 192.168.10.10 10010</span><br><span class="line">$ tar -cvf - dir_name| bzip2 -z | nc 192.168.10.10 10010</span><br><span class="line"><span class="comment">#ä½¿ç”¨ bzip2 å‹ç¼©</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nc -l 10010 | bzip2 -d | tar -xvf -</span><br><span class="line"><span class="comment">#ä½¿ç”¨ bzip2 è§£å‹ç¼©</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="åŠ å¯†é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®"><a href="#åŠ å¯†é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®" class="headerlink" title="åŠ å¯†é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®"></a>åŠ å¯†é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®</h4><p>å¦‚æœä½ æ‹…å¿ƒä½ åœ¨ç½‘ç»œä¸Šå‘é€æ•°æ®çš„å®‰å…¨ï¼Œä½ å¯ä»¥åœ¨å‘é€ä½ çš„æ•°æ®ä¹‹å‰ç”¨å¦‚ <strong>mcrypt</strong> çš„å·¥å…·åŠ å¯†ã€‚</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nc localhost 10010 | mcrypt -flush -bare -F -q -d -m ecb > testfile.txt</span><br><span class="line"><span class="comment">#ä½¿ç”¨mcryptå·¥å…·åŠ å¯†æ•°æ®</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mcrypt -flush -bare -F -q -m ecb < testfile.txt | nc -l 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½¿ç”¨mcryptå·¥å…·è§£å¯†æ•°æ®ã€‚</p><p>ä»¥ä¸Šä¸¤ä¸ªå‘½ä»¤ä¼šæç¤ºéœ€è¦å¯†ç ï¼Œç¡®ä¿ä¸¤ç«¯ä½¿ç”¨ç›¸åŒçš„å¯†ç ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯ä½¿ç”¨mcryptç”¨æ¥åŠ å¯†ï¼Œä½¿ç”¨å…¶å®ƒä»»æ„åŠ å¯†å·¥å…·éƒ½å¯ä»¥ã€‚</p><h4 id="åå‘-SHELL"><a href="#åå‘-SHELL" class="headerlink" title="åå‘ SHELL"></a>åå‘ SHELL</h4><p>åå‘shellæ˜¯æŒ‡åœ¨å®¢æˆ·ç«¯æ‰“å¼€çš„shellã€‚åå‘shellè¿™æ ·å‘½åæ˜¯å› ä¸ºä¸åŒäºå…¶ä»–é…ç½®ï¼Œè¿™é‡ŒæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ç”±å®¢æˆ·æä¾›çš„æœåŠ¡ã€‚</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -l 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œç®€å•åœ°å‘Šè¯‰netcatåœ¨è¿æ¥å®Œæˆåï¼Œæ‰§è¡Œshell</p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc 192.168.10.10 10010 -e /bin/bash</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç°åœ¨ï¼Œä»€ä¹ˆæ˜¯åå‘shellçš„ç‰¹åˆ«ä¹‹å¤„å‘¢ </p><p>åå‘shellç»å¸¸è¢«ç”¨æ¥ç»•è¿‡é˜²ç«å¢™çš„é™åˆ¶ï¼Œå¦‚é˜»æ­¢å…¥ç«™è¿æ¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘æœ‰ä¸€ä¸ªä¸“ç”¨IPåœ°å€ä¸º192.168.10.10ï¼Œæˆ‘ä½¿ç”¨ä»£ç†æœåŠ¡å™¨è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œã€‚å¦‚æœæˆ‘æƒ³ä»ç½‘ç»œå¤–éƒ¨è®¿é—® è¿™å°æœºå™¨å¦‚10.1.1.10çš„shellï¼Œé‚£ä¹ˆæˆ‘ä¼šç”¨åå‘å¤–å£³ç”¨äºè¿™ä¸€ç›®çš„ã€‚ </p><h4 id="å…‹éš†è®¾å¤‡"><a href="#å…‹éš†è®¾å¤‡" class="headerlink" title="å…‹éš†è®¾å¤‡"></a>å…‹éš†è®¾å¤‡</h4><p>å¦‚æœä½ å·²ç»å®‰è£…é…ç½®ä¸€å°Linuxæœºå™¨å¹¶ä¸”éœ€è¦é‡å¤åŒæ ·çš„æ“ä½œå¯¹å…¶ä»–çš„æœºå™¨ï¼Œè€Œä½ ä¸æƒ³åœ¨é‡å¤é…ç½®ä¸€éã€‚ä¸åœ¨éœ€è¦é‡å¤é…ç½®å®‰è£…çš„è¿‡ç¨‹ï¼Œåªå¯åŠ¨å¦ä¸€å°æœºå™¨çš„ä¸€äº›å¼•å¯¼å¯ä»¥éšèº«ç¢Ÿå’Œå…‹éš†ä½ çš„æœºå™¨ã€‚</p><p>å…‹éš†Linux PCå¾ˆç®€å•ï¼Œå‡å¦‚ä½ çš„ç³»ç»Ÿåœ¨ç£ç›˜/dev/sdaä¸Š</p><p>Server<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/sda | nc -l 10010</span><br></pre></td></tr></tbody></table></figure><p></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œç®€å•åœ°å‘Šè¯‰netcatåœ¨è¿æ¥å®Œæˆåï¼Œæ‰§è¡Œshell</p><p>Client<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -n 192.168.10.10 10010 | dd of=/dev/sda</span><br></pre></td></tr></tbody></table></figure><p></p><p>ddæ˜¯ä¸€ä¸ªä»ç£ç›˜è¯»å–åŸå§‹æ•°æ®çš„å·¥å…·ï¼Œæˆ‘é€šè¿‡netcatæœåŠ¡å™¨é‡å®šå‘å®ƒçš„è¾“å‡ºæµåˆ°å…¶ä»–æœºå™¨å¹¶ä¸”å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œå®ƒä¼šéšç€åˆ†åŒºè¡¨æ‹·è´æ‰€æœ‰çš„ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬å·²ç»åšè¿‡åˆ†åŒºå¹¶ä¸”åªéœ€è¦å…‹éš†rootåˆ†åŒºï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬ç³»ç»Ÿrootåˆ†åŒºçš„ä½ç½®ï¼Œæ›´æ”¹sda ä¸ºsda1ï¼Œsda2.ç­‰ç­‰ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://netcat.sourceforge.net/&quot; target=&quot;_blank&quot; rel=&quot;noopener
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>é˜²æ­¢ rm -rf è¯¯åˆ å¸¦æ¥çš„ç¾éš¾</title>
    <link href="https://jiemin.wang/2019/03/20/trash-cli/"/>
    <id>https://jiemin.wang/2019/03/20/trash-cli/</id>
    <published>2019-03-20T09:42:01.000Z</published>
    <updated>2019-03-20T10:04:37.894Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h4 id="æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm-rf-è¿™ç§æ“ä½œï¼Œå¤ªå±é™©äº†ã€‚ä¸ºä»€ä¹ˆä¸å­¦å­¦Ubuntu-MacOSç­‰ç³»ç»Ÿæœ‰ä¸€ä¸ªå›æ”¶ç«™ï¼Œåˆ é™¤äº†å¯ä»¥å»å›æ”¶ç«™é‡Œé¢æ‰¾ã€‚ç»è¿‡æŠ˜è…¾ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…·-trash-cliã€‚"><a href="#æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm-rf-è¿™ç§æ“ä½œï¼Œå¤ªå±é™©äº†ã€‚ä¸ºä»€ä¹ˆä¸å­¦å­¦Ubuntu-MacOSç­‰ç³»ç»Ÿæœ‰ä¸€ä¸ªå›æ”¶ç«™ï¼Œåˆ é™¤äº†å¯ä»¥å»å›æ”¶ç«™é‡Œé¢æ‰¾ã€‚ç»è¿‡æŠ˜è…¾ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…·-trash-cliã€‚" class="headerlink" title="æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm -rf è¿™ç§æ“ä½œï¼Œå¤ªå±é™©äº†ã€‚ä¸ºä»€ä¹ˆä¸å­¦å­¦Ubuntu/MacOSç­‰ç³»ç»Ÿæœ‰ä¸€ä¸ªå›æ”¶ç«™ï¼Œåˆ é™¤äº†å¯ä»¥å»å›æ”¶ç«™é‡Œé¢æ‰¾ã€‚ç»è¿‡æŠ˜è…¾ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…· trash-cliã€‚"></a>æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm -rf è¿™ç§æ“ä½œï¼Œå¤ªå±é™©äº†ã€‚ä¸ºä»€ä¹ˆä¸å­¦å­¦Ubuntu/MacOSç­‰ç³»ç»Ÿæœ‰ä¸€ä¸ªå›æ”¶ç«™ï¼Œåˆ é™¤äº†å¯ä»¥å»å›æ”¶ç«™é‡Œé¢æ‰¾ã€‚ç»è¿‡æŠ˜è…¾ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…· trash-cliã€‚</h4><h4 id="trash-cliæ˜¯ä¸€ä¸ªä½¿ç”¨-python-å¼€å‘çš„è½¯ä»¶åŒ…ï¼Œtrash-cli-trashesè®°å½•åŸå§‹è·¯å¾„ï¼Œåˆ é™¤æ—¥æœŸå’Œæƒé™çš„æ–‡ä»¶ã€‚å®ƒä½¿ç”¨KDEï¼ŒGNOMEå’ŒXFCEä½¿ç”¨çš„ç›¸åŒåƒåœ¾æ¡¶ï¼Œä½†æ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œï¼ˆå’Œè„šæœ¬ï¼‰è°ƒç”¨å®ƒã€‚åŒ…å«"><a href="#trash-cliæ˜¯ä¸€ä¸ªä½¿ç”¨-python-å¼€å‘çš„è½¯ä»¶åŒ…ï¼Œtrash-cli-trashesè®°å½•åŸå§‹è·¯å¾„ï¼Œåˆ é™¤æ—¥æœŸå’Œæƒé™çš„æ–‡ä»¶ã€‚å®ƒä½¿ç”¨KDEï¼ŒGNOMEå’ŒXFCEä½¿ç”¨çš„ç›¸åŒåƒåœ¾æ¡¶ï¼Œä½†æ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œï¼ˆå’Œè„šæœ¬ï¼‰è°ƒç”¨å®ƒã€‚åŒ…å«" class="headerlink" title="trash-cliæ˜¯ä¸€ä¸ªä½¿ç”¨ python å¼€å‘çš„è½¯ä»¶åŒ…ï¼Œtrash-cli trashesè®°å½•åŸå§‹è·¯å¾„ï¼Œåˆ é™¤æ—¥æœŸå’Œæƒé™çš„æ–‡ä»¶ã€‚å®ƒä½¿ç”¨KDEï¼ŒGNOMEå’ŒXFCEä½¿ç”¨çš„ç›¸åŒåƒåœ¾æ¡¶ï¼Œä½†æ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œï¼ˆå’Œè„šæœ¬ï¼‰è°ƒç”¨å®ƒã€‚åŒ…å«:"></a><a href="https://github.com/andreafrancia/trash-cli" target="_blank" rel="noopener">trash-cli</a>æ˜¯ä¸€ä¸ªä½¿ç”¨ python å¼€å‘çš„è½¯ä»¶åŒ…ï¼Œtrash-cli trashesè®°å½•åŸå§‹è·¯å¾„ï¼Œåˆ é™¤æ—¥æœŸå’Œæƒé™çš„æ–‡ä»¶ã€‚å®ƒä½¿ç”¨KDEï¼ŒGNOMEå’ŒXFCEä½¿ç”¨çš„ç›¸åŒåƒåœ¾æ¡¶ï¼Œä½†æ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œï¼ˆå’Œè„šæœ¬ï¼‰è°ƒç”¨å®ƒã€‚åŒ…å«:</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* trash-put           trash files and directories.</span><br><span class="line">* trash-empty         empty the trashcan(s).</span><br><span class="line">* trash-list          list trashed files.</span><br><span class="line">* trash-restore       restore a trashed file.</span><br><span class="line">* trash-rm            remove individual files from the trashcan.</span><br></pre></td></tr></tbody></table></figure><h2 id="trash-cli-å®‰è£…"><a href="#trash-cli-å®‰è£…" class="headerlink" title="trash-cli å®‰è£…"></a>trash-cli å®‰è£…</h2><h4 id="The-easy-way"><a href="#The-easy-way" class="headerlink" title="The easy way"></a>The easy way</h4><h5 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements:"></a>Requirements:</h5><blockquote><p>Python 2.7 or Python 3<br>  setuptools (use apt-get install python-setuptools on Debian)</p></blockquote><p>Installation command:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">easy_install trash-cli</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="From-sources"><a href="#From-sources" class="headerlink" title="From sources"></a>From sources</h4><h5 id="System-wide-installation"><a href="#System-wide-installation" class="headerlink" title="System-wide installation:"></a>System-wide installation:</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/andreafrancia/trash-cli.git</span><br><span class="line"><span class="built_in">cd</span> trash-cli</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></tbody></table></figure><h5 id="User-only-installation"><a href="#User-only-installation" class="headerlink" title="User-only installation:"></a>User-only installation:</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/andreafrancia/trash-cli.git</span><br><span class="line"><span class="built_in">cd</span> trash-cli</span><br><span class="line">python setup.py install --user</span><br></pre></td></tr></tbody></table></figure><h2 id="trash-cli-å‘½ä»¤"><a href="#trash-cli-å‘½ä»¤" class="headerlink" title="trash-cli å‘½ä»¤"></a>trash-cli å‘½ä»¤</h2><h4 id="æŸ¥çœ‹å®‰è£…æˆåŠŸä¹‹åçš„å‘½ä»¤"><a href="#æŸ¥çœ‹å®‰è£…æˆåŠŸä¹‹åçš„å‘½ä»¤" class="headerlink" title="æŸ¥çœ‹å®‰è£…æˆåŠŸä¹‹åçš„å‘½ä»¤"></a>æŸ¥çœ‹å®‰è£…æˆåŠŸä¹‹åçš„å‘½ä»¤</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ll /usr/bin/ | grep trash</span></span><br><span class="line">-rwxr-xr-x    1 root root         123 Feb  2 17:43 trash</span><br><span class="line">-rwxr-xr-x    1 root root         125 Feb  2 17:43 trash-empty</span><br><span class="line">-rwxr-xr-x    1 root root         124 Feb  2 17:43 trash-list</span><br><span class="line">-rwxr-xr-x    1 root root         123 Feb  2 17:43 trash-put</span><br><span class="line">-rwxr-xr-x    1 root root         127 Feb  2 17:43 trash-restore</span><br><span class="line">-rwxr-xr-x    1 root root         122 Feb  2 17:43 trash-rm</span><br></pre></td></tr></tbody></table></figure><h6 id="åŠŸèƒ½è¯´æ˜ï¼š"><a href="#åŠŸèƒ½è¯´æ˜ï¼š" class="headerlink" title="åŠŸèƒ½è¯´æ˜ï¼š"></a>åŠŸèƒ½è¯´æ˜ï¼š</h6><ul><li>trash-put     å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å›æ”¶ç«™</li><li>trash-empty   æ¸…ç©ºå›æ”¶ç«™</li><li>trash-list    åˆ—å‡ºå›æ”¶ç«™ä¸­çš„æ–‡ä»¶</li><li>trash-restore è¿˜åŸå›æ”¶ç«™ä¸­çš„æ–‡ä»¶</li><li>trash-rm      åˆ é™¤å›é¦–ç«™ä¸­çš„å•ä¸ªæ–‡ä»¶</li></ul><h6 id="ç”¨å®ƒæ›¿ä»£-rmå‘½ä»¤"><a href="#ç”¨å®ƒæ›¿ä»£-rmå‘½ä»¤" class="headerlink" title="ç”¨å®ƒæ›¿ä»£ rmå‘½ä»¤"></a>ç”¨å®ƒæ›¿ä»£ rmå‘½ä»¤</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim .bashrc </span></span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"><span class="comment">#alias rm='rm -i'</span></span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">'trash-put'</span></span><br></pre></td></tr></tbody></table></figure><h2 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h2><h4 id="åˆ é™¤æµ‹è¯•ï¼š"><a href="#åˆ é™¤æµ‹è¯•ï¼š" class="headerlink" title="åˆ é™¤æµ‹è¯•ï¼š"></a>åˆ é™¤æµ‹è¯•ï¼š</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -rf dump.sql</span></span><br><span class="line"><span class="comment"># ll ~/.local/share/Trash/files </span></span><br><span class="line">-rw-r--r-- 1 root root 123 Jul 17  2018 dump.sql</span><br><span class="line"> </span><br><span class="line"><span class="comment"># trash-list</span></span><br><span class="line">2019-02-02 18:02:33 /root/dump.sql</span><br></pre></td></tr></tbody></table></figure><h4 id="è¿˜åŸåˆ é™¤çš„æ–‡ä»¶"><a href="#è¿˜åŸåˆ é™¤çš„æ–‡ä»¶" class="headerlink" title="è¿˜åŸåˆ é™¤çš„æ–‡ä»¶"></a>è¿˜åŸåˆ é™¤çš„æ–‡ä»¶</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trash-restore /root/dump.rdb</span></span><br><span class="line">   0 2019-02-02 18:01:08 /root/dump.sql.bak</span><br><span class="line">   1 2019-02-02 18:02:33 /root/dump.sql</span><br><span class="line">What file to restore [0..1]: 1</span><br><span class="line"></span><br><span class="line">è¿˜åŸæˆåŠŸ</span><br><span class="line"><span class="comment"># ll /root/dump.rdb </span></span><br><span class="line">-rw-r--r-- 1 root root 123 Jul 17  2018 /root/dump.sql</span><br></pre></td></tr></tbody></table></figure><h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><h4 id="trash-putå‘½ä»¤ä¼šæŠŠæˆ‘ä»¬æƒ³è¦åˆ é™¤çš„æ–‡ä»¶ç§»åŠ¨åˆ°-local-share-Trash-files-ä¸­ã€‚ç›¸å…³ä¿¡æ¯è®°å½•åœ¨-local-share-Trash-infoä¸­ã€‚"><a href="#trash-putå‘½ä»¤ä¼šæŠŠæˆ‘ä»¬æƒ³è¦åˆ é™¤çš„æ–‡ä»¶ç§»åŠ¨åˆ°-local-share-Trash-files-ä¸­ã€‚ç›¸å…³ä¿¡æ¯è®°å½•åœ¨-local-share-Trash-infoä¸­ã€‚" class="headerlink" title="trash-putå‘½ä»¤ä¼šæŠŠæˆ‘ä»¬æƒ³è¦åˆ é™¤çš„æ–‡ä»¶ç§»åŠ¨åˆ°~/.local/share/Trash/files ä¸­ã€‚ç›¸å…³ä¿¡æ¯è®°å½•åœ¨~/.local/share/Trash/infoä¸­ã€‚"></a>trash-putå‘½ä»¤ä¼šæŠŠæˆ‘ä»¬æƒ³è¦åˆ é™¤çš„æ–‡ä»¶ç§»åŠ¨åˆ°~/.local/share/Trash/files ä¸­ã€‚ç›¸å…³ä¿¡æ¯è®°å½•åœ¨~/.local/share/Trash/infoä¸­ã€‚</h4><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;h4 id=&quot;æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm-rf-è¿™ç§æ“
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouse-sync-to-MySQLDate</title>
    <link href="https://jiemin.wang/2019/03/20/ClickHouse-sync-to-MySQLDate/"/>
    <id>https://jiemin.wang/2019/03/20/ClickHouse-sync-to-MySQLDate/</id>
    <published>2019-03-20T02:27:04.000Z</published>
    <updated>2019-03-20T03:45:10.206Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul><li>ClickHouse è¿™æ¬¾äº§å“å¤§å®¶éƒ½å¬è¯´è¿‡å¾ˆå¿«ï¼Œä½†æ˜¯åˆ°åº•æœ‰å¤šææ€–ï¼Ÿ</li><li>ClickHouse åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ClickHouseæœ€åˆæ˜¯ä¸º Yandex.Metrica ä¸–ç•Œç¬¬äºŒå¤§Webåˆ†æå¹³å° è€Œå¼€å‘çš„ã€‚å¤šå¹´æ¥ä¸€ç›´ä½œä¸ºè¯¥ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶è¢«è¯¥ç³»ç»ŸæŒç»­ä½¿ç”¨ç€ã€‚ç›®å‰ä¸ºæ­¢ï¼Œè¯¥ç³»ç»Ÿåœ¨ClickHouseä¸­æœ‰è¶…è¿‡13ä¸‡äº¿æ¡è®°å½•ï¼Œå¹¶ä¸”æ¯å¤©è¶…è¿‡200å¤šäº¿ä¸ªäº‹ä»¶è¢«å¤„ç†ã€‚å®ƒå…è®¸ç›´æ¥ä»åŸå§‹æ•°æ®ä¸­åŠ¨æ€æŸ¥è¯¢å¹¶ç”ŸæˆæŠ¥å‘Šã€‚æœ¬æ–‡ç®€è¦ä»‹ç»äº†ClickHouseåœ¨å…¶æ—©æœŸå‘å±•é˜¶æ®µçš„ç›®æ ‡ã€‚</p><p>Yandex.MetricaåŸºäºç”¨æˆ·å®šä¹‰çš„å­—æ®µï¼Œå¯¹å®æ—¶è®¿é—®ã€è¿æ¥ä¼šè¯ï¼Œç”Ÿæˆå®æ—¶çš„ç»Ÿè®¡æŠ¥è¡¨ã€‚è¿™ç§éœ€æ±‚å¾€å¾€éœ€è¦å¤æ‚èšåˆæ–¹å¼ï¼Œæ¯”å¦‚å¯¹è®¿é—®ç”¨æˆ·è¿›è¡Œå»é‡ã€‚æ„å»ºæŠ¥è¡¨çš„æ•°æ®ï¼Œæ˜¯å®æ—¶æ¥æ”¶å­˜å‚¨çš„æ–°æ•°æ®ã€‚</p><p>æˆªè‡³2014å¹´4æœˆï¼ŒYandex.Metricaæ¯å¤©è·Ÿè¸ªå¤§çº¦120äº¿ä¸ªäº‹ä»¶ï¼ˆç”¨æˆ·çš„ç‚¹å‡»å’Œæµè§ˆï¼‰ã€‚ä¸ºäº†å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„æŠ¥è¡¨ï¼Œæˆ‘ä»¬å¿…é¡»å­˜å‚¨å…¨éƒ¨è¿™äº›äº‹ä»¶ã€‚åŒæ—¶ï¼Œè¿™äº›æŸ¥è¯¢å¯èƒ½éœ€è¦åœ¨å‡ ç™¾æ¯«ç§’å†…æ‰«ææ•°ç™¾ä¸‡è¡Œçš„æ•°æ®ï¼Œæˆ–åœ¨å‡ ç§’å†…æ‰«ææ•°äº¿è¡Œçš„æ•°æ®ã€‚</p><h4 id="ä»€ä¹ˆæ˜¯ClickHouse"><a href="#ä»€ä¹ˆæ˜¯ClickHouse" class="headerlink" title="ä»€ä¹ˆæ˜¯ClickHouse ?"></a><strong>ä»€ä¹ˆæ˜¯ClickHouse ?</strong></h4><p>ClickHouse æ˜¯é¢å‘ OLAP çš„åˆ†å¸ƒå¼åˆ—å¼ DBMS.</p><h4 id="ClickHouseçš„æ˜¾è‘—ç‰¹æ€§"><a href="#ClickHouseçš„æ˜¾è‘—ç‰¹æ€§" class="headerlink" title="ClickHouseçš„æ˜¾è‘—ç‰¹æ€§"></a>ClickHouseçš„æ˜¾è‘—ç‰¹æ€§</h4><ul><li>çœŸæ­£çš„é¢å‘åˆ—çš„DBMS</li><li>æ•°æ®é«˜æ•ˆå‹ç¼©</li><li>ç£ç›˜å­˜å‚¨çš„æ•°æ®</li><li>å¤šæ ¸å¹¶è¡Œå¤„ç†</li></ul><ul><li>åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šåˆ†å¸ƒå¼å¤„ç†<ul><li>SQLè¯­æ³•æ”¯æŒ</li></ul></li></ul><ul><li>å‘é‡åŒ–å¼•æ“</li><li>å®æ—¶æ•°æ®æ›´æ–°</li><li>ç´¢å¼•</li><li>é€‚åˆåœ¨çº¿æŸ¥è¯¢</li><li>æ”¯æŒè¿‘ä¼¼é¢„ä¼°è®¡ç®—</li><li>æ”¯æŒåµŒå¥—çš„æ•°æ®ç»“æ„</li><li>æ”¯æŒæ•°ç»„ä½œä¸ºæ•°æ®ç±»å‹</li><li>æ”¯æŒé™åˆ¶æŸ¥è¯¢å¤æ‚æ€§ä»¥åŠé…é¢</li><li>å¤åˆ¶æ•°æ®å¤åˆ¶å’Œå¯¹æ•°æ®å®Œæ•´æ€§çš„æ”¯æŒ</li></ul><h4 id="OLAPåœºæ™¯çš„å…³é”®ç‰¹å¾"><a href="#OLAPåœºæ™¯çš„å…³é”®ç‰¹å¾" class="headerlink" title="OLAPåœºæ™¯çš„å…³é”®ç‰¹å¾"></a>OLAPåœºæ™¯çš„å…³é”®ç‰¹å¾</h4><ul><li>å¤§å¤šæ•°æ˜¯è¯»è¯·æ±‚</li><li>æ•°æ®æ€»æ˜¯ä»¥ç›¸å½“å¤§çš„æ‰¹(> 1000 rows)è¿›è¡Œå†™å…¥</li><li>ä¸ä¿®æ”¹å·²æ·»åŠ çš„æ•°æ®</li><li>æ¯æ¬¡æŸ¥è¯¢éƒ½ä»æ•°æ®åº“ä¸­è¯»å–å¤§é‡çš„è¡Œï¼Œä½†æ˜¯åŒæ—¶åˆä»…éœ€è¦å°‘é‡çš„åˆ—</li><li>å®½è¡¨ï¼Œå³æ¯ä¸ªè¡¨åŒ…å«ç€å¤§é‡çš„åˆ—</li><li>è¾ƒå°‘çš„æŸ¥è¯¢(é€šå¸¸æ¯å°æœåŠ¡å™¨æ¯ç§’æ•°ç™¾ä¸ªæŸ¥è¯¢æˆ–æ›´å°‘)</li><li>å¯¹äºç®€å•æŸ¥è¯¢ï¼Œå…è®¸å»¶è¿Ÿå¤§çº¦50æ¯«ç§’</li><li>åˆ—ä¸­çš„æ•°æ®ç›¸å¯¹è¾ƒå°ï¼š æ•°å­—å’ŒçŸ­å­—ç¬¦ä¸²(ä¾‹å¦‚ï¼Œæ¯ä¸ªURL 60ä¸ªå­—èŠ‚)</li><li>å¤„ç†å•ä¸ªæŸ¥è¯¢æ—¶éœ€è¦é«˜ååé‡ï¼ˆæ¯ä¸ªæœåŠ¡å™¨æ¯ç§’é«˜è¾¾æ•°åäº¿è¡Œï¼‰</li><li>äº‹åŠ¡ä¸æ˜¯å¿…é¡»çš„</li><li>å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä½</li><li>æ¯ä¸€ä¸ªæŸ¥è¯¢é™¤äº†ä¸€ä¸ªå¤§è¡¨å¤–éƒ½å¾ˆå°</li><li>æŸ¥è¯¢ç»“æœæ˜æ˜¾å°äºæºæ•°æ®ï¼Œæ¢å¥è¯è¯´ï¼Œæ•°æ®è¢«è¿‡æ»¤æˆ–èšåˆåèƒ½å¤Ÿè¢«ç››æ”¾åœ¨å•å°æœåŠ¡å™¨çš„å†…å­˜ä¸­</li></ul><h4 id="åˆ—å¼æ•°æ®åº“æ›´é€‚åˆOLAPåœºæ™¯çš„åŸå› "><a href="#åˆ—å¼æ•°æ®åº“æ›´é€‚åˆOLAPåœºæ™¯çš„åŸå› " class="headerlink" title="åˆ—å¼æ•°æ®åº“æ›´é€‚åˆOLAPåœºæ™¯çš„åŸå› "></a>åˆ—å¼æ•°æ®åº“æ›´é€‚åˆOLAPåœºæ™¯çš„åŸå› </h4><p>åˆ—å¼æ•°æ®åº“æ›´é€‚åˆäºOLAPåœºæ™¯(å¯¹äºå¤§å¤šæ•°æŸ¥è¯¢è€Œè¨€ï¼Œå¤„ç†é€Ÿåº¦è‡³å°‘æé«˜äº†100å€)ï¼Œä¸‹é¢è¯¦ç»†è§£é‡Šäº†åŸå› (é€šè¿‡å›¾ç‰‡æ›´æœ‰åˆ©äºç›´è§‚ç†è§£)ï¼š<br>è¡Œå¼<br><img src="/2019/03/20/ClickHouse-sync-to-MySQLDate/row_oriented.gif" title="row_oriented"><br>åˆ—å¼<br><img src="/2019/03/20/ClickHouse-sync-to-MySQLDate/column_oriented.gif" title="column_oriented"><br>çœ‹åˆ°å·®åˆ«äº†ä¹ˆï¼Ÿä¸‹é¢å°†è¯¦ç»†ä»‹ç»ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚<br>1.é’ˆå¯¹åˆ†æç±»æŸ¥è¯¢ï¼Œé€šå¸¸åªéœ€è¦è¯»å–è¡¨çš„ä¸€å°éƒ¨åˆ†åˆ—ã€‚åœ¨åˆ—å¼æ•°æ®åº“ä¸­ä½ å¯ä»¥åªè¯»å–ä½ éœ€è¦çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåªéœ€è¦è¯»å–100åˆ—ä¸­çš„5åˆ—ï¼Œè¿™å°†å¸®åŠ©ä½ æœ€å°‘å‡å°‘20å€çš„I/Oæ¶ˆè€—ã€‚<br>2.ç”±äºæ•°æ®æ€»æ˜¯æ‰“åŒ…æˆæ‰¹é‡è¯»å–çš„ï¼Œæ‰€ä»¥å‹ç¼©æ˜¯éå¸¸å®¹æ˜“çš„ã€‚åŒæ—¶æ•°æ®æŒ‰åˆ—åˆ†åˆ«å­˜å‚¨è¿™ä¹Ÿæ›´å®¹æ˜“å‹ç¼©ã€‚è¿™è¿›ä¸€æ­¥é™ä½äº†I/Oçš„ä½“ç§¯ã€‚<br>3.ç”±äºI/Oçš„é™ä½ï¼Œè¿™å°†å¸®åŠ©æ›´å¤šçš„æ•°æ®è¢«ç³»ç»Ÿç¼“å­˜ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ clickhouse-client</span><br><span class="line">ClickHouse client version 0.0.52053.</span><br><span class="line">Connecting to localhost:9000.</span><br><span class="line">Connected to ClickHouse server version 0.0.52053.</span><br><span class="line"></span><br><span class="line">:) SELECT CounterID, count() FROM hits GROUP BY CounterID ORDER BY count() DESC LIMIT 20</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">    CounterID,</span><br><span class="line">    count()</span><br><span class="line">FROM hits</span><br><span class="line">GROUP BY CounterID</span><br><span class="line">ORDER BY count() DESC</span><br><span class="line">LIMIT 20</span><br><span class="line"></span><br><span class="line">â”Œâ”€CounterIDâ”€â”¬â”€â”€count()â”€â”</span><br><span class="line">â”‚    114208 â”‚ 56057344 â”‚</span><br><span class="line">â”‚    115080 â”‚ 51619590 â”‚</span><br><span class="line">â”‚      3228 â”‚ 44658301 â”‚</span><br><span class="line">â”‚     38230 â”‚ 42045932 â”‚</span><br><span class="line">â”‚    145263 â”‚ 42042158 â”‚</span><br><span class="line">â”‚     91244 â”‚ 38297270 â”‚</span><br><span class="line">â”‚    154139 â”‚ 26647572 â”‚</span><br><span class="line">â”‚    150748 â”‚ 24112755 â”‚</span><br><span class="line">â”‚    242232 â”‚ 21302571 â”‚</span><br><span class="line">â”‚    338158 â”‚ 13507087 â”‚</span><br><span class="line">â”‚     62180 â”‚ 12229491 â”‚</span><br><span class="line">â”‚     82264 â”‚ 12187441 â”‚</span><br><span class="line">â”‚    232261 â”‚ 12148031 â”‚</span><br><span class="line">â”‚    146272 â”‚ 11438516 â”‚</span><br><span class="line">â”‚    168777 â”‚ 11403636 â”‚</span><br><span class="line">â”‚   4120072 â”‚ 11227824 â”‚</span><br><span class="line">â”‚  10938808 â”‚ 10519739 â”‚</span><br><span class="line">â”‚     74088 â”‚  9047015 â”‚</span><br><span class="line">â”‚    115079 â”‚  8837972 â”‚</span><br><span class="line">â”‚    337234 â”‚  8205961 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span>. Elapsed: 0.153 sec. Processed 1.00 billion rows, 4.00 GB (6.53 billion rows/s., 26.10 GB/s.)</span><br><span class="line"></span><br><span class="line">:)</span><br></pre></td></tr></tbody></table></figure><h4 id="ClickHouse-SQL"><a href="#ClickHouse-SQL" class="headerlink" title="ClickHouse SQL"></a>ClickHouse SQL</h4><p>Creating a Table<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1],</span><br><span class="line">    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,</span><br><span class="line">    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2</span><br><span class="line">) ENGINE = MergeTree()</span><br><span class="line">[PARTITION BY expr]</span><br><span class="line">[ORDER BY expr]</span><br><span class="line">[PRIMARY KEY expr]</span><br><span class="line">[SAMPLE BY expr]</span><br><span class="line">[SETTINGS name=value, ...]</span><br></pre></td></tr></tbody></table></figure><p></p><p>Example of sections setting<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENGINE MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER BY (CounterID, EventDate, intHash32(UserID)) SAMPLE BY intHash32(UserID) SETTINGS index_granularity=8192</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="MySQL-æ•°æ®å¯¼å…¥æµ‹è¯•"><a href="#MySQL-æ•°æ®å¯¼å…¥æµ‹è¯•" class="headerlink" title="MySQL æ•°æ®å¯¼å…¥æµ‹è¯•"></a>MySQL æ•°æ®å¯¼å…¥æµ‹è¯•</h2><h4 id="æµ‹è¯•ä¸€"><a href="#æµ‹è¯•ä¸€" class="headerlink" title="æµ‹è¯•ä¸€"></a>æµ‹è¯•ä¸€</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># duå‡ºçš„è¡¨å¤§å°</span></span><br><span class="line">5.5G    test_1.ibd</span><br><span class="line"><span class="comment"># ClickHouseæ“ä½œè¯­å¥</span></span><br><span class="line">CREATE TABLE test_1</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">ORDER BY id AS</span><br><span class="line">SELECT *</span><br><span class="line">FROM mysql(<span class="string">'host:port'</span>, <span class="string">'dbtest'</span>, <span class="string">'test_1'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>) </span><br><span class="line"><span class="comment"># è€—æ—¶å’Œå¹³å‡é€Ÿåº¦</span></span><br><span class="line">0 rows <span class="keyword">in</span> <span class="built_in">set</span>. Elapsed: 137.251 sec. Processed 18.59 million rows, 7.34 GB (135.43 thousand rows/s., 53.48 MB/s.)</span><br></pre></td></tr></tbody></table></figure><h4 id="æµ‹è¯•äºŒ"><a href="#æµ‹è¯•äºŒ" class="headerlink" title="æµ‹è¯•äºŒ"></a>æµ‹è¯•äºŒ</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦ä¸€ä¸ªè¡¨</span></span><br><span class="line">20G     test_2.ibd</span><br><span class="line">CREATE TABLE test_2</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">ORDER BY id AS</span><br><span class="line">SELECT *</span><br><span class="line">FROM mysql(<span class="string">'host:port'</span>, <span class="string">'dbtest'</span>, <span class="string">'test_2'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>) </span><br><span class="line"><span class="comment"># ä¸çŸ¥é“ä¸ºå•¥è¿™è¡¨è¿™ä¹ˆå¿«å°±å¯¼å…¥äº† è²Œä¼¼æ˜¯è¡Œå°‘ï¼Œä½†æ˜¯è¡¨çš„æ€»å¤§å°å¤§å•Š</span></span><br><span class="line">0 rows <span class="keyword">in</span> <span class="built_in">set</span>. Elapsed: 44.389 sec. Processed 13.03 million rows, 1.44 GB (293.44 thousand rows/s., 32.35 MB/s.)</span><br></pre></td></tr></tbody></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://clickhouse.yandex/docs/zh/" target="_blank" rel="noopener">ClickHouse å®˜æ–¹èµ„æ–™</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ClickHouse è¿™æ¬¾äº§å“å¤§å®¶éƒ½å¬è¯´è¿‡å¾ˆå¿«ï¼Œä½†æ˜¯åˆ°åº•æœ‰å¤šææ€–ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ClickHouse åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/li
      
    
    </summary>
    
      <category term="ClickHouse" scheme="https://jiemin.wang/categories/ClickHouse/"/>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/ClickHouse/MySQL/"/>
    
    
      <category term="ClickHouse" scheme="https://jiemin.wang/tags/ClickHouse/"/>
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>disk cache policy in RAID</title>
    <link href="https://jiemin.wang/2019/03/11/disk-cache-policy-in-RAID/"/>
    <id>https://jiemin.wang/2019/03/11/disk-cache-policy-in-RAID/</id>
    <published>2019-03-11T13:33:12.000Z</published>
    <updated>2019-03-11T13:39:43.204Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><h4 id="è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs-errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ-ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œå‘Šè¯‰å®¢æˆ·æ•°æ®æ¢å¤å›æ¥äº†ã€‚"><a href="#è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs-errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ-ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œå‘Šè¯‰å®¢æˆ·æ•°æ®æ¢å¤å›æ¥äº†ã€‚" class="headerlink" title="è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œå‘Šè¯‰å®¢æˆ·æ•°æ®æ¢å¤å›æ¥äº†ã€‚"></a>è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œå‘Šè¯‰å®¢æˆ·æ•°æ®æ¢å¤å›æ¥äº†ã€‚</h4><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><h4 id="é¦–å…ˆï¼ŒRAIDçš„write-policyåˆ†æˆä¸¤ç§ï¼š"><a href="#é¦–å…ˆï¼ŒRAIDçš„write-policyåˆ†æˆä¸¤ç§ï¼š" class="headerlink" title="é¦–å…ˆï¼ŒRAIDçš„write policyåˆ†æˆä¸¤ç§ï¼š"></a>é¦–å…ˆï¼ŒRAIDçš„write policyåˆ†æˆä¸¤ç§ï¼š</h4><ul><li>write back</li><li>write through</li></ul><p>ä¸€ç§æ¨¡å¼æ˜¯write backä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å› ä¸ºåœ¨write backæ¨¡å¼ä¸‹ï¼Œæ•°æ®å†™å…¥Controller Cacheï¼Œå°±è®¤ä¸ºWrite IOç»“æŸäº†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å†™å…¥Hard driverã€‚è¿™ç§æ¨¡å¼å¾ˆæ˜æ˜¾å­˜åœ¨å®‰å…¨éšæ‚£ï¼Œå¼‚å¸¸æ‰ç”µæƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å¼•èµ·æ•°æ®ä¸¢å¤±ã€‚</p><p>å¦ä¸€ç§æ¨¡å¼æ˜¯write throughï¼Œè¿™ç§æ¨¡å¼æ¯”è¾ƒè°¨æ…ï¼Œå®ƒå‹æ ¹ä¸ä½¿ç”¨Raid Cacheæ¥åŠ é€Ÿå†™æ“ä½œï¼Œå› æ­¤è¿™ç§æ¨¡å¼çš„æ€§èƒ½è¦æ¯”write back ä½ä¸å°‘ã€‚</p><p>ä½†æ˜¯write backçš„ä¸å®‰å…¨ä¹Ÿæ˜¯æœ‰åŠæ³•è§£å†³çš„ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ˜¯UPSâ€“Uninterruptible Power Supplyï¼Œè¿™ä¸ªæŒ‰ä¸‹ä¸æ</li><li>ç¬¬äºŒä¸ªæ–¹æ¡ˆæ˜¯BBUâ€“Backup Battery Unitï¼Œæœ‰äº†BBUï¼Œå°±å¯ä»¥å®‰å¿ƒåœ°é‡‡ç”¨write-backæ¨¡å¼äº†</li></ul><p>å¯¹BBUä¸å¤ªäº†è§£çš„ï¼Œå¯ä»¥é˜…è¯»[Barriers, Caches, Filesystems]ï¼Œä»‹ç»çš„éå¸¸å¥½</p><p>è®²å®Œäº†è¿™ä¸ªwrite policyï¼Œè¿˜æœ‰ä¸€ä¸ªä¸œä¸œå«disk cache policyï¼Œè¿™ä¸ªä¸œè¥¿ç”¨æ¥å†³å®šç£ç›˜ä¸€çº§çš„cacheæ˜¯å¦enableã€‚ ä¸€å®šè¦æ³¨æ„è¿™ä¸ªä¸œè¥¿ï¼Œæ— æ•°è¡€æ³ªéƒ½æ˜¯è¿™ä¸ªä¸œè¥¿å¼•èµ·çš„ã€‚</p><p>å¦‚æœé€‰æ‹©write throughæ¨¡å¼ï¼Œå³ä¸ä½¿ç”¨RAID cacheï¼Œè¿™ç§æƒ…å†µä¸‹disk cacheå¯¹æ€§èƒ½çš„æå‡æ˜¯å¾ˆå¤§çš„ã€‚ä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œä¹Ÿä¸è¦enable disk cacheï¼Œå› ä¸ºï¼Œä¼šæœ‰æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚å¦‚æœå¯èƒ½å¼‚å¸¸æ‰ç”µï¼Œé‚£ä¹ˆä¸€å®šä¸è¦enable disk cacheã€‚</p><h2 id="ç›¸å…³å‘½ä»¤"><a href="#ç›¸å…³å‘½ä»¤" class="headerlink" title="ç›¸å…³å‘½ä»¤"></a>ç›¸å…³å‘½ä»¤</h2><h4 id="æŸ¥çœ‹write-policy-å’Œ-disk-cache-policyçš„å‘½ä»¤å¦‚ä¸‹ï¼š"><a href="#æŸ¥çœ‹write-policy-å’Œ-disk-cache-policyçš„å‘½ä»¤å¦‚ä¸‹ï¼š" class="headerlink" title="æŸ¥çœ‹write policy å’Œ disk cache policyçš„å‘½ä»¤å¦‚ä¸‹ï¼š"></a>æŸ¥çœ‹write policy å’Œ disk cache policyçš„å‘½ä»¤å¦‚ä¸‹ï¼š</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aAll</span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Virtual Drive: 1 (Target Id: 1)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-5, Secondary-0, RAID Level Qualifier-3</span><br><span class="line">Size                : 25.466 TB</span><br><span class="line">Sector Size         : 512</span><br><span class="line">Is VD emulated      : No</span><br><span class="line">Parity Size         : 3.637 TB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : 128 KB</span><br><span class="line">Number Of Drives    : 8</span><br><span class="line">Span Depth          : 1</span><br><span class="line">Default Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disk<span class="string">'s Default</span></span><br><span class="line"><span class="string">Encryption Type     : None</span></span><br><span class="line"><span class="string">PI type: No PI</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Is VD Cached: No</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°Disk Cache Policy æ˜¯ Diskâ€™s Default ã€‚è¿™ä¸ªdefaultå€¼å¯ä»¥åˆ†æˆä»¥ä¸‹æƒ…å†µï¼š</p><ul><li>For virtual disks containing SATA disks ï¼Œ Enabled</li><li>For virtual disks containing SAS disks ï¼Œ Disabled</li></ul><p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å°†Disk Cache Policyçš„å€¼æ”¹æˆ Disable<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -DisDskCache -Immediate -Lall -aAll</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 0 (target id: 0) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 1 (target id: 1) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 2 (target id: 2) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 3 (target id: 3) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 4 (target id: 4) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 5 (target id: 5) success</span><br><span class="line">Set Disk Cache Policy to Disabled on Adapter 0, VD 6 (target id: 6) success</span><br><span class="line"></span><br><span class="line">Exit Code: 0x00</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ­¤æ—¶å†æ¬¡æŸ¥çœ‹è¾“å‡ºï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Virtual Drive: 1 (Target Id: 1)</span><br><span class="line">Name                :</span><br><span class="line">RAID Level          : Primary-5, Secondary-0, RAID Level Qualifier-3</span><br><span class="line">Size                : 25.466 TB</span><br><span class="line">Sector Size         : 512</span><br><span class="line">Is VD emulated      : No</span><br><span class="line">Parity Size         : 3.637 TB</span><br><span class="line">State               : Optimal</span><br><span class="line">Strip Size          : 128 KB</span><br><span class="line">Number Of Drives    : 8</span><br><span class="line">Span Depth          : 1</span><br><span class="line">Default Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Current Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache <span class="keyword">if</span> Bad BBU</span><br><span class="line">Default Access Policy: Read/Write</span><br><span class="line">Current Access Policy: Read/Write</span><br><span class="line">Disk Cache Policy   : Disabled</span><br><span class="line">Encryption Type     : None</span><br><span class="line">PI <span class="built_in">type</span>: No PI</span><br><span class="line"></span><br><span class="line">Is VD Cached: No</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ¨èè®¾ç½®"><a href="#æ¨èè®¾ç½®" class="headerlink" title="æ¨èè®¾ç½®"></a>æ¨èè®¾ç½®</h2><p>1.å•†ç”¨ç¯å¢ƒï¼ŒRAIDä¸€å®šè¦æœ‰BBU<br>2.write policy é‡‡ç”¨ write back<br>3.disk cache policy ä¸€å®šè¦ä¸ºdisable</p><p>è¿™ä¸ªæ¨èè®¾ç½®ï¼Œå’ŒIntelç»™å‡ºçš„ <a href="http://download.intel.com/support/motherboards/server/sb/configuring_raid_for_optimal_perfromance_11.pdf" target="_blank" rel="noopener">Configuring RAID For Optimal Performance</a> æ˜¯ä¸€è‡´çš„ï¼Œé™¤æ­¤ä»¥å¤–ï¼Œ<a href="https://www.thomas-krenn.com/en/wiki/RAID_Controller_and_Hard_Disk_Cache_Settings" target="_blank" rel="noopener">RAID Controller and Hard Disk Cache Settings</a>ä¹Ÿç»™å‡ºäº†ç±»ä¼¼çš„ç»“è®ºã€‚è¿™äº›éƒ½æ˜¯ä¸é”™çš„å‚è€ƒæ–‡çŒ®ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;h4 id=&quot;è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs-errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ-ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œ
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>check e2fsck progress realtime</title>
    <link href="https://jiemin.wang/2019/03/11/check-e2fsck-progress-realtime/"/>
    <id>https://jiemin.wang/2019/03/11/check-e2fsck-progress-realtime/</id>
    <published>2019-03-11T13:30:24.000Z</published>
    <updated>2019-03-11T13:31:59.698Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h4 id="å¯¹äºe2fsck-è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶éå¸¸ä¹…ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿›åº¦æ±‡æŠ¥æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¿®å¤å‡ ä¸ªå°æ—¶ï¼Œåˆæ²¡æœ‰è¿›åº¦æ±‡æŠ¥ï¼Œäººä¼šæŠ“ç‹‚çš„ã€‚"><a href="#å¯¹äºe2fsck-è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶éå¸¸ä¹…ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿›åº¦æ±‡æŠ¥æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¿®å¤å‡ ä¸ªå°æ—¶ï¼Œåˆæ²¡æœ‰è¿›åº¦æ±‡æŠ¥ï¼Œäººä¼šæŠ“ç‹‚çš„ã€‚" class="headerlink" title="å¯¹äºe2fsck è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶éå¸¸ä¹…ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿›åº¦æ±‡æŠ¥æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¿®å¤å‡ ä¸ªå°æ—¶ï¼Œåˆæ²¡æœ‰è¿›åº¦æ±‡æŠ¥ï¼Œäººä¼šæŠ“ç‹‚çš„ã€‚"></a>å¯¹äºe2fsck è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶éå¸¸ä¹…ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿›åº¦æ±‡æŠ¥æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¿®å¤å‡ ä¸ªå°æ—¶ï¼Œåˆæ²¡æœ‰è¿›åº¦æ±‡æŠ¥ï¼Œäººä¼šæŠ“ç‹‚çš„ã€‚</h4><h2 id="å®æ—¶æ£€æŸ¥-e2fsck-è¿›åº¦çš„æ–¹æ³•"><a href="#å®æ—¶æ£€æŸ¥-e2fsck-è¿›åº¦çš„æ–¹æ³•" class="headerlink" title="å®æ—¶æ£€æŸ¥ e2fsck è¿›åº¦çš„æ–¹æ³•"></a>å®æ—¶æ£€æŸ¥ e2fsck è¿›åº¦çš„æ–¹æ³•</h2><p>åœ¨e2fsck è¿›è¡Œçš„æ—¶å€™ï¼Œåœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯å‘e2fsck è¿›ç¨‹å‘é€SIGUSR1ä¿¡å·ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 5 <span class="built_in">kill</span> -10 `pidof e2fsck`</span><br></pre></td></tr></tbody></table></figure><p></p><p>åœ¨e2fsckè°ƒç”¨çš„ç»ˆç«¯ä¸Šï¼Œå°±ä¼šæ¯5ç§’é’Ÿæ˜¾ç¤ºä¸€ä¸‹å®æ—¶çš„è¿›åº¦ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">e2fsck 1.42 (29-Nov-2011)</span><br><span class="line">/dev/dm-19 contains a file system with errors, check forced.</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure                                           </span><br><span class="line">Pass 3: Checking directory connectivity                                        </span><br><span class="line">Pass 4: Checking reference counts                                              </span><br><span class="line">Pass 5: Checking group summary information                                     </span><br><span class="line">/dev/dm-19: |======================================================  \ 95.8%</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>å¹¶éåªæœ‰e2fsck è¿™ä¸ªå·¥å…·ä¼šå“åº”SIGUSR1ä¿¡å·ï¼Œddå·¥å…·ä¹Ÿæœ‰åŒæ ·çš„ç‰¹ç‚¹ã€‚dd æ‹·è´å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œåªæœ‰åœ¨æ‹·è´ç»“æŸçš„æ—¶å€™ï¼Œæ‰ä¼šæ±‡æŠ¥æ—¶é—´ä»¥åŠé€Ÿåº¦ç­‰ä¿¡æ¯ï¼Œä½†æ˜¯åƒæˆ‘è¿™ç§ç­‰å¾…ç„¦è™‘ç»¼åˆç—‡çš„é€‰æ‰‹ï¼Œä¸€å®šæ˜¯ä¼šæŠ“ç‹‚çš„ï¼ŒåŒæ ·é“ç†ï¼Œé€šè¿‡å®æ—¶å‘ddè¿›ç¨‹å‘é€ SIGUSR1ä¿¡å·ï¼Œddè¿›ç¨‹å°±ä¼šæ—¶æ—¶æ±‡æŠ¥é€Ÿç‡ä¿¡æ¯ï¼Œä¸å¦¨è¯•è¯•ï¼Œå¾ˆæœ‰ç”¨ã€‚</p><p>å¯¹äºå¼€å‘å„ç§å·¥å…·çš„äººæ¥è¯´ï¼Œå¦‚æœå·¥å…·è¿è¡Œæ—¶é—´å¯èƒ½å¾ˆä¹…ï¼Œå¯ä»¥é€šè¿‡æ³¨å†ŒSIGUSR1ä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œå®æ—¶å‘ç”¨æˆ·æ±‡æŠ¥è¿›åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„ä¹ æƒ¯ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;h4 id=&quot;å¯¹äºe2fsck-è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
</feed>
