<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jamin Blog</title>
  <icon>https://www.gravatar.com/avatar/fca0f49342f608d216999d4b41d5ba65</icon>
  <subtitle>ä¸€ä¸ªä¸èŠæŠ€æœ¯çš„ DBA ä¸æ˜¯ä¸€ä¸ªå¥½å¨å­...</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jiemin.wang/"/>
  <updated>2019-05-20T11:30:26.055Z</updated>
  <id>https://jiemin.wang/</id>
  
  <author>
    <name>Wang Jiemin</name>
    <email>278667010@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mongodb aggregate åŸºäºUNIXæ—¶é—´æˆ³çš„èšåˆ</title>
    <link href="https://jiemin.wang/2019/05/20/mongodb-aggregate/"/>
    <id>https://jiemin.wang/2019/05/20/mongodb-aggregate/</id>
    <published>2019-05-20T10:31:54.000Z</published>
    <updated>2019-05-20T11:30:26.055Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiiiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>å¯¹ä»Šå¤©è§£å†³ä¸äº†çš„äº‹æƒ…ï¼Œä¹Ÿä¸è¦ç€æ€¥ã€‚å› ä¸ºæ˜å¤©ä¹Ÿå¯èƒ½è¿˜æ˜¯è§£å†³ä¸äº†ã€‚</strong></p></blockquote><h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>å¼€å‘æ‰¾æˆ‘é—®<code>MongoDB</code> çš„ <code>aggregate èšåˆ</code>ç”¨è¿‡ä¸<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f630.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f630.png?v8">ğŸ˜°</span> ã€‚</p><p>æˆ‘è¯´æŸ¥æŸ¥èµ„æ–™å§ï¼Œå‘ç°æ˜¯<code>aggregate</code>èšåˆç®¡é“ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f628.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f628.png?v8">ğŸ˜¨</span> ã€‚</p><p>æŠŠSQL ä¸ Aggergation å¯¹æ¯”ä¸‹<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span></p><table><thead><tr><th style="text-align:center">SQL Terms, Functions, and Concepts</th><th style="text-align:center">MongoDB Aggregation Operators</th></tr></thead><tbody><tr><td style="text-align:center">WHERE</td><td style="text-align:center">$match</td></tr><tr><td style="text-align:center">HAVING</td><td style="text-align:center">$match</td></tr><tr><td style="text-align:center">SELECT</td><td style="text-align:center">$project</td></tr><tr><td style="text-align:center">ORDER BY</td><td style="text-align:center">$sort</td></tr><tr><td style="text-align:center">LIMIT</td><td style="text-align:center">$limit</td></tr><tr><td style="text-align:center">SUM()</td><td style="text-align:center">$sum</td></tr><tr><td style="text-align:center">COUNT()</td><td style="text-align:center">$sum</td></tr><tr><td style="text-align:center">COUNT()</td><td style="text-align:center">$sortByCount</td></tr><tr><td style="text-align:center">join</td><td style="text-align:center">$lookup</td></tr></tbody></table><p>å¼€å‘çš„éœ€æ±‚æ˜¯:</p><ul><li>æŒ‰ç…§å¤©åˆ†ç»„ï¼Œç»Ÿè®¡ä¸€ä¸‹æ•°é‡</li></ul><p>ç»è¿‡æŸ¥çœ‹<code>MongoDBå®˜ç½‘</code>çš„<a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener">aggregateèµ„æ–™</a>å®ç°å¼€å‘çš„éœ€æ±‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æŸ¥è¯¢æ•°æ®çš„çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.find({<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}).pretty().<span class="built_in">limit</span>(1);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">        <span class="string">"_id"</span> : ObjectId(<span class="string">"5c125657372eecd7a0a54e5e"</span>),</span><br><span class="line">        <span class="string">"adRate"</span> : 0,</span><br><span class="line">        <span class="string">"assoId"</span> : <span class="string">"223794113"</span>,</span><br><span class="line">        <span class="string">"assoType"</span> : 201,</span><br><span class="line">        <span class="string">"clientIp"</span> : <span class="string">"183.131.7.23"</span>,</span><br><span class="line">        <span class="string">"clientType"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"confidence"</span> : 12.655,</span><br><span class="line">        <span class="string">"content"</span> : <span class="string">"****http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1\**"</span>,</span><br><span class="line">        <span class="string">"createTs"</span> : NumberLong(1544705623),</span><br><span class="line">        <span class="string">"emailStatus"</span> : <span class="string">"verified"</span>,</span><br><span class="line">        <span class="string">"handleTs"</span> : NumberLong(1545036013),</span><br><span class="line">        <span class="string">"hotScore"</span> : 14.285,</span><br><span class="line">        <span class="string">"inspectStatus"</span> : 2,</span><br><span class="line">        <span class="string">"message"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"moduleId"</span> : NumberLong(5),</span><br><span class="line">        <span class="string">"normalScore"</span> : 73.25,</span><br><span class="line">        <span class="string">"ocrKeyword"</span> : [ ],</span><br><span class="line">        <span class="string">"ocrText"</span> : [ ],</span><br><span class="line">        <span class="string">"opUser"</span> : <span class="string">"fanyanning"</span>,</span><br><span class="line">        <span class="string">"opUserId"</span> : NumberLong(31648494),</span><br><span class="line">        <span class="string">"pornScore"</span> : 12.464,</span><br><span class="line">        <span class="string">"qcode"</span> : 0,</span><br><span class="line">        <span class="string">"receiveTs"</span> : NumberLong(1545035885),</span><br><span class="line">        <span class="string">"regTs"</span> : NumberLong(1475385061),</span><br><span class="line">        <span class="string">"requestId"</span> : <span class="string">"6f078c58-1235-4816-96a5-e876ea0cbcf2"</span>,</span><br><span class="line">        <span class="string">"rotOcrKeyword"</span> : [ ],</span><br><span class="line">        <span class="string">"rotOcrText"</span> : [ ],</span><br><span class="line">        <span class="string">"ruleId"</span> : NumberLong(10019),</span><br><span class="line">        <span class="string">"sim"</span> : 0,</span><br><span class="line">        <span class="string">"status"</span> : 1000,</span><br><span class="line">        <span class="string">"trashType"</span> : 0,</span><br><span class="line">        <span class="string">"ts"</span> : NumberLong(1544705623),</span><br><span class="line">        <span class="string">"url"</span> : <span class="string">"http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1"</span>,</span><br><span class="line">        <span class="string">"userId"</span> : NumberLong(56349617),</span><br><span class="line">        <span class="string">"userLevel"</span> : 3,</span><br><span class="line">        <span class="string">"version"</span> : <span class="string">"1.0.0"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¼€å‘ç»™çš„èšåˆçš„æŸ¥è¯¢<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([</span><br><span class="line">{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}},</span><br><span class="line">{ <span class="variable">$group</span>: {_id :{<span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date: <span class="string">"<span class="variable">$createTs</span>"</span> }},count: { <span class="variable">$sum</span>: 1 }}}</span><br><span class="line">]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mgset-11469021:SECONDARY> db.antispam_image.aggregate([{<span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5, createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}}, {<span class="variable">$group</span>: {_id: {<span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date: <span class="string">"<span class="variable">$createTs</span>"</span>}}, count: {<span class="variable">$sum</span>: 1}}}]);</span><br><span class="line">assert: <span class="built_in">command</span> failed: {</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1558347069, 2),</span><br><span class="line">        <span class="string">"ok"</span> : 0,</span><br><span class="line">        <span class="string">"errmsg"</span> : <span class="string">"can't convert from BSON type long to Date"</span>,</span><br><span class="line">        <span class="string">"code"</span> : 16006,</span><br><span class="line">        <span class="string">"codeName"</span> : <span class="string">"Location16006"</span></span><br><span class="line">} : aggregate failed</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">doassert@src/mongo/shell/assert.js:16:14</span><br><span class="line">assert.commandWorked@src/mongo/shell/assert.js:370:5</span><br><span class="line">DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5</span><br><span class="line">@(shell):1:1</span><br><span class="line"></span><br><span class="line">2019-05-20T18:11:10.818+0800 E QUERY    [thread1] Error: <span class="built_in">command</span> failed: {</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1558347069, 2),</span><br><span class="line">        <span class="string">"ok"</span> : 0,</span><br><span class="line">        <span class="string">"errmsg"</span> : <span class="string">"can't convert from BSON type long to Date"</span>,</span><br><span class="line">        <span class="string">"code"</span> : 16006,</span><br><span class="line">        <span class="string">"codeName"</span> : <span class="string">"Location16006"</span></span><br><span class="line">} : aggregate failed :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">doassert@src/mongo/shell/assert.js:16:14</span><br><span class="line">assert.commandWorked@src/mongo/shell/assert.js:370:5</span><br><span class="line">DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5</span><br><span class="line">@(shell):1:1</span><br></pre></td></tr></tbody></table></figure><p>æŠ¥é”™äº†ï¼Œé—®å¼€å‘ã€‚å¼€å‘åˆç»™äº†ä¸€ä¸ªæŸ¥è¯¢è¯­å¥<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([</span><br><span class="line">{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}},</span><br><span class="line">{ <span class="variable">$group</span>: {</span><br><span class="line">_id :{ <span class="variable">$dateToString</span>: {format: <span class="string">"%Y-%m-%d"</span>, date:{<span class="string">"<span class="variable">$add</span>"</span>:[new Date(0),<span class="string">"<span class="variable">$createTs</span>"</span>]}} },</span><br><span class="line">count: { <span class="variable">$sum</span>: 1 }</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"_id"</span> : <span class="string">"1970-01-19"</span>, <span class="string">"count"</span> : 15131 }</span><br><span class="line">{ <span class="string">"_id"</span> : <span class="string">"1970-01-18"</span>, <span class="string">"count"</span> : 180400 }</span><br></pre></td></tr></tbody></table></figure><p>å‘ç°æ—¶é—´æˆ³è½¬åŒ–ä¸å¯¹</p><p>äºæ˜¯æŸ¥çœ‹å®˜ç½‘èµ„æ–™ï¼Œç»§ç»­æ”¹å†™å…ˆæŠŠUNIXæ—¶é—´æˆ³è½¬åŒ–ä¸ºæ—¥æœŸã€‚å¯æ˜¯MongoDBåˆæ²¡æœ‰<code>MySQL</code>é‚£ç§<code>FROM_UNIXTIME()</code>ä¸<code>UNIX_TIMESTAMP()</code>å‡½æ•°ã€‚åªèƒ½è‡ªå·±é€ </p><p>é€šè¿‡å°†å€¼ä¹˜ä»¥1000å°†createTså­—æ®µè½¬æ¢ä¸ºæ¯«ç§’æ—¶é—´æˆ³<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>]}</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>$multiply    å°†æ•°å­—ç›¸ä¹˜ä»¥è¿”å›äº§å“ã€‚æ¥å—ä»»æ„æ•°é‡çš„å‚æ•°è¡¨è¾¾å¼ã€‚</p></blockquote><p>ç„¶åè½¬æ¢ä¸ºæ—¥æœŸ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>]} ]</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç»§ç»­ç»„è£…æŸ¥è¯¢<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="string">"<span class="variable">$group</span>"</span>: { <span class="string">"_id"</span>: { <span class="string">"year"</span>: { <span class="string">"<span class="variable">$year</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"mmonth"</span>: { <span class="string">"<span class="variable">$month</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"day"</span>: { <span class="string">"<span class="variable">$dayOfMonth</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}}, <span class="string">"count"</span> : { <span class="string">"<span class="variable">$sum</span>"</span> : 1 }}}</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>åœ¨<code>$project</code>ç®¡é“ä¸­å®Œæˆ,æ–¹æ³•æ˜¯å°†<code>æ¯«ç§’æ—¶é—´</code>æ·»åŠ åˆ°<code>é›¶æ¯«ç§’Date(0)</code>å¯¹è±¡,ç„¶åä»è½¬æ¢åçš„<code>æ—¥æœŸ</code>ä¸­æå–<code>$year</code>,<code>$month</code>,<code>$dayOfMonth</code>ä¸ªé›¶ä»¶,å¯ä»¥åœ¨<code>$group</code>ç®¡é“ä¸­ä½¿ç”¨è¿™äº›é›¶ä»¶å¯¹æ–‡æ¡£è¿›è¡Œåˆ†ç»„</p></blockquote><p>å®Œæ•´çš„æŸ¥è¯¢è¯­å¥æ‹¼æ¥å‡ºæ¥<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.antispam_image.aggregate([{ <span class="variable">$match</span>: {<span class="string">"moduleId"</span>:5,createTs:{<span class="variable">$gte</span>:1554048000},createTs:{<span class="variable">$lt</span>:1556640000}}}, {<span class="string">"<span class="variable">$group</span>"</span>: { <span class="string">"_id"</span>: { <span class="string">"year"</span>: { <span class="string">"<span class="variable">$year</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"mmonth"</span>: { <span class="string">"<span class="variable">$month</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ]}}, <span class="string">"day"</span>: { <span class="string">"<span class="variable">$dayOfMonth</span>"</span>: { <span class="string">"<span class="variable">$add</span>"</span>: [ new Date(0), { <span class="string">"<span class="variable">$multiply</span>"</span>: [1000, <span class="string">"<span class="variable">$createTs</span>"</span>] } ] }}}, <span class="string">"count"</span> : { <span class="string">"<span class="variable">$sum</span>"</span> : 1 }}}]);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 30 }, <span class="string">"count"</span> : 624 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 28 }, <span class="string">"count"</span> : 695 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 27 }, <span class="string">"count"</span> : 683 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 26 }, <span class="string">"count"</span> : 765 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 12 }, <span class="string">"count"</span> : 610 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 4 }, <span class="string">"count"</span> : 429 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 1, <span class="string">"day"</span> : 3 }, <span class="string">"count"</span> : 475 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 29 }, <span class="string">"count"</span> : 732 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 12, <span class="string">"day"</span> : 31 }, <span class="string">"count"</span> : 592 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 12, <span class="string">"day"</span> : 30 }, <span class="string">"count"</span> : 542 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 14 }, <span class="string">"count"</span> : 1155 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 13 }, <span class="string">"count"</span> : 1169 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 20 }, <span class="string">"count"</span> : 945 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 3, <span class="string">"day"</span> : 15 }, <span class="string">"count"</span> : 1062 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 24 }, <span class="string">"count"</span> : 751 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 15 }, <span class="string">"count"</span> : 721 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 18 }, <span class="string">"count"</span> : 895 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 16 }, <span class="string">"count"</span> : 713 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2019, <span class="string">"mmonth"</span> : 4, <span class="string">"day"</span> : 14 }, <span class="string">"count"</span> : 1278 }</span><br><span class="line">{ <span class="string">"_id"</span> : { <span class="string">"year"</span> : 2018, <span class="string">"mmonth"</span> : 10, <span class="string">"day"</span> : 17 }, <span class="string">"count"</span> : 583 }</span><br><span class="line">Type <span class="string">"it"</span> <span class="keyword">for</span> more</span><br><span class="line">mgset-11469021:SECONDARY></span><br></pre></td></tr></tbody></table></figure><p>æ‹¿è¿™æ ·æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®é—®å¼€å‘æ˜¯å¦æ˜¯è¿™æ ·ã€å¼€å‘ç¡®è®¤è¿™æ ·å¯ä»¥ã€‚éœ€æ±‚è§£å†³ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>é’ˆå¯¹DBAè¿™ä¸ªå²—ä½æ¥è¯´ã€‚å¤§å¤šæ•°éƒ½æ˜¯ä»äº‹MongoDB è¿ç»´å·¥ä½œ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span>ã€‚</p><p>å¾ˆå°‘è´´è¿‘å¼€å‘éœ€æ±‚ï¼Œè¿™æ¬¡å¼€å‘é—®äº†æˆ‘è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å½“ç„¶æ— æ³•ç«‹é©¬ç»™å‡ºç­”æ¡ˆã€‚åªèƒ½ä¸æ–­çš„æŸ¥è¯¢ã€‚æ‹¼æ¥ï¼Œæ‰èƒ½é©¬é©¬è™è™çš„æ»¡è¶³äº†å¼€å‘çš„éœ€æ±‚ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png?v8">âœ…</span>ã€‚</p><p>åˆšæ‰é—®ä¸€ä¸ªæ¶æ„å¸ˆï¼Œæ¶æ„å¸ˆè¯´æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹å¼ï¼š</p><ol><li>æŸ¥å‡ºæ€»ç»“å‡ºä¸€å¤©çš„æ•°æ®ï¼Œæ”¾åˆ°ç®¡é“ä¸­ä¸´æ—¶ä¿å­˜èµ·æ¥</li><li>åœ¨ç”¨å‰ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æŸæ—¶é—´ä½œä¸ºç¬¬äºŒå¤©çš„å¼€å§‹æ—¶é—´ï¼Œåœ¨åŠ ä¸Šä¸€å¤©çš„æ—¶é—´(86400s)å¾—å‡ºç»“å°¾æ—¶é—´ã€‚</li><li>æŸ¥è¯¢å®Œæˆåœ¨ç»Ÿä¸€æ˜¾ç¤ºæ‰“å°å‡ºæ¥</li></ol><p>è¿™ç§æ–¹å¼å°±éœ€è¦ä½¿ç”¨<code>MongoDB forEach</code>æ–¹å¼å®ç°äº†ã€‚</p><p>å¼€å‘åˆè¯´ä¸èƒ½æŒ‰æ—¶é—´æ’åº<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f631.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f631.png?v8">ğŸ˜±</span> , å¦¹çš„<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span>å“ªé‡Œæ¥çš„è¿™ä¹ˆå¤šè¦æ±‚<span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f631.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f631.png?v8">ğŸ˜±</span></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>MongoDB å®˜æ–¹èµ„æ–™: <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener">aggregateèµ„æ–™</a></li><li><a href="https://blog.gaoqixhb.com/p/5938ca473b447c14248d41ad" target="_blank" rel="noopener">MongoDB èšåˆæŸ¥è¯¢ - æŒ‰æ—¶é—´åˆ†ç»„ç»Ÿè®¡</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiiiii.jpg&quot; class=&quot;full-image&quot; alt=
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>mongodbæ•°æ®å¯¼å‡ºCSVæ–‡ä»¶</title>
    <link href="https://jiemin.wang/2019/05/17/mongodb-to-csv/"/>
    <id>https://jiemin.wang/2019/05/17/mongodb-to-csv/</id>
    <published>2019-05-17T05:45:15.000Z</published>
    <updated>2019-05-17T06:20:44.896Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="qiong.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>è¦ä¸æ˜¯å› ä¸ºæˆ‘ï¼Œä½ èƒ½æœ‰ä»Šå¤©ï¼Ÿ</strong><br><strong>è¦ä¸æ˜¯æˆ‘ä¼¤å®³ä½ ï¼Œä½ èƒ½æˆé•¿ï¼Ÿ</strong></p></blockquote><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><p>äº§å“éœ€è¦åˆ†æè¾¾äººæ–‡ç« çš„æ ‡ç­¾ï¼Œéœ€è¦æŠŠ2019å¹´1æœˆ1å·åˆ°ç°åœ¨çš„æ ‡ç­¾ï¼Œä»mongoå¯¼å‡ºæ¥ï¼Œå¯¼å‡ºæ ¼å¼ä¸ºcsvï¼ŒæŸ¥è¯¢æ¡ä»¶å¦‚ä¸‹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.content_medium_hismatch.find({<span class="string">"content_type_id"</span>:<span class="string">"28"</span>,<span class="string">"update_time"</span>:{<span class="string">"<span class="variable">$gte</span>"</span>:1546272000000},<span class="string">"is_delete"</span>:0}, {<span class="string">"content_id"</span>:1,<span class="string">"content_tags"</span>:1});</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><p>ä½¿ç”¨<code>MongoDB</code>ä¸­çš„<code>mongoexport</code>å‘½ä»¤<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">mongoexport --<span class="built_in">help</span></span><br><span class="line">Usage:</span><br><span class="line">  mongoexport <options></span><br><span class="line"></span><br><span class="line">Export data from MongoDB <span class="keyword">in</span> CSV or JSON format.</span><br><span class="line"></span><br><span class="line">See http://docs.mongodb.org/manual/reference/program/mongoexport/ <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">general options:</span><br><span class="line">      --<span class="built_in">help</span>                                      <span class="built_in">print</span> usage</span><br><span class="line">      --version                                   <span class="built_in">print</span> the tool version and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">verbosity options:</span><br><span class="line">  -v, --verbose=<level>                           more detailed <span class="built_in">log</span> output (include multiple <span class="built_in">times</span> <span class="keyword">for</span> more verbosity, e.g. -vvvvv, or specify a numeric value, e.g. --verbose=N)</span><br><span class="line">      --quiet                                     hide all <span class="built_in">log</span> output</span><br><span class="line"></span><br><span class="line">connection options:</span><br><span class="line">  -h, --host=<hostname>                           mongodb host to connect to (setname/host1,host2 <span class="keyword">for</span> replica sets)</span><br><span class="line">      --port=<port>                               server port (can also use --host hostname:port)</span><br><span class="line"></span><br><span class="line">ssl options:</span><br><span class="line">      --ssl                                       connect to a mongod or mongos that has ssl enabled</span><br><span class="line">      --sslCAFile=<filename>                      the .pem file containing the root certificate chain from the certificate authority</span><br><span class="line">      --sslPEMKeyFile=<filename>                  the .pem file containing the certificate and key</span><br><span class="line">      --sslPEMKeyPassword=<password>              the password to decrypt the sslPEMKeyFile, <span class="keyword">if</span> necessary</span><br><span class="line">      --sslCRLFile=<filename>                     the .pem file containing the certificate revocation list</span><br><span class="line">      --sslAllowInvalidCertificates               bypass the validation <span class="keyword">for</span> server certificates</span><br><span class="line">      --sslAllowInvalidHostnames                  bypass the validation <span class="keyword">for</span> server name</span><br><span class="line">      --sslFIPSMode                               use FIPS mode of the installed openssl library</span><br><span class="line"></span><br><span class="line">authentication options:</span><br><span class="line">  -u, --username=<username>                       username <span class="keyword">for</span> authentication</span><br><span class="line">  -p, --password=<password>                       password <span class="keyword">for</span> authentication</span><br><span class="line">      --authenticationDatabase=<database-name>    database that holds the user<span class="string">'s credentials</span></span><br><span class="line"><span class="string">      --authenticationMechanism=<mechanism>       authentication mechanism to use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">namespace options:</span></span><br><span class="line"><span class="string">  -d, --db=<database-name>                        database to use</span></span><br><span class="line"><span class="string">  -c, --collection=<collection-name>              collection to use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">output options:</span></span><br><span class="line"><span class="string">  -f, --fields=<field>[,<field>]*                 comma separated list of field names (required for exporting CSV) e.g. -f "name,age"</span></span><br><span class="line"><span class="string">      --fieldFile=<filename>                      file with field names - 1 per line</span></span><br><span class="line"><span class="string">      --type=<type>                               the output format, either json or csv (defaults to '</span>json<span class="string">') (default: json)</span></span><br><span class="line"><span class="string">  -o, --out=<filename>                            output file; if not specified, stdout is used</span></span><br><span class="line"><span class="string">      --jsonArray                                 output to a JSON array rather than one object per line</span></span><br><span class="line"><span class="string">      --pretty                                    output JSON formatted to be human-readable</span></span><br><span class="line"><span class="string">      --noHeaderLine                              export CSV data without a list of field names at the first line</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">querying options:</span></span><br><span class="line"><span class="string">  -q, --query=<json>                              query filter, as a JSON string, e.g., '</span>{x:{<span class="variable">$gt</span>:1}}<span class="string">'</span></span><br><span class="line"><span class="string">      --queryFile=<filename>                      path to a file containing a query filter (JSON)</span></span><br><span class="line"><span class="string">  -k, --slaveOk                                   allow secondary reads if available (default true) (default: false)</span></span><br><span class="line"><span class="string">      --readPreference=<string>|<json>            specify either a preference name or a preference json object</span></span><br><span class="line"><span class="string">      --forceTableScan                            force a table scan (do not use $snapshot)</span></span><br><span class="line"><span class="string">      --skip=<count>                              number of documents to skip</span></span><br><span class="line"><span class="string">      --limit=<count>                             limit the number of documents to export</span></span><br><span class="line"><span class="string">      --sort=<json>                               sort order, as a JSON string, e.g. '</span>{x:1}<span class="string">'</span></span><br><span class="line"><span class="string">      --assertExists                              if specified, export fails if the collection does not exist (default: false)</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>æ“ä½œå‘½ä»¤å¦‚ä¸‹:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</span> --<span class="built_in">type</span>=csv --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:18:52.325+0800    error validating settings: query <span class="string">'[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line">2019-05-17T13:18:52.325+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information</span><br></pre></td></tr></tbody></table></figure><p>åˆæ­¥åˆ¤æ–­æ˜¯å¯¼å‡º<code>CSVæ–‡ä»¶</code>ä¸­éœ€è¦çš„<code>é€—å·(,)</code>åˆ†å‰²ã€‚å­—æ®µå‘ç”Ÿé”™è¯¯ã€‚è¯­å¥æ·»åŠ â€“fields _id,content_id,content_tags<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</span> --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`2019-05-17T13:18:54.325+0800    error validating settings: query <span class="string">'[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line"> 2019-05-17T13:18:54.325+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information``bash</span><br></pre></td></tr></tbody></table></figure><p>å¼€å§‹æ’æŸ¥ä¸ºä»€ä¹ˆè¿˜ç»§ç»­æŠ¥é”™ã€‚ä½¿ç”¨ <code>mongo shell</code> è¿æ¥åˆ°mongodbä¸­æŸ¥è¯¢å‘ç°æ˜¯èƒ½è·å–åˆ°æ•°æ®çš„ã€‚å»æ‰â€“query æ¡ä»¶ä¹‹åå†æ‰§è¡Œä¸€æ¬¡å‘ç°æ˜¯æ²¡é—®é¢˜<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:24:18.176+0800    connected to: localhost:29001</span><br><span class="line">2019-05-17T13:24:19.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:20.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:21.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:22.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:23.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:24.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:25.167+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">2019-05-17T13:24:26.168+0800    [........................]  feeds.content_medium_hismatch  0/138863565  (0.0%)</span><br><span class="line">^C2019-05-17T13:24:26.900+0800  signal <span class="string">'interrupt'</span> received; forcefully terminating</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># ls</span></span><br><span class="line">content_medium_hismatch.csv</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># cat content_medium_hismatch.csv |more</span></span><br><span class="line">_id,content_id,content_tags</span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db599),1229,<span class="string">"["</span><span class="string">"å¥¶ç“¶"</span><span class="string">","</span><span class="string">"åƒå¥¶"</span><span class="string">","</span><span class="string">"å¸å®"</span><span class="string">","</span><span class="string">"ä¹³å¤´æ··æ·†"</span><span class="string">","</span><span class="string">"æ¯ä¹³"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5c8),1290,<span class="string">"["</span><span class="string">"è¡£æœ"</span><span class="string">","</span><span class="string">"äºŒæ‰‹è¡£æœ"</span><span class="string">","</span><span class="string">"æ¸…æ´—"</span><span class="string">","</span><span class="string">"çš®è‚¤"</span><span class="string">","</span><span class="string">"ç»†èŒ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5cd),1297,<span class="string">"["</span><span class="string">"èº«æ"</span><span class="string">","</span><span class="string">"äº§åå¦ˆå¦ˆ"</span><span class="string">","</span><span class="string">"æ–°å¦ˆå¦ˆ"</span><span class="string">","</span><span class="string">"è£™å­"</span><span class="string">","</span><span class="string">"è¡£æœ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5e1),1325,<span class="string">"["</span><span class="string">"æŠ¤è‚¤å“"</span><span class="string">","</span><span class="string">"å“ºä¹³æœŸ"</span><span class="string">","</span><span class="string">"çš®è‚¤"</span><span class="string">","</span><span class="string">"å¥åº·"</span><span class="string">","</span><span class="string">"æŠ¤è‚¤"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db5e8),1343,<span class="string">"["</span><span class="string">"æ”¶çº³"</span><span class="string">","</span><span class="string">"å®¶å…·"</span><span class="string">","</span><span class="string">"å¥¶ç²‰"</span><span class="string">","</span><span class="string">"åˆ†äº«"</span><span class="string">","</span><span class="string">"ä¸‰è§’å½¢"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db618),1393,<span class="string">"["</span><span class="string">"èƒŒå¸¦"</span><span class="string">","</span><span class="string">"å©´å„¿"</span><span class="string">","</span><span class="string">"å¸¦å®å®"</span><span class="string">","</span><span class="string">"å‡ºé—¨"</span><span class="string">","</span><span class="string">"è‚Œè‚‰å‘è‚²"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db65e),1465,<span class="string">"["</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"éª¨éª¼"</span><span class="string">","</span><span class="string">"çœ¼ç›"</span><span class="string">","</span><span class="string">"å¸®åŠ©"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db660),1467,<span class="string">"["</span><span class="string">"æ™’å¤ªé˜³"</span><span class="string">","</span><span class="string">"ç´«å¤–çº¿"</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">","</span><span class="string">"é»„ç–¸"</span><span class="string">","</span><span class="string">"çœ¼ç›"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db666),1472,<span class="string">"["</span><span class="string">"ä¼è½¦"</span><span class="string">","</span><span class="string">"æ¨è½¦"</span><span class="string">","</span><span class="string">"å©´å„¿ä¼è½¦"</span><span class="string">","</span><span class="string">"å©´å„¿æ¨è½¦"</span><span class="string">","</span><span class="string">"ä¼˜ç‚¹"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db669),1474,<span class="string">"["</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"å‘³è§‰å‘è‚²"</span><span class="string">","</span><span class="string">"å£å‘³"</span><span class="string">","</span><span class="string">"é£Ÿç›"</span><span class="string">","</span><span class="string">"é¥®é£Ÿ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db674),1490,<span class="string">"["</span><span class="string">"æ‚£ç—…"</span><span class="string">","</span><span class="string">"çˆ¶æ¯"</span><span class="string">","</span><span class="string">"æŒ‡ç”²"</span><span class="string">","</span><span class="string">"å¥åº·"</span><span class="string">","</span><span class="string">"æ‰“å‘¼å™œ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db67a),1500,<span class="string">"["</span><span class="string">"ç¡çœ "</span><span class="string">","</span><span class="string">"ç–¾ç—…"</span><span class="string">","</span><span class="string">"çˆ¶æ¯"</span><span class="string">","</span><span class="string">"ç—‡çŠ¶"</span><span class="string">","</span><span class="string">"åŒ»é™¢"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db68c),1513,<span class="string">"["</span><span class="string">"å£°éŸ³"</span><span class="string">","</span><span class="string">"å¥¶ç¡"</span><span class="string">","</span><span class="string">"ç¾å›½"</span><span class="string">","</span><span class="string">"æ‘‡æ™ƒ"</span><span class="string">","</span><span class="string">"å®å®ç¡è§‰"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db6a0),1535,<span class="string">"["</span><span class="string">"å®‰å…¨"</span><span class="string">","</span><span class="string">"æ¸…æ´—"</span><span class="string">","</span><span class="string">"åä¾¿å™¨"</span><span class="string">","</span><span class="string">"é©¬æ¡¶"</span><span class="string">","</span><span class="string">"ä¼˜ç‚¹"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db746),2732,<span class="string">"["</span><span class="string">"è”æ"</span><span class="string">","</span><span class="string">"è¿›é£Ÿ"</span><span class="string">","</span><span class="string">"è‘¡è„ç³–"</span><span class="string">","</span><span class="string">"ä¸Šç«"</span><span class="string">","</span><span class="string">"ç—‡çŠ¶"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db749),2733,<span class="string">"["</span><span class="string">"å®å®å–‚å…»"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"æ¯ä¹³"</span><span class="string">","</span><span class="string">"é¥®é£Ÿ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db752),2742,<span class="string">"["</span><span class="string">"ä¹³å¤´"</span><span class="string">","</span><span class="string">"å–‚å¥¶"</span><span class="string">","</span><span class="string">"ä¹³å¤´çš²è£‚"</span><span class="string">","</span><span class="string">"å“ºä¹³"</span><span class="string">","</span><span class="string">"ä¹³æˆ¿"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db758),2745,<span class="string">"["</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"æŒ‘é£Ÿ"</span><span class="string">","</span><span class="string">"åé£Ÿ"</span><span class="string">","</span><span class="string">"çˆ¸çˆ¸"</span><span class="string">","</span><span class="string">"è èœ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db75b),2746,<span class="string">"["</span><span class="string">"åƒé¥­"</span><span class="string">","</span><span class="string">"çˆ¸çˆ¸"</span><span class="string">","</span><span class="string">"å’€åš¼"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"æ—¶é—´"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db75f),2747,<span class="string">"["</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"å°å®"</span><span class="string">","</span><span class="string">"æ ¸æ¡ƒæ²¹"</span><span class="string">","</span><span class="string">"å¥åº·"</span><span class="string">","</span><span class="string">"äºšéº»é…¸"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db761),2748,<span class="string">"["</span><span class="string">"æ²¹ç‚¸"</span><span class="string">","</span><span class="string">"å¥åº·"</span><span class="string">","</span><span class="string">"é£Ÿå“"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"æ²¹è„‚"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db768),2751,<span class="string">"["</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"è†³é£Ÿçº¤ç»´"</span><span class="string">","</span><span class="string">"æ¶ˆåŒ–ä¸è‰¯"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"è‚ é“"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db76d),2753,<span class="string">"["</span><span class="string">"åƒé¥­"</span><span class="string">","</span><span class="string">"é¥®é£Ÿä¹ æƒ¯"</span><span class="string">","</span><span class="string">"å¸®åŠ©"</span><span class="string">","</span><span class="string">"ä¹ æƒ¯"</span><span class="string">","</span><span class="string">"çˆ¸çˆ¸"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db770),2754,<span class="string">"["</span><span class="string">"å¾®æ³¢ç‚‰"</span><span class="string">","</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"è¥å…»"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db773),2755,<span class="string">"["</span><span class="string">"è‘¡è„ç³–"</span><span class="string">","</span><span class="string">"è¥å…»"</span><span class="string">","</span><span class="string">"ä¹ æƒ¯"</span><span class="string">","</span><span class="string">"å®¶é•¿"</span><span class="string">","</span><span class="string">"å®å®ç”Ÿç—…"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db775),2756,<span class="string">"["</span><span class="string">"ç¥›æ¹¿"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"å¸®åŠ©"</span><span class="string">","</span><span class="string">"é£Ÿè°±"</span><span class="string">","</span><span class="string">"çº¢è±†"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db778),2757,<span class="string">"["</span><span class="string">"æ°´æœ"</span><span class="string">","</span><span class="string">"è”¬èœ"</span><span class="string">","</span><span class="string">"æœæ±"</span><span class="string">","</span><span class="string">"é…æ–¹å¥¶"</span><span class="string">","</span><span class="string">"æ¯ä¹³"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db77e),2759,<span class="string">"["</span><span class="string">"æŒ‘é£Ÿ"</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">","</span><span class="string">"è¥å…»"</span><span class="string">","</span><span class="string">"å®å®æŒ‘é£Ÿ"</span><span class="string">","</span><span class="string">"ç¼ºé”Œ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db781),2760,<span class="string">"["</span><span class="string">"åƒè‚‰"</span><span class="string">","</span><span class="string">"å¥åº·"</span><span class="string">","</span><span class="string">"æ°´æœ"</span><span class="string">","</span><span class="string">"é¥±å’Œè„‚è‚ªé…¸"</span><span class="string">","</span><span class="string">"ä¾¿ç§˜"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db784),2761,<span class="string">"["</span><span class="string">"æ°´æœ"</span><span class="string">","</span><span class="string">"è¥å…»"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"èƒ¡èåœç´ "</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db787),2762,<span class="string">"["</span><span class="string">"ä½“é‡"</span><span class="string">","</span><span class="string">"å®å®ç˜¦"</span><span class="string">","</span><span class="string">"è¥å…»ä¸è‰¯"</span><span class="string">","</span><span class="string">"åŸå› "</span><span class="string">","</span><span class="string">"çˆ¶æ¯"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db789),2763,<span class="string">"["</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"è¥å…»"</span><span class="string">","</span><span class="string">"å®å®å–‚å…»"</span><span class="string">","</span><span class="string">"è¿›é£Ÿ"</span><span class="string">","</span><span class="string">"æ—¶é—´"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db790),2765,<span class="string">"["</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"å®å®æ–­å¥¶"</span><span class="string">","</span><span class="string">"æ–­å¥¶"</span><span class="string">","</span><span class="string">"ä¿å­˜"</span><span class="string">","</span><span class="string">"å†°ç®±"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db792),2766,<span class="string">"["</span><span class="string">"æ–­å¥¶"</span><span class="string">","</span><span class="string">"æ¯ä¹³"</span><span class="string">","</span><span class="string">"ç¯å¢ƒ"</span><span class="string">","</span><span class="string">"å¤å­£"</span><span class="string">","</span><span class="string">"å®å®ç”Ÿç—…"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db795),2767,<span class="string">"["</span><span class="string">"ç›Šç”ŸèŒ"</span><span class="string">","</span><span class="string">"è¯ç‰©"</span><span class="string">","</span><span class="string">"é£Ÿå“"</span><span class="string">","</span><span class="string">"å¹³è¡¡"</span><span class="string">","</span><span class="string">"æŠ—ç”Ÿç´ "</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db798),2768,<span class="string">"["</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"å’³å—½"</span><span class="string">","</span><span class="string">"å®å®å’³å—½"</span><span class="string">","</span><span class="string">"é¥®é£Ÿ"</span><span class="string">","</span><span class="string">"è¾›è¾£"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db79b),2769,<span class="string">"["</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"é¥®é£Ÿ"</span><span class="string">","</span><span class="string">"æ–­å¥¶"</span><span class="string">","</span><span class="string">"å®å®æ–­å¥¶"</span><span class="string">","</span><span class="string">"ä¿å­˜"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598eaeeb42d8582db7a1),2773,<span class="string">"["</span><span class="string">"è¡¥é’™"</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">","</span><span class="string">"å®å®ç¼ºé’™"</span><span class="string">","</span><span class="string">"æ¯ä¹³"</span><span class="string">","</span><span class="string">"é…æ–¹å¥¶"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7a6),2775,<span class="string">"["</span><span class="string">"æœæ³¥"</span><span class="string">","</span><span class="string">"æ°´æœ"</span><span class="string">","</span><span class="string">"ç»´ç”Ÿç´ "</span><span class="string">","</span><span class="string">"å“ˆå¯†ç“œ"</span><span class="string">","</span><span class="string">"é¦™è•‰"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7a9),2776,<span class="string">"["</span><span class="string">"é¥®é£Ÿ"</span><span class="string">","</span><span class="string">"é£Ÿç‰©"</span><span class="string">","</span><span class="string">"è¾…é£Ÿ"</span><span class="string">","</span><span class="string">"è¿›é£Ÿ"</span><span class="string">","</span><span class="string">"æ°´æœ"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7ac),2777,<span class="string">"["</span><span class="string">"æœ‰æœºè”¬èœ"</span><span class="string">","</span><span class="string">"è”¬èœ"</span><span class="string">","</span><span class="string">"å†œè¯"</span><span class="string">","</span><span class="string">"æœ‰æœº"</span><span class="string">","</span><span class="string">"å†œè¯æ®‹ç•™"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7b4),2780,<span class="string">"["</span><span class="string">"æ–­å¥¶"</span><span class="string">","</span><span class="string">"ä¹³å¤´"</span><span class="string">","</span><span class="string">"ä¹³æˆ¿"</span><span class="string">","</span><span class="string">"ä¹³è…ºç‚"</span><span class="string">","</span><span class="string">"å›å¥¶"</span><span class="string">"]"</span></span><br><span class="line">ObjectId(5b0f598faeeb42d8582db7b8),2783,<span class="string">"["</span><span class="string">"å¶é»„ç´ "</span><span class="string">","</span><span class="string">"å¤ªé˜³é•œ"</span><span class="string">","</span><span class="string">"èƒ¡èåœ"</span><span class="string">","</span><span class="string">"å—ç“œ"</span><span class="string">","</span><span class="string">"èŠ’æœ"</span><span class="string">"]"</span></span><br></pre></td></tr></tbody></table></figure><p>å°±èƒ½ç¡®å®šè¿™ä¹ˆæ‰§è¡Œæ˜¯æ²¡æœ‰é—®é¢˜ã€‚é‡ç‚¹æ’æŸ¥<code>--queryæ¡ä»¶</code>ã€‚æ ¹æ®ä¹‹å‰æŠ¥é”™<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:25:56.341+0800    error validating settings: query <span class="string">'[123 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 58 50 56 44 117 112 100 97 116 101 95 116 105 109 101 58 123 36 103 116 101 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 105 115 95 100 101 108 101 116 101 58 48 125 44 123 99 111 110 116 101 110 116 95 105 100 58 49 44 99 111 110 116 101 110 116 95 116 97 103 115 58 49 125]'</span> is not valid JSON: invalid character <span class="string">','</span> after top-level value</span><br><span class="line">2019-05-17T13:25:56.341+0800    try <span class="string">'mongoexport --help'</span> <span class="keyword">for</span> more information</span><br></pre></td></tr></tbody></table></figure><p></p><p>å‘ç°ä¸€ä¸ªç‚¹<code>invalid character ',' after top-level value</code>ä¸­æç¤ºæœ‰<code>é€—å·,</code>çš„é—®é¢˜ï¼Œæ’æŸ¥ä¸€ä¸‹<code>--queryæ¡ä»¶</code>å‘ç°æœ‰<code>'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'</code>æœ‰ä¸€ä¸ª<code>é€—å·,</code></p><p>å»æ‰<code>é€—å·,</code>å’Œåé¢çš„<code>é€—å·ä¹‹åçš„æ¡ä»¶</code>å‘ç°æ‰§è¡ŒæˆåŠŸ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query=<span class="string">'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}'</span> --<span class="built_in">type</span>=csv --fields _id,content_id,content_tags --out=***.csv</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2019-05-17T13:41:33.068+0800    connected to: localhost:29001</span><br><span class="line">2019-05-17T13:41:34.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:35.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:36.067+0800    feeds.content_medium_hismatch  0</span><br><span class="line">2019-05-17T13:41:36.656+0800    feeds.content_medium_hismatch  18870</span><br><span class="line">2019-05-17T13:41:36.656+0800    exported 18870 records</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment"># cat content_medium_hismatch.csv |wc -l</span></span><br><span class="line">18871</span><br><span class="line">public-ops-mongodb2 seclogin <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>å’Œå¼€å‘ç¡®è®¤ä¸€ä¸‹è¿™ä¸ªæ¡ä»¶èƒ½å¦å´æ‰ï¼Œå¼€å‘ç¡®è®¤å¯ä»¥å»æ‰ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>mongoexport</code>åœ¨æ‰§è¡Œæœ‰æ¡ä»¶çš„å¯¼å‡ºæ–‡ä»¶ï¼Œ<code>--query</code> æ¡ä»¶è¦å†™åœ¨ä¸€ä¸ª<code>èŠ±æ‹¬å·{}</code>é‡Œé¢ï¼Œå¦‚æœè¦æœ‰ä¸¤ä¸ª<code>èŠ±æ‹¬å·{}</code>çš„æ¡ä»¶ï¼Œä¸­é—´ç”¨<code>é€—å·,</code>åˆ†å‰²ï¼Œè¿™æ ·æ˜¯ä¸è¡Œçš„ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;qiong.gif&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MongoDB" scheme="https://jiemin.wang/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://jiemin.wang/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>è¯¦ç»†çš„MySQLé«˜æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ€»ç»“</title>
    <link href="https://jiemin.wang/2019/05/16/mysql-innodb/"/>
    <id>https://jiemin.wang/2019/05/16/mysql-innodb/</id>
    <published>2019-05-16T09:53:50.000Z</published>
    <updated>2019-05-16T11:59:42.490Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>åŠªåŠ›ä¸ä¸€å®šæˆåŠŸï¼Œä½†æ˜¯ä¸åŠªåŠ›ä¼šå¾ˆèˆ’æœçš„å“¦!</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>MySQL å¯¹äºå¾ˆå¤š Linux ä»ä¸šè€…è€Œè¨€ï¼Œæ˜¯ä¸€ä¸ªéå¸¸æ£˜æ‰‹çš„é—®é¢˜ï¼Œå¤šæ•°æƒ…å†µéƒ½æ˜¯å› ä¸ºå¯¹æ•°æ®åº“å‡ºç°é—®é¢˜çš„æƒ…å†µå’Œå¤„ç†æ€è·¯ä¸æ¸…æ™°ã€‚</p><p>åœ¨è¿›è¡Œ MySQL çš„ä¼˜åŒ–ä¹‹å‰å¿…é¡»è¦äº†è§£çš„å°±æ˜¯ MySQL çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®© MySQL çš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚</p><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><img src="http://www.plantuml.com/plantuml/svg/bLDTIm9157sVNx5i3tt0Rk_Bij3NWv15I0-HFKGj4SKgMeH4q4EKbPfbXPPeQub2k4e41Hh-6MTs_HVDxgop7ndHFDsvSywvToxdHjStTjQtP8OD9a9BymmgLurcnUYUwVLBzX0m-8pDx6xBojwuTLbb2KBlv60ZpwxPIQFsZ4fPMAZxCkZfccRwbHFuSg9dJzqmTD_wYIGbUfqyJDrxmESrGqqPcWgJDpwmhn-I97ZOkKEv37qAA4faTffUWub0Q2f8hxnr79sx5afhzBeo5wBnmY8EZm1OZiinHkHNHsBovXelEUCQ128l-RiK6AXLKF93VsrEec8QNgWu2YlzuuTULuNfAqFJm2ZbSzw9O7f2ZeSL_V4TPQf6znO-blHsWIe2VpLkFyf9TlEuylLNxxE1wTOhS5SXY7-AIsGK0eFUL5GyjsL9qdnqMKCWCVOPyEIvpSY1uc0jAmZwRHabis65ve3VGcRBRWPv8kfUNvb8BzTkvNSAxUc76V5FBL_PB8ydHNFMGpaO7LPiiBLTv7zWk5T5KjulBtWg3-5DqBQfpVy2qWNu2qXNmn5tXZJOazz4Y0LzMq02RBPs3fMABYjYzCHm9O5OSi3v1W00"><h3 id="ä¼˜åŒ–çš„å“²å­¦"><a href="#ä¼˜åŒ–çš„å“²å­¦" class="headerlink" title="ä¼˜åŒ–çš„å“²å­¦"></a>ä¼˜åŒ–çš„å“²å­¦</h3><blockquote><p>æ³¨ï¼šä¼˜åŒ–æœ‰é£é™©ï¼Œä¿®æ”¹éœ€è°¨æ…ã€‚</p></blockquote><ul><li>ä¼˜åŒ–å¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼š</li><li>ä¼˜åŒ–ä¸æ€»æ˜¯å¯¹ä¸€ä¸ªå•çº¯çš„ç¯å¢ƒè¿›è¡Œï¼Œè¿˜å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„å·²æŠ•äº§çš„ç³»ç»Ÿã€‚</li><li>ä¼˜åŒ–æ‰‹æ®µæœ¬æ¥å°±æœ‰å¾ˆå¤§çš„é£é™©ï¼Œåªä¸è¿‡ä½ æ²¡èƒ½åŠ›æ„è¯†åˆ°å’Œé¢„è§åˆ°ã€‚</li><li>ä»»ä½•çš„æŠ€æœ¯å¯ä»¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œä½†å¿…ç„¶å­˜åœ¨å¸¦æ¥ä¸€ä¸ªé—®é¢˜çš„é£é™©ã€‚</li><li>å¯¹äºä¼˜åŒ–æ¥è¯´è§£å†³é—®é¢˜è€Œå¸¦æ¥çš„é—®é¢˜ï¼Œæ§åˆ¶åœ¨å¯æ¥å—çš„èŒƒå›´å†…æ‰æ˜¯æœ‰æˆæœã€‚</li><li>ä¿æŒç°çŠ¶æˆ–å‡ºç°æ›´å·®çš„æƒ…å†µéƒ½æ˜¯å¤±è´¥ã€‚</li></ul><p>ä¼˜åŒ–çš„éœ€æ±‚ï¼š</p><ul><li>ç¨³å®šæ€§å’Œä¸šåŠ¡å¯æŒç»­æ€§ï¼Œé€šå¸¸æ¯”æ€§èƒ½æ›´é‡è¦ã€‚</li><li>ä¼˜åŒ–ä¸å¯é¿å…æ¶‰åŠåˆ°å˜æ›´ï¼Œå˜æ›´å°±æœ‰é£é™©ã€‚</li><li>ä¼˜åŒ–ä½¿æ€§èƒ½å˜å¥½ï¼Œç»´æŒå’Œå˜å·®æ˜¯ç­‰æ¦‚ç‡äº‹ä»¶ã€‚</li><li>åˆ‡è®°ä¼˜åŒ–ï¼Œåº”è¯¥æ˜¯å„éƒ¨é—¨ååŒï¼Œå…±åŒå‚ä¸çš„å·¥ä½œï¼Œä»»ä½•å•ä¸€éƒ¨é—¨éƒ½ä¸èƒ½å¯¹æ•°æ®åº“è¿›è¡Œä¼˜åŒ–ã€‚</li></ul><p>æ‰€ä»¥ä¼˜åŒ–å·¥ä½œï¼Œæ˜¯ç”±ä¸šåŠ¡éœ€æ±‚é©±ä½¿çš„!</p><p>ä¼˜åŒ–ç”±è°å‚ä¸?åœ¨è¿›è¡Œæ•°æ®åº“ä¼˜åŒ–æ—¶ï¼Œåº”ç”±æ•°æ®åº“ç®¡ç†å‘˜ã€ä¸šåŠ¡éƒ¨é—¨ä»£è¡¨ã€åº”ç”¨ç¨‹åºæ¶æ„å¸ˆã€åº”ç”¨ç¨‹åºè®¾è®¡äººå‘˜ã€åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€ç¡¬ä»¶åŠç³»ç»Ÿç®¡ç†å‘˜ã€å­˜å‚¨ç®¡ç†å‘˜ç­‰ï¼Œä¸šåŠ¡ç›¸å…³äººå‘˜å…±åŒå‚ä¸ã€‚</p><h4 id="ä¼˜åŒ–æ€è·¯"><a href="#ä¼˜åŒ–æ€è·¯" class="headerlink" title="ä¼˜åŒ–æ€è·¯"></a>ä¼˜åŒ–æ€è·¯</h4><h4 id="ä¼˜åŒ–ä»€ä¹ˆ"><a href="#ä¼˜åŒ–ä»€ä¹ˆ" class="headerlink" title="ä¼˜åŒ–ä»€ä¹ˆ"></a>ä¼˜åŒ–ä»€ä¹ˆ</h4><p>åœ¨æ•°æ®åº“ä¼˜åŒ–ä¸Šæœ‰ä¸¤ä¸ªä¸»è¦æ–¹é¢ï¼š</p><ul><li>å®‰å…¨ï¼šæ•°æ®å¯æŒç»­æ€§ã€‚</li><li>æ€§èƒ½ï¼šæ•°æ®çš„é«˜æ€§èƒ½è®¿é—®ã€‚</li></ul><h4 id="ä¼˜åŒ–çš„èŒƒå›´æœ‰å“ªäº›"><a href="#ä¼˜åŒ–çš„èŒƒå›´æœ‰å“ªäº›" class="headerlink" title="ä¼˜åŒ–çš„èŒƒå›´æœ‰å“ªäº›"></a>ä¼˜åŒ–çš„èŒƒå›´æœ‰å“ªäº›</h4><p>å­˜å‚¨ã€ä¸»æœºå’Œæ“ä½œç³»ç»Ÿæ–¹é¢ï¼š</p><ul><li>ä¸»æœºæ¶æ„ç¨³å®šæ€§</li><li>I/O è§„åˆ’åŠé…ç½®</li><li>Swap äº¤æ¢åˆ†åŒº</li><li>OS å†…æ ¸å‚æ•°å’Œç½‘ç»œé—®é¢˜</li></ul><p>åº”ç”¨ç¨‹åºæ–¹é¢ï¼š</p><ul><li>åº”ç”¨ç¨‹åºç¨³å®šæ€§</li><li>SQL è¯­å¥æ€§èƒ½</li><li>ä¸²è¡Œè®¿é—®èµ„æº</li><li>æ€§èƒ½æ¬ ä½³ä¼šè¯ç®¡ç†</li><li>è¿™ä¸ªåº”ç”¨é€‚ä¸é€‚åˆç”¨ MySQL</li></ul><p>æ•°æ®åº“ä¼˜åŒ–æ–¹é¢ï¼š</p><ul><li>å†…å­˜</li><li>æ•°æ®åº“ç»“æ„(ç‰©ç†&é€»è¾‘)</li><li>å®ä¾‹é…ç½®</li></ul><blockquote><p>è¯´æ˜ï¼šä¸ç®¡æ˜¯è®¾è®¡ç³»ç»Ÿã€å®šä½é—®é¢˜è¿˜æ˜¯ä¼˜åŒ–ï¼Œéƒ½å¯ä»¥æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚</p></blockquote><h4 id="ä¼˜åŒ–ç»´åº¦"><a href="#ä¼˜åŒ–ç»´åº¦" class="headerlink" title="ä¼˜åŒ–ç»´åº¦"></a>ä¼˜åŒ–ç»´åº¦</h4><img src="/2019/05/16/mysql-innodb/weidu.jpeg" title="weidu"><p>æ•°æ®åº“ä¼˜åŒ–ç»´åº¦æœ‰å¦‚ä¸‹å››ä¸ª:</p><ul><li>ç¡¬ä»¶</li><li>ç³»ç»Ÿé…ç½®</li><li>æ•°æ®åº“è¡¨ç»“æ„</li><li>SQL åŠç´¢å¼•</li></ul><p>ä¼˜åŒ–é€‰æ‹©:</p><ul><li>ä¼˜åŒ–æˆæœ¬ï¼šç¡¬ä»¶>ç³»ç»Ÿé…ç½®>æ•°æ®åº“è¡¨ç»“æ„>SQL åŠç´¢å¼•ã€‚</li><li>ä¼˜åŒ–æ•ˆæœï¼šç¡¬ä»¶<ç³»ç»Ÿé…ç½®<æ•°æ®åº“è¡¨ç»“æ„</li></ul><h4 id="ä¼˜åŒ–å·¥å…·æœ‰å•¥"><a href="#ä¼˜åŒ–å·¥å…·æœ‰å•¥" class="headerlink" title="ä¼˜åŒ–å·¥å…·æœ‰å•¥"></a>ä¼˜åŒ–å·¥å…·æœ‰å•¥</h4><h2 id="æ•°æ®åº“å±‚é¢"><a href="#æ•°æ®åº“å±‚é¢" class="headerlink" title="æ•°æ®åº“å±‚é¢"></a>æ•°æ®åº“å±‚é¢</h2><p>æ£€æŸ¥é—®é¢˜å¸¸ç”¨çš„ 12 ä¸ªå·¥å…·:</p><ul><li>MySQL</li><li>mysqladminï¼šMySQL å®¢æˆ·ç«¯ï¼Œå¯è¿›è¡Œç®¡ç†æ“ä½œ</li><li>mysqlshowï¼šåŠŸèƒ½å¼ºå¤§çš„æŸ¥çœ‹ shell å‘½ä»¤</li><li>SHOW [SESSION | GLOBAL] variablesï¼šæŸ¥çœ‹æ•°æ®åº“å‚æ•°ä¿¡æ¯</li><li>SHOW [SESSION | GLOBAL] STATUSï¼šæŸ¥çœ‹æ•°æ®åº“çš„çŠ¶æ€ä¿¡æ¯</li><li>information_schemaï¼šè·å–å…ƒæ•°æ®çš„æ–¹æ³•</li><li>SHOW ENGINE INNODB STATUSï¼šInnodb å¼•æ“çš„æ‰€æœ‰çŠ¶æ€</li><li>SHOW PROCESSLISTï¼šæŸ¥çœ‹å½“å‰æ‰€æœ‰è¿æ¥çš„ session çŠ¶æ€</li><li>explainï¼šè·å–æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’</li><li>show indexï¼šæŸ¥çœ‹è¡¨çš„ç´¢å¼•ä¿¡æ¯</li><li>slow-logï¼šè®°å½•æ…¢æŸ¥è¯¢è¯­å¥</li><li>mysqldumpslowï¼šåˆ†æ slowlog æ–‡ä»¶çš„å·¥å…·</li></ul><p>ä¸å¸¸ç”¨ä½†å¥½ç”¨çš„ 7 ä¸ªå·¥å…·:</p><ul><li>Zabbixï¼šç›‘æ§ä¸»æœºã€ç³»ç»Ÿã€æ•°æ®åº“(éƒ¨ç½² Zabbix ç›‘æ§å¹³å°)</li><li>pt-query-digestï¼šåˆ†ææ…¢æ—¥å¿—</li><li>MySQL slapï¼šåˆ†ææ…¢æ—¥å¿—</li><li>sysbenchï¼šå‹åŠ›æµ‹è¯•å·¥å…·</li><li>MySQL profilingï¼šç»Ÿè®¡æ•°æ®åº“æ•´ä½“çŠ¶æ€å·¥å…·</li><li>Performance Schemaï¼šMySQL æ€§èƒ½çŠ¶æ€ç»Ÿè®¡çš„æ•°æ®</li><li>workbenchï¼šç®¡ç†ã€å¤‡ä»½ã€ç›‘æ§ã€åˆ†æã€ä¼˜åŒ–å·¥å…·(æ¯”è¾ƒè´¹èµ„æº)</li></ul><h4 id="æ•°æ®åº“å±‚é¢é—®é¢˜è§£å†³æ€è·¯"><a href="#æ•°æ®åº“å±‚é¢é—®é¢˜è§£å†³æ€è·¯" class="headerlink" title="æ•°æ®åº“å±‚é¢é—®é¢˜è§£å†³æ€è·¯"></a>æ•°æ®åº“å±‚é¢é—®é¢˜è§£å†³æ€è·¯</h4><p>ä¸€èˆ¬åº”æ€¥è°ƒä¼˜çš„æ€è·¯ï¼šé’ˆå¯¹çªç„¶çš„ä¸šåŠ¡åŠç†å¡é¡¿ï¼Œæ— æ³•è¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡å¤„ç†ï¼Œéœ€è¦é©¬ä¸Šè§£å†³çš„åœºæ™¯ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show processlist </span><br><span class="line">explain select id ,name from stu <span class="built_in">where</span> name=<span class="string">'clsn'</span>; <span class="comment"># ALL id name age sex </span></span><br><span class="line"> select id,name from stu <span class="built_in">where</span> id=2-1 å‡½æ•° ç»“æœé›†>30; </span><br><span class="line">ã€€ show index from table; </span><br><span class="line">é€šè¿‡æ‰§è¡Œè®¡åˆ’åˆ¤æ–­ï¼Œç´¢å¼•é—®é¢˜ï¼ˆæœ‰æ²¡æœ‰ã€åˆä¸åˆç†ï¼‰æˆ–è€…è¯­å¥æœ¬èº«é—®é¢˜ </span><br><span class="line">show status like <span class="string">'%lock%'</span>; <span class="comment"># æŸ¥è¯¢é”çŠ¶æ€ </span></span><br><span class="line"><span class="built_in">kill</span> SESSION_ID; <span class="comment"># æ€æ‰æœ‰é—®é¢˜çš„session</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¸¸è§„è°ƒä¼˜æ€è·¯ï¼šé’ˆå¯¹ä¸šåŠ¡å‘¨æœŸæ€§çš„å¡é¡¿ï¼Œä¾‹å¦‚åœ¨æ¯å¤© 10-11 ç‚¹ä¸šåŠ¡ç‰¹åˆ«æ…¢ï¼Œä½†æ˜¯è¿˜èƒ½å¤Ÿä½¿ç”¨ï¼Œè¿‡äº†è¿™æ®µæ—¶é—´å°±å¥½äº†ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥çœ‹slowlogï¼Œåˆ†æslowlogï¼Œåˆ†æå‡ºæŸ¥è¯¢æ…¢çš„è¯­å¥ï¼› </span><br><span class="line">æŒ‰ç…§ä¸€å®šä¼˜å…ˆçº§ï¼Œä¸€ä¸ªä¸€ä¸ªæ’æŸ¥æ‰€æœ‰æ…¢è¯­å¥ï¼› </span><br><span class="line">åˆ†ætop SQLï¼Œè¿›è¡Œexplainè°ƒè¯•ï¼ŒæŸ¥çœ‹è¯­å¥æ‰§è¡Œæ—¶é—´ï¼› </span><br><span class="line">è°ƒæ•´ç´¢å¼•æˆ–è¯­å¥æœ¬èº«ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="ç³»ç»Ÿå±‚é¢"><a href="#ç³»ç»Ÿå±‚é¢" class="headerlink" title="ç³»ç»Ÿå±‚é¢"></a>ç³»ç»Ÿå±‚é¢</h4><p>CPUæ–¹é¢ï¼švmstatã€sar topã€htopã€nmonã€mpstatã€‚</p><p>å†…å­˜ï¼šfreeã€ps-auxã€‚</p><p>IO è®¾å¤‡(ç£ç›˜ã€ç½‘ç»œ)ï¼šiostatã€ssã€netstatã€iptrafã€iftopã€lsofã€‚</p><p>vmstat å‘½ä»¤è¯´æ˜ï¼š</p><ul><li>Procsï¼šr æ˜¾ç¤ºæœ‰å¤šå°‘è¿›ç¨‹æ­£åœ¨ç­‰å¾… CPU æ—¶é—´ã€‚b æ˜¾ç¤ºå¤„äºä¸å¯ä¸­æ–­çš„ä¼‘çœ çš„è¿›ç¨‹æ•°é‡ã€‚åœ¨ç­‰å¾… I/Oã€‚</li><li>Memoryï¼šswpd æ˜¾ç¤ºè¢«äº¤æ¢åˆ°ç£ç›˜çš„æ•°æ®å—çš„æ•°é‡ã€‚æœªè¢«ä½¿ç”¨çš„æ•°æ®å—ï¼Œç”¨æˆ·ç¼“å†²æ•°æ®å—ï¼Œç”¨äºæ“ä½œç³»ç»Ÿçš„æ•°æ®å—çš„æ•°é‡ã€‚</li><li>Swapï¼šæ“ä½œç³»ç»Ÿæ¯ç§’ä»ç£ç›˜ä¸Šäº¤æ¢åˆ°å†…å­˜å’Œä»å†…å­˜äº¤æ¢åˆ°ç£ç›˜çš„æ•°æ®å—çš„æ•°é‡ã€‚s1 å’Œ s0 æœ€å¥½æ˜¯ 0ã€‚</li><li>IOï¼šæ¯ç§’ä»è®¾å¤‡ä¸­è¯»å…¥ b1 çš„å†™å…¥åˆ°è®¾å¤‡ b0 çš„æ•°æ®å—çš„æ•°é‡ã€‚åæ˜ äº†ç£ç›˜ I/Oã€‚</li><li>Systemï¼šæ˜¾ç¤ºäº†æ¯ç§’å‘ç”Ÿä¸­æ–­çš„æ•°é‡(in)å’Œä¸Šä¸‹æ–‡äº¤æ¢(cs)çš„æ•°é‡ã€‚</li><li>CPUï¼šæ˜¾ç¤ºç”¨äºè¿è¡Œç”¨æˆ·ä»£ç ï¼Œç³»ç»Ÿä»£ç ï¼Œç©ºé—²ï¼Œç­‰å¾… I/O çš„ CPU æ—¶é—´ã€‚</li></ul><p>iostat å‘½ä»¤è¯´æ˜ï¼š</p><ul><li>å®ä¾‹å‘½ä»¤ï¼šiostat -dk 1 5;iostat -d -k -x 5 (æŸ¥çœ‹è®¾å¤‡ä½¿ç”¨ç‡(%util)å’Œå“åº”æ—¶é—´(await))ã€‚</li><li>TPSï¼šè¯¥è®¾å¤‡æ¯ç§’çš„ä¼ è¾“æ¬¡æ•°ã€‚â€œä¸€æ¬¡ä¼ è¾“â€æ„æ€æ˜¯â€œä¸€æ¬¡ I/O è¯·æ±‚â€ã€‚å¤šä¸ªé€»è¾‘è¯·æ±‚å¯èƒ½ä¼šè¢«åˆå¹¶ä¸ºâ€œä¸€æ¬¡ I/O è¯·æ±‚â€ã€‚</li><li>iops ï¼šç¡¬ä»¶å‡ºå‚çš„æ—¶å€™ï¼Œå‚å®¶å®šä¹‰çš„ä¸€ä¸ªæ¯ç§’æœ€å¤§çš„ IO æ¬¡æ•°ã€‚</li><li>â€œä¸€æ¬¡ä¼ è¾“â€è¯·æ±‚çš„å¤§å°æ˜¯æœªçŸ¥çš„ã€‚</li><li>KB_read/sï¼šæ¯ç§’ä»è®¾å¤‡(drive expressed)è¯»å–çš„æ•°æ®é‡ã€‚</li><li>KB_wrtn/sï¼šæ¯ç§’å‘è®¾å¤‡(drive expressed)å†™å…¥çš„æ•°æ®é‡ã€‚</li><li>KB_readï¼šè¯»å–çš„æ€»æ•°æ®é‡ã€‚</li><li>KB_wrtnï¼šå†™å…¥çš„æ€»æ•°é‡æ•°æ®é‡;è¿™äº›å•ä½éƒ½ä¸º Kilobytesã€‚</li></ul><h4 id="ç³»ç»Ÿå±‚é¢é—®é¢˜è§£å†³åŠæ³•"><a href="#ç³»ç»Ÿå±‚é¢é—®é¢˜è§£å†³åŠæ³•" class="headerlink" title="ç³»ç»Ÿå±‚é¢é—®é¢˜è§£å†³åŠæ³•"></a>ç³»ç»Ÿå±‚é¢é—®é¢˜è§£å†³åŠæ³•</h4><p>ä½ è®¤ä¸ºåˆ°åº•è´Ÿè½½é«˜å¥½ï¼Œè¿˜æ˜¯ä½å¥½å‘¢?åœ¨å®é™…çš„ç”Ÿäº§ä¸­ï¼Œä¸€èˆ¬è®¤ä¸º CPU åªè¦ä¸è¶…è¿‡ 90% éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ã€‚å½“ç„¶ä¸æ’é™¤ä¸‹é¢è¿™äº›ç‰¹æ®Šæƒ…å†µã€‚</p><p>CPU è´Ÿè½½é«˜ï¼ŒIO è´Ÿè½½ä½ï¼š</p><ul><li>å†…å­˜ä¸å¤Ÿ</li><li>ç£ç›˜æ€§èƒ½å·®</li><li>SQL é—®é¢˜ï¼šå»æ•°æ®åº“å±‚ï¼Œè¿›ä¸€æ­¥æ’æŸ¥ SQL é—®é¢˜</li><li>IO å‡ºé—®é¢˜äº†(ç£ç›˜åˆ°ä¸´ç•Œäº†ã€raid è®¾è®¡ä¸å¥½ã€raid é™çº§ã€é”ã€åœ¨å•ä½æ—¶é—´å†… TPS è¿‡é«˜)</li><li>TPS è¿‡é«˜ï¼šå¤§é‡çš„å°æ•°æ® IOã€å¤§é‡çš„å…¨è¡¨æ‰«æ</li></ul><p>IO è´Ÿè½½é«˜ï¼ŒCPU è´Ÿè½½ä½ï¼š</p><ul><li>å¤§é‡å°çš„ IO å†™æ“ä½œ</li><li>autocommitï¼Œäº§ç”Ÿå¤§é‡å° IO;IO/PSï¼Œç£ç›˜çš„ä¸€ä¸ªå®šå€¼ï¼Œç¡¬ä»¶å‡ºå‚çš„æ—¶å€™ï¼Œå‚å®¶å®šä¹‰çš„ä¸€ä¸ªæ¯ç§’æœ€å¤§çš„ IO æ¬¡æ•°ã€‚</li><li>å¤§é‡å¤§çš„ IO å†™æ“ä½œï¼šSQL é—®é¢˜çš„å‡ ç‡æ¯”è¾ƒå¤§</li></ul><p>IOå’Œ CPU è´Ÿè½½éƒ½å¾ˆé«˜ï¼š</p><ul><li>ç¡¬ä»¶ä¸å¤Ÿäº†æˆ– SQL å­˜åœ¨é—®é¢˜</li></ul><h2 id="åŸºç¡€ä¼˜åŒ–"><a href="#åŸºç¡€ä¼˜åŒ–" class="headerlink" title="åŸºç¡€ä¼˜åŒ–"></a>åŸºç¡€ä¼˜åŒ–</h2><h4 id="ä¼˜åŒ–æ€è·¯-1"><a href="#ä¼˜åŒ–æ€è·¯-1" class="headerlink" title="ä¼˜åŒ–æ€è·¯"></a>ä¼˜åŒ–æ€è·¯</h4><p>å®šä½é—®é¢˜ç‚¹å®å¸ï¼šç¡¬ä»¶>ç³»ç»Ÿ>åº”ç”¨>æ•°æ®åº“>æ¶æ„(é«˜å¯ç”¨ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨)ã€‚</p><p>å¤„ç†æ–¹å‘ï¼šæ˜ç¡®ä¼˜åŒ–ç›®æ ‡ã€æ€§èƒ½å’Œå®‰å…¨çš„æŠ˜ä¸­ã€é˜²æ‚£æœªç„¶ã€‚</p><h4 id="ç¡¬ä»¶ä¼˜åŒ–"><a href="#ç¡¬ä»¶ä¼˜åŒ–" class="headerlink" title="ç¡¬ä»¶ä¼˜åŒ–"></a>ç¡¬ä»¶ä¼˜åŒ–</h4><h5 id="ä¸»æœºæ–¹é¢"><a href="#ä¸»æœºæ–¹é¢" class="headerlink" title="ä¸»æœºæ–¹é¢"></a>ä¸»æœºæ–¹é¢</h5><p>æ ¹æ®æ•°æ®åº“ç±»å‹ï¼Œä¸»æœº CPU é€‰æ‹©ã€å†…å­˜å®¹é‡é€‰æ‹©ã€ç£ç›˜é€‰æ‹©ï¼š</p><ul><li>å¹³è¡¡å†…å­˜å’Œç£ç›˜èµ„æº</li><li>éšæœºçš„ I/O å’Œé¡ºåºçš„ I/O</li><li>ä¸»æœº RAID å¡çš„ BBU(Battery Backup Unit)å…³é—­</li></ul><h5 id="CPU-çš„é€‰æ‹©"><a href="#CPU-çš„é€‰æ‹©" class="headerlink" title="CPU çš„é€‰æ‹©"></a>CPU çš„é€‰æ‹©</h5><p>CPU çš„ä¸¤ä¸ªå…³é”®å› ç´ ï¼šæ ¸æ•°ã€ä¸»é¢‘ã€‚æ ¹æ®ä¸åŒçš„ä¸šåŠ¡ç±»å‹è¿›è¡Œé€‰æ‹©ï¼š</p><ul><li>CPU å¯†é›†å‹ï¼šè®¡ç®—æ¯”è¾ƒå¤šï¼ŒOLTP ä¸»é¢‘å¾ˆé«˜çš„ CPUã€æ ¸æ•°è¿˜è¦å¤šã€‚</li><li>IO å¯†é›†å‹ï¼šæŸ¥è¯¢æ¯”è¾ƒï¼ŒOLAP æ ¸æ•°è¦å¤šï¼Œä¸»é¢‘ä¸ä¸€å®šé«˜çš„ã€‚</li></ul><h5 id="å†…å­˜çš„é€‰æ‹©"><a href="#å†…å­˜çš„é€‰æ‹©" class="headerlink" title="å†…å­˜çš„é€‰æ‹©"></a>å†…å­˜çš„é€‰æ‹©</h5><p>OLAP ç±»å‹æ•°æ®åº“ï¼Œéœ€è¦æ›´å¤šå†…å­˜ï¼Œå’Œæ•°æ®è·å–é‡çº§æœ‰å…³ã€‚OLTP ç±»å‹æ•°æ®ä¸€èˆ¬å†…å­˜æ˜¯ CPU æ ¸å¿ƒæ•°é‡çš„ 2 å€åˆ° 4 å€ï¼Œæ²¡æœ‰æœ€ä½³å®è·µã€‚</p><h5 id="å­˜å‚¨æ–¹é¢"><a href="#å­˜å‚¨æ–¹é¢" class="headerlink" title="å­˜å‚¨æ–¹é¢"></a>å­˜å‚¨æ–¹é¢</h5><p>æ ¹æ®å­˜å‚¨æ•°æ®ç§ç±»çš„ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„å­˜å‚¨è®¾å¤‡ï¼Œé…ç½®åˆç†çš„ RAID çº§åˆ«(raid5ã€raid10ã€çƒ­å¤‡ç›˜)ã€‚</p><p>å¯¹äºæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œä¸éœ€è¦å¤ªç‰¹æ®Šçš„é€‰æ‹©ï¼Œæœ€å¥½åšå¥½å†—ä½™(raid1)(ssdã€sasã€sata)ã€‚</p><p>ä¸»æœº raid å¡é€‰æ‹©ï¼š</p><ul><li>å®ç°æ“ä½œç³»ç»Ÿç£ç›˜çš„å†—ä½™(raid1)</li><li>å¹³è¡¡å†…å­˜å’Œç£ç›˜èµ„æº</li><li>éšæœºçš„ I/O å’Œé¡ºåºçš„ I/O</li><li>ä¸»æœº raid å¡çš„ BBU(Battery Backup Unit)è¦å…³é—­</li></ul><h5 id="ç½‘ç»œè®¾å¤‡æ–¹é¢"><a href="#ç½‘ç»œè®¾å¤‡æ–¹é¢" class="headerlink" title="ç½‘ç»œè®¾å¤‡æ–¹é¢"></a>ç½‘ç»œè®¾å¤‡æ–¹é¢</h5><p>ä½¿ç”¨æµé‡æ”¯æŒæ›´é«˜çš„ç½‘ç»œè®¾å¤‡(äº¤æ¢æœºã€è·¯ç”±å™¨ã€ç½‘çº¿ã€ç½‘å¡ã€HBA å¡)ã€‚æ³¨æ„ï¼šä»¥ä¸Šè¿™äº›è§„åˆ’åº”è¯¥åœ¨åˆå§‹è®¾è®¡ç³»ç»Ÿæ—¶å°±åº”è¯¥è€ƒè™‘å¥½ã€‚</p><h4 id="æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–"><a href="#æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–" class="headerlink" title="æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–"></a>æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–</h4><p>æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–å…³é”®ç‚¹ï¼š</p><ul><li>ç‰©ç†çŠ¶æ€ç¯</li><li>è‡ªå¸¦ç®¡ç†è®¾å¤‡ï¼šè¿œç¨‹æ§åˆ¶å¡(FENCEè®¾å¤‡ï¼šipmi ilo idarc)ã€å¼€å…³æœºã€ç¡¬ä»¶ç›‘æ§ã€‚</li><li>ç¬¬ä¸‰æ–¹çš„ç›‘æ§è½¯ä»¶ã€è®¾å¤‡(snmpã€agent)å¯¹ç‰©ç†è®¾æ–½è¿›è¡Œç›‘æ§ã€‚</li><li>å­˜å‚¨è®¾å¤‡ï¼šè‡ªå¸¦çš„ç›‘æ§å¹³å°ã€‚EMC2(HP æ”¶è´­äº†)ã€ æ—¥ç«‹(HDS)ã€IBM ä½ç«¯ OEM HDSã€é«˜ç«¯å­˜å‚¨æ˜¯è‡ªå·±æŠ€æœ¯ï¼Œåä¸ºå­˜å‚¨ã€‚</li></ul><h4 id="ç³»ç»Ÿä¼˜åŒ–"><a href="#ç³»ç»Ÿä¼˜åŒ–" class="headerlink" title="ç³»ç»Ÿä¼˜åŒ–"></a>ç³»ç»Ÿä¼˜åŒ–</h4><p>CPUï¼šåŸºæœ¬ä¸éœ€è¦è°ƒæ•´ï¼Œåœ¨ç¡¬ä»¶é€‰æ‹©æ–¹é¢ä¸‹åŠŸå¤«å³å¯ã€‚</p><p>å†…å­˜ï¼šåŸºæœ¬ä¸éœ€è¦è°ƒæ•´ï¼Œåœ¨ç¡¬ä»¶é€‰æ‹©æ–¹é¢ä¸‹åŠŸå¤«å³å¯ã€‚</p><p>SWAPï¼šMySQL å°½é‡é¿å…ä½¿ç”¨ Swapã€‚é˜¿é‡Œäº‘çš„æœåŠ¡å™¨ä¸­é»˜è®¤ swap ä¸º 0ã€‚</p><p>IO ï¼šraidã€no lvmã€ext4 æˆ– xfsã€ssdã€IO è°ƒåº¦ç­–ç•¥ã€‚</p><p>Swap è°ƒæ•´(ä¸ä½¿ç”¨ swap åˆ†åŒº)ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm/swappinessçš„å†…å®¹æ”¹æˆ0(ä¸´æ—¶)ï¼Œ/etc/sysctl. confä¸Šæ·»åŠ vm.swappiness=0(æ°¸ä¹…)</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™ä¸ªå‚æ•°å†³å®šäº† Linux æ˜¯å€¾å‘äºä½¿ç”¨ Swapï¼Œè¿˜æ˜¯å€¾å‘äºé‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚åœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹ï¼Œæ•°å€¼è¶Šä½è¶Šå€¾å‘äºé‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸ªå‚æ•°åªèƒ½å‡å°‘ä½¿ç”¨ Swap çš„æ¦‚ç‡ï¼Œå¹¶ä¸èƒ½é¿å… Linux ä½¿ç”¨ Swapã€‚</p><p>ä¿®æ”¹ MySQL çš„é…ç½®å‚æ•° innodb_flush_ methodï¼Œå¼€å¯ O_DIRECT æ¨¡å¼ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒInnoDB çš„ buffer pool ä¼šç›´æ¥ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿ Cache æ¥è®¿é—®ç£ç›˜ï¼Œä½†æ˜¯ redo log ä¾æ—§ä¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒRedo log æ˜¯è¦†å†™æ¨¡å¼çš„ï¼Œå³ä½¿ä½¿ç”¨äº†æ–‡ä»¶ç³»ç»Ÿçš„ Cacheï¼Œä¹Ÿä¸ä¼šå ç”¨å¤ªå¤šã€‚</p><p>IO è°ƒåº¦ç­–ç•¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#echo deadline>/sys/block/sda/queue/scheduler ä¸´æ—¶ä¿®æ”¹ä¸ºdeadline</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>æ°¸ä¹…ä¿®æ”¹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /boot/grub/grub.conf </span><br><span class="line">æ›´æ”¹åˆ°å¦‚ä¸‹å†…å®¹: </span><br><span class="line">kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="ç³»ç»Ÿå‚æ•°è°ƒæ•´"><a href="#ç³»ç»Ÿå‚æ•°è°ƒæ•´" class="headerlink" title="ç³»ç»Ÿå‚æ•°è°ƒæ•´"></a>ç³»ç»Ÿå‚æ•°è°ƒæ•´</h4><p>Linux ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ–<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/sysctl.conf </span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535ï¼š<span class="comment"># ç”¨æˆ·ç«¯å£èŒƒå›´ </span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096 </span><br><span class="line">net.ipv4.tcp_fin_timeout = 30 </span><br><span class="line">fs.file-max=65535ï¼š<span class="comment"># ç³»ç»Ÿæœ€å¤§æ–‡ä»¶å¥æŸ„ï¼Œæ§åˆ¶çš„æ˜¯èƒ½æ‰“å¼€æ–‡ä»¶æœ€å¤§æ•°é‡</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ç”¨æˆ·é™åˆ¶å‚æ•°(MySQL å¯ä»¥ä¸è®¾ç½®ä»¥ä¸‹é…ç½®)ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/security/limits.conf </span><br><span class="line">* soft nproc 65535 </span><br><span class="line">* hard nproc 65535 </span><br><span class="line">* soft nofile 65535 </span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="åº”ç”¨ä¼˜åŒ–"><a href="#åº”ç”¨ä¼˜åŒ–" class="headerlink" title="åº”ç”¨ä¼˜åŒ–"></a>åº”ç”¨ä¼˜åŒ–</h2><p>ä¸šåŠ¡åº”ç”¨å’Œæ•°æ®åº“åº”ç”¨ç‹¬ç«‹ã€‚</p><p>é˜²ç«å¢™ï¼šiptablesã€selinux ç­‰å…¶ä»–æ— ç”¨æœåŠ¡(å…³é—­)ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 23456 acpid off </span><br><span class="line">chkconfig --level 23456 anacron off </span><br><span class="line">chkconfig --level 23456 autofs off </span><br><span class="line">chkconfig --level 23456 avahi-daemon off </span><br><span class="line">chkconfig --level 23456 bluetooth off </span><br><span class="line">chkconfig --level 23456 cups off </span><br><span class="line">chkconfig --level 23456 firstboot off </span><br><span class="line">chkconfig --level 23456 haldaemon off </span><br><span class="line">chkconfig --level 23456 hplip off </span><br><span class="line">chkconfig --level 23456 ip6tables off </span><br><span class="line">chkconfig --level 23456 iptables off </span><br><span class="line">chkconfig --level 23456 isdn off </span><br><span class="line">chkconfig --level 23456 pcscd off </span><br><span class="line">chkconfig --level 23456 sendmail off </span><br><span class="line">chkconfig --level 23456 yum-updatesd off</span><br></pre></td></tr></tbody></table></figure><p></p><p>å®‰è£…å›¾å½¢ç•Œé¢çš„æœåŠ¡å™¨ä¸è¦å¯åŠ¨å›¾å½¢ç•Œé¢ runlevel 3ã€‚</p><p>å¦å¤–ï¼Œæ€è€ƒå°†æ¥æˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯å¦çœŸçš„éœ€è¦ MySQLï¼Œè¿˜æ˜¯ä½¿ç”¨å…¶ä»–ç§ç±»çš„æ•°æ®åº“ã€‚ç”¨æ•°æ®åº“çš„æœ€é«˜å¢ƒç•Œå°±æ˜¯ä¸ç”¨æ•°æ®åº“ã€‚</p><h2 id="æ•°æ®åº“ä¼˜åŒ–"><a href="#æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="æ•°æ®åº“ä¼˜åŒ–"></a>æ•°æ®åº“ä¼˜åŒ–</h2><p>SQL ä¼˜åŒ–æ–¹å‘ï¼š</p><ul><li>æ‰§è¡Œè®¡åˆ’</li><li>ç´¢å¼•</li><li>SQL æ”¹å†™</li></ul><p>æ¶æ„ä¼˜åŒ–æ–¹å‘ï¼š</p><ul><li>é«˜å¯ç”¨æ¶æ„</li><li>é«˜æ€§èƒ½æ¶æ„</li><li>åˆ†åº“åˆ†è¡¨</li></ul><h4 id="æ•°æ®åº“å‚æ•°ä¼˜åŒ–"><a href="#æ•°æ®åº“å‚æ•°ä¼˜åŒ–" class="headerlink" title="æ•°æ®åº“å‚æ•°ä¼˜åŒ–"></a>æ•°æ®åº“å‚æ•°ä¼˜åŒ–</h4><h5 id="è°ƒæ•´"><a href="#è°ƒæ•´" class="headerlink" title="è°ƒæ•´"></a>è°ƒæ•´</h5><p>å®ä¾‹æ•´ä½“(é«˜çº§ä¼˜åŒ–ï¼Œæ‰©å±•)ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thread_concurrencyï¼š<span class="comment"># å¹¶å‘çº¿ç¨‹æ•°é‡ä¸ªæ•° </span></span><br><span class="line">sort_buffer_sizeï¼š<span class="comment"># æ’åºç¼“å­˜ </span></span><br><span class="line">read_buffer_sizeï¼š<span class="comment"># é¡ºåºè¯»å–ç¼“å­˜ </span></span><br><span class="line">read_rnd_buffer_sizeï¼š<span class="comment"># éšæœºè¯»å–ç¼“å­˜ </span></span><br><span class="line">key_buffer_sizeï¼š<span class="comment"># ç´¢å¼•ç¼“å­˜ </span></span><br><span class="line">thread_cache_sizeï¼š<span class="comment"># (1Gâ€”>8, 2Gâ€”>16, 3Gâ€”>32, >3Gâ€”>64)</span></span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="è¿æ¥å±‚-åŸºç¡€ä¼˜åŒ–"><a href="#è¿æ¥å±‚-åŸºç¡€ä¼˜åŒ–" class="headerlink" title="è¿æ¥å±‚(åŸºç¡€ä¼˜åŒ–)"></a>è¿æ¥å±‚(åŸºç¡€ä¼˜åŒ–)</h5><p>è®¾ç½®åˆç†çš„è¿æ¥å®¢æˆ·å’Œè¿æ¥æ–¹å¼ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">max_connections <span class="comment"># æœ€å¤§è¿æ¥æ•°ï¼Œçœ‹äº¤æ˜“ç¬”æ•°è®¾ç½® </span></span><br><span class="line">max_connect_errors <span class="comment"># æœ€å¤§é”™è¯¯è¿æ¥æ•°ï¼Œèƒ½å¤§åˆ™å¤§ </span></span><br><span class="line">connect_timeout <span class="comment"># è¿æ¥è¶…æ—¶ </span></span><br><span class="line">max_user_connections <span class="comment"># æœ€å¤§ç”¨æˆ·è¿æ¥æ•° </span></span><br><span class="line">skip-name-resolve <span class="comment"># è·³è¿‡åŸŸåè§£æ </span></span><br><span class="line">wait_timeout <span class="comment"># ç­‰å¾…è¶…æ—¶ </span></span><br><span class="line">back_log <span class="comment"># å¯ä»¥åœ¨å †æ ˆä¸­çš„è¿æ¥æ•°é‡ </span></span><br><span class="line">```      </span><br><span class="line"><span class="comment">##### SQL å±‚(åŸºç¡€ä¼˜åŒ–)</span></span><br><span class="line">query_cache_sizeï¼š æŸ¥è¯¢ç¼“å­˜ >>> OLAP ç±»å‹æ•°æ®åº“ï¼Œéœ€è¦é‡ç‚¹åŠ å¤§æ­¤å†…å­˜ç¼“å­˜ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ä¼šè¶…è¿‡ GBã€‚</span><br><span class="line"></span><br><span class="line">å¯¹äºç»å¸¸è¢«ä¿®æ”¹çš„æ•°æ®ï¼Œç¼“å­˜ä¼šé©¬ä¸Šå¤±æ•ˆã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…å­˜æ•°æ®åº“(redisã€memecache)ï¼Œæ›¿ä»£å®ƒçš„åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">##### å­˜å‚¨å¼•æ“å±‚ä¼˜åŒ–</span></span><br><span class="line">innodb åŸºç¡€ä¼˜åŒ–å‚æ•°ï¼š</span><br><span class="line">```bash</span><br><span class="line">default-storage-engine </span><br><span class="line">innodb_buffer_pool_size <span class="comment"># æ²¡æœ‰å›ºå®šå¤§å°ï¼Œ50%æµ‹è¯•å€¼ï¼Œçœ‹çœ‹æƒ…å†µå†å¾®è°ƒã€‚ä½†æ˜¯å°½é‡è®¾ç½®ä¸è¦è¶…è¿‡ç‰©ç†å†…å­˜70% </span></span><br><span class="line">innodb_file_per_table=(1,0) </span><br><span class="line">innodb_flush_log_at_trx_commit=(0,1,2) <span class="comment"># 1æ˜¯æœ€å®‰å…¨çš„ï¼Œ0æ˜¯æ€§èƒ½æœ€é«˜ï¼Œ2æŠ˜ä¸­ </span></span><br><span class="line">binlog_sync </span><br><span class="line">Innodb_flush_method=(O_DIRECT, fdatasync) </span><br><span class="line">innodb_log_buffer_size <span class="comment"># 100Mä»¥ä¸‹ </span></span><br><span class="line">innodb_log_file_size <span class="comment"># 100M ä»¥ä¸‹ </span></span><br><span class="line">innodb_log_files_in_group <span class="comment"># 5ä¸ªæˆå‘˜ä»¥ä¸‹,ä¸€èˆ¬2-3ä¸ªå¤Ÿç”¨ï¼ˆiblogfile0-Nï¼‰ </span></span><br><span class="line">innodb_max_dirty_pages_pct <span class="comment"># è¾¾åˆ°ç™¾åˆ†ä¹‹75çš„æ—¶å€™åˆ·å†™ å†…å­˜è„é¡µåˆ°ç£ç›˜ã€‚ </span></span><br><span class="line">log_bin </span><br><span class="line">max_binlog_cache_size <span class="comment"># å¯ä»¥ä¸è®¾ç½® </span></span><br><span class="line">max_binlog_size <span class="comment"># å¯ä»¥ä¸è®¾ç½® </span></span><br><span class="line">innodb_additional_mem_pool_size <span class="comment">#å°äº2Gå†…å­˜çš„æœºå™¨ï¼Œæ¨èå€¼æ˜¯20Mã€‚32Gå†…å­˜ä»¥ä¸Š100M</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p>51CTOä¼ åª’: <a href="https://www.toutiao.com/i6647024189007987208/?tt_from=weixin&utm_campaign=client_share&wxshare_count=2&from=singlemessage&timestamp=1555614491&app=news_article&utm_source=weixin&isappinstalled=0&utm_medium=toutiao_ios&req_id=201904190308110100230720231370496&group_id=6647024189007987208&pbid=6691541599112283651" target="_blank" rel="noopener">ä¸€ä»½è¶…è¯¦ç»†çš„MySQLé«˜æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ€»ç»“</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiiii.jpg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>pt-table-checksum fails on older MySQL without utf8mb4-support</title>
    <link href="https://jiemin.wang/2019/05/14/PT-0/"/>
    <id>https://jiemin.wang/2019/05/14/PT-0/</id>
    <published>2019-05-14T02:45:11.000Z</published>
    <updated>2019-05-14T03:30:30.797Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="bs.png" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>â€œåˆ«å†æŠ±æ€¨ä½ æ­¤ç”Ÿæ‰¾ä¸åˆ°ä¸€ä¸ªå¯¹çš„äººï¼Œå½“åˆçš„æ•°å­¦é€‰æ‹©é¢˜å°±å››ä¸ªï¼Œä½ ä¹Ÿæ‰¾ä¸åˆ°å¯¹çš„ç­”æ¡ˆå•Šâ€</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ˜¨å¤©å¸®åŒäº‹è§£å†³ä¸»ä»åŒæ­¥çš„é—®é¢˜ã€‚</p><p>åŸå› æ˜¯åŒäº‹ä½¿ç”¨<code>Django</code>å¼€å‘äº†ä¸€å¥—è¿ç»´å¹³å°ã€‚ä½†æ˜¯é‡Œé¢çš„è¡¨ä½¿ç”¨äº†<code>FOREIGN KEY</code>ï¼Œåœ¨æ’å…¥çš„æ˜¯æŠ¥é”™ã€‚é€ æˆäº†<code>ä¸»ä»åŒæ­¥é”™è¯¯</code>ï¼Œæ•°æ®é‡ä¸å¤§ï¼Œä½¿ç”¨<code>pt-table-checksum</code>æ¥æ ¡éªŒä¸»ä»æ•°æ®</p><h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><p>ä¸€ã€å…ˆè·³è¿‡ä¸»ä»é”™è¯¯ï¼Œä¸»ä»åŒæ­¥å…³ç³»æ¢å¤æ­£å¸¸ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE sql_thread;</span><br><span class="line">SET GLOBAL sql_slave_skip_counter = 1;</span><br><span class="line">START SLAVE sql_thread;</span><br><span class="line">SHOW SLAVE STATUS\G</span><br></pre></td></tr></tbody></table></figure><p></p><p>äºŒã€ä½¿ç”¨ pt-table-checksum<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-checksum --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password=<span class="string">'*****'</span> --recursion-method=<span class="string">'processlist'</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Error setting innodb_lock_wait_timeout: DBD::mysql::db <span class="keyword">do</span> failed: Variable <span class="string">'innodb_lock_wait_timeout'</span> is a <span class="built_in">read</span> only variable [<span class="keyword">for</span> Statement <span class="string">"SET SESSION innodb_lock_wait_timeout=1"</span>].  The current value <span class="keyword">for</span> innodb_lock_wait_timeout is 50.  If the variable is <span class="built_in">read</span> only (not dynamic), specify --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=50 to avoid this warning, <span class="keyword">else</span> manually <span class="built_in">set</span> the variable and restart MySQL.</span><br><span class="line"></span><br><span class="line">Checking <span class="keyword">if</span> all tables can be checksummed ...</span><br><span class="line">Starting checksum ...</span><br><span class="line">Error setting innodb_lock_wait_timeout: DBD::mysql::db <span class="keyword">do</span> failed: Variable <span class="string">'innodb_lock_wait_timeout'</span> is a <span class="built_in">read</span> only variable [<span class="keyword">for</span> Statement <span class="string">"SET SESSION innodb_lock_wait_timeout=1"</span>].  The current value <span class="keyword">for</span> innodb_lock_wait_timeout is 50.  If the variable is <span class="built_in">read</span> only (not dynamic), specify --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=50 to avoid this warning, <span class="keyword">else</span> manually <span class="built_in">set</span> the variable and restart MySQL.</span><br><span class="line"></span><br><span class="line">05-13T18:42:19 Error executing EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(<span class="string">'#'</span>, `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/: DBD::mysql::st execute failed: Unknown character <span class="built_in">set</span>: <span class="string">'utf8mb4'</span> [<span class="keyword">for</span> Statement <span class="string">"EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/"</span>] at /usr/bin/pt-table-checksum line 12302.</span><br><span class="line"></span><br><span class="line">05-13T18:42:19 Error checksumming table bportal.server_basic_info: Error executing checksum query: DBD::mysql::st execute failed: Unknown character <span class="built_in">set</span>: <span class="string">'utf8mb4'</span> [<span class="keyword">for</span> Statement <span class="string">"REPLACE INTO `test`.`checksums` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT ?, ?, ?, ?, ?, ?, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*checksum table*/"</span> with ParamValues: 0=<span class="string">'bportal'</span>, 1=<span class="string">'server_basic_info'</span>, 2=1, 3=undef, 4=undef, 5=undef] at /usr/bin/pt-table-checksum line 11691.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            TS ERRORS  DIFFS     ROWS  DIFF_ROWS  CHUNKS SKIPPED    TIME TABLE</span><br><span class="line">05-13T18:42:19      2      0        0          0       1       0   0.008 bportal.server_basic_info</span><br></pre></td></tr></tbody></table></figure><h4 id="äºæ˜¯æ’é™¤é—®é¢˜ï¼š"><a href="#äºæ˜¯æ’é™¤é—®é¢˜ï¼š" class="headerlink" title="äºæ˜¯æ’é™¤é—®é¢˜ï¼š"></a>äºæ˜¯æ’é™¤é—®é¢˜ï¼š</h4><ol><li>æŸ¥çœ‹MySQL ç‰ˆæœ¬</li><li>æŸ¥çœ‹MySQL å­—ç¬¦é›†</li><li>æŸ¥çœ‹æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†<h4 id="googleæŸ¥æ‰¾é—®é¢˜åŸå› "><a href="#googleæŸ¥æ‰¾é—®é¢˜åŸå› " class="headerlink" title="googleæŸ¥æ‰¾é—®é¢˜åŸå› "></a>googleæŸ¥æ‰¾é—®é¢˜åŸå› </h4>å‘ç°ç¯‡æ–‡ç« å’Œè¯¥é”™è¯¯å‡ ä¹ä¸€è‡´ã€‚è¯´åˆ°pt-table-checksumå·²ç»ä¸æ”¯æŒMySQL 5.1ç‰ˆæœ¬ã€‚<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thank you <span class="keyword">for</span> the report.</span><br><span class="line"></span><br><span class="line">The error is expected since  character <span class="built_in">set</span> utf8mb4 Unknown to the MySQL 5.1</span><br><span class="line"></span><br><span class="line">MySQL 5.1 is not a supported version: https://www.percona.com/services/support/mysql-support/percona-toolkit-supported-platforms-and-versions</span><br></pre></td></tr></tbody></table></figure></li></ol><p>å†™äº†ä¸€ä¸ª<a href="./pt-table-checksum.utf8mb4.patch">patch</a></p><h4 id="pt-table-checksumæ‰“è¡¥ä¸"><a href="#pt-table-checksumæ‰“è¡¥ä¸" class="headerlink" title="pt-table-checksumæ‰“è¡¥ä¸"></a>pt-table-checksumæ‰“è¡¥ä¸</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patch pt-table-checksum < pt-table-checksum.utf8mb4.patch</span><br></pre></td></tr></tbody></table></figure><h4 id="æ‰§è¡Œå‘½ä»¤"><a href="#æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤"></a>æ‰§è¡Œå‘½ä»¤</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-checksum --<span class="built_in">set</span>-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password=<span class="string">'*****'</span> --recursion-method=<span class="string">'processlist'</span></span><br></pre></td></tr></tbody></table></figure><p>å‘ç°æ²¡æœ‰ä¸Šé¢çš„é—®é¢˜ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸ã€‚åœ¨æ‰§è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-table-sync --replicate=test.checksums --databases=***** --charset=utf8 h=****,P=****,u=****,p=<span class="string">'****'</span> --execute</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½¿ç”¨MySQL 5.1ç‰ˆæœ¬çš„æ•°æ®åº“èµ¶å¿«å‡çº§å§ã€‚å¤ªæŠ˜è…¾äººäº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>Percona: <a href="https://jira.percona.com/browse/PT-1552" target="_blank" rel="noopener">jira</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;bs.png&quot; class=&quot;full-image&quot; alt=&quot;alt
      
    
    </summary>
    
      <category term="Toolkit" scheme="https://jiemin.wang/categories/Toolkit/"/>
    
    
      <category term="Toolkit" scheme="https://jiemin.wang/tags/Toolkit/"/>
    
  </entry>
  
  <entry>
    <title>å›¾è§£Goçš„channelåº•å±‚åŸç†</title>
    <link href="https://jiemin.wang/2019/05/05/go-channal-graphic/"/>
    <id>https://jiemin.wang/2019/05/05/go-channal-graphic/</id>
    <published>2019-05-05T05:33:49.000Z</published>
    <updated>2019-05-05T06:13:58.039Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="iiii.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>åŠªåŠ›ä¸ä¸€å®šæˆåŠŸï¼Œä½†æ˜¯ä¸åŠªåŠ›ä¼šå¾ˆèˆ’æœçš„å“¦!</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>channelçš„æ•´ä½“ç»“æ„å›¾<br><img src="/2019/05/05/go-channal-graphic/hchan.png" title="hchan"></p><p>ç®€å•è¯´æ˜ï¼š</p><ul><li><code>buf</code>æ˜¯æœ‰ç¼“å†²çš„channelæ‰€ç‰¹æœ‰çš„ç»“æ„ï¼Œç”¨æ¥å­˜å‚¨ç¼“å­˜æ•°æ®ã€‚æ˜¯ä¸ªå¾ªç¯é“¾è¡¨</li><li><code>sendx</code>å’Œ<code>recvx</code>ç”¨äºè®°å½•<code>buf</code>è¿™ä¸ªå¾ªç¯é“¾è¡¨ä¸­çš„~å‘é€æˆ–è€…æ¥æ”¶çš„~index</li><li><code>lock</code>æ˜¯ä¸ªäº’æ–¥é”ã€‚</li><li><code>recvq</code>å’Œ<code>sendq</code>åˆ†åˆ«æ˜¯æ¥æ”¶(<-channel)æˆ–è€…å‘é€(channel <- xxx)çš„goroutineæŠ½è±¡å‡ºæ¥çš„ç»“æ„ä½“(sudog)çš„é˜Ÿåˆ—ã€‚æ˜¯ä¸ªåŒå‘é“¾è¡¨</li></ul><p>æºç ä½äº<code>/runtime/chan.go</code>ä¸­(ç›®å‰ç‰ˆæœ¬ï¼š1.11)ã€‚ç»“æ„ä½“ä¸º<code>hchan</code>ã€‚<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> {</span><br><span class="line">    qcount   <span class="keyword">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">    dataqsiz <span class="keyword">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">    buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">    elemsize <span class="keyword">uint16</span></span><br><span class="line">    closed   <span class="keyword">uint32</span></span><br><span class="line">    elemtype *_type <span class="comment">// element type</span></span><br><span class="line">    sendx    <span class="keyword">uint</span>   <span class="comment">// send index</span></span><br><span class="line">    recvx    <span class="keyword">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">    recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">    sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lock protects all fields in hchan, as well as several</span></span><br><span class="line">    <span class="comment">// fields in sudogs blocked on this channel.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Do not change another G's status while holding this lock</span></span><br><span class="line">    <span class="comment">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class="line">    <span class="comment">// with stack shrinking.</span></span><br><span class="line">    lock mutex</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»<code>hchan</code>ä¸­å„éƒ¨åˆ†æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p><h2 id="è¯¦ç»†ä»‹ç»"><a href="#è¯¦ç»†ä»‹ç»" class="headerlink" title="è¯¦ç»†ä»‹ç»"></a>è¯¦ç»†ä»‹ç»</h2><p>å…ˆä»åˆ›å»ºå¼€å§‹</p><p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªchannelã€‚<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/05/05/go-channal-graphic/hchan1.png" title="hchan1"><p>åˆ›å»ºchannelå®é™…ä¸Šå°±æ˜¯åœ¨å†…å­˜ä¸­å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>hchan</code>çš„ç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ªchæŒ‡é’ˆï¼Œæˆ‘ä»¬ä½¿ç”¨è¿‡ç¨‹ä¸­channelåœ¨å‡½æ•°ä¹‹é—´çš„ä¼ é€’éƒ½æ˜¯ç”¨çš„è¿™ä¸ªæŒ‡é’ˆï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‡½æ•°ä¼ é€’ä¸­æ— éœ€ä½¿ç”¨channelçš„æŒ‡é’ˆï¼Œè€Œç›´æ¥ç”¨channelå°±è¡Œäº†ï¼Œå› ä¸ºchannelæœ¬èº«å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p><h4 id="channelä¸­å‘é€send-ch-lt-xxx-å’Œrecv-lt-ch-æ¥æ”¶"><a href="#channelä¸­å‘é€send-ch-lt-xxx-å’Œrecv-lt-ch-æ¥æ”¶" class="headerlink" title="channelä¸­å‘é€send(ch <- xxx)å’Œrecv(<- ch)æ¥æ”¶"></a>channelä¸­å‘é€send(ch <- xxx)å’Œrecv(<- ch)æ¥æ”¶</h4><p>å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä½ æƒ³è®©goroutineä»¥å…ˆè¿›å…ˆå‡º(FIFO)çš„æ–¹å¼è¿›å…¥ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œä½ ä¼šæ€ä¹ˆæ“ä½œï¼Ÿ<br>åŠ é”ï¼å¯¹çš„ï¼channelå°±æ˜¯ç”¨äº†ä¸€ä¸ªé”ã€‚hchanæœ¬èº«åŒ…å«ä¸€ä¸ªäº’æ–¥é”<code>mutex</code></p><h4 id="channelä¸­é˜Ÿåˆ—æ˜¯å¦‚ä½•å®ç°çš„"><a href="#channelä¸­é˜Ÿåˆ—æ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="channelä¸­é˜Ÿåˆ—æ˜¯å¦‚ä½•å®ç°çš„"></a>channelä¸­é˜Ÿåˆ—æ˜¯å¦‚ä½•å®ç°çš„</h4><p>channelä¸­æœ‰ä¸ªç¼“å­˜bufï¼Œæ˜¯ç”¨æ¥ç¼“å­˜æ•°æ®çš„(å‡å¦‚å®ä¾‹åŒ–äº†å¸¦ç¼“å­˜çš„channelçš„è¯)é˜Ÿåˆ—ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°â€œé˜Ÿåˆ—â€çš„ã€‚<br>è¿˜æ˜¯åˆšæ‰åˆ›å»ºçš„é‚£ä¸ªchannel<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/05/05/go-channal-graphic/hchan_gif1.png" title="hchan_gif1"><p>å½“ä½¿ç”¨<code>send (ch <- xx)</code>æˆ–è€…<code>recv ( <-ch)</code>çš„æ—¶å€™ï¼Œé¦–å…ˆè¦é”ä½<code>hchan</code>è¿™ä¸ªç»“æ„ä½“ã€‚</p><img src="/2019/05/05/go-channal-graphic/hchan_gif2.png" title="hchan_gif2"><p>ç„¶åå¼€å§‹<code>send (ch <- xx)</code>æ•°æ®ã€‚</p><p>ä¸€<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>äºŒ<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸‰<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™æ—¶å€™æ»¡äº†ï¼Œé˜Ÿåˆ—å¡ä¸è¿›å»äº†</p><p>åŠ¨æ€å›¾è¡¨ç¤ºä¸ºï¼š<br><img src="/2019/05/05/go-channal-graphic/send.gif" title="send"><br>ç„¶åæ˜¯å–<code>recv ( <-ch)</code>çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸ªé€†å‘çš„æ“ä½œï¼Œä¹Ÿæ˜¯éœ€è¦åŠ é”ã€‚<br><img src="/2019/05/05/go-channal-graphic/hchan_gif6.png" title="hchan_gif6"></p><p>ç„¶åå¼€å§‹<code>recv (<-ch)</code>æ•°æ®ã€‚<br>ä¸€<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>äºŒ<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸‰<br></p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><-ch</span><br></pre></td></tr></tbody></table></figure><p></p><p>å›¾ä¸ºï¼š<br><img src="/2019/05/05/go-channal-graphic/recv.gif" title="recv"><br>æ³¨æ„ä»¥ä¸Šä¸¤å¹…å›¾ä¸­<code>buf</code>å’Œ<code>recvx</code>ä»¥åŠ<code>sendx</code>çš„å˜åŒ–ï¼Œ<code>recvx</code>å’Œ<code>sendx</code>æ˜¯æ ¹æ®å¾ªç¯é“¾è¡¨<code>buf</code>çš„å˜åŠ¨è€Œæ”¹å˜çš„ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆ<code>channel</code>ä¼šä½¿ç”¨<code>å¾ªç¯é“¾è¡¨</code>ä½œä¸ºç¼“å­˜ç»“æ„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯åœ¨ç¼“å­˜åˆ—è¡¨åœ¨åŠ¨æ€çš„<code>send</code>å’Œ<code>recv</code>è¿‡ç¨‹ä¸­ï¼Œå®šä½å½“å‰<code>send</code>æˆ–è€…<code>recvx</code>çš„ä½ç½®ã€é€‰æ‹©<code>send</code>çš„å’Œ<code>recvx</code>çš„ä½ç½®æ¯”è¾ƒæ–¹ä¾¿å§ï¼Œåªè¦é¡ºç€é“¾è¡¨é¡ºåºä¸€ç›´æ—‹è½¬æ“ä½œå°±å¥½ã€‚</p><p>ç¼“å­˜ä¸­æŒ‰é“¾è¡¨é¡ºåºå­˜æ”¾ï¼Œå–æ•°æ®çš„æ—¶å€™æŒ‰é“¾è¡¨é¡ºåºè¯»å–ï¼Œç¬¦åˆFIFOçš„åŸåˆ™ã€‚</p><h4 id="send-recvçš„ç»†åŒ–æ“ä½œ"><a href="#send-recvçš„ç»†åŒ–æ“ä½œ" class="headerlink" title="send/recvçš„ç»†åŒ–æ“ä½œ"></a>send/recvçš„ç»†åŒ–æ“ä½œ</h4><p>æ³¨æ„ï¼šç¼“å­˜é“¾è¡¨ä¸­ä»¥ä¸Šæ¯ä¸€æ­¥çš„æ“ä½œï¼Œéƒ½æ˜¯éœ€è¦åŠ é”æ“ä½œçš„ï¼</p><p>æ¯ä¸€æ­¥çš„æ“ä½œçš„ç»†èŠ‚å¯ä»¥ç»†åŒ–ä¸ºï¼š</p><ul><li>ç¬¬ä¸€ï¼ŒåŠ é”</li><li>ç¬¬äºŒï¼ŒæŠŠæ•°æ®ä»goroutineä¸­copyåˆ°â€œé˜Ÿåˆ—â€ä¸­(æˆ–è€…ä»é˜Ÿåˆ—ä¸­copyåˆ°goroutineä¸­ï¼‰ã€‚</li><li>ç¬¬ä¸‰ï¼Œé‡Šæ”¾é”</li></ul><p>æ¯ä¸€æ­¥çš„æ“ä½œæ€»ç»“ä¸ºåŠ¨æ€å›¾ä¸ºï¼š(å‘é€è¿‡ç¨‹)<br><img src="/2019/05/05/go-channal-graphic/send_single.gif" title="send_single"></p><p>æˆ–è€…ä¸ºï¼š(æ¥æ”¶è¿‡ç¨‹)<br><img src="/2019/05/05/go-channal-graphic/recv_single.gif" title="recv_single"></p><p>æ‰€ä»¥ä¸éš¾çœ‹å‡ºï¼ŒGoä¸­é‚£å¥ç»å…¸çš„è¯ï¼š<code>Do not communicate by sharing memory; instead, share memory by communicating.</code>çš„å…·ä½“å®ç°å°±æ˜¯åˆ©ç”¨channelæŠŠæ•°æ®ä»ä¸€ç«¯copyåˆ°äº†å¦ä¸€ç«¯ï¼</p><p>è¿˜çœŸæ˜¯ç¬¦åˆ<code>channel</code>çš„è‹±æ–‡å«ä¹‰ï¼š<br><img src="/2019/05/05/go-channal-graphic/hchan_channl.gif" title="hchan_channl"></p><h4 id="å½“channelç¼“å­˜æ»¡äº†ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™å…¶ä¸­çš„åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#å½“channelç¼“å­˜æ»¡äº†ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™å…¶ä¸­çš„åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="å½“channelç¼“å­˜æ»¡äº†ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™å…¶ä¸­çš„åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ"></a>å½“channelç¼“å­˜æ»¡äº†ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™å…¶ä¸­çš„åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ</h4><p>ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå½“channelç¼“å­˜æ»¡äº†ï¼Œæˆ–è€…æ²¡æœ‰ç¼“å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»§ç»­send(ch <- xxx)æˆ–è€…recv(<- ch)ä¼šé˜»å¡å½“å‰goroutineï¼Œä½†æ˜¯ï¼Œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒGoçš„goroutineæ˜¯ç”¨æˆ·æ€çš„çº¿ç¨‹(<code>user-space threads</code>)ï¼Œç”¨æˆ·æ€çš„çº¿ç¨‹æ˜¯éœ€è¦è‡ªå·±å»è°ƒåº¦çš„ï¼ŒGoæœ‰è¿è¡Œæ—¶çš„schedulerå»å¸®æˆ‘ä»¬å®Œæˆè°ƒåº¦è¿™ä»¶äº‹æƒ…ã€‚å…³äºGoçš„è°ƒåº¦æ¨¡å‹GMPæ¨¡å‹æˆ‘åœ¨æ­¤ä¸åšèµ˜è¿°ï¼Œå¦‚æœä¸äº†è§£ï¼Œå¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç« (<a href="https://i6448038.github.io/2017/12/04/golang-concurrency-principle/" target="_blank" rel="noopener">Goå¹¶å‘åŸç†</a>)</p><p>goroutineçš„é˜»å¡æ“ä½œï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨<code>send (ch <- xx)</code>æˆ–è€…<code>recv ( <-ch)</code>çš„æ—¶å€™ä¸»åŠ¨è§¦å‘çš„ï¼Œå…·ä½“è¯·çœ‹ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//goroutine1 ä¸­ï¼Œè®°åšG1</span></span><br><span class="line"></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">ch <- <span class="number">1</span></span><br><span class="line">ch <- <span class="number">1</span></span><br><span class="line">ch <- <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><img src="/2019/05/05/go-channal-graphic/hchan_block.png" title="hchan_block"><img src="/2019/05/05/go-channal-graphic/hchan_block1.png" title="hchan_block1"><p>è¿™ä¸ªæ—¶å€™G1æ­£åœ¨æ­£å¸¸è¿è¡Œ,å½“å†æ¬¡è¿›è¡Œsendæ“ä½œ(ch<-1)çš„æ—¶å€™ï¼Œä¼šä¸»åŠ¨è°ƒç”¨Goçš„è°ƒåº¦å™¨,è®©G1ç­‰å¾…ï¼Œå¹¶ä»è®©å‡ºMï¼Œè®©å…¶ä»–Gå»ä½¿ç”¨<br><img src="/2019/05/05/go-channal-graphic/hchan_block2.png" title="hchan_block2"></p><p>åŒæ—¶G1ä¹Ÿä¼šè¢«æŠ½è±¡æˆå«æœ‰G1æŒ‡é’ˆå’Œsendå…ƒç´ çš„<code>sudog</code>ç»“æ„ä½“ä¿å­˜åˆ°hchançš„<code>sendq</code>ä¸­ç­‰å¾…è¢«å”¤é†’ã€‚<br><img src="/2019/05/05/go-channal-graphic/hchan_blok3.gif" title="hchan_blok3"></p><p>é‚£ä¹ˆï¼ŒG1ä»€ä¹ˆæ—¶å€™è¢«å”¤é†’å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™G2éš†é‡ç™»åœºã€‚<br><img src="/2019/05/05/go-channal-graphic/hchan_block4.png" title="hchan_block4"></p><p>G2æ‰§è¡Œäº†recvæ“ä½œ<code>p := <-ch</code>ï¼Œäºæ˜¯ä¼šå‘ç”Ÿä»¥ä¸‹çš„æ“ä½œï¼š<br><img src="/2019/05/05/go-channal-graphic/hchan_block5.gif" title="hchan_block5"></p><p>G2ä»ç¼“å­˜é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼Œchannelä¼šå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„G1æ¨å‡ºï¼Œå°†G1å½“æ—¶sendçš„æ•°æ®æ¨åˆ°ç¼“å­˜ä¸­ï¼Œç„¶åè°ƒç”¨Goçš„schedulerï¼Œå”¤é†’G1ï¼Œå¹¶æŠŠG1æ”¾åˆ°å¯è¿è¡Œçš„Goroutineé˜Ÿåˆ—ä¸­ã€‚<br><img src="/2019/05/05/go-channal-graphic/hchan_block6.gif" title="hchan_block6"></p><h4 id="å‡å¦‚æ˜¯å…ˆè¿›è¡Œæ‰§è¡Œrecvæ“ä½œçš„G2ä¼šæ€ä¹ˆæ ·ï¼Ÿ"><a href="#å‡å¦‚æ˜¯å…ˆè¿›è¡Œæ‰§è¡Œrecvæ“ä½œçš„G2ä¼šæ€ä¹ˆæ ·ï¼Ÿ" class="headerlink" title="å‡å¦‚æ˜¯å…ˆè¿›è¡Œæ‰§è¡Œrecvæ“ä½œçš„G2ä¼šæ€ä¹ˆæ ·ï¼Ÿ"></a>å‡å¦‚æ˜¯å…ˆè¿›è¡Œæ‰§è¡Œrecvæ“ä½œçš„G2ä¼šæ€ä¹ˆæ ·ï¼Ÿ</h4><p>ä½ å¯èƒ½ä¼šé¡ºç€ä»¥ä¸Šçš„æ€è·¯åæ¨ã€‚é¦–å…ˆï¼š<br><img src="/2019/05/05/go-channal-graphic/hchan_block7_1.png" title="hchan_block7_1"></p><p>è¿™ä¸ªæ—¶å€™G2ä¼šä¸»åŠ¨è°ƒç”¨Goçš„è°ƒåº¦å™¨,è®©G2ç­‰å¾…ï¼Œå¹¶ä»è®©å‡ºMï¼Œè®©å…¶ä»–Gå»ä½¿ç”¨ã€‚</p><p>G2è¿˜ä¼šè¢«æŠ½è±¡æˆå«æœ‰G2æŒ‡é’ˆå’Œrecvç©ºå…ƒç´ çš„<code>sudog</code>ç»“æ„ä½“ä¿å­˜åˆ°hchançš„<code>recvq</code>ä¸­ç­‰å¾…è¢«å”¤é†’<br><img src="/2019/05/05/go-channal-graphic/hchan_block7.gif" title="hchan_block7"></p><p>æ­¤æ—¶æ°å¥½æœ‰ä¸ªgoroutine G1å¼€å§‹å‘channelä¸­æ¨é€æ•°æ® <code>ch <- 1</code>ã€‚</p><p>æ­¤æ—¶ï¼Œéå¸¸æœ‰æ„æ€çš„äº‹æƒ…å‘ç”Ÿäº†ï¼š<br><img src="/2019/05/05/go-channal-graphic/hchan_block8.gif" title="hchan_block8"></p><p>G1å¹¶æ²¡æœ‰é”ä½channelï¼Œç„¶åå°†æ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ•°æ®ä»G1ç›´æ¥copyåˆ°äº†G2çš„æ ˆä¸­ã€‚</p><p>è¿™ç§æ–¹å¼éå¸¸çš„èµï¼åœ¨å”¤é†’è¿‡ç¨‹ä¸­ï¼ŒG2æ— éœ€å†è·å¾—channelçš„é”ï¼Œç„¶åä»ç¼“å­˜ä¸­å–æ•°æ®ã€‚å‡å°‘äº†å†…å­˜çš„copyï¼Œæé«˜äº†æ•ˆç‡ã€‚</p><p>ä¹‹åçš„äº‹æƒ…æ˜¾è€Œæ˜“è§ï¼š<br><img src="/2019/05/05/go-channal-graphic/hchan_block9.gif" title="hchan_block9"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.youtube.com/watch?v=KBZlN0izeiY" target="_blank" rel="noopener">youtube</a></li><li><a href="https://zhuanlan.zhihu.com/p/27917262" target="_blank" rel="noopener">æ·±å…¥ç†è§£Golang Channel</a></li></ul><h2 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h2><ul><li><a href="https://i6448038.github.io/2019/04/11/go-channel/" target="_blank" rel="noopener">å›¾è§£Goçš„channelåº•å±‚å®ç°(RyuGou)</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;iiii.jpg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="Golang" scheme="https://jiemin.wang/categories/Golang/"/>
    
    
      <category term="Golang" scheme="https://jiemin.wang/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>æœ€å…¨Oracle DBAæ—¥å¸¸ç»´æŠ¤SQLè„šæœ¬å‘½ä»¤</title>
    <link href="https://jiemin.wang/2019/04/26/oracle-ops-sql/"/>
    <id>https://jiemin.wang/2019/04/26/oracle-ops-sql/</id>
    <published>2019-04-26T01:23:59.000Z</published>
    <updated>2019-04-26T02:54:17.653Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaa.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>â€œåŸè°…ä»–ä»¬æ˜¯ä¸Šå¸çš„äº‹ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯è´Ÿè´£é€ä»–ä»¬è§ä¸Šå¸ã€‚â€</strong></p></blockquote><h2 id="SQL-è¯­å¥"><a href="#SQL-è¯­å¥" class="headerlink" title="SQL è¯­å¥"></a>SQL è¯­å¥</h2><h4 id="æŸ¥è¯¢ç¢ç‰‡ç¨‹åº¦é«˜ï¼ˆå®é™…ä½¿ç”¨ç‡å°äº30-ï¼‰çš„è¡¨"><a href="#æŸ¥è¯¢ç¢ç‰‡ç¨‹åº¦é«˜ï¼ˆå®é™…ä½¿ç”¨ç‡å°äº30-ï¼‰çš„è¡¨" class="headerlink" title="æŸ¥è¯¢ç¢ç‰‡ç¨‹åº¦é«˜ï¼ˆå®é™…ä½¿ç”¨ç‡å°äº30%ï¼‰çš„è¡¨"></a>æŸ¥è¯¢ç¢ç‰‡ç¨‹åº¦é«˜ï¼ˆå®é™…ä½¿ç”¨ç‡å°äº30%ï¼‰çš„è¡¨</h4><p>å¯ä»¥æ”¶ç¼©çš„è¡¨æ¡ä»¶ä¸ºä»€ä¹ˆ<code>block>100</code>ï¼Œå› ä¸ºä¸€äº›å¾ˆå°çš„è¡¨ï¼Œåªæœ‰å‡ è¡Œæ•°æ®å®é™…å¤§å°å¾ˆå°ï¼Œä½†æ˜¯blockä¸€æ¬¡æ€§åˆ†é…å°±æ˜¯5ä¸ªï¼ˆ11gå¼€å§‹é»˜è®¤ä¸€æ¬¡æ€§åˆ†é…1Mçš„blockå¤§å°äº†ï¼Œè§create table storgedçš„NEXTå‚æ•°ï¼‰ï¼Œ5ä¸ªblockç›¸å¯¹äºå‡ è¡Œå°è¡¨æ•°æ®æ¥è¯´å°±ç›¸å·®å¤ªå¤§äº†ã€‚</p><p>ç®—æ³•ä¸­<code>/0.9</code>æ˜¯å› ä¸ºå—çš„<code>pfree</code>ä¸€èˆ¬ä¸º<code>10%</code>ï¼Œæ‰€ä»¥ä¸€ä¸ªå—æœ€å¤šåªç”¨äº†<code>90%</code>ï¼Œè€Œä¸”ä¸€è¡Œæ•°æ®å¤§äº<code>8KB</code>æ—¶å®¹æ˜“äº§ç”Ÿè¡Œé“¾æ¥ï¼ŒæŠŠä¸€è¡Œåˆ†ç‰‡å­˜å‚¨ï¼Œä¸€æ ·çš„ä¸€ä¸ªå—è¿<code>90%</code>éƒ½ç”¨ä¸æ»¡ ï¼Œ<code>AVG_ROW_LEN</code>è¿˜æ˜¯æ¯”è¾ƒå‡†çš„ï¼Œæ¯”å¦‚ä¸ªäººå®éªŒæƒ…å†µä¸€è¡¨6ä¸ªå­—æ®µï¼Œä¸€ä¸ª<code>numbe</code>rï¼Œå…¶ä»–5ä¸ªéƒ½æ˜¯<code>char(100)</code>ä½†æ˜¯å®é™…æ•°æ®éƒ½æ˜¯â€™1111111â€™7ä½ï¼ŒAVG_ROW_LENæ˜¾ç¤ºä¾ç„¶ä¸º513 ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT TABLE_NAME,</span><br><span class="line">        (BLOCKS * 8192/1024/1024) <span class="string">"ç†è®ºå¤§å°M"</span>,</span><br><span class="line">         (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9) <span class="string">"å®é™…å¤§å°M"</span>,</span><br><span class="line">         ROUND((NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024),</span><br><span class="line">         3) * 100|| <span class="string">'%'</span> <span class="string">"å®é™…ä½¿ç”¨ç‡%"</span></span><br><span class="line">FROM USER_TABLES</span><br><span class="line">WHERE blocks > 100</span><br><span class="line">        AND (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) < 0.3</span><br><span class="line">ORDER BY  (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) DESC</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥è¯¢ç´¢å¼•ç¢ç‰‡çš„æ¯”ä¾‹"><a href="#æŸ¥è¯¢ç´¢å¼•ç¢ç‰‡çš„æ¯”ä¾‹" class="headerlink" title="æŸ¥è¯¢ç´¢å¼•ç¢ç‰‡çš„æ¯”ä¾‹"></a>æŸ¥è¯¢ç´¢å¼•ç¢ç‰‡çš„æ¯”ä¾‹</h4><p>ç´¢å¼•åˆ é™¤è¡Œæ•°é™¤ä»¥ç´¢å¼•æ€»è¡Œæ•°çš„ç™¾åˆ†æ¯”>30%å³è®¤ä¸ºç´¢å¼•ç¢ç‰‡å¤§ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é‡å»ºçš„ç´¢å¼•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT name,</span><br><span class="line">         del_lf_rows,</span><br><span class="line">         lf_rows,</span><br><span class="line">         ROUND(del_lf_rows/decode(lf_rows,</span><br><span class="line">         0,</span><br><span class="line">         1,</span><br><span class="line">         lf_rows) * 100,</span><br><span class="line">        0)||<span class="string">'%'</span> frag_pct</span><br><span class="line">FROM index_stats</span><br><span class="line">WHERE ROUND(del_lf_rows/decode(lf_rows, 0, 1, lf_rows) * 100,0) > 30;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="é›†ç¾¤å› å­clustering-factoré«˜çš„è¡¨"><a href="#é›†ç¾¤å› å­clustering-factoré«˜çš„è¡¨" class="headerlink" title="é›†ç¾¤å› å­clustering_factoré«˜çš„è¡¨"></a>é›†ç¾¤å› å­clustering_factoré«˜çš„è¡¨</h4><p>é›†ç¾¤å› å­è¶Šæ¥è¿‘å—æ•°è¶Šå¥½ï¼Œæ¥è¿‘è¡Œæ•°åˆ™è¯´æ˜ç´¢å¼•åˆ—çš„åˆ—å€¼ç›¸ç­‰çš„è¡Œåˆ†å¸ƒæåº¦æ•£åˆ—ï¼Œå¯èƒ½ä¸èµ°ç´¢å¼•æ‰«æè€Œèµ°å…¨è¡¨æ‰«æ ï¼š</p><h5 id="æ–¹æ³•ä¸€ï¼š"><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT tab.table_name,</span><br><span class="line">         tab.blocks,</span><br><span class="line">         tab.num_rows,</span><br><span class="line">         ind.index_name,</span><br><span class="line">         ind.clustering_factor,</span><br><span class="line">         ROUND(nvl(ind.clustering_factor,</span><br><span class="line">         1)/decode(tab.num_rows,</span><br><span class="line">         0,</span><br><span class="line">         1,</span><br><span class="line">         tab.num_rows),</span><br><span class="line">         3) * 100||<span class="string">'%'</span> <span class="string">"é›†ç¾¤å› å­æ¥è¿‘è¡Œæ•°"</span></span><br><span class="line">FROM user_tables tab, user_indexes ind</span><br><span class="line">WHERE tab.table_name = ind.table_name</span><br><span class="line">        AND tab.blocks>100</span><br><span class="line">        AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows)</span><br><span class="line">    BETWEEN 0.35</span><br><span class="line">        AND 3</span><br></pre></td></tr></tbody></table></figure><h5 id="æ–¹æ³•äºŒï¼š"><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SELECT tab.owner,</span><br><span class="line">         tab.table_name,</span><br><span class="line">         tab.blocks,</span><br><span class="line">         tab.num_rows,</span><br><span class="line">         ind.index_name,</span><br><span class="line">         ind.clustering_factor,</span><br><span class="line">         round(nvl(ind.clustering_factor,</span><br><span class="line">        1)/decode(tab.num_rows,</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        tab.num_rows),</span><br><span class="line">        3)*100||<span class="string">'%'</span> <span class="string">"é›†ç¾¤å› å­æ¥è¿‘è¡Œæ•°"</span></span><br><span class="line">FROM dba_tables tab, dba_indexes ind</span><br><span class="line">WHERE tab.table_name=ind.table_name</span><br><span class="line">        AND tab.owner NOT IN (<span class="string">'SYS'</span>, <span class="string">'SYSTEM'</span>, <span class="string">'WMSYS'</span>, <span class="string">'DBSNMP'</span>, <span class="string">'CTXSYS'</span>, <span class="string">'XDB'</span>, <span class="string">'ORDDATA'</span>, <span class="string">'SYSMAN'</span>, <span class="string">'CATALOG'</span>, <span class="string">'APEX_030200'</span>, <span class="string">'MDSYS'</span>, <span class="string">'OLAPSYS'</span>, <span class="string">'EXFSYS'</span>)</span><br><span class="line">        AND tab.blocks > 100</span><br><span class="line">        AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows)</span><br><span class="line">    BETWEEN 0.35</span><br><span class="line">        AND 3</span><br></pre></td></tr></tbody></table></figure><h4 id="æ ¹æ®sidæŸ¥spidæˆ–æ ¹æ®spidæŸ¥sid"><a href="#æ ¹æ®sidæŸ¥spidæˆ–æ ¹æ®spidæŸ¥sid" class="headerlink" title="æ ¹æ®sidæŸ¥spidæˆ–æ ¹æ®spidæŸ¥sid"></a>æ ¹æ®sidæŸ¥spidæˆ–æ ¹æ®spidæŸ¥sid</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         p.spid,</span><br><span class="line">         s.terminal,</span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.status,</span><br><span class="line">         s.PROGRAM,</span><br><span class="line">         s.CLIENT_IDENTIFIER,</span><br><span class="line">         s.machine,</span><br><span class="line">         s.action,</span><br><span class="line">         s.MODULE,</span><br><span class="line">         s.PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         s.osuser</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.sid=XX</span><br><span class="line">        OR p.spid=YY</span><br></pre></td></tr></tbody></table></figure><h4 id="æ ¹æ®sidæŸ¥çœ‹å…·ä½“çš„sqlè¯­å¥ï¼Œä¸è¦åŠ æ¡ä»¶v-session-status-39-ACTIVE-39-ï¼Œæ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select-from-v-sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v-session-statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql-idå¯¹åº”çš„è¯­å¥å°±æ˜¯select-from-v-sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚"><a href="#æ ¹æ®sidæŸ¥çœ‹å…·ä½“çš„sqlè¯­å¥ï¼Œä¸è¦åŠ æ¡ä»¶v-session-status-39-ACTIVE-39-ï¼Œæ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select-from-v-sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v-session-statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql-idå¯¹åº”çš„è¯­å¥å°±æ˜¯select-from-v-sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚" class="headerlink" title="æ ¹æ®sidæŸ¥çœ‹å…·ä½“çš„sqlè¯­å¥ï¼Œä¸è¦åŠ æ¡ä»¶v$session.status='ACTIVE'ï¼Œæ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select * from v$sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v$session.statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯select * from v$sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚"></a>æ ¹æ®<code>sid</code>æŸ¥çœ‹å…·ä½“çš„<code>sqlè¯­å¥</code>ï¼Œä¸è¦åŠ æ¡ä»¶<code>v$session.status='ACTIVE'</code>ï¼Œæ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢<code>select * from v$session</code>æ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨<code>v$session.status</code>æ˜¯<code>INACTIVE</code>ï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯<code>select * from v$session</code>è€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚</h4><p>ä¸€ä¸ªsidå¯èƒ½æ‰§è¡Œè¿‡å¾ˆå¤šä¸ªsqlï¼Œæ‰€ä»¥æœ‰æ—¶éœ€è¦çš„sqlé€šè¿‡å¦‚ä¸‹æŸ¥ä¸åˆ°æ˜¯æ­£å¸¸çš„ï¼Œæ¯”å¦‚æŸ¥è¯¢åˆ°æŸæ­»é”æºsidï¼Œé€šè¿‡å¦‚ä¸‹æŸ¥è¯¢å¯èƒ½åªæ˜¯ä¸ª<code>selectè¯­å¥</code>ï¼Œè€ŒçœŸæ­£å¼•èµ·æ­»é”çš„sqlå´æŸ¥ä¸åˆ°ï¼Œæ˜¯å› ä¸ºå¯èƒ½è¿™ä¸ªsidæŒç»­äº†å¾ˆé•¿æ—¶é—´ï¼Œè¿™ä¸ªsidä¹‹å‰æ‰§è¡Œçš„ä¸€äº›sqlåœ¨<code>v$sql</code>å¯èƒ½å·²ç»è¢«æ¸…é™¤äº†ã€‚</p><h5 id="æ–¹æ³•ä¸€ï¼š-1"><a href="#æ–¹æ³•ä¸€ï¼š-1" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SELECT username,</span><br><span class="line">         sid,</span><br><span class="line">        SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">        action,</span><br><span class="line">         PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         osuser,</span><br><span class="line">         sql_text</span><br><span class="line">FROM v<span class="variable">$session</span> a, v<span class="variable">$sqltext_with_newlines</span> b</span><br><span class="line">WHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value</span><br><span class="line">        AND a.sid=&sid</span><br><span class="line">ORDER BY  piece; </span><br><span class="line">``` </span><br><span class="line"><span class="comment">##### æ–¹æ³•äºŒ:</span></span><br><span class="line">```bash</span><br><span class="line">SELECT username,</span><br><span class="line">         sid,</span><br><span class="line">        SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         sql_fulltext,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">         a.action,</span><br><span class="line">         PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         osuser</span><br><span class="line">FROM v<span class="variable">$session</span> a, v<span class="variable">$sql</span> b</span><br><span class="line">WHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value</span><br><span class="line">        AND a.sid=&sid</span><br></pre></td></tr></tbody></table></figure><h5 id="å¦‚æœä¸Šé¢è¯­å¥æ‰§è¡Œå¤ªæ…¢ï¼Œåˆ™æŒ‰å¦‚ä¸‹ä¸¤æ­¥"><a href="#å¦‚æœä¸Šé¢è¯­å¥æ‰§è¡Œå¤ªæ…¢ï¼Œåˆ™æŒ‰å¦‚ä¸‹ä¸¤æ­¥" class="headerlink" title="å¦‚æœä¸Šé¢è¯­å¥æ‰§è¡Œå¤ªæ…¢ï¼Œåˆ™æŒ‰å¦‚ä¸‹ä¸¤æ­¥"></a>å¦‚æœä¸Šé¢è¯­å¥æ‰§è¡Œå¤ªæ…¢ï¼Œåˆ™æŒ‰å¦‚ä¸‹ä¸¤æ­¥</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT sql_hash_value,</span><br><span class="line">         prev_hash_value,</span><br><span class="line">         username,</span><br><span class="line">         sid.SERIAL<span class="comment">#,</span></span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         status,</span><br><span class="line">         PROGRAM,</span><br><span class="line">         CLIENT_IDENTIFIER,</span><br><span class="line">         machine,</span><br><span class="line">         action,</span><br><span class="line">         PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         osuser</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE sid=&sidSELECT sql_fulltext</span><br><span class="line">FROM v<span class="variable">$sql</span></span><br><span class="line">WHERE hash_value=XX</span><br></pre></td></tr></tbody></table></figure><blockquote><ul><li>XXä¸ºä¸Šé¢ <code>sql_hash_value</code>ï¼Œå¦‚æœ <code>sql_hash_valueä¸º0</code>ï¼Œåˆ™XXä¸ºä¸Šé¢ <code>prev_hash_value</code></li></ul></blockquote><h4 id="æ ¹æ®spidæŸ¥è¯¢å…·ä½“çš„sqlè¯­å¥-ä¸è¦åŠ æ¡ä»¶v-session-status-â€™-ACTIVEâ€™-æ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select-from-v-sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v-session-statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql-idå¯¹åº”çš„è¯­å¥å°±æ˜¯select-from-v-sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚"><a href="#æ ¹æ®spidæŸ¥è¯¢å…·ä½“çš„sqlè¯­å¥-ä¸è¦åŠ æ¡ä»¶v-session-status-â€™-ACTIVEâ€™-æ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select-from-v-sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v-session-statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql-idå¯¹åº”çš„è¯­å¥å°±æ˜¯select-from-v-sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚" class="headerlink" title="æ ¹æ®spidæŸ¥è¯¢å…·ä½“çš„sqlè¯­å¥(ä¸è¦åŠ æ¡ä»¶v$session.status=â€™ ACTIVEâ€™,æ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select  from v$sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v$session.statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯select  from v$sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚)"></a>æ ¹æ®spidæŸ¥è¯¢å…·ä½“çš„sqlè¯­å¥(ä¸è¦åŠ æ¡ä»¶v$session.status=â€™ ACTIVEâ€™,æ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select <em> from v$sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v$session.statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯select </em> from v$sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚)</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT ss.SID,</span><br><span class="line">         ss.SERIAL<span class="comment">#,</span></span><br><span class="line">         ss.LOGON_TIME,</span><br><span class="line">         pr.SPID,</span><br><span class="line">         sa.SQL_FULLTEXT,</span><br><span class="line">         ss.machine,</span><br><span class="line">         ss.TERMINAL,</span><br><span class="line">         ss.PROGRAM,</span><br><span class="line">         ss.USERNAME,</span><br><span class="line">         ss.CLIENT_IDENTIFIER,</span><br><span class="line">         ss.action,</span><br><span class="line">         ss.PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         ss.STATUS,</span><br><span class="line">         ss.OSUSER,</span><br><span class="line">         ss.status,</span><br><span class="line">         ss.last_call_et,</span><br><span class="line">         sa.sql_text</span><br><span class="line">FROM v<span class="variable">$process</span> pr, v<span class="variable">$session</span> ss, v<span class="variable">$sql</span> sa</span><br><span class="line">WHERE pr.ADDR = ss.PADDR</span><br><span class="line">        AND DECODE(ss.sql_hash_value, 0, prev_hash_value, sql_hash_value)=sa.hash_value</span><br><span class="line">        AND pr.spid=&spid</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹å†å²session-idçš„SQLæ¥è‡ªå“ªä¸ªIP"><a href="#æŸ¥çœ‹å†å²session-idçš„SQLæ¥è‡ªå“ªä¸ªIP" class="headerlink" title="æŸ¥çœ‹å†å²session_idçš„SQLæ¥è‡ªå“ªä¸ªIP"></a>æŸ¥çœ‹å†å²session_idçš„SQLæ¥è‡ªå“ªä¸ªIP</h4><p>æŸ¥çœ‹traceæ–‡ä»¶åå°±å¯ä»¥çŸ¥é“spid,traceæ–‡ä»¶é‡Œé¢æœ‰sidå’Œå…·ä½“sqlï¼Œå¦‚æœtraceå­˜åœ¨incidentï¼Œé‚£traceå°±çœ‹ä¸åˆ°å…·ä½“sqlï¼Œä½†æ˜¯å¯ä»¥åœ¨incidentæ–‡ä»¶ä¸­çœ‹åˆ°å…·ä½“çš„sqlï¼Œå¦‚DW_ora_17751.trcä¸­17751å°±æ˜¯spidï¼Œé‡Œé¢æœ‰è¿™æ ·çš„å†…å®¹Incident 115 created, dump file: /XX/incident/incdir_115/DW_ora_17751_i115.trcï¼Œé‚£ä¹ˆåœ¨DW_ora_17751_i115.trcå°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„sqlè¯­å¥)</p><p>DB_ora_29349.trcä¸­å‡ºç°<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*** SESSION ID:(5057.12807) 2016-10-26 14:45:52.726</span><br></pre></td></tr></tbody></table></figure><p></p><p>é€šè¿‡è¡¨<code>V$ACTIVE_SESSION_HISTORY</code>æ¥æŸ¥<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.sql_id,</span><br><span class="line">         a.machine,</span><br><span class="line">         a.*</span><br><span class="line">FROM V<span class="variable">$ACTIVE_SESSION_HISTORY</span> a</span><br><span class="line">WHERE a.session_id=5057</span><br><span class="line">        AND a.SESSION_SERIAL<span class="comment">#=12807</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥è¯¢ä¸Šé¢çš„machineçš„IP"><a href="#æŸ¥è¯¢ä¸Šé¢çš„machineçš„IP" class="headerlink" title="æŸ¥è¯¢ä¸Šé¢çš„machineçš„IP"></a>æŸ¥è¯¢ä¸Šé¢çš„machineçš„IP</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.machine,</span><br><span class="line">         p.spid,</span><br><span class="line">         p.terminal</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.machine=<span class="string">'localhost'</span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ä¸Šé¢çš„<code>spid</code>åœ¨oracleæœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code>netstat -anp |grep spid</code>å³å¯<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@dwdb trace]$ netstat -anp |grep 17630 </span><br><span class="line">tcp      210      0 192.168.64.228:11095        192.168.21.16:1521          ESTABLISHED 17630/oracleDB </span><br><span class="line">tcp        0      0 ::ffff:192.168.64.228:1521  ::ffff:192.168.64.220:59848 ESTABLISHED 17630/oracleDB</span><br></pre></td></tr></tbody></table></figure><p></p><p>å‡ºç°ä¸¤ä¸ªï¼Œè¯´æ˜æ¥è‡ª220ï¼Œè¿æ¥äº†228æ•°æ®åº“æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆé€šè¿‡228æœåŠ¡å™¨çš„dblinkå»è¿æ¥äº†16æœåŠ¡å™¨ </p><h4 id="æŸ¥è¯¢æ­»é”å µå¡çš„ä¼šè¯sid"><a href="#æŸ¥è¯¢æ­»é”å µå¡çš„ä¼šè¯sid" class="headerlink" title="æŸ¥è¯¢æ­»é”å µå¡çš„ä¼šè¯sid"></a>æŸ¥è¯¢æ­»é”å µå¡çš„ä¼šè¯sid</h4><p>æœ€ç®€å•çš„ä¸€ä¸ªSQL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from V<span class="variable">$SESSION_BLOCKERS</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from dba_waiters</span><br></pre></td></tr></tbody></table></figure><p></p><p>æœ€å¸¸ç”¨çš„ä¸€ä¸ªSQL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT sid,</span><br><span class="line">         status,</span><br><span class="line">         LOGON_TIME,</span><br><span class="line">         sql_id,</span><br><span class="line">         blocking_session <span class="string">"æ­»é”ç›´æ¥æº"</span>,</span><br><span class="line">         FINAL_BLOCKING_SESSION <span class="string">"æ­»é”æœ€ç»ˆæº"</span>,</span><br><span class="line">         event,</span><br><span class="line">        seconds_in_wait <span class="string">"ä¼šè¯é”ä½æ—¶é—´_S"</span>,</span><br><span class="line">         LAST_CALL_ET <span class="string">"ä¼šè¯STATUSæŒç»­æ—¶é—´_S"</span></span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE state=<span class="string">'WAITING'</span></span><br><span class="line">        AND BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br><span class="line">        AND FINAL_BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯ä»¥æŠŠä¸¤è€…<code>SID</code>æ”¾å…¥<code>v$session</code>ï¼Œå‘ç°<code>LOGON_TIME</code>å­—æ®µ<code>FINAL_BLOCKING_SESSION</code>æ¯”<code>SID</code>è¦æ—© </p><blockquote><p>BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if BLOCKING_SESSION_STATUS has the value VALID. </p></blockquote><blockquote><p>FINAL_BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if FINAL_BLOCKING_SESSION_STATUS has the value VALID. </p></blockquote><p>å¦‚æœé‡åˆ°<code>RACç¯å¢ƒ</code>ï¼Œä¸€å®šè¦ç”¨<code>gv$</code>æ¥æŸ¥ï¼Œå¹¶ä¸”æ‰§è¡Œ<code>alter system kill session 'sid,serial#'</code>è¦åˆ°<code>RAC</code>å¯¹åº”çš„å®ä¾‹ä¸Šå»æ‰§è¡Œ   </p><p>æŠŠä¸Šé¢è¢«å µå¡ä¼šè¯çš„<code>sid</code>ä»£å…¥å¦‚ä¸‹è¯­å¥ï¼Œå¯ä»¥å‘ç°é”ä½çš„å¯¹è±¡å’Œå¯¹è±¡çš„å“ªä¸€è¡Œ(å¦‚æœ<code>sid</code>æ˜¯å µå¡æºçš„ä¼šè¯ï¼Œåˆ™ <code>row_wait_obj#=-1</code>ï¼Œè¡¨ç¤ºé”æŒæœ‰è€…ï¼Œå°±æ˜¯æ­»é”æºäº† )<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.username,</span><br><span class="line">         d.owner,</span><br><span class="line">         d.object_name,</span><br><span class="line">         s.row_wait_obj<span class="comment">#,</span></span><br><span class="line">         s.row_wait_row<span class="comment">#,</span></span><br><span class="line">         s.row_wait_file<span class="comment">#,</span></span><br><span class="line">         s.row_wait_block<span class="comment">#</span></span><br><span class="line">FROM v<span class="variable">$session</span> s, dba_objects d</span><br><span class="line">WHERE s.row_wait_obj<span class="comment"># = d.object_id</span></span><br><span class="line">        AND s.sid <span class="keyword">in</span>(XX,XX)</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥è¯¢é”ä½çš„DDLå¯¹è±¡"><a href="#æŸ¥è¯¢é”ä½çš„DDLå¯¹è±¡" class="headerlink" title="æŸ¥è¯¢é”ä½çš„DDLå¯¹è±¡"></a>æŸ¥è¯¢é”ä½çš„DDLå¯¹è±¡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT d.session_id,</span><br><span class="line">         s.SERIAL<span class="comment">#,</span></span><br><span class="line">         d.name</span><br><span class="line">FROM dba_ddl_locks d, v<span class="variable">$session</span> s</span><br><span class="line">WHERE d.owner = <span class="string">'MKLMIGEM'</span></span><br><span class="line">        AND d.SESSION_ID=s.sid</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢è¶…è¿‡ä¸¤ä¸ªå°æ—¶çš„ä¸æ´»åŠ¨ä¼šè¯"><a href="#æŸ¥è¯¢è¶…è¿‡ä¸¤ä¸ªå°æ—¶çš„ä¸æ´»åŠ¨ä¼šè¯" class="headerlink" title="æŸ¥è¯¢è¶…è¿‡ä¸¤ä¸ªå°æ—¶çš„ä¸æ´»åŠ¨ä¼šè¯"></a>æŸ¥è¯¢è¶…è¿‡ä¸¤ä¸ªå°æ—¶çš„ä¸æ´»åŠ¨ä¼šè¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">         s.serial<span class="comment">#,</span></span><br><span class="line">         p.spid,</span><br><span class="line">         s.LOGON_TIME,</span><br><span class="line">         s.LAST_CALL_ET,</span><br><span class="line">         s.status,</span><br><span class="line">         s.PROGRAM,</span><br><span class="line">         s.CLIENT_IDENTIFIER,</span><br><span class="line">         s.machine,</span><br><span class="line">         s.terminal,</span><br><span class="line">         s.action,</span><br><span class="line">         s.PROCESS <span class="string">"å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·"</span>,</span><br><span class="line">         s.osuser</span><br><span class="line">FROM v<span class="variable">$session</span> s, v<span class="variable">$process</span> p</span><br><span class="line">WHERE s.paddr=p.addr</span><br><span class="line">        AND s.sid IN </span><br><span class="line">    (SELECT sid</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE machine <> &DBæœåŠ¡å™¨åç§°</span><br><span class="line">            AND status=<span class="string">'INACTIVE'</span></span><br><span class="line">            AND sql_id is null</span><br><span class="line">            AND LAST_CALL_ET > 7200 )</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å µå¡åˆ«çš„ä¼šè¯è¶…è¿‡30åˆ†é’Ÿä¸”è‡ªèº«æ˜¯ä¸æ´»åŠ¨çš„ä¼šè¯"><a href="#æŸ¥è¯¢å µå¡åˆ«çš„ä¼šè¯è¶…è¿‡30åˆ†é’Ÿä¸”è‡ªèº«æ˜¯ä¸æ´»åŠ¨çš„ä¼šè¯" class="headerlink" title="æŸ¥è¯¢å µå¡åˆ«çš„ä¼šè¯è¶…è¿‡30åˆ†é’Ÿä¸”è‡ªèº«æ˜¯ä¸æ´»åŠ¨çš„ä¼šè¯"></a>æŸ¥è¯¢å µå¡åˆ«çš„ä¼šè¯è¶…è¿‡30åˆ†é’Ÿä¸”è‡ªèº«æ˜¯ä¸æ´»åŠ¨çš„ä¼šè¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT username,</span><br><span class="line">        sid,</span><br><span class="line">        serial<span class="comment">#,</span></span><br><span class="line">        status,</span><br><span class="line">        seconds_in_wait,</span><br><span class="line">        LAST_CALL_ET</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE sid IN </span><br><span class="line">    (SELECT FINAL_BLOCKING_SESSION</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE state=<span class="string">'WAITING'</span></span><br><span class="line">            AND BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span></span><br><span class="line">            AND FINAL_BLOCKING_SESSION_STATUS=<span class="string">'VALID'</span>)</span><br><span class="line">        AND status=<span class="string">'INACTIVE'</span></span><br><span class="line">        AND sql_id is null</span><br><span class="line">        AND seconds_in_wait>1800</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å¯èƒ½å­˜åœ¨è¿æ¥æ± ç©ºé—²åˆå§‹é…ç½®è¿‡å¤§çš„è¿æ¥ï¼ˆæ¥è‡ªåŒä¸€å°æœºå™¨çš„åŒä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ä¸ºINACTIVEçš„è¿æ¥éå¸¸å¤šï¼‰"><a href="#æŸ¥è¯¢å¯èƒ½å­˜åœ¨è¿æ¥æ± ç©ºé—²åˆå§‹é…ç½®è¿‡å¤§çš„è¿æ¥ï¼ˆæ¥è‡ªåŒä¸€å°æœºå™¨çš„åŒä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ä¸ºINACTIVEçš„è¿æ¥éå¸¸å¤šï¼‰" class="headerlink" title="æŸ¥è¯¢å¯èƒ½å­˜åœ¨è¿æ¥æ± ç©ºé—²åˆå§‹é…ç½®è¿‡å¤§çš„è¿æ¥ï¼ˆæ¥è‡ªåŒä¸€å°æœºå™¨çš„åŒä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ä¸ºINACTIVEçš„è¿æ¥éå¸¸å¤šï¼‰"></a>æŸ¥è¯¢å¯èƒ½å­˜åœ¨è¿æ¥æ± ç©ºé—²åˆå§‹é…ç½®è¿‡å¤§çš„è¿æ¥ï¼ˆæ¥è‡ªåŒä¸€å°æœºå™¨çš„åŒä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ä¸ºINACTIVEçš„è¿æ¥éå¸¸å¤šï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT count(ss.SID),</span><br><span class="line">        ss.machine,</span><br><span class="line">        ss.status,</span><br><span class="line">        ss.TERMINAL,</span><br><span class="line">        ss.PROGRAM,</span><br><span class="line">        ss.USERNAME,</span><br><span class="line">        ss.CLIENT_IDENTIFIER</span><br><span class="line">FROM v<span class="variable">$session</span> ss</span><br><span class="line">GROUP BY  ss.machine,ss.status,ss.TERMINAL,ss.PROGRAM,ss.USERNAME,ss.CLIENT_IDENTIFIER</span><br><span class="line">HAVING count(ss.SID)>10</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„sql"><a href="#æŸ¥è¯¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„sql" class="headerlink" title="æŸ¥è¯¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„sql"></a>æŸ¥è¯¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„sql</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.username,</span><br><span class="line">        spid,</span><br><span class="line">        v<span class="variable">$sql</span>.sql_id,</span><br><span class="line">        machine,</span><br><span class="line">        s.terminal,</span><br><span class="line">        s.program,</span><br><span class="line">        sql_text</span><br><span class="line">FROM v<span class="variable">$process</span>,v<span class="variable">$session</span> s,v<span class="variable">$sql</span></span><br><span class="line">WHERE addr=paddr</span><br><span class="line">        AND s.sql_id=v<span class="variable">$sql</span>.sql_id</span><br><span class="line">        AND sql_hash_value=hash_value</span><br><span class="line">        AND s.STATUS=<span class="string">'ACTIVE'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„SCHEDULER-JOB"><a href="#æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„SCHEDULER-JOB" class="headerlink" title="æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„SCHEDULER_JOB"></a>æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„SCHEDULER_JOB</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT owner,</span><br><span class="line">        job_name,</span><br><span class="line">        sid,</span><br><span class="line">        b.SERIAL<span class="comment">#,</span></span><br><span class="line">        b.username,</span><br><span class="line">        spid</span><br><span class="line">FROM ALL_SCHEDULER_RUNNING_JOBS,v<span class="variable">$session</span> b,v<span class="variable">$process</span></span><br><span class="line">WHERE session_id=sid</span><br><span class="line">        AND paddr=addr</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„dbms-job"><a href="#æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„dbms-job" class="headerlink" title="æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„dbms_job"></a>æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„dbms_job</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT job,</span><br><span class="line">        b.sid,</span><br><span class="line">        b.SERIAL<span class="comment">#,</span></span><br><span class="line">        b.username,</span><br><span class="line">        spid</span><br><span class="line">FROM DBA_JOBS_RUNNING a ,v<span class="variable">$session</span> b,v<span class="variable">$process</span></span><br><span class="line">WHERE a.sid=b.sid</span><br><span class="line">        AND paddr=addr</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢ä¸€ä¸ªä¼šè¯sessionã€processå¹³å‡æ¶ˆè€—å¤šå°‘PGAå†…å­˜ï¼ŒæŸ¥çœ‹ä¸‹é¢avg-used-Må€¼"><a href="#æŸ¥è¯¢ä¸€ä¸ªä¼šè¯sessionã€processå¹³å‡æ¶ˆè€—å¤šå°‘PGAå†…å­˜ï¼ŒæŸ¥çœ‹ä¸‹é¢avg-used-Må€¼" class="headerlink" title="æŸ¥è¯¢ä¸€ä¸ªä¼šè¯sessionã€processå¹³å‡æ¶ˆè€—å¤šå°‘PGAå†…å­˜ï¼ŒæŸ¥çœ‹ä¸‹é¢avg_used_Må€¼"></a>æŸ¥è¯¢ä¸€ä¸ªä¼šè¯sessionã€processå¹³å‡æ¶ˆè€—å¤šå°‘PGAå†…å­˜ï¼ŒæŸ¥çœ‹ä¸‹é¢avg_used_Må€¼</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT round(sum(pga_used_mem)/1024/1024,</span><br><span class="line">        0) total_used_M,</span><br><span class="line">         round(sum(pga_used_mem)/count(1)/1024/1024,</span><br><span class="line">        0) avg_used_M,</span><br><span class="line">         round(sum(pga_alloc_mem)/1024/1024,</span><br><span class="line">        0) total_alloc_M,</span><br><span class="line">         round(sum(pga_alloc_mem)/count(1)/1024/1024,</span><br><span class="line">        0) avg_alloc_M</span><br><span class="line">FROM v<span class="variable">$process</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="TOP-10-æ‰§è¡Œæ¬¡æ•°æ’åº"><a href="#TOP-10-æ‰§è¡Œæ¬¡æ•°æ’åº" class="headerlink" title="TOP 10 æ‰§è¡Œæ¬¡æ•°æ’åº"></a>TOP 10 æ‰§è¡Œæ¬¡æ•°æ’åº</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT executions,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  executions desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><h4 id="TOP-10-ç‰©ç†è¯»æ’åºï¼ˆæ¶ˆè€—IOæ’åºï¼Œå³æœ€å·®æ€§èƒ½SQLã€ä½æ•ˆSQLæ’åºï¼‰"><a href="#TOP-10-ç‰©ç†è¯»æ’åºï¼ˆæ¶ˆè€—IOæ’åºï¼Œå³æœ€å·®æ€§èƒ½SQLã€ä½æ•ˆSQLæ’åºï¼‰" class="headerlink" title="TOP 10 ç‰©ç†è¯»æ’åºï¼ˆæ¶ˆè€—IOæ’åºï¼Œå³æœ€å·®æ€§èƒ½SQLã€ä½æ•ˆSQLæ’åºï¼‰"></a>TOP 10 ç‰©ç†è¯»æ’åºï¼ˆæ¶ˆè€—IOæ’åºï¼Œå³æœ€å·®æ€§èƒ½SQLã€ä½æ•ˆSQLæ’åºï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT DISK_READS,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  DISK_READS desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ³¨æ„ï¼šä¸è¦ä½¿ç”¨DISK_READS/ EXECUTIONSæ¥æ’åºï¼Œå› ä¸ºä»»ä½•ä¸€æ¡è¯­å¥ä¸ç®¡æ‰§è¡Œå‡ æ¬¡éƒ½ä¼šè€—é€»è¾‘è¯»å’Œcpuï¼Œå¯èƒ½ä¸ä¼šè€—ç‰©ç†è¯»ï¼ˆé‡åˆ°LRUè¿˜ä¼šè€—ç‰©ç†è¯»ï¼ŒLRUè§„åˆ™æ˜¯æ‰§è¡Œæœ€ä¸é¢‘ç¹çš„ä¸”æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´è·ç¦»ç°åœ¨æœ€ä¹…è¿œçš„å°±ä¼šè¢«äº¤äº’å‡ºbuffer cacheï¼‰ï¼Œæ˜¯å› ä¸ºbuffer cacheå­˜æ”¾çš„æ˜¯æ•°æ®å—ï¼Œå»æ•°æ®å—é‡Œæ‰¾è¡Œä¸€å®šä¼šæ¶ˆè€—cpuå’Œé€»è¾‘è¯»çš„ã€‚Shared poolæ‰§è¡Œå­˜æ”¾sqlçš„è§£æç»“æœï¼Œsqlæ‰§è¡Œçš„æ—¶å€™åªæ˜¯å»share poolä¸­æ‰¾hash valueï¼Œå¦‚æœæœ‰åŒ¹é…çš„å°±æ˜¯è½¯è§£æã€‚æ‰€ä»¥ç‰©ç†è¯»é€»è¾‘è¯»æ˜¯åœ¨buffer cacheä¸­ï¼Œè½¯è§£æç¡¬è§£ææ˜¯åœ¨shared pool</p></blockquote><h4 id="TOP-10-é€»è¾‘è¯»æ’åºï¼ˆæ¶ˆè€—å†…å­˜æ’åºï¼‰"><a href="#TOP-10-é€»è¾‘è¯»æ’åºï¼ˆæ¶ˆè€—å†…å­˜æ’åºï¼‰" class="headerlink" title="TOP 10 é€»è¾‘è¯»æ’åºï¼ˆæ¶ˆè€—å†…å­˜æ’åºï¼‰"></a>TOP 10 é€»è¾‘è¯»æ’åºï¼ˆæ¶ˆè€—å†…å­˜æ’åºï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT BUFFER_GETS,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  BUFFER_GETS desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ³¨æ„ï¼šä¸è¦ä½¿ç”¨BUFFER_GETS/ EXECUTIONSæ¥æ’åºï¼Œå› ä¸ºä»»ä½•ä¸€æ¡è¯­å¥ä¸ç®¡æ‰§è¡Œå‡ æ¬¡éƒ½ä¼šè€—é€»è¾‘è¯»å’Œcpuï¼Œå¯èƒ½ä¸ä¼šè€—ç‰©ç†è¯»ï¼ˆé‡åˆ°LRUè¿˜ä¼šè€—ç‰©ç†è¯»ï¼ŒLRUè§„åˆ™æ˜¯æ‰§è¡Œæœ€ä¸é¢‘ç¹çš„ä¸”æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´è·ç¦»ç°åœ¨æœ€ä¹…è¿œçš„å°±ä¼šè¢«äº¤äº’å‡ºbuffer cacheï¼‰ï¼Œæ˜¯å› ä¸ºbuffer cacheå­˜æ”¾çš„æ˜¯æ•°æ®å—ï¼Œå»æ•°æ®å—é‡Œæ‰¾è¡Œä¸€å®šä¼šæ¶ˆè€—cpuå’Œé€»è¾‘è¯»çš„ã€‚Shared poolæ‰§è¡Œå­˜æ”¾sqlçš„è§£æç»“æœï¼Œsqlæ‰§è¡Œçš„æ—¶å€™åªæ˜¯å»share poolä¸­æ‰¾hash valueï¼Œå¦‚æœæœ‰åŒ¹é…çš„å°±æ˜¯è½¯è§£æã€‚æ‰€ä»¥ç‰©ç†è¯»é€»è¾‘è¯»æ˜¯åœ¨buffer cacheä¸­ï¼Œè½¯è§£æç¡¬è§£ææ˜¯åœ¨shared poolï¼‰</p></blockquote><h4 id="TOP-10-CPUæ’åº-å•ä½ç§’-cpu-time-1000000"><a href="#TOP-10-CPUæ’åº-å•ä½ç§’-cpu-time-1000000" class="headerlink" title="TOP 10 CPUæ’åº(å•ä½ç§’=cpu_time/1000000)"></a>TOP 10 CPUæ’åº(å•ä½ç§’=cpu_time/1000000)</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT CPU_TIME/1000000,</span><br><span class="line">        username,</span><br><span class="line">        PARSING_USER_ID,</span><br><span class="line">        sql_id,</span><br><span class="line">        ELAPSED_TIME/1000000,</span><br><span class="line">        sql_text</span><br><span class="line">    FROM v<span class="variable">$sql</span>,dba_users</span><br><span class="line">    WHERE user_id=PARSING_USER_ID</span><br><span class="line">    ORDER BY  CPU_TIME/1000000 desc)</span><br><span class="line">WHERE rownum <=5;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ³¨æ„ï¼šä¸è¦ä½¿ç”¨CPU_TIME/ EXECUTIONSæ¥æ’åºï¼Œå› ä¸ºä»»ä½•ä¸€æ¡è¯­å¥ä¸ç®¡æ‰§è¡Œå‡ æ¬¡éƒ½ä¼šè€—é€»è¾‘è¯»å’Œcpuï¼Œå¯èƒ½ä¸ä¼šè€—ç‰©ç†è¯»ï¼ˆé‡åˆ°LRUè¿˜ä¼šè€—ç‰©ç†è¯»ï¼ŒLRUè§„åˆ™æ˜¯æ‰§è¡Œæœ€ä¸é¢‘ç¹çš„ä¸”æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´è·ç¦»ç°åœ¨æœ€ä¹…è¿œçš„å°±ä¼šè¢«äº¤äº’å‡ºbuffer cacheï¼‰ï¼Œæ˜¯å› ä¸ºbuffer cacheå­˜æ”¾çš„æ˜¯æ•°æ®å—ï¼Œå»æ•°æ®å—é‡Œæ‰¾è¡Œä¸€å®šä¼šæ¶ˆè€—cpuå’Œé€»è¾‘è¯»çš„ã€‚Shared poolæ‰§è¡Œå­˜æ”¾sqlçš„è§£æç»“æœï¼Œsqlæ‰§è¡Œçš„æ—¶å€™åªæ˜¯å»share poolä¸­æ‰¾hash valueï¼Œå¦‚æœæœ‰åŒ¹é…çš„å°±æ˜¯è½¯è§£æã€‚æ‰€ä»¥ç‰©ç†è¯»é€»è¾‘è¯»æ˜¯åœ¨buffer cacheä¸­ï¼Œè½¯è§£æç¡¬è§£ææ˜¯åœ¨shared poolã€‚</p></blockquote><h4 id="æŸ¥è¯¢ç­‰å¾…äº‹ä»¶"><a href="#æŸ¥è¯¢ç­‰å¾…äº‹ä»¶" class="headerlink" title="æŸ¥è¯¢ç­‰å¾…äº‹ä»¶"></a>æŸ¥è¯¢ç­‰å¾…äº‹ä»¶</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT event,</span><br><span class="line">        sum(decode(wait_time,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        1)) <span class="string">"ä¹‹å‰ç­‰å¾…æ¬¡æ•°"</span>,</span><br><span class="line">         sum(decode(wait_time,</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        0)) <span class="string">"æ­£åœ¨ç­‰å¾…æ¬¡æ•°"</span>,</span><br><span class="line">        count(*)</span><br><span class="line">FROM v<span class="variable">$session_wait</span></span><br><span class="line">GROUP BY  event</span><br><span class="line">ORDER BY  4 DESC </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### æŸ¥è¯¢å½“å‰ç­‰å¾…äº‹ä»¶å¯¹åº”çš„å¯¹è±¡</span></span><br><span class="line">```bash</span><br><span class="line">SELECT DISTINCT wait_class<span class="comment">#,</span></span><br><span class="line">        wait_class</span><br><span class="line">FROM v<span class="variable">$session_wait_class</span></span><br><span class="line">ORDER BY  1</span><br></pre></td></tr></tbody></table></figure><h4 id="ä»¥ä¸Šsqlå‘ç°wait-class-6çš„æ˜¯ç©ºé—²ç­‰å¾…"><a href="#ä»¥ä¸Šsqlå‘ç°wait-class-6çš„æ˜¯ç©ºé—²ç­‰å¾…" class="headerlink" title="ä»¥ä¸Šsqlå‘ç°wait_class#=6çš„æ˜¯ç©ºé—²ç­‰å¾…"></a>ä»¥ä¸Šsqlå‘ç°wait_class#=6çš„æ˜¯ç©ºé—²ç­‰å¾…</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT sid,</span><br><span class="line">        event,</span><br><span class="line">        p1text,</span><br><span class="line">        p1,</span><br><span class="line">        p2text,</span><br><span class="line">        p2,</span><br><span class="line">        p3text,</span><br><span class="line">        p3,</span><br><span class="line">        WAIT_TIME,</span><br><span class="line">        SECONDS_IN_WAIT,</span><br><span class="line">        wait_class<span class="comment">#</span></span><br><span class="line">    FROM v<span class="variable">$session_wait</span></span><br><span class="line">    WHERE wait_class<span class="comment"># <> 6</span></span><br><span class="line">    ORDER BY  wait_time desc)</span><br><span class="line">WHERE rownum <=10;</span><br></pre></td></tr></tbody></table></figure><h4 id="èƒ½æŸ¥å‡ºç­‰å¾…çš„å¯¹è±¡æ˜¯å¦æ¥è‡ªæ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä»¥ä¸ŠæŸ¥åˆ°p1textæ˜¯file-æˆ–file-numberï¼‰"><a href="#èƒ½æŸ¥å‡ºç­‰å¾…çš„å¯¹è±¡æ˜¯å¦æ¥è‡ªæ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä»¥ä¸ŠæŸ¥åˆ°p1textæ˜¯file-æˆ–file-numberï¼‰" class="headerlink" title="èƒ½æŸ¥å‡ºç­‰å¾…çš„å¯¹è±¡æ˜¯å¦æ¥è‡ªæ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä»¥ä¸ŠæŸ¥åˆ°p1textæ˜¯file#æˆ–file numberï¼‰"></a>èƒ½æŸ¥å‡ºç­‰å¾…çš„å¯¹è±¡æ˜¯å¦æ¥è‡ªæ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä»¥ä¸ŠæŸ¥åˆ°p1textæ˜¯file#æˆ–file numberï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT owner,</span><br><span class="line">        segment_name,</span><br><span class="line">        segment_type,</span><br><span class="line">        block_id,</span><br><span class="line">        bytes</span><br><span class="line">    FROM dba_extents</span><br><span class="line">    WHERE file_id=p1</span><br><span class="line">            AND block_id<p2 order=<span class="string">""</span> by=<span class="string">""</span> block_id=<span class="string">""</span> desc)</span><br><span class="line">WHERE rownum<2</span><br></pre></td></tr></tbody></table></figure><p>æŠŠä¸Šé¢ç¬¬äºŒä¸ªsqlç»“æœçš„p1ã€p2å€¼ä»£å…¥ä¸Šè¿°sqlçš„file_idã€block_id</p><p>é€šè¿‡<code>AWR</code>çš„<code>top sql</code>æˆ–<code>v$sql.sql_text</code>æŸ¥çœ‹æ˜¯å¦æœ‰è¯¥å¯¹è±¡çš„è¯­å¥ï¼Œæ£€æŸ¥è¯¥è¯­å¥çš„æ‰§è¡Œè®¡åˆ’å°±å¯ä»¥æŸ¥å‡ºé—®é¢˜æ‰€åœ¨ã€‚</p><h4 id="æŸ¥è¯¢å½“å‰æ­£åœ¨æ¶ˆè€—ä¸´æ—¶ç©ºé—´çš„sqlè¯­å¥"><a href="#æŸ¥è¯¢å½“å‰æ­£åœ¨æ¶ˆè€—ä¸´æ—¶ç©ºé—´çš„sqlè¯­å¥" class="headerlink" title="æŸ¥è¯¢å½“å‰æ­£åœ¨æ¶ˆè€—ä¸´æ—¶ç©ºé—´çš„sqlè¯­å¥"></a>æŸ¥è¯¢å½“å‰æ­£åœ¨æ¶ˆè€—ä¸´æ—¶ç©ºé—´çš„sqlè¯­å¥</h4><h5 id="æ–¹æ³•ä¸€ï¼š-2"><a href="#æ–¹æ³•ä¸€ï¼š-2" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT se.username,</span><br><span class="line">         se.sid,</span><br><span class="line">         su.blocks * to_number(rtrim(p.value))/1024/1024 AS space_G,</span><br><span class="line">         su.tablespace,</span><br><span class="line">         sql_text</span><br><span class="line">FROM V<span class="variable">$TEMPSEG_USAGE</span> su, v<span class="variable">$parameter</span> p, v<span class="variable">$session</span> se, v<span class="variable">$sql</span> s</span><br><span class="line">WHERE p.name = <span class="string">'db_block_size'</span></span><br><span class="line">        AND su.session_addr=se.saddr</span><br><span class="line">        AND su.sqlhash=s.hash_value</span><br><span class="line">        AND su.sqladdr=s.address</span><br><span class="line">        AND se.STATUS=<span class="string">'ACTIVE'</span></span><br><span class="line">``` </span><br><span class="line"><span class="comment">##### æ–¹æ³•äºŒï¼š</span></span><br><span class="line">```bash</span><br><span class="line">SELECT v<span class="variable">$sql</span>.sql_id,</span><br><span class="line">        v<span class="variable">$sql</span>.sql_fulltext,</span><br><span class="line">        swa.TEMPSEG_SIZE/1024/1024 TEMPSEG_M,</span><br><span class="line">         swa.*</span><br><span class="line">FROM v<span class="variable">$sql_workarea_active</span> swa,v<span class="variable">$sql</span></span><br><span class="line">WHERE swa.sql_id=v<span class="variable">$sql</span>.sql_id</span><br><span class="line">        AND swa.NUMBER_PASSES>0</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å› PGAä¸è¶³è€Œä½¿ç”¨ä¸´æ—¶è¡¨ç©ºé—´çš„æœ€é¢‘ç¹çš„10æ¡SQLè¯­å¥"><a href="#æŸ¥è¯¢å› PGAä¸è¶³è€Œä½¿ç”¨ä¸´æ—¶è¡¨ç©ºé—´çš„æœ€é¢‘ç¹çš„10æ¡SQLè¯­å¥" class="headerlink" title="æŸ¥è¯¢å› PGAä¸è¶³è€Œä½¿ç”¨ä¸´æ—¶è¡¨ç©ºé—´çš„æœ€é¢‘ç¹çš„10æ¡SQLè¯­å¥"></a>æŸ¥è¯¢å› PGAä¸è¶³è€Œä½¿ç”¨ä¸´æ—¶è¡¨ç©ºé—´çš„æœ€é¢‘ç¹çš„10æ¡SQLè¯­å¥</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT OPERATION_TYPE,</span><br><span class="line">        ESTIMATED_OPTIMAL_SIZE,</span><br><span class="line">        ESTIMATED_ONEPASS_SIZE,</span><br><span class="line">         sum(OPTIMAL_EXECUTIONS) optimal_cnt,</span><br><span class="line">        sum(ONEPASS_EXECUTIONS) AS onepass_cnt,</span><br><span class="line">         sum(MULTIPASSES_EXECUTIONS) AS mpass_cnt,</span><br><span class="line">        s.sql_text</span><br><span class="line">    FROM V<span class="variable">$SQL_WORKAREA</span> swa, v<span class="variable">$sql</span> s</span><br><span class="line">    WHERE swa.sql_id=s.sql_id</span><br><span class="line">    GROUP BY  OPERATION_TYPE,ESTIMATED_OPTIMAL_SIZE,ESTIMATED_ONEPASS_SIZE,sql_text</span><br><span class="line">    HAVING sum(ONEPASS_EXECUTIONS+MULTIPASSES_EXECUTIONS)>0</span><br><span class="line">    ORDER BY  sum(ONEPASS_EXECUTIONS) DESC )</span><br><span class="line">WHERE rownum<10</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ­£åœ¨æ¶ˆè€—PGAçš„SQL"><a href="#æŸ¥è¯¢æ­£åœ¨æ¶ˆè€—PGAçš„SQL" class="headerlink" title="æŸ¥è¯¢æ­£åœ¨æ¶ˆè€—PGAçš„SQL"></a>æŸ¥è¯¢æ­£åœ¨æ¶ˆè€—PGAçš„SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sql_text,</span><br><span class="line">         sw.EXPECTED_SIZE,</span><br><span class="line">         sw.ACTUAL_MEM_USED,</span><br><span class="line">        sw.NUMBER_PASSES,</span><br><span class="line">         sw.TEMPSEG_SIZE</span><br><span class="line">FROM v<span class="variable">$sql_workarea_active</span> sw, v<span class="variable">$sql</span> s</span><br><span class="line">WHERE sw.sql_id=s.sql_id;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢éœ€è¦ä½¿ç”¨ç»‘å®šå˜é‡çš„sqlï¼Œ10Gä»¥åæ¨èç¬¬äºŒç§"><a href="#æŸ¥è¯¢éœ€è¦ä½¿ç”¨ç»‘å®šå˜é‡çš„sqlï¼Œ10Gä»¥åæ¨èç¬¬äºŒç§" class="headerlink" title="æŸ¥è¯¢éœ€è¦ä½¿ç”¨ç»‘å®šå˜é‡çš„sqlï¼Œ10Gä»¥åæ¨èç¬¬äºŒç§"></a>æŸ¥è¯¢éœ€è¦ä½¿ç”¨ç»‘å®šå˜é‡çš„sqlï¼Œ10Gä»¥åæ¨èç¬¬äºŒç§</h4><blockquote><p>æ³¨æ„ï¼šä»»ä½•ä¸€æ¡æ‰§è¡Œè¿‡çš„è¯­å¥ä¸ç®¡æ‰§è¡Œäº†å‡ æ¬¡åœ¨V$SQLä¸­éƒ½åªæœ‰ä¸€æ¡è®°å½•ï¼ŒV$SQLä¸­ä¼šè®°å½•æ‰§è¡Œäº†å‡ æ¬¡ã€‚ä¸¤æ¡ä¸€æ¨¡ä¸€æ ·çš„è¯­å¥ä½†æ˜¯åœ¨ä¸åŒçš„schemaä¸‹æ‰§è¡Œçš„ä¸¤ç§ç»“æœï¼Œå¦‚select <em> from t1.teståœ¨syeã€systemä¸‹æ‰§è¡Œåˆ™V$SQLåªæœ‰ä¸€æ¡è®°å½•(è°å…ˆæ‰§è¡Œåˆ™PARSING_SCHEMA_NAMEæ˜¾ç¤ºè°)ã€‚å¦‚åœ¨syså’Œsysteméƒ½æ‰§è¡Œselect </em> from teståˆ™V$SQLä¸­æœ‰ä¸¤æ¡è®°å½•ï¼Œä¸¤æ¡è®°å½•çš„CHILD_NUMBERå’ŒPARSING_SCHEMA_NAMEä¸ä¸€æ ·ã€‚</p></blockquote><p>åŒä¸€ä¸ªç”¨æˆ·ä¸‹æ‰§è¡Œä¸€æ ·çš„è¯­å¥å¦‚æœå¤§å°å†™ä¸ä¸€æ ·æˆ–åŠ äº†hintçš„è¯åˆ™ä¼šå‡ºç°å¤šä¸ªV$SQLè®°å½•ï¼Œè¯´æ˜V$SQLå¯¹åº”çš„sqlè¯­å¥å¿…é¡»ä¸€æ¨¡ä¸€æ ·ï¼Œå¦‚æœalter system flush shared_poolï¼ˆä¸»ç«™æ…ç”¨ï¼‰åå†æ‰§è¡Œä¸€æ ·çš„è¯­å¥ï¼Œå‘ç°è¯­å¥åœ¨V$SQLä¸­çš„SQL_IDå’ŒHASH_VALUEä¸ä¹‹å‰çš„ä¸€æ ·ï¼Œè¯´æ˜SQL_IDå’ŒHASH_VALUEåº”è¯¥æ˜¯oracleè‡ªå·±çš„ä¸€å¥—ç®—æ³•æ¥çš„ï¼Œåªæ˜¯æ ¹æ®sqlè¯­å¥å†…å®¹æ¥è¿›è¡Œè½¬æ¢ï¼Œsqlè¯­å¥ä¸å˜åˆ™SQL_IDå’ŒHASH_VALUEä¹Ÿä¸å˜ã€‚</p><h5 id="ç¬¬ä¸€ç§"><a href="#ç¬¬ä¸€ç§" class="headerlink" title="ç¬¬ä¸€ç§"></a>ç¬¬ä¸€ç§</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">    (SELECT count(*),</span><br><span class="line">        sql_id,</span><br><span class="line">         substr(sql_text,</span><br><span class="line">        1,</span><br><span class="line">        40)</span><br><span class="line">    FROM v<span class="variable">$sql</span></span><br><span class="line">    GROUP BY  sql_id, substr(sql_text,1,40)</span><br><span class="line">    HAVING count(*) > 10</span><br><span class="line">    ORDER BY  count(*) desc)</span><br><span class="line">WHERE rownum<10</span><br></pre></td></tr></tbody></table></figure><h5 id="ç¬¬äºŒç§"><a href="#ç¬¬äºŒç§" class="headerlink" title="ç¬¬äºŒç§"></a>ç¬¬äºŒç§</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">count(1)>10è¡¨ç¤ºç±»è¯­å¥è¿è¡Œäº†10æ¬¡ä»¥ä¸ŠSELECT sql_id,</span><br><span class="line">         FORCE_MATCHING_SIGNATURE,</span><br><span class="line">         sql_text</span><br><span class="line">FROM v<span class="variable">$SQL</span></span><br><span class="line">WHERE FORCE_MATCHING_SIGNATURE IN </span><br><span class="line">    (SELECT /*+ unnest */ FORCE_MATCHING_SIGNATURE</span><br><span class="line">    FROM v<span class="variable">$sql</span></span><br><span class="line">    WHERE FORCE_MATCHING_SIGNATURE > 0</span><br><span class="line">            AND FORCE_MATCHING_SIGNATURE != EXACT_MATCHING_SIGNATURE</span><br><span class="line">    GROUP BY  FORCE_MATCHING_SIGNATURE</span><br><span class="line">    HAVING count(1) > 10)</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹æ•°æ®æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”"><a href="#æŸ¥çœ‹æ•°æ®æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”" class="headerlink" title="æŸ¥çœ‹æ•°æ®æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”"></a>æŸ¥çœ‹æ•°æ®æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”</h4><p><code>dba_free_space</code>å¹¶ä¸ä¼šåŒ…å«æ‰€æœ‰<code>file_id</code>ï¼Œå¦‚æœè¯¥æ•°æ®æ–‡ä»¶æ»¡äº†ï¼Œåˆ™ <code>dba_free_space.file_id</code>æ²¡æœ‰è¯¥æ•°æ®æ–‡ä»¶ï¼Œæ‰€ä»¥ä»¥ä¸‹sqlä¸­ <code>a.file_id=b.file_id</code>çš„æ¡ä»¶è¿‡æ»¤åæ˜¯ä¸ä¼šæœ‰æ‰€æœ‰file_idçš„<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.file_id,</span><br><span class="line">        b.tablespace_name,</span><br><span class="line">        b.file_name,</span><br><span class="line">        b.AUTOEXTENSIBLE,</span><br><span class="line">         ROUND(b.MAXBYTES/1024/1024/1024,</span><br><span class="line">        2) ||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶æœ€å¤§å¯ç”¨æ€»å®¹é‡"</span>, ROUND(b.bytes/1024/1024/1024,2) ||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶æ€»å®¹é‡"</span>, ROUND((b.bytes-sum(nvl(a.bytes,0)))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶å·²ç”¨å®¹é‡"</span>, ROUND(sum(nvl(a.bytes,0))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶å¯ç”¨å®¹é‡"</span>, ROUND(sum(nvl(a.bytes,0))/(b.bytes),2)*100||<span class="string">'%'</span> <span class="string">"æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”"</span></span><br><span class="line">FROM dba_free_space a,dba_data_files b</span><br><span class="line">WHERE a.file_id=b.file_id</span><br><span class="line">GROUP BY  b.tablespace_name,b.file_name,b.file_id,b.bytes,b.AUTOEXTENSIBLE,b.MAXBYTES</span><br><span class="line">ORDER BY  b.tablespace_name;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>å¦‚ä¸‹ä¸ºæ ‡å‡†ç‰ˆ<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.file_id,</span><br><span class="line">        b.tablespace_name,</span><br><span class="line">        b.file_name,</span><br><span class="line">        b.AUTOEXTENSIBLE,</span><br><span class="line">         ROUND(b.MAXBYTES/1024/1024/1024,</span><br><span class="line">        2) ||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶æœ€å¤§å¯ç”¨æ€»å®¹é‡"</span>, ROUND(b.bytes/1024/1024/1024,2) ||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶å½“å‰æ€»å®¹é‡"</span>, ROUND((b.bytes-sum(nvl(a.bytes,0)))/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶å½“å‰å·²ç”¨å®¹é‡"</span>, ROUND((decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes)/1024/1024/1024,2)||<span class="string">'G'</span> <span class="string">"æ–‡ä»¶å¯ç”¨å®¹é‡"</span>, ROUND((decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes)/(decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)),2)*100||<span class="string">'%'</span> <span class="string">"æ–‡ä»¶å¯ç”¨ç™¾åˆ†æ¯”"</span></span><br><span class="line">FROM dba_free_space a,dba_data_files b</span><br><span class="line">WHERE a.file_id=b.file_id</span><br><span class="line">GROUP BY  b.tablespace_name,b.file_name,b.file_id,b.bytes,b.AUTOEXTENSIBLE,b.MAXBYTES</span><br><span class="line">ORDER BY  decode(AUTOEXTENSIBLE,<span class="string">'NO'</span>,b.BYTES,b.MAXBYTES)+sum(nvl(a.bytes,0))-b.bytes;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶çš„å®é™…æ€»é‡ï¼Œå•ä½G"><a href="#æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶çš„å®é™…æ€»é‡ï¼Œå•ä½G" class="headerlink" title="æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶çš„å®é™…æ€»é‡ï¼Œå•ä½G"></a>æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶çš„å®é™…æ€»é‡ï¼Œå•ä½G</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.datafile_size+b.tempfile_size-c.free_size</span><br><span class="line">FROM </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) datafile_size</span><br><span class="line">    FROM dba_data_files ) a, </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) tempfile_size</span><br><span class="line">    FROM dba_temp_files ) b, </span><br><span class="line">    (SELECT sum(bytes/1024/1024/1024) free_size</span><br><span class="line">    FROM dba_free_space ) c</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹è¡¨ç©ºé—´å¯ç”¨ç™¾åˆ†æ¯”ï¼ˆ-dba-free-spaceä¸ä¼šåŒ…å«æ‰€æœ‰tablespaceï¼Œå¦‚æœä¸€ä¸ªè¡¨ç©ºé—´çš„æ•°æ®æ–‡ä»¶éƒ½æ»¡äº†ï¼Œåˆ™è¿™ä¸ªè¡¨ç©ºé—´ä¸ä¼šå‡ºç°åœ¨dba-free-spaceä¸­-ï¼‰"><a href="#æŸ¥çœ‹è¡¨ç©ºé—´å¯ç”¨ç™¾åˆ†æ¯”ï¼ˆ-dba-free-spaceä¸ä¼šåŒ…å«æ‰€æœ‰tablespaceï¼Œå¦‚æœä¸€ä¸ªè¡¨ç©ºé—´çš„æ•°æ®æ–‡ä»¶éƒ½æ»¡äº†ï¼Œåˆ™è¿™ä¸ªè¡¨ç©ºé—´ä¸ä¼šå‡ºç°åœ¨dba-free-spaceä¸­-ï¼‰" class="headerlink" title="æŸ¥çœ‹è¡¨ç©ºé—´å¯ç”¨ç™¾åˆ†æ¯”ï¼ˆ dba_free_spaceä¸ä¼šåŒ…å«æ‰€æœ‰tablespaceï¼Œå¦‚æœä¸€ä¸ªè¡¨ç©ºé—´çš„æ•°æ®æ–‡ä»¶éƒ½æ»¡äº†ï¼Œåˆ™è¿™ä¸ªè¡¨ç©ºé—´ä¸ä¼šå‡ºç°åœ¨dba_free_spaceä¸­ ï¼‰"></a>æŸ¥çœ‹è¡¨ç©ºé—´å¯ç”¨ç™¾åˆ†æ¯”ï¼ˆ dba_free_spaceä¸ä¼šåŒ…å«æ‰€æœ‰tablespaceï¼Œå¦‚æœä¸€ä¸ªè¡¨ç©ºé—´çš„æ•°æ®æ–‡ä»¶éƒ½æ»¡äº†ï¼Œåˆ™è¿™ä¸ªè¡¨ç©ºé—´ä¸ä¼šå‡ºç°åœ¨dba_free_spaceä¸­ ï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.tablespace_name,</span><br><span class="line">        a.maxsize max_M,</span><br><span class="line">        a.total total_M,</span><br><span class="line">        b.free free_M,</span><br><span class="line">        round((b.free/a.total)*100) <span class="string">"% Free"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         sum(bytes/(1024*1024)) total ,</span><br><span class="line">        sum(MAXBYTES/(1024*1024)) maxsize</span><br><span class="line">    FROM dba_data_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         round(sum(bytes/(1024*1024))) free</span><br><span class="line">    FROM dba_free_space</span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">ORDER BY  <span class="string">"% Free"</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>å¦‚ä¸‹ä¸ºæ ‡å‡†ç‰ˆ <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.tablespace_name,</span><br><span class="line">        a.maxsize max_M,</span><br><span class="line">        a.total total_M,</span><br><span class="line">        b.free free_M,</span><br><span class="line">        round(((a.maxsize+b.free-a.total)/a.maxsize)*100) <span class="string">"% Free"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         sum(bytes/(1024*1024)) total ,</span><br><span class="line">        sum((decode(AUTOEXTENSIBLE,</span><br><span class="line">        <span class="string">'NO'</span>,BYTES,MAXBYTES))/(1024*1024)) maxsize</span><br><span class="line">    FROM dba_data_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         round(sum(bytes/(1024*1024))) free</span><br><span class="line">    FROM dba_free_space</span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">ORDER BY  <span class="string">"% Free"</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="æŸ¥çœ‹ä¸´æ—¶è¡¨ç©ºé—´ä½¿ç”¨ç‡"><a href="#æŸ¥çœ‹ä¸´æ—¶è¡¨ç©ºé—´ä½¿ç”¨ç‡" class="headerlink" title="æŸ¥çœ‹ä¸´æ—¶è¡¨ç©ºé—´ä½¿ç”¨ç‡"></a>æŸ¥çœ‹ä¸´æ—¶è¡¨ç©ºé—´ä½¿ç”¨ç‡</h4><h5 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT temp_used.tablespace_name,</span><br><span class="line">        round(total),</span><br><span class="line">        used,</span><br><span class="line">         round(total - used) AS <span class="string">"Free"</span>,</span><br><span class="line">         round(nvl(total-used,</span><br><span class="line">         0) * 100/total,</span><br><span class="line">        1) <span class="string">"Free percent"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM(bytes_used)/1024/1024 used</span><br><span class="line">    FROM GV<span class="variable">$TEMP_SPACE_HEADER</span></span><br><span class="line">    GROUP BY  tablespace_name) temp_used, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM(decode(autoextensible,</span><br><span class="line">        <span class="string">'YES'</span>,MAXBYTES,bytes))/1024/1024 total</span><br><span class="line">    FROM dba_temp_files</span><br><span class="line">    GROUP BY  tablespace_name) temp_total</span><br><span class="line">WHERE temp_used.tablespace_name = temp_total.tablespace_name</span><br></pre></td></tr></tbody></table></figure><h5 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.tablespace_name,</span><br><span class="line">         round(a.BYTES/1024/1024) total_M,</span><br><span class="line">         round(a.bytes/1024/1024 - nvl(b.bytes/1024/1024,</span><br><span class="line">         0)) free_M,</span><br><span class="line">         round(b.bytes/1024/1024) used,</span><br><span class="line">        round(b.using/1024/1024) using</span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM (decode(autoextensible,</span><br><span class="line">        <span class="string">'YES'</span>,MAXBYTES,bytes)) bytes</span><br><span class="line">    FROM dba_temp_files</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         SUM (bytes_cached) bytes,</span><br><span class="line">        sum(bytes_used) using</span><br><span class="line">    FROM v<span class="variable">$temp_extent_pool</span></span><br><span class="line">    GROUP BY  tablespace_name) b</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name(+)</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢undoè¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ"><a href="#æŸ¥è¯¢undoè¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ" class="headerlink" title="æŸ¥è¯¢undoè¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ"></a>æŸ¥è¯¢undoè¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT tablespace_name,</span><br><span class="line">        status,</span><br><span class="line">        sum(bytes)/1024/1024 M</span><br><span class="line">FROM dba_undo_extents</span><br><span class="line">GROUP BY  tablespace_name,status</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢ä½¿ç”¨undoæ¯”è¾ƒå¤šçš„SQL"><a href="#æŸ¥è¯¢ä½¿ç”¨undoæ¯”è¾ƒå¤šçš„SQL" class="headerlink" title="æŸ¥è¯¢ä½¿ç”¨undoæ¯”è¾ƒå¤šçš„SQL"></a>æŸ¥è¯¢ä½¿ç”¨undoæ¯”è¾ƒå¤šçš„SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT *from </span><br><span class="line">    (SELECT maxqueryid,</span><br><span class="line">         round(sum(undoblks )*8/1024) consumed_size_MB</span><br><span class="line">    FROM v<span class="variable">$undostat</span></span><br><span class="line">    GROUP BY  maxqueryid</span><br><span class="line">    ORDER BY  consumed_size_MB DESC )</span><br><span class="line">WHERE rownum<10;</span><br></pre></td></tr></tbody></table></figure><h4 id="ä¼°è®¡undoéœ€è¦å¤šå¤§"><a href="#ä¼°è®¡undoéœ€è¦å¤šå¤§" class="headerlink" title="ä¼°è®¡undoéœ€è¦å¤šå¤§"></a>ä¼°è®¡undoéœ€è¦å¤šå¤§</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT (UR * (UPS * DBS)) AS <span class="string">"Bytes"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT max(tuned_undoretention) AS UR</span><br><span class="line">    FROM v<span class="variable">$undostat</span>), </span><br><span class="line">    (SELECT undoblks/((end_time-begin_time)*86400) AS UPS</span><br><span class="line">    FROM v<span class="variable">$undostat</span></span><br><span class="line">    WHERE undoblks = </span><br><span class="line">        (SELECT MAX(undoblks)</span><br><span class="line">        FROM v<span class="variable">$undostat</span>)), </span><br><span class="line">        (SELECT block_size AS DBS</span><br><span class="line">        FROM dba_tablespaces</span><br><span class="line">        WHERE tablespace_name = </span><br><span class="line">            (SELECT UPPER(value)</span><br><span class="line">            FROM v<span class="variable">$parameter</span></span><br><span class="line">            WHERE name = <span class="string">'undo_tablespace'</span>));</span><br></pre></td></tr></tbody></table></figure><h4 id="äº§ç”Ÿundoçš„å½“å‰æ´»åŠ¨ä¼šè¯æ˜¯å“ªäº›"><a href="#äº§ç”Ÿundoçš„å½“å‰æ´»åŠ¨ä¼šè¯æ˜¯å“ªäº›" class="headerlink" title="äº§ç”Ÿundoçš„å½“å‰æ´»åŠ¨ä¼šè¯æ˜¯å“ªäº›"></a>äº§ç”Ÿundoçš„å½“å‰æ´»åŠ¨ä¼šè¯æ˜¯å“ªäº›</h4><h5 id="æ–¹æ³•ä¸€-1"><a href="#æ–¹æ³•ä¸€-1" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.inst_id,</span><br><span class="line">         a.sid,</span><br><span class="line">         c.username,</span><br><span class="line">         c.osuser,</span><br><span class="line">         c.program,</span><br><span class="line">         b.name,</span><br><span class="line">         a.value,</span><br><span class="line">         d.used_urec,</span><br><span class="line">         d.used_ublk</span><br><span class="line">FROM gv<span class="variable">$sesstat</span> a, v<span class="variable">$statname</span> b, gv<span class="variable">$session</span> c, gv<span class="variable">$transaction</span> d</span><br><span class="line">WHERE a.statistic<span class="comment"># = b.statistic#</span></span><br><span class="line">        AND a.inst_id = c.inst_id</span><br><span class="line">        AND a.sid = c.sid</span><br><span class="line">        AND c.inst_id = d.inst_id</span><br><span class="line">        AND c.saddr = d.ses_addr</span><br><span class="line">        AND b.name = <span class="string">'undo change vector size'</span></span><br><span class="line">        AND a.value>0</span><br><span class="line">ORDER BY  a.value DESC</span><br></pre></td></tr></tbody></table></figure><h5 id="æ–¹æ³•äºŒ-1"><a href="#æ–¹æ³•äºŒ-1" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.sql_id,</span><br><span class="line">        v.usn,</span><br><span class="line">        r.status,</span><br><span class="line">         v.rssize/1024/1024 mb</span><br><span class="line">FROM dba_rollback_segs r, v<span class="variable">$rollstat</span> v,v<span class="variable">$transaction</span> t,v<span class="variable">$session</span> s</span><br><span class="line">WHERE r.segment_id = v.usn</span><br><span class="line">        AND v.usn=t.xidusn</span><br><span class="line">        AND t.addr=s.taddr</span><br><span class="line">ORDER BY  6 desc;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹ASMç£ç›˜ç»„ä½¿ç”¨ç‡"><a href="#æŸ¥çœ‹ASMç£ç›˜ç»„ä½¿ç”¨ç‡" class="headerlink" title="æŸ¥çœ‹ASMç£ç›˜ç»„ä½¿ç”¨ç‡"></a>æŸ¥çœ‹ASMç£ç›˜ç»„ä½¿ç”¨ç‡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT name,</span><br><span class="line">        round(total_mb/1024) <span class="string">"æ€»å®¹é‡"</span>,</span><br><span class="line">        round(free_mb/1024) <span class="string">"ç©ºé—²ç©ºé—´"</span>,</span><br><span class="line">        round((free_mb/total_mb)*100) <span class="string">"å¯ç”¨ç©ºé—´æ¯”ä¾‹"</span></span><br><span class="line">FROM gv<span class="variable">$asm_diskgroup</span></span><br></pre></td></tr></tbody></table></figure><h4 id="ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´ç‡"><a href="#ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´ç‡" class="headerlink" title="ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´ç‡"></a>ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´ç‡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SELECT c.owner <span class="string">"ç”¨æˆ·"</span>,</span><br><span class="line">         a.tablespace_name <span class="string">"è¡¨ç©ºé—´å"</span>,</span><br><span class="line">         total/1024/1024 <span class="string">"è¡¨ç©ºé—´å¤§å°M"</span>,</span><br><span class="line">         free/1024/1024 <span class="string">"è¡¨ç©ºé—´å‰©ä½™å¤§å°M"</span>,</span><br><span class="line">         ( total - free )/1024/1024 <span class="string">"è¡¨ç©ºé—´ä½¿ç”¨å¤§å°M"</span>,</span><br><span class="line">         Round(( total - free ) / total,</span><br><span class="line">         4) * 100 <span class="string">"è¡¨ç©ºé—´æ€»è®¡ä½¿ç”¨ç‡ %"</span>,</span><br><span class="line">         c.schemas_use/1024/1024 <span class="string">"ç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´å¤§å°M"</span>,</span><br><span class="line">         round((schemas_use)/total,</span><br><span class="line">        4)*100 <span class="string">"ç”¨æˆ·ä½¿ç”¨è¡¨ç©ºé—´ç‡ %"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         Sum(bytes) free</span><br><span class="line">    FROM DBA_FREE_SPACE</span><br><span class="line">    GROUP BY  tablespace_name) a, </span><br><span class="line">    (SELECT tablespace_name,</span><br><span class="line">         Sum(bytes) total</span><br><span class="line">    FROM DBA_DATA_FILES</span><br><span class="line">    GROUP BY  tablespace_name) b, </span><br><span class="line">    (SELECT owner ,</span><br><span class="line">        Tablespace_Name,</span><br><span class="line">         Sum(bytes) schemas_use</span><br><span class="line">    FROM Dba_Segments</span><br><span class="line">    GROUP BY  owner,Tablespace_Name) c</span><br><span class="line">WHERE a.tablespace_name = b.tablespace_name</span><br><span class="line">        AND a.tablespace_name =c.Tablespace_Name</span><br><span class="line">ORDER BY  <span class="string">"ç”¨æˆ·"</span>,<span class="string">"è¡¨ç©ºé—´å"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹é—ªå›åŒº-å¿«é€Ÿæ¢å¤åŒºç©ºé—´ä½¿ç”¨ç‡"><a href="#æŸ¥çœ‹é—ªå›åŒº-å¿«é€Ÿæ¢å¤åŒºç©ºé—´ä½¿ç”¨ç‡" class="headerlink" title="æŸ¥çœ‹é—ªå›åŒº\å¿«é€Ÿæ¢å¤åŒºç©ºé—´ä½¿ç”¨ç‡"></a>æŸ¥çœ‹é—ªå›åŒº\å¿«é€Ÿæ¢å¤åŒºç©ºé—´ä½¿ç”¨ç‡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT sum(percent_space_used)||<span class="string">'%'</span> <span class="string">"å·²ä½¿ç”¨ç©ºé—´æ¯”ä¾‹"</span></span><br><span class="line">FROM V<span class="variable">$RECOVERY_AREA_USAGE</span> </span><br><span class="line"></span><br><span class="line">æˆ–</span><br><span class="line"></span><br><span class="line">SELECT round(100*(a.space_used/space_limit),</span><br><span class="line">        2)||<span class="string">'%'</span> <span class="string">"å·²ä½¿ç”¨ç©ºé—´æ¯”ä¾‹"</span>,a.*</span><br><span class="line">FROM v<span class="variable">$recovery_file_dest</span> a;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹åƒµæ­»è¿›ç¨‹ï¼Œåˆ†ä¸¤ç§ï¼ˆä¸€ç§æ˜¯ä¼šè¯ä¸åœ¨çš„ï¼Œå¦ä¸€ç§æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilledçš„ä½†æ˜¯ä¼šè¯è¿˜åœ¨çš„ï¼‰"><a href="#æŸ¥çœ‹åƒµæ­»è¿›ç¨‹ï¼Œåˆ†ä¸¤ç§ï¼ˆä¸€ç§æ˜¯ä¼šè¯ä¸åœ¨çš„ï¼Œå¦ä¸€ç§æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilledçš„ä½†æ˜¯ä¼šè¯è¿˜åœ¨çš„ï¼‰" class="headerlink" title="æŸ¥çœ‹åƒµæ­»è¿›ç¨‹ï¼Œåˆ†ä¸¤ç§ï¼ˆä¸€ç§æ˜¯ä¼šè¯ä¸åœ¨çš„ï¼Œå¦ä¸€ç§æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilledçš„ä½†æ˜¯ä¼šè¯è¿˜åœ¨çš„ï¼‰"></a>æŸ¥çœ‹åƒµæ­»è¿›ç¨‹ï¼Œåˆ†ä¸¤ç§ï¼ˆä¸€ç§æ˜¯ä¼šè¯ä¸åœ¨çš„ï¼Œå¦ä¸€ç§æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilledçš„ä½†æ˜¯ä¼šè¯è¿˜åœ¨çš„ï¼‰</h4><p><code>alter system kill session</code>ä¸€æ‰§è¡Œåˆ™<code>session</code>å³æ ‡è®°ä¸º<code>KILLED</code>ï¼Œä½†æ˜¯å¦‚æœä¼šè¯äº§ç”Ÿçš„æ•°æ®é‡å¤§åˆ™è¿™ä¸ªkillå¯èƒ½ä¼šæ¯”è¾ƒä¹…ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­sessionæ ‡è®°ä¸ºKILLEDä½†æ˜¯è¿™ä¸ªä¼šè¯è¿˜åœ¨<code>V$session</code>ä¸­ï¼Œåˆ™<code>V$session.paddr</code>è¿˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥åŒ¹é…åˆ°<code>V$process.addr</code>ï¼Œæ‰€ä»¥processè¿›ç¨‹è¿˜åœ¨ï¼›å½“killè¿‡ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™è¿™ä¸ªä¼šè¯å³ä¸åœ¨<code>V$session</code>ä¸­</p><h5 id="ä¼šè¯ä¸åœ¨çš„"><a href="#ä¼šè¯ä¸åœ¨çš„" class="headerlink" title="ä¼šè¯ä¸åœ¨çš„"></a>ä¼šè¯ä¸åœ¨çš„</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$process</span></span><br><span class="line">WHERE addr NOT IN </span><br><span class="line">    (SELECT paddr</span><br><span class="line">    FROM v<span class="variable">$session</span>)</span><br><span class="line">        AND pid NOT IN (1,17,18)</span><br></pre></td></tr></tbody></table></figure><h5 id="ä¼šè¯è¿˜åœ¨çš„ï¼Œä½†æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilled"><a href="#ä¼šè¯è¿˜åœ¨çš„ï¼Œä½†æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilled" class="headerlink" title="ä¼šè¯è¿˜åœ¨çš„ï¼Œä½†æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilled"></a>ä¼šè¯è¿˜åœ¨çš„ï¼Œä½†æ˜¯ä¼šè¯æ ‡è®°ä¸ºkilled</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$process</span></span><br><span class="line">WHERE addr IN </span><br><span class="line">    (SELECT paddr</span><br><span class="line">    FROM v<span class="variable">$session</span></span><br><span class="line">    WHERE status=<span class="string">'KILLED'</span>)</span><br></pre></td></tr></tbody></table></figure><p>å†æ ¹æ®ä¸Šè¿°ç»“æœä¸­çš„SPIDé€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°processçš„å¯åŠ¨æ—¶é—´<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|grep SPID</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥çœ‹è¡Œè¿ç§»æˆ–è¡Œé“¾æ¥çš„è¡¨"><a href="#æŸ¥çœ‹è¡Œè¿ç§»æˆ–è¡Œé“¾æ¥çš„è¡¨" class="headerlink" title="æŸ¥çœ‹è¡Œè¿ç§»æˆ–è¡Œé“¾æ¥çš„è¡¨"></a>æŸ¥çœ‹è¡Œè¿ç§»æˆ–è¡Œé“¾æ¥çš„è¡¨</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_tables</span><br><span class="line">WHERE nvl(chain_cnt,0)<>0 chain_cnt ï¼šNumber of rows IN the table that are chained</span><br><span class="line">FROM one data block to another</span><br><span class="line">        OR that have migrated to a new block, requiring a link to preserve the old rowid. This column is updated only after you analyze the table.</span><br></pre></td></tr></tbody></table></figure><h4 id="æ•°æ®ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§db-cache-sizeï¼‰"><a href="#æ•°æ®ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§db-cache-sizeï¼‰" class="headerlink" title="æ•°æ®ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§db_cache_sizeï¼‰"></a>æ•°æ®ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§db_cache_sizeï¼‰</h4><h5 id="æ–¹æ³•ä¸€-2"><a href="#æ–¹æ³•ä¸€-2" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.VALUE+b.VALUE logical_reads,</span><br><span class="line">         c.VALUE phys_reads,</span><br><span class="line">         round(100*(1-c.value/(a.value+b.value)),</span><br><span class="line">        2)||<span class="string">'%'</span> hit_ratio</span><br><span class="line">FROM v<span class="variable">$sysstat</span> a,v<span class="variable">$sysstat</span> b,v<span class="variable">$sysstat</span> c</span><br><span class="line">WHERE a.NAME=<span class="string">'db block gets'</span></span><br><span class="line">        AND b.NAME=<span class="string">'consistent gets'</span></span><br><span class="line">        AND c.NAME=<span class="string">'physical reads'</span>;</span><br></pre></td></tr></tbody></table></figure><h5 id="æ–¹æ³•äºŒ-2"><a href="#æ–¹æ³•äºŒ-2" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT DB_BLOCK_GETS+CONSISTENT_GETS Logical_reads,</span><br><span class="line">        PHYSICAL_READS phys_reads,</span><br><span class="line">         round(100*(1-(PHYSICAL_READS/(DB_BLOCK_GETS+CONSISTENT_GETS))),</span><br><span class="line">        2)||<span class="string">'%'</span> <span class="string">"Hit Ratio"</span></span><br><span class="line">FROM V<span class="variable">$BUFFER_POOL_STATISTICS</span></span><br><span class="line">WHERE NAME=<span class="string">'DEFAULT'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="å…±äº«æ± å‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§shared-pool-sizeï¼‰"><a href="#å…±äº«æ± å‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§shared-pool-sizeï¼‰" class="headerlink" title="å…±äº«æ± å‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§shared_pool_sizeï¼‰"></a>å…±äº«æ± å‘½ä¸­ç‡ï¼ˆç™¾åˆ†æ¯”å°äº90å°±è¦åŠ å¤§shared_pool_sizeï¼‰</h4><p>ä»¥ä¸‹ä¸¤è€…å¯ä»¥æ ¹æ®ä¸ªäººç†è§£è¿ç”¨<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT sum(pinhits)/sum(pins)*100</span><br><span class="line">FROM v<span class="variable">$librarycache</span>;</span><br><span class="line"></span><br><span class="line">SELECT sum(pinhits-reloads)/sum(pins)*100</span><br><span class="line">FROM v<span class="variable">$librarycache</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥è¯¢å½’æ¡£æ—¥å¿—åˆ‡æ¢é¢‘ç‡"><a href="#æŸ¥è¯¢å½’æ¡£æ—¥å¿—åˆ‡æ¢é¢‘ç‡" class="headerlink" title="æŸ¥è¯¢å½’æ¡£æ—¥å¿—åˆ‡æ¢é¢‘ç‡"></a>æŸ¥è¯¢å½’æ¡£æ—¥å¿—åˆ‡æ¢é¢‘ç‡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SELECT sequence<span class="comment">#,</span></span><br><span class="line">        to_char(first_time,</span><br><span class="line">        <span class="string">'yyyymmdd_hh24:mi:ss'</span>) firsttime,round((first_time-lag(first_time) over(order by first_time))*24*60,2) minutes</span><br><span class="line">FROM v<span class="variable">$log_history</span></span><br><span class="line">WHERE first_time > sysdate - 3</span><br><span class="line">ORDER BY  first_time,</span><br><span class="line">        minutes; </span><br><span class="line"></span><br><span class="line">æˆ–</span><br><span class="line">SELECT sequence<span class="comment">#,</span></span><br><span class="line">        to_char(first_time,</span><br><span class="line">        <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) First_time,First_change<span class="comment">#,switch_change#</span></span><br><span class="line">FROM v<span class="variable">$loghist</span></span><br><span class="line">WHERE first_time>sysdate-3</span><br><span class="line">ORDER BY  1;</span><br><span class="line"></span><br><span class="line">æˆ–</span><br><span class="line">SELECT TO_CHAR(first_time,</span><br><span class="line">         <span class="string">'MM/DD'</span>) DAY, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'00'</span>, 1, 0)) H00, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'01'</span>, 1, 0)) H01, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'02'</span>, 1, 0)) H02, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'03'</span>, 1, 0)) H03, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'04'</span>, 1, 0)) H04, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'05'</span>, 1, 0)) H05, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'06'</span>, 1, 0)) H06, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'07'</span>, 1, 0)) H07, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'08'</span>, 1, 0)) H08, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'09'</span>, 1, 0)) H09, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'10'</span>, 1, 0)) H10, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'11'</span>, 1, 0)) H11, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'12'</span>, 1, 0)) H12, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'13'</span>, 1, 0)) H13, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'14'</span>, 1, 0)) H14, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'15'</span>, 1, 0)) H15, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'16'</span>, 1, 0)) H16, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'17'</span>, 1, 0)) H17, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'18'</span>, 1, 0)) H18, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'19'</span>, 1, 0)) H19, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'20'</span>, 1, 0)) H20, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'21'</span>, 1, 0)) H21, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'22'</span>, 1, 0)) H22, SUM(DECODE(TO_CHAR(first_time, <span class="string">'HH24'</span>), <span class="string">'23'</span>, 1, 0)) H23, COUNT(*) TOTAL</span><br><span class="line">FROM </span><br><span class="line">    (SELECT ROWNUM RN,</span><br><span class="line">         FIRST_TIME</span><br><span class="line">    FROM V<span class="variable">$LOG_HISTORY</span></span><br><span class="line">    WHERE first_time>sysdate-18</span><br><span class="line">            AND FIRST_TIME>ADD_MONTHS(SYSDATE,-1)</span><br><span class="line">    ORDER BY  FIRST_TIME)</span><br><span class="line">GROUP BY  TO_CHAR(first_time, <span class="string">'MM/DD'</span>)</span><br><span class="line">ORDER BY  MIN(RN);</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢lgwrè¿›ç¨‹å†™æ—¥å¿—æ—¶æ¯æ‰§è¡Œä¸€æ¬¡lgwréœ€è¦å¤šå°‘ç§’ï¼Œåœ¨stateæ˜¯waitingçš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç­‰å¾…ç¼–å·seq-ä¸‹ï¼Œseconds-in-waitè¾¾å¤šå°‘ç§’ï¼Œå°±æ˜¯lgwrè¿›ç¨‹å†™ä¸€æ¬¡IOéœ€è¦å¤šå°‘ç§’"><a href="#æŸ¥è¯¢lgwrè¿›ç¨‹å†™æ—¥å¿—æ—¶æ¯æ‰§è¡Œä¸€æ¬¡lgwréœ€è¦å¤šå°‘ç§’ï¼Œåœ¨stateæ˜¯waitingçš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç­‰å¾…ç¼–å·seq-ä¸‹ï¼Œseconds-in-waitè¾¾å¤šå°‘ç§’ï¼Œå°±æ˜¯lgwrè¿›ç¨‹å†™ä¸€æ¬¡IOéœ€è¦å¤šå°‘ç§’" class="headerlink" title="æŸ¥è¯¢lgwrè¿›ç¨‹å†™æ—¥å¿—æ—¶æ¯æ‰§è¡Œä¸€æ¬¡lgwréœ€è¦å¤šå°‘ç§’ï¼Œåœ¨stateæ˜¯waitingçš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç­‰å¾…ç¼–å·seq#ä¸‹ï¼Œseconds_in_waitè¾¾å¤šå°‘ç§’ï¼Œå°±æ˜¯lgwrè¿›ç¨‹å†™ä¸€æ¬¡IOéœ€è¦å¤šå°‘ç§’"></a>æŸ¥è¯¢lgwrè¿›ç¨‹å†™æ—¥å¿—æ—¶æ¯æ‰§è¡Œä¸€æ¬¡lgwréœ€è¦å¤šå°‘ç§’ï¼Œåœ¨stateæ˜¯waitingçš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç­‰å¾…ç¼–å·seq#ä¸‹ï¼Œseconds_in_waitè¾¾å¤šå°‘ç§’ï¼Œå°±æ˜¯lgwrè¿›ç¨‹å†™ä¸€æ¬¡IOéœ€è¦å¤šå°‘ç§’</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT event,</span><br><span class="line">        state,</span><br><span class="line">        seq<span class="comment">#,</span></span><br><span class="line">        seconds_in_wait,</span><br><span class="line">        program</span><br><span class="line">FROM v<span class="variable">$session</span></span><br><span class="line">WHERE program LIKE <span class="string">'%LGWR%'</span></span><br><span class="line">        AND state=<span class="string">'WAITING'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ²¡æœ‰ç´¢å¼•çš„è¡¨"><a href="#æŸ¥è¯¢æ²¡æœ‰ç´¢å¼•çš„è¡¨" class="headerlink" title="æŸ¥è¯¢æ²¡æœ‰ç´¢å¼•çš„è¡¨"></a>æŸ¥è¯¢æ²¡æœ‰ç´¢å¼•çš„è¡¨</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT table_name</span><br><span class="line">FROM user_tables</span><br><span class="line">WHERE table_name NOT IN </span><br><span class="line">    (SELECT table_name</span><br><span class="line">    FROM user_indexes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT table_name</span><br><span class="line">FROM user_tables</span><br><span class="line">WHERE table_name NOT IN </span><br><span class="line">    (SELECT table_name</span><br><span class="line">    FROM user_ind_columns)</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢ä¸€ä¸ªAWRå‘¨æœŸå†…çš„å¹³å‡sessionæ•°ã€OSå¹³å‡è´Ÿè½½ã€å¹³å‡db-timeã€å¹³å‡æ¯ç§’å¤šå°‘äº‹åŠ¡"><a href="#æŸ¥è¯¢ä¸€ä¸ªAWRå‘¨æœŸå†…çš„å¹³å‡sessionæ•°ã€OSå¹³å‡è´Ÿè½½ã€å¹³å‡db-timeã€å¹³å‡æ¯ç§’å¤šå°‘äº‹åŠ¡" class="headerlink" title="æŸ¥è¯¢ä¸€ä¸ªAWRå‘¨æœŸå†…çš„å¹³å‡sessionæ•°ã€OSå¹³å‡è´Ÿè½½ã€å¹³å‡db timeã€å¹³å‡æ¯ç§’å¤šå°‘äº‹åŠ¡"></a>æŸ¥è¯¢ä¸€ä¸ªAWRå‘¨æœŸå†…çš„å¹³å‡sessionæ•°ã€OSå¹³å‡è´Ÿè½½ã€å¹³å‡db timeã€å¹³å‡æ¯ç§’å¤šå°‘äº‹åŠ¡</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT to_char(max(BEGIN_TIME),</span><br><span class="line">        <span class="string">'yyyy-mm-dd hh24:mi'</span>)||to_char(max(end_time),<span class="string">'* hh24:mi'</span>) time, snap_id, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Session Count'</span> THEN</span><br><span class="line">    average end),2) sessions, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Current OS Load'</span> THEN</span><br><span class="line">    average end),2) OS_LOAD, (trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'Database Time Per Sec'</span> THEN</span><br><span class="line">    average end),2)/100)*(ceil((max(end_time)-max(BEGIN_TIME))*24*60*60)) Database_Time_second, trunc(sum(<span class="keyword">case</span> metric_name</span><br><span class="line">    WHEN <span class="string">'User Transaction Per Sec'</span> THEN</span><br><span class="line">    average end),2) User_Transaction_Per_Sec</span><br><span class="line">FROM dba_hist_sysmetric_summary</span><br><span class="line">GROUP BY  snap_id</span><br><span class="line">ORDER BY  snap_id;</span><br></pre></td></tr></tbody></table></figure><ul><li>Database Time Per Secå¯¹åº”å€¼çš„å•ä½æ˜¯ç™¾åˆ†ä¸€ç§’/æ¯ç§’ </li><li>(/100)<em>(ceil((max(end_time)-max(BEGIN_TIME))</em>24<em>60</em>60))æ˜¯ä»£è¡¨æ¯ä¸ªsnapå‘¨æœŸå†…çš„æ€»ç§’æ•°ï¼Œoracle ä¸¤ä¸ªæ—¶é—´ç›¸å‡é»˜è®¤çš„æ˜¯å¤©æ•°,<em>24</em>60*60 ä¸ºç›¸å·®çš„ç§’æ•° </li><li>è¿™ä¸ªSQLæŸ¥åˆ°çš„DB TIMEæ¯”è¾ƒå‡†ç¡®ï¼Œå’Œawrä¸Šé¢çš„db timeæ¯”è¾ƒä¸€è‡´ </li></ul><h4 id="æŸ¥è¯¢äº§ç”Ÿçƒ­å—è¾ƒå¤šçš„å¯¹è±¡"><a href="#æŸ¥è¯¢äº§ç”Ÿçƒ­å—è¾ƒå¤šçš„å¯¹è±¡" class="headerlink" title="æŸ¥è¯¢äº§ç”Ÿçƒ­å—è¾ƒå¤šçš„å¯¹è±¡"></a>æŸ¥è¯¢äº§ç”Ÿçƒ­å—è¾ƒå¤šçš„å¯¹è±¡</h4><p>x$bh .tch(Touch)è¡¨ç¤ºè®¿é—®æ¬¡æ•°è¶Šé«˜ï¼Œçƒ­ç‚¹å¿«ç«äº‰é—®é¢˜å°±å­˜åœ¨<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT e.owner,</span><br><span class="line">         e.segment_name,</span><br><span class="line">         e.segment_type</span><br><span class="line">FROM dba_extents e, </span><br><span class="line">    (SELECT *</span><br><span class="line">    FROM </span><br><span class="line">        (SELECT addr,</span><br><span class="line">        ts<span class="comment">#,</span></span><br><span class="line">        file<span class="comment">#,</span></span><br><span class="line">        dbarfil,</span><br><span class="line">        dbablk,</span><br><span class="line">        tch</span><br><span class="line">        FROM x<span class="variable">$bh</span></span><br><span class="line">        ORDER BY  tch DESC)</span><br><span class="line">        WHERE ROWNUM < 11) b</span><br><span class="line">    WHERE e.relative_fno = b.dbarfil</span><br><span class="line">        AND e.block_id <= b.dbablk</span><br><span class="line">        AND e.block_id + e.blocks > b.dbablk;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æ‰‹å·¥åˆ›å»ºå¿«ç…§çš„è¯­å¥"><a href="#æ‰‹å·¥åˆ›å»ºå¿«ç…§çš„è¯­å¥" class="headerlink" title="æ‰‹å·¥åˆ›å»ºå¿«ç…§çš„è¯­å¥"></a>æ‰‹å·¥åˆ›å»ºå¿«ç…§çš„è¯­å¥</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> dbms_workload_repository.create_snapshot;</span><br></pre></td></tr></tbody></table></figure><h4 id="AWRè®¾ç½®æ¯éš”30åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡æŠ¥å‘Šï¼Œä¿ç•™14å¤©çš„æŠ¥å‘Š"><a href="#AWRè®¾ç½®æ¯éš”30åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡æŠ¥å‘Šï¼Œä¿ç•™14å¤©çš„æŠ¥å‘Š" class="headerlink" title="AWRè®¾ç½®æ¯éš”30åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡æŠ¥å‘Šï¼Œä¿ç•™14å¤©çš„æŠ¥å‘Š"></a>AWRè®¾ç½®æ¯éš”30åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡æŠ¥å‘Šï¼Œä¿ç•™14å¤©çš„æŠ¥å‘Š</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(retention=>14*24*60, interval=>30); </span><br><span class="line"></span><br><span class="line">select * from dba_hist_wr_control;</span><br></pre></td></tr></tbody></table></figure><h4 id="AWRåŸºçº¿æŸ¥çœ‹å’Œåˆ›å»º"><a href="#AWRåŸºçº¿æŸ¥çœ‹å’Œåˆ›å»º" class="headerlink" title="AWRåŸºçº¿æŸ¥çœ‹å’Œåˆ›å»º"></a>AWRåŸºçº¿æŸ¥çœ‹å’Œåˆ›å»º</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from dba_hist_baseline; </span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE(start_snap_id=>7550,end_snap_id=>7660,baseline_name=><span class="string">'am_baseline'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="å¯¼å‡ºAWRæŠ¥å‘Šçš„SQLè¯­å¥"><a href="#å¯¼å‡ºAWRæŠ¥å‘Šçš„SQLè¯­å¥" class="headerlink" title="å¯¼å‡ºAWRæŠ¥å‘Šçš„SQLè¯­å¥"></a>å¯¼å‡ºAWRæŠ¥å‘Šçš„SQLè¯­å¥</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_hist_snapshot</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM table(dbms_workload_repository.awr_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid))</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM TABLE(DBMS_WORKLOAD_REPOSITORY.awr_diff_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid, DBID, INSTANCE_NUMBER, startsnapid,endsnapid));</span><br></pre></td></tr></tbody></table></figure><h4 id="å¯¼å‡ºæœ€æ–°ADDMçš„æŠ¥å‘Šï¼ˆéœ€è¦sysç”¨æˆ·ï¼‰"><a href="#å¯¼å‡ºæœ€æ–°ADDMçš„æŠ¥å‘Šï¼ˆéœ€è¦sysç”¨æˆ·ï¼‰" class="headerlink" title="å¯¼å‡ºæœ€æ–°ADDMçš„æŠ¥å‘Šï¼ˆéœ€è¦sysç”¨æˆ·ï¼‰"></a>å¯¼å‡ºæœ€æ–°ADDMçš„æŠ¥å‘Šï¼ˆéœ€è¦sysç”¨æˆ·ï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT dbms_advisor.get_task_report(task_name)</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">WHERE task_id =</span><br><span class="line">    (SELECT max(t.task_id)</span><br><span class="line">    FROM dba_advisor_tasks t, dba_advisor_log l</span><br><span class="line">    WHERE t.task_id=l.task_id</span><br><span class="line">            AND t.advisor_name=<span class="string">'ADDM'</span></span><br><span class="line">            AND l.status=<span class="string">'COMPLETED'</span> );SELECT task_id,</span><br><span class="line">        task_name,</span><br><span class="line">        description</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">ORDER BY  1 DESCSELECT dbms_advisor.get_task_report(task_name)</span><br><span class="line">FROM dba_advisor_tasks</span><br><span class="line">WHERE task_id =XX</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’"><a href="#æŸ¥è¯¢æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’" class="headerlink" title="æŸ¥è¯¢æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’"></a>æŸ¥è¯¢æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table(dbms_xplan.display_cursor(<span class="string">'sql_id'</span>,0,<span class="string">' advanced '</span>));</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„0è¡¨ç¤º<code>v$sql.child_number</code>ä¸º0ï¼Œå¦‚æœä¸€ä¸ªsql_idåœ¨v$sqlä¸­æœ‰å¤šè¡Œè¯´æ˜æœ‰å¤šä¸ªchild_numberï¼Œè¦çœ‹å“ªå„¿child_numberçš„æ‰§è¡Œè®¡åˆ’ï¼Œå°±å†™å“ªä¸ªçš„å€¼ï¼Œæ¯”å¦‚è¦çœ‹child_numberä¸º2çš„æ‰§è¡Œè®¡åˆ’ï¼Œå°±æŠŠä¸Šé¢sqlçš„0æ”¹ä¸º2 ã€‚</p><h4 id="å®˜æ–¹æ–‡æ¡£å¯¹display-cursorè¿™ä¸ªå‡½æ•°çš„è¯´æ˜é‡Œé¢æ²¡æœ‰advancedè¿™ä¸ªå‚æ•°å€¼ï¼Œåªæœ‰BASICã€TYPICALã€ALLè¿™å‡ ä¸ªï¼Œä¸è¿‡å®è·µä¸­å‘ç°advancedè¿™ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„å†…å®¹æ¯”è¿™å‡ ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„éƒ½å¤šã€‚"><a href="#å®˜æ–¹æ–‡æ¡£å¯¹display-cursorè¿™ä¸ªå‡½æ•°çš„è¯´æ˜é‡Œé¢æ²¡æœ‰advancedè¿™ä¸ªå‚æ•°å€¼ï¼Œåªæœ‰BASICã€TYPICALã€ALLè¿™å‡ ä¸ªï¼Œä¸è¿‡å®è·µä¸­å‘ç°advancedè¿™ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„å†…å®¹æ¯”è¿™å‡ ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„éƒ½å¤šã€‚" class="headerlink" title="å®˜æ–¹æ–‡æ¡£å¯¹display_cursorè¿™ä¸ªå‡½æ•°çš„è¯´æ˜é‡Œé¢æ²¡æœ‰advancedè¿™ä¸ªå‚æ•°å€¼ï¼Œåªæœ‰BASICã€TYPICALã€ALLè¿™å‡ ä¸ªï¼Œä¸è¿‡å®è·µä¸­å‘ç°advancedè¿™ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„å†…å®¹æ¯”è¿™å‡ ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„éƒ½å¤šã€‚"></a>å®˜æ–¹æ–‡æ¡£å¯¹display_cursorè¿™ä¸ªå‡½æ•°çš„è¯´æ˜é‡Œé¢æ²¡æœ‰advancedè¿™ä¸ªå‚æ•°å€¼ï¼Œåªæœ‰BASICã€TYPICALã€ALLè¿™å‡ ä¸ªï¼Œä¸è¿‡å®è·µä¸­å‘ç°advancedè¿™ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„å†…å®¹æ¯”è¿™å‡ ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„éƒ½å¤šã€‚</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM table(xplan.display_cursor(<span class="string">'v$sql.sql_id'</span>,0,<span class="string">'advanced'</span>));</span><br></pre></td></tr></tbody></table></figure><h4 id="åˆ›å»ºxplanåŒ…ï¼Œå†æ‰§è¡Œ"><a href="#åˆ›å»ºxplanåŒ…ï¼Œå†æ‰§è¡Œ" class="headerlink" title="åˆ›å»ºxplanåŒ…ï¼Œå†æ‰§è¡Œ"></a>åˆ›å»ºxplanåŒ…ï¼Œå†æ‰§è¡Œ</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL> CREATE PUBLIC SYNONYM XPLAN FOR SYS.XPLAN; </span><br><span class="line">SQL> grant execute on sys.xplan to public;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢Rmançš„é…ç½®ä¿¡æ¯"><a href="#æŸ¥è¯¢Rmançš„é…ç½®ä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢Rmançš„é…ç½®ä¿¡æ¯"></a>æŸ¥è¯¢Rmançš„é…ç½®ä¿¡æ¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT NAME,</span><br><span class="line">        VALUE</span><br><span class="line">FROM V<span class="variable">$RMAN_CONFIGURATION</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢Rmanå¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯ï¼ˆæœªè¿‡æœŸçš„ï¼Œè¿‡æœŸå¹¶å·²åˆ é™¤çš„æŸ¥ä¸åˆ°ï¼‰"><a href="#æŸ¥è¯¢Rmanå¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯ï¼ˆæœªè¿‡æœŸçš„ï¼Œè¿‡æœŸå¹¶å·²åˆ é™¤çš„æŸ¥ä¸åˆ°ï¼‰" class="headerlink" title="æŸ¥è¯¢Rmanå¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯ï¼ˆæœªè¿‡æœŸçš„ï¼Œè¿‡æœŸå¹¶å·²åˆ é™¤çš„æŸ¥ä¸åˆ°ï¼‰"></a>æŸ¥è¯¢Rmanå¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯ï¼ˆæœªè¿‡æœŸçš„ï¼Œè¿‡æœŸå¹¶å·²åˆ é™¤çš„æŸ¥ä¸åˆ°ï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT B.RECID BackupSet_ID,</span><br><span class="line">        </span><br><span class="line">         A.SET_STAMP,</span><br><span class="line">        </span><br><span class="line">         DECODE (B.INCREMENTAL_LEVEL,</span><br><span class="line">        </span><br><span class="line">         <span class="string">''</span>, DECODE (BACKUP_TYPE, <span class="string">'L'</span>, <span class="string">'Archivelog'</span>, <span class="string">'Full'</span>), 1, <span class="string">'Incr-1çº§'</span>, 0, <span class="string">'Incr-0çº§'</span>, B.INCREMENTAL_LEVEL) <span class="string">"Type LV"</span>, B.CONTROLFILE_INCLUDED <span class="string">"åŒ…å«CTL"</span>, DECODE (A.STATUS, <span class="string">'A'</span>, <span class="string">'AVAILABLE'</span>, <span class="string">'D'</span>, <span class="string">'DELETED'</span>, <span class="string">'X'</span>, <span class="string">'EXPIRED'</span>, <span class="string">'ERROR'</span>) <span class="string">"STATUS"</span>, A.DEVICE_TYPE <span class="string">"Device Type"</span>, A.START_TIME <span class="string">"Start Time"</span>, A.COMPLETION_TIME <span class="string">"Completion Time"</span>, A.ELAPSED_SECONDS <span class="string">"Elapsed Seconds"</span>, A.BYTES/1024/1024/1024 <span class="string">"Size(G)"</span>, A.COMPRESSED, A.TAG <span class="string">"Tag"</span>, A.HANDLE <span class="string">"Path"</span></span><br><span class="line">FROM GV<span class="variable">$BACKUP_PIECE</span> A,</span><br><span class="line">         GV<span class="variable">$BACKUP_SET</span> B</span><br><span class="line">WHERE A.SET_STAMP = B.SET_STAMP</span><br><span class="line">        AND A.DELETED = <span class="string">'NO'</span></span><br><span class="line">ORDER BY  A.COMPLETION_TIME DESC;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢Rmanå¤‡ä»½è¿›åº¦"><a href="#æŸ¥è¯¢Rmanå¤‡ä»½è¿›åº¦" class="headerlink" title="æŸ¥è¯¢Rmanå¤‡ä»½è¿›åº¦"></a>æŸ¥è¯¢Rmanå¤‡ä»½è¿›åº¦</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT SID,</span><br><span class="line">         SERIAL<span class="comment">#,</span></span><br><span class="line">         opname,</span><br><span class="line">        ROUND(SOFAR/TOTALWORK*100)||<span class="string">'%'</span> <span class="string">"%_COMPLETE"</span>, TRUNC(elapsed_seconds/60) || <span class="string">':'</span> || MOD(elapsed_seconds,60) elapsed, TRUNC(time_remaining/60) || <span class="string">':'</span> || MOD(time_remaining,60) remaining, CONTEXT,target,SOFAR, TOTALWORK</span><br><span class="line">FROM V<span class="variable">$SESSION_LONGOPS</span></span><br><span class="line">WHERE OPNAME LIKE <span class="string">'RMAN%'</span></span><br><span class="line">        AND OPNAME NOT LIKE <span class="string">'%aggregate%'</span></span><br><span class="line">        AND TOTALWORK != 0</span><br><span class="line">        AND SOFAR <> TOTALWORK;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ‰§è¡Œè¿‡å…¨è¡¨æ‰«æçš„sqlè¯­å¥çš„SQL-IDå’Œsql-fulltext"><a href="#æŸ¥è¯¢æ‰§è¡Œè¿‡å…¨è¡¨æ‰«æçš„sqlè¯­å¥çš„SQL-IDå’Œsql-fulltext" class="headerlink" title="æŸ¥è¯¢æ‰§è¡Œè¿‡å…¨è¡¨æ‰«æçš„sqlè¯­å¥çš„SQL_IDå’Œsql_fulltext"></a>æŸ¥è¯¢æ‰§è¡Œè¿‡å…¨è¡¨æ‰«æçš„sqlè¯­å¥çš„SQL_IDå’Œsql_fulltext</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.sid,</span><br><span class="line">        s.serial<span class="comment">#,</span></span><br><span class="line">        s.inst_id,</span><br><span class="line">        s.sql_id,</span><br><span class="line">        s.username,</span><br><span class="line">        s.target,</span><br><span class="line">        s.ELAPSED_SECONDS,</span><br><span class="line">        s.START_TIME,</span><br><span class="line">        s.LAST_UPDATE_TIME,</span><br><span class="line">        v.sql_fulltext</span><br><span class="line">FROM gv<span class="variable">$session_longops</span> s,gv<span class="variable">$sql</span> v</span><br><span class="line">WHERE s.OPNAME = <span class="string">'Table Scan'</span></span><br><span class="line">        AND s.SQL_PLAN_OPERATION = <span class="string">'TABLE ACCESS'</span></span><br><span class="line">        AND s.SQL_PLAN_OPTIONS = <span class="string">'FULL'</span></span><br><span class="line">        AND s.sql_id=v.sql_id</span><br><span class="line">ORDER BY  s.LAST_UPDATE_TIME DESC</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ­»äº‹åŠ¡éœ€è¦å¤šé•¿çš„å›æ»šæ—¶é—´"><a href="#æŸ¥è¯¢æ­»äº‹åŠ¡éœ€è¦å¤šé•¿çš„å›æ»šæ—¶é—´" class="headerlink" title="æŸ¥è¯¢æ­»äº‹åŠ¡éœ€è¦å¤šé•¿çš„å›æ»šæ—¶é—´"></a>æŸ¥è¯¢æ­»äº‹åŠ¡éœ€è¦å¤šé•¿çš„å›æ»šæ—¶é—´</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X<span class="variable">$KTUXE</span>ï¼š[K]ernel [T]ransaction [U]ndo Transa[x]tion [E]ntry (table)`</span><br></pre></td></tr></tbody></table></figure><p><code>X$KTUXE</code>è¡¨çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½æ˜¯ï¼Œå¯ä»¥è·å¾—æ— æ³•é€šè¿‡<code>v$transaction</code>æ¥è§‚å¯Ÿçš„æ­»äº‹åŠ¡ä¿¡æ¯ï¼Œå½“ä¸€ä¸ªæ•°æ®åº“å‘ç”Ÿå¼‚å¸¸ä¸­æ–­ï¼Œæˆ–è€…è¿›è¡Œå»¶è¿Ÿäº‹åŠ¡æ¢å¤æ—¶ï¼Œæ•°æ®åº“å¯åŠ¨åï¼Œæ— æ³•é€šè¿‡V$TRANSACTIONæ¥è§‚å¯Ÿäº‹åŠ¡ä¿¡æ¯ï¼Œä½†æ˜¯<code>X$KTUXE</code>å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å¾—è¿™äº›ä¿¡æ¯ã€‚è¯¥è¡¨ä¸­çš„KTUXECFLä»£è¡¨äº†äº‹åŠ¡çš„Flagæ ‡è®°ï¼Œé€šè¿‡è¿™ä¸ªæ ‡è®°å¯ä»¥æ‰¾åˆ°é‚£äº›Deadäº‹åŠ¡ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL> select distinct KTUXECFL,count(*) from x<span class="variable">$ktuxe</span> group by KTUXECFL; </span><br><span class="line">    KTUXECFL                  COUNT(*) </span><br><span class="line">    ------------------------ ---------- </span><br><span class="line">    DEAD                              1 </span><br><span class="line">NONE                          2393</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="KTUXESIZç”¨æ¥è®°å½•äº‹åŠ¡ä½¿ç”¨çš„å›æ»šæ®µå—æ•°ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªå­—æ®µæ¥è¯„ä¼°æ¢å¤è¿›åº¦-ä¾‹å¦‚å¦‚ä¸‹äº‹åŠ¡å›æ»šç»è¿‡æµ‹ç®—éœ€è¦å¤§çº¦3å°æ—¶"><a href="#KTUXESIZç”¨æ¥è®°å½•äº‹åŠ¡ä½¿ç”¨çš„å›æ»šæ®µå—æ•°ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªå­—æ®µæ¥è¯„ä¼°æ¢å¤è¿›åº¦-ä¾‹å¦‚å¦‚ä¸‹äº‹åŠ¡å›æ»šç»è¿‡æµ‹ç®—éœ€è¦å¤§çº¦3å°æ—¶" class="headerlink" title="KTUXESIZç”¨æ¥è®°å½•äº‹åŠ¡ä½¿ç”¨çš„å›æ»šæ®µå—æ•°ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªå­—æ®µæ¥è¯„ä¼°æ¢å¤è¿›åº¦,ä¾‹å¦‚å¦‚ä¸‹äº‹åŠ¡å›æ»šç»è¿‡æµ‹ç®—éœ€è¦å¤§çº¦3å°æ—¶"></a>KTUXESIZç”¨æ¥è®°å½•äº‹åŠ¡ä½¿ç”¨çš„å›æ»šæ®µå—æ•°ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªå­—æ®µæ¥è¯„ä¼°æ¢å¤è¿›åº¦,ä¾‹å¦‚å¦‚ä¸‹äº‹åŠ¡å›æ»šç»è¿‡æµ‹ç®—éœ€è¦å¤§çº¦3å°æ—¶</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXECFL =<span class="string">'DEAD'</span>; </span><br><span class="line">    ADDR              KTUXEUSN  KTUXESLT  KTUXESQN  KTUXESIZ </span><br><span class="line">    ---------------- ---------- ---------- ---------- ---------- </span><br><span class="line">FFFFFFFF7D07B91C        10        39    2567412    1086075 </span><br><span class="line"></span><br><span class="line">SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXECFL =<span class="string">'DEAD'</span>; </span><br><span class="line">    ADDR              KTUXEUSN  KTUXESLT  KTUXESQN  KTUXESIZ </span><br><span class="line">    ---------------- ---------- ---------- ---------- ---------- </span><br><span class="line">    FFFFFFFF7D07B91C        10        39    2567412    1086067 </span><br><span class="line"></span><br><span class="line">SQL> <span class="built_in">declare</span> </span><br><span class="line">   l_start number; </span><br><span class="line">   l_end    number; </span><br><span class="line">   begin </span><br><span class="line">    select ktuxesiz into l_start from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXEUSN=10 and KTUXESLT=39; </span><br><span class="line">    dbms_lock.sleep(60); </span><br><span class="line">    select ktuxesiz into l_end from x<span class="variable">$ktuxe</span> <span class="built_in">where</span>  KTUXEUSN=10 and KTUXESLT=39; </span><br><span class="line">    dbms_output.put_line(<span class="string">'time_H:'</span>|| round(l_end/(l_start -l_end)/60,2)); </span><br><span class="line">  end; </span><br><span class="line">  / </span><br><span class="line"></span><br><span class="line">time_H:3</span><br></pre></td></tr></tbody></table></figure><h4 id="æŠŠXXXç”¨æˆ·ä¸‹é¢çš„æŸäº›YYYè¡¨èµ‹æƒç»™user-XXX-YYYè¦å¤§å†™"><a href="#æŠŠXXXç”¨æˆ·ä¸‹é¢çš„æŸäº›YYYè¡¨èµ‹æƒç»™user-XXX-YYYè¦å¤§å†™" class="headerlink" title="æŠŠXXXç”¨æˆ·ä¸‹é¢çš„æŸäº›YYYè¡¨èµ‹æƒç»™user,XXX\YYYè¦å¤§å†™"></a>æŠŠXXXç”¨æˆ·ä¸‹é¢çš„æŸäº›YYYè¡¨èµ‹æƒç»™user,XXX\YYYè¦å¤§å†™</h4><ul><li>XXXè¦å¤§å†™<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> tablename varchar2(200);     </span><br><span class="line">    begin </span><br><span class="line">    <span class="keyword">for</span> x IN (SELECT * FROM dba_tables <span class="built_in">where</span> owner=<span class="string">'XXX'</span> and table_name like <span class="string">'%YYY%'</span>) loop   </span><br><span class="line">    tablename:=x.table_name; </span><br><span class="line">    dbms_output.put_line(<span class="string">'GRANT SELECT ON XXX.'</span>||tablename||<span class="string">' to user'</span>); </span><br><span class="line">    EXECUTE IMMEDIATE <span class="string">'GRANT SELECT ON XXX.'</span>||tablename||<span class="string">' TO user'</span>;  </span><br><span class="line">    end loop; </span><br><span class="line">end;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="OracleæŸ¥å‡ºä¸€ä¸ªç”¨æˆ·å…·æœ‰çš„æ‰€æœ‰ç³»ç»Ÿæƒé™å’Œå¯¹è±¡æƒé™"><a href="#OracleæŸ¥å‡ºä¸€ä¸ªç”¨æˆ·å…·æœ‰çš„æ‰€æœ‰ç³»ç»Ÿæƒé™å’Œå¯¹è±¡æƒé™" class="headerlink" title="OracleæŸ¥å‡ºä¸€ä¸ªç”¨æˆ·å…·æœ‰çš„æ‰€æœ‰ç³»ç»Ÿæƒé™å’Œå¯¹è±¡æƒé™"></a>OracleæŸ¥å‡ºä¸€ä¸ªç”¨æˆ·å…·æœ‰çš„æ‰€æœ‰ç³»ç»Ÿæƒé™å’Œå¯¹è±¡æƒé™</h4><p>ç³»ç»Ÿæƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢<code>select * from session_privs</code>çš„ç»“æœä¸€è‡´ï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM DBA_SYS_PRIVS</span><br><span class="line">WHERE GRANTEE = <span class="string">'ç”¨æˆ·å'</span></span><br><span class="line">UNION</span><br><span class="line">ALLSELECT *</span><br><span class="line">FROM DBA_SYS_PRIVS</span><br><span class="line">WHERE GRANTEE IN </span><br><span class="line">    (SELECT GRANTED_ROLE</span><br><span class="line">    FROM DBA_ROLE_PRIVS</span><br><span class="line">    WHERE GRANTEE = <span class="string">'ç”¨æˆ·å'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="å¯¹è±¡æƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢select-FROM-TABLE-PRIVILEGES-where-GRANTEE-39-å½“å‰ç”¨æˆ·-39-çš„ç»“æœä¸€è‡´ï¼‰"><a href="#å¯¹è±¡æƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢select-FROM-TABLE-PRIVILEGES-where-GRANTEE-39-å½“å‰ç”¨æˆ·-39-çš„ç»“æœä¸€è‡´ï¼‰" class="headerlink" title="å¯¹è±¡æƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢select * FROM TABLE_PRIVILEGES where GRANTEE='å½“å‰ç”¨æˆ·'çš„ç»“æœä¸€è‡´ï¼‰"></a>å¯¹è±¡æƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢<code>select * FROM TABLE_PRIVILEGES where GRANTEE='å½“å‰ç”¨æˆ·'</code>çš„ç»“æœä¸€è‡´ï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM DBA_TAB_PRIVS</span><br><span class="line">WHERE GRANTEE = <span class="string">'ç”¨æˆ·å'</span></span><br><span class="line">UNION</span><br><span class="line">ALLSELECT *</span><br><span class="line">FROM DBA_TAB_PRIVS</span><br><span class="line">WHERE GRANTEE IN </span><br><span class="line">    (SELECT GRANTED_ROLE</span><br><span class="line">    FROM DBA_ROLE_PRIVS</span><br><span class="line">    WHERE GRANTEE = <span class="string">'ç”¨æˆ·å'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²"><a href="#æŸ¥è¯¢æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²" class="headerlink" title="æŸ¥è¯¢æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²"></a>æŸ¥è¯¢æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_role_privs</span><br><span class="line">WHERE GRANTEE=<span class="string">'ç”¨æˆ·å'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ‹¥æœ‰DBAè§’è‰²æƒé™çš„ç”¨æˆ·"><a href="#æŸ¥è¯¢æ‹¥æœ‰DBAè§’è‰²æƒé™çš„ç”¨æˆ·" class="headerlink" title="æŸ¥è¯¢æ‹¥æœ‰DBAè§’è‰²æƒé™çš„ç”¨æˆ·"></a>æŸ¥è¯¢æ‹¥æœ‰DBAè§’è‰²æƒé™çš„ç”¨æˆ·</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_role_privs</span><br><span class="line">WHERE GRANTED_ROLE=<span class="string">'DBA'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸä¸ªè§’è‰²æ‹¥æœ‰çš„ç³»ç»Ÿæƒé™"><a href="#æŸ¥è¯¢æŸä¸ªè§’è‰²æ‹¥æœ‰çš„ç³»ç»Ÿæƒé™" class="headerlink" title="æŸ¥è¯¢æŸä¸ªè§’è‰²æ‹¥æœ‰çš„ç³»ç»Ÿæƒé™"></a>æŸ¥è¯¢æŸä¸ªè§’è‰²æ‹¥æœ‰çš„ç³»ç»Ÿæƒé™</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM ROLE_SYS_PRIVS</span><br><span class="line">WHERE role=<span class="string">'è§’è‰²å'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="æ¸…é™¤æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’"><a href="#æ¸…é™¤æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’" class="headerlink" title="æ¸…é™¤æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’"></a>æ¸…é™¤æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exec DBMS_SHARED_POOL.PURGE(<span class="string">'v$sqlarea.ADDRESS,v$sqlarea.HASH_VALUE'</span>,<span class="string">'c'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å¯†ç æ˜¯å¦æœ‰è¿‡æœŸé™åˆ¶ï¼Œé»˜è®¤æ˜¯180å¤©ï¼Œä¸€èˆ¬ä¿®æ”¹ä¸ºunlimited"><a href="#æŸ¥è¯¢å¯†ç æ˜¯å¦æœ‰è¿‡æœŸé™åˆ¶ï¼Œé»˜è®¤æ˜¯180å¤©ï¼Œä¸€èˆ¬ä¿®æ”¹ä¸ºunlimited" class="headerlink" title="æŸ¥è¯¢å¯†ç æ˜¯å¦æœ‰è¿‡æœŸé™åˆ¶ï¼Œé»˜è®¤æ˜¯180å¤©ï¼Œä¸€èˆ¬ä¿®æ”¹ä¸ºunlimited"></a>æŸ¥è¯¢å¯†ç æ˜¯å¦æœ‰è¿‡æœŸé™åˆ¶ï¼Œé»˜è®¤æ˜¯180å¤©ï¼Œä¸€èˆ¬ä¿®æ”¹ä¸ºunlimited</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_profiles</span><br><span class="line">WHERE profile=<span class="string">'DEFAULT'</span></span><br><span class="line">        AND RESOURCE_NAME LIKE <span class="string">'PASSWORD%'</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢å’Œä¿®æ”¹éšå«å‚æ•°ï¼ˆå¿…é¡»åœ¨sysdbaæƒé™ä¸‹æ“ä½œï¼‰"><a href="#æŸ¥è¯¢å’Œä¿®æ”¹éšå«å‚æ•°ï¼ˆå¿…é¡»åœ¨sysdbaæƒé™ä¸‹æ“ä½œï¼‰" class="headerlink" title="æŸ¥è¯¢å’Œä¿®æ”¹éšå«å‚æ•°ï¼ˆå¿…é¡»åœ¨sysdbaæƒé™ä¸‹æ“ä½œï¼‰"></a>æŸ¥è¯¢å’Œä¿®æ”¹éšå«å‚æ•°ï¼ˆå¿…é¡»åœ¨sysdbaæƒé™ä¸‹æ“ä½œï¼‰</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.ksppinm name,</span><br><span class="line">         b.ksppstvl value,</span><br><span class="line">         a.ksppdesc description</span><br><span class="line">FROM x<span class="variable">$ksppi</span> a, x<span class="variable">$ksppcv</span> b</span><br><span class="line">WHERE a.indx = b.indx</span><br><span class="line">        AND a.ksppinm LIKE <span class="string">'%_small_table_threshold%'</span></span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">alter system <span class="built_in">set</span> <span class="string">"_small_table_threshold"</span>=value scope=both sid=<span class="string">'*'</span>;</span><br></pre></td></tr></tbody></table></figure><p>ä¸åŠ sidåˆ™è¯´æ˜åœ¨é»˜è®¤åœ¨RACçš„æ‰€æœ‰å®ä¾‹ä¸­ä¿®æ”¹ </p><p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·, å¦å¤–å¼•å·å†…ä¸èƒ½æœ‰ç©ºæ ¼, åªèƒ½åŒ…å«å‚æ•°çš„åå­— </p><h4 id="è¯„ä¼°SGAè¯¥è®¾ç½®å¤šå°‘"><a href="#è¯„ä¼°SGAè¯¥è®¾ç½®å¤šå°‘" class="headerlink" title="è¯„ä¼°SGAè¯¥è®¾ç½®å¤šå°‘"></a>è¯„ä¼°SGAè¯¥è®¾ç½®å¤šå°‘</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT SGA_SIZE</span><br><span class="line">FROM </span><br><span class="line">    (SELECT *</span><br><span class="line">    FROM V<span class="variable">$SGA_TARGET_ADVICE</span></span><br><span class="line">    WHERE ESTD_DB_TIME_FACTOR=1</span><br><span class="line">    ORDER BY  1)</span><br><span class="line">WHERE rownum=1;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹shared-poolè¿˜å‰©å¤šå°‘"><a href="#æŸ¥çœ‹shared-poolè¿˜å‰©å¤šå°‘" class="headerlink" title="æŸ¥çœ‹shared poolè¿˜å‰©å¤šå°‘"></a>æŸ¥çœ‹shared poolè¿˜å‰©å¤šå°‘</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM v<span class="variable">$sgastat</span></span><br><span class="line">WHERE name=<span class="string">'free memory'</span></span><br><span class="line">        AND pool=<span class="string">'shared pool'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="ç»Ÿè®¡æ‰€æœ‰è¡¨çš„å®¹é‡å¤§å°-å«åˆ†åŒºå­—æ®µã€LOBå­—æ®µ"><a href="#ç»Ÿè®¡æ‰€æœ‰è¡¨çš„å®¹é‡å¤§å°-å«åˆ†åŒºå­—æ®µã€LOBå­—æ®µ" class="headerlink" title="ç»Ÿè®¡æ‰€æœ‰è¡¨çš„å®¹é‡å¤§å°(å«åˆ†åŒºå­—æ®µã€LOBå­—æ®µ)"></a>ç»Ÿè®¡æ‰€æœ‰è¡¨çš„å®¹é‡å¤§å°(å«åˆ†åŒºå­—æ®µã€LOBå­—æ®µ)</h4><p>ä¸€èˆ¬å…ˆæ‰§è¡Œ<code>select distinct SEGMENT_TYPE from dba_segments where owner<>'SYS' and tablespace_name<>'SYSAUX'</code>æŸ¥çœ‹åˆ°æ‰€æœ‰çš„<code>segment_type</code><br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">SELECT owner,</span><br><span class="line">        table_name,</span><br><span class="line">         TRUNC(sum(bytes)/1024/1024) Meg</span><br><span class="line">FROM </span><br><span class="line">    (SELECT segment_name table_name,</span><br><span class="line">         owner,</span><br><span class="line">         bytes</span><br><span class="line">    FROM dba_segments</span><br><span class="line">    WHERE segment_type = <span class="string">'TABLE'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT s.segment_name table_name,</span><br><span class="line">         pt.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_segments s, dba_part_tables pt</span><br><span class="line">    WHERE s.segment_name = pt.table_name</span><br><span class="line">            AND s.owner = pt.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'TABLE PARTITION'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT i.table_name,</span><br><span class="line">         i.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_indexes i, dba_segments s</span><br><span class="line">    WHERE s.segment_name = i.index_name</span><br><span class="line">            AND s.owner = i.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'INDEX'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT pi.table_name,</span><br><span class="line">         pi.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_part_indexes pi, dba_segments s</span><br><span class="line">    WHERE s.segment_name = pi.index_name</span><br><span class="line">            AND s.owner = pi.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'INDEX PARTITION'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.segment_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOBSEGMENT'</span></span><br><span class="line">    UNION</span><br><span class="line">    ALLSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.index_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOBINDEX'</span></span><br><span class="line">    UNION</span><br><span class="line">    allSELECT l.table_name,</span><br><span class="line">         l.owner,</span><br><span class="line">         s.bytes</span><br><span class="line">    FROM dba_lobs l, dba_segments s</span><br><span class="line">    WHERE s.segment_name = l.segment_name</span><br><span class="line">            AND s.owner = l.owner</span><br><span class="line">            AND s.segment_type = <span class="string">'LOB PARTITION'</span> )</span><br><span class="line">GROUP BY  owner,table_name</span><br><span class="line">HAVING SUM(bytes)/1024/1024 > 10</span><br><span class="line">ORDER BY  SUM(bytes) DESC</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æŸ¥çœ‹å½“å‰ä¼šè¯çš„SID"><a href="#æŸ¥çœ‹å½“å‰ä¼šè¯çš„SID" class="headerlink" title="æŸ¥çœ‹å½“å‰ä¼šè¯çš„SID"></a>æŸ¥çœ‹å½“å‰ä¼šè¯çš„SID</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM V<span class="variable">$MYSTAT</span></span><br><span class="line">WHERE rownum<2</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚consistent-getsä¸€è‡´æ€§è¯»"><a href="#æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚consistent-getsä¸€è‡´æ€§è¯»" class="headerlink" title="æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚consistent getsä¸€è‡´æ€§è¯»"></a>æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚consistent getsä¸€è‡´æ€§è¯»</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT A.SID,</span><br><span class="line">        A.STATISTIC<span class="comment">#,</span></span><br><span class="line">        A.VALUE SID_VALUE,</span><br><span class="line">        B.NAME,</span><br><span class="line">        B.VALUE ALL_SID_VALUE</span><br><span class="line">FROM V<span class="variable">$SESSTAT</span> A ,V<span class="variable">$SYSSTAT</span> B</span><br><span class="line">WHERE A.STATISTIC<span class="comment">#=B.STATISTIC#</span></span><br><span class="line">        AND A.SID=1187</span><br><span class="line">        AND B.NAME=<span class="string">'consistent gets'</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>V$SYSSTAT</code>ç»Ÿè®¡æ•´ä¸ªDBçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œ<code>V$SYSSTAT</code>å·²ç»å–ä»£äº†<code>V$STATNAME</code>ï¼Œå¹¶ä¸”å¤šäº†VALUEè¿™ä¸€åˆ— <code>V$SESSTAT</code>ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„ç»Ÿè®¡ä¿¡æ¯ </li></ul><h4 id="æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç­‰å¾…äº‹ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚log-file-sync"><a href="#æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç­‰å¾…äº‹ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚log-file-sync" class="headerlink" title="æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç­‰å¾…äº‹ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚log file sync"></a>æŸ¥è¯¢æŸä¸ªSIDçš„æŸä¸ªç­‰å¾…äº‹ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚log file sync</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT A.SID,</span><br><span class="line">        A.EVENT,</span><br><span class="line">        C.NAME,</span><br><span class="line">        C.PARAMETER1,</span><br><span class="line">        C.PARAMETER2,</span><br><span class="line">        C.PARAMETER3,</span><br><span class="line">         A.TIME_WAITED SID_TIMEWAITED,</span><br><span class="line">        B.TIME_WAITED ALL_SID_TIMEWAITED,</span><br><span class="line">        A.TOTAL_WAITS SID_TOTALWAITS,</span><br><span class="line">        B.TOTAL_WAITS ALL_SID_TOTALWAITS</span><br><span class="line">FROM V<span class="variable">$SESSION_EVENT</span> A ,V<span class="variable">$SYSTEM_EVENT</span> B,V<span class="variable">$EVENT_NAME</span> C</span><br><span class="line">WHERE A.EVENT=B.EVENT</span><br><span class="line">        AND A.EVENT=C.NAME</span><br><span class="line">        AND A.SID=1</span><br><span class="line">        AND C.NAME=<span class="string">'log file sync'</span> V<span class="variable">$SESSION_EVENT</span>æè¿°æ¯ä¸ªç”¨æˆ·çš„ç­‰å¾…äº‹ä»¶ä¿¡æ¯ V<span class="variable">$SYSTEM_EVENT</span>æè¿°æ•´ä¸ªDBç­‰å¾…äº‹ä»¶ä¿¡æ¯ V<span class="variable">$EVENT_NAME</span>æè¿°ç­‰å¾…äº‹ä»¶ä¿¡æœ¬èº«çš„ä¿¡æ¯(æ¯”å¦‚V<span class="variable">$ACTIVE_SESSION_HISTORY</span>çš„P1TEXTã€P2TEXTã€P2TEXTåŒ¹é…V<span class="variable">$EVENT_NAME</span>çš„PARAMETER1ã€PARAMETER2ã€PARAMETER3)</span><br></pre></td></tr></tbody></table></figure><h4 id="RACè·¨èŠ‚ç‚¹æ€ä¼šè¯"><a href="#RACè·¨èŠ‚ç‚¹æ€ä¼šè¯" class="headerlink" title="RACè·¨èŠ‚ç‚¹æ€ä¼šè¯"></a>RACè·¨èŠ‚ç‚¹æ€ä¼šè¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter system <span class="built_in">kill</span> session <span class="string">'SID,serial#,@1'</span>  --æ€æ‰1èŠ‚ç‚¹çš„è¿›ç¨‹ </span><br><span class="line">alter system <span class="built_in">kill</span> session <span class="string">'SID,serial#,@2'</span>  --æ€æ‰2èŠ‚ç‚¹çš„è¿›ç¨‹</span><br></pre></td></tr></tbody></table></figure><h4 id="Truncate-åˆ†åŒºçš„SQL"><a href="#Truncate-åˆ†åŒºçš„SQL" class="headerlink" title="Truncate åˆ†åŒºçš„SQL"></a>Truncate åˆ†åŒºçš„SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name TRUNCATE PARTITION p1 DROP STORAGE UPDATE GLOBAL INDEXES;</span><br></pre></td></tr></tbody></table></figure><h4 id="Dropåˆ†åŒºçš„SQL"><a href="#Dropåˆ†åŒºçš„SQL" class="headerlink" title="Dropåˆ†åŒºçš„SQL"></a>Dropåˆ†åŒºçš„SQL</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name DROP PARTITION p1 UPDATE GLOBAL INDEXES;</span><br></pre></td></tr></tbody></table></figure><h4 id="DATAGUARDä¸»å¤‡å»¶è¿Ÿå¤šå°‘æ—¶é—´çš„æŸ¥è¯¢æ–¹æ³•"><a href="#DATAGUARDä¸»å¤‡å»¶è¿Ÿå¤šå°‘æ—¶é—´çš„æŸ¥è¯¢æ–¹æ³•" class="headerlink" title="DATAGUARDä¸»å¤‡å»¶è¿Ÿå¤šå°‘æ—¶é—´çš„æŸ¥è¯¢æ–¹æ³•"></a>DATAGUARDä¸»å¤‡å»¶è¿Ÿå¤šå°‘æ—¶é—´çš„æŸ¥è¯¢æ–¹æ³•</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">å¤‡ åº“sqlplus></span><br><span class="line">SELECT value</span><br><span class="line">FROM v<span class="variable">$dataguard_stats</span></span><br><span class="line">WHERE name=<span class="string">'apply lag'</span> </span><br><span class="line">æˆ– </span><br><span class="line">å¤‡åº“sqlplus></span><br><span class="line">SELECT ceil((sysdate-next_time)*24*60) <span class="string">"M"</span></span><br><span class="line">FROM v<span class="variable">$archived_log</span></span><br><span class="line">WHERE applied=<span class="string">'YES'</span></span><br><span class="line">        AND SEQUENCE<span class="comment">#=</span></span><br><span class="line">    (SELECT MAX(SEQUENCE<span class="comment">#)</span></span><br><span class="line">    FROM V<span class="variable">$ARCHIVED_LOG</span></span><br><span class="line">    WHERE applied=<span class="string">'YES'</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥çœ‹æŸä¸ªåŒ…æˆ–å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒç”¨-å¦‚æœå¦‚ä¸‹æœ‰ç»“æœï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç¼–è¯‘ï¼Œå¦åˆ™ä¼šé”ä½"><a href="#æŸ¥çœ‹æŸä¸ªåŒ…æˆ–å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒç”¨-å¦‚æœå¦‚ä¸‹æœ‰ç»“æœï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç¼–è¯‘ï¼Œå¦åˆ™ä¼šé”ä½" class="headerlink" title="æŸ¥çœ‹æŸä¸ªåŒ…æˆ–å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒç”¨,å¦‚æœå¦‚ä¸‹æœ‰ç»“æœï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç¼–è¯‘ï¼Œå¦åˆ™ä¼šé”ä½"></a>æŸ¥çœ‹æŸä¸ªåŒ…æˆ–å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒç”¨,å¦‚æœå¦‚ä¸‹æœ‰ç»“æœï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç¼–è¯‘ï¼Œå¦åˆ™ä¼šé”ä½</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM V<span class="variable">$DB_OBJECT_CACHE</span></span><br><span class="line">WHERE pin>0</span><br><span class="line">        AND name=upper(<span class="string">'XX'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æ•°æ®åº“æ‰“è¡¥ä¸çš„è®°å½•"><a href="#æŸ¥è¯¢æ•°æ®åº“æ‰“è¡¥ä¸çš„è®°å½•" class="headerlink" title="æŸ¥è¯¢æ•°æ®åº“æ‰“è¡¥ä¸çš„è®°å½•"></a>æŸ¥è¯¢æ•°æ®åº“æ‰“è¡¥ä¸çš„è®°å½•</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM dba_registry_history;</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸè¡¨çš„ç´¢å¼•å­—æ®µçš„distinctè¡Œæ•°å’ŒCLUSTERING-FACTORä¿¡æ¯"><a href="#æŸ¥è¯¢æŸè¡¨çš„ç´¢å¼•å­—æ®µçš„distinctè¡Œæ•°å’ŒCLUSTERING-FACTORä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢æŸè¡¨çš„ç´¢å¼•å­—æ®µçš„distinctè¡Œæ•°å’ŒCLUSTERING_FACTORä¿¡æ¯"></a>æŸ¥è¯¢æŸè¡¨çš„ç´¢å¼•å­—æ®µçš„distinctè¡Œæ•°å’ŒCLUSTERING_FACTORä¿¡æ¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.table_name,</span><br><span class="line">        a.index_name,</span><br><span class="line">        b.COLUMN_NAME,</span><br><span class="line">        a.blevel,</span><br><span class="line">        a.distinct_keys,</span><br><span class="line">        A.CLUSTERING_FACTOR,</span><br><span class="line">        A.NUM_ROWS,</span><br><span class="line">        trunc((a.distinct_keys/A.NUM_ROWS),</span><br><span class="line">        2)*100||<span class="string">'%'</span> <span class="string">"distinct%"</span>,trunc((a.CLUSTERING_FACTOR/A.NUM_ROWS),2)*100||<span class="string">'%'</span> <span class="string">"CLUSTERING_FACTOR%"</span></span><br><span class="line">FROM DBA_IND_STATISTICS a,DBA_IND_COLUMNS b</span><br><span class="line">WHERE a.table_name=<span class="string">'XX'</span></span><br><span class="line">        AND a.INDEX_NAME=b.index_name</span><br><span class="line">ORDER BY  5 desc</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢æŸè¡¨çš„æ‰€æœ‰å­—æ®µçš„distinctè¡Œæ•°"><a href="#æŸ¥è¯¢æŸè¡¨çš„æ‰€æœ‰å­—æ®µçš„distinctè¡Œæ•°" class="headerlink" title="æŸ¥è¯¢æŸè¡¨çš„æ‰€æœ‰å­—æ®µçš„distinctè¡Œæ•°"></a>æŸ¥è¯¢æŸè¡¨çš„æ‰€æœ‰å­—æ®µçš„distinctè¡Œæ•°</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.table_name,</span><br><span class="line">        b.num_rows,</span><br><span class="line">        a.column_name,</span><br><span class="line">        a.data_type,</span><br><span class="line">        a.data_length,</span><br><span class="line">        a.num_distinct,</span><br><span class="line">        trunc((a.num_distinct/b.num_rows),</span><br><span class="line">        2)*100||<span class="string">'%'</span></span><br><span class="line">FROM dba_TAB_COLS a,dba_tables b</span><br><span class="line">WHERE a.table_name=<span class="string">'XX'</span></span><br><span class="line">        AND a.table_name=b.table_name</span><br><span class="line">ORDER BY  6 DESC</span><br></pre></td></tr></tbody></table></figure><h4 id="æŸ¥è¯¢5Gä»¥ä¸Šç©ºé—²ç©ºé—´å¯ä»¥è¿›è¡Œæ”¶ç¼©çš„æ•°æ®æ–‡ä»¶"><a href="#æŸ¥è¯¢5Gä»¥ä¸Šç©ºé—²ç©ºé—´å¯ä»¥è¿›è¡Œæ”¶ç¼©çš„æ•°æ®æ–‡ä»¶" class="headerlink" title="æŸ¥è¯¢5Gä»¥ä¸Šç©ºé—²ç©ºé—´å¯ä»¥è¿›è¡Œæ”¶ç¼©çš„æ•°æ®æ–‡ä»¶"></a>æŸ¥è¯¢5Gä»¥ä¸Šç©ºé—²ç©ºé—´å¯ä»¥è¿›è¡Œæ”¶ç¼©çš„æ•°æ®æ–‡ä»¶</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">'alter database datafile '</span><span class="string">''</span> || a.file_name || <span class="string">''</span><span class="string">' resize '</span> || round(a.filesize -(a.filesize - c.hwmsize) * 0.8) || <span class="string">'M;'</span>, a.filesize || <span class="string">'M'</span> AS <span class="string">"æ•°æ®æ–‡ä»¶çš„æ€»å¤§å°"</span>, c.hwmsize || <span class="string">'M'</span> AS <span class="string">"æ•°æ®æ–‡ä»¶çš„å®ç”¨å¤§å°"</span></span><br><span class="line">FROM </span><br><span class="line">    (SELECT file_id,</span><br><span class="line">         file_name,</span><br><span class="line">         round(bytes / 1024 / 1024) AS filesize</span><br><span class="line">    FROM dba_data_files) a, </span><br><span class="line">    (SELECT file_id,</span><br><span class="line">         round(max(block_id) * 8 / 1024) AS HWMsize</span><br><span class="line">    FROM dba_extents</span><br><span class="line">    GROUP BY  file_id) c</span><br><span class="line">WHERE a.file_id = c.file_id</span><br><span class="line">        AND a.filesize - c.hwmsize > 5000;</span><br></pre></td></tr></tbody></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å»–å­¦å¼º,<a href="http://blog.itpub.net/30126024/viewspace-2057474/" target="_blank" rel="noopener">DBAæ—¥å¸¸ç»´æŠ¤SQLè„šæœ¬</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaa.jpeg&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="Oracle" scheme="https://jiemin.wang/categories/Oracle/"/>
    
    
      <category term="Oracle" scheme="https://jiemin.wang/tags/Oracle/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®åº“æ‹†åˆ†</title>
    <link href="https://jiemin.wang/2019/04/24/databaseSplitting/"/>
    <id>https://jiemin.wang/2019/04/24/databaseSplitting/</id>
    <published>2019-04-24T10:19:28.000Z</published>
    <updated>2019-04-24T10:28:11.792Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaaa.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ç«¥è¯é‡Œç°å§‘å¨˜éƒ½å¾ˆç©·ï¼Œä½†éƒ½å¾ˆæ¼‚äº®ï¼Œä½ æ¼‚äº®å—ï¼Ÿ</strong></p></blockquote><h2 id="æ•°æ®åº“æ°´å¹³å‚ç›´æ‹†åˆ†"><a href="#æ•°æ®åº“æ°´å¹³å‚ç›´æ‹†åˆ†" class="headerlink" title="æ•°æ®åº“æ°´å¹³å‚ç›´æ‹†åˆ†"></a>æ•°æ®åº“æ°´å¹³å‚ç›´æ‹†åˆ†</h2><p>å½“æ•°æ®åº“é‡éå¸¸å¤§çš„æ—¶å€™ï¼ŒDB å·²ç»æˆä¸ºç³»ç»Ÿç“¶é¢ˆæ—¶å°±å¯ä»¥è€ƒè™‘è¿›è¡Œæ°´å¹³å‚ç›´æ‹†åˆ†äº†ã€‚</p><h2 id="æ°´å¹³æ‹†åˆ†"><a href="#æ°´å¹³æ‹†åˆ†" class="headerlink" title="æ°´å¹³æ‹†åˆ†"></a>æ°´å¹³æ‹†åˆ†</h2><p>ä¸€èˆ¬æ°´å¹³æ‹†åˆ†æ˜¯æ ¹æ®è¡¨ä¸­çš„æŸä¸€å­—æ®µ(é€šå¸¸æ˜¯ä¸»é”® ID )å–æ¨¡å¤„ç†ï¼Œå°†ä¸€å¼ è¡¨çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ä¸­ã€‚è¿™æ ·æ¯å¼ è¡¨çš„è¡¨ç»“æ„æ˜¯ç›¸åŒçš„ä½†æ˜¯æ•°æ®ä¸åŒã€‚</p><p>ä¸ä½†å¯ä»¥é€šè¿‡ ID å–æ¨¡åˆ†è¡¨è¿˜å¯ä»¥é€šè¿‡æ—¶é—´åˆ†è¡¨ï¼Œæ¯”å¦‚æ¯æœˆç”Ÿæˆä¸€å¼ è¡¨ã€‚<br>æŒ‰ç…§èŒƒå›´åˆ†è¡¨ä¹Ÿæ˜¯å¯è¡Œçš„:ä¸€å¼ è¡¨åªå­˜å‚¨ <code>0~1000W</code>çš„æ•°æ®ï¼Œè¶…è¿‡åªå°±è¿›è¡Œåˆ†è¡¨ï¼Œè¿™æ ·åˆ†è¡¨çš„ä¼˜ç‚¹æ˜¯æ‰©å±•çµæ´»ï¼Œä½†æ˜¯å­˜åœ¨çƒ­ç‚¹æ•°æ®ã€‚</p><p>æŒ‰ç…§å–æ¨¡åˆ†è¡¨æ‹†åˆ†ä¹‹åæˆ‘ä»¬çš„æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤ä¹Ÿéƒ½æ˜¯å–æ¨¡ã€‚æ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®çš„æ—¶å€™å¾€å¾€éœ€è¦ä¸€å¼ ä¸´æ—¶è¡¨æ¥ç”Ÿæˆ ID,ç„¶åæ ¹æ®ç”Ÿæˆçš„ ID å–æ¨¡è®¡ç®—å‡ºéœ€è¦å†™å…¥çš„æ˜¯å“ªå¼ è¡¨(ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://jiemin.wang/2019/04/24/Distributed-ID-Generation/">åˆ†å¸ƒå¼ ID ç”Ÿæˆå™¨</a>æ¥ç”Ÿæˆ ID)ã€‚</p><p>åˆ†è¡¨ä¹‹åä¸èƒ½é¿å…çš„å°±æ˜¯æŸ¥è¯¢è¦æ¯”ä»¥å‰å¤æ‚ï¼Œé€šå¸¸ä¸å»ºè®® <code>join</code> ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯åšä¸¤æ¬¡æŸ¥è¯¢ã€‚</p><h2 id="å‚ç›´æ‹†åˆ†"><a href="#å‚ç›´æ‹†åˆ†" class="headerlink" title="å‚ç›´æ‹†åˆ†"></a>å‚ç›´æ‹†åˆ†</h2><p>å½“ä¸€å¼ è¡¨çš„å­—æ®µè¿‡å¤šæ—¶åˆ™å¯ä»¥è€ƒè™‘å‚ç›´æ‹†åˆ†ã€‚<br>é€šå¸¸æ˜¯å°†ä¸€å¼ è¡¨çš„å­—æ®µæ‰åˆ†ä¸ºä¸»è¡¨ä»¥åŠæ‰©å±•è¡¨ï¼Œä½¿ç”¨é¢‘æ¬¡è¾ƒé«˜çš„å­—æ®µåœ¨ä¸€å¼ è¡¨ï¼Œå…¶ä½™çš„åœ¨ä¸€å¼ è¡¨ã€‚</p><p>è¿™é‡Œçš„å¤šè¡¨æŸ¥è¯¢ä¹Ÿä¸å»ºè®®ä½¿ç”¨ <code>join</code> ï¼Œä¾ç„¶å»ºè®®ä½¿ç”¨ä¸¤æ¬¡æŸ¥è¯¢ã€‚</p><h2 id="æ‹†åˆ†ä¹‹åå¸¦æ¥çš„é—®é¢˜"><a href="#æ‹†åˆ†ä¹‹åå¸¦æ¥çš„é—®é¢˜" class="headerlink" title="æ‹†åˆ†ä¹‹åå¸¦æ¥çš„é—®é¢˜"></a>æ‹†åˆ†ä¹‹åå¸¦æ¥çš„é—®é¢˜</h2><p>æ‹†åˆ†ä¹‹åç”±ä¸€å¼ è¡¨å˜ä¸ºäº†å¤šå¼ è¡¨ï¼Œä¸€ä¸ªåº“å˜ä¸ºäº†å¤šä¸ªåº“ã€‚æœ€çªå‡ºçš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯äº‹åŠ¡å¦‚ä½•ä¿è¯ã€‚</p><h3 id="ä¸¤æ®µæäº¤"><a href="#ä¸¤æ®µæäº¤" class="headerlink" title="ä¸¤æ®µæäº¤"></a>ä¸¤æ®µæäº¤</h3><h3 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="æœ€ç»ˆä¸€è‡´æ€§"></a>æœ€ç»ˆä¸€è‡´æ€§</h3><p>å¦‚æœä¸šåŠ¡å¯¹å¼ºä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆé«˜é‚£ä¹ˆæœ€ç»ˆä¸€è‡´æ€§åˆ™æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆã€‚</p><p>é€šå¸¸çš„åšæ³•å°±æ˜¯è¡¥å¿ï¼Œæ¯”å¦‚ ä¸€ä¸ªä¸šåŠ¡æ˜¯ A è°ƒç”¨ Bï¼Œä¸¤ä¸ªæ‰§è¡ŒæˆåŠŸæ‰ç®—æœ€ç»ˆæˆåŠŸï¼Œå½“ A æˆåŠŸä¹‹åï¼ŒB æ‰§è¡Œå¤±è´¥å¦‚ä½•æ¥é€šçŸ¥ A å‘¢ã€‚</p><p>æ¯”è¾ƒå¸¸è§çš„åšæ³•æ˜¯ å¤±è´¥æ—¶ B é€šè¿‡ MQ å°†æ¶ˆæ¯å‘Šè¯‰ Aï¼ŒA å†æ¥è¿›è¡Œå›æ»šã€‚è¿™ç§çš„å‰ææ˜¯ A çš„å›æ»šæ“ä½œå¾—æ˜¯å¹‚ç­‰çš„ï¼Œä¸ç„¶ B é‡å¤å‘æ¶ˆæ¯å°±ä¼šå‡ºç°é—®é¢˜ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaaa.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ ID ç”Ÿæˆç­–ç•¥</title>
    <link href="https://jiemin.wang/2019/04/24/Distributed-ID-Generation/"/>
    <id>https://jiemin.wang/2019/04/24/Distributed-ID-Generation/</id>
    <published>2019-04-24T09:49:09.000Z</published>
    <updated>2019-04-24T10:28:38.062Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="images.png" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¯¹äºç³»ç»Ÿä¸­çš„ä¸€ç»„æ•°æ®è€Œè¨€ï¼Œå¿…ä¸å¯å°‘åœ°å¯¹åº”æœ‰å”¯ä¸€æ ‡è¯†ã€‚ç®€å•çš„å•ä½“åº”ç”¨å¯ä»¥ä½¿ç”¨æ•°æ®åº“çš„è‡ªå¢ ID ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚è€Œåœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå°±éœ€è¦ä¸€äº›ç‰¹å®šçš„ç­–ç•¥å»ç”Ÿæˆå¯¹åº”çš„åˆ†å¸ƒå¼ IDã€‚</p><p>å¸¸è§çš„é¡¹ç›®ä¸­ ID ä¼šæœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><ol><li>å…¨å±€å”¯ä¸€æ€§ã€‚</li><li>è¶‹åŠ¿é€’å¢ï¼ˆå¯¹äºä½¿ç”¨ MySQL çš„é¡¹ç›®è€Œè¨€ï¼‰ã€‚</li><li><blockquote><p>å› ä¸ºä¸€èˆ¬ ID ä¼šä½œä¸ºæ•°æ®åº“çš„ä¸»é”®å­˜å‚¨ï¼Œè€Œåœ¨ MySQL InnoDB ä¸­ä½¿ç”¨çš„æ˜¯èšç°‡ç´¢å¼•ï¼Œä½¿ç”¨æœ‰åºçš„ ID å¯ä»¥ä¿è¯å†™å…¥æ€§èƒ½ã€‚</p></blockquote></li></ol><p>ä¸€èˆ¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡æ¥ç”Ÿæˆ IDã€‚è€Œè¿™ä¸ªæœåŠ¡åˆ™éœ€è¦ä¿è¯é«˜å¯ç”¨æ€§ã€é«˜QPS ä¸å®‰å…¨æ€§ã€‚å¦å¤–ç”Ÿæˆçš„ ID æ˜¯ä¸åº”è¯¥å¯¹å¤–æš´éœ²çš„ï¼Œå¦‚æœéè¦å¯¹å¤–å±•ç¤ºï¼Œæœ€å¥½æ˜¯æ— è§„åˆ™ã€ä¸è§„å¾‹çš„ç¼–ç ã€‚</p><h2 id="ç”Ÿæˆç­–ç•¥"><a href="#ç”Ÿæˆç­–ç•¥" class="headerlink" title="ç”Ÿæˆç­–ç•¥"></a>ç”Ÿæˆç­–ç•¥</h2><h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4><p>UUID (Universally Unique Identifier) ç”Ÿæˆçš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 32 çš„ 16 è¿›åˆ¶æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚UUID æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå„ç‰ˆæœ¬ç®—æ³•ä¸åŒã€‚ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç»“åˆæœºå™¨çš„ç½‘å¡ã€å½“å‰æ—¶é—´ã€ä¸€ä¸ªéšæœºæ•°æ¥ç”Ÿæˆç‰¹å®šé•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</p><p>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ã€é«˜å¯æ‰©å±•æ€§ï¼šæœ¬åœ°ç”Ÿæˆï¼Œæ— ç½‘ç»œæ¶ˆè€—ï¼Œä¸éœ€è¦è€ƒè™‘æ€§èƒ½ç“¶é¢ˆã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•ä¿è¯è¶‹åŠ¿é€’å¢ã€‚</li><li>UUID è¿‡é•¿ï¼Œå¦‚æœéœ€è¦åœ¨æ•°æ®åº“å­˜å‚¨ï¼Œä½œä¸ºä¸»é”®å»ºç«‹ç´¢å¼•æ•ˆç‡ä½ã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼šä¸éœ€è¦è€ƒè™‘ç©ºé—´å ç”¨ï¼Œä¸éœ€è¦ç”Ÿæˆæœ‰é€’å¢è¶‹åŠ¿ï¼Œä¸”ä¸åœ¨ MySQL ä¸­å­˜å‚¨ã€‚</p><h4 id="Snowflake"><a href="#Snowflake" class="headerlink" title="Snowflake"></a>Snowflake</h4><p>snowflake æ˜¯ Twitter å¼€æºçš„ä¸€ä¸ª ID ç”Ÿæˆç®—æ³•ã€‚<br><img src="/2019/04/24/Distributed-ID-Generation/640.webp" width="640"></p><ul><li>é¦–ä½ç¬¦å·ä½ï¼šå› ä¸º ID ä¸€èˆ¬ä¸ºæ­£æ•°ï¼Œè¯¥å€¼ä¸º 0ã€‚</li><li>41 ä½æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼š</li><li><blockquote><p>æ—¶é—´æˆ³ä¸æ˜¯å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆ³çš„å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆ³ - èµ·å§‹æ—¶é—´æˆ³ï¼ˆèµ·å§‹æ—¶é—´æˆ³éœ€è¦ç¨‹åºæŒ‡å®šï¼‰ï¼‰ç†è®ºä¸Šå¯ä»¥æœ€å¤šä½¿ç”¨ <code>(1 << 41) / (1000x60x60x24x365) = 69å¹´</code>ã€‚</p></blockquote></li><li><p>10 ä½æ•°æ®æœºå™¨ä½ï¼šåŒ…æ‹¬ 5 ä½æ•°æ®æ ‡è¯†ä½å’Œ 5 ä½æœºå™¨æ ‡è¯†ä½ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šå¯ä»¥éƒ¨ç½²èŠ‚ç‚¹æ•°ä¸ºï¼š<code>1 << 10 = 1024</code>ã€‚</p></li><li>12 ä½æ¯«ç§’å†…çš„åºåˆ—ï¼šåŒä¸€èŠ‚ç‚¹ã€åŒä¸€æ—¶åˆ»æœ€å¤šç”Ÿæˆ ID æ•° <code>1 << 12 = 4096</code>ã€‚</li></ul><p>æœ€åç”Ÿæˆç»“æœä¸º 64 ä½ Long å‹æ•°å€¼ã€‚</p><p>ä¼˜ç‚¹</p><ul><li>è¶‹åŠ¿é€’å¢ï¼Œä¸”æŒ‰ç…§æ—¶é—´æœ‰åºã€‚</li><li>æ€§èƒ½é«˜ã€ç¨³å®šæ€§é«˜ã€ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿã€‚</li><li>å¯ä»¥æŒ‰ç…§è‡ªèº«ä¸šåŠ¡ç‰¹æ€§çµæ´»åˆ†é… bit ä½ã€‚</li></ul><p>ç¼ºç‚¹</p><ul><li>ä¾èµ–äºæœºå™¨æ—¶é’Ÿï¼Œæ—¶é’Ÿå›æ‹¨ä¼šé€ æˆæš‚ä¸å¯ç”¨æˆ–é‡å¤å‘å·ã€‚<blockquote><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯å°æœºå™¨ä¸Šçš„æ—¶é’Ÿä¸å¯èƒ½å®Œå…¨åŒæ­¥ã€‚åœ¨åŒæ­¥å„ä¸ªæœåŠ¡å™¨çš„æ—¶é—´æ—¶ï¼Œæœ‰ä¸€å®šå‡ ç‡å‘ç”Ÿæ—¶é’Ÿå›æ‹¨ã€‚</p></blockquote></li></ul><p>é€‚ç”¨åœºæ™¯ï¼šè¦æ±‚é«˜æ€§èƒ½ï¼Œå¯ä»¥ä¸è¿ç»­ï¼Œæ•°æ®ç±»å‹ä¸º long å‹ã€‚</p><h4 id="Flicker"><a href="#Flicker" class="headerlink" title="Flicker"></a>Flicker</h4><p>Flicker æ–¹æ¡ˆä¸»è¦æ€è·¯æ˜¯è®¾è®¡å•ç‹¬çš„åº“è¡¨ï¼Œåˆ©ç”¨æ•°æ®åº“çš„è‡ªå¢ ID æ¥ç”Ÿæˆå…¨å±€ IDã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE ticket_center (  </span><br><span class="line">    id bigint(20) unsigned NOT NULL auto_increment,  </span><br><span class="line">    stub char(1) NOT NULL default <span class="string">''</span>,  </span><br><span class="line">    PRIMARY KEY (id),  </span><br><span class="line">    UNIQUE KEY unq_stub (stub)  </span><br><span class="line">)ENGINE=MyISAM;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li><blockquote><p>stub: ç¥¨æ ¹ï¼Œå¯¹åº”éœ€è¦ç”Ÿæˆ Id çš„ä¸šåŠ¡æ–¹ç¼–ç ï¼Œå¯ä»¥æ˜¯é¡¹ç›®åã€è¡¨åç”šè‡³æ˜¯æœåŠ¡å™¨ IP åœ°å€ã€‚</p></blockquote></li><li><blockquote><p>MyISAMï¼šé»˜è®¤è¡¨ç±»å‹ï¼ŒåŸºäºä¼ ç»Ÿçš„ ISAM ç±»å‹ã€‚ISAMæ˜¯ Indexed Sequential Access Method (æœ‰ç´¢å¼•çš„é¡ºåºè®¿é—®æ–¹æ³•) çš„ç¼©å†™ï¼Œå®ƒæ˜¯å­˜å‚¨è®°å½•å’Œæ–‡ä»¶çš„æ ‡å‡†æ–¹æ³•ã€‚ä¸æ˜¯äº‹åŠ¡å®‰å…¨çš„ï¼Œè€Œä¸”ä¸æ”¯æŒå¤–é”®ã€‚å¦‚æœæ‰§è¡Œå¤§é‡çš„ selectï¼ŒMySql å­˜å‚¨å¼•æ“é€‰ç”¨ MyISAM æ¯”è¾ƒé€‚åˆã€‚</p></blockquote></li></ul><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„SQL è·å– ID:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPLACE INTO ticket_center (stub) VALUES (<span class="string">'test'</span>);  </span><br><span class="line">SELECT LAST_INSERT_ID();</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p><code>Replace into</code> å…ˆå°è¯•æ’å…¥æ•°æ®åˆ°è¡¨ä¸­ï¼Œå¦‚æœå‘ç°è¡¨ä¸­å·²ç»æœ‰æ­¤è¡Œæ•°æ®ï¼ˆæ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ¤æ–­ï¼‰åˆ™å…ˆåˆ é™¤æ­¤è¡Œæ•°æ®ï¼Œç„¶åæ’å…¥æ–°çš„æ•°æ®ï¼Œ å¦åˆ™ç›´æ¥æ’å…¥æ–°æ•°æ®</p></blockquote><p>ä¸ºäº†è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼šFlicker æ–¹æ¡ˆå¯ç”¨äº†ä¸¤å°æ•°æ®åº“æœåŠ¡å™¨æ¥ç”Ÿæˆ IDï¼Œé€šè¿‡åŒºåˆ† auto_increment çš„èµ·å§‹å€¼å’Œæ­¥é•¿æ¥ç”Ÿæˆå¥‡å¶æ•°çš„ IDã€‚ï¼ˆä¹Ÿå¯ä»¥æ ¹æ®æƒ…å†µéƒ¨ç½²å¤šå°æœåŠ¡å™¨ï¼‰</p><p>ä¼˜ç‚¹</p><p>å……åˆ†åˆ©ç”¨äº†æ•°æ®åº“è‡ªå¢ ID æœºåˆ¶ï¼Œç”Ÿæˆçš„ ID æœ‰åºé€’å¢ã€‚</p><p>ç¼ºç‚¹</p><p>ä¾èµ–äºæ•°æ®åº“ï¼Œå¯ç”¨æ€§ä½</p><p>æ°´å¹³æ‰©å±•å›°éš¾ï¼šå®šä¹‰å¥½äº†èµ·å§‹å€¼ã€æ­¥é•¿å’Œæœºå™¨å°æ•°ä¹‹åï¼Œå¦‚æœè¦æ·»åŠ æœºå™¨å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p><p>é€‚ç”¨åœºæ™¯ï¼šæ•°æ®é‡ä¸å¤šï¼Œå¹¶å‘é‡ä¸å¤§ã€‚</p><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><p>å› ä¸º Redis ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œå¯ä»¥åˆ©ç”¨ Incrbyå‘½ä»¤æ¥æ¨¡æ‹Ÿ ID çš„é€’å¢ã€‚å¹¶ä¸”å¯ä»¥é€šè¿‡ä½¿ç”¨é›†ç¾¤æ¥æå‡ååé‡ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ Redis èŠ‚ç‚¹è®¾ç½®ä¸åŒçš„åˆå§‹å€¼å¹¶ç»Ÿä¸€æ­¥é•¿ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨ Redis ç”Ÿæˆå”¯ä¸€ä¸”è¶‹åŠ¿é€’å¢çš„ ID äº†ã€‚ä¾‹å¦‚æœ‰ 3 ä¸ª Redis èŠ‚ç‚¹ï¼Œåˆ†åˆ«è®¾ç½®åˆå§‹å€¼ä¸º 1ã€2ã€3 ï¼Œè¿™æ—¶æ­¥é•¿å°±åº”è¯¥å®šä¸º 3 ã€‚è¿™æ ·æ¯ä¸ªèŠ‚ç‚¹ä¸ä¼šç”Ÿæˆé‡å¤çš„ IDã€‚</p><blockquote><p>Incrby ï¼šå°† key ä¸­å‚¨å­˜çš„æ•°å­—åŠ ä¸ŠæŒ‡å®šçš„å¢é‡å€¼ã€‚è¿™æ˜¯ä¸€ä¸ª â€œINCR AND GETâ€ çš„åŸå­æ“ä½œ, ä¸šåŠ¡æ–¹å¯ä»¥å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ key å€¼ï¼Œé€šè¿‡ INCR å‘½ä»¤æ¥è·å–å¯¹åº”çš„ IDã€‚</p></blockquote><p>ä¼˜ç‚¹ï¼š<br>ä¸ä¾èµ–æ•°æ®åº“ï¼Œä¸”æ€§èƒ½ä¼˜äºä¾èµ–æ•°æ®åº“çš„ Flicker æ–¹æ¡ˆã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>æ‰©å±•æ€§ä½ï¼ŒRedis é›†ç¾¤éœ€è¦è®¾ç½®å¥½åˆå§‹å€¼ä¸æ­¥é•¿ã€‚</li><li>Reids å®•æœºå¯èƒ½ä¼šç”Ÿæˆé‡å¤çš„Idã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼šRedis é›†ç¾¤é«˜å¯ç”¨ï¼Œå¹¶å‘é‡é«˜ã€‚</p><h4 id="Leaf"><a href="#Leaf" class="headerlink" title="Leaf"></a>Leaf</h4><p>ä¸Šé¢æåˆ°çš„è¿™äº›å¸¸è§çš„ ID ç”Ÿæˆç­–ç•¥ï¼Œæœ‰æ—¶å¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³å®é™…ç”Ÿäº§ä¸­çš„éœ€æ±‚ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ä¼šå¯¹å…¶åšä¸€äº›æ”¹é€ å’Œä¼˜åŒ–ã€‚</p><p>ç¾å›¢çš„ Leaf åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿ ï¼Œåœ¨ Flicker ç­–ç•¥ ä¸ Snowflake ç®—æ³•çš„åŸºç¡€ä¸Šåšäº†ä¸¤å¥—ä¼˜åŒ–çš„æ–¹æ¡ˆã€‚ä¸‹æ–‡ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ Leaf æ–¹æ¡ˆåšçš„ä¸€äº›ä¼˜åŒ–ï¼Œå¹¶ä¸ä¼šæ·±å…¥åˆ†æã€‚è¯¦ç»†æ–¹æ¡ˆå¤§å®¶å¯ä»¥æŸ¥çœ‹è¿™é‡Œï¼šã€ŠLeaf åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿ ã€‹</p><p>Leaf-segment æ•°æ®åº“æ–¹æ¡ˆ</p><p>ç›¸æ¯”äº Flicker æ–¹æ¡ˆæ¯æ¬¡éƒ½éœ€è¦è¯»å–æ•°æ®åº“ï¼ŒLeaf-segment æ”¹ä¸ºäº†åˆ©ç”¨ proxy server æ‰¹é‡è·å–ï¼Œä¸”åšäº†åŒ buffer çš„ä¼˜åŒ–ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š<br><img src="/2019/04/24/Distributed-ID-Generation/640_1.webp" title="640_1"></p><blockquote><p>åŒ bufferï¼šID åˆ†å·æ®µåŠ è½½ï¼Œä¸”å½“å·æ®µæ¶ˆè´¹åˆ°æŸä¸ªç‚¹æ—¶å°±å¼‚æ­¥çš„æŠŠä¸‹ä¸€ä¸ªå·æ®µåŠ è½½åˆ°å†…å­˜ä¸­ã€‚è€Œä¸éœ€è¦ç­‰åˆ°å·æ®µç”¨å°½çš„æ—¶å€™æ‰å»æ›´æ–°å·æ®µã€‚</p></blockquote><p>Leaf-snowflake æ–¹æ¡ˆ</p><p>ä¸»è¦æ˜¯é’ˆå¯¹æ—¶é’Ÿå›æ‹¨é—®é¢˜åšäº†ç‰¹æ®Šå¤„ç†ã€‚ è‹¥å‘ç”Ÿæ—¶é’Ÿå›æ‹¨åˆ™æ‹’ç»å‘å·ï¼Œå¹¶è¿›è¡Œå‘Šè­¦ã€‚<br><img src="/2019/04/24/Distributed-ID-Generation/640_2.webp" title="640_2"></p><p>é€‚ç”¨åœºæ™¯ï¼šæœåŠ¡è§„æ¨¡è¾ƒå¤§ï¼Œè°ƒç”¨é¢‘ç¹ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…³äºåˆ†å¸ƒå¼ ID çš„ç”Ÿæˆç­–ç•¥æš‚ä¸”ä»‹ç»åˆ°è¿™é‡Œã€‚å…¶å®è¿˜æœ‰ä¸€äº›ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ç™¾åº¦çš„ uid-generatorï¼Œå¾®ä¿¡çš„ SEQSVRã€‚åŸºæœ¬ä¸Šéƒ½æ˜¯éƒ½ä¸Šé¢ä¸€äº›æ–¹æ¡ˆçš„ä¼˜åŒ–ï¼Œè¿™é‡Œå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®è‡ªèº«ä¸šåŠ¡åœºæ™¯æ¥é€‰å–åˆé€‚çš„æ–¹æ¡ˆï¼Œä¹Ÿå¹¶éå¤§è€Œå…¨çš„æ–¹æ¡ˆå°±æ˜¯å¥½çš„æ–¹æ¡ˆã€‚</p><h2 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h2><p>ç‰›åœ¨èˆ’ï¼Œ<a href="https://mp.weixin.qq.com/s/h8dphDS4D36nWyhPCLC7ag" target="_blank" rel="noopener">åˆ†å¸ƒå¼ ID ç”Ÿæˆç­–ç•¥</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;images.png&quot; class=&quot;full-image&quot; alt=
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL æ°´å¹³æ‹†åˆ†è¡¨çš„ä¸€æ¬¡è¸©å‘</title>
    <link href="https://jiemin.wang/2019/04/24/mysql-sharding/"/>
    <id>https://jiemin.wang/2019/04/24/mysql-sharding/</id>
    <published>2019-04-24T09:43:37.000Z</published>
    <updated>2019-04-24T09:56:53.810Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="cbC80KVt.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼</strong></p></blockquote><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰ä¸å°‘äººé—®æˆ‘â€èƒ½å¦åˆ†äº«ä¸€äº›åˆ†åº“åˆ†è¡¨ç›¸å…³çš„å®è·µâ€ï¼Œå…¶å®ä¸æ˜¯æˆ‘ä¸åˆ†äº«ï¼Œè€Œæ˜¯çœŸçš„ç»éªŒä¸å¤šğŸ¤£ï¼›å’Œå¤§éƒ¨åˆ†äººä¸€æ ·éƒ½æ˜¯åœç•™åœ¨ç†è®ºé˜¶æ®µã€‚</p><p>ä¸è¿‡è¿™æ¬¡å¤šå°‘æœ‰äº›å¯ä»¥è¯´é“äº†ã€‚</p><p>å…ˆè°ˆè°ˆèƒŒæ™¯ï¼Œæˆ‘ä»¬ç”Ÿäº§æ•°æ®åº“éšç€ä¸šåŠ¡å‘å±•é‡ä¹Ÿé€æ¸èµ·æ¥ï¼›å¥½å‡ å¼ å•è¡¨å·²ç»çªç ´<strong>äº¿çº§</strong>æ•°æ®ï¼Œå¹¶ä¸”ä¿æŒæ¯å¤© 200+W çš„æ•°æ®é‡å¢åŠ ã€‚</p><p>è€Œæˆ‘ä»¬æœ‰äº›ä¸šåŠ¡éœ€è¦è¿›è¡Œå…³è”æŸ¥è¯¢ã€æˆ–è€…æ˜¯æŠ¥è¡¨ç»Ÿè®¡ï¼›åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å¤§è¡¨çš„é—®é¢˜æ›´åŠ çªå‡ºï¼ˆæ¯”å¦‚ä¸€ä¸ªæŸ¥è¯¢åŠŸèƒ½éœ€è¦è·‘å¥½å‡ åˆ†é’Ÿï¼‰ã€‚</p><a id="more"></a><blockquote><p>å¯èƒ½å¾ˆå¤šäººä¼šè¯´ï¼šä¸ºå•¥å•è¡¨éƒ½è¿‡äº¿äº†æ‰æƒ³æ–¹æ¡ˆè§£å†³ï¼Ÿå…¶å®ä¸æ˜¯ä¸æƒ³ï¼Œè€Œæ˜¯ç”±äºå†å²åŸå› åŠ ä¸Šé”™è¯¯é¢„ä¼°äº†æ•°æ®å¢é•¿æ‰å¯¼è‡´è¿™ä¸ªå±€é¢ã€‚æ€»ä¹‹åŸå› æ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿä¸æ˜¯æœ¬æ¬¡è®¨è®ºçš„é‡ç‚¹ã€‚</p></blockquote><h1 id="ä¸´æ—¶æ–¹æ¡ˆ"><a href="#ä¸´æ—¶æ–¹æ¡ˆ" class="headerlink" title="ä¸´æ—¶æ–¹æ¡ˆ"></a>ä¸´æ—¶æ–¹æ¡ˆ</h1><p>ç”±äºéœ€æ±‚ç´§ã€äººæ‰‹ç¼ºçš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ªå¤„ç†çš„è¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µã€‚</p><p>ç¬¬ä¸€é˜¶æ®µåº”è¯¥æ˜¯å»å¹´åº•ï¼Œå½“æ—¶è¿ç»´ååº” <code>MySQL</code> æ‰€åœ¨çš„ä¸»æœºå†…å­˜å ç”¨å¾ˆé«˜ï¼Œæ•´ä½“è´Ÿè½½ä¹Ÿå±…é«˜ä¸ä¸‹ï¼Œå¯¼è‡´æ•´ä¸ª MySQL çš„ååé‡æ˜æ˜¾é™ä½ï¼ˆå†™å…¥ã€æŸ¥è¯¢æ•°æ®éƒ½æ˜æ˜¾å‡æ…¢ï¼‰ã€‚</p><p>ä¸ºæ­¤æˆ‘ä»¬æ‰¾å‡ºäº†æ•°æ®é‡æœ€å¤§çš„å‡ å¼ è¡¨ï¼Œå‘ç°å¤§éƒ¨åˆ†æ•°æ®é‡åœ¨7/8000W å·¦å³ï¼Œå°‘æ•°çš„å·²ç»çªç ´ä¸€äº¿ã€‚</p><p>é€šè¿‡ä¸šåŠ¡å±‚é¢è¿›è¡Œåˆ†æå‘ç°ï¼Œè¿™äº›æ•°æ®å¤šæ•°éƒ½æ˜¯ç”¨æˆ·äº§ç”Ÿçš„ä¸€äº›<strong>æ—¥å¿—å‹æ•°æ®</strong>ï¼Œè€Œä¸”è¿™äº›æ•°æ®åœ¨ä¸šåŠ¡ä¸Šå¹¶ä¸æ˜¯å¼ºç›¸å…³çš„ï¼Œç”šè‡³ä¸¤ä¸‰ä¸ªæœˆå‰çš„æ•°æ®å…¶å®å·²ç»ä¸éœ€è¦å®æ—¶æŸ¥è¯¢äº†ã€‚</p><p>å› ä¸ºæ¥è¿‘å¹´åº•ï¼Œå°½å¯èƒ½çš„ä¸æƒ³å»åŠ¨åº”ç”¨ï¼Œè€ƒè™‘æ˜¯å¦å¯ä»¥åœ¨è¿ç»´å±‚é¢ç¼“è§£å‹åŠ›ï¼›ä¸»è¦çš„ç›®çš„å°±æ˜¯æŠŠå•è¡¨çš„æ•°æ®é‡é™ä½ã€‚</p><p>åŸæœ¬æ˜¯æƒ³æŠŠä¸¤ä¸ªæœˆä¹‹å‰çš„æ•°æ®ç›´æ¥è¿ç§»å‡ºæ¥æ”¾åˆ°å¤‡ä»½è¡¨ä¸­ï¼Œä½†åœ¨å‡†å¤‡å®æ–½çš„è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªå¤§å‘ã€‚</p><blockquote><p>è¡¨ä¸­æ²¡æœ‰ä¸€ä¸ªå¯ä»¥æ’åºçš„ç´¢å¼•ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•å¿«é€Ÿçš„ç­›é€‰å‡ºä¸€éƒ¨åˆ†æ•°æ®ï¼è¿™çœŸæ˜¯ä¸€ä¸ªæ·±å‘ï¼Œä¸ºåé¢çš„ä¸€äº›ä¼˜åŒ–åŸ‹äº†ä¸ªåœ°é›·ï¼›å³ä¾¿æ˜¯åŠ ç´¢å¼•ä¹Ÿéœ€è¦èŠ±å‡ ä¸ªå°æ—¶ï¼ˆå…·ä½“å¤šä¹…æ²¡æ•¢åœ¨ç”Ÿäº§æµ‹è¯•ï¼‰ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬å¼ºè¡ŒæŒ‰ç…§æ—¶é—´è¿›è¡Œç­›é€‰ï¼Œå¯èƒ½æŸ¥è¯¢å‡º 4000W çš„æ•°æ®å°±å¾—èŠ±ä¸Šå¥½å‡ ä¸ªå°æ—¶ï¼›è¿™æ˜¾ç„¶æ˜¯è¡Œä¸é€šçš„ã€‚</p><p>äºæ˜¯æˆ‘ä»¬ä¾¿æƒ³åˆ°äº†ä¸€ä¸ªå¤§èƒ†çš„æƒ³æ³•ï¼šè¿™éƒ¨åˆ†æ•°æ®æ˜¯å¦å¯ä»¥ç›´æ¥ä¸è¦äº†ï¼Ÿ</p><p>è¿™å¯èƒ½æ˜¯æœ€æœ‰æ•ˆåŠæœ€å¿«çš„æ–¹å¼äº†ï¼Œå’Œäº§å“æ²Ÿé€šåå¾—çŸ¥è¿™éƒ¨åˆ†æ•°æ®çœŸçš„åªæ˜¯æ—¥å¿—å‹çš„æ•°æ®ï¼Œå³ä¾¿æ˜¯æŠ¥è¡¨å‡ºä¸æ¥ä»Šåè¡¥ä¸Šä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>äºæ˜¯æˆ‘ä»¬å°±ç®€å•ç²—æš´çš„åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><ul><li>ä¿®æ”¹åŸæœ‰è¡¨çš„è¡¨åï¼Œæ¯”å¦‚åŠ ä¸Š(<code>_190416bak</code>)ã€‚</li><li>å†æ–°å»ºä¸€å¼ å’ŒåŸæœ‰è¡¨åç§°ç›¸åŒçš„è¡¨ã€‚</li></ul><p>è¿™æ ·æ–°çš„æ•°æ®å°±å†™åˆ°äº†æ–°è¡¨ï¼ŒåŒæ—¶ä¸šåŠ¡ä¸Šä¹Ÿæ˜¯ä½¿ç”¨çš„è¿™ä¸ªæ•°æ®é‡è¾ƒå°çš„æ–°è¡¨ã€‚</p><p>è™½è¯´è¿‡ç¨‹ä¸å¤ªä¼˜é›…ï¼Œä½†è‡³å°‘æ˜¯è§£å†³äº†é—®é¢˜åŒæ—¶ä¹Ÿç»™æˆ‘ä»¬åšæŠ€æœ¯æ”¹é€ é¢„ç•™äº†æ—¶é—´ã€‚</p><h1 id="åˆ†è¡¨æ–¹æ¡ˆ"><a href="#åˆ†è¡¨æ–¹æ¡ˆ" class="headerlink" title="åˆ†è¡¨æ–¹æ¡ˆ"></a>åˆ†è¡¨æ–¹æ¡ˆ</h1><p>ä¹‹å‰çš„æ–¹æ¡ˆè™½è¯´å¯ä»¥ç¼“è§£å‹åŠ›ï¼Œä½†ä¸èƒ½æ ¹æœ¬è§£å†³é—®é¢˜ã€‚</p><p>æœ‰äº›ä¸šåŠ¡å¿…é¡»å¾—æŸ¥è¯¢ä¹‹å‰çš„æ•°æ®ï¼Œå¯¼è‡´ä¹‹å‰é‚£æ‹›è¡Œä¸é€šäº†ï¼Œæ‰€ä»¥æ­£å¥½æˆ‘ä»¬å°±å€ŸåŠ©è¿™ä¸ªæœºä¼šæŠŠè¡¨åˆ†äº†ã€‚</p><p>æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººè™½è¯´æ²¡æœ‰åšè¿‡å®é™…åšè¿‡åˆ†è¡¨ï¼Œä½†ä¹Ÿè§è¿‡çŒªè·‘ï¼›ç½‘ä¸Šä¸€æœå„ç§æ–¹æ¡ˆå±‚å‡ºä¸ç©·ã€‚</p><p>æˆ‘è®¤ä¸ºæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯è¦ç»“åˆå®é™…ä¸šåŠ¡æ‰¾å‡ºéœ€è¦ sharding çš„å­—æ®µï¼ŒåŒæ—¶è¿˜æœ‰ä¸Šçº¿é˜¶æ®µçš„æ•°æ®è¿ç§»ä¹Ÿéå¸¸é‡è¦ã€‚</p><h2 id="æ—¶é—´"><a href="#æ—¶é—´" class="headerlink" title="æ—¶é—´"></a>æ—¶é—´</h2><p>å¯èƒ½å¤§å®¶éƒ½ä¼šè¯´ç”¨ hash çš„æ–¹å¼åˆ†é…å¾—æœ€å‡åŒ€ï¼Œä½†æˆ‘è®¤ä¸ºè¿™è¿˜æ˜¯éœ€è¦ä½¿ç”¨å†å²æ•°æ®çš„åœºæ™¯æ‰ç”¨å“ˆå¸Œåˆ†è¡¨ã€‚</p><p>è€Œå¯¹äºä¸éœ€è¦å†å²æ•°æ®çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸šåŠ¡ä¸ŠåªæŸ¥è¯¢è¿‘ä¸‰ä¸ªæœˆçš„æ•°æ®ã€‚</p><p>è¿™ç±»éœ€æ±‚å®Œæˆå¯ä»¥é‡‡å–æ—¶é—´åˆ†è¡¨ï¼ŒæŒ‰ç…§æœˆä»½è¿›è¡Œåˆ’åˆ†ï¼Œè¿™æ ·æ”¹åŠ¨ç®€å•ï¼ŒåŒæ—¶å¯¹å†å²æ•°æ®ä¹Ÿæ¯”è¾ƒå¥½è¿ç§»ã€‚</p><p>äºæ˜¯æˆ‘ä»¬é¦–å…ˆå°†è¿™ç±»éœ€æ±‚çš„è¡¨ç­›é€‰å‡ºæ¥ï¼ŒæŒ‰ç…§æœˆä»½è¿›è¡Œæ‹†åˆ†ï¼Œåªæ˜¯åœ¨æŸ¥è¯¢çš„æ—¶å€™æ‹¼æ¥å¥½è¡¨åå³å¯ï¼›ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚</p><h2 id="å“ˆå¸Œ"><a href="#å“ˆå¸Œ" class="headerlink" title="å“ˆå¸Œ"></a>å“ˆå¸Œ</h2><p>åˆšæ‰ä¹Ÿæåˆ°äº†ï¼šéœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œåˆ†è¡¨ç­–ç•¥ã€‚</p><p>è€Œä¸€æ—¦æ‰€æœ‰çš„æ•°æ®éƒ½æœ‰å¯èƒ½æŸ¥è¯¢æ—¶ï¼ŒæŒ‰ç…§æ—¶é—´åˆ†è¡¨ä¹Ÿå°±è¡Œä¸é€šäº†ã€‚ï¼ˆä¹Ÿèƒ½åšï¼Œåªæ˜¯å¦‚æœä¸æ˜¯æŒ‰ç…§æ—¶é—´è¿›è¡ŒæŸ¥è¯¢æ—¶éœ€è¦éå†æ‰€æœ‰çš„è¡¨ï¼‰</p><p>å› æ­¤æˆ‘ä»¬è®¡åˆ’é‡‡ç”¨ <code>hash</code> çš„æ–¹å¼åˆ†è¡¨ï¼Œè¿™ç®—æ˜¯ä¸šç•Œæ¯”è¾ƒä¸»æµçš„æ–¹å¼å°±ä¸å†èµ˜è¿°ã€‚</p><p>é‡‡ç”¨å“ˆå¸Œæ—¶éœ€è¦å°† <code>sharding</code> å­—æ®µé€‰å¥½ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡æ¯”è¾ƒå•çº¯ï¼›æ˜¯ä¸€ä¸ªç‰©è”ç½‘åº”ç”¨ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½åŒ…å«æœ‰ç‰©è”ç½‘è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼ˆIMEIï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå­—æ®µå¤©ç„¶çš„å°±ä¿æŒäº†å”¯ä¸€æ€§ï¼›å¤§å¤šæ•°çš„ä¸šåŠ¡ä¹Ÿéƒ½æ˜¯æ ¹æ®è¿™ä¸ªå­—æ®µæ¥çš„ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆæ¥åšè¿™ä¸ª <code>sharding</code> å­—æ®µã€‚</p><p>åœ¨åšåˆ†è¡¨ä¹‹å‰ä¹Ÿè°ƒç ”è¿‡ <code>MyCAT</code> åŠ <code>sharding-jdbc</code>(ç°å·²å‡çº§ä¸º <code>shardingsphere</code>)ï¼Œæœ€ç»ˆè€ƒè™‘åˆ°å¯¹å¼€å‘çš„å‹å¥½æ€§åŠä¸å¢åŠ è¿ç»´å¤æ‚åº¦è¿˜æ˜¯å†³å®šåœ¨ jdbc å±‚ sharding çš„æ–¹å¼ã€‚</p><p>ä½†ç”±äºå†å²åŸå› æˆ‘ä»¬å¹¶ä¸å¤ªå¥½é›†æˆ <code>sharding-jdbc</code>ï¼Œä½†åŸºäº <code>sharding</code> çš„ç‰¹ç‚¹è‡ªå·±å®ç°äº†ä¸€ä¸ªåˆ†è¡¨ç­–ç•¥ã€‚</p><p>è¿™ä¸ªç®€å•ä¹Ÿå¥½ç†è§£ï¼š</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> index = hash(shardingå­—æ®µ) % åˆ†è¡¨æ•°é‡ ;</span><br><span class="line"></span><br><span class="line">select xx from <span class="string">'busy_'</span>+index where shardingå­—æ®µ = xxx;</span><br></pre></td></tr></tbody></table></figure><p>å…¶å®å°±æ˜¯ç®—å‡ºäº†è¡¨åï¼Œç„¶åè·¯ç”±è¿‡å»æŸ¥è¯¢å³å¯ã€‚</p><p>åªæ˜¯æˆ‘ä»¬å®ç°çš„éå¸¸ç®€å•ï¼šä¿®æ”¹äº†æ‰€æœ‰çš„åº•å±‚æŸ¥è¯¢æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½é‡Œéƒ½åšäº†è¿™æ ·çš„ä¸€ä¸ªåˆ¤æ–­ã€‚</p><p>å¹¶æ²¡æœ‰åƒ <code>sharding-jdbc</code> ä¸€æ ·ï¼Œä»£ç†äº†æ•°æ®åº“çš„æŸ¥è¯¢æ–¹æ³•ï¼›å…¶ä¸­è¿˜è¦åš <code>SQLè§£æ-->SQLè·¯ç”±-->æ‰§è¡ŒSQL-->åˆå¹¶ç»“æœ</code> è¿™ä¸€ç³»åˆ—çš„æµç¨‹ã€‚</p><p>å¦‚æœè‡ªå·±å†åšä¸€éæ— å¼‚äºé‡æ–°é€ äº†ä¸€ä¸ªè½®å­ï¼Œå¹¶ä¸”å¹¶ä¸ä¸“ä¸šï¼Œåªæ˜¯åœ¨ç°æœ‰çš„æŠ€æœ¯æ¡ä»¶ä¸‹é€‰æ‹©äº†ä¸€ä¸ªå¿«é€Ÿå®ç°è¾¾æˆæ•ˆæœçš„æ–¹æ³•ã€‚</p><p>ä¸è¿‡è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬èŠ‚çœäº†å°† sharding å­—æ®µå“ˆå¸Œçš„è¿‡ç¨‹ï¼Œå› ä¸ºæ¯ä¸€ä¸ª IMEI å·å…¶å®éƒ½æ˜¯ä¸€ä¸ªå”¯ä¸€çš„æ•´å‹ï¼Œç›´æ¥ç”¨å®ƒåš mod è¿ç®—å³å¯ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªæ˜¯éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„ç»„ä»¶ç”Ÿæˆè§„åˆ™ï¼Œåˆ†è¡¨åä¸èƒ½å†ä¾èµ–äºå•è¡¨çš„å­—æ®µè‡ªå¢äº†ï¼›æ–¹æ³•è¿˜æ˜¯æŒºå¤šçš„ï¼š</p><ul><li>æ¯”å¦‚æ—¶é—´æˆ³+éšæœºæ•°å¯æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡ã€‚</li><li>UUIDï¼Œç”Ÿæˆç®€å•ï¼Œä½†æ²¡æ³•åšæ’åºã€‚</li><li>é›ªèŠ±ç®—æ³•ç»Ÿä¸€ç”Ÿæˆä¸»é”®IDã€‚</li></ul><p>å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µåšé€‰æ‹©ã€‚</p><h1 id="ä¸šåŠ¡è°ƒæ•´"><a href="#ä¸šåŠ¡è°ƒæ•´" class="headerlink" title="ä¸šåŠ¡è°ƒæ•´"></a>ä¸šåŠ¡è°ƒæ•´</h1><p>å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ sharding-jdbc ç»„ä»¶ï¼Œæ‰€æœ‰æ²¡æœ‰åŠæ³•åšåˆ°å¯¹ä»£ç çš„ä½ä¾µå…¥æ€§ï¼›æ¯ä¸ªæ¶‰åŠåˆ°åˆ†è¡¨çš„ä¸šåŠ¡ä»£ç éƒ½éœ€è¦åšåº•å±‚æ–¹æ³•çš„æ”¹é€ ï¼ˆä¹Ÿå°±æ˜¯è·¯ç”±åˆ°æ­£ç¡®çš„è¡¨ï¼‰ã€‚</p><p>è€ƒè™‘åˆ°åç»­ä¸šåŠ¡çš„å‘å±•ï¼Œæˆ‘ä»¬å†³å®šå°†æ‹†åˆ†çš„è¡¨åˆ†ä¸º 64 å¼ ï¼›åŠ ä¸Šåç»­å¼•å…¥å¤§æ•°æ®å¹³å°è¶³ä»¥åº”å¯¹å‡ å¹´çš„æ•°æ®å¢é•¿ã€‚</p><blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼šåˆ†è¡¨çš„æ•°é‡éœ€è¦ä¸º 2âˆ§N æ¬¡æ–¹ï¼Œå› ä¸ºåœ¨å–æ¨¡çš„è¿™ç§åˆ†è¡¨æ–¹å¼ä¸‹ï¼Œå³ä¾¿æ˜¯ä»Šåå†éœ€è¦åˆ†è¡¨å½±å“çš„æ•°æ®ä¹Ÿä¼šå°½é‡çš„å°ã€‚</p></blockquote><p>å†ä¿®æ”¹æ—¶åªèƒ½å°†è¡¨åç§°è¿›è¡Œå…¨å±€æœç´¢ï¼Œç„¶ååŠ ä»¥ä¿®æ”¹ï¼ŒåŒæ—¶æ ¹æ®ä¿®æ”¹çš„æ–¹æ³•å€’æ¨åˆ°è¡¨ç°çš„ä¸šåŠ¡å¹¶è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿åç»­å›å½’æµ‹è¯•ã€‚</p><hr><p>å½“ç„¶æ— æ³•é¿å…æŸ¥è¯¢æ—¶åˆ©ç”¨é sharding å­—æ®µå¯¼è‡´çš„å…¨è¡¨æ‰«æï¼Œè¿™æ˜¯æ‰€æœ‰åˆ†ç‰‡åéƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚</p><p>å› æ­¤æˆ‘ä»¬åœ¨ä¿®æ”¹åˆ†è¡¨æ–¹æ³•çš„åº•å±‚æŸ¥è¯¢æ—¶åŒæ—¶ä¹Ÿä¼šæŸ¥çœ‹æ˜¯å¦æœ‰èµ°åˆ†ç‰‡å­—æ®µï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£æ˜¯å¦å¯ä»¥è°ƒæ•´ä¸šåŠ¡ã€‚</p><p>æ¯”å¦‚å¯¹äºä¸€ä¸ªä¸Šäº¿çš„æ•°æ®æ˜¯å¦è¿˜æœ‰å¿…è¦å­˜åœ¨æŒ‰ç…§åˆ†é¡µæŸ¥è¯¢ã€æ—¥æœŸæŸ¥è¯¢ï¼Ÿè¿™æ ·çš„ä¸šåŠ¡æ˜¯å¦çœŸçš„å…·æœ‰æ„ä¹‰ï¼Ÿ</p><p>æˆ‘ä»¬å°½å¯èƒ½çš„å¼•å¯¼äº§å“æŒ‰ç…§è¿™æ ·çš„æ–¹å¼æ¥è®¾è®¡äº§å“æˆ–è€…åšå‡ºè°ƒæ•´ã€‚</p><p>ä½†å¯¹äºæŠ¥è¡¨è¿™ç±»çš„éœ€æ±‚ç¡®å®ä¹Ÿæ²¡åŠæ³•ï¼Œæ¯”å¦‚ç»Ÿè®¡è¡¨ä¸­æŸç§ç±»å‹çš„æ•°æ®ï¼›è¿™ç§æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼å»å¹¶è¡ŒæŸ¥è¯¢ç„¶åæ±‡æ€»ç»Ÿè®¡æ¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</p><p>æœ‰æ—¶ä¹Ÿæœ‰ä¸€äº›å¦ç±»åœºæ™¯ï¼š</p><blockquote><p>æ¯”å¦‚ä¸€ä¸ªåƒä¸‡è¡¨ä¸­æœ‰æŸä¸€ç‰¹æ®Šç±»å‹çš„æ•°æ®åªå äº†å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚è¯´å‡ åƒä¸Šä¸‡æ¡ã€‚</p></blockquote><p>è¿™æ—¶é¡µé¢ä¸Šéœ€è¦å¯¹å®ƒè¿›è¡Œåˆ†é¡µæŸ¥è¯¢æ˜¯æ¯”è¾ƒæ­£å¸¸çš„ï¼ˆæ¯”å¦‚æŸç§æŠ•è¯‰æ¶ˆæ¯ï¼Œå®¢æˆ·éœ€è¦ä¸€æ¡ä¸€æ¡çš„å•ç‹¬å¤„ç†ï¼‰ï¼Œä½†å¦‚æœæˆ‘ä»¬æŒ‰ç…§ IMEI å·æˆ–è€…æ˜¯ä¸»é”®è¿›è¡Œåˆ†ç‰‡åå†åˆ†é¡µæŸ¥è¯¢é‚£å°±æ¯”è¾ƒè›‹ç–¼äº†ã€‚</p><p>æ‰€ä»¥è¿™ç±»å‹çš„æ•°æ®å»ºè®®å•ç‹¬æ–°å»ºä¸€å¼ è¡¨æ¥ç»´æŠ¤ï¼Œä¸è¦å’Œå…¶ä»–æ•°æ®æ··åˆåœ¨ä¸€èµ·ï¼Œè¿™æ ·ä¸ç®¡æ˜¯åšåˆ†é¡µè¿˜æ˜¯ like éƒ½æ¯”è¾ƒç®€å•å’Œç‹¬ç«‹ã€‚</p><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>ä»£ç æ”¹å®Œï¼Œå¼€å‘ä¹Ÿå•æµ‹å®Œæˆåæ€ä¹ˆæ¥éªŒè¯åˆ†è¡¨çš„ä¸šåŠ¡æ˜¯å¦æ­£å¸¸ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚</p><p>ä¸€ä¸ªæ˜¯æµ‹è¯•éº»çƒ¦ï¼Œå†ä¸€ä¸ªæ˜¯ä¸‡ä¸€å“ªé‡Œæ”¹æ¼äº†è¿˜æ˜¯æŸ¥è¯¢çš„åŸè¡¨ï¼Œä½†è¿™æ ·åœ¨æµ‹è¯•ç¯å¢ƒå¹¶ä¸ä¼šæœ‰å¼‚å¸¸ï¼Œä¸€æ—¦ä¸Šçº¿äº§ç”Ÿäº†ç”Ÿäº§æ•°æ®åˆ°æ–°çš„ 64 å¼ è¡¨åæƒ³è¦å†ä¿®å¤å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å–äº†ä¸ªå·§ï¼Œç›´æ¥å°†åŸè¡¨çš„è¡¨åä¿®æ”¹ï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªåç¼€ï¼›è¿™æ ·åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­è§‚å¯Ÿå‰åå°æœ‰æ— æŠ¥é”™å°±æ¯”è¾ƒå®¹æ˜“æå‰å‘ç°è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="ä¸Šçº¿æµç¨‹"><a href="#ä¸Šçº¿æµç¨‹" class="headerlink" title="ä¸Šçº¿æµç¨‹"></a>ä¸Šçº¿æµç¨‹</h1><p>æµ‹è¯•éªŒæ”¶é€šè¿‡ååªæ˜¯åˆ†è¡¨è¿™ä¸ªéœ€æ±‚çš„80%ï¼Œå‰©ä¸‹å¦‚ä½•ä¸Šçº¿ä¹Ÿæ˜¯æ¯”è¾ƒå¤´ç–¼ã€‚</p><p>ä¸€æ—¦åº”ç”¨ä¸Šçº¿åæ‰€æœ‰çš„æŸ¥è¯¢ã€å†™å…¥ã€åˆ é™¤éƒ½ä¼šå…ˆèµ°è·¯ç”±ç„¶ååˆ°è¾¾æ–°è¡¨ï¼›è€Œè€æ•°æ®åœ¨åŸè¡¨é‡Œæ˜¯ä¸ä¼šå‘ç”Ÿæ”¹å˜çš„ã€‚</p><h2 id="æ•°æ®è¿ç§»"><a href="#æ•°æ®è¿ç§»" class="headerlink" title="æ•°æ®è¿ç§»"></a>æ•°æ®è¿ç§»</h2><p>æ‰€ä»¥æˆ‘ä»¬ä¸Šçº¿å‰çš„ç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯éœ€è¦å°†åŸæœ‰çš„æ•°æ®è¿›è¡Œè¿ç§»ï¼Œè¿ç§»çš„ç›®çš„æ˜¯è¦åˆ†ç‰‡åˆ°æ–°çš„ 64 å¼ è¡¨ä¸­ï¼Œè¿™æ ·æ‰ä¼šå¯¹åŸæœ‰çš„ä¸šåŠ¡æ— å½±å“ã€‚</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦é¢å¤–å‡†å¤‡ä¸€ä¸ªç¨‹åºï¼Œå®ƒéœ€è¦å°†è€è¡¨é‡Œçš„æ•°æ®æŒ‰ç…§åˆ†ç‰‡è§„åˆ™å¤åˆ¶åˆ°æ–°è¡¨ä¸­ï¼›</p><p>åœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œç”Ÿäº§æ•°æ®æœ‰äº›å·²ç»ä¸Šäº¿äº†ï¼Œè¿™ä¸ªè¿ç§»è¿‡ç¨‹æˆ‘ä»¬åœ¨æµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿå‘ç°è€—æ—¶æ˜¯éå¸¸ä¹…çš„ã€‚è€Œä¸”æˆ‘ä»¬è€è¡¨ä¸­å¯¹äº <code>create_time</code> è¿™æ ·ç”¨äºç­›é€‰æ•°æ®çš„å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼ˆä»¥å‰çš„æŠ€æœ¯å€ºï¼‰ï¼Œæ‰€ä»¥æŸ¥è¯¢èµ·æ¥å°±æ›´åŠ æ…¢äº†ã€‚</p><p>æœ€åæ²¡åŠæ³•ï¼Œæˆ‘ä»¬åªèƒ½å’Œäº§å“åå•†å‘ŠçŸ¥ç”¨æˆ·å¯¹äºä¹‹å‰äº§ç”Ÿçš„æ•°æ®çŸ­æœŸå¯èƒ½ä¼šæŸ¥è¯¢ä¸åˆ°ï¼Œè¿™ä¸ªæ—¶é—´æœ€åå¯èƒ½ä¼šæŒç»­å‡ å¤©ï¼ˆæˆ‘ä»¬åªèƒ½åœ¨å‡Œæ™¨è¿ç§»ï¼Œç™½å¤©ä¼šå½±å“åˆ°æ•°æ®åº“è´Ÿè½½ï¼‰ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¾¿æ˜¯æˆ‘ä»¬è¿™æ¬¡çš„åˆ†è¡¨å®è·µï¼Œè™½è¯´ä¸å°‘è¿‡ç¨‹éƒ½ä¸ä¼˜é›…ï¼Œä½†å—é™äºæ¡ä»¶ä¹Ÿåªèƒ½æŠ˜ä¸­å¤„ç†ã€‚</p><p>ä½†æˆ‘ä»¬åç»­çš„è®¡åˆ’æ˜¯ï¼Œä¿®æ”¹æˆ‘ä»¬åº•å±‚çš„æ•°æ®è¿æ¥ï¼ˆç›®å‰æ˜¯è‡ªå·±å°è£…çš„ä¸€ä¸ª jar åŒ…ï¼Œå¯¼è‡´é›†æˆ sharding-jdbc æ¯”è¾ƒéº»çƒ¦ï¼‰æœ€ç»ˆé€æ¸è¿ç§»åˆ° <code>sharding-jdbc</code> .</p><p>æœ€åå¾—å‡ºäº†å‡ ä¸ªç»“è®ºï¼š</p><ul><li>ä¸€ä¸ªå¥½çš„äº§å“è§„åˆ’éå¸¸æœ‰å¿…è¦ï¼Œå¯ä»¥åœ¨åˆç†çš„æ—¶é—´å¯¹æ•°æ®å¤„ç†ï¼ˆä¸ç®¡æ˜¯åˆ†è¡¨è¿˜æ˜¯åˆ‡å…¥å½’æ¡£ï¼‰ã€‚</li><li>æ¯å¼ è¡¨éƒ½éœ€è¦ä¸€ä¸ªå¯ä»¥ç”¨äºæ’åºæŸ¥è¯¢çš„å­—æ®µï¼ˆè‡ªå¢IDã€åˆ›å»ºæ—¶é—´ï¼‰ï¼Œæ•´ä¸ªè¿‡ç¨‹ç”±äºæ²¡æœ‰è¿™ä¸ªå­—æ®µå¯¼è‡´è€½æäº†å¾ˆé•¿æ—¶é—´ã€‚</li><li>åˆ†è¡¨å­—æ®µéœ€è¦è°¨æ…ï¼Œè¦å…¨ç›˜çš„è€ƒè™‘ä¸šåŠ¡æƒ…å†µï¼Œå°½é‡é¿å…å‡ºç°æŸ¥è¯¢æ‰«è¡¨çš„æƒ…å†µã€‚</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;cbC80KVt.gif&quot; class=&quot;full-image&quot; alt=&quot;alt&quot; title=&quot;title&quot;&gt;&lt;meta itemprop=&quot;width&quot; content=&quot;auto&quot;&gt;&lt;meta itemprop=&quot;height&quot; content=&quot;auto&quot;&gt;&lt;/span&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;p&gt;&lt;strong&gt;èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;ä¹‹å‰ä¸å°‘äººé—®æˆ‘â€èƒ½å¦åˆ†äº«ä¸€äº›åˆ†åº“åˆ†è¡¨ç›¸å…³çš„å®è·µâ€ï¼Œå…¶å®ä¸æ˜¯æˆ‘ä¸åˆ†äº«ï¼Œè€Œæ˜¯çœŸçš„ç»éªŒä¸å¤šğŸ¤£ï¼›å’Œå¤§éƒ¨åˆ†äººä¸€æ ·éƒ½æ˜¯åœç•™åœ¨ç†è®ºé˜¶æ®µã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡è¿™æ¬¡å¤šå°‘æœ‰äº›å¯ä»¥è¯´é“äº†ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆè°ˆè°ˆèƒŒæ™¯ï¼Œæˆ‘ä»¬ç”Ÿäº§æ•°æ®åº“éšç€ä¸šåŠ¡å‘å±•é‡ä¹Ÿé€æ¸èµ·æ¥ï¼›å¥½å‡ å¼ å•è¡¨å·²ç»çªç ´&lt;strong&gt;äº¿çº§&lt;/strong&gt;æ•°æ®ï¼Œå¹¶ä¸”ä¿æŒæ¯å¤© 200+W çš„æ•°æ®é‡å¢åŠ ã€‚&lt;/p&gt;
&lt;p&gt;è€Œæˆ‘ä»¬æœ‰äº›ä¸šåŠ¡éœ€è¦è¿›è¡Œå…³è”æŸ¥è¯¢ã€æˆ–è€…æ˜¯æŠ¥è¡¨ç»Ÿè®¡ï¼›åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å¤§è¡¨çš„é—®é¢˜æ›´åŠ çªå‡ºï¼ˆæ¯”å¦‚ä¸€ä¸ªæŸ¥è¯¢åŠŸèƒ½éœ€è¦è·‘å¥½å‡ åˆ†é’Ÿï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL5.7 GTIDåŸç†ä¸å®æˆ˜</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-GTID/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-GTID/</id>
    <published>2019-04-22T06:14:52.000Z</published>
    <updated>2019-04-22T07:33:26.786Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="aaa.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>å·¥ä½œå¤šå¹´ï¼Œå½“äººå®¶é—®ä½ æ˜¯ä¸æ˜¯åˆå…¥ç¤¾ä¼šï¼Œä¸æ˜¯å› ä¸ºä½ çœ‹èµ·æ¥å¹´è½»ï¼Œè€Œæ˜¯å› ä¸ºè§‰å¾—ä½ æ€ä¹ˆè¿™ä¹ˆç¬¨ã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h4 id="GTIDæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#GTIDæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="GTIDæ˜¯ä»€ä¹ˆï¼Ÿ"></a>GTIDæ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>GTID æ˜¯<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html" target="_blank" rel="noopener">Global Transaction Identifiers</a>çš„ç¼©å†™ï¼Œç®€ç§°GTID</p><h4 id="GTIDç»„æˆå’Œæ¶æ„"><a href="#GTIDç»„æˆå’Œæ¶æ„" class="headerlink" title="GTIDç»„æˆå’Œæ¶æ„"></a>GTIDç»„æˆå’Œæ¶æ„</h4><p>1) <code>GTID = source_id:transaction_id</code><br>2) server_uuid æ¥æºäº auto.cnf<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3E11FA47-71CA-11E1-9E33-C80AA9429562</span><br></pre></td></tr></tbody></table></figure><p></p><p>3) GTID: åœ¨ä¸€ç»„å¤åˆ¶ä¸­ï¼Œå…¨å±€å”¯ä¸€</p><p>The syntax for a GTID set is as follows:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gtid_set:</span><br><span class="line">    uuid_set [, uuid_set] ...</span><br><span class="line">    | <span class="string">''</span></span><br><span class="line"></span><br><span class="line">uuid_set:</span><br><span class="line">    uuid:interval[:interval]...</span><br><span class="line"></span><br><span class="line">uuid:</span><br><span class="line">    hhhhhhhh-hhhh-hhhh-hhhh-hhhhhhhhhhhh</span><br><span class="line"></span><br><span class="line">h:</span><br><span class="line">    [0-9|A-F]</span><br><span class="line"></span><br><span class="line">interval:</span><br><span class="line">    n[-n]</span><br><span class="line"></span><br><span class="line">    (n >= 1)</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>mysql.gtid_executedè¡¨</code>çš„å‹ç¼©ç”±åä¸º<code>thread</code>/<code>sql</code>/<code>compress_gtid_table</code>çš„ä¸“ç”¨å‰å°çº¿ç¨‹æ‰§è¡Œã€‚ æ­¤çº¿ç¨‹æœªåœ¨<code>SHOW PROCESSLIST</code>çš„è¾“å‡ºä¸­åˆ—å‡ºï¼Œä½†å¯ä»¥å°†å…¶è§†ä¸ºçº¿ç¨‹è¡¨ä¸­çš„ä¸€è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql> SELECT * FROM performance_schema.threads WHERE NAME LIKE <span class="string">'%gtid%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">          THREAD_ID: 26</span><br><span class="line">               NAME: thread/sql/compress_gtid_table</span><br><span class="line">               TYPE: FOREGROUND</span><br><span class="line">     PROCESSLIST_ID: 1</span><br><span class="line">   PROCESSLIST_USER: NULL</span><br><span class="line">   PROCESSLIST_HOST: NULL</span><br><span class="line">     PROCESSLIST_DB: NULL</span><br><span class="line">PROCESSLIST_COMMAND: Daemon</span><br><span class="line">   PROCESSLIST_TIME: 1509</span><br><span class="line">  PROCESSLIST_STATE: Suspending</span><br><span class="line">   PROCESSLIST_INFO: NULL</span><br><span class="line">   PARENT_THREAD_ID: 1</span><br><span class="line">               ROLE: NULL</span><br><span class="line">       INSTRUMENTED: YES</span><br><span class="line">            HISTORY: YES</span><br><span class="line">    CONNECTION_TYPE: NULL</span><br><span class="line">       THREAD_OS_ID: 18677</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="GTIDå’ŒBinlogçš„å…³ç³»"><a href="#GTIDå’ŒBinlogçš„å…³ç³»" class="headerlink" title="GTIDå’ŒBinlogçš„å…³ç³»"></a>GTIDå’ŒBinlogçš„å…³ç³»</h5><ul><li><p>GTIDåœ¨binlogä¸­çš„ç»“æ„</p><img src="/2019/04/22/mysql-GTID/binlog_gtid.jpg" title="binlog_gtid"></li><li><p>GTID event ç»“æ„</p></li><li><p>Previous_gtid_log_event</p></li></ul><ol><li><code>Previous_gtid_log_event</code> åœ¨æ¯ä¸ªbinlog å¤´éƒ¨éƒ½ä¼šæœ‰</li><li>æ¯æ¬¡<code>binlog rotate</code>çš„æ—¶å€™å­˜å‚¨åœ¨binlogå¤´éƒ¨</li><li><code>Previous-GTIDs</code>åœ¨binlogä¸­åªä¼šå­˜å‚¨åœ¨è¿™å°æœºå™¨ä¸Šæ‰§è¡Œè¿‡çš„æ‰€æœ‰binlogï¼Œä¸åŒ…æ‹¬æ‰‹åŠ¨è®¾ç½®<code>gtid_purged</code>å€¼ã€‚</li><li>æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ æ‰‹åŠ¨<code>set global gtid_purged=xx;</code> é‚£ä¹ˆxxæ˜¯ä¸ä¼šè®°å½•åœ¨<code>Previous_gtid_log_event</code>ä¸­çš„ã€‚</li></ol><ul><li>GTIDå’ŒBinlogä¹‹é—´çš„å…³ç³»æ˜¯æ€ä¹ˆå¯¹åº”çš„å‘¢<br>  å¦‚ä½•æ‰èƒ½æ‰¾åˆ°GTID=?å¯¹åº”çš„binlogæ–‡ä»¶å‘¢ï¼Ÿ<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* å‡è®¾æœ‰4ä¸ªbinlog: bin.001,bin.002,bin.003,bin.004</span><br><span class="line">* bin.001 : Previous-GTIDs=empty; binlog_eventæœ‰ï¼š1-40  </span><br><span class="line">* bin.002 : Previous-GTIDs=1-40;  binlog_eventæœ‰ï¼š41-80 </span><br><span class="line">* bin.003 : Previous-GTIDs=1-80;  binlog_eventæœ‰ï¼š81-120  </span><br><span class="line">* bin.004 : Previous-GTIDs=1-120;  binlog_eventæœ‰ï¼š121-160  </span><br><span class="line">    1. å‡è®¾ç°åœ¨æˆ‘ä»¬è¦æ‰¾GTID=<span class="variable">$A</span>ï¼Œé‚£ä¹ˆMySQLçš„æ‰«æé¡ºåºä¸ºï¼š ä»æœ€åä¸€ä¸ªbinlogå¼€å§‹æ‰«æï¼ˆå³ï¼šbin.004ï¼‰      </span><br><span class="line">    2. bin.004çš„Previous-GTIDs=1-120ï¼Œå¦‚æœ<span class="variable">$A</span>=140 > Previous-GTIDs,é‚£ä¹ˆè‚¯å®šåœ¨bin.004ä¸­  </span><br><span class="line">    3. bin.004çš„Previous-GTIDs=1-120ï¼Œå¦‚æœ<span class="variable">$A</span>=88 åŒ…å«åœ¨Previous-GTIDsä¸­,é‚£ä¹ˆç»§ç»­å¯¹æ¯”ä¸Šä¸€ä¸ªbinlogæ–‡ä»¶ bin.003,ç„¶åå†å¾ªç¯å‰é¢2ä¸ªæ­¥éª¤ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="é‡è¦å‚æ•°çš„æŒä¹…åŒ–"><a href="#é‡è¦å‚æ•°çš„æŒä¹…åŒ–" class="headerlink" title="é‡è¦å‚æ•°çš„æŒä¹…åŒ–"></a>é‡è¦å‚æ•°çš„æŒä¹…åŒ–</h5><ul><li>GTIDç›¸å…³å‚æ•°</li></ul><table><thead><tr><th style="text-align:center">variables</th><th style="text-align:center">comment</th></tr></thead><tbody><tr><td style="text-align:center">gtid_executed</td><td style="text-align:center">æ‰§è¡Œè¿‡çš„æ‰€æœ‰GTID</td></tr><tr><td style="text-align:center">gtid_purged</td><td style="text-align:center">ä¸¢å¼ƒæ‰çš„GTID</td></tr><tr><td style="text-align:center">gtid_mode</td><td style="text-align:center">gtidæ¨¡å¼</td></tr><tr><td style="text-align:center">gtid_next</td><td style="text-align:center">sessionçº§åˆ«çš„å˜é‡ï¼Œä¸‹ä¸€ä¸ªgtid</td></tr><tr><td style="text-align:center">gtid_owned</td><td style="text-align:center">æ­£åœ¨è¿è¡Œçš„gtid</td></tr><tr><td style="text-align:center">enforce_gtid_consistency</td><td style="text-align:center">ä¿è¯GTIDå®‰å…¨çš„å‚æ•°</td></tr></tbody></table><ul><li>é‡è¦å‚æ•°å¦‚ä½•æŒä¹…åŒ–</li></ul><ol><li>å¦‚ä½•æŒä¹…åŒ–<code>gtid_executed</code> <code>[ log-bin=on,log_slave_update=on ]</code><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gtid_executed = mysql.gtid_executed <span class="comment">#[normal]</span></span><br><span class="line">or</span><br><span class="line">gtid_executed = mysql.gtid_executed + last_binlog ä¸­æœ€åæ²¡å†™åˆ°mysql.gtid_executedä¸­çš„gtid_event  <span class="comment">#[recover]</span></span><br></pre></td></tr></tbody></table></figure></li></ol><ul><li>å¦‚ä½•æŒä¹…åŒ–é‡ç½®çš„gtid_purgedå€¼?<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reset master;</span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">'$A:a-b'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. ç”±äºæœ‰å¯èƒ½æ‰‹åŠ¨è®¾ç½®è¿‡gtid_purged=<span class="variable">$A</span>:a-b, binlog.indexä¸­ï¼Œlast_binlogçš„Previous-GTIDså¹¶ä¸ä¼šåŒ…å«<span class="variable">$A</span>:a-b  </span><br><span class="line">2. ç”±äºæœ‰å¯èƒ½æ‰‹åŠ¨è®¾ç½®è¿‡gtid_purged=<span class="variable">$A</span>:a-b, binlog.indexä¸­ï¼Œfirst_binlogçš„Previous-GTIDsè‚¯å®šä¸ä¼šå‡ºç°<span class="variable">$A</span>:a-b  </span><br><span class="line">3. é‡ç½®çš„gtid_purged = @@global.gtid_executed(mysql.gtid_executed:æ³¨æ„ï¼Œè€ƒè™‘åˆ°è¿™ä¸ªè¡¨çš„æ›´æ–°è§¦å‘æ¡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œç”¨@@global.gtid_executedä»£æ›¿) - last_binlogçš„Previous-GTIDs  - last_binlogæ‰€æœ‰çš„gtid_event  </span><br><span class="line">4. ä¸‹é¢å°±ç”¨ <span class="variable">$reset_gtid_purged</span> æ¥è¡¨ç¤ºé‡ç½®çš„gtid</span><br></pre></td></tr></tbody></table></figure><ul><li>å¦‚ä½•æŒä¹…åŒ–<code>gtid_purged</code> <code>[ log-bin=on,log_slave_update=on ]</code><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gtid_purged=binlog.index:first_binlogçš„Previous-GTIDs  + <span class="variable">$reset_gtid_purged</span></span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="å¼€å¯GTIDçš„å¿…å¤‡æ¡ä»¶"><a href="#å¼€å¯GTIDçš„å¿…å¤‡æ¡ä»¶" class="headerlink" title="å¼€å¯GTIDçš„å¿…å¤‡æ¡ä»¶"></a>å¼€å¯GTIDçš„å¿…å¤‡æ¡ä»¶</h5><ul><li><p>MySQL 5.6</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (å¿…é€‰)    </span><br><span class="line">log_bin=ON                  (å¿…é€‰)    </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        (å¿…é€‰)    </span><br><span class="line">enforce-gtid-consistency    (å¿…é€‰)</span><br></pre></td></tr></tbody></table></figure></li><li><p>MySQL 5.7</p><blockquote><p>MySQL5.7.13 or higher</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (å¿…é€‰)  </span><br><span class="line">enforce-gtid-consistency    ï¼ˆå¿…é€‰ï¼‰</span><br><span class="line">log_bin=ON                  ï¼ˆå¯é€‰ï¼‰--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON  </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        ï¼ˆå¯é€‰ï¼‰--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON</span><br></pre></td></tr></tbody></table></figure></blockquote></li></ul><h5 id="æ–°çš„å¤åˆ¶åè®®-COM-BINLOG-DUMP-GTID"><a href="#æ–°çš„å¤åˆ¶åè®®-COM-BINLOG-DUMP-GTID" class="headerlink" title="æ–°çš„å¤åˆ¶åè®® COM_BINLOG_DUMP_GTID"></a>æ–°çš„å¤åˆ¶åè®® COM_BINLOG_DUMP_GTID</h5><ul><li><p>slaveä¼šå°†å·²ç»æ‰§è¡Œè¿‡çš„gtidï¼Œä»¥åŠä»¥åŠæ¥å—åˆ°relay logä¸­çš„gtidçš„å¹¶é›†å‘é€ç»™master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* http://dev.mysql.com/doc/refman/5.7/en/change-master-to.html</span><br><span class="line">UNION(@@global.gtid_executed, Retrieved_gtid_set - last_received_GTID)</span><br></pre></td></tr></tbody></table></figure></li><li><p>Master send all other transactions to slave</p></li><li>åŒæ ·çš„GTIDä¸èƒ½è¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œå¦‚æœæœ‰åŒæ ·çš„GTIDï¼Œä¼šè‡ªåŠ¨è¢«skipæ‰ã€‚</li></ul><img src="/2019/04/22/mysql-GTID/com_binlog_dump_gtid.jpg" title="com_binlog_dump_gtid"><pre><code>- slave1 : å°†è‡ªèº«çš„UUID1:1 å‘é€ç»™ masterï¼Œç„¶åæ¥æ”¶åˆ°äº† UUID1:2,UUID1:3 event- slave2 : å°†è‡ªèº«çš„UUID1:1,UUID1:2 å‘é€ç»™ masterï¼Œç„¶åæ¥æ”¶åˆ°äº†UUID1:3 event</code></pre><h5 id="GTIDé‡è¦å‡½æ•°å’Œæ–°è¯­æ³•"><a href="#GTIDé‡è¦å‡½æ•°å’Œæ–°è¯­æ³•" class="headerlink" title="GTIDé‡è¦å‡½æ•°å’Œæ–°è¯­æ³•"></a>GTIDé‡è¦å‡½æ•°å’Œæ–°è¯­æ³•</h5><ul><li>é‡è¦å‡½æ•°</li></ul><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">GTID_SUBSET(subset, set)</td><td style="text-align:center">returns true (1) if all GTIDs in subset are also in set</td></tr><tr><td style="text-align:center">GTID_SUBTRACT(set,subset)</td><td style="text-align:center">returns only those GTIDs from set that are not in subset</td></tr><tr><td style="text-align:center">WAIT_FOR_EXECUTED_GTID_SET(gtid_set[, timeout])</td><td style="text-align:center">Wait until the given GTIDs have executed on slave.</td></tr><tr><td style="text-align:center">WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS(gtid_set[, timeout][,channel])</td><td style="text-align:center">Wait until the given GTIDs have executed on slave.</td></tr></tbody></table><ul><li><p>æ–°è¯­æ³•</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">START SLAVE [thread_types] [until_option] [connection_options]</span><br><span class="line">thread_types:</span><br><span class="line">    [thread_type [, thread_type] ... ]</span><br><span class="line">thread_type: </span><br><span class="line">    IO_THREAD | SQL_THREAD</span><br><span class="line">until_option:</span><br><span class="line">    UNTIL {   {SQL_BEFORE_GTIDS | SQL_AFTER_GTIDS} = gtid_set</span><br><span class="line">          |   MASTER_LOG_FILE = <span class="string">'log_name'</span>, MASTER_LOG_POS = log_pos</span><br><span class="line">          |   RELAY_LOG_FILE = <span class="string">'log_name'</span>, RELAY_LOG_POS = log_pos</span><br><span class="line">          |   SQL_AFTER_MTS_GAPS  }</span><br></pre></td></tr></tbody></table></figure></li><li><p>ä¸¾ä¸ªæ —å­: </p></li></ul><ol><li><p>START SLAVE SQL_THREAD UNTIL SQL_BEFORE_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56   </p><blockquote><p>è¡¨ç¤ºï¼Œå½“SQL_thread æ‰§è¡Œåˆ°3E11FA47-71CA-11E1-9E33-C80AA9429562:10 çš„æ—¶å€™åœæ­¢ï¼Œä¸‹ä¸€ä¸ªäº‹åŠ¡æ˜¯11  </p></blockquote></li><li><p>START SLAVE SQL_THREAD UNTIL SQL_AFTER_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56  </p><blockquote><p>è¡¨ç¤ºï¼Œå½“SQL_thread æ‰§è¡Œåˆ°3E11FA47-71CA-11E1-9E33-C80AA9429562:56 çš„æ—¶å€™åœæ­¢ï¼Œ56æ˜¯æœ€åä¸€ä¸ªæäº¤çš„äº‹åŠ¡ã€‚</p></blockquote></li></ol><h4 id="GTIDæœ‰ä»€ä¹ˆå¥½å¤„"><a href="#GTIDæœ‰ä»€ä¹ˆå¥½å¤„" class="headerlink" title="GTIDæœ‰ä»€ä¹ˆå¥½å¤„"></a>GTIDæœ‰ä»€ä¹ˆå¥½å¤„</h4><h5 id="classic-replication-è¿ç»´ä¹‹ä¼¤"><a href="#classic-replication-è¿ç»´ä¹‹ä¼¤" class="headerlink" title="classic replication [è¿ç»´ä¹‹ä¼¤]"></a>classic replication [è¿ç»´ä¹‹ä¼¤]</h5><img src="/2019/04/22/mysql-GTID/classic_rpl.jpg" title="classic_rpl"><h5 id="GTID-replication-so-easy"><a href="#GTID-replication-so-easy" class="headerlink" title="GTID replication [so easy]"></a>GTID replication [so easy]</h5><img src="/2019/04/22/mysql-GTID/GTID_rpl.jpg" title="GTID_rpl"><h4 id="GTIDçš„Limitation"><a href="#GTIDçš„Limitation" class="headerlink" title="GTIDçš„Limitation"></a>GTIDçš„Limitation</h4><ul><li>ä¸å®‰å…¨çš„äº‹åŠ¡<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¾ç½®enforce-gtid-consistency=ON</span><br></pre></td></tr></tbody></table></figure></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. CREATE TABLE ... SELECT statements  </span><br><span class="line">2. CREATE TEMPORARY TABLE or DROP TEMPORARY TABLE statements inside transactions</span><br><span class="line">3. åŒæ—¶æ›´æ–° äº‹åŠ¡å¼•æ“ å’Œ éäº‹åŠ¡å¼•æ“ã€‚</span><br></pre></td></tr></tbody></table></figure><h4 id="MySQL5-7-GTID-crash-safe"><a href="#MySQL5-7-GTID-crash-safe" class="headerlink" title="MySQL5.7 GTID crash-safe"></a>MySQL5.7 GTID crash-safe</h4><p><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-solutions-unexpected-slave-halt.html" target="_blank" rel="noopener">å…³äº GTID crash safe å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£åˆ—å‡ºçš„å®‰å…¨é…ç½®</a></p><ul><li>å•çº¿ç¨‹å¤åˆ¶<br>Non-GTID æ¨èé…ç½®:<ul><li>relay_log_recovery=1</li><li>relay_log_info_repository=TABLE</li><li>master_info_repository=TABLE</li></ul></li></ul><p>GTID æ¨èé…ç½®:</p><pre><code>* MASTER_AUTO_POSITION=on* relay_log_recovery=0</code></pre><img src="/2019/04/22/mysql-GTID/replication_slave_halt.jpg" title="replication_slave_halt"><ul><li>å¤šçº¿ç¨‹å¤åˆ¶<br>Non-GTID æ¨èé…ç½®:<ul><li>relay_log_recovery=1</li><li>sync_relay_log=1</li><li>relay_log_info_repository=TABLE</li><li>master_info_repository=TABLE<br>GTID æ¨èé…ç½®:</li><li>MASTER_AUTO_POSITION=on</li><li>relay_log_recovery=0</li></ul></li></ul><img src="/2019/04/22/mysql-GTID/replication_slave_halt_duoble.jpg" title="replication_slave_halt_duoble"><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h4 id="ä½¿ç”¨GTIDæ­å»ºReplication"><a href="#ä½¿ç”¨GTIDæ­å»ºReplication" class="headerlink" title="ä½¿ç”¨GTIDæ­å»ºReplication"></a>ä½¿ç”¨GTIDæ­å»ºReplication</h4><h5 id="ä»0å¼€å§‹æ­å»º"><a href="#ä»0å¼€å§‹æ­å»º" class="headerlink" title="ä»0å¼€å§‹æ­å»º"></a>ä»0å¼€å§‹æ­å»º</h5><ul><li><p>step 1: è®©æ‰€æœ‰serverå¤„äºåŒä¸€ä¸ªç‚¹</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@global.read_only = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 2: å…³é—­æ‰€æœ‰MySQL</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell> mysqladmin -uusername -p shutdown</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: é‡å¯æ‰€æœ‰MySQLï¼Œå¹¶å¼€å¯GTID</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell> mysqld --gtid-mode=ON --<span class="built_in">log</span>-bin --enforce-gtid-consistency &</span><br></pre></td></tr></tbody></table></figure></li></ul><blockquote><p>å½“ç„¶ï¼Œåœ¨my.cnfä¸­é…ç½®å¥½æœ€ä½³</p></blockquote><ul><li><p>step 4: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line">mysql> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 5: è®©master å¯è¯»å¯å†™</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@global.read_only = OFF;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="ä»å¤‡ä»½ä¸­æ¢å¤-amp-æ­å»º"><a href="#ä»å¤‡ä»½ä¸­æ¢å¤-amp-æ­å»º" class="headerlink" title="ä»å¤‡ä»½ä¸­æ¢å¤&æ­å»º"></a>ä»å¤‡ä»½ä¸­æ¢å¤&æ­å»º</h5><ul><li><p>step 1: å¤‡ä»½</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqldump xx è·å–å¹¶ä¸”è®°å½•gtid_purgedå€¼  </span><br><span class="line">or</span><br><span class="line">å†·å¤‡ä»½ --è·å–å¹¶ä¸”è®°å½•gtid_executedå€¼ï¼Œè¿™ä¸ªå°±ç›¸å½“äºmysqldumpä¸­å¾—åˆ°çš„gtid_purged</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 2: åœ¨æ–°æœåŠ¡å™¨ä¸Šreset masterï¼Œå¯¼å…¥å¤‡ä»½</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reset master; --æ¸…ç©ºgtidä¿¡æ¯  </span><br><span class="line">å¯¼å…¥å¤‡ä»½ï¼› --å¦‚æœæ˜¯é€»è¾‘å¯¼å…¥ï¼Œè¯·è®¾ç½®sql_log_bin=off  </span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">'xx'</span>;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10;</span><br><span class="line"></span><br><span class="line">mysql> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="å¦‚ä½•ä»classic-replication-å‡çº§æˆ-GTID-replication"><a href="#å¦‚ä½•ä»classic-replication-å‡çº§æˆ-GTID-replication" class="headerlink" title="å¦‚ä½•ä»classic replication å‡çº§æˆ GTID replication"></a>å¦‚ä½•ä»classic replication å‡çº§æˆ GTID replication</h4><h5 id="offline-æ–¹å¼å‡çº§"><a href="#offline-æ–¹å¼å‡çº§" class="headerlink" title="offline æ–¹å¼å‡çº§"></a>offline æ–¹å¼å‡çº§</h5><p>offline çš„æ–¹å¼å‡çº§æœ€ç®€å•ã€‚å…¨éƒ¨å…³æœºï¼Œç„¶åé…ç½®å¥½GTIDï¼Œé‡å¯ï¼Œ<code>CHANGE MASTER TO MASTER_AUTO_POSITION=1</code>ã€‚</p><h5 id="online-æ–¹å¼å‡çº§"><a href="#online-æ–¹å¼å‡çº§" class="headerlink" title="online æ–¹å¼å‡çº§"></a>online æ–¹å¼å‡çº§</h5><p>è¿™é‡Œå…ˆä»‹ç»å‡ ä¸ªé‡è¦<code>GTID_MODE</code>çš„<code>value</code></p><ul><li>GTID_MODE = OFF               ä¸äº§ç”ŸNormal_GTIDï¼Œåªæ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID</li><li>GTID_MODE = OFF_PERMISSIVE    ä¸äº§ç”ŸNormal_GTIDï¼Œå¯ä»¥æ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID & Normal_GTID</li><li>GTID_MODE = ON_PERMISSIVE     äº§ç”ŸNormal_GTIDï¼Œå¯ä»¥æ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID & Normal_GTID</li><li>GTID_MODE = ON                äº§ç”ŸNormal_GTIDï¼Œåªæ¥å—æ¥è‡ªmasterçš„Normal_GTID</li></ul><p>masterå’Œslaveçš„gtid_mode ç»„åˆæ­é…çŸ©é˜µå›¾</p><blockquote><p>æ°´å¹³çš„GTID_MODEä¸ºï¼šmaster</p></blockquote><blockquote><p>å‚ç›´çš„GTID_MODEä¸ºï¼šslave</p></blockquote><table><thead><tr><th style="text-align:left">gtid_mode</th><th style="text-align:left">OFF(master)</th><th style="text-align:left">OFF_PERMISSIVE(master)</th><th style="text-align:left">ON_PERMISSIVE(master)</th><th style="text-align:left">ON(master)</th></tr></thead><tbody><tr><td style="text-align:left">OFF(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">N</td><td style="text-align:left">N</td></tr><tr><td style="text-align:left">OFF_PERMISSIVE(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_positionå¯ä»¥å¼€å¯)</td></tr><tr><td style="text-align:left">ON_PERMISSIVE(slave)</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_positionå¯ä»¥å¼€å¯)</td></tr><tr><td style="text-align:left">ON(slave)</td><td style="text-align:left">N</td><td style="text-align:left">N</td><td style="text-align:left">Y</td><td style="text-align:left">Y(auto_positionå¯ä»¥å¼€å¯)</td></tr></tbody></table><p>å½’çº³æ€»ç»“ï¼š</p><ol><li>å½“masteräº§ç”ŸNormal_GTIDçš„æ—¶å€™ï¼ˆON_PERMISSIVEï¼ŒONï¼‰ï¼Œå¦‚æœslaveçš„gtid_modeï¼ˆOFFï¼‰ä¸èƒ½æ¥å—Normal_GTIDï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™</li><li>å½“masteräº§ç”ŸANONYMOUS_GTIDçš„æ—¶å€™ï¼ˆOFF_PERMISSIVEï¼ŒOFFï¼‰ï¼Œå¦‚æœslaveçš„gtid_modeï¼ˆONï¼‰ä¸èƒ½æ¥å—ANONYMOUS_GTIDï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™</li><li>è®¾ç½®auto_positionçš„æ¡ä»¶ï¼š å½“master gtid_mode=ONæ—¶ï¼Œslaveå¯ä»¥ä¸ºOFF_PERMISSIVEï¼ŒON_PERMISSIVEï¼ŒONã€‚é™¤æ­¤ä¹‹å¤–ï¼Œéƒ½ä¸èƒ½è®¾ç½®auto_position = on</li></ol><p>ä¸‹é¢ç½—åˆ—ä¸‹ï¼Œå¦‚ä½•online å‡çº§ä¸ºGTIDæ¨¡å¼ã€‚</p><ul><li><p>step 1: æ¯å°serveræ‰§è¡Œ</p><blockquote><p>æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼Œç›´åˆ°æ²¡æœ‰é”™è¯¯å‡ºç°ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 2: æ¯å°serveræ‰§è¡Œ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 3: æ¯å°serveræ‰§è¡Œ</p><blockquote><p>ä¸ç”¨å…³å¿ƒä¸€ç»„å¤åˆ¶é›†ç¾¤çš„serverçš„æ‰§è¡Œé¡ºåºï¼Œåªéœ€è¦ä¿è¯æ¯ä¸ªServeréƒ½æ‰§è¡Œäº†ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 4: æ¯å°serveræ‰§è¡Œ</p><blockquote><p>ä¸ç”¨å…³å¿ƒä¸€ç»„å¤åˆ¶é›†ç¾¤çš„serverçš„æ‰§è¡Œé¡ºåºï¼Œåªéœ€è¦ä¿è¯æ¯ä¸ªServeréƒ½æ‰§è¡Œäº†ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 5: åœ¨æ¯å°serverä¸Šæ‰§è¡Œï¼Œå¦‚æœONGOING_ANONYMOUS_TRANSACTION_COUNT=0å°±å¯ä»¥</p><blockquote><p>ä¸éœ€è¦ä¸€ç›´ä¸º0ï¼Œåªè¦å‡ºç°è¿‡0ä¸€æ¬¡ï¼Œå°±ok</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE <span class="string">'ONGOING_ANONYMOUS_TRANSACTION_COUNT'</span>;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>step 6ï¼š ç¡®ä¿æ‰€æœ‰anonymousäº‹åŠ¡ä¼ é€’åˆ°slaveä¸Šäº†</p></li></ul><ul><li><p>master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS;</span><br></pre></td></tr></tbody></table></figure></li><li><p>æ¯ä¸ªslave  </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT MASTER_POS_WAIT(file, position);</span><br></pre></td></tr></tbody></table></figure></li></ul><p>æˆ–è€…ï¼Œç­‰ä¸€æ®µæ—¶é—´ï¼Œåªè¦ä¸æ˜¯å¤§çš„å»¶è¿Ÿï¼Œä¸€èˆ¬éƒ½æ²¡é—®é¢˜</p><ul><li><p>step 7: æ¯å°Serverä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET @@GLOBAL.GTID_MODE = ON;</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 8: åœ¨æ¯å°serverä¸Šå°†my.cnfä¸­æ·»åŠ å¥½gtidé…ç½®</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON                (å¿…é€‰) </span><br><span class="line">enforce-gtid-consistency    (å¿…é€‰)</span><br><span class="line">log_bin=ON                  (å¯é€‰)--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON  </span><br><span class="line"><span class="built_in">log</span>-slave-updates=ON        (å¯é€‰)--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON</span><br></pre></td></tr></tbody></table></figure></li><li><p>step 9: change master</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;  </span><br><span class="line">CHANGE MASTER TO MASTER_AUTO_POSITION = 1;  </span><br><span class="line">START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="GTID-failover"><a href="#GTID-failover" class="headerlink" title="GTID failover"></a>GTID failover</h4><h5 id="MySQL-crash"><a href="#MySQL-crash" class="headerlink" title="MySQL crash"></a>MySQL crash</h5><pre><code>> é…ç½®å¥½loss-less semi-sync replicationï¼Œå¯ä»¥æ›´å¯é çš„ä¿è¯æ•°æ®é›¶ä¸¢å¤±ã€‚  ä»¥ä¸‹è¯´çš„éƒ½æ˜¯crash åï¼Œèµ·ä¸æ¥çš„æƒ…å†µ</code></pre><ul><li>binlog åœ¨masterè¿˜æœ‰æ—¥å¿—æ²¡æœ‰ä¼ é€’åˆ° slave<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_position åŒæ­¥å¥½  </span><br><span class="line">2. mysqlbinlog å°†æ²¡ä¼ é€’è¿‡æ¥çš„binlogåœ¨æ–°masterä¸Šreplay  </span><br><span class="line">3. æ‰“å¼€æ–° master çš„ SET GLOBAL surper_read_only=off;</span><br><span class="line">``` </span><br><span class="line">* binlog å·²ç»ä¼ é€’åˆ°slave</span><br><span class="line">```bash</span><br><span class="line">1. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_positionåŒæ­¥å¥½  </span><br><span class="line">2. æ‰“å¼€æ–°masterçš„ SET GLOBAL surper_read_only=off;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="OS-crash"><a href="#OS-crash" class="headerlink" title="OS crash"></a>OS crash</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_positionåŒæ­¥å¥½  </span><br><span class="line">2. æ‰“å¼€æ–°masterçš„ SET GLOBAL surper_read_only=off;</span><br></pre></td></tr></tbody></table></figure><blockquote><blockquote><p>ä»¥ä¸Šæ“ä½œï¼Œåœ¨ä¼ ç»Ÿæ¨¡å¼å¤åˆ¶ä¸‹ï¼Œåªèƒ½é€šè¿‡MHAæ¥å®ç°ï¼ŒMHAæ¯”è¾ƒå¤æ‚ã€‚<br>   ç°åœ¨ï¼Œåœ¨GTIDæ¨¡å¼ä¸‹ï¼Œå®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œä¸”éå¸¸æ–¹ä¾¿ã€‚</p></blockquote></blockquote><h4 id="GTID-è¿ç»´å’Œé”™è¯¯å¤„ç†"><a href="#GTID-è¿ç»´å’Œé”™è¯¯å¤„ç†" class="headerlink" title="GTID è¿ç»´å’Œé”™è¯¯å¤„ç†"></a>GTID è¿ç»´å’Œé”™è¯¯å¤„ç†</h4><ol><li>ä½¿ç”¨GTIDåï¼Œå¯¹åŸæ¥ä¼ ç»Ÿçš„è¿ç»´æœ‰ä¸åŒä¹‹å¤„äº†ï¼Œéœ€è¦è°ƒæ•´è¿‡æ¥ã€‚</li><li>ä½¿ç”¨Rowæ¨¡å¼ä¸”å¤åˆ¶é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼ŒåŸºæœ¬ä¸Šå¾ˆå°‘å‘ç°æœ‰å¤åˆ¶å‡ºé”™çš„æƒ…å†µã€‚</li><li>slave è®¾ç½® super_read_only=on</li></ol><h5 id="é”™è¯¯åœºæ™¯-Errant-transaction"><a href="#é”™è¯¯åœºæ™¯-Errant-transaction" class="headerlink" title="é”™è¯¯åœºæ™¯: Errant transaction"></a>é”™è¯¯åœºæ™¯: Errant transaction</h5><p>å‡ºç°è¿™ç§é—®é¢˜åŸºæœ¬æœ‰ä¸¤ç§æƒ…å†µ</p><blockquote><ol><li>å¤åˆ¶å‚æ•°æ²¡æœ‰é…ç½®æ­£ç¡®ï¼Œå½“slave crashåï¼Œä¼šå‡ºç°é‡å¤é”®é—®é¢˜</li><li>DBAæ“ä½œä¸æ­£ç¡®ï¼Œä¸å°å¿ƒåœ¨slaveä¸Šæ‰§è¡Œäº†äº‹åŠ¡</li></ol></blockquote><p>å¯¹äºç¬¬ä¸€ä¸ªé‡å¤é”®é—®é¢˜</p><ul><li><p>å¯¹äºç¬¬ä¸€ä¸ªé‡å¤é”®é—®é¢˜</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* skip transation; </span><br><span class="line">SQL> SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1;</span><br><span class="line">SQL> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li><li><p>GTIDæ¨¡å¼</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL> SET GTID_NEXT=<span class="string">'b9b4712a-df64-11e3-b391-60672090eb04:7'</span>;   --è®¾ç½®éœ€è¦è·³è¿‡çš„gtid event</span><br><span class="line">SQL> BEGIN;COMMIT;</span><br><span class="line">SQL> SET GTID_NEXT=<span class="string">'AUTOMATIC'</span>;</span><br><span class="line">SQL> START SLAVE;</span><br></pre></td></tr></tbody></table></figure></li></ul><p>å¯¹äºç¬¬äºŒç§ä¸å°å¿ƒå¤šæ‰§è¡Œäº†äº‹åŠ¡</p><blockquote><p>è¿™ç§æƒ…å†µå°±æ¯”è¾ƒéš¾äº†ï¼Œè¿™æ ·å·²ç»å¯¼è‡´äº†æ•°æ®ä¸ä¸€è‡´ï¼Œå¤§å¤šæ•°æƒ…å†µï¼Œå»ºè®®slaveé‡åš<br>  å¦‚ä½•é¿å…ï¼š slave è®¾ç½® super_read_only=on;</p></blockquote><p><strong><em>é‡ç‚¹ï¼š å½“å‘ç”Ÿinject empty transctionåï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤±äº‹åŠ¡</em></strong></p><pre><code>è¿™é‡Œè¯´ä¸‹inject empty transctionçš„éšæ‚£    å½“slaveä¸Šinject empty transctionï¼Œè¯´æ˜æœ‰ä¸€ä¸ªmasterçš„äº‹åŠ¡è¢«å¿½ç•¥äº†ï¼ˆè¿™é‡Œå‡è®¾æ˜¯ $uuid:100ï¼‰    äº‹åŠ¡ä¸¢å¤±ä¸€ï¼šå¦‚æœæ­¤æ—¶æ­¤åˆ»masteræŒ‚äº†ï¼Œè¿™ä¸ªslaveè¢«é€‰ä¸¾ä¸ºæ–°masterï¼Œé‚£ä¹ˆå…¶ä»–çš„slaveå¦‚æœè¿˜æ²¡æœ‰æ‰§è¡Œåˆ°$uuid:100,å°±ä¼šä¸¢å¤±æ‰$uuid:100è¿™ä¸ªäº‹åŠ¡ã€‚    äº‹åŠ¡ä¸¢å¤±äºŒï¼šå¦‚æœä»å¤‡ä»½ä¸­é‡æ–°æ­å»ºä¸€ä¸ªslaveï¼Œéœ€è¦é‡æ–°æ‰§è¡Œä¹‹å‰çš„æ‰€æœ‰äº‹åŠ¡ï¼Œè€Œæ­¤æ—¶ï¼ŒmasteræŒ‚äº†ï¼Œ åˆå›åˆ°äº†äº‹åŠ¡ä¸¢å¤±ä¸€çš„åœºæ™¯ã€‚</code></pre><h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><h4 id="å¦‚ä½•é‡ç½®gtid-executedï¼Œgtid-purgedã€‚"><a href="#å¦‚ä½•é‡ç½®gtid-executedï¼Œgtid-purgedã€‚" class="headerlink" title="å¦‚ä½•é‡ç½®gtid_executedï¼Œgtid_purgedã€‚"></a>å¦‚ä½•é‡ç½®gtid_executedï¼Œgtid_purgedã€‚</h4><ul><li><p>è®¾ç½®gtid_executed</p><blockquote><p>ç°åœ¨åªèƒ½æ‰§è¡Œ:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> reset master;</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>è®¾ç½®gtid_purged</p></li><li>å½“gtid_executed éç©ºçš„æ—¶å€™ï¼Œä¸èƒ½è®¾ç½®gtid_purged</li><li>å½“gtid_executed ä¸ºç©ºçš„æ—¶å€™(å³åˆšåˆšå¤‡ä»½å¥½çš„é•œåƒï¼Œåˆšæ­å»ºçš„mysql)<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql> SET @@GLOBAL.GTID_PURGED=<span class="string">'0ad6eae9-2d66-11e6-864f-ecf4bbf1f42c:1-3'</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="å¦‚æœauto-cnf-è¢«åˆ æ‰äº†ï¼Œå¯¹äºGTIDçš„å¤åˆ¶ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ"><a href="#å¦‚æœauto-cnf-è¢«åˆ æ‰äº†ï¼Œå¯¹äºGTIDçš„å¤åˆ¶ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ" class="headerlink" title="å¦‚æœauto.cnf è¢«åˆ æ‰äº†ï¼Œå¯¹äºGTIDçš„å¤åˆ¶ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ"></a>å¦‚æœauto.cnf è¢«åˆ æ‰äº†ï¼Œå¯¹äºGTIDçš„å¤åˆ¶ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</h5><pre><code>> å¦‚æœè¢«åˆ æ‰ï¼Œé‡å¯åï¼Œserver-uuid ä¼šå˜</code></pre><h5 id="æ‰‹åŠ¨è®¾ç½®-set-gtid-purged-xx-yy-mysqlä¼šå»ä¸»åŠ¨ä¿®æ”¹binlogçš„å¤´ä¹ˆ"><a href="#æ‰‹åŠ¨è®¾ç½®-set-gtid-purged-xx-yy-mysqlä¼šå»ä¸»åŠ¨ä¿®æ”¹binlogçš„å¤´ä¹ˆ" class="headerlink" title="æ‰‹åŠ¨è®¾ç½® set @@gtid_purged = xx:yy, mysqlä¼šå»ä¸»åŠ¨ä¿®æ”¹binlogçš„å¤´ä¹ˆ"></a>æ‰‹åŠ¨è®¾ç½® set @@gtid_purged = xx:yy, mysqlä¼šå»ä¸»åŠ¨ä¿®æ”¹binlogçš„å¤´ä¹ˆ</h5><pre><code>> ä¸ä¼š</code></pre><h5 id="GTIDå’Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼ŸMySQLï¼Œtestè¿˜èƒ½æ„‰å¿«çš„è¿‡æ»¤æ‰å—ï¼Ÿ"><a href="#GTIDå’Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼ŸMySQLï¼Œtestè¿˜èƒ½æ„‰å¿«çš„è¿‡æ»¤æ‰å—ï¼Ÿ" class="headerlink" title="GTIDå’Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼ŸMySQLï¼Œtestè¿˜èƒ½æ„‰å¿«çš„è¿‡æ»¤æ‰å—ï¼Ÿ"></a>GTIDå’Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼ŸMySQLï¼Œtestè¿˜èƒ½æ„‰å¿«çš„è¿‡æ»¤æ‰å—ï¼Ÿ</h5><pre><code>> å¯ä»¥ï¼Œæ”¹è¿‡æ»¤çš„ä¼šè‡ªå·±è¿‡æ»¤ï¼Œä¸ç”¨æ‹…å¿ƒ</code></pre><h2 id="Automatic-failover-with-mysqlfailover-GTID"><a href="#Automatic-failover-with-mysqlfailover-GTID" class="headerlink" title="Automatic failover with mysqlfailover+GTID"></a>Automatic failover with mysqlfailover+GTID</h2><p><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-solutions-switch.html" target="_blank" rel="noopener">mysqlfailover+GTID</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;aaa.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQLæŸ¥è¯¢é‡å¤è®°å½•,åˆ é™¤é‡å¤è®°å½•æ–¹æ³•</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-duplicate/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-duplicate/</id>
    <published>2019-04-22T05:55:23.000Z</published>
    <updated>2019-04-22T06:05:32.273Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>å–„è‰¯æ²¡ç”¨ï¼Œå› ä¸ºåªæœ‰ä½ å…ˆæ¼‚äº®ï¼Œåˆ«äººæ‰èƒ½çœ‹åˆ°ä½ çš„å–„è‰¯ã€‚</strong></p></blockquote><h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><p>æŸ¥æ‰¾å…¨éƒ¨é‡å¤è®°å½•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM è¡¨ WHERE é‡å¤å­—æ®µ IN (SELECT é‡å¤å­—æ®µ FROM è¡¨ GROUP BY é‡å¤å­—æ®µ HAVING COUNT(*)>1);</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿‡æ»¤é‡å¤è®°å½•(åªæ˜¾ç¤ºä¸€æ¡)<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM è¡¨ WHERE ID IN (SELECT MAX(ID) FROM è¡¨ GROUP BY Title);     <span class="comment">#æ˜¾ç¤ºIDæœ€å¤§ä¸€æ¡è®°å½•</span></span><br><span class="line">SELECT * FROM è¡¨ WHERE ID IN (SELECT MIN(ID) FROM è¡¨ GROUP BY Title);     <span class="comment">#æ˜¾ç¤ºIDæœ€å°ä¸€æ¡è®°å½•</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ é™¤å…¨éƒ¨é‡å¤è®°å½•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE è¡¨ WHERE é‡å¤å­—æ®µ IN (SELECT é‡å¤å­—æ®µ FROM è¡¨ GROUP BY é‡å¤å­—æ®µ HAVING COUNT(*)>1);</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ é™¤å…¨éƒ¨é‡å¤è®°å½•ä¿ç•™æœ€å¤§IDæœ€å¤§ä¸€æ¡è®°å½•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM è¡¨ WHERE ID NOT IN (SELECT MAX(ID) FROM è¡¨ GROUP BY Title)    <span class="comment">#ä¿ç•™IDæœ€å¤§ä¸€æ¡è®°å½•</span></span><br><span class="line">DELETE FROM è¡¨ WHERE ID NOT IN (SELECT MIN(ID) FROM è¡¨ GROUP BY Title)    <span class="comment">#ä¿ç•™IDæœ€å°ä¸€æ¡è®°å½•</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ é™¤è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰ï¼Œåªç•™æœ‰rowidæœ€å°çš„è®°å½•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1)</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥æ‰¾è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰ï¼Œä¸åŒ…å«rowidæœ€å°çš„è®°å½•<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1)</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥æ‰¾è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1)</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯´æ˜ï¼š</p><ul><li>å•è¡¨çš„å”¯ä¸€æŸ¥è¯¢ç”¨ï¼šdistinct</li><li>å¤šè¡¨çš„å”¯ä¸€æŸ¥è¯¢ç”¨ï¼šgroup by</li><li>distinct æŸ¥è¯¢å¤šè¡¨æ—¶ï¼Œleft join è¿˜æœ‰æ•ˆï¼Œå…¨è¿æ¥æ— æ•ˆ</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQLä¿®æ”¹è¡¨ã€å­—æ®µã€åº“çš„å­—ç¬¦é›†åŠå­—ç¬¦é›†</title>
    <link href="https://jiemin.wang/2019/04/22/mysql-character/"/>
    <id>https://jiemin.wang/2019/04/22/mysql-character/</id>
    <published>2019-04-22T05:48:55.000Z</published>
    <updated>2019-04-22T06:06:52.657Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ä¸€ç›´å¯¹å‘å‹å’Œèº«æä¸æ»¡æ„çš„äººï¼Œæœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šä¸è‚¯æ‰¿è®¤è¿™æ˜¯è„¸çš„é—®é¢˜ã€‚</strong></p></blockquote><h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><p>ä¿®æ”¹æ•°æ®åº“å­—ç¬¦é›†<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE db_name DEFAULT CHARACTER SET character_name [COLLATE ...];</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŠŠè¡¨é»˜è®¤çš„å­—ç¬¦é›†å’Œæ‰€æœ‰å­—ç¬¦åˆ—ï¼ˆCHAR,VARCHAR,TEXTï¼‰æ”¹ä¸ºæ–°çš„å­—ç¬¦é›†ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name CONVERT TO CHARACTER SET character_name [COLLATE ...]</span><br><span class="line">å¦‚ï¼šALTER TABLE logtest CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>åªæ˜¯ä¿®æ”¹è¡¨çš„é»˜è®¤å­—ç¬¦é›†<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name DEFAULT CHARACTER SET character_name [COLLATE...];</span><br><span class="line">å¦‚ï¼šALTER TABLE logtest DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¿®æ”¹å­—æ®µçš„å­—ç¬¦é›†<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name CHANGE c_name c_name CHARACTER SET character_name [COLLATE ...];</span><br><span class="line">å¦‚ï¼šALTER TABLE logtest CHANGE title title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹å­—æ®µç¼–ç <br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW FULL COLUMNS FROM tbl_name;</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹ç³»ç»Ÿçš„ç¼–ç å­—ç¬¦<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES WHERE Variable_name LIKE <span class="string">'character\_set\_%'</span> OR Variable_name LIKE <span class="string">'collation%'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="MySQLå­—ç¬¦é›†è®¾ç½®"><a href="#MySQLå­—ç¬¦é›†è®¾ç½®" class="headerlink" title="MySQLå­—ç¬¦é›†è®¾ç½®"></a>MySQLå­—ç¬¦é›†è®¾ç½®</h2><p>ç³»ç»Ÿå˜é‡ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â€“ character_set_serverï¼šé»˜è®¤çš„å†…éƒ¨æ“ä½œå­—ç¬¦é›†</span><br><span class="line">â€“ character_set_clientï¼šå®¢æˆ·ç«¯æ¥æºæ•°æ®ä½¿ç”¨çš„å­—ç¬¦é›†</span><br><span class="line">â€“ character_set_connectionï¼šè¿æ¥å±‚å­—ç¬¦é›†</span><br><span class="line">â€“ character_set_resultsï¼šæŸ¥è¯¢ç»“æœå­—ç¬¦é›†</span><br><span class="line">â€“ character_set_databaseï¼šå½“å‰é€‰ä¸­æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†</span><br><span class="line">â€“ character_set_systemï¼šç³»ç»Ÿå…ƒæ•°æ®(å­—æ®µåç­‰)å­—ç¬¦é›†</span><br><span class="line">â€“ è¿˜æœ‰ä»¥collation_å¼€å¤´çš„åŒä¸Šé¢å¯¹åº”çš„å˜é‡ï¼Œç”¨æ¥æè¿°å­—ç¬¦åºã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†"><a href="#ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†" class="headerlink" title="ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†"></a>ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†</h2><p>æ ¼å¼ä¸ºï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[_charset] â€˜stringâ€™ [COLLATE collation]</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¾‹å­:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT _latin1 â€˜stringâ€™;</span><br><span class="line">â€¢ SELECT _utf8 â€˜ä½ å¥½â€™ COLLATE utf8_general_ci;</span><br><span class="line">â€“ ç”±introducerä¿®é¥°çš„æ–‡æœ¬å­—ç¬¦ä¸²åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ä¸ç»è¿‡å¤šä½™çš„è½¬ç ï¼Œç›´æ¥è½¬æ¢ä¸ºå†…éƒ¨å­—ç¬¦é›†å¤„ç†ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹"><a href="#MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹" class="headerlink" title="MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹"></a>MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹</h2><ol><li>MySQL Serveræ”¶åˆ°è¯·æ±‚æ—¶å°†è¯·æ±‚æ•°æ®ä»character_set_clientè½¬æ¢ä¸ºcharacter_set_connectionï¼›</li><li>è¿›è¡Œå†…éƒ¨æ“ä½œå‰å°†è¯·æ±‚æ•°æ®ä»character_set_connectionè½¬æ¢ä¸ºå†…éƒ¨æ“ä½œå­—ç¬¦é›†ï¼Œå…¶ç¡®å®šæ–¹æ³•å¦‚ä¸‹ï¼š<ul><li>ä½¿ç”¨æ¯ä¸ªæ•°æ®å­—æ®µçš„CHARACTER SETè®¾å®šå€¼ï¼›</li><li>è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®è¡¨çš„DEFAULT CHARACTER SETè®¾å®šå€¼(MySQLæ‰©å±•ï¼ŒéSQLæ ‡å‡†)ï¼›</li><li>è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®åº“çš„DEFAULT CHARACTER SETè®¾å®šå€¼ï¼›</li><li>è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨character_set_serverè®¾å®šå€¼ã€‚</li></ul></li><li>å°†æ“ä½œç»“æœä»å†…éƒ¨æ“ä½œå­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_results</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.gif&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="MySQL" scheme="https://jiemin.wang/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://jiemin.wang/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Linux Systemdè¯¦è§£</title>
    <link href="https://jiemin.wang/2019/04/22/linux-systemd/"/>
    <id>https://jiemin.wang/2019/04/22/linux-systemd/</id>
    <published>2019-04-22T05:15:48.000Z</published>
    <updated>2019-04-22T06:08:00.117Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ä¸€åœºè¯´èµ°å°±èµ°çš„æ—…è¡Œï¼Œå›æ¥ç­‰ç€ä½ çš„å°±æ˜¯ä¸€æ®µåƒåœŸçš„æ—¥å­ã€‚</strong></p></blockquote><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Systemdæ˜¯Linuxç³»ç»Ÿå·¥å…·ï¼Œç”¨æ¥å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå·²æˆä¸ºå¤§å¤šæ•°å‘è¡Œç‰ˆçš„æ ‡é…ï¼ŒPIDä¸º1æœ€å…ˆå¯åŠ¨ï¼›</p><p>å†å²ä¸Šï¼ŒLinux çš„å¯åŠ¨ä¸€ç›´é‡‡ç”¨initè¿›ç¨‹ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/apache2 start</span><br><span class="line">æˆ–è€…</span><br><span class="line">$ service apache2 start</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚</p><ul><li>ä¸€æ˜¯å¯åŠ¨æ—¶é—´é•¿ã€‚initè¿›ç¨‹æ˜¯ä¸²è¡Œå¯åŠ¨ï¼Œåªæœ‰å‰ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨å®Œï¼Œæ‰ä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªè¿›ç¨‹ã€‚</li><li>äºŒæ˜¯å¯åŠ¨è„šæœ¬å¤æ‚ã€‚initè¿›ç¨‹åªæ˜¯æ‰§è¡Œå¯åŠ¨è„šæœ¬ï¼Œä¸ç®¡å…¶ä»–äº‹æƒ…ã€‚è„šæœ¬éœ€è¦è‡ªå·±å¤„ç†å„ç§æƒ…å†µï¼Œè¿™å¾€å¾€ä½¿å¾—è„šæœ¬å˜å¾—å¾ˆé•¿ã€‚</li></ul><p>Systemd å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼Œä¸ºç³»ç»Ÿçš„å¯åŠ¨å’Œç®¡ç†æä¾›ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚<br>æ ¹æ® Linux æƒ¯ä¾‹ï¼Œå­—æ¯dæ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„ç¼©å†™ã€‚ Systemd è¿™ä¸ªåå­—çš„å«ä¹‰ï¼Œå°±æ˜¯å®ƒè¦å®ˆæŠ¤æ•´ä¸ªç³»ç»Ÿã€‚<br>CentOS/RHEL7 ä»¥ä¸Šç‰ˆæœ¬ä¸­Systemd å–ä»£äº†initdï¼Œæˆä¸ºç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆPID ç­‰äº 1ï¼‰ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒçš„å­è¿›ç¨‹ã€‚<br>æŸ¥çœ‹ç‰ˆæœ¬ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl --version</span><br></pre></td></tr></tbody></table></figure><p></p><img src="/2019/04/22/linux-systemd/systemd.png" title="systemd"><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><h4 id="systemctl-å‘½ä»¤"><a href="#systemctl-å‘½ä»¤" class="headerlink" title="systemctl å‘½ä»¤"></a>systemctl å‘½ä»¤</h4><p>é‡å¯ç³»ç»Ÿ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reboot</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…³é—­ç³»ç»Ÿï¼Œåˆ‡æ–­ç”µæº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl poweroff</span><br></pre></td></tr></tbody></table></figure><p></p><p>CPUåœæ­¢å·¥ä½œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl halt</span><br></pre></td></tr></tbody></table></figure><p></p><p>æš‚åœç³»ç»Ÿ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">suspend</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>è®©ç³»ç»Ÿè¿›å…¥å†¬çœ çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl hibernate</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®©ç³»ç»Ÿè¿›å…¥äº¤äº’å¼ä¼‘çœ çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl hybrid-sleep</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¯åŠ¨è¿›å…¥æ•‘æ´çŠ¶æ€ï¼ˆå•ç”¨æˆ·çŠ¶æ€ï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl rescue</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>systemd-analyze</code> æ˜¯æŸ¥çœ‹å¯åŠ¨è€—æ—¶</p><p>æŸ¥çœ‹å¯åŠ¨è€—æ—¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æ¯ä¸ªæœåŠ¡çš„å¯åŠ¨è€—æ—¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze blame</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºç€‘å¸ƒçŠ¶çš„å¯åŠ¨è¿‡ç¨‹æµ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze critical-chain</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæŒ‡å®šæœåŠ¡çš„å¯åŠ¨æµ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze critical-chain atd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="hostnamectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚"><a href="#hostnamectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚" class="headerlink" title="hostnamectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚"></a><code>hostnamectl</code>å‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚</h4><p>æ˜¾ç¤ºå½“å‰ä¸»æœºçš„ä¿¡æ¯<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl</span><br><span class="line">```bash</span><br><span class="line">è®¾ç½®ä¸»æœºåã€‚</span><br><span class="line">```bash</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname rhel7</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="localectlå‘½ä»¤ç”¨äºæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚"><a href="#localectlå‘½ä»¤ç”¨äºæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚" class="headerlink" title="localectlå‘½ä»¤ç”¨äºæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚"></a><code>localectl</code>å‘½ä»¤ç”¨äºæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚</h4><p>æŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localectl</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®¾ç½®æœ¬åœ°åŒ–å‚æ•°ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localectl <span class="built_in">set</span>-locale LANG=en_GB.utf8</span><br><span class="line">localectl <span class="built_in">set</span>-keymap en_GB</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="timedatectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚"><a href="#timedatectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚" class="headerlink" title="timedatectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚"></a><code>timedatectl</code>å‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚</h4><p>æŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æ—¶åŒº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®¾ç½®å½“å‰æ—¶åŒº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timedatectl <span class="built_in">set</span>-timezone America/New_York</span><br><span class="line">timedatectl <span class="built_in">set</span>-time YYYY-MM-DD</span><br><span class="line">timedatectl <span class="built_in">set</span>-time HH:MM:SS</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="loginctlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚"><a href="#loginctlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚" class="headerlink" title="loginctlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚"></a><code>loginctl</code>å‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚</h4><p>åˆ—å‡ºå½“å‰session<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl list-sessions</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºå½“å‰ç™»å½•ç”¨æˆ·<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl list-users</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ˜¾ç¤ºæŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginctl show-user ruanyf</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><code>Systemd</code> å¯ä»¥ç®¡ç†æ‰€æœ‰ç³»ç»Ÿèµ„æºã€‚ä¸åŒçš„èµ„æºç»Ÿç§°ä¸º Unitï¼ˆå•ä½ï¼‰ã€‚</p><p><code>Unit</code> ä¸€å…±åˆ†æˆ12ç§ã€‚</p><ul><li><code>Service unit</code>ï¼šç³»ç»ŸæœåŠ¡</li><li><code>Target unit</code>ï¼šå¤šä¸ª Unit æ„æˆçš„ä¸€ä¸ªç»„</li><li><code>Device Unit</code>ï¼šç¡¬ä»¶è®¾å¤‡</li><li><code>Mount Unit</code>ï¼šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹</li><li><code>Automount Unit</code>ï¼šè‡ªåŠ¨æŒ‚è½½ç‚¹</li><li><code>Path Unit</code>ï¼šæ–‡ä»¶æˆ–è·¯å¾„</li><li><code>Scope Unit</code>ï¼šä¸æ˜¯ç”± Systemd å¯åŠ¨çš„å¤–éƒ¨è¿›ç¨‹</li><li><code>Slice Unit</code>ï¼šè¿›ç¨‹ç»„</li><li><code>Snapshot Unit</code>ï¼šSystemd å¿«ç…§ï¼Œå¯ä»¥åˆ‡å›æŸä¸ªå¿«ç…§</li><li><code>Socket Unit</code>ï¼šè¿›ç¨‹é—´é€šä¿¡çš„ socket</li><li><code>Swap Unit</code>ï¼šswap æ–‡ä»¶</li><li><code>Timer Unit</code>ï¼šå®šæ—¶å™¨</li></ul><p><code>systemctl list-units</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Unit ã€‚</p><p>åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„ Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ‰€æœ‰Unitï¼ŒåŒ…æ‹¬æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„æˆ–è€…å¯åŠ¨å¤±è´¥çš„<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --all</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ‰€æœ‰æ²¡æœ‰è¿è¡Œçš„ Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --all --state=inactive</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ‰€æœ‰åŠ è½½å¤±è´¥çš„ Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --failed</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ã€ç±»å‹ä¸º service çš„ Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --<span class="built_in">type</span>=service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-çš„çŠ¶æ€"><a href="#Unit-çš„çŠ¶æ€" class="headerlink" title="Unit çš„çŠ¶æ€"></a><code>Unit</code> çš„çŠ¶æ€</h4><p><code>systemctl status</code>å‘½ä»¤ç”¨äºæŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œå•ä¸ª Unit çš„çŠ¶æ€ã€‚</p><p>æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºå•ä¸ª Unit çš„çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysystemctl status bluetooth.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºè¿œç¨‹ä¸»æœºçš„æŸä¸ª Unit çš„çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl -H root@rhel7.example.com status httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>é™¤äº†<code>status</code>å‘½ä»¤ï¼Œ<code>systemctl</code>è¿˜æä¾›äº†ä¸‰ä¸ªæŸ¥è¯¢çŠ¶æ€çš„ç®€å•æ–¹æ³•ï¼Œä¸»è¦ä¾›è„šæœ¬å†…éƒ¨çš„åˆ¤æ–­è¯­å¥ä½¿ç”¨ã€‚</p><p>æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦æ­£åœ¨è¿è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-active application.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦å¤„äºå¯åŠ¨å¤±è´¥çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-failed application.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæŸä¸ª Unit æœåŠ¡æ˜¯å¦å»ºç«‹äº†å¯åŠ¨é“¾æ¥<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-enabled application.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-ç®¡ç†"><a href="#Unit-ç®¡ç†" class="headerlink" title="Unit ç®¡ç†"></a><code>Unit</code> ç®¡ç†</h4><p>å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ä¸‹é¢è¿™äº›å‘½ä»¤ï¼Œç”¨äºå¯åŠ¨å’Œåœæ­¢ Unitï¼ˆä¸»è¦æ˜¯ serviceï¼‰ã€‚</p><p>ç«‹å³å¯åŠ¨ä¸€ä¸ªæœåŠ¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç«‹å³åœæ­¢ä¸€ä¸ªæœåŠ¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>é‡å¯ä¸€ä¸ªæœåŠ¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ€æ­»ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å­è¿›ç¨‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">kill</span> apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>é‡æ–°åŠ è½½ä¸€ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload apache.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>é‡è½½æ‰€æœ‰ä¿®æ”¹è¿‡çš„é…ç½®æ–‡ä»¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæŸä¸ª Unit çš„æ‰€æœ‰åº•å±‚å‚æ•°<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæŸä¸ª Unit çš„æŒ‡å®šå±æ€§çš„å€¼<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show -p CPUShares httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®¾ç½®æŸä¸ª Unit çš„æŒ‡å®šå±æ€§<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">set</span>-property httpd.service CPUShares=500</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="ä¾èµ–å…³ç³»"><a href="#ä¾èµ–å…³ç³»" class="headerlink" title="ä¾èµ–å…³ç³»"></a>ä¾èµ–å…³ç³»</h4><p><code>Unit</code> ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼šA ä¾èµ–äº Bï¼Œå°±æ„å‘³ç€ Systemd åœ¨å¯åŠ¨ A çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šå»å¯åŠ¨ Bã€‚</p><p><code>systemctl list-dependencies</code>å‘½ä»¤åˆ—å‡ºä¸€ä¸ª Unit çš„æ‰€æœ‰ä¾èµ–ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-dependencies nginx.service</span><br><span class="line">```bash</span><br><span class="line">ä¸Šé¢å‘½ä»¤çš„è¾“å‡ºç»“æœä¹‹ä¸­ï¼Œæœ‰äº›ä¾èµ–æ˜¯ Target ç±»å‹ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œé»˜è®¤ä¸ä¼šå±•å¼€æ˜¾ç¤ºã€‚å¦‚æœè¦å±•å¼€ Targetï¼Œå°±éœ€è¦ä½¿ç”¨--allå‚æ•°ã€‚</span><br><span class="line">```bash</span><br><span class="line">systemctl list-dependencies --all nginx.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Unit-çš„é…ç½®æ–‡ä»¶"><a href="#Unit-çš„é…ç½®æ–‡ä»¶" class="headerlink" title="Unit çš„é…ç½®æ–‡ä»¶"></a>Unit çš„é…ç½®æ–‡ä»¶</h4><p>æ¯ä¸€ä¸ª Unit éƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰ Systemd æ€ä¹ˆå¯åŠ¨è¿™ä¸ª Unit ã€‚</p><p><code>Systemd</code> é»˜è®¤ä»ç›®å½•/etc/systemd/system/è¯»å–é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œé‡Œé¢å­˜æ”¾çš„å¤§éƒ¨åˆ†æ–‡ä»¶éƒ½æ˜¯ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘ç›®å½•/usr/lib/systemd/system/ï¼ŒçœŸæ­£çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨é‚£ä¸ªç›®å½•ã€‚</p><p><code>systemctl enable</code>å‘½ä»¤ç”¨äºåœ¨ä¸Šé¢ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œå»ºç«‹ç¬¦å·é“¾æ¥å…³ç³»ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> clamd@scan.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç­‰åŒäº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s <span class="string">'/usr/lib/systemd/system/clamd@scan.service'</span> <span class="string">'/etc/systemd/system/multi-user.target.wants/clamd@scan.service'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœé…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®äº†å¼€æœºå¯åŠ¨ï¼Œsystemctl enableå‘½ä»¤ç›¸å½“äºæ¿€æ´»å¼€æœºå¯åŠ¨ã€‚</p><p>ä¸ä¹‹å¯¹åº”çš„ï¼Œsystemctl disableå‘½ä»¤ç”¨äºåœ¨ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œæ’¤é”€ç¬¦å·é“¾æ¥å…³ç³»ï¼Œç›¸å½“äºæ’¤é”€å¼€æœºå¯åŠ¨ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> clamd@scan.service</span><br></pre></td></tr></tbody></table></figure><p></p><p>é…ç½®æ–‡ä»¶çš„åç¼€åï¼Œå°±æ˜¯è¯¥ Unit çš„ç§ç±»ï¼Œæ¯”å¦‚sshd.socketã€‚å¦‚æœçœç•¥ï¼ŒSystemd é»˜è®¤åç¼€åä¸º.serviceï¼Œæ‰€ä»¥sshdä¼šè¢«ç†è§£æˆsshd.serviceã€‚</p><p>é…ç½®æ–‡ä»¶çš„çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-fileså‘½ä»¤ç”¨äºåˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ—å‡ºæŒ‡å®šç±»å‹çš„é…ç½®æ–‡ä»¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=service</span><br><span class="line">è¿™ä¸ªå‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªåˆ—è¡¨ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files</span><br></pre></td></tr></tbody></table></figure><h4 id="UNIT-FILE-STATE"><a href="#UNIT-FILE-STATE" class="headerlink" title="UNIT FILE STATE"></a>UNIT FILE STATE</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chronyd.service enabled</span><br><span class="line">clamd@.service static</span><br><span class="line">clamd@scan.service disabled</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªåˆ—è¡¨æ˜¾ç¤ºæ¯ä¸ªé…ç½®æ–‡ä»¶çš„çŠ¶æ€ï¼Œä¸€å…±æœ‰å››ç§ã€‚</p><ul><li>enabledï¼šå·²å»ºç«‹å¯åŠ¨é“¾æ¥</li><li>disabledï¼šæ²¡å»ºç«‹å¯åŠ¨é“¾æ¥</li><li>staticï¼šè¯¥é…ç½®æ–‡ä»¶æ²¡æœ‰[Install]éƒ¨åˆ†ï¼ˆæ— æ³•æ‰§è¡Œï¼‰ï¼Œåªèƒ½ä½œä¸ºå…¶ä»–é…ç½®æ–‡ä»¶çš„ä¾èµ–</li><li>maskedï¼šè¯¥é…ç½®æ–‡ä»¶è¢«ç¦æ­¢å»ºç«‹å¯åŠ¨é“¾æ¥<blockquote><p>æ³¨æ„ï¼Œä»é…ç½®æ–‡ä»¶çš„çŠ¶æ€æ— æ³•çœ‹å‡ºï¼Œè¯¥ Unit æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚è¿™å¿…é¡»æ‰§è¡Œå‰é¢æåˆ°çš„systemctl statuså‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status bluetooth.service</span><br></pre></td></tr></tbody></table></figure></blockquote></li></ul><p>ä¸€æ—¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°±è¦è®© SystemD é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡æ–°å¯åŠ¨ï¼Œå¦åˆ™ä¿®æ”¹ä¸ä¼šç”Ÿæ•ˆã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart httpd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="é…ç½®æ–‡ä»¶çš„æ ¼å¼"><a href="#é…ç½®æ–‡ä»¶çš„æ ¼å¼" class="headerlink" title="é…ç½®æ–‡ä»¶çš„æ ¼å¼"></a>é…ç½®æ–‡ä»¶çš„æ ¼å¼</h4><p>é…ç½®æ–‡ä»¶å°±æ˜¯æ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ã€‚</p><p><code>systemctl cat</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl cat atd.service</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="unit-é…ç½®æ–‡ä»¶"><a href="#unit-é…ç½®æ–‡ä»¶" class="headerlink" title="unit é…ç½®æ–‡ä»¶"></a>unit é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ATD daemon</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/bin/atd</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œé…ç½®æ–‡ä»¶åˆ†æˆå‡ ä¸ªåŒºå—ã€‚æ¯ä¸ªåŒºå—çš„ç¬¬ä¸€è¡Œï¼Œæ˜¯ç”¨æ–¹æ‹¬å·è¡¨ç¤ºçš„åŒºåˆ«åï¼Œæ¯”å¦‚[Unit]ã€‚æ³¨æ„ï¼Œé…ç½®æ–‡ä»¶çš„åŒºå—åå’Œå­—æ®µåï¼Œéƒ½æ˜¯å¤§å°å†™æ•æ„Ÿçš„ã€‚</span><br><span class="line">æ¯ä¸ªåŒºå—å†…éƒ¨æ˜¯ä¸€äº›ç­‰å·è¿æ¥çš„é”®å€¼å¯¹ã€‚</span><br><span class="line"></span><br><span class="line">[Section]</span><br><span class="line">Directive1=value</span><br><span class="line">Directive2=value</span><br><span class="line"></span><br><span class="line">. . .</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ³¨æ„ï¼Œé”®å€¼å¯¹çš„ç­‰å·ä¸¤ä¾§ä¸èƒ½æœ‰ç©ºæ ¼ã€‚</p></blockquote><h4 id="é…ç½®æ–‡ä»¶çš„åŒºåŸŸ"><a href="#é…ç½®æ–‡ä»¶çš„åŒºåŸŸ" class="headerlink" title="é…ç½®æ–‡ä»¶çš„åŒºåŸŸ"></a>é…ç½®æ–‡ä»¶çš„åŒºåŸŸ</h4><p><code>[Unit]</code>åŒºå—é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰ Unit çš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸å…¶ä»– Unit çš„å…³ç³»ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚</p><ul><li>Descriptionï¼šç®€çŸ­æè¿°</li><li>Documentationï¼šæ–‡æ¡£åœ°å€</li><li>Requiresï¼šå½“å‰ Unit ä¾èµ–çš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¼šå¯åŠ¨å¤±è´¥</li><li>Wantsï¼šä¸å½“å‰ Unit é…åˆçš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¸ä¼šå¯åŠ¨å¤±è´¥</li><li>BindsToï¼šä¸Requiresç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ</li><li>Beforeï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹åå¯åŠ¨</li><li>Afterï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹å‰å¯åŠ¨</li><li>Conflictsï¼šè¿™é‡ŒæŒ‡å®šçš„ Unit ä¸èƒ½ä¸å½“å‰ Unit åŒæ—¶è¿è¡Œ</li><li>Conditionâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¸ä¼šè¿è¡Œ</li><li>Assertâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥å¯åŠ¨å¤±è´¥</li></ul><p><code>[Install]</code>é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„æœ€åä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚</p><ul><li>WantedByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .wantsåç¼€æ„æˆçš„å­ç›®å½•ä¸­</li><li>RequiredByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .requiredåç¼€æ„æˆçš„å­ç›®å½•ä¸­</li><li>Aliasï¼šå½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å</li><li>Alsoï¼šå½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit</li></ul><p><code>[Service]</code>åŒºå—ç”¨æ¥ Service çš„é…ç½®ï¼Œåªæœ‰ Service ç±»å‹çš„ Unit æ‰æœ‰è¿™ä¸ªåŒºå—ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚</p><ul><li>Typeï¼šå®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚</li><li>Type=simpleï¼šé»˜è®¤å€¼ï¼Œæ‰§è¡ŒExecStartæŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹</li><li>Type=forkingï¼šä»¥ fork æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º</li><li>Type=oneshotï¼šä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li><li>Type=dbusï¼šå½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨</li><li>Type=notifyï¼šå½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥Systemdï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li><li>Type=idleï¼šè‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ</li><li>ExecStartï¼šå¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤</li><li>ExecStartPreï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤</li><li>ExecStartPostï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</li><li>ExecReloadï¼šé‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤</li><li>ExecStopï¼šåœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤</li><li>ExecStopPostï¼šåœæ­¢å½“å…¶æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</li><li>RestartSecï¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°</li><li>Restartï¼šå®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬alwaysï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€on-successã€on-failureã€on-abnormalã€on-abortã€on-watchdog</li><li>TimeoutSecï¼šå®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°</li><li>Environmentï¼šæŒ‡å®šç¯å¢ƒå˜é‡</li></ul><blockquote><p>Unit é…ç½®æ–‡ä»¶çš„å®Œæ•´å­—æ®µæ¸…å•ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p></blockquote><h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p>å¯åŠ¨è®¡ç®—æœºçš„æ—¶å€™ï¼Œéœ€è¦å¯åŠ¨å¤§é‡çš„ Unitã€‚å¦‚æœæ¯ä¸€æ¬¡å¯åŠ¨ï¼Œéƒ½è¦ä¸€ä¸€å†™æ˜æœ¬æ¬¡å¯åŠ¨éœ€è¦å“ªäº› Unitï¼Œæ˜¾ç„¶éå¸¸ä¸æ–¹ä¾¿ã€‚Systemd çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ Targetã€‚<br>ç®€å•è¯´ï¼ŒTarget å°±æ˜¯ä¸€ä¸ª Unit ç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„ Unit ã€‚å¯åŠ¨æŸä¸ª Target çš„æ—¶å€™ï¼ŒSystemd å°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„ Unitã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTarget è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºâ€çŠ¶æ€ç‚¹â€ï¼Œå¯åŠ¨æŸä¸ª Target å°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚<br>ä¼ ç»Ÿçš„initå¯åŠ¨æ¨¡å¼é‡Œé¢ï¼Œæœ‰ RunLevel çš„æ¦‚å¿µï¼Œè·Ÿ Target çš„ä½œç”¨å¾ˆç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒRunLevel æ˜¯äº’æ–¥çš„ï¼Œä¸å¯èƒ½å¤šä¸ª RunLevel åŒæ—¶å¯åŠ¨ï¼Œä½†æ˜¯å¤šä¸ª Target å¯ä»¥åŒæ—¶å¯åŠ¨ã€‚</p><p>æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=target</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹ä¸€ä¸ª Target åŒ…å«çš„æ‰€æœ‰ Unit<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-dependencies multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤ Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl get-default</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®¾ç½®å¯åŠ¨æ—¶çš„é»˜è®¤ Target<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">set</span>-default multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆ‡æ¢ Target æ—¶ï¼Œé»˜è®¤ä¸å…³é—­å‰ä¸€ä¸ª Target å¯åŠ¨çš„è¿›ç¨‹ï¼Œ<code>systemctl isolate</code> å‘½ä»¤æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œå…³é—­å‰ä¸€ä¸ª Target é‡Œé¢æ‰€æœ‰ä¸å±äºåä¸€ä¸ª Target çš„è¿›ç¨‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl isolate multi-user.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>Target ä¸ ä¼ ç»Ÿ RunLevel çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Traditional runlevel New target name Symbolically linked to...</span><br><span class="line"></span><br><span class="line">Runlevel 0 | runlevel0.target -> poweroff.target</span><br><span class="line">Runlevel 1 | runlevel1.target -> rescue.target</span><br><span class="line">Runlevel 2 | runlevel2.target -> multi-user.target</span><br><span class="line">Runlevel 3 | runlevel3.target -> multi-user.target</span><br><span class="line">Runlevel 4 | runlevel4.target -> multi-user.target</span><br><span class="line">Runlevel 5 | runlevel5.target -> graphical.target</span><br><span class="line">Runlevel 6 | runlevel6.target -> reboot.target</span><br></pre></td></tr></tbody></table></figure><p></p><p>å®ƒä¸initè¿›ç¨‹çš„ä¸»è¦å·®åˆ«å¦‚ä¸‹:</p><ol><li>é»˜è®¤çš„ RunLevelï¼ˆåœ¨/etc/inittabæ–‡ä»¶è®¾ç½®ï¼‰ç°åœ¨è¢«é»˜è®¤çš„ Target å–ä»£ï¼Œä½ç½®æ˜¯/etc/systemd/system/default.targetï¼Œé€šå¸¸ç¬¦å·é“¾æ¥åˆ°graphical.targetï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ–è€…multi-user.targetï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œï¼‰ã€‚</li><li>å¯åŠ¨è„šæœ¬çš„ä½ç½®ï¼Œä»¥å‰æ˜¯/etc/init.dç›®å½•ï¼Œç¬¦å·é“¾æ¥åˆ°ä¸åŒçš„ RunLevel ç›®å½• ï¼ˆæ¯”å¦‚/etc/rc3.dã€/etc/rc5.dç­‰ï¼‰ï¼Œç°åœ¨åˆ™å­˜æ”¾åœ¨/lib/systemd/systemå’Œ/etc/systemd/systemç›®å½•ã€‚</li><li>é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å‰initè¿›ç¨‹çš„é…ç½®æ–‡ä»¶æ˜¯/etc/inittabï¼Œå„ç§æœåŠ¡çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨/etc/sysconfigç›®å½•ã€‚ç°åœ¨çš„é…ç½®æ–‡ä»¶ä¸»è¦å­˜æ”¾åœ¨/lib/systemdç›®å½•ï¼Œåœ¨/etc/systemdç›®å½•é‡Œé¢çš„ä¿®æ”¹å¯ä»¥è¦†ç›–åŸå§‹è®¾ç½®ã€‚</li></ol><h4 id="æ—¥å¿—ç®¡ç†"><a href="#æ—¥å¿—ç®¡ç†" class="headerlink" title="æ—¥å¿—ç®¡ç†"></a>æ—¥å¿—ç®¡ç†</h4><p>Systemd ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ Unit çš„å¯åŠ¨æ—¥å¿—ã€‚å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ï¼Œå¯ä»¥åªç”¨journalctlä¸€ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆå†…æ ¸æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—ï¼‰ã€‚æ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯/etc/systemd/journald.confã€‚</p><p><code>journalctl</code>åŠŸèƒ½å¼ºå¤§ï¼Œç”¨æ³•éå¸¸å¤šã€‚</p><p>æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆä¸æ˜¾ç¤ºåº”ç”¨æ—¥å¿—ï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -k</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b</span><br><span class="line">journalctl -b -0</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼ˆéœ€æ›´æ”¹è®¾ç½®ï¼‰<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -1</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŒ‡å®šæ—¶é—´çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">journalctl --since=<span class="string">"2012-10-30 18:17:16"</span></span><br><span class="line">journalctl --since <span class="string">"20 min ago"</span></span><br><span class="line">journalctl --since yesterday</span><br><span class="line">journalctl --since <span class="string">"2015-01-10"</span> --until <span class="string">"2015-01-11 03:00"</span></span><br><span class="line">journalctl --since 09:00 --until <span class="string">"1 hour ago"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºå°¾éƒ¨çš„æœ€æ–°10è¡Œæ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -n</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºå°¾éƒ¨æŒ‡å®šè¡Œæ•°çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -n 20</span><br></pre></td></tr></tbody></table></figure><p></p><p>å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -f</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl /usr/lib/systemd/systemd</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl _PID=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŸä¸ªè·¯å¾„çš„è„šæœ¬çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl /usr/bin/bash</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl _UID=33 --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service</span><br><span class="line">journalctl -u nginx.service --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæŸä¸ª Unit çš„æœ€æ–°æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service -f</span><br></pre></td></tr></tbody></table></figure><p></p><p>åˆå¹¶æ˜¾ç¤ºå¤šä¸ª Unit çš„æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u nginx.service -u php-fpm.service --since today</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹æŒ‡å®šä¼˜å…ˆçº§ï¼ˆåŠå…¶ä»¥ä¸Šçº§åˆ«ï¼‰çš„æ—¥å¿—ï¼Œå…±æœ‰8çº§</p><ol start="0"><li>0:emerg</li><li>1:alert</li><li>2:crit</li><li>3:err</li><li>4:warning</li><li>5:notice</li><li>6:info</li><li>7:debug<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -p err -b</span><br></pre></td></tr></tbody></table></figure></li></ol><p>æ—¥å¿—é»˜è®¤åˆ†é¡µè¾“å‡ºï¼Œâ€“no-pager æ”¹ä¸ºæ­£å¸¸çš„æ ‡å‡†è¾“å‡º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --no-pager</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä»¥ JSON æ ¼å¼ï¼ˆå•è¡Œï¼‰è¾“å‡º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -u nginx.service -o json</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä»¥ JSON æ ¼å¼ï¼ˆå¤šè¡Œï¼‰è¾“å‡ºï¼Œå¯è¯»æ€§æ›´å¥½<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -b -u nginx.serviceqq -o json-pretty</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ˜¾ç¤ºæ—¥å¿—å æ®çš„ç¡¬ç›˜ç©ºé—´<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --disk-usage</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŒ‡å®šæ—¥å¿—æ–‡ä»¶å æ®çš„æœ€å¤§ç©ºé—´<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --vacuum-size=1G</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šä¹…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --vacuum-time=1years</span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>LinuxæŸ¥çœ‹æœ€æ¶ˆè€—CPUå’Œå†…å­˜çš„è¿›ç¨‹</title>
    <link href="https://jiemin.wang/2019/04/22/cpu-memory/"/>
    <id>https://jiemin.wang/2019/04/22/cpu-memory/</id>
    <published>2019-04-22T05:11:18.000Z</published>
    <updated>2019-04-22T06:12:12.052Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>çœŸæ­£åŠªåŠ›è¿‡çš„äººæ‰çŸ¥é“ï¼Œæ™ºå•†ä¸Šçš„å·®è·æ˜¯ä¸å¯é€¾è¶Šçš„ã€‚</strong></p></blockquote><h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><ol><li><p>CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k3|head -10</span><br></pre></td></tr></tbody></table></figure></li><li><p>å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k4|head -10</span><br></pre></td></tr></tbody></table></figure></li><li><p>è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k5|head -10</span><br></pre></td></tr></tbody></table></figure></li></ol><p>å‡ ä¸ªå‚æ•°å«ä¹‰:</p><ul><li>%MEM è¿›ç¨‹çš„å†…å­˜å ç”¨ç‡</li><li>VSZ è¿›ç¨‹æ‰€ä½¿ç”¨çš„è™šå­˜çš„å¤§å°</li><li>RSS è¿›ç¨‹ä½¿ç”¨çš„é©»ç•™é›†å¤§å°æˆ–è€…æ˜¯å®é™…å†…å­˜çš„å¤§å°(RSS is the â€œresident set sizeâ€ meaning physical memory used)</li><li>TTY ä¸è¿›ç¨‹å…³è”çš„ç»ˆç«¯ï¼ˆttyï¼‰</li><li>ä¸²è¡Œç«¯å£ç»ˆç«¯ï¼ˆ/dev/ttySnï¼‰</li><li>ä¼ªç»ˆç«¯ï¼ˆ/dev/pty/ï¼‰</li><li>æ§åˆ¶ç»ˆç«¯ï¼ˆ/dev/ttyï¼‰</li><li>æ§åˆ¶å°ç»ˆç«¯ï¼ˆ/dev/ttyn, /dev/consoleï¼‰</li><li>è™šæ‹Ÿç»ˆç«¯(/dev/pts/n)</li><li>STAT æ£€æŸ¥çš„çŠ¶æ€ï¼šè¿›ç¨‹çŠ¶æ€ä½¿ç”¨å­—ç¬¦è¡¨ç¤ºçš„ï¼Œå¦‚Rï¼ˆrunningæ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œï¼‰ã€Sï¼ˆsleepingç¡çœ ï¼‰ã€Iï¼ˆidleç©ºé—²ï¼‰ã€Z (åƒµæ­»)ã€Dï¼ˆä¸å¯ä¸­æ–­çš„ç¡çœ ï¼Œé€šå¸¸æ˜¯I/Oï¼‰ã€Pï¼ˆç­‰å¾…äº¤æ¢é¡µï¼‰ã€Wï¼ˆæ¢å‡º,è¡¨ç¤ºå½“å‰é¡µé¢ä¸åœ¨å†…å­˜ï¼‰ã€Nï¼ˆä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼‰T(terminateç»ˆæ­¢)ã€W has no resident pages</li><li>D ä¸å¯ä¸­æ–­ Uninterruptible sleep (usually IO)</li><li>R æ­£åœ¨è¿è¡Œï¼Œæˆ–åœ¨é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹</li><li>S å¤„äºä¼‘çœ çŠ¶æ€</li><li>T åœæ­¢æˆ–è¢«è¿½è¸ª</li><li>Z åƒµå°¸è¿›ç¨‹</li><li>W è¿›å…¥å†…å­˜äº¤æ¢ï¼ˆä»å†…æ ¸2.6å¼€å§‹æ— æ•ˆï¼‰</li><li>X æ­»æ‰çš„è¿›ç¨‹</li><li>< é«˜ä¼˜å…ˆçº§</li><li>N ä½ä¼˜å…ˆçº§</li><li>L æœ‰äº›é¡µè¢«é”è¿›å†…å­˜</li><li>s åŒ…å«å­è¿›ç¨‹</li></ul><p>ä½äºåå°çš„è¿›ç¨‹ç»„</p><ul><li>l å¤šçº¿ç¨‹</li><li>å…‹éš†çº¿ç¨‹ multi-threaded (using CLONE_THREAD, like NPTL pthreads do)</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>NginxæŸ¥çœ‹æˆªå–åˆ‡å‰²æ—¥å¿—</title>
    <link href="https://jiemin.wang/2019/04/22/nginx-log/"/>
    <id>https://jiemin.wang/2019/04/22/nginx-log/</id>
    <published>2019-04-22T05:07:39.000Z</published>
    <updated>2019-04-22T06:11:27.300Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="AAA.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é”™ï¼Œè°è®©ä½ é•¿å¾—ä¸å¥½çœ‹åˆæ²¡é’±ã€‚</strong></p></blockquote><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>nginxæ—¥å¿—æœ€å¥½å®ç°æ¯å¤©å®šæ—¶åˆ‡å‰²ä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨è®¿é—®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸å¤„ç†ï¼Œå¦‚æœæ²¡åˆ‡å‰²ï¼Œå¯ä»¥ç”¨sedç›´æ¥åˆ‡å‰²</p><h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><p>æŸ¥æ‰¾7æœˆ17æ—¥è®¿é—®logå¯¼å‡ºåˆ°17.logæ–‡ä»¶ä¸­<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat gelin_web_access.log | egrep <span class="string">"17/Jul/2017"</span> | sed  -n <span class="string">'/00:00:00/,/23:59:59/p'</span> > /tmp/17.log</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹è®¿é—®é‡å‰10çš„IP<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> 17.log | sort | uniq -c | sort -nr | head -n 10</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹è®¿é—®å‰10çš„URL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $11}'</span> gelin_web_access.log | sort | uniq -c | sort -nr | head -n 10</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„URL<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $7}'</span> gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„IP<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ ¹æ®è®¿é—®IPç»Ÿè®¡UV<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $1}'</span> gelin_web_access.log | sort | uniq -c | wc -l</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç»Ÿè®¡è®¿é—®URLç»Ÿè®¡PV<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'{print $7}'</span> gelin_web_access.log | wc -l</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ ¹æ®æ—¶é—´æ®µç»Ÿè®¡æŸ¥çœ‹æ—¥å¿—<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat gelin_web_access.log | sed -n <span class="string">'/17\/Jul\/2017:12/,/17\/Jul\/2017:13/p'</span> | more</span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;AAA.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux iptables æ•´ç†</title>
    <link href="https://jiemin.wang/2019/04/22/linux-iptables/"/>
    <id>https://jiemin.wang/2019/04/22/linux-iptables/</id>
    <published>2019-04-22T04:51:19.000Z</published>
    <updated>2019-04-22T06:10:30.728Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.gif" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>ä½ æ€»å«Œæœ‰äº›äººæ‡’ï¼Œè¯´å¾—å¥½åƒä½ å‹¤å¿«äº†å°±çœŸèƒ½å¹²å‡ºä»€ä¹ˆå¤§äº‹å„¿ä¸€æ ·ã€‚</strong></p></blockquote><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>iptablesæ˜¯Linuxä¸­é‡è¦çš„è®¿é—®æ§åˆ¶æ‰‹æ®µï¼Œæ˜¯ä¿—ç§°çš„ Linux é˜²ç«å¢™ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¿™é‡Œè®°å½•äº†iptables é˜²ç«å¢™è§„åˆ™çš„ä¸€äº›å¸¸ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‚</p><p>iptablesçš„åŸºæœ¬è¯­æ³•ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t filter/nat] [-A/I] [INPUT/OUTPUT/FORWARD] [-i/o interface] [-p tcp/udp/icmp/all] [-s ip/network] [--sport ports] [-d ip/network] [--dport ports] [-j ACCEPT/DROP]</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°è¯´æ˜:</span><br><span class="line">     ä¸åŠ -tæ—¶é»˜è®¤æ˜¯filter</span><br><span class="line">     </span><br><span class="line">     è¯­æ³•å‚æ•°ï¼š</span><br><span class="line">     -Iï¼šç¬¬ä¸€è¡Œæ’å…¥</span><br><span class="line">     -Aï¼šæœ€åè¿½åŠ  </span><br><span class="line">     -i/oï¼šæŒ‡çš„æ˜¯æ•°æ®è¦è¿›å…¥æˆ–å‡ºå»æ‰€è¦ç»è¿‡çš„ç«¯å£ï¼Œå¦‚eth1,eth0,pppoeç­‰</span><br><span class="line">     -pï¼šä½ æ‰€è¦æŒ‡å®šçš„åè®® </span><br><span class="line">     -sï¼šæŒ‡å®šæ¥æºipï¼Œå¯ä»¥æ˜¯å•ä¸ªipå¦‚192.168.109.131ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘ç»œ 192.168.109.0/24ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªåŸŸåå¦‚163.comï¼Œå¦‚æœä½ å¡«å†™çš„æ˜¯åŸŸåç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå‡ºä»–çš„ipå¹¶åœ¨iptablesé‡Œæ˜¾ç¤º</span><br><span class="line">     --sportï¼šæ¥æºç«¯å£ </span><br><span class="line">     -dï¼šæŒ‡å®šç›®æ ‡ip</span><br><span class="line">     --dportï¼šç›®æ ‡ç«¯å£ </span><br><span class="line">     -jï¼šæ‰§è¡Œå‚æ•°ACCEPTæˆ–DROPï¼ŒREJECTä¸€èˆ¬ä¸ç”¨</span><br><span class="line">     -A åœ¨æŒ‡å®šé“¾çš„æœ«å°¾æ·»åŠ ï¼ˆappendï¼‰ä¸€æ¡æ–°çš„è§„åˆ™</span><br><span class="line">     -D åˆ é™¤ï¼ˆdeleteï¼‰æŒ‡å®šé“¾ä¸­çš„æŸä¸€æ¡è§„åˆ™ï¼Œå¯ä»¥æŒ‰è§„åˆ™åºå·å’Œå†…å®¹åˆ é™¤</span><br><span class="line">     -I åœ¨æŒ‡å®šé“¾ä¸­æ’å…¥ï¼ˆinsertï¼‰ä¸€æ¡æ–°çš„è§„åˆ™ï¼Œé»˜è®¤åœ¨ç¬¬ä¸€è¡Œæ·»åŠ </span><br><span class="line">     -R ä¿®æ”¹ã€æ›¿æ¢ï¼ˆreplaceï¼‰æŒ‡å®šé“¾ä¸­çš„æŸä¸€æ¡è§„åˆ™ï¼Œå¯ä»¥æŒ‰è§„åˆ™åºå·å’Œå†…å®¹æ›¿æ¢</span><br><span class="line">     -L åˆ—å‡ºï¼ˆlistï¼‰æŒ‡å®šé“¾ä¸­æ‰€æœ‰çš„è§„åˆ™è¿›è¡ŒæŸ¥çœ‹</span><br><span class="line">     -E é‡å‘½åç”¨æˆ·å®šä¹‰çš„é“¾ï¼Œä¸æ”¹å˜é“¾æœ¬èº«</span><br><span class="line">     -F æ¸…ç©ºï¼ˆflushï¼‰</span><br><span class="line">     -N æ–°å»ºï¼ˆnew-chainï¼‰ä¸€æ¡ç”¨æˆ·è‡ªå·±å®šä¹‰çš„è§„åˆ™é“¾</span><br><span class="line">     -X åˆ é™¤æŒ‡å®šè¡¨ä¸­ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™é“¾ï¼ˆdelete-chainï¼‰</span><br><span class="line">     -P è®¾ç½®æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆpolicyï¼‰</span><br><span class="line">     -Z å°†æ‰€æœ‰è¡¨çš„æ‰€æœ‰é“¾çš„å­—èŠ‚å’Œæ•°æ®åŒ…è®¡æ•°å™¨æ¸…é›¶</span><br><span class="line">     -n ä½¿ç”¨æ•°å­—å½¢å¼ï¼ˆnumericï¼‰æ˜¾ç¤ºè¾“å‡ºç»“æœ</span><br><span class="line">     -v æŸ¥çœ‹è§„åˆ™è¡¨è¯¦ç»†ä¿¡æ¯ï¼ˆverboseï¼‰çš„ä¿¡æ¯</span><br><span class="line">     -V æŸ¥çœ‹ç‰ˆæœ¬(version)</span><br><span class="line">     -h è·å–å¸®åŠ©ï¼ˆ<span class="built_in">help</span>ï¼‰</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœé…ç½®çš„æ˜¯INPUTï¼ˆè¿›å…¥ï¼‰,åˆ™æ¥æºipæ˜¯è¿ç¨‹ipï¼Œç›®æ ‡ç«¯å£å°±æ˜¯æœ¬æœºï¼›OUTPUTç›¸å</p><img src="/2019/04/22/linux-iptables/iptables.jpeg" title="iptables"><img src="/2019/04/22/linux-iptables/iptables1.png" title="iptables1"><h2 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><p>å½“æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡ä¸»æœºæ—¶ï¼Œç»è¿‡PREROUTINGé“¾,ç»è·¯ç”±ä¹‹åå†³å®šæ˜¯å¦è½¬å‘ï¼Œä¸è½¬å‘åˆ™è¿›å…¥INPUTé“¾ï¼Œåˆ°è¾¾ç”¨æˆ·ç©ºé—´ã€‚è¿›ç¨‹å¯¹å¤–é€šä¿¡æ—¶ï¼Œç»ç”±OUTPUTé“¾å‡ºå»ï¼Œè·¯ç”±ä¹‹ååˆ°è¾¾POSTROUTINGé“¾ï¼Œç»ç½‘å¡å‡ºå»ã€‚å½“ä¸€æ•°æ®åŒ…ç»è¿‡PREROUTINGé“¾å‘ç°å…¶ä¸æ˜¯åˆ°è¾¾æœ¬ä¸»æœºï¼Œé‚£ä¹ˆæ•°æ®åŒ…ç»è¿‡FORWARDé“¾ï¼Œåˆ°è¾¾ POSTROUTINGé“¾è½¬å‘å‡ºå»ã€‚æœ¬æœºè¿›ç¨‹å¯¹å‘é€æ•°æ®æ—¶ï¼Œç»ç”±OUTPUTé“¾è·¯ç”±ä¹‹åè¿›å…¥POSTROUTINGé“¾å‡ºå»ã€‚<br>iptablesåŒ¹é…è§„åˆ™æ—¶ï¼Œæ˜¯è‡ªä¸Šè€Œä¸‹åŒ¹é…çš„ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€æ¡è§„åˆ™æ—¶æ—¢è·³å‡ºï¼Œå¦åˆ™ä¸€ç›´å¾€ä¸‹åŒ¹é…ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤è§„åˆ™ã€‚<br>iptablesè§„åˆ™å»ºç«‹æ—¶ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šåŠŸèƒ½ï¼ˆè¡¨ï¼‰ï¼Œç¡®å®šæŠ¥æ–‡æµå‘ï¼Œç¡®å®šè¦å®ç°çš„ç›®æ ‡ï¼Œç¡®å®šåŒ¹é…æ¡ä»¶ã€‚<br>å°½é‡éµå¾ªä»¥ä¸‹è§„åˆ™ï¼šå°½é‡å‡å°‘è§„åˆ™æ¡ç›®ï¼Œå½¼æ­¤é—´æ— å…³è”ï¼Œè®¿é—®æ¡ç›®å¤§æ”¾ä¸Šé¢ï¼Œæœ‰å…³è”ï¼ˆåŒä¸€åŠŸèƒ½ï¼‰ï¼Œè§„åˆ™æ›´ä¸¥æ ¼çš„æ”¾ä¸Šé¢</p><p>äº”ä¸ªhookå‡½æ•°åˆ†åˆ«æ˜¯<code>PREROUTING</code>,<code>INPUT</code> ,<code>OUTPUT</code>,<code>POSTROUTING</code>,<code>FORWARD</code>ï¼Œæˆ‘ä»¬æŠŠè¿™äº”ä¸ªé’©å­å‡½æ•°ç§°ä¸ºé“¾ï¼ŒNetfilterå®ç°äº†å‡ åŠŸèƒ½ï¼Œ<code>raw</code> ï¼Œ<code>mangle</code>ï¼Œ<code>nat</code>ï¼Œ<code>filter</code>ã€‚æˆ‘ä»¬ä¸€èˆ¬æŠŠè¿™å‡ ä¸ªåŠŸèƒ½ç§°ä¸ºè¡¨ï¼Œè¡¨ä¹‹é—´æœ‰ä¼˜å…ˆçº§å…³ç³»ï¼Œä»ä½åˆ°é«˜ä¸º<code>filterâ€”-natâ€”-mangleâ€”-raw</code>,è¡¨ä¸é“¾ä¹‹é—´æœ‰å¯¹åº”å…³ç³»ï¼Œå…·ä½“è§å›¾è¡¨ã€‚<br><img src="/2019/04/22/linux-iptables/iptables-hook.png" title="iptables-hook"></p><h4 id="è¡¨"><a href="#è¡¨" class="headerlink" title="è¡¨"></a>è¡¨</h4><ul><li>rawè¡¨ï¼š å¯¹æŠ¥æ–‡è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œå†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªæœºåˆ¶å¤„ç†</li><li>mangleè¡¨ï¼š ä¸»è¦ç”¨äºä¿®æ”¹æ•°æ®åŒ…</li><li>natè¡¨ï¼š ä¸»è¦ç”¨å¤„æ˜¯ç½‘ç»œåœ°å€è½¬æ¢ã€ç«¯å£æ˜ å°„</li><li>fileterè¡¨ï¼š ä¸»è¦ç”¨äºè¿‡æ»¤åŒ…</li></ul><p>ä¸€èˆ¬æƒ…å†µæˆ‘ä»¬å¯¹filterè¡¨åšé…ç½®çš„æ›´å¤šã€‚</p><h4 id="é“¾"><a href="#é“¾" class="headerlink" title="é“¾"></a>é“¾</h4><ul><li>INPUTï¼š ä½œç”¨äºè¿›å…¥æœ¬æœºçš„åŒ…</li><li>OUTPUTï¼š ä½œç”¨äºæœ¬æœºé€å‡ºçš„åŒ… </li><li>FORWARDï¼š åŒ¹é…ç©¿è¿‡æœ¬æœºçš„æ•°æ®åŒ…ï¼ˆè½¬å‘ï¼‰ </li><li>PREROUTINGï¼š ç”¨äºä¿®æ”¹ç›®çš„åœ°å€ï¼ˆDNATï¼‰ </li><li>POSTROUTINGï¼šç”¨äºä¿®æ”¹æºåœ°å€ ï¼ˆSNATï¼‰</li></ul><h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¯åŠ¨æŒ‡ä»¤:service iptables start    </span><br><span class="line">é‡å¯æŒ‡ä»¤:service iptables restart    </span><br><span class="line">å…³é—­æŒ‡ä»¤:service iptables stop</span><br><span class="line">ä¿å­˜æŒ‡ä»¤:service iptables save</span><br><span class="line">æ¸…é™¤è§„åˆ™ï¼šiptables -F   </span><br><span class="line">å°†é“¾çš„è®°æ•°çš„æµé‡æ¸…é›¶: iptables -Z</span><br><span class="line">æ¸…é™¤é“¾: iptables -X</span><br><span class="line">æ¸…ç©ºiptablesæ—¶ä¸€èˆ¬-F -Z -Xä¸€èµ·ä½¿ç”¨</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸‰ç§çŠ¶æ€"><a href="#ä¸‰ç§çŠ¶æ€" class="headerlink" title="ä¸‰ç§çŠ¶æ€"></a>ä¸‰ç§çŠ¶æ€</h2><ul><li>ACCEPT å…è®¸</li><li>DROP ä¸¢å¼ƒ</li><li>REJECT æ‹’ç»</li></ul><p>ROPå’ŒREJECTçš„åŒºåˆ«ï¼šDROPæ˜¯ç›´æ¥ä¸è®©è¿›å…¥ï¼Œè€ŒREJECTæ˜¯å…ˆè®©è¿›å…¥ç„¶åå†æ‹’ç»ï¼ŒLOGåœ¨/var/log/messagesæ–‡ä»¶ä¸­è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™.</p><p>DROPæ›´å®‰å…¨ï¼Œæ‰€ä»¥ä¸€èˆ¬æ‹’ç»éƒ½ç”¨DROP</p><p>-Aé»˜è®¤æ˜¯æ’å…¥åˆ°å°¾éƒ¨çš„ï¼Œå¯ä»¥-Iæ¥æ’å…¥åˆ°æŒ‡å®šä½ç½®</p><p>iptablesçš„ä¸¤ç§é…ç½®æ€è·¯:</p><ol><li>é»˜è®¤å…è®¸ï¼Œæ‹’ç»ç‰¹åˆ«</li><li>é»˜è®¤æ‹’ç»ï¼Œå…è®¸ç‰¹åˆ«</li></ol><p>äºŒè€…éƒ½æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼Œçœ‹æƒ…å†µè€Œå®šã€‚ä½†æ˜¯æ³¨æ„ï¼šå¦‚æœè¦é€‰æ‹©ç¬¬äºŒç§é…ç½®æ€è·¯ï¼Œé…ç½®å‰åˆ‡è®°å…ˆæŠŠsshè®¾ç½®ä¸ºACCEPTï¼Œå› ä¸ºä¸€èˆ¬æœºå™¨ä¸åœ¨æˆ‘ä»¬èº«è¾¹ï¼Œä¸€æ—¦é…ç½®é»˜è®¤æ‹’ç»ï¼Œé‚£æˆ‘ä»¬çš„è¿œç¨‹ç™»å½•å°±ä¼šæ–­å¼€è¿æ¥ï¼Œé‚£é—®é¢˜å°±å¤§äº†ã€‚<br>é…ç½®é»˜è®¤æ‹’ç»å‰è®¾ç½®:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT    </span><br><span class="line">iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼šåšä¸€ä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œè®©iptableså®šæœŸåœæ­¢ï¼Œå³æ‰§è¡Œservice iptables stopï¼Œè¿™æ ·çš„è¯å³ä½¿é…ç½®é»˜è®¤æ‹’ç»å‰æ²¡æœ‰å…è®¸sshä¹Ÿæ²¡å…³ç³»ï¼Œç­‰åˆ°è®¡åˆ’ä»»åŠ¡ç”Ÿæ•ˆçš„æ—¶é—´iptableså°±ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰çš„é…ç½®ï¼ŒåŒ…æ‹¬é»˜è®¤è§„åˆ™ã€‚</p><p>iptablesçš„æ‰§è¡Œä¼˜å…ˆçº§:</p><ul><li>iptablesçš„æ‰§è¡Œé¡ºåºæ˜¯è‡ªä¸Šè€Œä¸‹ï¼Œå½“æœ‰é…ç½®äº§ç”Ÿå†²çªæ—¶ï¼Œå‰é¢æ‰§è¡Œçš„ç”Ÿæ•ˆã€‚</li></ul><p>åˆ é™¤iptablesè§„åˆ™<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT 3  //åˆ é™¤inputçš„ç¬¬3æ¡è§„åˆ™</span><br><span class="line">iptables -t nat -D POSTROUTING 1  //åˆ é™¤natè¡¨ä¸­postroutingçš„ç¬¬ä¸€æ¡è§„åˆ™</span><br><span class="line">iptables -F INPUT   //æ¸…ç©º filterè¡¨INPUTæ‰€æœ‰è§„åˆ™</span><br><span class="line">iptables -F    //æ¸…ç©ºæ‰€æœ‰è§„åˆ™</span><br><span class="line">iptables -t nat -F POSTROUTING   //æ¸…ç©ºnatè¡¨POSTROUTINGæ‰€æœ‰è§„åˆ™</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="åˆ é™¤è§„åˆ™"><a href="#åˆ é™¤è§„åˆ™" class="headerlink" title="åˆ é™¤è§„åˆ™"></a>åˆ é™¤è§„åˆ™</h2><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/iptables</span><br><span class="line">åˆ é™¤ç›¸åº”çš„è¡Œï¼Œç„¶å</span><br><span class="line">service iptables restart </span><br><span class="line">service iptables save</span><br></pre></td></tr></tbody></table></figure><p></p><blockquote><p>æ³¨æ„:</p></blockquote><blockquote><p>ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ä¸èƒ½å…ˆsaveï¼Œä¸€å®šè¦å…ˆrestartæ‰èƒ½saveï¼Œè¦ä¸ç„¶å°±ç™½åšäº†ã€‚å› ä¸ºsaveä¼šåœ¨iptablesæœåŠ¡å¯åŠ¨æ—¶é‡æ–°åŠ è½½ï¼Œè¦æ˜¯åœ¨é‡å¯ä¹‹å‰ç›´æ¥å…ˆè°ƒç”¨äº†service iptables save é‚£ä¹ˆä½ çš„/etc/sysconfig/iptables é…ç½®å°±å›æ»šåˆ°ä¸Šæ¬¡å¯åŠ¨æœåŠ¡çš„é…ç½®äº†ã€‚</p></blockquote><p>ç¬¬äºŒç§æ–¹æ³•ï¼šç›´æ¥ç”¨å‘½ä»¤åˆ é™¤</p><p>å¦‚æœä½ è®°å¾—é…ç½®æ—¶çš„å†™æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥<code>iptables -D</code> åè·Ÿä¸Šé…ç½®æ—¶çš„å†™æ³•ã€‚å¦‚ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT -s 10.72.11.12 -p tcp --sport 1234 -d 10.10.2.58 --dport 80 -j DROP</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ–è€…æŸ¥çœ‹æ¯æ¡iptablesçš„åºå·<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -L INPUT --line-numbers</span><br><span class="line">ç„¶ååˆ é™¤</span><br><span class="line">iptables -D INPUT 2  <span class="comment">#åˆ é™¤ç¬¬2æ¡è§„åˆ™ï¼Œå³æ—¶ç”Ÿæ•ˆ</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="é˜²ç«å¢™å¸¸ç”¨çš„ç­–ç•¥"><a href="#é˜²ç«å¢™å¸¸ç”¨çš„ç­–ç•¥" class="headerlink" title="é˜²ç«å¢™å¸¸ç”¨çš„ç­–ç•¥"></a>é˜²ç«å¢™å¸¸ç”¨çš„ç­–ç•¥</h2><p>æ‹’ç»è¿›å…¥é˜²ç«å¢™çš„æ‰€æœ‰ICMPåè®®æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p icmp -j REJECT</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…è®¸é˜²ç«å¢™è½¬å‘é™¤ICMPåè®®ä»¥å¤–çš„æ‰€æœ‰æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p ! icmp -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ‹’ç»è½¬å‘æ¥è‡ª192.168.1.10ä¸»æœºçš„æ•°æ®ï¼Œå…è®¸è½¬å‘æ¥è‡ª192.168.0.0/24ç½‘æ®µçš„æ•°æ®<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s 192.168.1.11 -j REJECT </span><br><span class="line">iptables -A FORWARD -s 192.168.0.0/24 -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸¢å¼ƒä»å¤–ç½‘æ¥å£ï¼ˆeth1ï¼‰è¿›å…¥é˜²ç«å¢™æœ¬æœºçš„æºåœ°å€ä¸ºç§ç½‘åœ°å€çš„æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth1 -s 192.168.0.0/16 -j DROP </span><br><span class="line">iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP </span><br><span class="line">iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</span><br></pre></td></tr></tbody></table></figure><p></p><p>å°å µç½‘æ®µï¼ˆ192.168.1.0/24ï¼‰ï¼Œä¸¤å°æ—¶åè§£å°ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s 10.20.30.0/24 -j DROP </span><br><span class="line">iptables -I FORWARD -s 10.20.30.0/24 -j DROP </span><br><span class="line">at now 2 hours at> iptables -D INPUT 1 at> iptables -D FORWARD 1</span><br></pre></td></tr></tbody></table></figure><p></p><p>åªå…è®¸ç®¡ç†å‘˜ä»202.13.0.0/16ç½‘æ®µä½¿ç”¨SSHè¿œç¨‹ç™»å½•é˜²ç«å¢™ä¸»æœºã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -s 202.13.0.0/16 -j ACCEPT </span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…è®¸æœ¬æœºå¼€æ”¾ä»TCPç«¯å£20-1024æä¾›çš„åº”ç”¨æœåŠ¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 20:1024 -j ACCEPT </span><br><span class="line">iptables -A OUTPUT -p tcp --sport 20:1024 -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…è®¸è½¬å‘æ¥è‡ª192.168.0.0/24å±€åŸŸç½‘æ®µçš„DNSè§£æè¯·æ±‚æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s 192.168.0.0/24 -p udp --dport 53 -j ACCEPT </span><br><span class="line">iptables -A FORWARD -d 192.168.0.0/24 -p udp --sport 53 -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç¦æ­¢å…¶ä»–ä¸»æœºpingé˜²ç«å¢™ä¸»æœºï¼Œä½†æ˜¯å…è®¸ä»é˜²ç«å¢™ä¸Špingå…¶ä»–ä¸»æœº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p icmp --icmp-type Echo-Request -j DROP </span><br><span class="line">iptables -I INPUT -p icmp --icmp-type Echo-Reply -j ACCEPT </span><br><span class="line">iptables -I INPUT -p icmp --icmp-type destination-Unreachable -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç¦æ­¢è½¬å‘æ¥è‡ªMACåœ°å€ä¸º00ï¼š0Cï¼š29ï¼š27ï¼š55ï¼š3Fçš„å’Œä¸»æœºçš„æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -m mac --mac-source 00:0c:29:27:55:3F -j DROP</span><br><span class="line">è¯´æ˜ï¼šiptablesä¸­ä½¿ç”¨â€œ-m æ¨¡å—å…³é”®å­—â€çš„å½¢å¼è°ƒç”¨æ˜¾ç¤ºåŒ¹é…ã€‚è¿™é‡Œç”¨â€œ-m mac â€“mac-sourceâ€æ¥è¡¨ç¤ºæ•°æ®åŒ…çš„æºMACåœ°å€ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p>å…è®¸é˜²ç«å¢™æœ¬æœºå¯¹å¤–å¼€æ”¾TCPç«¯å£20ã€21ã€25ã€110ä»¥åŠè¢«åŠ¨æ¨¡å¼FTPç«¯å£1250-1280<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m multiport --dport 20,21,25,110,1250:1280 -j ACCEPT</span><br><span class="line">è¯´æ˜ï¼šè¿™é‡Œç”¨â€œ-m multiport â€“dportâ€æ¥æŒ‡å®šç›®çš„ç«¯å£åŠèŒƒå›´</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç¦æ­¢è½¬å‘æºIPåœ°å€ä¸º192.168.1.20-192.168.1.99çš„TCPæ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p tcp -m iprange --src-range 192.168.1.20-192.168.1.99 -j DROP</span><br><span class="line">è¯´æ˜ï¼šæ­¤å¤„ç”¨â€œ-m â€“iprange â€“src-rangeâ€æŒ‡å®šIPèŒƒå›´ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç¦æ­¢è½¬å‘ä¸æ­£å¸¸TCPè¿æ¥æ— å…³çš„éâ€”synè¯·æ±‚æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -m state --state NEW -p tcp ! --syn -j DROP</span><br><span class="line">è¯´æ˜ï¼šâ€œ-m stateâ€è¡¨ç¤ºæ•°æ®åŒ…çš„è¿æ¥çŠ¶æ€ï¼Œâ€œNEWâ€è¡¨ç¤ºä¸ä»»ä½•è¿æ¥æ— å…³çš„</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ‹’ç»è®¿é—®é˜²ç«å¢™çš„æ–°æ•°æ®åŒ…ï¼Œä½†å…è®¸å“åº”è¿æ¥æˆ–ä¸å·²æœ‰è¿æ¥ç›¸å…³çš„æ•°æ®åŒ…<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -j DROP </span><br><span class="line">iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¯´æ˜ï¼šâ€œESTABLISHEDâ€è¡¨ç¤ºå·²ç»å“åº”è¯·æ±‚æˆ–è€…å·²ç»å»ºç«‹è¿æ¥çš„æ•°æ®åŒ…ï¼Œâ€œRELATEDâ€è¡¨ç¤ºä¸å·²å»ºç«‹çš„è¿æ¥æœ‰ç›¸å…³æ€§çš„ï¼Œæ¯”å¦‚FTPæ•°æ®è¿æ¥ç­‰ã€‚</p><p>åªå¼€æ”¾æœ¬æœºçš„webæœåŠ¡ï¼ˆ80ï¼‰ã€FTP(20ã€21ã€20450-20480)ï¼Œæ”¾è¡Œå¤–éƒ¨ä¸»æœºå‘ä½æœåŠ¡å™¨å…¶å®ƒç«¯å£çš„åº”ç­”æ•°æ®åŒ…ï¼Œå°†å…¶ä»–å…¥ç«™æ•°æ®åŒ…å‡äºˆä»¥ä¸¢å¼ƒå¤„ç†ã€‚<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp -m multiport --dport 20,21,80 -j ACCEPT </span><br><span class="line">iptables -I INPUT -p tcp --dport 20450:20480 -j ACCEPT </span><br><span class="line">iptables -I INPUT -p tcp -m state --state ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -P INPUT DROP</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸‹é¢ä¸¤å¥è¯å¯ä»¥å®šä¹‰é»˜è®¤å…¨éƒ¨ä¸¢å¼ƒæ•°æ®åŒ…ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br></pre></td></tr></tbody></table></figure><p></p><p>-På‚æ•°çš„æ„æ€æ˜¯policyï¼Œç¿»è¯‘æˆç­–ç•¥ï½é‚£ä¹ˆè¿™ä¸¤å¥è¯å°±å¥½ç†è§£äº†ã€‚</p><p>ç¬¬ä¸€å¥çš„æ„æ€æ˜¯ï¼š</p><p>è¾“å…¥(INPUT)çš„æ•°æ®åŒ…é»˜è®¤çš„ç­–ç•¥(-P)æ˜¯ä¸¢å¼ƒ(DROP)çš„</p><p>ç¬¬äºŒå¥çš„æ„æ€æ˜¯ï¼š</p><p>è¾“å‡º(OUTPUT)çš„æ•°æ®åŒ…é»˜è®¤çš„ç­–ç•¥(-P)æ˜¯ä¸¢å¼ƒ(DROP)çš„</p><p>å…¶å®åˆ°è¿™é‡Œå·²ç»æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„é˜²ç«å¢™äº†ï¼Œåªä¸è¿‡ï¼Œæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå’Œæ‹”æ‰ç½‘çº¿çš„æ¦‚å¿µæ²¡æœ‰ä»€ä¹ˆä¸åŒ</p><p>é¦–å…ˆå†™ä¸‹è¿™6å¥è¯<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type any -j ACCEPT</span><br><span class="line">å…è®¸icmpåŒ…è¿›å…¥</span><br><span class="line">iptables -A INPUT -s localhost -d localhost -j ACCEPT</span><br><span class="line">å…è®¸æœ¬åœ°çš„æ•°æ®åŒ…</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">å…è®¸å·²ç»å»ºç«‹å’Œç›¸å…³çš„æ•°æ®åŒ…è¿›å…¥</span><br><span class="line">iptables -A OUTPUT -p icmp --icmp any -j ACCEPT</span><br><span class="line">å…è®¸icmpåŒ…å‡ºå»</span><br><span class="line">iptables -A OUTPUT -s localhost -d localhost -j ACCEPT</span><br><span class="line">å…è®¸æœ¬åœ°æ•°æ®åŒ…</span><br><span class="line">iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">å…è®¸å·²ç»å»ºç«‹å’Œç›¸å…³çš„æ•°æ®åŒ…å‡ºå»</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¯´æ˜ä¸€ä¸‹ï¼Œè¿™6å¥åŸºæœ¬ä¸Šéƒ½æ˜¯è¦çš„</p><p>æŸ¥çœ‹natè¡¨<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -vnL POSTROUTING --line-number  </span><br><span class="line">Chain POSTROUTING (policy ACCEPT 38 packets, 2297 bytes)  </span><br><span class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination  </span><br><span class="line">1        0     0 MASQUERADE  all  --  *      *       192.168.10.0/24      0.0.0.0/0</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹filterè¡¨<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n --line-number |grep 21 //--line-numberå¯ä»¥æ˜¾ç¤ºè§„åˆ™åºå·ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™æ¯”è¾ƒæ–¹ä¾¿  </span><br><span class="line">5    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0           tcp dpt:21</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h4 id="é™„æœ€ç»å…¸çš„iptablesè„šæœ¬"><a href="#é™„æœ€ç»å…¸çš„iptablesè„šæœ¬" class="headerlink" title="é™„æœ€ç»å…¸çš„iptablesè„šæœ¬"></a>é™„æœ€ç»å…¸çš„iptablesè„šæœ¬</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">modprobe ipt_MASQUERADE</span><br><span class="line">modprobe ip_conntrack_ftp</span><br><span class="line">modprobe ip_nat_ftp</span><br><span class="line">iptables -F</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -t nat -X</span><br><span class="line"><span class="comment">###########################INPUTé”®###################################</span></span><br><span class="line"></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m multiport --dports 110,80,25 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 139 -j ACCEPT</span><br><span class="line"><span class="comment">#å…è®¸å†…ç½‘samba,smtp,pop3,è¿æ¥</span></span><br><span class="line">iptables -A INPUT -i eth1 -p udp -m multiport --dports 53 -j ACCEPT</span><br><span class="line"><span class="comment">#å…è®¸dnsè¿æ¥</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 1723 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p gre -j ACCEPT</span><br><span class="line"><span class="comment">#å…è®¸å¤–ç½‘vpnè¿æ¥</span></span><br><span class="line">iptables -A INPUT -s 192.186.0.0/24 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -i ppp0 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP</span><br><span class="line"><span class="comment">#ä¸ºäº†é˜²æ­¢DOSå¤ªå¤šè¿æ¥è¿›æ¥,é‚£ä¹ˆå¯ä»¥å…è®¸æœ€å¤š15ä¸ªåˆå§‹è¿æ¥,è¶…è¿‡çš„ä¸¢å¼ƒ</span></span><br><span class="line">iptables -A INPUT -s 192.186.0.0/24 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP</span><br><span class="line"><span class="comment">#ä¸ºäº†é˜²æ­¢DOSå¤ªå¤šè¿æ¥è¿›æ¥,é‚£ä¹ˆå¯ä»¥å…è®¸æœ€å¤š15ä¸ªåˆå§‹è¿æ¥,è¶…è¿‡çš„ä¸¢å¼ƒ</span></span><br><span class="line">iptables -A INPUT -p icmp -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/s -j LOG --<span class="built_in">log</span>-level INFO --<span class="built_in">log</span>-prefix <span class="string">"ICMP packet IN: "</span></span><br><span class="line">iptables -A INPUT -p icmp -j DROP</span><br><span class="line"><span class="comment">#ç¦æ­¢icmpé€šä¿¡-ping ä¸é€š</span></span><br><span class="line">iptables -t nat -A POSTROUTING -o ppp0 -s 192.168.0.0/24 -j MASQUERADE</span><br><span class="line"><span class="comment">#å†…ç½‘è½¬å‘</span></span><br><span class="line">iptables -N syn-flood</span><br><span class="line">iptables -A INPUT -p tcp --syn -j syn-flood</span><br><span class="line">iptables -I syn-flood -p tcp -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/s --<span class="built_in">limit</span>-burst 6 -j RETURN</span><br><span class="line">iptables -A syn-flood -j REJECT</span><br><span class="line"><span class="comment">#é˜²æ­¢SYNæ”»å‡» è½»é‡</span></span><br><span class="line"><span class="comment">#######################FORWARDé“¾###########################</span></span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -p tcp -s 192.168.0.0/24 -m multiport --dports 80,110,21,25,1723 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p udp -s 192.168.0.0/24 --dport 53 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p gre -s 192.168.0.0/24 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p icmp -s 192.168.0.0/24 -j ACCEPT</span><br><span class="line"><span class="comment">#å…è®¸ vpnå®¢æˆ·èµ°vpnç½‘ç»œè¿æ¥å¤–ç½‘</span></span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -I FORWARD -p udp --dport 53 -m string --string <span class="string">"tencent"</span> -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line"><span class="comment">#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqé€šä¿¡</span></span><br><span class="line">iptables -I FORWARD -p udp --dport 53 -m string --string <span class="string">"TENCENT"</span> -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line"><span class="comment">#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqé€šä¿¡</span></span><br><span class="line">iptables -I FORWARD -p udp --dport 53 -m string --string <span class="string">"tencent"</span> -m time --timestart 13:30 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line">iptables -I FORWARD -p udp --dport 53 -m string --string <span class="string">"TENCENT"</span> -m time --timestart 13:30 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line"><span class="comment">#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„13:30-20:30ç¦æ­¢QQé€šä¿¡</span></span><br><span class="line">iptables -I FORWARD -s 192.168.0.0/24 -m string --string <span class="string">"qq.com"</span> -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line"><span class="comment">#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqç½‘é¡µ</span></span><br><span class="line">iptables -I FORWARD -s 192.168.0.0/24 -m string --string <span class="string">"qq.com"</span> -m time --timestart 13:00 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat  -j DROP</span><br><span class="line"><span class="comment">#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„13:30-20:30ç¦æ­¢QQç½‘é¡µ</span></span><br><span class="line">iptables -I FORWARD -s 192.168.0.0/24 -m string --string <span class="string">"ay2000.net"</span> -j DROP</span><br><span class="line">iptables -I FORWARD -d 192.168.0.0/24 -m string --string <span class="string">"å®½é¢‘å½±é™¢"</span> -j DROP</span><br><span class="line">iptables -I FORWARD -s 192.168.0.0/24 -m string --string <span class="string">"è‰²æƒ…"</span> -j DROP</span><br><span class="line">iptables -I FORWARD -p tcp --sport 80 -m string --string <span class="string">"å¹¿å‘Š"</span> -j DROP</span><br><span class="line"><span class="comment">#ç¦æ­¢ay2000.netï¼Œå®½é¢‘å½±é™¢ï¼Œè‰²æƒ…ï¼Œå¹¿å‘Šç½‘é¡µè¿æ¥ ï¼ä½†ä¸­æ–‡ ä¸æ˜¯å¾ˆç†æƒ³</span></span><br><span class="line">iptables -A FORWARD -m ipp2p --edk --kazaa --bit -j DROP</span><br><span class="line">iptables -A FORWARD -p tcp -m ipp2p --ares -j DROP</span><br><span class="line">iptables -A FORWARD -p udp -m ipp2p --kazaa -j DROP</span><br><span class="line"><span class="comment">#ç¦æ­¢BTè¿æ¥</span></span><br><span class="line">iptables -A FORWARD -p tcp --syn --dport 80 -m connlimit --connlimit-above 15 --connlimit-mask 24</span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line">sysctl -w net.ipv4.ip_forward=1 &>/dev/null</span><br><span class="line"><span class="comment">#æ‰“å¼€è½¬å‘</span></span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line">sysctl -w net.ipv4.tcp_syncookies=1 &>/dev/null</span><br><span class="line"><span class="comment">#æ‰“å¼€ syncookie ï¼ˆè½»é‡çº§é¢„é˜² DOS æ”»å‡»ï¼‰</span></span><br><span class="line">sysctl -w net.ipv4.netfilter.ip_conntrack_tcp_timeout_established=3800 &>/dev/null</span><br><span class="line"><span class="comment">#è®¾ç½®é»˜è®¤ TCP è¿æ¥ç—´å‘†æ—¶é•¿ä¸º 3800 ç§’ï¼ˆæ­¤é€‰é¡¹å¯ä»¥å¤§å¤§é™ä½è¿æ¥æ•°ï¼‰</span></span><br><span class="line">sysctl -w net.ipv4.ip_conntrack_max=300000 &>/dev/null</span><br><span class="line"><span class="comment">#è®¾ç½®æ”¯æŒæœ€å¤§è¿æ¥æ ‘ä¸º 30Wï¼ˆè¿™ä¸ªæ ¹æ®ä½ çš„å†…å­˜å’Œ iptables ç‰ˆæœ¬æ¥ï¼Œæ¯ä¸ª connection éœ€è¦ 300 å¤šä¸ªå­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line">iptables -I INPUT -s 192.168.0.50 -j ACCEPT</span><br><span class="line">iptables -I FORWARD -s 192.168.0.50 -j ACCEPT</span><br><span class="line"><span class="comment">#192.168.0.50æ˜¯æˆ‘çš„æœºå­ï¼Œå…¨éƒ¨æ”¾è¡Œï¼</span></span><br><span class="line"><span class="comment">############################å®Œ#########################################</span></span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.gif&quot; class=&quot;full-image&quot; alt=&quot;a
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>linux awk å‘½ä»¤</title>
    <link href="https://jiemin.wang/2019/04/22/linux-awk/"/>
    <id>https://jiemin.wang/2019/04/22/linux-awk/</id>
    <published>2019-04-22T04:45:12.000Z</published>
    <updated>2019-04-22T06:09:00.982Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="AAA.jpg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>å¯¹ä»Šå¤©è§£å†³ä¸äº†çš„äº‹æƒ…ï¼Œä¹Ÿä¸è¦ç€æ€¥ã€‚å› ä¸ºæ˜å¤©ä¹Ÿå¯èƒ½è¿˜æ˜¯è§£å†³ä¸äº†ã€‚</strong></p></blockquote><h2 id="awkå‘½ä»¤ä¾‹å­ï¼š"><a href="#awkå‘½ä»¤ä¾‹å­ï¼š" class="headerlink" title="awkå‘½ä»¤ä¾‹å­ï¼š"></a>awkå‘½ä»¤ä¾‹å­ï¼š</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ‰“å°æ–‡ä»¶çš„ç¬¬ä¸€åˆ—(åŸŸ)  awk <span class="string">'{print $1}'</span> filename</span><br><span class="line">æ‰“å°æ–‡ä»¶çš„å‰ä¸¤åˆ—(åŸŸ)  awk <span class="string">'{print $1,$2}'</span> filename</span><br><span class="line">æ‰“å°å®Œç¬¬ä¸€åˆ—ï¼Œç„¶åæ‰“å°ç¬¬äºŒåˆ—  awk <span class="string">'{print $1 $2}'</span> filename</span><br><span class="line">æ‰“å°æ–‡æœ¬æ–‡ä»¶çš„æ€»è¡Œæ•°  awk <span class="string">'END{print NR}'</span> filename</span><br><span class="line">æ‰“å°æ–‡æœ¬ç¬¬ä¸€è¡Œ       awk <span class="string">'NR==1{print}'</span> filename</span><br><span class="line">æ‰“å°æ–‡æœ¬ç¬¬äºŒè¡Œç¬¬ä¸€åˆ—  sed -n <span class="string">"2, 1p"</span> filename | awk <span class="string">'print $1'</span></span><br></pre></td></tr></tbody></table></figure><p>Bashé‡Œé¢çš„èµ‹å€¼æ–¹æ³•æœ‰ä¸¤ç§ï¼Œæ ¼å¼ä¸º<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) arg=`(å‘½ä»¤)`</span><br><span class="line">2) arg=$(å‘½ä»¤)</span><br></pre></td></tr></tbody></table></figure><p></p><p>æƒ³è¦æŠŠæŸä¸€æ–‡ä»¶çš„æ€»è¡Œæ•°èµ‹å€¼ç»™å˜é‡nlinesï¼Œå¯ä»¥è¡¨è¾¾ä¸ºï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) nlines=`(awk <span class="string">'END{print NR}'</span> filename)`</span><br><span class="line">æˆ–</span><br><span class="line">2) nlines=$(awk <span class="string">'END{print NR}'</span> filename)</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'/[^0-9][0-9].*Starting the backup operation/{print $1,$2}'</span> /data/backup/logs/all.log</span><br><span class="line"><span class="comment">#181217 02:12:48</span></span><br><span class="line"><span class="comment">#181217 02:12:48 innobackupex: Starting the backup operation</span></span><br><span class="line">awk <span class="string">'/[^0-9][0-9].*OK\!/{print $1,$2}'</span> /data/backup/logs/all.log</span><br><span class="line"><span class="comment">#181217 03:51:21</span></span><br><span class="line"><span class="comment">#181217 03:51:21 completed OK!</span></span><br></pre></td></tr></tbody></table></figure><p>æ—¶é—´ç›¸å‡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN{tstamp1=mktime("2108 12 18 02 12 48");tstamp2=mktime("2018 12 19 03 51 12");print tstamp2-tstamp1;}'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä»åº“å‘¨æœŸæ€§å»¶è¿Ÿ éœ€è¦ä½ ä»binlogä¸­æ‰¾å‡ºæ‰¾ä¸ªbinlog å„ç§æ“ä½œçš„ç»Ÿè®¡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --no-defaults --base64-output=<span class="string">'decode-rows'</span> -v -v mysql-bin.004177 | awk <span class="string">'/UPDATE|INSERT|DELETE/{gsub("###","");gsub("INSERT.*INTO","INSERT");gsub("DELETE.*FROM","DELETE");count[$1" "$2]++}END{for(i in count)print i,"\t",count[i]}'</span> |sort -k3nr|head -n 20</span><br></pre></td></tr></tbody></table></figure><p></p><p>netstat and AWK<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | awk <span class="string">'/^tcp/ {++S[$NF]};END {for(a in S) print a,S[a]}'</span></span><br><span class="line">netstat -an | awk <span class="string">'/^tcp/ {++state[$NF]}; END {for(key in state) print key,"\t",state[key]}'</span></span><br><span class="line">netstat -ant | awk <span class="string">'{print $NF}'</span> | grep -v <span class="string">'[a-z]'</span> | sort | uniq -c</span><br><span class="line"></span><br><span class="line">netstat -anlp | grep 3306 | grep tcp | awk <span class="string">'{print $5}'</span> | awk -F: <span class="string">'{print $1}'</span> | sort | uniq -c | sort -nr | head -n20</span><br><span class="line">netstat -ant | awk <span class="string">'/:3306/{split($5,ip,":");++A[ip[1]]}END{for(i in A) print A[i],i}'</span> | sort -nr | head -n20</span><br><span class="line"></span><br><span class="line">netstat -an | grep SYN | awk <span class="string">'{print $5}'</span> | awk -F: <span class="string">'{print $1}'</span> | sort | uniq -c | sort -nr | more</span><br><span class="line">tcpdump -i eno16777736 -tnn dst port 80 -c 1000 | awk -F<span class="string">"."</span> <span class="string">'{print $1"."$2"."$3"."$4}'</span> | sort | uniq -c | sort -nr | head -20</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹è¡¨çš„å¤§å°æ’åº<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">du -s *|grep ibd|sort|uniq -u|sort -nr|awk <span class="string">'{print $2}'</span>|xargs du -sh</span><br><span class="line">du -s *|grep ibd|sort|uniq -u|sort -nr|awk <span class="string">'{print $2}'</span>|sort|uniq -u|xargs du -sh</span><br></pre></td></tr></tbody></table></figure><p></p><p>åƒµå°¸è¿›ç¨‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -A -o <span class="built_in">stat</span>,ppid,pid,cmd | grep -e <span class="string">'\'</span><span class="string">'^[Zz]'</span>\<span class="string">''</span> | awk <span class="string">'\'</span><span class="string">'{print }'</span>\<span class="string">''</span> | xargs <span class="built_in">kill</span> -9<span class="string">'</span></span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;AAA.jpg&quot; class=&quot;full-image&quot; alt=&quot;al
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨FIOæµ‹è¯•ä¸»æœºIOPSåŠå†™å…¥è¯»å–é€Ÿåº¦</title>
    <link href="https://jiemin.wang/2019/04/22/linux-fio/"/>
    <id>https://jiemin.wang/2019/04/22/linux-fio/</id>
    <published>2019-04-22T02:30:01.000Z</published>
    <updated>2019-04-22T03:27:56.215Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>åˆ«è¯´ä½ ä¸€æ— æ‰€é•¿ï¼Œç†¬å¤œç©æ‰‹æœºä½ æ˜¯ä¸€æŠŠå¥½æ‰‹ã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å®‰è£…FIO<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install fio -y</span><br></pre></td></tr></tbody></table></figure><p></p><p>å‚æ•°è¯´æ˜:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bs=4k                    å•æ¬¡ioçš„å—æ–‡ä»¶å¤§å°ä¸º4k</span><br><span class="line">bsrange=512-2048         åŒä¸Šï¼Œæå®šæ•°æ®å—çš„å¤§å°èŒƒå›´</span><br><span class="line">size=5g                  æœ¬æ¬¡çš„æµ‹è¯•æ–‡ä»¶å¤§å°ä¸º5gï¼Œä»¥æ¯æ¬¡4kçš„ioè¿›è¡Œæµ‹è¯•</span><br><span class="line">numjobs=30               æœ¬æ¬¡çš„æµ‹è¯•çº¿ç¨‹ä¸º30</span><br><span class="line">runtime=1000             æµ‹è¯•æ—¶é—´ä¸º1000ç§’ï¼Œå¦‚æœä¸å†™åˆ™ä¸€ç›´å°†5gæ–‡ä»¶åˆ†4kæ¯æ¬¡å†™å®Œä¸ºæ­¢</span><br><span class="line">ioengine=psync           ioå¼•æ“ä½¿ç”¨pyncæ–¹å¼ï¼Œå¦‚æœè¦ä½¿ç”¨libaioå¼•æ“ï¼Œéœ€è¦yum install libaio-develåŒ…</span><br><span class="line">rwmixwrite=30            åœ¨æ··åˆè¯»å†™çš„æ¨¡å¼ä¸‹ï¼Œå†™å 30%</span><br><span class="line">group_reporting          å…³äºæ˜¾ç¤ºç»“æœçš„ï¼Œæ±‡æ€»æ¯ä¸ªè¿›ç¨‹çš„ä¿¡æ¯æ­¤å¤–</span><br><span class="line">lockmem=1g               åªä½¿ç”¨1gå†…å­˜è¿›è¡Œæµ‹è¯•</span><br><span class="line">zero_buffers             ç”¨0åˆå§‹åŒ–ç³»ç»Ÿbuffer</span><br><span class="line">nrfiles=8                æ¯ä¸ªè¿›ç¨‹ç”Ÿæˆæ–‡ä»¶çš„æ•°é‡</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="FIO-å‘½ä»¤"><a href="#FIO-å‘½ä»¤" class="headerlink" title="FIO å‘½ä»¤"></a>FIO å‘½ä»¤</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">fio -direct=1 -iodepth=128 -rw=write -ioengine=libaio -bs=4k -size=100G -numjobs=1 -runtime=1000 -group_reporting -name=<span class="built_in">test</span> -filename=/data/test111</span><br><span class="line"></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line"><span class="built_in">test</span>: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=128</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 1 process</span><br><span class="line"><span class="built_in">test</span>: Laying out IO file(s) (1 file(s) / 102400MB)</span><br><span class="line">Jobs: 1 (f=1): [W] [100.0% <span class="keyword">done</span>] [0K/129.3M/0K /s] [0 /33.1K/0  iops] [eta 00m:00s]</span><br><span class="line"><span class="built_in">test</span>: (groupid=0, <span class="built_in">jobs</span>=1): err= 0: pid=594: Mon May 14 10:27:54 2018</span><br><span class="line">  write: io=102400MB, bw=129763KB/s, iops=32440 , runt=808070msec</span><br><span class="line">    slat (usec): min=0 , max=80322 , avg=12.06, stdev=24.73</span><br><span class="line">    clat (usec): min=222 , max=254410 , avg=3932.47, stdev=5007.90</span><br><span class="line">     lat (usec): min=622 , max=254416 , avg=3944.82, stdev=5007.26</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 1288],  5.00th=[ 1560], 10.00th=[ 1736], 20.00th=[ 1992],</span><br><span class="line">     | 30.00th=[ 2224], 40.00th=[ 2480], 50.00th=[ 2736], 60.00th=[ 3088],</span><br><span class="line">     | 70.00th=[ 3536], 80.00th=[ 4320], 90.00th=[ 6624], 95.00th=[ 9664],</span><br><span class="line">     | 99.00th=[21120], 99.50th=[37632], 99.90th=[54528], 99.95th=[78336],</span><br><span class="line">     | 99.99th=[177152]</span><br><span class="line">    bw (KB/s)  : min=20720, max=215424, per=100.00%, avg=129801.50, stdev=19878.75</span><br><span class="line">    lat (usec) : 250=0.01%, 750=0.01%, 1000=0.09%</span><br><span class="line">    lat (msec) : 2=20.47%, 4=56.01%, 10=18.78%, 20=3.20%, 50=1.33%</span><br><span class="line">    lat (msec) : 100=0.09%, 250=0.02%, 500=0.01%</span><br><span class="line">  cpu          : usr=4.88%, sys=36.64%, ctx=9409837, majf=0, minf=23</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, >=64=100.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.1%</span><br><span class="line">     issued    : total=r=0/w=26214400/d=0, short=r=0/w=0/d=0</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: io=102400MB, aggrb=129763KB/s, minb=129763KB/s, maxb=129763KB/s, mint=808070msec, maxt=808070msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  vdb: ios=0/26203032, merge=0/3962, ticks=0/90681446, in_queue=90672667, util=100.00%</span><br></pre></td></tr></tbody></table></figure><p>100%éšæœºï¼Œ100%è¯»ï¼Œ4K<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=rand_100read_4k</span><br><span class="line"></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line">rand_100read_4k: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">rand_100read_4k: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 50 threads</span><br><span class="line">Jobs: 50 (f=50): [rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr] [100.0% <span class="keyword">done</span>] [47544K/0K/0K /s] [11.9K/0 /0  iops] [eta 00m:00s]</span><br><span class="line">rand_100read_4k: (groupid=0, <span class="built_in">jobs</span>=50): err= 0: pid=25884: Mon May 14 14:59:44 2018</span><br><span class="line">  <span class="built_in">read</span> : io=8454.3MB, bw=48091KB/s, iops=12022 , runt=180018msec</span><br><span class="line">    clat (usec): min=318 , max=167471 , avg=4156.60, stdev=8363.94</span><br><span class="line">     lat (usec): min=318 , max=167472 , avg=4156.89, stdev=8363.95</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 1032],  5.00th=[ 1176], 10.00th=[ 1240], 20.00th=[ 1352],</span><br><span class="line">     | 30.00th=[ 1464], 40.00th=[ 1688], 50.00th=[ 1832], 60.00th=[ 1944],</span><br><span class="line">     | 70.00th=[ 2064], 80.00th=[ 2288], 90.00th=[15808], 95.00th=[18560],</span><br><span class="line">     | 99.00th=[20608], 99.50th=[39168], 99.90th=[134144], 99.95th=[144384],</span><br><span class="line">     | 99.99th=[156672]</span><br><span class="line">    bw (KB/s)  : min=  231, max= 7248, per=2.00%, avg=961.78, stdev=384.46</span><br><span class="line">    lat (usec) : 500=0.05%, 750=0.20%, 1000=0.51%</span><br><span class="line">    lat (msec) : 2=64.37%, 4=19.62%, 10=2.88%, 20=10.62%, 50=1.52%</span><br><span class="line">    lat (msec) : 100=0.02%, 250=0.23%</span><br><span class="line">  cpu          : usr=0.00%, sys=0.02%, ctx=1813752, majf=18446744073709550866, minf=18446744073698419008</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     issued    : total=r=2164296/w=0/d=0, short=r=0/w=0/d=0</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">   READ: io=8454.3MB, aggrb=48090KB/s, minb=48090KB/s, maxb=48090KB/s, mint=180018msec, maxt=180018msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  vdb: ios=2163559/42, merge=23/10, ticks=8925036/223, in_queue=8922540, util=99.94%</span><br><span class="line">100%éšæœºï¼Œ100%å†™ï¼Œ 4K</span><br><span class="line"></span><br><span class="line">[root@<span class="built_in">test</span>-db data]<span class="comment"># fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randwrite -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=rand_100write_4k</span></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line">rand_100write_4k: (g=0): rw=randwrite, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">rand_100write_4k: (g=0): rw=randwrite, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 50 threads</span><br><span class="line">Jobs: 50 (f=50): [wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww] [100.0% <span class="keyword">done</span>] [0K/47996K/0K /s] [0 /11.1K/0  iops] [eta 00m:00s]</span><br><span class="line">rand_100write_4k: (groupid=0, <span class="built_in">jobs</span>=50): err= 0: pid=25963: Mon May 14 15:08:43 2018</span><br><span class="line">  write: io=8445.5MB, bw=48039KB/s, iops=12009 , runt=180024msec</span><br></pre></td></tr></tbody></table></figure><p></p><p>100%é¡ºåºï¼Œ100%è¯» ï¼Œ4K<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=<span class="built_in">read</span> -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=sqe_100read_4k</span><br><span class="line"></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line">sqe_100read_4k: (g=0): rw=<span class="built_in">read</span>, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 50 threads</span><br><span class="line">Jobs: 50 (f=50): [RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR] [100.0% <span class="keyword">done</span>] [59996K/0K/0K /s] [14.1K/0 /0  iops] [eta 00m:00s]</span><br><span class="line">sqe_100read_4k: (groupid=0, <span class="built_in">jobs</span>=50): err= 0: pid=26047: Mon May 14 15:13:02 2018</span><br><span class="line">  <span class="built_in">read</span> : io=10599MB, bw=60295KB/s, iops=15073 , runt=180006msec</span><br><span class="line">    clat (usec): min=253 , max=550591 , avg=3315.70, stdev=26406.30</span><br><span class="line">     lat (usec): min=254 , max=550591 , avg=3315.95, stdev=26406.30</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 1176],  5.00th=[ 1240], 10.00th=[ 1256], 20.00th=[ 1288],</span><br><span class="line">     | 30.00th=[ 1336], 40.00th=[ 1368], 50.00th=[ 1416], 60.00th=[ 1480],</span><br><span class="line">     | 70.00th=[ 1528], 80.00th=[ 1592], 90.00th=[ 1736], 95.00th=[ 2800],</span><br><span class="line">     | 99.00th=[17792], 99.50th=[18816], 99.90th=[522240], 99.95th=[528384],</span><br><span class="line">     | 99.99th=[536576]</span><br><span class="line">    bw (KB/s)  : min=   15, max= 2475, per=2.00%, avg=1206.47, stdev=634.32</span><br><span class="line">    lat (usec) : 500=0.01%, 750=0.01%, 1000=0.04%</span><br><span class="line">    lat (msec) : 2=92.64%, 4=3.87%, 10=1.05%, 20=2.03%, 50=0.01%</span><br><span class="line">    lat (msec) : 250=0.01%, 500=0.17%, 750=0.15%</span><br><span class="line">  cpu          : usr=0.05%, sys=0.23%, ctx=2697397, majf=0, minf=18446744073708900853</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     issued    : total=r=2713362/w=0/d=0, short=r=0/w=0/d=0</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">   READ: io=10599MB, aggrb=60294KB/s, minb=60294KB/s, maxb=60294KB/s, mint=180006msec, maxt=180006msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  vdb: ios=2711304/55, merge=1805/10, ticks=8899022/202, in_queue=8898860, util=100.00%</span><br></pre></td></tr></tbody></table></figure><p></p><p>100%é¡ºåºï¼Œ100%å†™ ï¼Œ4K<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=sqe_100write_4k</span><br><span class="line"></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line">sqe_100write_4k: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">sqe_100write_4k: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 50 threads</span><br><span class="line">Jobs: 50 (f=50): [WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW] [100.0% <span class="keyword">done</span>] [0K/55788K/0K /s] [0 /13.1K/0  iops] [eta 00m:00s]</span><br><span class="line">sqe_100write_4k: (groupid=0, <span class="built_in">jobs</span>=50): err= 0: pid=26100: Mon May 14 15:17:24 2018</span><br><span class="line">  write: io=10002MB, bw=56896KB/s, iops=14224 , runt=180019msec</span><br><span class="line">    clat (usec): min=583 , max=457330 , avg=3513.01, stdev=9958.13</span><br><span class="line">     lat (usec): min=584 , max=457331 , avg=3513.60, stdev=9958.13</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 1224],  5.00th=[ 1384], 10.00th=[ 1480], 20.00th=[ 1592],</span><br><span class="line">     | 30.00th=[ 1672], 40.00th=[ 1752], 50.00th=[ 1832], 60.00th=[ 1928],</span><br><span class="line">     | 70.00th=[ 2096], 80.00th=[ 2480], 90.00th=[ 6368], 95.00th=[12480],</span><br><span class="line">     | 99.00th=[20608], 99.50th=[37120], 99.90th=[166912], 99.95th=[268288],</span><br><span class="line">     | 99.99th=[346112]</span><br><span class="line">    bw (KB/s)  : min=  152, max= 2432, per=2.01%, avg=1141.03, stdev=401.10</span><br><span class="line">    lat (usec) : 750=0.01%, 1000=0.11%</span><br><span class="line">    lat (msec) : 2=65.06%, 4=21.62%, 10=7.36%, 20=4.40%, 50=1.24%</span><br><span class="line">    lat (msec) : 100=0.08%, 250=0.06%, 500=0.07%</span><br><span class="line">  cpu          : usr=0.05%, sys=0.38%, ctx=2547790, majf=0, minf=18446744073708899536</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     issued    : total=r=0/w=2560604/d=0, short=r=0/w=0/d=0</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: io=10002MB, aggrb=56896KB/s, minb=56896KB/s, maxb=56896KB/s, mint=180019msec, maxt=180019msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  vdb: ios=63/2558949, merge=0/275, ticks=12/8897256, in_queue=8895411, util=100.00%</span><br></pre></td></tr></tbody></table></figure><p></p><p>100%éšæœºï¼Œ70%è¯»ï¼Œ30%å†™ 4K<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randrw -rwmixread=70 -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=randrw_70read_4k</span><br><span class="line"></span><br><span class="line">è¿è¡Œç»“æœï¼š</span><br><span class="line">randrw_70read_4k: (g=0): rw=randrw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">randrw_70read_4k: (g=0): rw=randrw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1</span><br><span class="line">fio-2.0.13</span><br><span class="line">Starting 50 threads</span><br><span class="line">Jobs: 50 (f=50): [mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm] [100.0% <span class="keyword">done</span>] [48012K/20800K/0K /s] [12.3K/5200 /0  iops] [eta 00m:00s]</span><br><span class="line">randrw_70read_4k: (groupid=0, <span class="built_in">jobs</span>=50): err= 0: pid=26162: Mon May 14 15:29:18 2018</span><br><span class="line">  <span class="built_in">read</span> : io=8430.4MB, bw=47954KB/s, iops=11988 , runt=180020msec</span><br><span class="line">    clat (usec): min=304 , max=177969 , avg=3045.60, stdev=5103.08</span><br><span class="line">     lat (usec): min=304 , max=177970 , avg=3045.87, stdev=5103.08</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[  860],  5.00th=[ 1048], 10.00th=[ 1160], 20.00th=[ 1320],</span><br><span class="line">     | 30.00th=[ 1448], 40.00th=[ 1560], 50.00th=[ 1656], 60.00th=[ 1768],</span><br><span class="line">     | 70.00th=[ 1896], 80.00th=[ 2128], 90.00th=[ 4384], 95.00th=[17792],</span><br><span class="line">     | 99.00th=[20352], 99.50th=[28544], 99.90th=[41216], 99.95th=[57088],</span><br><span class="line">     | 99.99th=[127488]</span><br><span class="line">    bw (KB/s)  : min=  206, max= 4424, per=2.00%, avg=959.77, stdev=408.18</span><br><span class="line">  write: io=3613.8MB, bw=20556KB/s, iops=5138 , runt=180020msec</span><br><span class="line">    clat (usec): min=569 , max=157336 , avg=2617.23, stdev=2821.20</span><br><span class="line">     lat (usec): min=570 , max=157337 , avg=2617.81, stdev=2821.20</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 1096],  5.00th=[ 1432], 10.00th=[ 1592], 20.00th=[ 1768],</span><br><span class="line">     | 30.00th=[ 1912], 40.00th=[ 2040], 50.00th=[ 2160], 60.00th=[ 2288],</span><br><span class="line">     | 70.00th=[ 2416], 80.00th=[ 2576], 90.00th=[ 2864], 95.00th=[ 3472],</span><br><span class="line">     | 99.00th=[19328], 99.50th=[20352], 99.90th=[22400], 99.95th=[37632],</span><br><span class="line">     | 99.99th=[52992]</span><br><span class="line">    bw (KB/s)  : min=   62, max= 1888, per=2.00%, avg=411.23, stdev=178.61</span><br><span class="line">    lat (usec) : 500=0.06%, 750=0.22%, 1000=2.28%</span><br><span class="line">    lat (msec) : 2=61.13%, 4=27.68%, 10=3.02%, 20=4.48%, 50=1.07%</span><br><span class="line">    lat (msec) : 100=0.04%, 250=0.01%</span><br><span class="line">  cpu          : usr=0.01%, sys=0.08%, ctx=2743663, majf=0, minf=18446744073698904078</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%</span><br><span class="line">     issued    : total=r=2158165/w=925122/d=0, short=r=0/w=0/d=0</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">   READ: io=8430.4MB, aggrb=47953KB/s, minb=47953KB/s, maxb=47953KB/s, mint=180020msec, maxt=180020msec</span><br><span class="line">  WRITE: io=3613.8MB, aggrb=20555KB/s, minb=20555KB/s, maxb=20555KB/s, mint=180020msec, maxt=180020msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  vdb: ios=2154562/923535, merge=0/0, ticks=6503566/2394699, in_queue=8896553, util=99.93%</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ‰§è¡Œç»“æœè¯´æ˜:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">io=æ‰§è¡Œäº†å¤šå°‘Mçš„IO</span><br><span class="line">bw=å¹³å‡IOå¸¦å®½</span><br><span class="line">iops=IOPS</span><br><span class="line">runt=çº¿ç¨‹è¿è¡Œæ—¶é—´</span><br><span class="line">slat=æäº¤å»¶è¿Ÿ</span><br><span class="line">clat=å®Œæˆå»¶è¿Ÿ</span><br><span class="line">lat=å“åº”æ—¶é—´</span><br><span class="line">bw=å¸¦å®½</span><br><span class="line">cpu=åˆ©ç”¨ç‡</span><br><span class="line">IO depths=ioé˜Ÿåˆ—</span><br><span class="line">IO submit=å•ä¸ªIOæäº¤è¦æäº¤çš„IOæ•°</span><br><span class="line">IO complete=Like the above submit number, but <span class="keyword">for</span> completions instead.</span><br><span class="line">IO issued=The number of <span class="built_in">read</span>/write requests issued, and how many of them were short.</span><br><span class="line">IO latencies=IOå®Œå»¶è¿Ÿçš„åˆ†å¸ƒ</span><br><span class="line"></span><br><span class="line">io=æ€»å…±æ‰§è¡Œäº†å¤šå°‘sizeçš„IO</span><br><span class="line">aggrb=groupæ€»å¸¦å®½</span><br><span class="line">minb=æœ€å°.å¹³å‡å¸¦å®½.</span><br><span class="line">maxb=æœ€å¤§å¹³å‡å¸¦å®½.</span><br><span class="line">mint=groupä¸­çº¿ç¨‹çš„æœ€çŸ­è¿è¡Œæ—¶é—´.</span><br><span class="line">maxt=groupä¸­çº¿ç¨‹çš„æœ€é•¿è¿è¡Œæ—¶é—´.</span><br><span class="line"></span><br><span class="line">ios=æ‰€æœ‰groupæ€»å…±æ‰§è¡Œçš„IOæ•°.</span><br><span class="line">merge=æ€»å…±å‘ç”Ÿçš„IOåˆå¹¶æ•°.</span><br><span class="line">ticks=Number of ticks we kept the disk busy.</span><br><span class="line">io_queue=èŠ±è´¹åœ¨é˜Ÿåˆ—ä¸Šçš„æ€»å…±æ—¶é—´.</span><br><span class="line">util=ç£ç›˜åˆ©ç”¨ç‡</span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>curl æ¥æµ‹è¯•ç½‘ç«™-dnsè§£ææ—¶é—´,å“åº”æ—¶é—´,ä¼ è¾“æ—¶é—´</title>
    <link href="https://jiemin.wang/2019/04/22/curl-dns-time/"/>
    <id>https://jiemin.wang/2019/04/22/curl-dns-time/</id>
    <published>2019-04-22T02:16:41.000Z</published>
    <updated>2019-04-22T02:29:18.492Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æœ‰äº›äººåŠªåŠ›äº†ä¸€è¾ˆå­ï¼Œä¹Ÿå°±ä»ç¤¾ä¼šçš„å››æµè¿›å…¥äº†ä¸‰æµã€‚</strong></p></blockquote><h2 id="è·å–-è§£ææ—¶é—´-å“åº”æ—¶é—´-ä¼ è¾“æ—¶é—´"><a href="#è·å–-è§£ææ—¶é—´-å“åº”æ—¶é—´-ä¼ è¾“æ—¶é—´" class="headerlink" title="è·å– è§£ææ—¶é—´:å“åº”æ—¶é—´:ä¼ è¾“æ—¶é—´"></a>è·å– è§£ææ—¶é—´:å“åº”æ—¶é—´:ä¼ è¾“æ—¶é—´</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test_dbs2 ~ <span class="comment"># curl -o /dev/null -s -w %{time_connect}:%{time_starttransfer}:%{time_total} https://jiemin.wang    </span></span><br><span class="line">0.104:0.000:18.174</span><br></pre></td></tr></tbody></table></figure><img src="/2019/04/22/curl-dns-time/curl.jpg" title="curl"><p>ç»™å‡ºå¯¹ç«™ç‚¹æ‰§è¡Œ <code>curl</code> å‘½ä»¤çš„æƒ…å†µ.è¾“å‡ºé€šå¸¸æ˜¯ <code>HTML ä»£ç </code>,é€šè¿‡ <code>-o</code> å‚æ•°å‘é€åˆ° <code>/dev/null</code>. <code>-s</code> å‚æ•°å»æ‰æ‰€æœ‰çŠ¶æ€ä¿¡æ¯. <code>-w</code> å‚æ•°è®© <code>curl</code> å†™å‡ºè®¡æ—¶å™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚</p><p>å‚æ•°è¯´æ˜:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time_connect        å»ºç«‹åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥æ‰€ç”¨çš„æ—¶é—´</span><br><span class="line">time_starttransfer  åœ¨å‘å‡ºè¯·æ±‚ä¹‹å,Web æœåŠ¡å™¨è¿”å›æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€ç”¨çš„æ—¶é—´</span><br><span class="line">time_total          å®Œæˆè¯·æ±‚æ‰€ç”¨çš„æ—¶é—´</span><br><span class="line">time_namelookup     DNSè§£ææ—¶é—´,ä»è¯·æ±‚å¼€å§‹åˆ°DNSè§£æå®Œæ¯•æ‰€ç”¨æ—¶é—´(è®°å¾—å…³æ‰ Linux çš„ nscd çš„æœåŠ¡æµ‹è¯•)</span><br><span class="line">speed_download      ä¸‹è½½é€Ÿåº¦ï¼Œå•ä½-å­—èŠ‚æ¯ç§’ã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™äº›è®¡æ—¶å™¨éƒ½ç›¸å¯¹äºäº‹åŠ¡çš„èµ·å§‹æ—¶é—´,ç”šè‡³è¦å…ˆäº <code>Domain Name Serviceï¼ˆDNS</code>ï¼‰æŸ¥è¯¢.å› æ­¤,åœ¨å‘å‡ºè¯·æ±‚ä¹‹å,Web æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶å¼€å§‹å‘å›æ•°æ®æ‰€ç”¨çš„æ—¶é—´æ˜¯ 0.000 - 0.104 = 0 ç§’.å®¢æˆ·æœºä»æœåŠ¡å™¨ä¸‹è½½æ•°æ®æ‰€ç”¨çš„æ—¶é—´æ˜¯ 18.174 - 0.000 = 18 ç§’.</p><p>é€šè¿‡è§‚å¯Ÿ curl æ•°æ®åŠå…¶éšæ—¶é—´å˜åŒ–çš„è¶‹åŠ¿,å¯ä»¥å¾ˆå¥½åœ°äº†è§£ç«™ç‚¹å¯¹ç”¨æˆ·çš„å“åº”æ€§.ä»¥ä¸Šå˜é‡ä¼šæŒ‰CURLè®¤ä¸ºåˆé€‚çš„æ ¼å¼è¾“å‡ºï¼Œè¾“å‡ºå˜é‡éœ€è¦æŒ‰ç…§<code>%{variable_name}</code>çš„æ ¼å¼ï¼Œå¦‚æœéœ€è¦<code>è¾“å‡º%</code>ï¼Œdoubleä¸€ä¸‹å³å¯ï¼Œå³<code>%%</code>ï¼ŒåŒæ—¶ï¼Œ<code>næ˜¯æ¢è¡Œ</code>ï¼Œ<code>ræ˜¯å›è½¦</code>ï¼Œ<code>tæ˜¯TAB</code>ã€‚</p><p>å½“ç„¶,Web ç«™ç‚¹ä¸ä»…ä»…ç”±é¡µé¢ç»„æˆ.å®ƒè¿˜æœ‰å›¾åƒã€JavaScript ä»£ç ã€CSS å’Œ cookie è¦å¤„ç†.curl å¾ˆé€‚åˆäº†è§£å•ä¸€å…ƒç´ çš„å“åº”æ—¶é—´,ä½†æ˜¯æœ‰æ—¶å€™éœ€è¦äº†è§£æ•´ä¸ªé¡µé¢çš„è£…è½½é€Ÿåº¦.</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>linux-TIME-WAIT</title>
    <link href="https://jiemin.wang/2019/04/22/linux-TIME-WAIT/"/>
    <id>https://jiemin.wang/2019/04/22/linux-TIME-WAIT/</id>
    <published>2019-04-22T01:50:20.000Z</published>
    <updated>2019-04-22T01:58:02.955Z</updated>
    
    <content type="html"><![CDATA[<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="timg.jpeg" class="full-image" alt="alt" title="title"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><blockquote class="blockquote-center"><p><strong>æ²¡äº‹å¬å¬åˆ«äººå£ä¸­çš„è‡ªå·±ï¼Œè¿™æ¯”çœ‹å¤§ç‰‡è¿˜åˆºæ¿€ï¼Œä½ ä¼šå‘ç°ä½ ä»€ä¹ˆéƒ½æ²¡åšï¼Œä½†å·²ç»æ¼”äº†å¥½å¤šç‰ˆæœ¬ï¼Œéƒ½æ˜¯å¤§è§’è‰²ã€‚</strong></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>TIME_WAIT</code> çŠ¶æ€åŸç†<br>å½“å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥æ—¶ï¼Œä¼šå‘é€æœ€åä¸€ä¸ª<code>ACK</code>ï¼Œç„¶åä¼šè¿›å…¥<code>TIME_WAIT</code>çŠ¶æ€ï¼Œå†åœç•™2ä¸ª<code>MSLæ—¶é—´(çº¦1-4åˆ†é’Ÿ)</code>ï¼Œè¿›å…¥<code>CLOSED</code>çŠ¶æ€ã€‚<br><img src="/2019/04/22/linux-TIME-WAIT/tcp.png" title="tcp"></p><h2 id="è¯¦ç»†"><a href="#è¯¦ç»†" class="headerlink" title="è¯¦ç»†"></a>è¯¦ç»†</h2><p>CentOS6/7.xé»˜è®¤æ²¡æœ‰å¯¹ç³»ç»Ÿå‚æ•°è¿›è¡Œè®¾ç½®ï¼Œå½“å¤§é‡<code>TIME_WAIT</code>äº§ç”Ÿçš„æ—¶å€™ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œ</p><p>ç»Ÿè®¡<code>TIME_WAIT</code>çŠ¶æ€æ•°é‡<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | grep TIME_WAIT | wc -l</span><br></pre></td></tr></tbody></table></figure><p></p><p>æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿æ¥çŠ¶æ€<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">netstat -n | awk <span class="string">'/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'</span></span><br><span class="line">TIME_WAIT 1280</span><br><span class="line">FIN_WAIT1 7</span><br><span class="line">SYN_SENT 1</span><br><span class="line">FIN_WAIT2 7</span><br><span class="line">ESTABLISHED 247</span><br><span class="line">LAST_ACK 1</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ‘ä»¬åªç”¨å…³å¿ƒ<code>TIME_WAIT</code>çš„ä¸ªæ•°ï¼Œåœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰1280å¤šä¸ª<code>TIME_WAIT</code>ï¼Œè¿™æ ·å°±å ç”¨äº†1280å¤šä¸ªç«¯å£ï¼Œç«¯å£çš„æ•°é‡åªæœ‰65535ä¸ªï¼Œå ç”¨ä¸€ä¸ªå°‘ä¸€ä¸ªï¼Œä¼šä¸¥é‡çš„å½±å“åˆ°åç»§çš„æ–°è¿æ¥ï¼Œå°±éœ€è°ƒæ•´ä¸‹Linuxçš„TCPå†…æ ¸å‚æ•°ï¼Œè®©ç³»ç»Ÿæ›´å¿«çš„é‡Šæ”¾<code>TIME_WAIT</code>è¿æ¥ã€‚</p><p>è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>ä¿®æ”¹å†…æ ¸é…ç½®<code>vim /etc/sysctl.conf</code> ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_syncookies = 1         <span class="comment">#è¡¨ç¤ºå¼€å¯SYN Cookiesã€‚å½“å‡ºç°SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨cookiesæ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡SYNæ”»å‡»ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1           <span class="comment">#è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1         <span class="comment">#è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30       <span class="comment">#ä¿®æ”¹ç³»çµ±é»˜è®¤çš„ TIMEOUT æ—¶é—´ã€‚</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ç„¶åæ‰§è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/sysctl -p</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®©å‚æ•°ç”Ÿæ•ˆã€‚</p><p>å‚æ•°è¯´æ˜:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_keepalive_time = 1200   <span class="comment">#è¡¨ç¤ºå½“keepaliveèµ·ç”¨çš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2å°æ—¶ï¼Œæ”¹ä¸º20åˆ†é’Ÿã€‚</span></span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65000   <span class="comment">#è¡¨ç¤ºç”¨äºå‘å¤–è¿æ¥çš„ç«¯å£èŒƒå›´ã€‚ç¼ºçœæƒ…å†µä¸‹å¾ˆå°ï¼š32768åˆ°61000ï¼Œæ”¹ä¸º10000åˆ°65000ã€‚ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¸è¦å°†æœ€ä½å€¼è®¾çš„å¤ªä½ï¼Œå¦åˆ™å¯èƒ½ä¼šå ç”¨æ‰æ­£å¸¸çš„ç«¯å£ï¼ï¼‰</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192  <span class="comment">#è¡¨ç¤ºSYNé˜Ÿåˆ—çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º1024ï¼ŒåŠ å¤§é˜Ÿåˆ—é•¿åº¦ä¸º8192ï¼Œå¯ä»¥å®¹çº³æ›´å¤šç­‰å¾…è¿æ¥çš„ç½‘ç»œè¿æ¥æ•°ã€‚</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000  <span class="comment">#è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒTIME_WAITçš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚é»˜è®¤180000ï¼Œæ”¹ä¸º6000ã€‚å¯¹äºApacheã€Nginxç­‰æœåŠ¡å™¨ï¼Œä¸Šå‡ è¡Œçš„å‚æ•°å¯ä»¥å¾ˆå¥½åœ°å‡å°‘TIME_WAITå¥—æ¥å­—æ•°é‡ï¼Œä½†æ˜¯å¯¹äº Squidï¼Œæ•ˆæœå´ä¸å¤§ã€‚æ­¤é¡¹å‚æ•°å¯ä»¥æ§åˆ¶TIME_WAITçš„æœ€å¤§æ•°é‡ï¼Œé¿å…SquidæœåŠ¡å™¨è¢«å¤§é‡çš„TIME_WAITæ‹–æ­»ã€‚</span></span><br><span class="line"></span><br><span class="line">å†…æ ¸å…¶ä»–TCPå‚æ•°è¯´æ˜ï¼š</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 65536  <span class="comment">#è®°å½•çš„é‚£äº›å°šæœªæ”¶åˆ°å®¢æˆ·ç«¯ç¡®è®¤ä¿¡æ¯çš„è¿æ¥è¯·æ±‚çš„æœ€å¤§å€¼ã€‚å¯¹äºæœ‰128Må†…å­˜çš„ç³»ç»Ÿè€Œè¨€ï¼Œç¼ºçœå€¼æ˜¯1024ï¼Œå°å†…å­˜çš„ç³»ç»Ÿåˆ™æ˜¯128ã€‚</span></span><br><span class="line">net.core.netdev_max_backlog = 32768   <span class="comment">#æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚</span></span><br><span class="line">net.core.somaxconn = 32768   <span class="comment">#webåº”ç”¨ä¸­listenå‡½æ•°çš„backlogé»˜è®¤ä¼šç»™æˆ‘ä»¬å†…æ ¸å‚æ•°çš„net.core.somaxconné™åˆ¶åˆ°128ï¼Œè€Œnginxå®šä¹‰çš„NGX_LISTEN_BACKLOGé»˜è®¤ä¸º511ï¼Œæ‰€ä»¥æœ‰å¿…è¦è°ƒæ•´è¿™ä¸ªå€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line">net.core.rmem_max = 16777216           <span class="comment">#æœ€å¤§socketè¯»buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼:873200</span></span><br><span class="line">net.core.wmem_max = 16777216           <span class="comment">#æœ€å¤§socketå†™buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼:873200</span></span><br><span class="line">net.ipv4.tcp_timestsmps = 0    <span class="comment">#æ—¶é—´æˆ³å¯ä»¥é¿å…åºåˆ—å·çš„å·ç»•ã€‚ä¸€ä¸ª1Gbpsçš„é“¾è·¯è‚¯å®šä¼šé‡åˆ°ä»¥å‰ç”¨è¿‡çš„åºåˆ—å·ã€‚æ—¶é—´æˆ³èƒ½å¤Ÿè®©å†…æ ¸æ¥å—è¿™ç§â€œå¼‚å¸¸â€çš„æ•°æ®åŒ…ã€‚è¿™é‡Œéœ€è¦å°†å…¶å…³æ‰ã€‚</span></span><br><span class="line">net.ipv4.tcp_synack_retries = 2   <span class="comment">#ä¸ºäº†æ‰“å¼€å¯¹ç«¯çš„è¿æ¥ï¼Œå†…æ ¸éœ€è¦å‘é€ä¸€ä¸ªSYNå¹¶é™„å¸¦ä¸€ä¸ªå›åº”å‰é¢ä¸€ä¸ªSYNçš„ACKã€‚ä¹Ÿå°±æ˜¯æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹ä¸­çš„ç¬¬äºŒæ¬¡æ¡æ‰‹ã€‚è¿™ä¸ªè®¾ç½®å†³å®šäº†å†…æ ¸æ”¾å¼ƒè¿æ¥ä¹‹å‰å‘é€SYN+ACKåŒ…çš„æ•°é‡ã€‚</span></span><br><span class="line">net.ipv4.tcp_syn_retries = 2  <span class="comment">#åœ¨å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYNåŒ…çš„æ•°é‡ã€‚</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1     <span class="comment"># å¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ã€‚</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_wmem = 8192 436600 873200   <span class="comment"># TCPå†™buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼: 8192 436600 873200</span></span><br><span class="line">net.ipv4.tcp_rmem  = 32768 436600 873200  <span class="comment"># TCPè¯»buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼: 32768 436600 873200</span></span><br><span class="line">net.ipv4.tcp_mem = 94500000 91500000 92700000  <span class="comment"># åŒæ ·æœ‰3ä¸ªå€¼,æ„æ€æ˜¯:</span></span><br><span class="line">net.ipv4.tcp_mem[0]:ä½äºæ­¤å€¼ï¼ŒTCPæ²¡æœ‰å†…å­˜å‹åŠ›ã€‚</span><br><span class="line">net.ipv4.tcp_mem[1]:åœ¨æ­¤å€¼ä¸‹ï¼Œè¿›å…¥å†…å­˜å‹åŠ›é˜¶æ®µã€‚</span><br><span class="line">net.ipv4.tcp_mem[2]:é«˜äºæ­¤å€¼ï¼ŒTCPæ‹’ç»åˆ†é…socketã€‚</span><br><span class="line">ä¸Šè¿°å†…å­˜å•ä½æ˜¯é¡µï¼Œè€Œä¸æ˜¯å­—èŠ‚ã€‚å¯å‚è€ƒçš„ä¼˜åŒ–å€¼æ˜¯:786432 1048576 1572864</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800   <span class="comment">#ç³»ç»Ÿä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªTCPå¥—æ¥å­—ä¸è¢«å…³è”åˆ°ä»»ä½•ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶å¥æŸ„ä¸Šã€‚</span></span><br><span class="line">å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œè¿æ¥å°†å³åˆ»è¢«å¤ä½å¹¶æ‰“å°å‡ºè­¦å‘Šä¿¡æ¯ã€‚</span><br><span class="line">è¿™ä¸ªé™åˆ¶ä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢ç®€å•çš„DoSæ”»å‡»ï¼Œä¸èƒ½è¿‡åˆ†ä¾é å®ƒæˆ–è€…äººä¸ºåœ°å‡å°è¿™ä¸ªå€¼ï¼Œ</span><br><span class="line">æ›´åº”è¯¥å¢åŠ è¿™ä¸ªå€¼(å¦‚æœå¢åŠ äº†å†…å­˜ä¹‹å)ã€‚</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30   <span class="comment">#å¦‚æœå¥—æ¥å­—ç”±æœ¬ç«¯è¦æ±‚å…³é—­ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†å®ƒä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ã€‚å¯¹ç«¯å¯ä»¥å‡ºé”™å¹¶æ°¸è¿œä¸å…³é—­è¿æ¥ï¼Œç”šè‡³æ„å¤–å½“æœºã€‚ç¼ºçœå€¼æ˜¯60ç§’ã€‚2.2 å†…æ ¸çš„é€šå¸¸å€¼æ˜¯180ç§’ï¼Œä½ å¯ä»¥æŒ‰è¿™ä¸ªè®¾ç½®ï¼Œä½†è¦è®°ä½çš„æ˜¯ï¼Œå³ä½¿ä½ çš„æœºå™¨æ˜¯ä¸€ä¸ªè½»è½½çš„WEBæœåŠ¡å™¨ï¼Œä¹Ÿæœ‰å› ä¸ºå¤§é‡çš„æ­»å¥—æ¥å­—è€Œå†…å­˜æº¢å‡ºçš„é£é™©ï¼ŒFIN- WAIT-2çš„å±é™©æ€§æ¯”FIN-WAIT-1è¦å°ï¼Œå› ä¸ºå®ƒæœ€å¤šåªèƒ½åƒæ‰1.5Kå†…å­˜ï¼Œä½†æ˜¯å®ƒä»¬çš„ç”Ÿå­˜æœŸé•¿äº›ã€‚</span></span><br></pre></td></tr></tbody></table></figure><p></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span itemprop=&quot;image&quot; itemscope itemtype=&quot;http://schema.org/ImageObject&quot;&gt;&lt;img itemprop=&quot;url image&quot; src=&quot;timg.jpeg&quot; class=&quot;full-image&quot; alt=&quot;
      
    
    </summary>
    
      <category term="Linux" scheme="https://jiemin.wang/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://jiemin.wang/tags/Linux/"/>
    
  </entry>
  
</feed>
