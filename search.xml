<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Linux å¸¸ç”¨yumæºæ•´ç†]]></title>
    <url>%2F2019%2F06%2F05%2Flinux-yumReposSummary%2F</url>
    <content type="text"><![CDATA[å‡ºå–è‡ªå·±çš„çµé­‚å’ŒåŸåˆ™å¹¶ä¸ä¸¢äººï¼Œä¸¢äººçš„æ˜¯æ²¡èƒ½å–ä¸€ä¸ªå¥½ä»·é’±ã€‚ å‰è¨€CentOSç³»ç»Ÿå¸¦æœ‰å‡ ä¸ªå®˜æ–¹æºï¼Œé»˜è®¤å¯ç”¨çš„ä»…æœ‰base, updateså’Œextrasä¸‰ä¸ªã€‚å¦‚æœå¸Œæœ›ä»æºå®‰è£…Nginxï¼Œé«˜ç‰ˆæœ¬çš„gcc/PHPç­‰è½¯ä»¶ï¼Œåˆ™è¦å¯¼å…¥æä¾›è½¯ä»¶åŒ…çš„ç¬¬ä¸‰æ–¹æºã€‚æœ¬æ–‡æ•´ç†å¸¸è§çš„ç¬¬ä¸‰æ–¹yumæºï¼Œå¹¶ä»¥CentOS 7ä¸ºä¾‹ä»‹ç»å…¶å®‰è£…æ–¹æ³•ã€‚ ç¬¬ä¸‰æ–¹yumæºEPELEPELæ˜¯Extra Packages for Enterprise Linuxçš„ç¼©å†™ï¼Œå…¶ä¸ºEL6æˆ–EL7æä¾›é‡å»ºçš„Fedoraç»„ä»¶ï¼Œå¹¶ä¸”ä¸ä¼šæ›¿æ¢baseä¸­çš„åŒ…ã€‚EPELç®—å¾—ä¸Šæ˜¯æœ€è‘—åçš„ç¬¬ä¸‰æ–¹è½¯ä»¶æºï¼Œå‡ ä¹å„ä¸ªäº‘æœåŠ¡å™¨å‚å•†æä¾›çš„CentOS ç³»ç»Ÿå‡ä¼šè‡ªå¸¦è¯¥æºå¹¶é»˜è®¤å¯ç”¨ã€‚å…¶æ”¶å½•äº†webä¸­å¸¸ç”¨çš„Nginxè½¯ä»¶åŒ…ã€‚ EPELçš„å®˜ç½‘æ˜¯ï¼šhttp://fedoraproject.org/wiki/EPELï¼Œå¯ä»¥é€šè¿‡`yum install -y epel-release`å®‰è£…ã€‚ SCLSCLæ˜¯Software Collectionsçš„ç¼©å†™ï¼Œç”±CentOS ç‰¹åˆ«å…´è¶£å°ç»„æ‰€ç»´æŠ¤ã€‚å…¶æ”¶å½•äº†è®¸å¤šç¨‹åºçš„æ–°ç‰ˆæœ¬ï¼Œä¾‹å¦‚gcc, PHP, git, pythonç­‰ã€‚å®‰è£…çš„è½¯ä»¶å¯ä¸æ—§ç‰ˆå…±å­˜ï¼ŒåŒ…åå¤šä»¥rh-ä¸ºå‰ç¼€ã€‚ SCLçš„å®˜ç½‘æ˜¯https://www.softwarecollections.orgï¼ŒCentOS 7çš„å®‰è£…æ–¹æ³•æ˜¯ï¼šyum install centos-release-sclã€‚å®‰è£…å®Œæˆååœ¨/etc/yum.repos.dç›®å½•ä¸‹ä¼šå‡ºç°CentOS-SCLo-scl.repoå’ŒCentOS-SCLo-scl-rh.repoä¸¤ä¸ªæ–‡ä»¶ã€‚å®‰è£…åæºé»˜è®¤å¯ç”¨ã€‚ ELRepoELRepoæ˜¯The Community Enterprise Linux Repositoryçš„ç¼©å†™ï¼Œæ—¨åœ¨æä¾›é©±åŠ¨ç¨‹åºæ¥å¢å¼ºç³»ç»Ÿçš„ç¡¬ä»¶æ”¯æŒï¼ˆåŒ…æ‹¬ï¼šæ˜¾ç¤ºã€æ–‡ä»¶ç³»ç»Ÿã€ç¡¬ä»¶ç›‘æ§ã€ç½‘ç»œã€éŸ³æ•ˆã€ç½‘ç»œæ‘„åƒé•œé©±åŠ¨ç¨‹åºï¼‰ã€‚ä¹Ÿæä¾›è¾ƒæ–°ç‰ˆçš„å†…æ ¸ï¼Œä¾‹å¦‚æ”¯æŒBBRç®—æ³•çš„4.9+å†…æ ¸ã€‚ ELRepoçš„å®˜æ–¹æ˜¯http://elrepo.org/ï¼ŒCentOS 7ç³»ç»Ÿçš„å®‰è£…æ–¹æ³•æ˜¯ï¼š12rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.orgrpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm å®‰è£…å®Œæˆååœ¨/etc/yum.repos.dç›®å½•ä¸‹å‡ºç°elrepo.repoæ–‡ä»¶ï¼Œå¯ç¼–è¾‘æ–‡ä»¶ä¸­çš„enableçš„å€¼å¯ç”¨å…·ä½“ä»“åº“ï¼Œä¹Ÿå¯åœ¨è¿è¡Œæ—¶ç”¨--enablerepo="xxx"æŒ‡å®šä½¿ç”¨çš„è½¯ä»¶åº“ã€‚ IUSIUSçš„å®˜ç½‘æ˜¯https://ius.io/ï¼Œæ—¨åœ¨ä¸ºRHELå’ŒCentOSæä¾›é«˜è´¨é‡ã€æœ€æ–°ç‰ˆçš„è½¯ä»¶ï¼Œå¦‚PHP, Python, MySQLç­‰ã€‚CentOS 7å®‰è£…è¯¥æºçš„å‘½ä»¤ä¸ºï¼šrpm -Uvh https://centos7.iuscommunity.org/ius-release.rpmã€‚ RPMfusionRPMfusionæä¾›Fedora Projectæˆ– Red Hatä¸æ„¿å‘è¡Œçš„è½¯ä»¶ï¼ŒåŒ…å«â€œå…è´¹ï¼ˆå¼€æºè½¯ä»¶ï¼‰â€å’Œâ€œéå…è´¹ï¼ˆæºä»£ç å¯å…¬å¼€è·å–ä½†ä¸å¼€æºä¸”é™éå•†ä¸šç”¨é€”ï¼‰â€ä¸¤ç§ç±»å‹çš„ä»“åº“ã€‚ RPMfusionçš„å®˜ç½‘æ˜¯https://rpmfusion.org/ï¼ŒCentOS 7çš„å®‰è£…æ–¹æ³•æ˜¯ï¼š1234# å…è´¹åº“yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm# éå…è´¹åº“yum localinstall --nogpgcheck https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-7.noarch.rpm RemiRemiç»´æŠ¤å¤§é‡ç»„ä»¶ï¼ŒåŒ…æ‹¬æœ€æ–°ç‰ˆçš„PHP, GLPIç­‰ã€‚Remiçš„safeä»“åº“ä¸ä¼šæ›¿ä»£ç³»ç»Ÿçš„åŸºæœ¬ç»„ä»¶ï¼Œä½†remi-phpxx.repoä¸­çš„è½¯ä»¶åŒ…ä¼šæ›¿ä»£ç³»ç»Ÿé»˜è®¤çš„phpã€‚éœ€è¦æ³¨æ„çš„æ˜¯Remiå¯èƒ½ä¼šä¸IUSçš„è½¯ä»¶åŒ…å†²çªï¼Œå› ä¸ºåŒæ–¹éƒ½æä¾›æœ€æ–°ç‰ˆçš„PHPã€‚ Remiçš„å®˜æ–¹ç½‘ç«™æ˜¯http://rpms.remirepo.net/ï¼ŒCentOS 7çš„å®‰è£…æ–¹æ³•æ˜¯ï¼šyum install -y remi-releaseã€‚ Webtaticæä¾›è¾ƒæ–°ç‰ˆçš„PHPã€MySQLåŠå…¶å®ƒç»„ä»¶ã€‚å»ºè®®ç”¨IUSæˆ–SCLä»£æ›¿ã€‚ è½¯ä»¶å®˜æ–¹ç»´æŠ¤çš„æºé™¤ä¸Šè¿°æ”¶å½•å¤šä¸ªè½¯ä»¶åŒ…çš„ç»¼åˆæºå¤–ï¼Œè¿˜æœ‰è®¸å¤šç”±è½¯ä»¶å®˜æ–¹ç»´æŠ¤çš„æºï¼Œä¾‹å¦‚Nginx, Gitlab, Nodejsç­‰ã€‚è¿™äº›æºçš„å®‰è£…å’Œä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒå®˜æ–¹æŒ‡å—ã€‚ æºç®¡ç†æºçš„é…ç½®æ–‡ä»¶å‡ä½äº/etc/yum.repos.dç›®å½•ä¸‹ï¼Œå¯ç”¨vim, nanoç­‰ç¼–è¾‘å™¨æ‰“å¼€é…ç½®æ–‡ä»¶å¹¶ç¼–è¾‘ã€‚ ä¸€äº›æœ‰ç”¨çš„æºç®¡ç†yumå‘½ä»¤ï¼š yum repolistï¼š åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æº, ç­‰åŒäºyum repolist enabledï¼› yum repolist disabledï¼š åˆ—å‡ºæ‰€æœ‰ç¦ç”¨çš„æºï¼› yum repoinfo [enabled|disabled]ï¼šåˆ—å‡ºå¯ç”¨ï¼ˆç¦ç”¨ï¼‰æºçš„æ›´è¯¦ç»†ä¿¡æ¯ yum --disablerepo="*" --enablerepo="xxxx" install/search: ä»æŒ‡å®šæºå®‰è£…/æœç´¢è½¯ä»¶ï¼›"â€“disablerepo"å’Œ"â€“enablerepo"é€‰é¡¹å¯ç‹¬ç«‹æˆ–é…åˆä½¿ç”¨ï¼ŒåŠ¨æ€å¯ç”¨å’Œç¦ç”¨æºã€‚ å›½å†…é•œåƒå› ä¸ºæŸäº›åŸå› ï¼Œä»ä½äºå¢ƒå¤–çš„æºé•œåƒå®‰è£…è½¯ä»¶æ…¢çš„è®©äººæŠ“ç‹‚ã€‚å¦‚æœé‡åˆ°äº†æ­¤ç§æƒ…å½¢ï¼Œå»ºè®®ä½¿ç”¨ä»£ç†ï¼Œæˆ–è€…é…ç½®æºçš„åœ°å€ä¸ºå›½å†…é•œåƒçš„åœ°å€ã€‚å›½å†…çŸ¥åçš„yumæºé•œåƒç«™æœ‰ï¼š é˜¿é‡Œäº‘ï¼Œç½‘å€ï¼šhttps://opsx.alibaba.com/mirror ç½‘æ˜“163ï¼Œç½‘å€ï¼šhttp://mirrors.163.com/ æ¸…åå¤§å­¦ï¼Œç½‘å€ï¼šhttp://mirrors.tuna.tsinghua.edu.cn/ ä¸­ç§‘å¤§ï¼Œç½‘å€ï¼šhttp://mirrors.ustc.edu.cn/ æµ™å¤§ï¼Œç½‘å€ï¼šhttp://mirrors.zju.edu.cn/ å…·ä½“ä»“åº“çš„é…ç½®æ–¹æ³•è¯·å‚è€ƒç«™å†…æŒ‡å—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¹¶éæ‰€æœ‰çš„é•œåƒéƒ½åŒ…å«ä¸Šè¿°åˆ—å‡ºçš„yumæºï¼Œæœ¬äººæ¨èé˜¿é‡Œäº‘ã€æ¸…åå¤§å­¦ã€ä¸­ç§‘å¤§é•œåƒç«™ã€‚ å‚è€ƒ https://wiki.centos.org/zh/AdditionalResources/Repositories document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[DBAä¸å¯ä¸çŸ¥çš„æ“ä½œç³»ç»Ÿå†…æ ¸å‚æ•°]]></title>
    <url>%2F2019%2F05%2F24%2FLinux-systemctl-variables%2F</url>
    <content type="text"><![CDATA[æ¯å½“æˆ‘æ‰¾åˆ°æˆåŠŸçš„é’¥åŒ™ï¼Œå°±å‘ç°æœ‰äººæŠŠé”èŠ¯ç»™æ¢äº†ã€‚ èƒŒæ™¯æ“ä½œç³»ç»Ÿä¸ºäº†é€‚åº”æ›´å¤šçš„ç¡¬ä»¶ç¯å¢ƒï¼Œè®¸å¤šåˆå§‹çš„è®¾ç½®å€¼ï¼Œå®½å®¹åº¦éƒ½å¾ˆé«˜ã€‚ å¦‚æœä¸ç»è°ƒæ•´ï¼Œè¿™äº›å€¼å¯èƒ½æ— æ³•é€‚åº”HPCï¼Œæˆ–è€…ç¡¬ä»¶ç¨å¥½äº›çš„ç¯å¢ƒã€‚ æ— æ³•å‘æŒ¥æ›´å¥½çš„ç¡¬ä»¶æ€§èƒ½ï¼Œç”šè‡³å¯èƒ½å½±å“æŸäº›åº”ç”¨è½¯ä»¶çš„ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åº“ã€‚ æ•°æ®åº“å…³å¿ƒçš„OSå†…æ ¸å‚æ•°512GB å†…å­˜ä¸ºä¾‹ 1. å‚æ•° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000100110021003100410051006100710081009101010111012101310141015101610171018101910201021102210231024102510261027102810291030103110321033103410351036103710381039104010411042104310441045104610471048104910501051105210531054105510561057105810591060106110621063106410651066106710681069107010711072107310741075107610771078107910801081108210831084108510861087108810891090109110921093109410951096109710981099110011011102110311041105110611071108110911101111111211131114111511161117111811191120112111221123112411251126112711281129113011311132113311341135113611371138113911401141114211431144114511461147114811491150115111521153115411551156115711581159116011611162116311641165116611671168116911701171117211731174117511761177117811791180118111821183118411851186118711881189119011911192119311941195119611971198119912001201120212031204120512061207120812091210121112121213121412151216121712181219122012211222122312241225122612271228122912301231123212331234123512361237123812391240124112421243124412451246124712481249125012511252125312541255125612571258125912601261126212631264126512661267126812691270127112721273127412751276127712781279128012811282fs.aio-max-nr ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` aio-nr & aio-max-nr: . aio-nr is the running total of the number of events specified on the io_setup system call for all currently active aio contexts. . If aio-nr reaches aio-max-nr then io_setup will fail with EAGAIN. . Note that raising aio-max-nr does not result in the pre-allocation or re-sizing of any kernel data structures. . aio-nr & aio-max-nr: . aio-nr shows the current system-wide number of asynchronous io requests. . aio-max-nr allows you to change the maximum value aio-nr can grow to. ``` æ¨èè®¾ç½® ``` fs.aio-max-nr = 1xxxxxx . PostgreSQL, Greenplum å‡æœªä½¿ç”¨io_setupåˆ›å»ºaio contexts. æ— éœ€è®¾ç½®ã€‚ å¦‚æœOracleæ•°æ®åº“ï¼Œè¦ä½¿ç”¨aioçš„è¯ï¼Œéœ€è¦è®¾ç½®å®ƒã€‚ è®¾ç½®å®ƒä¹Ÿæ²¡ä»€ä¹ˆåå¤„ï¼Œå¦‚æœå°†æ¥éœ€è¦é€‚åº”å¼‚æ­¥IOï¼Œå¯ä»¥ä¸éœ€è¦é‡æ–°ä¿®æ”¹è¿™ä¸ªè®¾ç½®ã€‚ ``` 2\. å‚æ•° ``` fs.file-max ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` file-max & file-nr: . The value in file-max denotes the maximum number of file handles that the Linux kernel will allocate. . When you get lots of error messages about running out of file handles, you might want to increase this limit. . Historically, the kernel was able to allocate file handles dynamically, but not to free them again. . The three values in file-nr denote : the number of allocated file handles , the number of allocated but unused file handles , the maximum number of file handles. . Linux 2.6 always reports 0 as the number of free file handles -- this is not an error, it just means that the number of allocated file handles exactly matches the number of used file handles. . Attempts to allocate more file descriptors than file-max are reported with printk, look for "VFS: file-max limit reached". ``` æ¨èè®¾ç½® ``` fs.file-max = 7xxxxxxx . PostgreSQL æœ‰ä¸€å¥—è‡ªå·±ç®¡ç†çš„VFSï¼ŒçœŸæ­£æ‰“å¼€çš„FDä¸å†…æ ¸ç®¡ç†çš„æ–‡ä»¶æ‰“å¼€å…³é—­æœ‰ä¸€å¥—æ˜ å°„çš„æœºåˆ¶ï¼Œæ‰€ä»¥çœŸå®æƒ…å†µä¸éœ€è¦ä½¿ç”¨é‚£ä¹ˆå¤šçš„file handlersã€‚ max_files_per_process å‚æ•°ã€‚ å‡è®¾1GBå†…å­˜æ”¯æ’‘100ä¸ªè¿æ¥ï¼Œæ¯ä¸ªè¿æ¥æ‰“å¼€1000ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆä¸€ä¸ªPGå®ä¾‹éœ€è¦æ‰“å¼€10ä¸‡ä¸ªæ–‡ä»¶ï¼Œä¸€å°æœºå™¨æŒ‰512Gå†…å­˜æ¥ç®—å¯ä»¥è·‘500ä¸ªPGå®ä¾‹ï¼Œåˆ™éœ€è¦5000ä¸‡ä¸ªfile handlerã€‚ ä»¥ä¸Šè®¾ç½®ç»°ç»°æœ‰ä½™ã€‚ ``` 3\. å‚æ•° ``` kernel.core_pattern ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` core_pattern: . core_pattern is used to specify a core dumpfile pattern name. . max length 128 characters; default value is "core" . core_pattern is used as a pattern template for the output filename; certain string patterns (beginning with '%') are substituted with their actual values. . backward compatibility with core_uses_pid: If core_pattern does not include "%p" (default does not) and core_uses_pid is set, then .PID will be appended to the filename. . corename format specifiers: % '%' is dropped %% output one '%' %p pid %P global pid (init PID namespace) %i tid %I global tid (init PID namespace) %u uid %g gid %d dump mode, matches PR_SET_DUMPABLE and /proc/sys/fs/suid_dumpable %s signal number %t UNIX time of dump %h hostname %e executable filename (may be shortened) %E executable path % both are dropped . If the first character of the pattern is a '|', the kernel will treat the rest of the pattern as a command to run. The core dump will be written to the standard input of that program instead of to a file. ``` æ¨èè®¾ç½® ``` kernel.core_pattern = /xxx/core_%e_%u_%t_%s.%p . è¿™ä¸ªç›®å½•è¦777çš„æƒé™ï¼Œå¦‚æœå®ƒæ˜¯ä¸ªè½¯é“¾ï¼Œåˆ™çœŸå®ç›®å½•éœ€è¦777çš„æƒé™ mkdir /xxx chmod 777 /xxx ç•™è¶³å¤Ÿçš„ç©ºé—´ ``` 4\. å‚æ•° ``` kernel.sem ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` kernel.sem = 4096 2147483647 2147483646 512000 . 4096 æ¯ç»„å¤šå°‘ä¿¡å·é‡ (>=17, PostgreSQL æ¯16ä¸ªè¿›ç¨‹ä¸€ç»„, æ¯ç»„éœ€è¦17ä¸ªä¿¡å·é‡) , 2147483647 æ€»å…±å¤šå°‘ä¿¡å·é‡ (2^31-1 , ä¸”å¤§äº4096*512000 ) , 2147483646 æ¯ä¸ªsemop()è°ƒç”¨æ”¯æŒå¤šå°‘æ“ä½œ (2^31-1), 512000 å¤šå°‘ç»„ä¿¡å·é‡ (å‡è®¾æ¯GBæ”¯æŒ100ä¸ªè¿æ¥, 512GBæ”¯æŒ51200ä¸ªè¿æ¥, åŠ ä¸Šå…¶ä»–è¿›ç¨‹, > 51200*2/16 ç»°ç»°æœ‰ä½™) . # sysctl -w kernel.sem="4096 2147483647 2147483646 512000" . # ipcs -s -l ------ Semaphore Limits -------- max number of arrays = 512000 max semaphores per array = 4096 max semaphores system wide = 2147483647 max ops per semop call = 2147483646 semaphore max value = 32767 ``` æ¨èè®¾ç½® ``` kernel.sem = 4096 2147483647 2147483646 512000 . 4096å¯èƒ½èƒ½å¤Ÿé€‚åˆæ›´å¤šçš„åœºæ™¯, æ‰€ä»¥å¤§ç‚¹æ— å¦¨ï¼Œå…³é”®æ˜¯512000 arraysä¹Ÿå¤Ÿäº†ã€‚ ``` 5\. å‚æ•° ``` kernel.shmall = 107374182 kernel.shmmax = 274877906944 kernel.shmmni = 819200 ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` å‡è®¾ä¸»æœºå†…å­˜ 512GB . shmmax å•ä¸ªå…±äº«å†…å­˜æ®µæœ€å¤§ 256GB (ä¸»æœºå†…å­˜çš„ä¸€åŠï¼Œå•ä½å­—èŠ‚) shmall æ‰€æœ‰å…±äº«å†…å­˜æ®µåŠ èµ·æ¥æœ€å¤§ (ä¸»æœºå†…å­˜çš„80%ï¼Œå•ä½PAGE) shmmni ä¸€å…±å…è®¸åˆ›å»º819200ä¸ªå…±äº«å†…å­˜æ®µ (æ¯ä¸ªæ•°æ®åº“å¯åŠ¨éœ€è¦2ä¸ªå…±äº«å†…å­˜æ®µã€‚ å°†æ¥å…è®¸åŠ¨æ€åˆ›å»ºå…±äº«å†…å­˜æ®µï¼Œå¯èƒ½éœ€æ±‚é‡æ›´å¤§) . # getconf PAGE_SIZE 4096 ``` æ¨èè®¾ç½® ``` kernel.shmall = 107374182 kernel.shmmax = 274877906944 kernel.shmmni = 819200 . 9.2ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ï¼Œæ•°æ®åº“å¯åŠ¨æ—¶ï¼Œå¯¹å…±äº«å†…å­˜æ®µçš„å†…å­˜éœ€æ±‚éå¸¸å¤§ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ Connections: (1800 + 270 * max_locks_per_transaction) * max_connections Autovacuum workers: (1800 + 270 * max_locks_per_transaction) * autovacuum_max_workers Prepared transactions: (770 + 270 * max_locks_per_transaction) * max_prepared_transactions Shared disk buffers: (block_size + 208) * shared_buffers WAL buffers: (wal_block_size + 8) * wal_buffers Fixed space requirements: 770 kB . ä»¥ä¸Šå»ºè®®å‚æ•°æ ¹æ®9.2ä»¥å‰çš„ç‰ˆæœ¬è®¾ç½®ï¼ŒåæœŸçš„ç‰ˆæœ¬åŒæ ·é€‚ç”¨ã€‚ ``` 6\. å‚æ•° ``` net.core.netdev_max_backlog ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` netdev_max_backlog ------------------ Maximum number of packets, queued on the INPUT side, when the interface receives packets faster than kernel can process them. ``` æ¨èè®¾ç½® ``` net.core.netdev_max_backlog=1xxxx . INPUTé“¾è¡¨è¶Šé•¿ï¼Œå¤„ç†è€—è´¹è¶Šå¤§ï¼Œå¦‚æœç”¨äº†iptablesç®¡ç†çš„è¯ï¼Œéœ€è¦åŠ å¤§è¿™ä¸ªå€¼ã€‚ ``` 7\. å‚æ•° ``` net.core.rmem_default net.core.rmem_max net.core.wmem_default net.core.wmem_max ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` rmem_default ------------ The default setting of the socket receive buffer in bytes. . rmem_max -------- The maximum receive socket buffer size in bytes. . wmem_default ------------ The default setting (in bytes) of the socket send buffer. . wmem_max -------- The maximum send socket buffer size in bytes. ``` æ¨èè®¾ç½® ``` net.core.rmem_default = 262144 net.core.rmem_max = 4194304 net.core.wmem_default = 262144 net.core.wmem_max = 4194304 ``` 8\. å‚æ•° ``` net.core.somaxconn ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` somaxconn - INTEGER Limit of socket listen() backlog, known in userspace as SOMAXCONN. Defaults to 128. See also tcp_max_syn_backlog for additional tuning for TCP sockets. ``` æ¨èè®¾ç½® ``` net.core.somaxconn=4xxx ``` 9\. å‚æ•° ``` net.ipv4.tcp_max_syn_backlog ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_max_syn_backlog - INTEGER Maximal number of remembered connection requests, which have not received an acknowledgment from connecting client. The minimal value is 128 for low memory machines, and it will increase in proportion to the memory of machine. If server suffers from overload, try increasing this number. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_max_syn_backlog=4xxx pgpool-II ä½¿ç”¨äº†è¿™ä¸ªå€¼ï¼Œç”¨äºå°†è¶…è¿‡num_init_childä»¥å¤–çš„è¿æ¥queueã€‚ æ‰€ä»¥è¿™ä¸ªå€¼å†³å®šäº†æœ‰å¤šå°‘è¿æ¥å¯ä»¥åœ¨é˜Ÿåˆ—é‡Œé¢ç­‰å¾…ã€‚ ``` 10\. å‚æ•° ``` net.ipv4.tcp_keepalive_intvl=20 net.ipv4.tcp_keepalive_probes=3 net.ipv4.tcp_keepalive_time=60 ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_keepalive_time - INTEGER How often TCP sends out keepalive messages when keepalive is enabled. Default: 2hours. . tcp_keepalive_probes - INTEGER How many keepalive probes TCP sends out, until it decides that the connection is broken. Default value: 9. . tcp_keepalive_intvl - INTEGER How frequently the probes are send out. Multiplied by tcp_keepalive_probes it is time to kill not responding connection, after probes started. Default value: 75sec i.e. connection will be aborted after ~11 minutes of retries. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_keepalive_intvl=20 net.ipv4.tcp_keepalive_probes=3 net.ipv4.tcp_keepalive_time=60 . è¿æ¥ç©ºé—²60ç§’å, æ¯éš”20ç§’å‘å¿ƒè·³åŒ…, å°è¯•3æ¬¡å¿ƒè·³åŒ…æ²¡æœ‰å“åº”ï¼Œå…³é—­è¿æ¥ã€‚ ä»å¼€å§‹ç©ºé—²ï¼Œåˆ°å…³é—­è¿æ¥æ€»å…±å†æ—¶120ç§’ã€‚ ``` 11\. å‚æ•° ``` net.ipv4.tcp_mem=8388608 12582912 16777216 ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_mem - vector of 3 INTEGERs: min, pressure, max å•ä½ page min: below this number of pages TCP is not bothered about its memory appetite. . pressure: when amount of memory allocated by TCP exceeds this number of pages, TCP moderates its memory consumption and enters memory pressure mode, which is exited when memory consumption falls under "min". . max: number of pages allowed for queueing by all TCP sockets. . Defaults are calculated at boot time from amount of available memory. 64GB å†…å­˜ï¼Œè‡ªåŠ¨è®¡ç®—çš„å€¼æ˜¯è¿™æ ·çš„ net.ipv4.tcp_mem = 1539615 2052821 3079230 . 512GB å†…å­˜ï¼Œè‡ªåŠ¨è®¡ç®—å¾—åˆ°çš„å€¼æ˜¯è¿™æ ·çš„ net.ipv4.tcp_mem = 49621632 66162176 99243264 . è¿™ä¸ªå‚æ•°è®©æ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è®¡ç®—ï¼Œé—®é¢˜ä¹Ÿä¸å¤§ ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_mem=8388608 12582912 16777216 . è¿™ä¸ªå‚æ•°è®©æ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è®¡ç®—ï¼Œé—®é¢˜ä¹Ÿä¸å¤§ ``` 12\. å‚æ•° ``` net.ipv4.tcp_fin_timeout ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_fin_timeout - INTEGER The length of time an orphaned (no longer referenced by any application) connection will remain in the FIN_WAIT_2 state before it is aborted at the local end. While a perfectly valid "receive only" state for an un-orphaned connection, an orphaned connection in FIN_WAIT_2 state could otherwise wait forever for the remote to close its end of the connection. Cf. tcp_max_orphans Default: 60 seconds ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_fin_timeout=5 . åŠ å¿«åƒµå°¸è¿æ¥å›æ”¶é€Ÿåº¦ ``` 13\. å‚æ•° ``` net.ipv4.tcp_synack_retries ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_synack_retries - INTEGER Number of times SYNACKs for a passive TCP connection attempt will be retransmitted. Should not be higher than 255. Default value is 5, which corresponds to 31seconds till the last retransmission with the current initial RTO of 1second. With this the final timeout for a passive TCP connection will happen after 63seconds. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_synack_retries=2 . ç¼©çŸ­tcp syncackè¶…æ—¶æ—¶é—´ ``` 14\. å‚æ•° ``` net.ipv4.tcp_syncookies ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_syncookies - BOOLEAN Only valid when the kernel was compiled with CONFIG_SYN_COOKIES Send out syncookies when the syn backlog queue of a socket overflows. This is to prevent against the common 'SYN flood attack' Default: 1 . Note, that syncookies is fallback facility. It MUST NOT be used to help highly loaded servers to stand against legal connection rate. If you see SYN flood warnings in your logs, but investigation shows that they occur because of overload with legal connections, you should tune another parameters until this warning disappear. See: tcp_max_syn_backlog, tcp_synack_retries, tcp_abort_on_overflow. . syncookies seriously violate TCP protocol, do not allow to use TCP extensions, can result in serious degradation of some services (f.e. SMTP relaying), visible not by you, but your clients and relays, contacting you. While you see SYN flood warnings in logs not being really flooded, your server is seriously misconfigured. . If you want to test which effects syncookies have to your network connections you can set this knob to 2 to enable unconditionally generation of syncookies. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_syncookies=1 . é˜²æ­¢syn floodæ”»å‡» ``` 15\. å‚æ•° ``` net.ipv4.tcp_timestamps ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_timestamps - BOOLEAN Enable timestamps as defined in RFC1323. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_timestamps=1 . tcp_timestamps æ˜¯ tcp åè®®ä¸­çš„ä¸€ä¸ªæ‰©å±•é¡¹ï¼Œé€šè¿‡æ—¶é—´æˆ³çš„æ–¹å¼æ¥æ£€æµ‹è¿‡æ¥çš„åŒ…ä»¥é˜²æ­¢ PAWS(Protect Against Wrapped Sequence numbers)ï¼Œå¯ä»¥æé«˜ tcp çš„æ€§èƒ½ã€‚ ``` 16\. å‚æ•° ``` net.ipv4.tcp_tw_recycle net.ipv4.tcp_tw_reuse net.ipv4.tcp_max_tw_buckets ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_tw_recycle - BOOLEAN Enable fast recycling TIME-WAIT sockets. Default value is 0. It should not be changed without advice/request of technical experts. . tcp_tw_reuse - BOOLEAN Allow to reuse TIME-WAIT sockets for new connections when it is safe from protocol viewpoint. Default value is 0. It should not be changed without advice/request of technical experts. . tcp_max_tw_buckets - INTEGER Maximal number of timewait sockets held by system simultaneously. If this number is exceeded time-wait socket is immediately destroyed and warning is printed. This limit exists only to prevent simple DoS attacks, you _must_ not lower the limit artificially, but rather increase it (probably, after increasing installed memory), if network conditions require more than default value. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_tw_recycle=0 net.ipv4.tcp_tw_reuse=1 net.ipv4.tcp_max_tw_buckets = 2xxxxx . net.ipv4.tcp_tw_recycleå’Œnet.ipv4.tcp_timestampsä¸å»ºè®®åŒæ—¶å¼€å¯ ``` 17\. å‚æ•° ``` net.ipv4.tcp_rmem net.ipv4.tcp_wmem ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` tcp_wmem - vector of 3 INTEGERs: min, default, max min: Amount of memory reserved for send buffers for TCP sockets. Each TCP socket has rights to use it due to fact of its birth. Default: 1 page . default: initial size of send buffer used by TCP sockets. This value overrides net.core.wmem_default used by other protocols. It is usually lower than net.core.wmem_default. Default: 16K . max: Maximal amount of memory allowed for automatically tuned send buffers for TCP sockets. This value does not override net.core.wmem_max. Calling setsockopt() with SO_SNDBUF disables automatic tuning of that socket's send buffer size, in which case this value is ignored. Default: between 64K and 4MB, depending on RAM size. . tcp_rmem - vector of 3 INTEGERs: min, default, max min: Minimal size of receive buffer used by TCP sockets. It is guaranteed to each TCP socket, even under moderate memory pressure. Default: 1 page . default: initial size of receive buffer used by TCP sockets. This value overrides net.core.rmem_default used by other protocols. Default: 87380 bytes. This value results in window of 65535 with default setting of tcp_adv_win_scale and tcp_app_win:0 and a bit less for default tcp_app_win. See below about these variables. . max: maximal size of receive buffer allowed for automatically selected receiver buffers for TCP socket. This value does not override net.core.rmem_max. Calling setsockopt() with SO_RCVBUF disables automatic tuning of that socket's receive buffer size, in which case this value is ignored. Default: between 87380B and 6MB, depending on RAM size. ``` æ¨èè®¾ç½® ``` net.ipv4.tcp_rmem=8192 87380 16777216 net.ipv4.tcp_wmem=8192 65536 16777216 . è®¸å¤šæ•°æ®åº“çš„æ¨èè®¾ç½®ï¼Œæé«˜ç½‘ç»œæ€§èƒ½ ``` 18\. å‚æ•° ``` net.nf_conntrack_max net.netfilter.nf_conntrack_max ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6 ``` å‚æ•°è§£é‡Š ``` nf_conntrack_max - INTEGER Size of connection tracking table. Default value is nf_conntrack_buckets value * 4. ``` æ¨èè®¾ç½® ``` net.nf_conntrack_max=1xxxxxx net.netfilter.nf_conntrack_max=1xxxxxx ``` 19\. å‚æ•° ``` vm.dirty_background_bytes vm.dirty_expire_centisecs vm.dirty_ratio vm.dirty_writeback_centisecs ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` ============================================================== . dirty_background_bytes . Contains the amount of dirty memory at which the background kernel flusher threads will start writeback. . Note: dirty_background_bytes is the counterpart of dirty_background_ratio. Only one of them may be specified at a time. When one sysctl is written it is immediately taken into account to evaluate the dirty memory limits and the other appears as 0 when read. . ============================================================== . dirty_background_ratio . Contains, as a percentage of total system memory, the number of pages at which the background kernel flusher threads will start writing out dirty data. . ============================================================== . dirty_bytes . Contains the amount of dirty memory at which a process generating disk writes will itself start writeback. . Note: dirty_bytes is the counterpart of dirty_ratio. Only one of them may be specified at a time. When one sysctl is written it is immediately taken into account to evaluate the dirty memory limits and the other appears as 0 when read. . Note: the minimum value allowed for dirty_bytes is two pages (in bytes); any value lower than this limit will be ignored and the old configuration will be retained. . ============================================================== . dirty_expire_centisecs . This tunable is used to define when dirty data is old enough to be eligible for writeout by the kernel flusher threads. It is expressed in 100'ths of a second. Data which has been dirty in-memory for longer than this interval will be written out next time a flusher thread wakes up. . ============================================================== . dirty_ratio . Contains, as a percentage of total system memory, the number of pages at which a process which is generating disk writes will itself start writing out dirty data. . ============================================================== . dirty_writeback_centisecs . The kernel flusher threads will periodically wake up and write `old' data out to disk. This tunable expresses the interval between those wakeups, in 100'ths of a second. . Setting this to zero disables periodic writeback altogether. . ============================================================== ``` æ¨èè®¾ç½® ``` vm.dirty_background_bytes = 4096000000 vm.dirty_expire_centisecs = 6000 vm.dirty_ratio = 80 vm.dirty_writeback_centisecs = 50 . å‡å°‘æ•°æ®åº“è¿›ç¨‹åˆ·è„é¡µçš„é¢‘ç‡ï¼Œdirty_background_bytesæ ¹æ®å®é™…IOPSèƒ½åŠ›ä»¥åŠå†…å­˜å¤§å°è®¾ç½® ``` 20\. å‚æ•° ``` vm.extra_free_kbytes ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6 ``` å‚æ•°è§£é‡Š ``` extra_free_kbytes . This parameter tells the VM to keep extra free memory between the threshold where background reclaim (kswapd) kicks in, and the threshold where direct reclaim (by allocating processes) kicks in. . This is useful for workloads that require low latency memory allocations and have a bounded burstiness in memory allocations, for example a realtime application that receives and transmits network traffic (causing in-kernel memory allocations) with a maximum total message burst size of 200MB may need 200MB of extra free memory to avoid direct reclaim related latencies. . ç›®æ ‡æ˜¯å°½é‡è®©åå°è¿›ç¨‹å›æ”¶å†…å­˜ï¼Œæ¯”ç”¨æˆ·è¿›ç¨‹ææ—©å¤šå°‘kbyteså›æ”¶ï¼Œå› æ­¤ç”¨æˆ·è¿›ç¨‹å¯ä»¥å¿«é€Ÿåˆ†é…å†…å­˜ã€‚ ``` æ¨èè®¾ç½® ``` vm.extra_free_kbytes=4xxxxxx ``` 21\. å‚æ•° ``` vm.min_free_kbytes ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` min_free_kbytes: . This is used to force the Linux VM to keep a minimum number of kilobytes free. The VM uses this number to compute a watermark[WMARK_MIN] value for each lowmem zone in the system. Each lowmem zone gets a number of reserved free pages based proportionally on its size. . Some minimal amount of memory is needed to satisfy PF_MEMALLOC allocations; if you set this to lower than 1024KB, your system will become subtly broken, and prone to deadlock under high loads. . Setting this too high will OOM your machine instantly. ``` æ¨èè®¾ç½® ``` vm.min_free_kbytes = 2xxxxxx # vm.min_free_kbytes å»ºè®®æ¯32Gå†…å­˜åˆ†é…1G vm.min_free_kbytes. é˜²æ­¢åœ¨é«˜è´Ÿè½½æ—¶ç³»ç»Ÿæ— å“åº”ï¼Œå‡å°‘å†…å­˜åˆ†é…æ­»é”æ¦‚ç‡ã€‚ ``` 22\. å‚æ•° ``` vm.mmap_min_addr ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` mmap_min_addr . This file indicates the amount of address space which a user process will be restricted from mmapping. Since kernel null dereference bugs could accidentally operate based on the information in the first couple of pages of memory userspace processes should not be allowed to write to them. By default this value is set to 0 and no protections will be enforced by the security module. Setting this value to something like 64k will allow the vast majority of applications to work correctly and provide defense in depth against future potential kernel bugs. ``` æ¨èè®¾ç½® ``` vm.mmap_min_addr=6xxxx . é˜²æ­¢å†…æ ¸éšè—çš„BUGå¯¼è‡´çš„é—®é¢˜ ``` 23\. å‚æ•° ``` vm.overcommit_memory vm.overcommit_ratio ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` ============================================================== . overcommit_kbytes: . When overcommit_memory is set to 2, the committed address space is not permitted to exceed swap plus this amount of physical RAM. See below. . Note: overcommit_kbytes is the counterpart of overcommit_ratio. Only one of them may be specified at a time. Setting one disables the other (which then appears as 0 when read). . ============================================================== . overcommit_memory: . This value contains a flag that enables memory overcommitment. . When this flag is 0, the kernel attempts to estimate the amount of free memory left when userspace requests more memory. . When this flag is 1, the kernel pretends there is always enough memory until it actually runs out. . When this flag is 2, the kernel uses a "never overcommit" policy that attempts to prevent any overcommit of memory. Note that user_reserve_kbytes affects this policy. . This feature can be very useful because there are a lot of programs that malloc() huge amounts of memory "just-in-case" and don't use much of it. . The default value is 0. . See Documentation/vm/overcommit-accounting and security/commoncap.c::cap_vm_enough_memory() for more information. . ============================================================== . overcommit_ratio: . When overcommit_memory is set to 2, the committed address space is not permitted to exceed swap + this percentage of physical RAM. See above. . ============================================================== ``` æ¨èè®¾ç½® ``` vm.overcommit_memory = 0 vm.overcommit_ratio = 90 . vm.overcommit_memory = 0 æ—¶ vm.overcommit_ratioå¯ä»¥ä¸è®¾ç½® ``` 24\. å‚æ•° ``` vm.swappiness ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` swappiness . This control is used to define how aggressive the kernel will swap memory pages. Higher values will increase agressiveness, lower values decrease the amount of swap. . The default value is 60. ``` æ¨èè®¾ç½® ``` vm.swappiness = 0 ``` 25\. å‚æ•° ``` vm.zone_reclaim_mode ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` zone_reclaim_mode: . Zone_reclaim_mode allows someone to set more or less aggressive approaches to reclaim memory when a zone runs out of memory. If it is set to zero then no zone reclaim occurs. Allocations will be satisfied from other zones / nodes in the system. . This is value ORed together of . 1 = Zone reclaim on 2 = Zone reclaim writes dirty pages out 4 = Zone reclaim swaps pages . zone_reclaim_mode is disabled by default. For file servers or workloads that benefit from having their data cached, zone_reclaim_mode should be left disabled as the caching effect is likely to be more important than data locality. . zone_reclaim may be enabled if it's known that the workload is partitioned such that each partition fits within a NUMA node and that accessing remote memory would cause a measurable performance reduction. The page allocator will then reclaim easily reusable pages (those page cache pages that are currently not used) before allocating off node pages. . Allowing zone reclaim to write out pages stops processes that are writing large amounts of data from dirtying pages on other nodes. Zone reclaim will write out dirty pages if a zone fills up and so effectively throttle the process. This may decrease the performance of a single process since it cannot use all of system memory to buffer the outgoing writes anymore but it preserve the memory on other nodes so that the performance of other processes running on other nodes will not be affected. . Allowing regular swap effectively restricts allocations to the local node unless explicitly overridden by memory policies or cpuset configurations. ``` æ¨èè®¾ç½® ``` vm.zone_reclaim_mode=0 . ä¸ä½¿ç”¨NUMA ``` 26\. å‚æ•° ``` net.ipv4.ip_local_port_range ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` ip_local_port_range - 2 INTEGERS Defines the local port range that is used by TCP and UDP to choose the local port. The first number is the first, the second the last local port number. The default values are 32768 and 61000 respectively. . ip_local_reserved_ports - list of comma separated ranges Specify the ports which are reserved for known third-party applications. These ports will not be used by automatic port assignments (e.g. when calling connect() or bind() with port number 0). Explicit port allocation behavior is unchanged. . The format used for both input and output is a comma separated list of ranges (e.g. "1,2-4,10-10" for ports 1, 2, 3, 4 and 10). Writing to the file will clear all previously reserved ports and update the current list with the one given in the input. . Note that ip_local_port_range and ip_local_reserved_ports settings are independent and both are considered by the kernel when determining which ports are available for automatic port assignments. . You can reserve ports which are not in the current ip_local_port_range, e.g.: . $ cat /proc/sys/net/ipv4/ip_local_port_range 32000 61000 $ cat /proc/sys/net/ipv4/ip_local_reserved_ports 8080,9148 . although this is redundant. However such a setting is useful if later the port range is changed to a value that will include the reserved ports. . Default: Empty ``` æ¨èè®¾ç½® ``` net.ipv4.ip_local_port_range=40000 65535 . é™åˆ¶æœ¬åœ°åŠ¨æ€ç«¯å£åˆ†é…èŒƒå›´ï¼Œé˜²æ­¢å ç”¨ç›‘å¬ç«¯å£ã€‚ ``` 27\. å‚æ•° ``` vm.nr_hugepages ``` æ”¯æŒç³»ç»Ÿ ``` CentOS 6, 7 ``` å‚æ•°è§£é‡Š ``` ============================================================== nr_hugepages Change the minimum size of the hugepage pool. See Documentation/vm/hugetlbpage.txt ============================================================== nr_overcommit_hugepages Change the maximum size of the hugepage pool. The maximum is nr_hugepages + nr_overcommit_hugepages. See Documentation/vm/hugetlbpage.txt . The output of "cat /proc/meminfo" will include lines like: ...... HugePages_Total: vvv HugePages_Free: www HugePages_Rsvd: xxx HugePages_Surp: yyy Hugepagesize: zzz kB . where: HugePages_Total is the size of the pool of huge pages. HugePages_Free is the number of huge pages in the pool that are not yet allocated. HugePages_Rsvd is short for "reserved," and is the number of huge pages for which a commitment to allocate from the pool has been made, but no allocation has yet been made. Reserved huge pages guarantee that an application will be able to allocate a huge page from the pool of huge pages at fault time. HugePages_Surp is short for "surplus," and is the number of huge pages in the pool above the value in /proc/sys/vm/nr_hugepages. The maximum number of surplus huge pages is controlled by /proc/sys/vm/nr_overcommit_hugepages. . /proc/filesystems should also show a filesystem of type "hugetlbfs" configured in the kernel. . /proc/sys/vm/nr_hugepages indicates the current number of "persistent" huge pages in the kernel's huge page pool. "Persistent" huge pages will be returned to the huge page pool when freed by a task. A user with root privileges can dynamically allocate more or free some persistent huge pages by increasing or decreasing the value of 'nr_hugepages'. ``` æ¨èè®¾ç½® ``` å¦‚æœè¦ä½¿ç”¨PostgreSQLçš„huge pageï¼Œå»ºè®®è®¾ç½®å®ƒã€‚ å¤§äºæ•°æ®åº“éœ€è¦çš„å…±äº«å†…å­˜å³å¯ã€‚ ``` 28\. å‚æ•° fs.nr_open12æ”¯æŒç³»ç»Ÿ CentOS 6, 712å‚æ•°è§£é‡Š nr_open: This denotes the maximum number of file-handles a process canallocate. Default value is 1024*1024 (1048576) which should beenough for most machines. Actual limit depends on RLIMIT_NOFILEresource limit. å®ƒè¿˜å½±å“security/limits.conf çš„æ–‡ä»¶å¥æŸ„é™åˆ¶ï¼Œå•ä¸ªè¿›ç¨‹çš„æ‰“å¼€å¥æŸ„ä¸èƒ½å¤§äºfs.nr_openï¼Œæ‰€ä»¥è¦åŠ å¤§æ–‡ä»¶å¥æŸ„é™åˆ¶ï¼Œé¦–å…ˆè¦åŠ å¤§nr_open æ¨èè®¾ç½® å¯¹äºæœ‰å¾ˆå¤šå¯¹è±¡ï¼ˆè¡¨ã€è§†å›¾ã€ç´¢å¼•ã€åºåˆ—ã€ç‰©åŒ–è§†å›¾ç­‰ï¼‰çš„PostgreSQLæ•°æ®åº“ï¼Œå»ºè®®è®¾ç½®ä¸º2000ä¸‡ï¼Œä¾‹å¦‚fs.nr_open=20480000 ## æ•°æ®åº“å…³å¿ƒçš„èµ„æºé™åˆ¶ 1\. é€šè¿‡/etc/security/limits.confè®¾ç½®ï¼Œæˆ–è€…ulimitè®¾ç½® 2\. é€šè¿‡/proc/$pid/limitsæŸ¥çœ‹å½“å‰è¿›ç¨‹çš„è®¾ç½® - core - limits the core file size (KB)- memlock - max locked-in-memory address space (KB)- nofile - max number of open files å»ºè®®è®¾ç½®ä¸º1000ä¸‡ , ä½†æ˜¯å¿…é¡»è®¾ç½®sysctl, fs.nr_openå¤§äºå®ƒï¼Œå¦åˆ™ä¼šå¯¼è‡´ç³»ç»Ÿæ— æ³•ç™»é™†ã€‚- nproc - max number of processesä»¥ä¸Šå››ä¸ªæ˜¯éå¸¸å…³å¿ƒçš„é…ç½®â€¦. - data - max data size (KB)- fsize - maximum filesize (KB)- rss - max resident set size (KB)- stack - max stack size (KB)- cpu - max CPU time (MIN)- as - address space limit (KB)- maxlogins - max number of logins for this user- maxsyslogins - max number of logins on the system- priority - the priority to run user process with- locks - max number of file locks the user can hold- sigpending - max number of pending signals- msgqueue - max memory used by POSIX message queues (bytes)- nice - max nice priority allowed to raise to values: [-20, 19]- rtprio - max realtime priority ## æ•°æ®åº“å…³å¿ƒçš„IOè°ƒåº¦è§„åˆ™ 1\. ç›®å‰æ“ä½œç³»ç»Ÿæ”¯æŒçš„IOè°ƒåº¦ç­–ç•¥åŒ…æ‹¬cfq, deadline, noop ç­‰ã€‚ /kernel-doc-xxx/Documentation/block-râ€“râ€“râ€“ 1 root root 674 Apr 8 16:33 00-INDEX-râ€“râ€“râ€“ 1 root root 55006 Apr 8 16:33 biodoc.txt-râ€“râ€“râ€“ 1 root root 618 Apr 8 16:33 capability.txt-râ€“râ€“râ€“ 1 root root 12791 Apr 8 16:33 cfq-iosched.txt-râ€“râ€“râ€“ 1 root root 13815 Apr 8 16:33 data-integrity.txt-râ€“râ€“râ€“ 1 root root 2841 Apr 8 16:33 deadline-iosched.txt-râ€“râ€“râ€“ 1 root root 4713 Apr 8 16:33 ioprio.txt-râ€“râ€“râ€“ 1 root root 2535 Apr 8 16:33 null_blk.txt-râ€“râ€“râ€“ 1 root root 4896 Apr 8 16:33 queue-sysfs.txt-râ€“râ€“râ€“ 1 root root 2075 Apr 8 16:33 request.txt-râ€“râ€“râ€“ 1 root root 3272 Apr 8 16:33 stat.txt-râ€“râ€“râ€“ 1 root root 1414 Apr 8 16:33 switching-sched.txt-râ€“râ€“râ€“ 1 root root 3916 Apr 8 16:33 writeback_cache_control.txt å¦‚æœä½ è¦è¯¦ç»†äº†è§£è¿™äº›è°ƒåº¦ç­–ç•¥çš„è§„åˆ™ï¼Œå¯ä»¥æŸ¥çœ‹WIKIæˆ–è€…çœ‹å†…æ ¸æ–‡æ¡£ã€‚ ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°å®ƒçš„è°ƒåº¦ç­–ç•¥ cat /sys/block/vdb/queue/schedulernoop [deadline] cfq ä¿®æ”¹ echo deadline > /sys/block/hda/queue/scheduler æˆ–è€…ä¿®æ”¹å¯åŠ¨å‚æ•° grub.confelevator=deadline` ä»å¾ˆå¤šæµ‹è¯•ç»“æœæ¥çœ‹ï¼Œæ•°æ®åº“ä½¿ç”¨deadlineè°ƒåº¦ï¼Œæ€§èƒ½ä¼šæ›´ç¨³å®šä¸€äº›ã€‚ å…¶ä»–1. å…³é—­é€æ˜å¤§é¡µ 2. ç¦ç”¨NUMA 3. SSDçš„å¯¹é½ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodb çš„ forEachç”¨æ³•]]></title>
    <url>%2F2019%2F05%2F21%2Fmongodb-forEach%2F</url>
    <content type="text"><![CDATA[åŠªåŠ›ä¸ä¸€å®šä¼šæˆåŠŸï¼Œå¯ä¸åŠªåŠ›ä¼šå¾ˆè½»æ¾å“¦ MongoDB forEach è¯´æ˜forEachæ–¹æ³•ä¸­çš„functionå›è°ƒæœ‰ä¸‰ä¸ªå‚æ•°: éå†çš„æ•°ç»„å†…å®¹ å¯¹åº”çš„æ•°ç»„ç´¢å¼• æ•°ç»„æœ¬èº« MongoDB forEach ä½¿ç”¨æ¡ˆä¾‹MongoDBæ•°æ®æ’å…¥ã€åˆ é™¤ã€æ›´æ–°ã€æ‰¹é‡æ›´æ–°æŸä¸ªå­—æ®µæ‰¹é‡æ›´æ–°æŸä¸ªå­—æ®µ ä¾‹112345db.getCollection('bond_sentiment_news').find({"source" : 2,"siteUrl" : "http://www.21jingji.com/"}).forEach( function(item){ db.getCollection('bond_sentiment_news').update({"_id":item._id},{$set:{"siteName":"21ç»æµç½‘"}}) }) ä¾‹212345db.getCollection('my_booking').find({"hospitalName":/xxåŒ»é™¢/,openId:/^2/}).forEach( function(item){ db.getCollection('my_booking').update({"_id":item._id},{$set:{"payType": "1"}}) }) æŸ¥è¯¢å‡ºhospitalNameæ˜¯xxåŒ»é™¢å’ŒopenIdä»¥2å¼€å¤´çš„æ‰€æœ‰è®°å½•ï¼Œå¹¶ä¸”æ›´æ–°my_bookingè¡¨ä¸­çš„payTypeä¸º1. ä¾‹312345db.getCollection('my_booking').find({"hospitalName":/è¿åŸå¸‚ä¸­å¿ƒåŒ»é™¢/,openId:{$not:/^2/}}).forEach( function(item){ db.getCollection('my_booking').update({"_id":item._id},{$set:{"outTradeNo1": item.outTradeNo2}}) }) æŸ¥è¯¢å‡ºxxåŒ»é™¢å’Œä¸å·²2å¼€å¤´çš„openIdçš„æ‰€æœ‰è®°å½•ï¼Œå¹¶ä¸”å°†æ¯æ¡è®°å½•çš„outTradeNo2èµ‹å€¼ç»™outTradeNo1. MongoDB æ•°ç»„éå†æ“ä½œ forEach12345db.User.find().forEach( function(item){ db.User.update({"_id":item._id},{"$set":{"LastUpdate":item.CreateAt}},false,true) }) MongoDB æ›´æ–°æ¯æ¡æ•°æ®æŸä¸ªå­—æ®µçš„å€¼ä¾‹112345678910111213141516var begin = 1499675090;var end = 1499675198;var t = begin;while(t]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodb aggregate åŸºäºUNIXæ—¶é—´æˆ³çš„èšåˆ]]></title>
    <url>%2F2019%2F05%2F20%2Fmongodb-aggregate%2F</url>
    <content type="text"><![CDATA[å¯¹ä»Šå¤©è§£å†³ä¸äº†çš„äº‹æƒ…ï¼Œä¹Ÿä¸è¦ç€æ€¥ã€‚å› ä¸ºæ˜å¤©ä¹Ÿå¯èƒ½è¿˜æ˜¯è§£å†³ä¸äº†ã€‚ å‰æå¼€å‘æ‰¾æˆ‘é—®MongoDB çš„ aggregate èšåˆç”¨è¿‡ä¸ğŸ˜° ã€‚ æˆ‘è¯´æŸ¥æŸ¥èµ„æ–™å§ï¼Œå‘ç°æ˜¯aggregateèšåˆç®¡é“ ğŸ˜¨ ã€‚ æŠŠSQL ä¸ Aggergation å¯¹æ¯”ä¸‹ğŸ˜‚ SQL Terms, Functions, and Concepts MongoDB Aggregation Operators WHERE $match HAVING $match SELECT $project ORDER BY $sort LIMIT $limit SUM() $sum COUNT() $sum COUNT() $sortByCount join $lookup å¼€å‘çš„éœ€æ±‚æ˜¯: æŒ‰ç…§å¤©åˆ†ç»„ï¼Œç»Ÿè®¡ä¸€ä¸‹æ•°é‡ ç»è¿‡æŸ¥çœ‹MongoDBå®˜ç½‘çš„aggregateèµ„æ–™å®ç°å¼€å‘çš„éœ€æ±‚ å®ç°æŸ¥è¯¢æ•°æ®çš„çŠ¶æ€1db.antispam_image.find({"moduleId":5,createTs:{$gte:1554048000},createTs:{$lt:1556640000}}).pretty().limit(1); 1234567891011121314151617181920212223242526272829303132333435363738{ "_id" : ObjectId("5c125657372eecd7a0a54e5e"), "adRate" : 0, "assoId" : "223794113", "assoType" : 201, "clientIp" : "183.131.7.23", "clientType" : "", "confidence" : 12.655, "content" : "****http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1\**", "createTs" : NumberLong(1544705623), "emailStatus" : "verified", "handleTs" : NumberLong(1545036013), "hotScore" : 14.285, "inspectStatus" : 2, "message" : "", "moduleId" : NumberLong(5), "normalScore" : 73.25, "ocrKeyword" : [ ], "ocrText" : [ ], "opUser" : "fanyanning", "opUserId" : NumberLong(31648494), "pornScore" : 12.464, "qcode" : 0, "receiveTs" : NumberLong(1545035885), "regTs" : NumberLong(1475385061), "requestId" : "6f078c58-1235-4816-96a5-e876ea0cbcf2", "rotOcrKeyword" : [ ], "rotOcrText" : [ ], "ruleId" : NumberLong(10019), "sim" : 0, "status" : 1000, "trashType" : 0, "ts" : NumberLong(1544705623), "url" : "http://videoplayer.babytreeimg.com/lamavideo:2018/1213/Flb_T4qsxRcK7suNqaHo2JbD6zWJ_000001.jpg?id=-1", "userId" : NumberLong(56349617), "userLevel" : 3, "version" : "1.0.0"} å¼€å‘ç»™çš„èšåˆçš„æŸ¥è¯¢1234db.antispam_image.aggregate([{ $match: {"moduleId":5,createTs:{$gte:1554048000},createTs:{$lt:1556640000}}},{ $group: {_id :{$dateToString: {format: "%Y-%m-%d", date: "$createTs" }},count: { $sum: 1 }}}]); 1234567891011121314151617181920212223242526mgset-11469021:SECONDARY> db.antispam_image.aggregate([{$match: {"moduleId":5, createTs:{$gte:1554048000},createTs:{$lt:1556640000}}}, {$group: {_id: {$dateToString: {format: "%Y-%m-%d", date: "$createTs"}}, count: {$sum: 1}}}]);assert: command failed: { "operationTime" : Timestamp(1558347069, 2), "ok" : 0, "errmsg" : "can't convert from BSON type long to Date", "code" : 16006, "codeName" : "Location16006"} : aggregate failed_getErrorWithCode@src/mongo/shell/utils.js:25:13doassert@src/mongo/shell/assert.js:16:14assert.commandWorked@src/mongo/shell/assert.js:370:5DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5@(shell):1:12019-05-20T18:11:10.818+0800 E QUERY [thread1] Error: command failed: { "operationTime" : Timestamp(1558347069, 2), "ok" : 0, "errmsg" : "can't convert from BSON type long to Date", "code" : 16006, "codeName" : "Location16006"} : aggregate failed :_getErrorWithCode@src/mongo/shell/utils.js:25:13doassert@src/mongo/shell/assert.js:16:14assert.commandWorked@src/mongo/shell/assert.js:370:5DBCollection.prototype.aggregate@src/mongo/shell/collection.js:1319:5@(shell):1:1 æŠ¥é”™äº†ï¼Œé—®å¼€å‘ã€‚å¼€å‘åˆç»™äº†ä¸€ä¸ªæŸ¥è¯¢è¯­å¥12345678db.antispam_image.aggregate([{ $match: {"moduleId":5,createTs:{$gte:1554048000},createTs:{$lt:1556640000}}},{ $group: { _id :{ $dateToString: {format: "%Y-%m-%d", date:{"$add":[new Date(0),"$createTs"]}} }, count: { $sum: 1 } }}]); 12{ "_id" : "1970-01-19", "count" : 15131 }{ "_id" : "1970-01-18", "count" : 180400 } å‘ç°æ—¶é—´æˆ³è½¬åŒ–ä¸å¯¹ äºæ˜¯æŸ¥çœ‹å®˜ç½‘èµ„æ–™ï¼Œç»§ç»­æ”¹å†™å…ˆæŠŠUNIXæ—¶é—´æˆ³è½¬åŒ–ä¸ºæ—¥æœŸã€‚å¯æ˜¯MongoDBåˆæ²¡æœ‰MySQLé‚£ç§FROM_UNIXTIME()ä¸UNIX_TIMESTAMP()å‡½æ•°ã€‚åªèƒ½è‡ªå·±é€  é€šè¿‡å°†å€¼ä¹˜ä»¥1000å°†createTså­—æ®µè½¬æ¢ä¸ºæ¯«ç§’æ—¶é—´æˆ³1{ "$multiply": [1000, "$createTs"]} $multiply å°†æ•°å­—ç›¸ä¹˜ä»¥è¿”å›äº§å“ã€‚æ¥å—ä»»æ„æ•°é‡çš„å‚æ•°è¡¨è¾¾å¼ã€‚ ç„¶åè½¬æ¢ä¸ºæ—¥æœŸ1"$add": [ new Date(0), { "$multiply": [1000, "$createTs"]} ] ç»§ç»­ç»„è£…æŸ¥è¯¢1{"$group": { "_id": { "year": { "$year": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ]}}, "mmonth": { "$month": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ]}}, "day": { "$dayOfMonth": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ]}}}, "count" : { "$sum" : 1 }}} åœ¨$projectç®¡é“ä¸­å®Œæˆ,æ–¹æ³•æ˜¯å°†æ¯«ç§’æ—¶é—´æ·»åŠ åˆ°é›¶æ¯«ç§’Date(0)å¯¹è±¡,ç„¶åä»è½¬æ¢åçš„æ—¥æœŸä¸­æå–$year,$month,$dayOfMonthä¸ªé›¶ä»¶,å¯ä»¥åœ¨$groupç®¡é“ä¸­ä½¿ç”¨è¿™äº›é›¶ä»¶å¯¹æ–‡æ¡£è¿›è¡Œåˆ†ç»„ å®Œæ•´çš„æŸ¥è¯¢è¯­å¥æ‹¼æ¥å‡ºæ¥1db.antispam_image.aggregate([{ $match: {"moduleId":5,createTs:{$gte:1554048000},createTs:{$lt:1556640000}}}, {"$group": { "_id": { "year": { "$year": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ]}}, "mmonth": { "$month": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ]}}, "day": { "$dayOfMonth": { "$add": [ new Date(0), { "$multiply": [1000, "$createTs"] } ] }}}, "count" : { "$sum" : 1 }}}]); 12345678910111213141516171819202122{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 30 }, "count" : 624 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 28 }, "count" : 695 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 27 }, "count" : 683 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 26 }, "count" : 765 }{ "_id" : { "year" : 2019, "mmonth" : 1, "day" : 12 }, "count" : 610 }{ "_id" : { "year" : 2019, "mmonth" : 1, "day" : 4 }, "count" : 429 }{ "_id" : { "year" : 2019, "mmonth" : 1, "day" : 3 }, "count" : 475 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 29 }, "count" : 732 }{ "_id" : { "year" : 2018, "mmonth" : 12, "day" : 31 }, "count" : 592 }{ "_id" : { "year" : 2018, "mmonth" : 12, "day" : 30 }, "count" : 542 }{ "_id" : { "year" : 2019, "mmonth" : 3, "day" : 14 }, "count" : 1155 }{ "_id" : { "year" : 2019, "mmonth" : 3, "day" : 13 }, "count" : 1169 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 20 }, "count" : 945 }{ "_id" : { "year" : 2019, "mmonth" : 3, "day" : 15 }, "count" : 1062 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 24 }, "count" : 751 }{ "_id" : { "year" : 2018, "mmonth" : 10, "day" : 15 }, "count" : 721 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 18 }, "count" : 895 }{ "_id" : { "year" : 2018, "mmonth" : 10, "day" : 16 }, "count" : 713 }{ "_id" : { "year" : 2019, "mmonth" : 4, "day" : 14 }, "count" : 1278 }{ "_id" : { "year" : 2018, "mmonth" : 10, "day" : 17 }, "count" : 583 }Type "it" for moremgset-11469021:SECONDARY> æ‹¿è¿™æ ·æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®é—®å¼€å‘æ˜¯å¦æ˜¯è¿™æ ·ã€å¼€å‘ç¡®è®¤è¿™æ ·å¯ä»¥ã€‚éœ€æ±‚è§£å†³ã€‚ å¼€å‘å†™äº†ä¸€ä¸ªæŸ¥è¯¢12345678910db.antispam_report.aggregate( [ { $project: { createTs: 1, date1Str: {$dateToString: {format: "%Y-%m-%d", date:{"$add":[new Date(0),{"$multiply":["$createTs",1000]},28800000]}}} } } ]) æ·»åŠ äº†æ—¶åŒºæ—¶é—´28800000 123456789101112131415161718192021{ "_id" : ObjectId("5bd41d96e870a1daab7a0d6d"), "createTs" : NumberLong(1540627862), "date1Str" : "2018-10-27" }{ "_id" : ObjectId("5bd8fc96e870a1daab5e99c1"), "createTs" : NumberLong(1540947095), "date1Str" : "2018-10-31" }{ "_id" : ObjectId("5bf9ed96e870a1daabe6b236"), "createTs" : NumberLong(1543105942), "date1Str" : "2018-11-25" }{ "_id" : ObjectId("5c025140e870a1daaba6f00c"), "createTs" : NumberLong(1543655744), "date1Str" : "2018-12-01" }{ "_id" : ObjectId("5bffc529e870a1daabadff49"), "createTs" : NumberLong(1543488809), "date1Str" : "2018-11-29" }{ "_id" : ObjectId("5c0ce4b8e870a1daab28b208"), "createTs" : NumberLong(1544348856), "date1Str" : "2018-12-09" }{ "_id" : ObjectId("5bf23dc4e870a1daab3b698c"), "createTs" : NumberLong(1542602181), "date1Str" : "2018-11-19" }{ "_id" : ObjectId("5bf1fdc2e870a1daab7729b1"), "createTs" : NumberLong(1542585793), "date1Str" : "2018-11-19" }{ "_id" : ObjectId("5bf9ed8be870a1daabe57c10"), "createTs" : NumberLong(1543105931), "date1Str" : "2018-11-25" }{ "_id" : ObjectId("5c064d15e870a1daabcb43bd"), "createTs" : NumberLong(1543916821), "date1Str" : "2018-12-04" }{ "_id" : ObjectId("5be44e5ce870a1daabb1b84f"), "createTs" : NumberLong(1541688924), "date1Str" : "2018-11-08" }{ "_id" : ObjectId("5bffeafee870a1daab044619"), "createTs" : NumberLong(1543498494), "date1Str" : "2018-11-29" }{ "_id" : ObjectId("5c076f01e870a1daabe32b96"), "createTs" : NumberLong(1543991041), "date1Str" : "2018-12-05" }{ "_id" : ObjectId("5bdc4cc8e870a1daab855084"), "createTs" : NumberLong(1541164232), "date1Str" : "2018-11-02" }{ "_id" : ObjectId("5bc343d8e870a1daab708be1"), "createTs" : NumberLong(1539523544), "date1Str" : "2018-10-14" }{ "_id" : ObjectId("5bfcd64de870a1daab0d2617"), "createTs" : NumberLong(1543296589), "date1Str" : "2018-11-27" }{ "_id" : ObjectId("5bc9adefe870a1daabf4ab80"), "createTs" : NumberLong(1539943919), "date1Str" : "2018-10-19" }{ "_id" : ObjectId("5bbd8c31e870a1daab26cf3e"), "createTs" : NumberLong(1539148850), "date1Str" : "2018-10-10" }{ "_id" : ObjectId("5beff335e870a1daab8be35a"), "createTs" : NumberLong(1542452021), "date1Str" : "2018-11-17" }{ "_id" : ObjectId("5bc9ae33e870a1daabf4c03a"), "createTs" : NumberLong(1539943987), "date1Str" : "2018-10-19" }Type "it" for more ç»“è®ºé’ˆå¯¹DBAè¿™ä¸ªå²—ä½æ¥è¯´ã€‚å¤§å¤šæ•°éƒ½æ˜¯ä»äº‹MongoDB è¿ç»´å·¥ä½œ ğŸ˜‚ã€‚ å¾ˆå°‘è´´è¿‘å¼€å‘éœ€æ±‚ï¼Œè¿™æ¬¡å¼€å‘é—®äº†æˆ‘è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å½“ç„¶æ— æ³•ç«‹é©¬ç»™å‡ºç­”æ¡ˆã€‚åªèƒ½ä¸æ–­çš„æŸ¥è¯¢ã€‚æ‹¼æ¥ï¼Œæ‰èƒ½é©¬é©¬è™è™çš„æ»¡è¶³äº†å¼€å‘çš„éœ€æ±‚ âœ…ã€‚ åˆšæ‰é—®ä¸€ä¸ªæ¶æ„å¸ˆï¼Œæ¶æ„å¸ˆè¯´æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹å¼ï¼š æŸ¥å‡ºæ€»ç»“å‡ºä¸€å¤©çš„æ•°æ®ï¼Œæ”¾åˆ°ç®¡é“ä¸­ä¸´æ—¶ä¿å­˜èµ·æ¥ åœ¨ç”¨å‰ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æŸæ—¶é—´ä½œä¸ºç¬¬äºŒå¤©çš„å¼€å§‹æ—¶é—´ï¼Œåœ¨åŠ ä¸Šä¸€å¤©çš„æ—¶é—´(86400s)å¾—å‡ºç»“å°¾æ—¶é—´ã€‚ æŸ¥è¯¢å®Œæˆåœ¨ç»Ÿä¸€æ˜¾ç¤ºæ‰“å°å‡ºæ¥ è¿™ç§æ–¹å¼å°±éœ€è¦ä½¿ç”¨MongoDB forEachæ–¹å¼å®ç°äº†ã€‚ å¼€å‘åˆè¯´ä¸èƒ½æŒ‰æ—¶é—´æ’åºğŸ˜± , å¦¹çš„ğŸ˜‚å“ªé‡Œæ¥çš„è¿™ä¹ˆå¤šè¦æ±‚ğŸ˜± å‚è€ƒ MongoDB å®˜æ–¹èµ„æ–™: aggregateèµ„æ–™ MongoDB èšåˆæŸ¥è¯¢ - æŒ‰æ—¶é—´åˆ†ç»„ç»Ÿè®¡ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodbæ•°æ®å¯¼å‡ºCSVæ–‡ä»¶]]></title>
    <url>%2F2019%2F05%2F17%2Fmongodb-to-csv%2F</url>
    <content type="text"><![CDATA[è¦ä¸æ˜¯å› ä¸ºæˆ‘ï¼Œä½ èƒ½æœ‰ä»Šå¤©ï¼Ÿè¦ä¸æ˜¯æˆ‘ä¼¤å®³ä½ ï¼Œä½ èƒ½æˆé•¿ï¼Ÿ éœ€æ±‚äº§å“éœ€è¦åˆ†æè¾¾äººæ–‡ç« çš„æ ‡ç­¾ï¼Œéœ€è¦æŠŠ2019å¹´1æœˆ1å·åˆ°ç°åœ¨çš„æ ‡ç­¾ï¼Œä»mongoå¯¼å‡ºæ¥ï¼Œå¯¼å‡ºæ ¼å¼ä¸ºcsvï¼ŒæŸ¥è¯¢æ¡ä»¶å¦‚ä¸‹ï¼š1db.content_medium_hismatch.find({"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}); æ“ä½œä½¿ç”¨MongoDBä¸­çš„mongoexportå‘½ä»¤1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859mongoexport --helpUsage: mongoexport Export data from MongoDB in CSV or JSON format.See http://docs.mongodb.org/manual/reference/program/mongoexport/ for more information.general options: --help print usage --version print the tool version and exitverbosity options: -v, --verbose= more detailed log output (include multiple times for more verbosity, e.g. -vvvvv, or specify a numeric value, e.g. --verbose=N) --quiet hide all log outputconnection options: -h, --host= mongodb host to connect to (setname/host1,host2 for replica sets) --port= server port (can also use --host hostname:port)ssl options: --ssl connect to a mongod or mongos that has ssl enabled --sslCAFile= the .pem file containing the root certificate chain from the certificate authority --sslPEMKeyFile= the .pem file containing the certificate and key --sslPEMKeyPassword= the password to decrypt the sslPEMKeyFile, if necessary --sslCRLFile= the .pem file containing the certificate revocation list --sslAllowInvalidCertificates bypass the validation for server certificates --sslAllowInvalidHostnames bypass the validation for server name --sslFIPSMode use FIPS mode of the installed openssl libraryauthentication options: -u, --username= username for authentication -p, --password= password for authentication --authenticationDatabase= database that holds the user's credentials --authenticationMechanism= authentication mechanism to usenamespace options: -d, --db= database to use -c, --collection= collection to useoutput options: -f, --fields=[,]* comma separated list of field names (required for exporting CSV) e.g. -f "name,age" --fieldFile= file with field names - 1 per line --type= the output format, either json or csv (defaults to 'json') (default: json) -o, --out= output file; if not specified, stdout is used --jsonArray output to a JSON array rather than one object per line --pretty output JSON formatted to be human-readable --noHeaderLine export CSV data without a list of field names at the first linequerying options: -q, --query= query filter, as a JSON string, e.g., '{x:{$gt:1}}' --queryFile= path to a file containing a query filter (JSON) -k, --slaveOk allow secondary reads if available (default true) (default: false) --readPreference=| specify either a preference name or a preference json object --forceTableScan force a table scan (do not use $snapshot) --skip= number of documents to skip --limit= limit the number of documents to export --sort= sort order, as a JSON string, e.g. '{x:1}' --assertExists if specified, export fails if the collection does not exist (default: false) æ“ä½œå‘½ä»¤å¦‚ä¸‹:1/usr/local/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query='{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}' --type=csv --out=***.csv 122019-05-17T13:18:52.325+0800 error validating settings: query '[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]' is not valid JSON: invalid character ',' after top-level value2019-05-17T13:18:52.325+0800 try 'mongoexport --help' for more information åˆæ­¥åˆ¤æ–­æ˜¯å¯¼å‡ºCSVæ–‡ä»¶ä¸­éœ€è¦çš„é€—å·(,)åˆ†å‰²ã€‚å­—æ®µå‘ç”Ÿé”™è¯¯ã€‚è¯­å¥æ·»åŠ â€“fields _id,content_id,content_tags1/usr/local/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query='{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}' --type=csv --fields _id,content_id,content_tags --out=***.csv 12`2019-05-17T13:18:54.325+0800 error validating settings: query '[123 34 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 34 58 34 50 56 34 44 34 117 112 100 97 116 101 95 116 105 109 101 34 58 123 34 36 103 116 101 34 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 34 105 115 95 100 101 108 101 116 101 34 58 48 125 44 32 123 34 99 111 110 116 101 110 116 95 105 100 34 58 49 44 34 99 111 110 116 101 110 116 95 116 97 103 115 34 58 49 125]' is not valid JSON: invalid character ',' after top-level value 2019-05-17T13:18:54.325+0800 try 'mongoexport --help' for more information``bash å¼€å§‹æ’æŸ¥ä¸ºä»€ä¹ˆè¿˜ç»§ç»­æŠ¥é”™ã€‚ä½¿ç”¨ mongo shell è¿æ¥åˆ°mongodbä¸­æŸ¥è¯¢å‘ç°æ˜¯èƒ½è·å–åˆ°æ•°æ®çš„ã€‚å»æ‰â€“query æ¡ä»¶ä¹‹åå†æ‰§è¡Œä¸€æ¬¡å‘ç°æ˜¯æ²¡é—®é¢˜1/usr/local/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --type=csv --fields _id,content_id,content_tags --out=***.csv 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556572019-05-17T13:24:18.176+0800 connected to: localhost:290012019-05-17T13:24:19.167+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:20.167+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:21.168+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:22.167+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:23.168+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:24.168+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:25.167+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)2019-05-17T13:24:26.168+0800 [........................] feeds.content_medium_hismatch 0/138863565 (0.0%)^C2019-05-17T13:24:26.900+0800 signal 'interrupt' received; forcefully terminatingpublic-ops-mongodb2 seclogin # lscontent_medium_hismatch.csvpublic-ops-mongodb2 seclogin # cat content_medium_hismatch.csv |more_id,content_id,content_tagsObjectId(5b0f598eaeeb42d8582db599),1229,"[""å¥¶ç“¶"",""åƒå¥¶"",""å¸å®"",""ä¹³å¤´æ··æ·†"",""æ¯ä¹³""]"ObjectId(5b0f598eaeeb42d8582db5c8),1290,"[""è¡£æœ"",""äºŒæ‰‹è¡£æœ"",""æ¸…æ´—"",""çš®è‚¤"",""ç»†èŒ""]"ObjectId(5b0f598eaeeb42d8582db5cd),1297,"[""èº«æ"",""äº§åå¦ˆå¦ˆ"",""æ–°å¦ˆå¦ˆ"",""è£™å­"",""è¡£æœ""]"ObjectId(5b0f598eaeeb42d8582db5e1),1325,"[""æŠ¤è‚¤å“"",""å“ºä¹³æœŸ"",""çš®è‚¤"",""å¥åº·"",""æŠ¤è‚¤""]"ObjectId(5b0f598eaeeb42d8582db5e8),1343,"[""æ”¶çº³"",""å®¶å…·"",""å¥¶ç²‰"",""åˆ†äº«"",""ä¸‰è§’å½¢""]"ObjectId(5b0f598eaeeb42d8582db618),1393,"[""èƒŒå¸¦"",""å©´å„¿"",""å¸¦å®å®"",""å‡ºé—¨"",""è‚Œè‚‰å‘è‚²""]"ObjectId(5b0f598eaeeb42d8582db65e),1465,"[""ç»´ç”Ÿç´ "",""é£Ÿç‰©"",""éª¨éª¼"",""çœ¼ç›"",""å¸®åŠ©""]"ObjectId(5b0f598eaeeb42d8582db660),1467,"[""æ™’å¤ªé˜³"",""ç´«å¤–çº¿"",""ç»´ç”Ÿç´ "",""é»„ç–¸"",""çœ¼ç›""]"ObjectId(5b0f598eaeeb42d8582db666),1472,"[""ä¼è½¦"",""æ¨è½¦"",""å©´å„¿ä¼è½¦"",""å©´å„¿æ¨è½¦"",""ä¼˜ç‚¹""]"ObjectId(5b0f598eaeeb42d8582db669),1474,"[""é£Ÿç‰©"",""å‘³è§‰å‘è‚²"",""å£å‘³"",""é£Ÿç›"",""é¥®é£Ÿ""]"ObjectId(5b0f598eaeeb42d8582db674),1490,"[""æ‚£ç—…"",""çˆ¶æ¯"",""æŒ‡ç”²"",""å¥åº·"",""æ‰“å‘¼å™œ""]"ObjectId(5b0f598eaeeb42d8582db67a),1500,"[""ç¡çœ "",""ç–¾ç—…"",""çˆ¶æ¯"",""ç—‡çŠ¶"",""åŒ»é™¢""]"ObjectId(5b0f598eaeeb42d8582db68c),1513,"[""å£°éŸ³"",""å¥¶ç¡"",""ç¾å›½"",""æ‘‡æ™ƒ"",""å®å®ç¡è§‰""]"ObjectId(5b0f598eaeeb42d8582db6a0),1535,"[""å®‰å…¨"",""æ¸…æ´—"",""åä¾¿å™¨"",""é©¬æ¡¶"",""ä¼˜ç‚¹""]"ObjectId(5b0f598eaeeb42d8582db746),2732,"[""è”æ"",""è¿›é£Ÿ"",""è‘¡è„ç³–"",""ä¸Šç«"",""ç—‡çŠ¶""]"ObjectId(5b0f598eaeeb42d8582db749),2733,"[""å®å®å–‚å…»"",""é£Ÿç‰©"",""è¾…é£Ÿ"",""æ¯ä¹³"",""é¥®é£Ÿ""]"ObjectId(5b0f598eaeeb42d8582db752),2742,"[""ä¹³å¤´"",""å–‚å¥¶"",""ä¹³å¤´çš²è£‚"",""å“ºä¹³"",""ä¹³æˆ¿""]"ObjectId(5b0f598eaeeb42d8582db758),2745,"[""é£Ÿç‰©"",""æŒ‘é£Ÿ"",""åé£Ÿ"",""çˆ¸çˆ¸"",""è èœ""]"ObjectId(5b0f598eaeeb42d8582db75b),2746,"[""åƒé¥­"",""çˆ¸çˆ¸"",""å’€åš¼"",""é£Ÿç‰©"",""æ—¶é—´""]"ObjectId(5b0f598eaeeb42d8582db75f),2747,"[""è¾…é£Ÿ"",""å°å®"",""æ ¸æ¡ƒæ²¹"",""å¥åº·"",""äºšéº»é…¸""]"ObjectId(5b0f598eaeeb42d8582db761),2748,"[""æ²¹ç‚¸"",""å¥åº·"",""é£Ÿå“"",""é£Ÿç‰©"",""æ²¹è„‚""]"ObjectId(5b0f598eaeeb42d8582db768),2751,"[""è¾…é£Ÿ"",""è†³é£Ÿçº¤ç»´"",""æ¶ˆåŒ–ä¸è‰¯"",""é£Ÿç‰©"",""è‚ é“""]"ObjectId(5b0f598eaeeb42d8582db76d),2753,"[""åƒé¥­"",""é¥®é£Ÿä¹ æƒ¯"",""å¸®åŠ©"",""ä¹ æƒ¯"",""çˆ¸çˆ¸""]"ObjectId(5b0f598eaeeb42d8582db770),2754,"[""å¾®æ³¢ç‚‰"",""è¾…é£Ÿ"",""è¥å…»"",""é£Ÿç‰©"",""ç»´ç”Ÿç´ ""]"ObjectId(5b0f598eaeeb42d8582db773),2755,"[""è‘¡è„ç³–"",""è¥å…»"",""ä¹ æƒ¯"",""å®¶é•¿"",""å®å®ç”Ÿç—…""]"ObjectId(5b0f598eaeeb42d8582db775),2756,"[""ç¥›æ¹¿"",""é£Ÿç‰©"",""å¸®åŠ©"",""é£Ÿè°±"",""çº¢è±†""]"ObjectId(5b0f598eaeeb42d8582db778),2757,"[""æ°´æœ"",""è”¬èœ"",""æœæ±"",""é…æ–¹å¥¶"",""æ¯ä¹³""]"ObjectId(5b0f598eaeeb42d8582db77e),2759,"[""æŒ‘é£Ÿ"",""ç»´ç”Ÿç´ "",""è¥å…»"",""å®å®æŒ‘é£Ÿ"",""ç¼ºé”Œ""]"ObjectId(5b0f598eaeeb42d8582db781),2760,"[""åƒè‚‰"",""å¥åº·"",""æ°´æœ"",""é¥±å’Œè„‚è‚ªé…¸"",""ä¾¿ç§˜""]"ObjectId(5b0f598eaeeb42d8582db784),2761,"[""æ°´æœ"",""è¥å…»"",""é£Ÿç‰©"",""èƒ¡èåœç´ "",""ç»´ç”Ÿç´ ""]"ObjectId(5b0f598eaeeb42d8582db787),2762,"[""ä½“é‡"",""å®å®ç˜¦"",""è¥å…»ä¸è‰¯"",""åŸå› "",""çˆ¶æ¯""]"ObjectId(5b0f598eaeeb42d8582db789),2763,"[""é£Ÿç‰©"",""è¥å…»"",""å®å®å–‚å…»"",""è¿›é£Ÿ"",""æ—¶é—´""]"ObjectId(5b0f598eaeeb42d8582db790),2765,"[""è¾…é£Ÿ"",""å®å®æ–­å¥¶"",""æ–­å¥¶"",""ä¿å­˜"",""å†°ç®±""]"ObjectId(5b0f598eaeeb42d8582db792),2766,"[""æ–­å¥¶"",""æ¯ä¹³"",""ç¯å¢ƒ"",""å¤å­£"",""å®å®ç”Ÿç—…""]"ObjectId(5b0f598eaeeb42d8582db795),2767,"[""ç›Šç”ŸèŒ"",""è¯ç‰©"",""é£Ÿå“"",""å¹³è¡¡"",""æŠ—ç”Ÿç´ ""]"ObjectId(5b0f598eaeeb42d8582db798),2768,"[""é£Ÿç‰©"",""å’³å—½"",""å®å®å’³å—½"",""é¥®é£Ÿ"",""è¾›è¾£""]"ObjectId(5b0f598eaeeb42d8582db79b),2769,"[""è¾…é£Ÿ"",""é¥®é£Ÿ"",""æ–­å¥¶"",""å®å®æ–­å¥¶"",""ä¿å­˜""]"ObjectId(5b0f598eaeeb42d8582db7a1),2773,"[""è¡¥é’™"",""ç»´ç”Ÿç´ "",""å®å®ç¼ºé’™"",""æ¯ä¹³"",""é…æ–¹å¥¶""]"ObjectId(5b0f598faeeb42d8582db7a6),2775,"[""æœæ³¥"",""æ°´æœ"",""ç»´ç”Ÿç´ "",""å“ˆå¯†ç“œ"",""é¦™è•‰""]"ObjectId(5b0f598faeeb42d8582db7a9),2776,"[""é¥®é£Ÿ"",""é£Ÿç‰©"",""è¾…é£Ÿ"",""è¿›é£Ÿ"",""æ°´æœ""]"ObjectId(5b0f598faeeb42d8582db7ac),2777,"[""æœ‰æœºè”¬èœ"",""è”¬èœ"",""å†œè¯"",""æœ‰æœº"",""å†œè¯æ®‹ç•™""]"ObjectId(5b0f598faeeb42d8582db7b4),2780,"[""æ–­å¥¶"",""ä¹³å¤´"",""ä¹³æˆ¿"",""ä¹³è…ºç‚"",""å›å¥¶""]"ObjectId(5b0f598faeeb42d8582db7b8),2783,"[""å¶é»„ç´ "",""å¤ªé˜³é•œ"",""èƒ¡èåœ"",""å—ç“œ"",""èŠ’æœ""]" å°±èƒ½ç¡®å®šè¿™ä¹ˆæ‰§è¡Œæ˜¯æ²¡æœ‰é—®é¢˜ã€‚é‡ç‚¹æ’æŸ¥--queryæ¡ä»¶ã€‚æ ¹æ®ä¹‹å‰æŠ¥é”™122019-05-17T13:25:56.341+0800 error validating settings: query '[123 99 111 110 116 101 110 116 95 116 121 112 101 95 105 100 58 50 56 44 117 112 100 97 116 101 95 116 105 109 101 58 123 36 103 116 101 58 49 53 52 54 50 55 50 48 48 48 48 48 48 125 44 105 115 95 100 101 108 101 116 101 58 48 125 44 123 99 111 110 116 101 110 116 95 105 100 58 49 44 99 111 110 116 101 110 116 95 116 97 103 115 58 49 125]' is not valid JSON: invalid character ',' after top-level value2019-05-17T13:25:56.341+0800 try 'mongoexport --help' for more information å‘ç°ä¸€ä¸ªç‚¹invalid character ',' after top-level valueä¸­æç¤ºæœ‰é€—å·,çš„é—®é¢˜ï¼Œæ’æŸ¥ä¸€ä¸‹--queryæ¡ä»¶å‘ç°æœ‰'{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}, {"content_id":1,"content_tags":1}'æœ‰ä¸€ä¸ªé€—å·, å»æ‰é€—å·,å’Œåé¢çš„é€—å·ä¹‹åçš„æ¡ä»¶å‘ç°æ‰§è¡ŒæˆåŠŸ1/usr/local/mongodb/bin/mongoexport --port 29001 --host=localhost -user=*** --password=***** --authenticationDatabase=**** --db=db --collection=collection --query='{"content_type_id":"28","update_time":{"$gte":1546272000000},"is_delete":0}' --type=csv --fields _id,content_id,content_tags --out=***.csv 1234567892019-05-17T13:41:33.068+0800 connected to: localhost:290012019-05-17T13:41:34.067+0800 feeds.content_medium_hismatch 02019-05-17T13:41:35.067+0800 feeds.content_medium_hismatch 02019-05-17T13:41:36.067+0800 feeds.content_medium_hismatch 02019-05-17T13:41:36.656+0800 feeds.content_medium_hismatch 188702019-05-17T13:41:36.656+0800 exported 18870 recordspublic-ops-mongodb2 seclogin # cat content_medium_hismatch.csv |wc -l18871public-ops-mongodb2 seclogin # å’Œå¼€å‘ç¡®è®¤ä¸€ä¸‹è¿™ä¸ªæ¡ä»¶èƒ½å¦å´æ‰ï¼Œå¼€å‘ç¡®è®¤å¯ä»¥å»æ‰ã€‚ æ€»ç»“mongoexportåœ¨æ‰§è¡Œæœ‰æ¡ä»¶çš„å¯¼å‡ºæ–‡ä»¶ï¼Œ--query æ¡ä»¶è¦å†™åœ¨ä¸€ä¸ªèŠ±æ‹¬å·{}é‡Œé¢ï¼Œå¦‚æœè¦æœ‰ä¸¤ä¸ªèŠ±æ‹¬å·{}çš„æ¡ä»¶ï¼Œä¸­é—´ç”¨é€—å·,åˆ†å‰²ï¼Œè¿™æ ·æ˜¯ä¸è¡Œçš„ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è¯¦ç»†çš„MySQLé«˜æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ€»ç»“]]></title>
    <url>%2F2019%2F05%2F16%2Fmysql-innodb%2F</url>
    <content type="text"><![CDATA[åŠªåŠ›ä¸ä¸€å®šæˆåŠŸï¼Œä½†æ˜¯ä¸åŠªåŠ›ä¼šå¾ˆèˆ’æœçš„å“¦! å‰è¨€MySQL å¯¹äºå¾ˆå¤š Linux ä»ä¸šè€…è€Œè¨€ï¼Œæ˜¯ä¸€ä¸ªéå¸¸æ£˜æ‰‹çš„é—®é¢˜ï¼Œå¤šæ•°æƒ…å†µéƒ½æ˜¯å› ä¸ºå¯¹æ•°æ®åº“å‡ºç°é—®é¢˜çš„æƒ…å†µå’Œå¤„ç†æ€è·¯ä¸æ¸…æ™°ã€‚ åœ¨è¿›è¡Œ MySQL çš„ä¼˜åŒ–ä¹‹å‰å¿…é¡»è¦äº†è§£çš„å°±æ˜¯ MySQL çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®© MySQL çš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚ ä¼˜åŒ– ä¼˜åŒ–çš„å“²å­¦ æ³¨ï¼šä¼˜åŒ–æœ‰é£é™©ï¼Œä¿®æ”¹éœ€è°¨æ…ã€‚ ä¼˜åŒ–å¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼š ä¼˜åŒ–ä¸æ€»æ˜¯å¯¹ä¸€ä¸ªå•çº¯çš„ç¯å¢ƒè¿›è¡Œï¼Œè¿˜å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„å·²æŠ•äº§çš„ç³»ç»Ÿã€‚ ä¼˜åŒ–æ‰‹æ®µæœ¬æ¥å°±æœ‰å¾ˆå¤§çš„é£é™©ï¼Œåªä¸è¿‡ä½ æ²¡èƒ½åŠ›æ„è¯†åˆ°å’Œé¢„è§åˆ°ã€‚ ä»»ä½•çš„æŠ€æœ¯å¯ä»¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œä½†å¿…ç„¶å­˜åœ¨å¸¦æ¥ä¸€ä¸ªé—®é¢˜çš„é£é™©ã€‚ å¯¹äºä¼˜åŒ–æ¥è¯´è§£å†³é—®é¢˜è€Œå¸¦æ¥çš„é—®é¢˜ï¼Œæ§åˆ¶åœ¨å¯æ¥å—çš„èŒƒå›´å†…æ‰æ˜¯æœ‰æˆæœã€‚ ä¿æŒç°çŠ¶æˆ–å‡ºç°æ›´å·®çš„æƒ…å†µéƒ½æ˜¯å¤±è´¥ã€‚ ä¼˜åŒ–çš„éœ€æ±‚ï¼š ç¨³å®šæ€§å’Œä¸šåŠ¡å¯æŒç»­æ€§ï¼Œé€šå¸¸æ¯”æ€§èƒ½æ›´é‡è¦ã€‚ ä¼˜åŒ–ä¸å¯é¿å…æ¶‰åŠåˆ°å˜æ›´ï¼Œå˜æ›´å°±æœ‰é£é™©ã€‚ ä¼˜åŒ–ä½¿æ€§èƒ½å˜å¥½ï¼Œç»´æŒå’Œå˜å·®æ˜¯ç­‰æ¦‚ç‡äº‹ä»¶ã€‚ åˆ‡è®°ä¼˜åŒ–ï¼Œåº”è¯¥æ˜¯å„éƒ¨é—¨ååŒï¼Œå…±åŒå‚ä¸çš„å·¥ä½œï¼Œä»»ä½•å•ä¸€éƒ¨é—¨éƒ½ä¸èƒ½å¯¹æ•°æ®åº“è¿›è¡Œä¼˜åŒ–ã€‚ æ‰€ä»¥ä¼˜åŒ–å·¥ä½œï¼Œæ˜¯ç”±ä¸šåŠ¡éœ€æ±‚é©±ä½¿çš„! ä¼˜åŒ–ç”±è°å‚ä¸?åœ¨è¿›è¡Œæ•°æ®åº“ä¼˜åŒ–æ—¶ï¼Œåº”ç”±æ•°æ®åº“ç®¡ç†å‘˜ã€ä¸šåŠ¡éƒ¨é—¨ä»£è¡¨ã€åº”ç”¨ç¨‹åºæ¶æ„å¸ˆã€åº”ç”¨ç¨‹åºè®¾è®¡äººå‘˜ã€åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€ç¡¬ä»¶åŠç³»ç»Ÿç®¡ç†å‘˜ã€å­˜å‚¨ç®¡ç†å‘˜ç­‰ï¼Œä¸šåŠ¡ç›¸å…³äººå‘˜å…±åŒå‚ä¸ã€‚ ä¼˜åŒ–æ€è·¯ä¼˜åŒ–ä»€ä¹ˆåœ¨æ•°æ®åº“ä¼˜åŒ–ä¸Šæœ‰ä¸¤ä¸ªä¸»è¦æ–¹é¢ï¼š å®‰å…¨ï¼šæ•°æ®å¯æŒç»­æ€§ã€‚ æ€§èƒ½ï¼šæ•°æ®çš„é«˜æ€§èƒ½è®¿é—®ã€‚ ä¼˜åŒ–çš„èŒƒå›´æœ‰å“ªäº›å­˜å‚¨ã€ä¸»æœºå’Œæ“ä½œç³»ç»Ÿæ–¹é¢ï¼š ä¸»æœºæ¶æ„ç¨³å®šæ€§ I/O è§„åˆ’åŠé…ç½® Swap äº¤æ¢åˆ†åŒº OS å†…æ ¸å‚æ•°å’Œç½‘ç»œé—®é¢˜ åº”ç”¨ç¨‹åºæ–¹é¢ï¼š åº”ç”¨ç¨‹åºç¨³å®šæ€§ SQL è¯­å¥æ€§èƒ½ ä¸²è¡Œè®¿é—®èµ„æº æ€§èƒ½æ¬ ä½³ä¼šè¯ç®¡ç† è¿™ä¸ªåº”ç”¨é€‚ä¸é€‚åˆç”¨ MySQL æ•°æ®åº“ä¼˜åŒ–æ–¹é¢ï¼š å†…å­˜ æ•°æ®åº“ç»“æ„(ç‰©ç†&é€»è¾‘) å®ä¾‹é…ç½® è¯´æ˜ï¼šä¸ç®¡æ˜¯è®¾è®¡ç³»ç»Ÿã€å®šä½é—®é¢˜è¿˜æ˜¯ä¼˜åŒ–ï¼Œéƒ½å¯ä»¥æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚ ä¼˜åŒ–ç»´åº¦ æ•°æ®åº“ä¼˜åŒ–ç»´åº¦æœ‰å¦‚ä¸‹å››ä¸ª: ç¡¬ä»¶ ç³»ç»Ÿé…ç½® æ•°æ®åº“è¡¨ç»“æ„ SQL åŠç´¢å¼• ä¼˜åŒ–é€‰æ‹©: ä¼˜åŒ–æˆæœ¬ï¼šç¡¬ä»¶>ç³»ç»Ÿé…ç½®>æ•°æ®åº“è¡¨ç»“æ„>SQL åŠç´¢å¼•ã€‚ ä¼˜åŒ–æ•ˆæœï¼šç¡¬ä»¶ç³»ç»Ÿ>åº”ç”¨>æ•°æ®åº“>æ¶æ„(é«˜å¯ç”¨ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨)ã€‚ å¤„ç†æ–¹å‘ï¼šæ˜ç¡®ä¼˜åŒ–ç›®æ ‡ã€æ€§èƒ½å’Œå®‰å…¨çš„æŠ˜ä¸­ã€é˜²æ‚£æœªç„¶ã€‚ ç¡¬ä»¶ä¼˜åŒ–ä¸»æœºæ–¹é¢æ ¹æ®æ•°æ®åº“ç±»å‹ï¼Œä¸»æœº CPU é€‰æ‹©ã€å†…å­˜å®¹é‡é€‰æ‹©ã€ç£ç›˜é€‰æ‹©ï¼š å¹³è¡¡å†…å­˜å’Œç£ç›˜èµ„æº éšæœºçš„ I/O å’Œé¡ºåºçš„ I/O ä¸»æœº RAID å¡çš„ BBU(Battery Backup Unit)å…³é—­ CPU çš„é€‰æ‹©CPU çš„ä¸¤ä¸ªå…³é”®å› ç´ ï¼šæ ¸æ•°ã€ä¸»é¢‘ã€‚æ ¹æ®ä¸åŒçš„ä¸šåŠ¡ç±»å‹è¿›è¡Œé€‰æ‹©ï¼š CPU å¯†é›†å‹ï¼šè®¡ç®—æ¯”è¾ƒå¤šï¼ŒOLTP ä¸»é¢‘å¾ˆé«˜çš„ CPUã€æ ¸æ•°è¿˜è¦å¤šã€‚ IO å¯†é›†å‹ï¼šæŸ¥è¯¢æ¯”è¾ƒï¼ŒOLAP æ ¸æ•°è¦å¤šï¼Œä¸»é¢‘ä¸ä¸€å®šé«˜çš„ã€‚ å†…å­˜çš„é€‰æ‹©OLAP ç±»å‹æ•°æ®åº“ï¼Œéœ€è¦æ›´å¤šå†…å­˜ï¼Œå’Œæ•°æ®è·å–é‡çº§æœ‰å…³ã€‚OLTP ç±»å‹æ•°æ®ä¸€èˆ¬å†…å­˜æ˜¯ CPU æ ¸å¿ƒæ•°é‡çš„ 2 å€åˆ° 4 å€ï¼Œæ²¡æœ‰æœ€ä½³å®è·µã€‚ å­˜å‚¨æ–¹é¢æ ¹æ®å­˜å‚¨æ•°æ®ç§ç±»çš„ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„å­˜å‚¨è®¾å¤‡ï¼Œé…ç½®åˆç†çš„ RAID çº§åˆ«(raid5ã€raid10ã€çƒ­å¤‡ç›˜)ã€‚ å¯¹äºæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œä¸éœ€è¦å¤ªç‰¹æ®Šçš„é€‰æ‹©ï¼Œæœ€å¥½åšå¥½å†—ä½™(raid1)(ssdã€sasã€sata)ã€‚ ä¸»æœº raid å¡é€‰æ‹©ï¼š å®ç°æ“ä½œç³»ç»Ÿç£ç›˜çš„å†—ä½™(raid1) å¹³è¡¡å†…å­˜å’Œç£ç›˜èµ„æº éšæœºçš„ I/O å’Œé¡ºåºçš„ I/O ä¸»æœº raid å¡çš„ BBU(Battery Backup Unit)è¦å…³é—­ ç½‘ç»œè®¾å¤‡æ–¹é¢ä½¿ç”¨æµé‡æ”¯æŒæ›´é«˜çš„ç½‘ç»œè®¾å¤‡(äº¤æ¢æœºã€è·¯ç”±å™¨ã€ç½‘çº¿ã€ç½‘å¡ã€HBA å¡)ã€‚æ³¨æ„ï¼šä»¥ä¸Šè¿™äº›è§„åˆ’åº”è¯¥åœ¨åˆå§‹è®¾è®¡ç³»ç»Ÿæ—¶å°±åº”è¯¥è€ƒè™‘å¥½ã€‚ æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–å…³é”®ç‚¹ï¼š ç‰©ç†çŠ¶æ€ç¯ è‡ªå¸¦ç®¡ç†è®¾å¤‡ï¼šè¿œç¨‹æ§åˆ¶å¡(FENCEè®¾å¤‡ï¼šipmi ilo idarc)ã€å¼€å…³æœºã€ç¡¬ä»¶ç›‘æ§ã€‚ ç¬¬ä¸‰æ–¹çš„ç›‘æ§è½¯ä»¶ã€è®¾å¤‡(snmpã€agent)å¯¹ç‰©ç†è®¾æ–½è¿›è¡Œç›‘æ§ã€‚ å­˜å‚¨è®¾å¤‡ï¼šè‡ªå¸¦çš„ç›‘æ§å¹³å°ã€‚EMC2(HP æ”¶è´­äº†)ã€ æ—¥ç«‹(HDS)ã€IBM ä½ç«¯ OEM HDSã€é«˜ç«¯å­˜å‚¨æ˜¯è‡ªå·±æŠ€æœ¯ï¼Œåä¸ºå­˜å‚¨ã€‚ ç³»ç»Ÿä¼˜åŒ–CPUï¼šåŸºæœ¬ä¸éœ€è¦è°ƒæ•´ï¼Œåœ¨ç¡¬ä»¶é€‰æ‹©æ–¹é¢ä¸‹åŠŸå¤«å³å¯ã€‚ å†…å­˜ï¼šåŸºæœ¬ä¸éœ€è¦è°ƒæ•´ï¼Œåœ¨ç¡¬ä»¶é€‰æ‹©æ–¹é¢ä¸‹åŠŸå¤«å³å¯ã€‚ SWAPï¼šMySQL å°½é‡é¿å…ä½¿ç”¨ Swapã€‚é˜¿é‡Œäº‘çš„æœåŠ¡å™¨ä¸­é»˜è®¤ swap ä¸º 0ã€‚ IO ï¼šraidã€no lvmã€ext4 æˆ– xfsã€ssdã€IO è°ƒåº¦ç­–ç•¥ã€‚ Swap è°ƒæ•´(ä¸ä½¿ç”¨ swap åˆ†åŒº)ï¼š1/proc/sys/vm/swappinessçš„å†…å®¹æ”¹æˆ0(ä¸´æ—¶)ï¼Œ/etc/sysctl. confä¸Šæ·»åŠ vm.swappiness=0(æ°¸ä¹…) è¿™ä¸ªå‚æ•°å†³å®šäº† Linux æ˜¯å€¾å‘äºä½¿ç”¨ Swapï¼Œè¿˜æ˜¯å€¾å‘äºé‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚åœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹ï¼Œæ•°å€¼è¶Šä½è¶Šå€¾å‘äºé‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚ å½“ç„¶ï¼Œè¿™ä¸ªå‚æ•°åªèƒ½å‡å°‘ä½¿ç”¨ Swap çš„æ¦‚ç‡ï¼Œå¹¶ä¸èƒ½é¿å… Linux ä½¿ç”¨ Swapã€‚ ä¿®æ”¹ MySQL çš„é…ç½®å‚æ•° innodb_flush_ methodï¼Œå¼€å¯ O_DIRECT æ¨¡å¼ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼ŒInnoDB çš„ buffer pool ä¼šç›´æ¥ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿ Cache æ¥è®¿é—®ç£ç›˜ï¼Œä½†æ˜¯ redo log ä¾æ—§ä¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ Cacheã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒRedo log æ˜¯è¦†å†™æ¨¡å¼çš„ï¼Œå³ä½¿ä½¿ç”¨äº†æ–‡ä»¶ç³»ç»Ÿçš„ Cacheï¼Œä¹Ÿä¸ä¼šå ç”¨å¤ªå¤šã€‚ IO è°ƒåº¦ç­–ç•¥ï¼š1#echo deadline>/sys/block/sda/queue/scheduler ä¸´æ—¶ä¿®æ”¹ä¸ºdeadline æ°¸ä¹…ä¿®æ”¹123vi /boot/grub/grub.conf æ›´æ”¹åˆ°å¦‚ä¸‹å†…å®¹: kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet ç³»ç»Ÿå‚æ•°è°ƒæ•´Linux ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ–12345vim/etc/sysctl.conf net.ipv4.ip_local_port_range = 1024 65535ï¼š# ç”¨æˆ·ç«¯å£èŒƒå›´ net.ipv4.tcp_max_syn_backlog = 4096 net.ipv4.tcp_fin_timeout = 30 fs.file-max=65535ï¼š# ç³»ç»Ÿæœ€å¤§æ–‡ä»¶å¥æŸ„ï¼Œæ§åˆ¶çš„æ˜¯èƒ½æ‰“å¼€æ–‡ä»¶æœ€å¤§æ•°é‡ ç”¨æˆ·é™åˆ¶å‚æ•°(MySQL å¯ä»¥ä¸è®¾ç½®ä»¥ä¸‹é…ç½®)ï¼š12345vim/etc/security/limits.conf * soft nproc 65535 * hard nproc 65535 * soft nofile 65535 * hard nofile 65535 åº”ç”¨ä¼˜åŒ–ä¸šåŠ¡åº”ç”¨å’Œæ•°æ®åº“åº”ç”¨ç‹¬ç«‹ã€‚ é˜²ç«å¢™ï¼šiptablesã€selinux ç­‰å…¶ä»–æ— ç”¨æœåŠ¡(å…³é—­)ï¼š123456789101112131415chkconfig --level 23456 acpid off chkconfig --level 23456 anacron off chkconfig --level 23456 autofs off chkconfig --level 23456 avahi-daemon off chkconfig --level 23456 bluetooth off chkconfig --level 23456 cups off chkconfig --level 23456 firstboot off chkconfig --level 23456 haldaemon off chkconfig --level 23456 hplip off chkconfig --level 23456 ip6tables off chkconfig --level 23456 iptables off chkconfig --level 23456 isdn off chkconfig --level 23456 pcscd off chkconfig --level 23456 sendmail off chkconfig --level 23456 yum-updatesd off å®‰è£…å›¾å½¢ç•Œé¢çš„æœåŠ¡å™¨ä¸è¦å¯åŠ¨å›¾å½¢ç•Œé¢ runlevel 3ã€‚ å¦å¤–ï¼Œæ€è€ƒå°†æ¥æˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯å¦çœŸçš„éœ€è¦ MySQLï¼Œè¿˜æ˜¯ä½¿ç”¨å…¶ä»–ç§ç±»çš„æ•°æ®åº“ã€‚ç”¨æ•°æ®åº“çš„æœ€é«˜å¢ƒç•Œå°±æ˜¯ä¸ç”¨æ•°æ®åº“ã€‚ æ•°æ®åº“ä¼˜åŒ–SQL ä¼˜åŒ–æ–¹å‘ï¼š æ‰§è¡Œè®¡åˆ’ ç´¢å¼• SQL æ”¹å†™ æ¶æ„ä¼˜åŒ–æ–¹å‘ï¼š é«˜å¯ç”¨æ¶æ„ é«˜æ€§èƒ½æ¶æ„ åˆ†åº“åˆ†è¡¨ æ•°æ®åº“å‚æ•°ä¼˜åŒ–è°ƒæ•´å®ä¾‹æ•´ä½“(é«˜çº§ä¼˜åŒ–ï¼Œæ‰©å±•)ï¼š123456thread_concurrencyï¼š# å¹¶å‘çº¿ç¨‹æ•°é‡ä¸ªæ•° sort_buffer_sizeï¼š# æ’åºç¼“å­˜ read_buffer_sizeï¼š# é¡ºåºè¯»å–ç¼“å­˜ read_rnd_buffer_sizeï¼š# éšæœºè¯»å–ç¼“å­˜ key_buffer_sizeï¼š# ç´¢å¼•ç¼“å­˜ thread_cache_sizeï¼š# (1Gâ€”>8, 2Gâ€”>16, 3Gâ€”>32, >3Gâ€”>64) è¿æ¥å±‚(åŸºç¡€ä¼˜åŒ–)è®¾ç½®åˆç†çš„è¿æ¥å®¢æˆ·å’Œè¿æ¥æ–¹å¼ï¼š123456789101112131415161718192021222324252627282930max_connections # æœ€å¤§è¿æ¥æ•°ï¼Œçœ‹äº¤æ˜“ç¬”æ•°è®¾ç½® max_connect_errors # æœ€å¤§é”™è¯¯è¿æ¥æ•°ï¼Œèƒ½å¤§åˆ™å¤§ connect_timeout # è¿æ¥è¶…æ—¶ max_user_connections # æœ€å¤§ç”¨æˆ·è¿æ¥æ•° skip-name-resolve # è·³è¿‡åŸŸåè§£æ wait_timeout # ç­‰å¾…è¶…æ—¶ back_log # å¯ä»¥åœ¨å †æ ˆä¸­çš„è¿æ¥æ•°é‡ ``` ##### SQL å±‚(åŸºç¡€ä¼˜åŒ–)query_cache_sizeï¼š æŸ¥è¯¢ç¼“å­˜ >>> OLAP ç±»å‹æ•°æ®åº“ï¼Œéœ€è¦é‡ç‚¹åŠ å¤§æ­¤å†…å­˜ç¼“å­˜ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ä¼šè¶…è¿‡ GBã€‚å¯¹äºç»å¸¸è¢«ä¿®æ”¹çš„æ•°æ®ï¼Œç¼“å­˜ä¼šé©¬ä¸Šå¤±æ•ˆã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…å­˜æ•°æ®åº“(redisã€memecache)ï¼Œæ›¿ä»£å®ƒçš„åŠŸèƒ½ã€‚##### å­˜å‚¨å¼•æ“å±‚ä¼˜åŒ–innodb åŸºç¡€ä¼˜åŒ–å‚æ•°ï¼š```bashdefault-storage-engine innodb_buffer_pool_size # æ²¡æœ‰å›ºå®šå¤§å°ï¼Œ50%æµ‹è¯•å€¼ï¼Œçœ‹çœ‹æƒ…å†µå†å¾®è°ƒã€‚ä½†æ˜¯å°½é‡è®¾ç½®ä¸è¦è¶…è¿‡ç‰©ç†å†…å­˜70% innodb_file_per_table=(1,0) innodb_flush_log_at_trx_commit=(0,1,2) # 1æ˜¯æœ€å®‰å…¨çš„ï¼Œ0æ˜¯æ€§èƒ½æœ€é«˜ï¼Œ2æŠ˜ä¸­ binlog_sync Innodb_flush_method=(O_DIRECT, fdatasync) innodb_log_buffer_size # 100Mä»¥ä¸‹ innodb_log_file_size # 100M ä»¥ä¸‹ innodb_log_files_in_group # 5ä¸ªæˆå‘˜ä»¥ä¸‹,ä¸€èˆ¬2-3ä¸ªå¤Ÿç”¨ï¼ˆiblogfile0-Nï¼‰ innodb_max_dirty_pages_pct # è¾¾åˆ°ç™¾åˆ†ä¹‹75çš„æ—¶å€™åˆ·å†™ å†…å­˜è„é¡µåˆ°ç£ç›˜ã€‚ log_bin max_binlog_cache_size # å¯ä»¥ä¸è®¾ç½® max_binlog_size # å¯ä»¥ä¸è®¾ç½® innodb_additional_mem_pool_size #å°äº2Gå†…å­˜çš„æœºå™¨ï¼Œæ¨èå€¼æ˜¯20Mã€‚32Gå†…å­˜ä»¥ä¸Š100M å‚è€ƒæ–‡ç« 51CTOä¼ åª’: ä¸€ä»½è¶…è¯¦ç»†çš„MySQLé«˜æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ€»ç»“ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[pt-table-checksum fails on older MySQL without utf8mb4-support]]></title>
    <url>%2F2019%2F05%2F14%2FPT-0%2F</url>
    <content type="text"><![CDATA[â€œåˆ«å†æŠ±æ€¨ä½ æ­¤ç”Ÿæ‰¾ä¸åˆ°ä¸€ä¸ªå¯¹çš„äººï¼Œå½“åˆçš„æ•°å­¦é€‰æ‹©é¢˜å°±å››ä¸ªï¼Œä½ ä¹Ÿæ‰¾ä¸åˆ°å¯¹çš„ç­”æ¡ˆå•Šâ€ å‰è¨€æ˜¨å¤©å¸®åŒäº‹è§£å†³ä¸»ä»åŒæ­¥çš„é—®é¢˜ã€‚ åŸå› æ˜¯åŒäº‹ä½¿ç”¨Djangoå¼€å‘äº†ä¸€å¥—è¿ç»´å¹³å°ã€‚ä½†æ˜¯é‡Œé¢çš„è¡¨ä½¿ç”¨äº†FOREIGN KEYï¼Œåœ¨æ’å…¥çš„æ˜¯æŠ¥é”™ã€‚é€ æˆäº†ä¸»ä»åŒæ­¥é”™è¯¯ï¼Œæ•°æ®é‡ä¸å¤§ï¼Œä½¿ç”¨pt-table-checksumæ¥æ ¡éªŒä¸»ä»æ•°æ® æ“ä½œä¸€ã€å…ˆè·³è¿‡ä¸»ä»é”™è¯¯ï¼Œä¸»ä»åŒæ­¥å…³ç³»æ¢å¤æ­£å¸¸ã€‚1234STOP SLAVE sql_thread;SET GLOBAL sql_slave_skip_counter = 1;START SLAVE sql_thread;SHOW SLAVE STATUS\G äºŒã€ä½¿ç”¨ pt-table-checksum1pt-table-checksum --set-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password='*****' --recursion-method='processlist' 12345678910111213Error setting innodb_lock_wait_timeout: DBD::mysql::db do failed: Variable 'innodb_lock_wait_timeout' is a read only variable [for Statement "SET SESSION innodb_lock_wait_timeout=1"]. The current value for innodb_lock_wait_timeout is 50. If the variable is read only (not dynamic), specify --set-vars innodb_lock_wait_timeout=50 to avoid this warning, else manually set the variable and restart MySQL.Checking if all tables can be checksummed ...Starting checksum ...Error setting innodb_lock_wait_timeout: DBD::mysql::db do failed: Variable 'innodb_lock_wait_timeout' is a read only variable [for Statement "SET SESSION innodb_lock_wait_timeout=1"]. The current value for innodb_lock_wait_timeout is 50. If the variable is read only (not dynamic), specify --set-vars innodb_lock_wait_timeout=50 to avoid this warning, else manually set the variable and restart MySQL.05-13T18:42:19 Error executing EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/: DBD::mysql::st execute failed: Unknown character set: 'utf8mb4' [for Statement "EXPLAIN SELECT COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*explain checksum table*/"] at /usr/bin/pt-table-checksum line 12302.05-13T18:42:19 Error checksumming table bportal.server_basic_info: Error executing checksum query: DBD::mysql::st execute failed: Unknown character set: 'utf8mb4' [for Statement "REPLACE INTO `test`.`checksums` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT ?, ?, ?, ?, ?, ?, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS('#', `id`, convert(`uuid` using utf8mb4), convert(`city` using utf8mb4), convert(`bassert` using utf8mb4), convert(`hostname` using utf8mb4), `idc_id`, `dp_id`, convert(`vlanip` using utf8mb4), convert(`wlanip` using utf8mb4), convert(`remote_ip` using utf8mb4), convert(`network_card` using utf8mb4), convert(`mac` using utf8mb4), convert(`serverown` using utf8mb4), convert(`status` using utf8mb4), convert(`rack` using utf8mb4), convert(`unit` using utf8mb4), convert(`sysversion` using utf8mb4), `order_time`, convert(`comment` using utf8mb4), `update_time`, `onlinetime`, `offlinetime`, convert(`roles` using utf8mb4), convert(`services` using utf8mb4), convert(`install_status` using utf8mb4), convert(`service_env` using utf8mb4), convert(`host_type` using utf8mb4), convert(`kvm_local` using utf8mb4), CONCAT(ISNULL(`order_time`), ISNULL(`onlinetime`), ISNULL(`offlinetime`), ISNULL(`roles`), ISNULL(`services`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `bportal`.`server_basic_info` /*checksum table*/" with ParamValues: 0='bportal', 1='server_basic_info', 2=1, 3=undef, 4=undef, 5=undef] at /usr/bin/pt-table-checksum line 11691. TS ERRORS DIFFS ROWS DIFF_ROWS CHUNKS SKIPPED TIME TABLE05-13T18:42:19 2 0 0 0 1 0 0.008 bportal.server_basic_info äºæ˜¯æ’é™¤é—®é¢˜ï¼š æŸ¥çœ‹MySQL ç‰ˆæœ¬ æŸ¥çœ‹MySQL å­—ç¬¦é›† æŸ¥çœ‹æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†googleæŸ¥æ‰¾é—®é¢˜åŸå› å‘ç°ç¯‡æ–‡ç« å’Œè¯¥é”™è¯¯å‡ ä¹ä¸€è‡´ã€‚è¯´åˆ°pt-table-checksumå·²ç»ä¸æ”¯æŒMySQL 5.1ç‰ˆæœ¬ã€‚12345Thank you for the report.The error is expected since character set utf8mb4 Unknown to the MySQL 5.1MySQL 5.1 is not a supported version: https://www.percona.com/services/support/mysql-support/percona-toolkit-supported-platforms-and-versions å†™äº†ä¸€ä¸ªpatch pt-table-checksumæ‰“è¡¥ä¸1patch pt-table-checksum < pt-table-checksum.utf8mb4.patch æ‰§è¡Œå‘½ä»¤1pt-table-checksum --set-vars innodb_lock_wait_timeout=200 --nocheck-replication-filters --no-check-binlog-format --replicate=test.checksums --create-replicate-table --databases=***** --host=*** --port=*** --user=*** --password='*****' --recursion-method='processlist' å‘ç°æ²¡æœ‰ä¸Šé¢çš„é—®é¢˜ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸ã€‚åœ¨æ‰§è¡Œ1pt-table-sync --replicate=test.checksums --databases=***** --charset=utf8 h=****,P=****,u=****,p='****' --execute æ€»ç»“ä½¿ç”¨MySQL 5.1ç‰ˆæœ¬çš„æ•°æ®åº“èµ¶å¿«å‡çº§å§ã€‚å¤ªæŠ˜è…¾äººäº†ã€‚ å‚è€ƒ Percona: jira document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Toolkit</category>
      </categories>
      <tags>
        <tag>Toolkit</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å›¾è§£Goçš„channelåº•å±‚åŸç†]]></title>
    <url>%2F2019%2F05%2F05%2Fgo-channal-graphic%2F</url>
    <content type="text"><![CDATA[åŠªåŠ›ä¸ä¸€å®šæˆåŠŸï¼Œä½†æ˜¯ä¸åŠªåŠ›ä¼šå¾ˆèˆ’æœçš„å“¦! å‰è¨€channelçš„æ•´ä½“ç»“æ„å›¾ ç®€å•è¯´æ˜ï¼š bufæ˜¯æœ‰ç¼“å†²çš„channelæ‰€ç‰¹æœ‰çš„ç»“æ„ï¼Œç”¨æ¥å­˜å‚¨ç¼“å­˜æ•°æ®ã€‚æ˜¯ä¸ªå¾ªç¯é“¾è¡¨ sendxå’Œrecvxç”¨äºè®°å½•bufè¿™ä¸ªå¾ªç¯é“¾è¡¨ä¸­çš„~å‘é€æˆ–è€…æ¥æ”¶çš„~index lockæ˜¯ä¸ªäº’æ–¥é”ã€‚ recvqå’Œsendqåˆ†åˆ«æ˜¯æ¥æ”¶(]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æœ€å…¨Oracle DBAæ—¥å¸¸ç»´æŠ¤SQLè„šæœ¬å‘½ä»¤]]></title>
    <url>%2F2019%2F04%2F26%2Foracle-ops-sql%2F</url>
    <content type="text"><![CDATA[â€œåŸè°…ä»–ä»¬æ˜¯ä¸Šå¸çš„äº‹ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯è´Ÿè´£é€ä»–ä»¬è§ä¸Šå¸ã€‚â€ SQL è¯­å¥æŸ¥è¯¢ç¢ç‰‡ç¨‹åº¦é«˜ï¼ˆå®é™…ä½¿ç”¨ç‡å°äº30%ï¼‰çš„è¡¨å¯ä»¥æ”¶ç¼©çš„è¡¨æ¡ä»¶ä¸ºä»€ä¹ˆblock>100ï¼Œå› ä¸ºä¸€äº›å¾ˆå°çš„è¡¨ï¼Œåªæœ‰å‡ è¡Œæ•°æ®å®é™…å¤§å°å¾ˆå°ï¼Œä½†æ˜¯blockä¸€æ¬¡æ€§åˆ†é…å°±æ˜¯5ä¸ªï¼ˆ11gå¼€å§‹é»˜è®¤ä¸€æ¬¡æ€§åˆ†é…1Mçš„blockå¤§å°äº†ï¼Œè§create table storgedçš„NEXTå‚æ•°ï¼‰ï¼Œ5ä¸ªblockç›¸å¯¹äºå‡ è¡Œå°è¡¨æ•°æ®æ¥è¯´å°±ç›¸å·®å¤ªå¤§äº†ã€‚ ç®—æ³•ä¸­/0.9æ˜¯å› ä¸ºå—çš„pfreeä¸€èˆ¬ä¸º10%ï¼Œæ‰€ä»¥ä¸€ä¸ªå—æœ€å¤šåªç”¨äº†90%ï¼Œè€Œä¸”ä¸€è¡Œæ•°æ®å¤§äº8KBæ—¶å®¹æ˜“äº§ç”Ÿè¡Œé“¾æ¥ï¼ŒæŠŠä¸€è¡Œåˆ†ç‰‡å­˜å‚¨ï¼Œä¸€æ ·çš„ä¸€ä¸ªå—è¿90%éƒ½ç”¨ä¸æ»¡ ï¼ŒAVG_ROW_LENè¿˜æ˜¯æ¯”è¾ƒå‡†çš„ï¼Œæ¯”å¦‚ä¸ªäººå®éªŒæƒ…å†µä¸€è¡¨6ä¸ªå­—æ®µï¼Œä¸€ä¸ªnumberï¼Œå…¶ä»–5ä¸ªéƒ½æ˜¯char(100)ä½†æ˜¯å®é™…æ•°æ®éƒ½æ˜¯â€™1111111â€™7ä½ï¼ŒAVG_ROW_LENæ˜¾ç¤ºä¾ç„¶ä¸º513 ã€‚123456789SELECT TABLE_NAME, (BLOCKS * 8192/1024/1024) "ç†è®ºå¤§å°M", (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9) "å®é™…å¤§å°M", ROUND((NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024), 3) * 100|| '%' "å®é™…ä½¿ç”¨ç‡%"FROM USER_TABLESWHERE blocks > 100 AND (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) < 0.3ORDER BY (NUM_ROWS * AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS * 8192/1024/1024) DESC æŸ¥è¯¢ç´¢å¼•ç¢ç‰‡çš„æ¯”ä¾‹ç´¢å¼•åˆ é™¤è¡Œæ•°é™¤ä»¥ç´¢å¼•æ€»è¡Œæ•°çš„ç™¾åˆ†æ¯”>30%å³è®¤ä¸ºç´¢å¼•ç¢ç‰‡å¤§ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é‡å»ºçš„ç´¢å¼•12345678910SELECT name, del_lf_rows, lf_rows, ROUND(del_lf_rows/decode(lf_rows, 0, 1, lf_rows) * 100, 0)||'%' frag_pctFROM index_statsWHERE ROUND(del_lf_rows/decode(lf_rows, 0, 1, lf_rows) * 100,0) > 30; é›†ç¾¤å› å­clustering_factoré«˜çš„è¡¨é›†ç¾¤å› å­è¶Šæ¥è¿‘å—æ•°è¶Šå¥½ï¼Œæ¥è¿‘è¡Œæ•°åˆ™è¯´æ˜ç´¢å¼•åˆ—çš„åˆ—å€¼ç›¸ç­‰çš„è¡Œåˆ†å¸ƒæåº¦æ•£åˆ—ï¼Œå¯èƒ½ä¸èµ°ç´¢å¼•æ‰«æè€Œèµ°å…¨è¡¨æ‰«æ ï¼š æ–¹æ³•ä¸€ï¼š1234567891011121314151617SELECT tab.table_name, tab.blocks, tab.num_rows, ind.index_name, ind.clustering_factor, ROUND(nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows), 3) * 100||'%' "é›†ç¾¤å› å­æ¥è¿‘è¡Œæ•°"FROM user_tables tab, user_indexes indWHERE tab.table_name = ind.table_name AND tab.blocks>100 AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows) BETWEEN 0.35 AND 3 æ–¹æ³•äºŒï¼š12345678910111213141516171819SELECT tab.owner, tab.table_name, tab.blocks, tab.num_rows, ind.index_name, ind.clustering_factor, round(nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows), 3)*100||'%' "é›†ç¾¤å› å­æ¥è¿‘è¡Œæ•°"FROM dba_tables tab, dba_indexes indWHERE tab.table_name=ind.table_name AND tab.owner NOT IN ('SYS', 'SYSTEM', 'WMSYS', 'DBSNMP', 'CTXSYS', 'XDB', 'ORDDATA', 'SYSMAN', 'CATALOG', 'APEX_030200', 'MDSYS', 'OLAPSYS', 'EXFSYS') AND tab.blocks > 100 AND nvl(ind.clustering_factor, 1)/decode(tab.num_rows, 0, 1, tab.num_rows) BETWEEN 0.35 AND 3 æ ¹æ®sidæŸ¥spidæˆ–æ ¹æ®spidæŸ¥sid1234567891011121314151617SELECT s.sid, s.serial#, p.spid, s.terminal, s.LOGON_TIME, s.status, s.PROGRAM, s.CLIENT_IDENTIFIER, s.machine, s.action, s.MODULE, s.PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", s.osuserFROM v$session s, v$process pWHERE s.paddr=p.addr AND s.sid=XX OR p.spid=YY æ ¹æ®sidæŸ¥çœ‹å…·ä½“çš„sqlè¯­å¥ï¼Œä¸è¦åŠ æ¡ä»¶v$session.status='ACTIVE'ï¼Œæ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select * from v$sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v$session.statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯select * from v$sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚ä¸€ä¸ªsidå¯èƒ½æ‰§è¡Œè¿‡å¾ˆå¤šä¸ªsqlï¼Œæ‰€ä»¥æœ‰æ—¶éœ€è¦çš„sqlé€šè¿‡å¦‚ä¸‹æŸ¥ä¸åˆ°æ˜¯æ­£å¸¸çš„ï¼Œæ¯”å¦‚æŸ¥è¯¢åˆ°æŸæ­»é”æºsidï¼Œé€šè¿‡å¦‚ä¸‹æŸ¥è¯¢å¯èƒ½åªæ˜¯ä¸ªselectè¯­å¥ï¼Œè€ŒçœŸæ­£å¼•èµ·æ­»é”çš„sqlå´æŸ¥ä¸åˆ°ï¼Œæ˜¯å› ä¸ºå¯èƒ½è¿™ä¸ªsidæŒç»­äº†å¾ˆé•¿æ—¶é—´ï¼Œè¿™ä¸ªsidä¹‹å‰æ‰§è¡Œçš„ä¸€äº›sqlåœ¨v$sqlå¯èƒ½å·²ç»è¢«æ¸…é™¤äº†ã€‚ æ–¹æ³•ä¸€ï¼š12345678910111213141516171819202122232425262728293031323334SELECT username, sid, SERIAL#, LOGON_TIME, status, PROGRAM, CLIENT_IDENTIFIER, machine, action, PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", osuser, sql_textFROM v$session a, v$sqltext_with_newlines bWHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value AND a.sid=&sidORDER BY piece; ``` ##### æ–¹æ³•äºŒ:```bashSELECT username, sid, SERIAL#, LOGON_TIME, status, sql_fulltext, PROGRAM, CLIENT_IDENTIFIER, machine, a.action, PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", osuserFROM v$session a, v$sql bWHERE DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) = b.hash_value AND a.sid=&sid å¦‚æœä¸Šé¢è¯­å¥æ‰§è¡Œå¤ªæ…¢ï¼Œåˆ™æŒ‰å¦‚ä¸‹ä¸¤æ­¥12345678910111213141516SELECT sql_hash_value, prev_hash_value, username, sid.SERIAL#, LOGON_TIME, status, PROGRAM, CLIENT_IDENTIFIER, machine, action, PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", osuserFROM v$sessionWHERE sid=&sidSELECT sql_fulltextFROM v$sqlWHERE hash_value=XX XXä¸ºä¸Šé¢ sql_hash_valueï¼Œå¦‚æœ sql_hash_valueä¸º0ï¼Œåˆ™XXä¸ºä¸Šé¢ prev_hash_value æ ¹æ®spidæŸ¥è¯¢å…·ä½“çš„sqlè¯­å¥(ä¸è¦åŠ æ¡ä»¶v$session.status=â€™ ACTIVEâ€™,æ¯”å¦‚toadå¯¹åŒä¸€æ•°æ®åº“å¼€ä¸¤ä¸ªè¿æ¥ä¼šè¯ï¼Œéƒ½æ‰§è¡Œäº†ä¸€äº›è¯­å¥ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£æŸ¥è¯¢select from v$sessionæ—¶ä¼šå‘ç°å¦ä¸€ä¸ªçª—å£åœ¨v$session.statusæ˜¯INACTIVEï¼Œå¹¶ä¸ä»£è¡¨å¦ä¸€ä¸ªçª—å£æ²¡æœ‰æ‰§è¡Œè¿‡sqlè¯­å¥ï¼Œè€Œå½“å‰çª—å£æ˜¯activeçŠ¶æ€ï¼Œå¯¹åº”çš„sql_idå¯¹åº”çš„è¯­å¥å°±æ˜¯select from v$sessionè€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼ŒACTIVEè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œsqlã€‚)123456789101112131415161718192021SELECT ss.SID, ss.SERIAL#, ss.LOGON_TIME, pr.SPID, sa.SQL_FULLTEXT, ss.machine, ss.TERMINAL, ss.PROGRAM, ss.USERNAME, ss.CLIENT_IDENTIFIER, ss.action, ss.PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", ss.STATUS, ss.OSUSER, ss.status, ss.last_call_et, sa.sql_textFROM v$process pr, v$session ss, v$sql saWHERE pr.ADDR = ss.PADDR AND DECODE(ss.sql_hash_value, 0, prev_hash_value, sql_hash_value)=sa.hash_value AND pr.spid=&spid æŸ¥çœ‹å†å²session_idçš„SQLæ¥è‡ªå“ªä¸ªIPæŸ¥çœ‹traceæ–‡ä»¶åå°±å¯ä»¥çŸ¥é“spid,traceæ–‡ä»¶é‡Œé¢æœ‰sidå’Œå…·ä½“sqlï¼Œå¦‚æœtraceå­˜åœ¨incidentï¼Œé‚£traceå°±çœ‹ä¸åˆ°å…·ä½“sqlï¼Œä½†æ˜¯å¯ä»¥åœ¨incidentæ–‡ä»¶ä¸­çœ‹åˆ°å…·ä½“çš„sqlï¼Œå¦‚DW_ora_17751.trcä¸­17751å°±æ˜¯spidï¼Œé‡Œé¢æœ‰è¿™æ ·çš„å†…å®¹Incident 115 created, dump file: /XX/incident/incdir_115/DW_ora_17751_i115.trcï¼Œé‚£ä¹ˆåœ¨DW_ora_17751_i115.trcå°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„sqlè¯­å¥) DB_ora_29349.trcä¸­å‡ºç°1*** SESSION ID:(5057.12807) 2016-10-26 14:45:52.726 é€šè¿‡è¡¨V$ACTIVE_SESSION_HISTORYæ¥æŸ¥123456SELECT a.sql_id, a.machine, a.*FROM V$ACTIVE_SESSION_HISTORY aWHERE a.session_id=5057 AND a.SESSION_SERIAL#=12807 æŸ¥è¯¢ä¸Šé¢çš„machineçš„IP123456789SELECT s.sid, s.serial#, s.LOGON_TIME, s.machine, p.spid, p.terminalFROM v$session s, v$process pWHERE s.paddr=p.addr AND s.machine='localhost' é€šè¿‡ä¸Šé¢çš„spidåœ¨oracleæœåŠ¡å™¨ä¸Šæ‰§è¡Œnetstat -anp |grep spidå³å¯123[oracle@dwdb trace]$ netstat -anp |grep 17630 tcp 210 0 192.168.64.228:11095 192.168.21.16:1521 ESTABLISHED 17630/oracleDB tcp 0 0 ::ffff:192.168.64.228:1521 ::ffff:192.168.64.220:59848 ESTABLISHED 17630/oracleDB å‡ºç°ä¸¤ä¸ªï¼Œè¯´æ˜æ¥è‡ª220ï¼Œè¿æ¥äº†228æ•°æ®åº“æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆé€šè¿‡228æœåŠ¡å™¨çš„dblinkå»è¿æ¥äº†16æœåŠ¡å™¨ æŸ¥è¯¢æ­»é”å µå¡çš„ä¼šè¯sidæœ€ç®€å•çš„ä¸€ä¸ªSQL1234select * from V$SESSION_BLOCKERS select * from dba_waiters æœ€å¸¸ç”¨çš„ä¸€ä¸ªSQL12345678910111213SELECT sid, status, LOGON_TIME, sql_id, blocking_session "æ­»é”ç›´æ¥æº", FINAL_BLOCKING_SESSION "æ­»é”æœ€ç»ˆæº", event, seconds_in_wait "ä¼šè¯é”ä½æ—¶é—´_S", LAST_CALL_ET "ä¼šè¯STATUSæŒç»­æ—¶é—´_S"FROM v$sessionWHERE state='WAITING' AND BLOCKING_SESSION_STATUS='VALID' AND FINAL_BLOCKING_SESSION_STATUS='VALID' å¯ä»¥æŠŠä¸¤è€…SIDæ”¾å…¥v$sessionï¼Œå‘ç°LOGON_TIMEå­—æ®µFINAL_BLOCKING_SESSIONæ¯”SIDè¦æ—© BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if BLOCKING_SESSION_STATUS has the value VALID. FINAL_BLOCKING_SESSION:Session identifier of the blocking session. This column is valid only if FINAL_BLOCKING_SESSION_STATUS has the value VALID. å¦‚æœé‡åˆ°RACç¯å¢ƒï¼Œä¸€å®šè¦ç”¨gv$æ¥æŸ¥ï¼Œå¹¶ä¸”æ‰§è¡Œalter system kill session 'sid,serial#'è¦åˆ°RACå¯¹åº”çš„å®ä¾‹ä¸Šå»æ‰§è¡Œ æŠŠä¸Šé¢è¢«å µå¡ä¼šè¯çš„sidä»£å…¥å¦‚ä¸‹è¯­å¥ï¼Œå¯ä»¥å‘ç°é”ä½çš„å¯¹è±¡å’Œå¯¹è±¡çš„å“ªä¸€è¡Œ(å¦‚æœsidæ˜¯å µå¡æºçš„ä¼šè¯ï¼Œåˆ™ row_wait_obj#=-1ï¼Œè¡¨ç¤ºé”æŒæœ‰è€…ï¼Œå°±æ˜¯æ­»é”æºäº† )1234567891011SELECT s.sid, s.username, d.owner, d.object_name, s.row_wait_obj#, s.row_wait_row#, s.row_wait_file#, s.row_wait_block#FROM v$session s, dba_objects dWHERE s.row_wait_obj# = d.object_id AND s.sid in(XX,XX) æŸ¥è¯¢é”ä½çš„DDLå¯¹è±¡123456SELECT d.session_id, s.SERIAL#, d.nameFROM dba_ddl_locks d, v$session sWHERE d.owner = 'MKLMIGEM' AND d.SESSION_ID=s.sid æŸ¥è¯¢è¶…è¿‡ä¸¤ä¸ªå°æ—¶çš„ä¸æ´»åŠ¨ä¼šè¯12345678910111213141516171819202122SELECT s.sid, s.serial#, p.spid, s.LOGON_TIME, s.LAST_CALL_ET, s.status, s.PROGRAM, s.CLIENT_IDENTIFIER, s.machine, s.terminal, s.action, s.PROCESS "å®¢æˆ·ç«¯æœºå™¨è¿›ç¨‹å·", s.osuserFROM v$session s, v$process pWHERE s.paddr=p.addr AND s.sid IN (SELECT sid FROM v$session WHERE machine &DBæœåŠ¡å™¨åç§° AND status='INACTIVE' AND sql_id is null AND LAST_CALL_ET > 7200 ) æŸ¥è¯¢å µå¡åˆ«çš„ä¼šè¯è¶…è¿‡30åˆ†é’Ÿä¸”è‡ªèº«æ˜¯ä¸æ´»åŠ¨çš„ä¼šè¯12345678910111213141516SELECT username, sid, serial#, status, seconds_in_wait, LAST_CALL_ETFROM v$sessionWHERE sid IN (SELECT FINAL_BLOCKING_SESSION FROM v$session WHERE state='WAITING' AND BLOCKING_SESSION_STATUS='VALID' AND FINAL_BLOCKING_SESSION_STATUS='VALID') AND status='INACTIVE' AND sql_id is null AND seconds_in_wait>1800 æŸ¥è¯¢å¯èƒ½å­˜åœ¨è¿æ¥æ± ç©ºé—²åˆå§‹é…ç½®è¿‡å¤§çš„è¿æ¥ï¼ˆæ¥è‡ªåŒä¸€å°æœºå™¨çš„åŒä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ä¸ºINACTIVEçš„è¿æ¥éå¸¸å¤šï¼‰12345678910SELECT count(ss.SID), ss.machine, ss.status, ss.TERMINAL, ss.PROGRAM, ss.USERNAME, ss.CLIENT_IDENTIFIERFROM v$session ssGROUP BY ss.machine,ss.status,ss.TERMINAL,ss.PROGRAM,ss.USERNAME,ss.CLIENT_IDENTIFIERHAVING count(ss.SID)>10 æŸ¥è¯¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„sql1234567891011121314SELECT s.sid, s.serial#, s.username, spid, v$sql.sql_id, machine, s.terminal, s.program, sql_textFROM v$process,v$session s,v$sqlWHERE addr=paddr AND s.sql_id=v$sql.sql_id AND sql_hash_value=hash_value AND s.STATUS='ACTIVE' æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„SCHEDULER_JOB123456789SELECT owner, job_name, sid, b.SERIAL#, b.username, spidFROM ALL_SCHEDULER_RUNNING_JOBS,v$session b,v$processWHERE session_id=sid AND paddr=addr æŸ¥è¯¢æ­£åœ¨æ‰§è¡Œçš„dbms_job12345678SELECT job, b.sid, b.SERIAL#, b.username, spidFROM DBA_JOBS_RUNNING a ,v$session b,v$processWHERE a.sid=b.sid AND paddr=addr æŸ¥è¯¢ä¸€ä¸ªä¼šè¯sessionã€processå¹³å‡æ¶ˆè€—å¤šå°‘PGAå†…å­˜ï¼ŒæŸ¥çœ‹ä¸‹é¢avg_used_Må€¼123456789SELECT round(sum(pga_used_mem)/1024/1024, 0) total_used_M, round(sum(pga_used_mem)/count(1)/1024/1024, 0) avg_used_M, round(sum(pga_alloc_mem)/1024/1024, 0) total_alloc_M, round(sum(pga_alloc_mem)/count(1)/1024/1024, 0) avg_alloc_MFROM v$process; TOP 10 æ‰§è¡Œæ¬¡æ•°æ’åº1234567891011SELECT *FROM (SELECT executions, username, PARSING_USER_ID, sql_id, sql_text FROM v$sql,dba_users WHERE user_id=PARSING_USER_ID ORDER BY executions desc)WHERE rownum sysdate-18 AND FIRST_TIME>ADD_MONTHS(SYSDATE,-1) ORDER BY FIRST_TIME)GROUP BY TO_CHAR(first_time, 'MM/DD')ORDER BY MIN(RN); æŸ¥è¯¢lgwrè¿›ç¨‹å†™æ—¥å¿—æ—¶æ¯æ‰§è¡Œä¸€æ¬¡lgwréœ€è¦å¤šå°‘ç§’ï¼Œåœ¨stateæ˜¯waitingçš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç­‰å¾…ç¼–å·seq#ä¸‹ï¼Œseconds_in_waitè¾¾å¤šå°‘ç§’ï¼Œå°±æ˜¯lgwrè¿›ç¨‹å†™ä¸€æ¬¡IOéœ€è¦å¤šå°‘ç§’12345678SELECT event, state, seq#, seconds_in_wait, programFROM v$sessionWHERE program LIKE '%LGWR%' AND state='WAITING' æŸ¥è¯¢æ²¡æœ‰ç´¢å¼•çš„è¡¨123456789101112SELECT table_nameFROM user_tablesWHERE table_name NOT IN (SELECT table_name FROM user_indexes)SELECT table_nameFROM user_tablesWHERE table_name NOT IN (SELECT table_name FROM user_ind_columns) æŸ¥è¯¢ä¸€ä¸ªAWRå‘¨æœŸå†…çš„å¹³å‡sessionæ•°ã€OSå¹³å‡è´Ÿè½½ã€å¹³å‡db timeã€å¹³å‡æ¯ç§’å¤šå°‘äº‹åŠ¡12345678910111213SELECT to_char(max(BEGIN_TIME), 'yyyy-mm-dd hh24:mi')||to_char(max(end_time),'* hh24:mi') time, snap_id, trunc(sum(case metric_name WHEN 'Session Count' THEN average end),2) sessions, trunc(sum(case metric_name WHEN 'Current OS Load' THEN average end),2) OS_LOAD, (trunc(sum(case metric_name WHEN 'Database Time Per Sec' THEN average end),2)/100)*(ceil((max(end_time)-max(BEGIN_TIME))*24*60*60)) Database_Time_second, trunc(sum(case metric_name WHEN 'User Transaction Per Sec' THEN average end),2) User_Transaction_Per_SecFROM dba_hist_sysmetric_summaryGROUP BY snap_idORDER BY snap_id; Database Time Per Secå¯¹åº”å€¼çš„å•ä½æ˜¯ç™¾åˆ†ä¸€ç§’/æ¯ç§’ (/100)(ceil((max(end_time)-max(BEGIN_TIME))246060))æ˜¯ä»£è¡¨æ¯ä¸ªsnapå‘¨æœŸå†…çš„æ€»ç§’æ•°ï¼Œoracle ä¸¤ä¸ªæ—¶é—´ç›¸å‡é»˜è®¤çš„æ˜¯å¤©æ•°,2460*60 ä¸ºç›¸å·®çš„ç§’æ•° è¿™ä¸ªSQLæŸ¥åˆ°çš„DB TIMEæ¯”è¾ƒå‡†ç¡®ï¼Œå’Œawrä¸Šé¢çš„db timeæ¯”è¾ƒä¸€è‡´ æŸ¥è¯¢äº§ç”Ÿçƒ­å—è¾ƒå¤šçš„å¯¹è±¡x$bh .tch(Touch)è¡¨ç¤ºè®¿é—®æ¬¡æ•°è¶Šé«˜ï¼Œçƒ­ç‚¹å¿«ç«äº‰é—®é¢˜å°±å­˜åœ¨123456789101112131415161718SELECT e.owner, e.segment_name, e.segment_typeFROM dba_extents e, (SELECT * FROM (SELECT addr, ts#, file#, dbarfil, dbablk, tch FROM x$bh ORDER BY tch DESC) WHERE ROWNUM < 11) b WHERE e.relative_fno = b.dbarfil AND e.block_id b.dbablk; æ‰‹å·¥åˆ›å»ºå¿«ç…§çš„è¯­å¥1exec dbms_workload_repository.create_snapshot; AWRè®¾ç½®æ¯éš”30åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡æŠ¥å‘Šï¼Œä¿ç•™14å¤©çš„æŠ¥å‘Š123exec DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(retention=>14*24*60, interval=>30); select * from dba_hist_wr_control; AWRåŸºçº¿æŸ¥çœ‹å’Œåˆ›å»º123select * from dba_hist_baseline; exec DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE(start_snap_id=>7550,end_snap_id=>7660,baseline_name=>'am_baseline'); å¯¼å‡ºAWRæŠ¥å‘Šçš„SQLè¯­å¥12345678SELECT *FROM dba_hist_snapshotSELECT *FROM table(dbms_workload_repository.awr_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid))SELECT *FROM TABLE(DBMS_WORKLOAD_REPOSITORY.awr_diff_report_html(DBID, INSTANCE_NUMBER, startsnapid,endsnapid, DBID, INSTANCE_NUMBER, startsnapid,endsnapid)); å¯¼å‡ºæœ€æ–°ADDMçš„æŠ¥å‘Šï¼ˆéœ€è¦sysç”¨æˆ·ï¼‰1234567891011121314SELECT dbms_advisor.get_task_report(task_name)FROM dba_advisor_tasksWHERE task_id = (SELECT max(t.task_id) FROM dba_advisor_tasks t, dba_advisor_log l WHERE t.task_id=l.task_id AND t.advisor_name='ADDM' AND l.status='COMPLETED' );SELECT task_id, task_name, descriptionFROM dba_advisor_tasksORDER BY 1 DESCSELECT dbms_advisor.get_task_report(task_name)FROM dba_advisor_tasksWHERE task_id =XX æŸ¥è¯¢æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’12SELECT *FROM table(dbms_xplan.display_cursor('sql_id',0,' advanced ')); ä¸Šé¢çš„0è¡¨ç¤ºv$sql.child_numberä¸º0ï¼Œå¦‚æœä¸€ä¸ªsql_idåœ¨v$sqlä¸­æœ‰å¤šè¡Œè¯´æ˜æœ‰å¤šä¸ªchild_numberï¼Œè¦çœ‹å“ªå„¿child_numberçš„æ‰§è¡Œè®¡åˆ’ï¼Œå°±å†™å“ªä¸ªçš„å€¼ï¼Œæ¯”å¦‚è¦çœ‹child_numberä¸º2çš„æ‰§è¡Œè®¡åˆ’ï¼Œå°±æŠŠä¸Šé¢sqlçš„0æ”¹ä¸º2 ã€‚ å®˜æ–¹æ–‡æ¡£å¯¹display_cursorè¿™ä¸ªå‡½æ•°çš„è¯´æ˜é‡Œé¢æ²¡æœ‰advancedè¿™ä¸ªå‚æ•°å€¼ï¼Œåªæœ‰BASICã€TYPICALã€ALLè¿™å‡ ä¸ªï¼Œä¸è¿‡å®è·µä¸­å‘ç°advancedè¿™ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„å†…å®¹æ¯”è¿™å‡ ä¸ªå‚æ•°å€¼æ˜¾ç¤ºçš„éƒ½å¤šã€‚12SELECT *FROM table(xplan.display_cursor('v$sql.sql_id',0,'advanced')); åˆ›å»ºxplanåŒ…ï¼Œå†æ‰§è¡Œ12SQL> CREATE PUBLIC SYNONYM XPLAN FOR SYS.XPLAN; SQL> grant execute on sys.xplan to public; æŸ¥è¯¢Rmançš„é…ç½®ä¿¡æ¯123SELECT NAME, VALUEFROM V$RMAN_CONFIGURATION; æŸ¥è¯¢Rmanå¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯ï¼ˆæœªè¿‡æœŸçš„ï¼Œè¿‡æœŸå¹¶å·²åˆ é™¤çš„æŸ¥ä¸åˆ°ï¼‰123456789101112SELECT B.RECID BackupSet_ID, A.SET_STAMP, DECODE (B.INCREMENTAL_LEVEL, '', DECODE (BACKUP_TYPE, 'L', 'Archivelog', 'Full'), 1, 'Incr-1çº§', 0, 'Incr-0çº§', B.INCREMENTAL_LEVEL) "Type LV", B.CONTROLFILE_INCLUDED "åŒ…å«CTL", DECODE (A.STATUS, 'A', 'AVAILABLE', 'D', 'DELETED', 'X', 'EXPIRED', 'ERROR') "STATUS", A.DEVICE_TYPE "Device Type", A.START_TIME "Start Time", A.COMPLETION_TIME "Completion Time", A.ELAPSED_SECONDS "Elapsed Seconds", A.BYTES/1024/1024/1024 "Size(G)", A.COMPRESSED, A.TAG "Tag", A.HANDLE "Path"FROM GV$BACKUP_PIECE A, GV$BACKUP_SET BWHERE A.SET_STAMP = B.SET_STAMP AND A.DELETED = 'NO'ORDER BY A.COMPLETION_TIME DESC; æŸ¥è¯¢Rmanå¤‡ä»½è¿›åº¦123456789SELECT SID, SERIAL#, opname, ROUND(SOFAR/TOTALWORK*100)||'%' "%_COMPLETE", TRUNC(elapsed_seconds/60) || ':' || MOD(elapsed_seconds,60) elapsed, TRUNC(time_remaining/60) || ':' || MOD(time_remaining,60) remaining, CONTEXT,target,SOFAR, TOTALWORKFROM V$SESSION_LONGOPSWHERE OPNAME LIKE 'RMAN%' AND OPNAME NOT LIKE '%aggregate%' AND TOTALWORK != 0 AND SOFAR TOTALWORK; æŸ¥è¯¢æ‰§è¡Œè¿‡å…¨è¡¨æ‰«æçš„sqlè¯­å¥çš„SQL_IDå’Œsql_fulltext12345678910111213141516SELECT s.sid, s.serial#, s.inst_id, s.sql_id, s.username, s.target, s.ELAPSED_SECONDS, s.START_TIME, s.LAST_UPDATE_TIME, v.sql_fulltextFROM gv$session_longops s,gv$sql vWHERE s.OPNAME = 'Table Scan' AND s.SQL_PLAN_OPERATION = 'TABLE ACCESS' AND s.SQL_PLAN_OPTIONS = 'FULL' AND s.sql_id=v.sql_idORDER BY s.LAST_UPDATE_TIME DESC æŸ¥è¯¢æ­»äº‹åŠ¡éœ€è¦å¤šé•¿çš„å›æ»šæ—¶é—´1X$KTUXEï¼š[K]ernel [T]ransaction [U]ndo Transa[x]tion [E]ntry (table)` X$KTUXEè¡¨çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½æ˜¯ï¼Œå¯ä»¥è·å¾—æ— æ³•é€šè¿‡v$transactionæ¥è§‚å¯Ÿçš„æ­»äº‹åŠ¡ä¿¡æ¯ï¼Œå½“ä¸€ä¸ªæ•°æ®åº“å‘ç”Ÿå¼‚å¸¸ä¸­æ–­ï¼Œæˆ–è€…è¿›è¡Œå»¶è¿Ÿäº‹åŠ¡æ¢å¤æ—¶ï¼Œæ•°æ®åº“å¯åŠ¨åï¼Œæ— æ³•é€šè¿‡V$TRANSACTIONæ¥è§‚å¯Ÿäº‹åŠ¡ä¿¡æ¯ï¼Œä½†æ˜¯X$KTUXEå¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å¾—è¿™äº›ä¿¡æ¯ã€‚è¯¥è¡¨ä¸­çš„KTUXECFLä»£è¡¨äº†äº‹åŠ¡çš„Flagæ ‡è®°ï¼Œé€šè¿‡è¿™ä¸ªæ ‡è®°å¯ä»¥æ‰¾åˆ°é‚£äº›Deadäº‹åŠ¡ï¼š12345SQL> select distinct KTUXECFL,count(*) from x$ktuxe group by KTUXECFL; KTUXECFL COUNT(*) ------------------------ ---------- DEAD 1 NONE 2393 KTUXESIZç”¨æ¥è®°å½•äº‹åŠ¡ä½¿ç”¨çš„å›æ»šæ®µå—æ•°ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿè¿™ä¸ªå­—æ®µæ¥è¯„ä¼°æ¢å¤è¿›åº¦,ä¾‹å¦‚å¦‚ä¸‹äº‹åŠ¡å›æ»šç»è¿‡æµ‹ç®—éœ€è¦å¤§çº¦3å°æ—¶12345678910111213141516171819202122SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x$ktuxe where KTUXECFL ='DEAD'; ADDR KTUXEUSN KTUXESLT KTUXESQN KTUXESIZ ---------------- ---------- ---------- ---------- ---------- FFFFFFFF7D07B91C 10 39 2567412 1086075 SQL> select ADDR,KTUXEUSN,KTUXESLT,KTUXESQN,KTUXESIZ from x$ktuxe where KTUXECFL ='DEAD'; ADDR KTUXEUSN KTUXESLT KTUXESQN KTUXESIZ ---------------- ---------- ---------- ---------- ---------- FFFFFFFF7D07B91C 10 39 2567412 1086067 SQL> declare l_start number; l_end number; begin select ktuxesiz into l_start from x$ktuxe where KTUXEUSN=10 and KTUXESLT=39; dbms_lock.sleep(60); select ktuxesiz into l_end from x$ktuxe where KTUXEUSN=10 and KTUXESLT=39; dbms_output.put_line('time_H:'|| round(l_end/(l_start -l_end)/60,2)); end; / time_H:3 æŠŠXXXç”¨æˆ·ä¸‹é¢çš„æŸäº›YYYè¡¨èµ‹æƒç»™user,XXX\YYYè¦å¤§å†™ XXXè¦å¤§å†™12345678declare tablename varchar2(200); begin for x IN (SELECT * FROM dba_tables where owner='XXX' and table_name like '%YYY%') loop tablename:=x.table_name; dbms_output.put_line('GRANT SELECT ON XXX.'||tablename||' to user'); EXECUTE IMMEDIATE 'GRANT SELECT ON XXX.'||tablename||' TO user'; end loop; end; OracleæŸ¥å‡ºä¸€ä¸ªç”¨æˆ·å…·æœ‰çš„æ‰€æœ‰ç³»ç»Ÿæƒé™å’Œå¯¹è±¡æƒé™ç³»ç»Ÿæƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢select * from session_privsçš„ç»“æœä¸€è‡´ï¼‰12345678910SELECT *FROM DBA_SYS_PRIVSWHERE GRANTEE = 'ç”¨æˆ·å'UNIONALLSELECT *FROM DBA_SYS_PRIVSWHERE GRANTEE IN (SELECT GRANTED_ROLE FROM DBA_ROLE_PRIVS WHERE GRANTEE = 'ç”¨æˆ·å'); å¯¹è±¡æƒé™ï¼ˆå’Œç”¨æˆ·è‡ªå·±æŸ¥è¯¢select * FROM TABLE_PRIVILEGES where GRANTEE='å½“å‰ç”¨æˆ·'çš„ç»“æœä¸€è‡´ï¼‰12345678910SELECT *FROM DBA_TAB_PRIVSWHERE GRANTEE = 'ç”¨æˆ·å'UNIONALLSELECT *FROM DBA_TAB_PRIVSWHERE GRANTEE IN (SELECT GRANTED_ROLE FROM DBA_ROLE_PRIVS WHERE GRANTEE = 'ç”¨æˆ·å'); æŸ¥è¯¢æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²123SELECT *FROM dba_role_privsWHERE GRANTEE='ç”¨æˆ·å'; æŸ¥è¯¢æ‹¥æœ‰DBAè§’è‰²æƒé™çš„ç”¨æˆ·123SELECT *FROM dba_role_privsWHERE GRANTED_ROLE='DBA'; æŸ¥è¯¢æŸä¸ªè§’è‰²æ‹¥æœ‰çš„ç³»ç»Ÿæƒé™123SELECT *FROM ROLE_SYS_PRIVSWHERE role='è§’è‰²å' æ¸…é™¤æŸä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’1Exec DBMS_SHARED_POOL.PURGE('v$sqlarea.ADDRESS,v$sqlarea.HASH_VALUE','c') æŸ¥è¯¢å¯†ç æ˜¯å¦æœ‰è¿‡æœŸé™åˆ¶ï¼Œé»˜è®¤æ˜¯180å¤©ï¼Œä¸€èˆ¬ä¿®æ”¹ä¸ºunlimited1234567SELECT *FROM dba_profilesWHERE profile='DEFAULT' AND RESOURCE_NAME LIKE 'PASSWORD%'; ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED æŸ¥è¯¢å’Œä¿®æ”¹éšå«å‚æ•°ï¼ˆå¿…é¡»åœ¨sysdbaæƒé™ä¸‹æ“ä½œï¼‰123456789SELECT a.ksppinm name, b.ksppstvl value, a.ksppdesc descriptionFROM x$ksppi a, x$ksppcv bWHERE a.indx = b.indx AND a.ksppinm LIKE '%_small_table_threshold%' alter system set "_small_table_threshold"=value scope=both sid='*'; ä¸åŠ sidåˆ™è¯´æ˜åœ¨é»˜è®¤åœ¨RACçš„æ‰€æœ‰å®ä¾‹ä¸­ä¿®æ”¹ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·, å¦å¤–å¼•å·å†…ä¸èƒ½æœ‰ç©ºæ ¼, åªèƒ½åŒ…å«å‚æ•°çš„åå­— è¯„ä¼°SGAè¯¥è®¾ç½®å¤šå°‘1234567SELECT SGA_SIZEFROM (SELECT * FROM V$SGA_TARGET_ADVICE WHERE ESTD_DB_TIME_FACTOR=1 ORDER BY 1)WHERE rownum=1; æŸ¥çœ‹shared poolè¿˜å‰©å¤šå°‘1234SELECT *FROM v$sgastatWHERE name='free memory' AND pool='shared pool'; ç»Ÿè®¡æ‰€æœ‰è¡¨çš„å®¹é‡å¤§å°(å«åˆ†åŒºå­—æ®µã€LOBå­—æ®µ)ä¸€èˆ¬å…ˆæ‰§è¡Œselect distinct SEGMENT_TYPE from dba_segments where owner'SYS' and tablespace_name'SYSAUX'æŸ¥çœ‹åˆ°æ‰€æœ‰çš„segment_type123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960SELECT owner, table_name, TRUNC(sum(bytes)/1024/1024) MegFROM (SELECT segment_name table_name, owner, bytes FROM dba_segments WHERE segment_type = 'TABLE' UNION ALLSELECT s.segment_name table_name, pt.owner, s.bytes FROM dba_segments s, dba_part_tables pt WHERE s.segment_name = pt.table_name AND s.owner = pt.owner AND s.segment_type = 'TABLE PARTITION' UNION ALLSELECT i.table_name, i.owner, s.bytes FROM dba_indexes i, dba_segments s WHERE s.segment_name = i.index_name AND s.owner = i.owner AND s.segment_type = 'INDEX' UNION ALLSELECT pi.table_name, pi.owner, s.bytes FROM dba_part_indexes pi, dba_segments s WHERE s.segment_name = pi.index_name AND s.owner = pi.owner AND s.segment_type = 'INDEX PARTITION' UNION ALLSELECT l.table_name, l.owner, s.bytes FROM dba_lobs l, dba_segments s WHERE s.segment_name = l.segment_name AND s.owner = l.owner AND s.segment_type = 'LOBSEGMENT' UNION ALLSELECT l.table_name, l.owner, s.bytes FROM dba_lobs l, dba_segments s WHERE s.segment_name = l.index_name AND s.owner = l.owner AND s.segment_type = 'LOBINDEX' UNION allSELECT l.table_name, l.owner, s.bytes FROM dba_lobs l, dba_segments s WHERE s.segment_name = l.segment_name AND s.owner = l.owner AND s.segment_type = 'LOB PARTITION' )GROUP BY owner,table_nameHAVING SUM(bytes)/1024/1024 > 10ORDER BY SUM(bytes) DESC æŸ¥çœ‹å½“å‰ä¼šè¯çš„SID123SELECT *FROM V$MYSTATWHERE rownumSELECT valueFROM v$dataguard_statsWHERE name='apply lag' æˆ– å¤‡åº“sqlplus>SELECT ceil((sysdate-next_time)*24*60) "M"FROM v$archived_logWHERE applied='YES' AND SEQUENCE#= (SELECT MAX(SEQUENCE#) FROM V$ARCHIVED_LOG WHERE applied='YES'); æŸ¥çœ‹æŸä¸ªåŒ…æˆ–å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒç”¨,å¦‚æœå¦‚ä¸‹æœ‰ç»“æœï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç¼–è¯‘ï¼Œå¦åˆ™ä¼šé”ä½1234SELECT *FROM V$DB_OBJECT_CACHEWHERE pin>0 AND name=upper('XX') æŸ¥è¯¢æ•°æ®åº“æ‰“è¡¥ä¸çš„è®°å½•12SELECT *FROM dba_registry_history; æŸ¥è¯¢æŸè¡¨çš„ç´¢å¼•å­—æ®µçš„distinctè¡Œæ•°å’ŒCLUSTERING_FACTORä¿¡æ¯12345678910111213SELECT a.table_name, a.index_name, b.COLUMN_NAME, a.blevel, a.distinct_keys, A.CLUSTERING_FACTOR, A.NUM_ROWS, trunc((a.distinct_keys/A.NUM_ROWS), 2)*100||'%' "distinct%",trunc((a.CLUSTERING_FACTOR/A.NUM_ROWS),2)*100||'%' "CLUSTERING_FACTOR%"FROM DBA_IND_STATISTICS a,DBA_IND_COLUMNS bWHERE a.table_name='XX' AND a.INDEX_NAME=b.index_nameORDER BY 5 desc æŸ¥è¯¢æŸè¡¨çš„æ‰€æœ‰å­—æ®µçš„distinctè¡Œæ•°123456789101112SELECT a.table_name, b.num_rows, a.column_name, a.data_type, a.data_length, a.num_distinct, trunc((a.num_distinct/b.num_rows), 2)*100||'%'FROM dba_TAB_COLS a,dba_tables bWHERE a.table_name='XX' AND a.table_name=b.table_nameORDER BY 6 DESC æŸ¥è¯¢5Gä»¥ä¸Šç©ºé—²ç©ºé—´å¯ä»¥è¿›è¡Œæ”¶ç¼©çš„æ•°æ®æ–‡ä»¶123456789101112SELECT 'alter database datafile ''' || a.file_name || ''' resize ' || round(a.filesize -(a.filesize - c.hwmsize) * 0.8) || 'M;', a.filesize || 'M' AS "æ•°æ®æ–‡ä»¶çš„æ€»å¤§å°", c.hwmsize || 'M' AS "æ•°æ®æ–‡ä»¶çš„å®ç”¨å¤§å°"FROM (SELECT file_id, file_name, round(bytes / 1024 / 1024) AS filesize FROM dba_data_files) a, (SELECT file_id, round(max(block_id) * 8 / 1024) AS HWMsize FROM dba_extents GROUP BY file_id) cWHERE a.file_id = c.file_id AND a.filesize - c.hwmsize > 5000; å‚è€ƒ å»–å­¦å¼º,DBAæ—¥å¸¸ç»´æŠ¤SQLè„šæœ¬ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Oracle</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åº“æ‹†åˆ†]]></title>
    <url>%2F2019%2F04%2F24%2FdatabaseSplitting%2F</url>
    <content type="text"><![CDATA[ç«¥è¯é‡Œç°å§‘å¨˜éƒ½å¾ˆç©·ï¼Œä½†éƒ½å¾ˆæ¼‚äº®ï¼Œä½ æ¼‚äº®å—ï¼Ÿ æ•°æ®åº“æ°´å¹³å‚ç›´æ‹†åˆ†å½“æ•°æ®åº“é‡éå¸¸å¤§çš„æ—¶å€™ï¼ŒDB å·²ç»æˆä¸ºç³»ç»Ÿç“¶é¢ˆæ—¶å°±å¯ä»¥è€ƒè™‘è¿›è¡Œæ°´å¹³å‚ç›´æ‹†åˆ†äº†ã€‚ æ°´å¹³æ‹†åˆ†ä¸€èˆ¬æ°´å¹³æ‹†åˆ†æ˜¯æ ¹æ®è¡¨ä¸­çš„æŸä¸€å­—æ®µ(é€šå¸¸æ˜¯ä¸»é”® ID )å–æ¨¡å¤„ç†ï¼Œå°†ä¸€å¼ è¡¨çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ä¸­ã€‚è¿™æ ·æ¯å¼ è¡¨çš„è¡¨ç»“æ„æ˜¯ç›¸åŒçš„ä½†æ˜¯æ•°æ®ä¸åŒã€‚ ä¸ä½†å¯ä»¥é€šè¿‡ ID å–æ¨¡åˆ†è¡¨è¿˜å¯ä»¥é€šè¿‡æ—¶é—´åˆ†è¡¨ï¼Œæ¯”å¦‚æ¯æœˆç”Ÿæˆä¸€å¼ è¡¨ã€‚æŒ‰ç…§èŒƒå›´åˆ†è¡¨ä¹Ÿæ˜¯å¯è¡Œçš„:ä¸€å¼ è¡¨åªå­˜å‚¨ 0~1000Wçš„æ•°æ®ï¼Œè¶…è¿‡åªå°±è¿›è¡Œåˆ†è¡¨ï¼Œè¿™æ ·åˆ†è¡¨çš„ä¼˜ç‚¹æ˜¯æ‰©å±•çµæ´»ï¼Œä½†æ˜¯å­˜åœ¨çƒ­ç‚¹æ•°æ®ã€‚ æŒ‰ç…§å–æ¨¡åˆ†è¡¨æ‹†åˆ†ä¹‹åæˆ‘ä»¬çš„æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤ä¹Ÿéƒ½æ˜¯å–æ¨¡ã€‚æ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®çš„æ—¶å€™å¾€å¾€éœ€è¦ä¸€å¼ ä¸´æ—¶è¡¨æ¥ç”Ÿæˆ ID,ç„¶åæ ¹æ®ç”Ÿæˆçš„ ID å–æ¨¡è®¡ç®—å‡ºéœ€è¦å†™å…¥çš„æ˜¯å“ªå¼ è¡¨(ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼ ID ç”Ÿæˆå™¨æ¥ç”Ÿæˆ ID)ã€‚ åˆ†è¡¨ä¹‹åä¸èƒ½é¿å…çš„å°±æ˜¯æŸ¥è¯¢è¦æ¯”ä»¥å‰å¤æ‚ï¼Œé€šå¸¸ä¸å»ºè®® join ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯åšä¸¤æ¬¡æŸ¥è¯¢ã€‚ å‚ç›´æ‹†åˆ†å½“ä¸€å¼ è¡¨çš„å­—æ®µè¿‡å¤šæ—¶åˆ™å¯ä»¥è€ƒè™‘å‚ç›´æ‹†åˆ†ã€‚é€šå¸¸æ˜¯å°†ä¸€å¼ è¡¨çš„å­—æ®µæ‰åˆ†ä¸ºä¸»è¡¨ä»¥åŠæ‰©å±•è¡¨ï¼Œä½¿ç”¨é¢‘æ¬¡è¾ƒé«˜çš„å­—æ®µåœ¨ä¸€å¼ è¡¨ï¼Œå…¶ä½™çš„åœ¨ä¸€å¼ è¡¨ã€‚ è¿™é‡Œçš„å¤šè¡¨æŸ¥è¯¢ä¹Ÿä¸å»ºè®®ä½¿ç”¨ join ï¼Œä¾ç„¶å»ºè®®ä½¿ç”¨ä¸¤æ¬¡æŸ¥è¯¢ã€‚ æ‹†åˆ†ä¹‹åå¸¦æ¥çš„é—®é¢˜æ‹†åˆ†ä¹‹åç”±ä¸€å¼ è¡¨å˜ä¸ºäº†å¤šå¼ è¡¨ï¼Œä¸€ä¸ªåº“å˜ä¸ºäº†å¤šä¸ªåº“ã€‚æœ€çªå‡ºçš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯äº‹åŠ¡å¦‚ä½•ä¿è¯ã€‚ ä¸¤æ®µæäº¤æœ€ç»ˆä¸€è‡´æ€§å¦‚æœä¸šåŠ¡å¯¹å¼ºä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆé«˜é‚£ä¹ˆæœ€ç»ˆä¸€è‡´æ€§åˆ™æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆã€‚ é€šå¸¸çš„åšæ³•å°±æ˜¯è¡¥å¿ï¼Œæ¯”å¦‚ ä¸€ä¸ªä¸šåŠ¡æ˜¯ A è°ƒç”¨ Bï¼Œä¸¤ä¸ªæ‰§è¡ŒæˆåŠŸæ‰ç®—æœ€ç»ˆæˆåŠŸï¼Œå½“ A æˆåŠŸä¹‹åï¼ŒB æ‰§è¡Œå¤±è´¥å¦‚ä½•æ¥é€šçŸ¥ A å‘¢ã€‚ æ¯”è¾ƒå¸¸è§çš„åšæ³•æ˜¯ å¤±è´¥æ—¶ B é€šè¿‡ MQ å°†æ¶ˆæ¯å‘Šè¯‰ Aï¼ŒA å†æ¥è¿›è¡Œå›æ»šã€‚è¿™ç§çš„å‰ææ˜¯ A çš„å›æ»šæ“ä½œå¾—æ˜¯å¹‚ç­‰çš„ï¼Œä¸ç„¶ B é‡å¤å‘æ¶ˆæ¯å°±ä¼šå‡ºç°é—®é¢˜ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ†å¸ƒå¼ ID ç”Ÿæˆç­–ç•¥]]></title>
    <url>%2F2019%2F04%2F24%2FDistributed-ID-Generation%2F</url>
    <content type="text"><![CDATA[èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼ å‰è¨€å¯¹äºç³»ç»Ÿä¸­çš„ä¸€ç»„æ•°æ®è€Œè¨€ï¼Œå¿…ä¸å¯å°‘åœ°å¯¹åº”æœ‰å”¯ä¸€æ ‡è¯†ã€‚ç®€å•çš„å•ä½“åº”ç”¨å¯ä»¥ä½¿ç”¨æ•°æ®åº“çš„è‡ªå¢ ID ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚è€Œåœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå°±éœ€è¦ä¸€äº›ç‰¹å®šçš„ç­–ç•¥å»ç”Ÿæˆå¯¹åº”çš„åˆ†å¸ƒå¼ IDã€‚ å¸¸è§çš„é¡¹ç›®ä¸­ ID ä¼šæœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š å…¨å±€å”¯ä¸€æ€§ã€‚ è¶‹åŠ¿é€’å¢ï¼ˆå¯¹äºä½¿ç”¨ MySQL çš„é¡¹ç›®è€Œè¨€ï¼‰ã€‚ å› ä¸ºä¸€èˆ¬ ID ä¼šä½œä¸ºæ•°æ®åº“çš„ä¸»é”®å­˜å‚¨ï¼Œè€Œåœ¨ MySQL InnoDB ä¸­ä½¿ç”¨çš„æ˜¯èšç°‡ç´¢å¼•ï¼Œä½¿ç”¨æœ‰åºçš„ ID å¯ä»¥ä¿è¯å†™å…¥æ€§èƒ½ã€‚ ä¸€èˆ¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡æ¥ç”Ÿæˆ IDã€‚è€Œè¿™ä¸ªæœåŠ¡åˆ™éœ€è¦ä¿è¯é«˜å¯ç”¨æ€§ã€é«˜QPS ä¸å®‰å…¨æ€§ã€‚å¦å¤–ç”Ÿæˆçš„ ID æ˜¯ä¸åº”è¯¥å¯¹å¤–æš´éœ²çš„ï¼Œå¦‚æœéè¦å¯¹å¤–å±•ç¤ºï¼Œæœ€å¥½æ˜¯æ— è§„åˆ™ã€ä¸è§„å¾‹çš„ç¼–ç ã€‚ ç”Ÿæˆç­–ç•¥UUIDUUID (Universally Unique Identifier) ç”Ÿæˆçš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 32 çš„ 16 è¿›åˆ¶æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚UUID æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå„ç‰ˆæœ¬ç®—æ³•ä¸åŒã€‚ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç»“åˆæœºå™¨çš„ç½‘å¡ã€å½“å‰æ—¶é—´ã€ä¸€ä¸ªéšæœºæ•°æ¥ç”Ÿæˆç‰¹å®šé•¿åº¦çš„å­—ç¬¦ä¸²ã€‚ ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ã€é«˜å¯æ‰©å±•æ€§ï¼šæœ¬åœ°ç”Ÿæˆï¼Œæ— ç½‘ç»œæ¶ˆè€—ï¼Œä¸éœ€è¦è€ƒè™‘æ€§èƒ½ç“¶é¢ˆã€‚ ç¼ºç‚¹ï¼š æ— æ³•ä¿è¯è¶‹åŠ¿é€’å¢ã€‚ UUID è¿‡é•¿ï¼Œå¦‚æœéœ€è¦åœ¨æ•°æ®åº“å­˜å‚¨ï¼Œä½œä¸ºä¸»é”®å»ºç«‹ç´¢å¼•æ•ˆç‡ä½ã€‚ é€‚ç”¨åœºæ™¯ï¼šä¸éœ€è¦è€ƒè™‘ç©ºé—´å ç”¨ï¼Œä¸éœ€è¦ç”Ÿæˆæœ‰é€’å¢è¶‹åŠ¿ï¼Œä¸”ä¸åœ¨ MySQL ä¸­å­˜å‚¨ã€‚ Snowflakesnowflake æ˜¯ Twitter å¼€æºçš„ä¸€ä¸ª ID ç”Ÿæˆç®—æ³•ã€‚ é¦–ä½ç¬¦å·ä½ï¼šå› ä¸º ID ä¸€èˆ¬ä¸ºæ­£æ•°ï¼Œè¯¥å€¼ä¸º 0ã€‚ 41 ä½æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼š æ—¶é—´æˆ³ä¸æ˜¯å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆ³çš„å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆ³ - èµ·å§‹æ—¶é—´æˆ³ï¼ˆèµ·å§‹æ—¶é—´æˆ³éœ€è¦ç¨‹åºæŒ‡å®šï¼‰ï¼‰ç†è®ºä¸Šå¯ä»¥æœ€å¤šä½¿ç”¨ (1 < 41) / (1000x60x60x24x365) = 69å¹´]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL æ°´å¹³æ‹†åˆ†è¡¨çš„ä¸€æ¬¡è¸©å‘]]></title>
    <url>%2F2019%2F04%2F24%2Fmysql-sharding%2F</url>
    <content type="text"><![CDATA[èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼ å‰è¨€ä¹‹å‰ä¸å°‘äººé—®æˆ‘â€èƒ½å¦åˆ†äº«ä¸€äº›åˆ†åº“åˆ†è¡¨ç›¸å…³çš„å®è·µâ€ï¼Œå…¶å®ä¸æ˜¯æˆ‘ä¸åˆ†äº«ï¼Œè€Œæ˜¯çœŸçš„ç»éªŒä¸å¤šğŸ¤£ï¼›å’Œå¤§éƒ¨åˆ†äººä¸€æ ·éƒ½æ˜¯åœç•™åœ¨ç†è®ºé˜¶æ®µã€‚ ä¸è¿‡è¿™æ¬¡å¤šå°‘æœ‰äº›å¯ä»¥è¯´é“äº†ã€‚ å…ˆè°ˆè°ˆèƒŒæ™¯ï¼Œæˆ‘ä»¬ç”Ÿäº§æ•°æ®åº“éšç€ä¸šåŠ¡å‘å±•é‡ä¹Ÿé€æ¸èµ·æ¥ï¼›å¥½å‡ å¼ å•è¡¨å·²ç»çªç ´äº¿çº§æ•°æ®ï¼Œå¹¶ä¸”ä¿æŒæ¯å¤© 200+W çš„æ•°æ®é‡å¢åŠ ã€‚ è€Œæˆ‘ä»¬æœ‰äº›ä¸šåŠ¡éœ€è¦è¿›è¡Œå…³è”æŸ¥è¯¢ã€æˆ–è€…æ˜¯æŠ¥è¡¨ç»Ÿè®¡ï¼›åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å¤§è¡¨çš„é—®é¢˜æ›´åŠ çªå‡ºï¼ˆæ¯”å¦‚ä¸€ä¸ªæŸ¥è¯¢åŠŸèƒ½éœ€è¦è·‘å¥½å‡ åˆ†é’Ÿï¼‰ã€‚ å¯èƒ½å¾ˆå¤šäººä¼šè¯´ï¼šä¸ºå•¥å•è¡¨éƒ½è¿‡äº¿äº†æ‰æƒ³æ–¹æ¡ˆè§£å†³ï¼Ÿå…¶å®ä¸æ˜¯ä¸æƒ³ï¼Œè€Œæ˜¯ç”±äºå†å²åŸå› åŠ ä¸Šé”™è¯¯é¢„ä¼°äº†æ•°æ®å¢é•¿æ‰å¯¼è‡´è¿™ä¸ªå±€é¢ã€‚æ€»ä¹‹åŸå› æ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿä¸æ˜¯æœ¬æ¬¡è®¨è®ºçš„é‡ç‚¹ã€‚ ä¸´æ—¶æ–¹æ¡ˆç”±äºéœ€æ±‚ç´§ã€äººæ‰‹ç¼ºçš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ªå¤„ç†çš„è¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µã€‚ ç¬¬ä¸€é˜¶æ®µåº”è¯¥æ˜¯å»å¹´åº•ï¼Œå½“æ—¶è¿ç»´ååº” MySQL æ‰€åœ¨çš„ä¸»æœºå†…å­˜å ç”¨å¾ˆé«˜ï¼Œæ•´ä½“è´Ÿè½½ä¹Ÿå±…é«˜ä¸ä¸‹ï¼Œå¯¼è‡´æ•´ä¸ª MySQL çš„ååé‡æ˜æ˜¾é™ä½ï¼ˆå†™å…¥ã€æŸ¥è¯¢æ•°æ®éƒ½æ˜æ˜¾å‡æ…¢ï¼‰ã€‚ ä¸ºæ­¤æˆ‘ä»¬æ‰¾å‡ºäº†æ•°æ®é‡æœ€å¤§çš„å‡ å¼ è¡¨ï¼Œå‘ç°å¤§éƒ¨åˆ†æ•°æ®é‡åœ¨7/8000W å·¦å³ï¼Œå°‘æ•°çš„å·²ç»çªç ´ä¸€äº¿ã€‚ é€šè¿‡ä¸šåŠ¡å±‚é¢è¿›è¡Œåˆ†æå‘ç°ï¼Œè¿™äº›æ•°æ®å¤šæ•°éƒ½æ˜¯ç”¨æˆ·äº§ç”Ÿçš„ä¸€äº›æ—¥å¿—å‹æ•°æ®ï¼Œè€Œä¸”è¿™äº›æ•°æ®åœ¨ä¸šåŠ¡ä¸Šå¹¶ä¸æ˜¯å¼ºç›¸å…³çš„ï¼Œç”šè‡³ä¸¤ä¸‰ä¸ªæœˆå‰çš„æ•°æ®å…¶å®å·²ç»ä¸éœ€è¦å®æ—¶æŸ¥è¯¢äº†ã€‚ å› ä¸ºæ¥è¿‘å¹´åº•ï¼Œå°½å¯èƒ½çš„ä¸æƒ³å»åŠ¨åº”ç”¨ï¼Œè€ƒè™‘æ˜¯å¦å¯ä»¥åœ¨è¿ç»´å±‚é¢ç¼“è§£å‹åŠ›ï¼›ä¸»è¦çš„ç›®çš„å°±æ˜¯æŠŠå•è¡¨çš„æ•°æ®é‡é™ä½ã€‚ åŸæœ¬æ˜¯æƒ³æŠŠä¸¤ä¸ªæœˆä¹‹å‰çš„æ•°æ®ç›´æ¥è¿ç§»å‡ºæ¥æ”¾åˆ°å¤‡ä»½è¡¨ä¸­ï¼Œä½†åœ¨å‡†å¤‡å®æ–½çš„è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªå¤§å‘ã€‚ è¡¨ä¸­æ²¡æœ‰ä¸€ä¸ªå¯ä»¥æ’åºçš„ç´¢å¼•ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•å¿«é€Ÿçš„ç­›é€‰å‡ºä¸€éƒ¨åˆ†æ•°æ®ï¼è¿™çœŸæ˜¯ä¸€ä¸ªæ·±å‘ï¼Œä¸ºåé¢çš„ä¸€äº›ä¼˜åŒ–åŸ‹äº†ä¸ªåœ°é›·ï¼›å³ä¾¿æ˜¯åŠ ç´¢å¼•ä¹Ÿéœ€è¦èŠ±å‡ ä¸ªå°æ—¶ï¼ˆå…·ä½“å¤šä¹…æ²¡æ•¢åœ¨ç”Ÿäº§æµ‹è¯•ï¼‰ã€‚ å¦‚æœæˆ‘ä»¬å¼ºè¡ŒæŒ‰ç…§æ—¶é—´è¿›è¡Œç­›é€‰ï¼Œå¯èƒ½æŸ¥è¯¢å‡º 4000W çš„æ•°æ®å°±å¾—èŠ±ä¸Šå¥½å‡ ä¸ªå°æ—¶ï¼›è¿™æ˜¾ç„¶æ˜¯è¡Œä¸é€šçš„ã€‚ äºæ˜¯æˆ‘ä»¬ä¾¿æƒ³åˆ°äº†ä¸€ä¸ªå¤§èƒ†çš„æƒ³æ³•ï¼šè¿™éƒ¨åˆ†æ•°æ®æ˜¯å¦å¯ä»¥ç›´æ¥ä¸è¦äº†ï¼Ÿ è¿™å¯èƒ½æ˜¯æœ€æœ‰æ•ˆåŠæœ€å¿«çš„æ–¹å¼äº†ï¼Œå’Œäº§å“æ²Ÿé€šåå¾—çŸ¥è¿™éƒ¨åˆ†æ•°æ®çœŸçš„åªæ˜¯æ—¥å¿—å‹çš„æ•°æ®ï¼Œå³ä¾¿æ˜¯æŠ¥è¡¨å‡ºä¸æ¥ä»Šåè¡¥ä¸Šä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ äºæ˜¯æˆ‘ä»¬å°±ç®€å•ç²—æš´çš„åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š ä¿®æ”¹åŸæœ‰è¡¨çš„è¡¨åï¼Œæ¯”å¦‚åŠ ä¸Š(_190416bak)ã€‚ å†æ–°å»ºä¸€å¼ å’ŒåŸæœ‰è¡¨åç§°ç›¸åŒçš„è¡¨ã€‚ è¿™æ ·æ–°çš„æ•°æ®å°±å†™åˆ°äº†æ–°è¡¨ï¼ŒåŒæ—¶ä¸šåŠ¡ä¸Šä¹Ÿæ˜¯ä½¿ç”¨çš„è¿™ä¸ªæ•°æ®é‡è¾ƒå°çš„æ–°è¡¨ã€‚ è™½è¯´è¿‡ç¨‹ä¸å¤ªä¼˜é›…ï¼Œä½†è‡³å°‘æ˜¯è§£å†³äº†é—®é¢˜åŒæ—¶ä¹Ÿç»™æˆ‘ä»¬åšæŠ€æœ¯æ”¹é€ é¢„ç•™äº†æ—¶é—´ã€‚ åˆ†è¡¨æ–¹æ¡ˆä¹‹å‰çš„æ–¹æ¡ˆè™½è¯´å¯ä»¥ç¼“è§£å‹åŠ›ï¼Œä½†ä¸èƒ½æ ¹æœ¬è§£å†³é—®é¢˜ã€‚ æœ‰äº›ä¸šåŠ¡å¿…é¡»å¾—æŸ¥è¯¢ä¹‹å‰çš„æ•°æ®ï¼Œå¯¼è‡´ä¹‹å‰é‚£æ‹›è¡Œä¸é€šäº†ï¼Œæ‰€ä»¥æ­£å¥½æˆ‘ä»¬å°±å€ŸåŠ©è¿™ä¸ªæœºä¼šæŠŠè¡¨åˆ†äº†ã€‚ æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººè™½è¯´æ²¡æœ‰åšè¿‡å®é™…åšè¿‡åˆ†è¡¨ï¼Œä½†ä¹Ÿè§è¿‡çŒªè·‘ï¼›ç½‘ä¸Šä¸€æœå„ç§æ–¹æ¡ˆå±‚å‡ºä¸ç©·ã€‚ æˆ‘è®¤ä¸ºæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯è¦ç»“åˆå®é™…ä¸šåŠ¡æ‰¾å‡ºéœ€è¦ sharding çš„å­—æ®µï¼ŒåŒæ—¶è¿˜æœ‰ä¸Šçº¿é˜¶æ®µçš„æ•°æ®è¿ç§»ä¹Ÿéå¸¸é‡è¦ã€‚ æ—¶é—´å¯èƒ½å¤§å®¶éƒ½ä¼šè¯´ç”¨ hash çš„æ–¹å¼åˆ†é…å¾—æœ€å‡åŒ€ï¼Œä½†æˆ‘è®¤ä¸ºè¿™è¿˜æ˜¯éœ€è¦ä½¿ç”¨å†å²æ•°æ®çš„åœºæ™¯æ‰ç”¨å“ˆå¸Œåˆ†è¡¨ã€‚ è€Œå¯¹äºä¸éœ€è¦å†å²æ•°æ®çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸šåŠ¡ä¸ŠåªæŸ¥è¯¢è¿‘ä¸‰ä¸ªæœˆçš„æ•°æ®ã€‚ è¿™ç±»éœ€æ±‚å®Œæˆå¯ä»¥é‡‡å–æ—¶é—´åˆ†è¡¨ï¼ŒæŒ‰ç…§æœˆä»½è¿›è¡Œåˆ’åˆ†ï¼Œè¿™æ ·æ”¹åŠ¨ç®€å•ï¼ŒåŒæ—¶å¯¹å†å²æ•°æ®ä¹Ÿæ¯”è¾ƒå¥½è¿ç§»ã€‚ äºæ˜¯æˆ‘ä»¬é¦–å…ˆå°†è¿™ç±»éœ€æ±‚çš„è¡¨ç­›é€‰å‡ºæ¥ï¼ŒæŒ‰ç…§æœˆä»½è¿›è¡Œæ‹†åˆ†ï¼Œåªæ˜¯åœ¨æŸ¥è¯¢çš„æ—¶å€™æ‹¼æ¥å¥½è¡¨åå³å¯ï¼›ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚ å“ˆå¸Œåˆšæ‰ä¹Ÿæåˆ°äº†ï¼šéœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œåˆ†è¡¨ç­–ç•¥ã€‚ è€Œä¸€æ—¦æ‰€æœ‰çš„æ•°æ®éƒ½æœ‰å¯èƒ½æŸ¥è¯¢æ—¶ï¼ŒæŒ‰ç…§æ—¶é—´åˆ†è¡¨ä¹Ÿå°±è¡Œä¸é€šäº†ã€‚ï¼ˆä¹Ÿèƒ½åšï¼Œåªæ˜¯å¦‚æœä¸æ˜¯æŒ‰ç…§æ—¶é—´è¿›è¡ŒæŸ¥è¯¢æ—¶éœ€è¦éå†æ‰€æœ‰çš„è¡¨ï¼‰ å› æ­¤æˆ‘ä»¬è®¡åˆ’é‡‡ç”¨ hash çš„æ–¹å¼åˆ†è¡¨ï¼Œè¿™ç®—æ˜¯ä¸šç•Œæ¯”è¾ƒä¸»æµçš„æ–¹å¼å°±ä¸å†èµ˜è¿°ã€‚ é‡‡ç”¨å“ˆå¸Œæ—¶éœ€è¦å°† sharding å­—æ®µé€‰å¥½ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡æ¯”è¾ƒå•çº¯ï¼›æ˜¯ä¸€ä¸ªç‰©è”ç½‘åº”ç”¨ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½åŒ…å«æœ‰ç‰©è”ç½‘è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼ˆIMEIï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå­—æ®µå¤©ç„¶çš„å°±ä¿æŒäº†å”¯ä¸€æ€§ï¼›å¤§å¤šæ•°çš„ä¸šåŠ¡ä¹Ÿéƒ½æ˜¯æ ¹æ®è¿™ä¸ªå­—æ®µæ¥çš„ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆæ¥åšè¿™ä¸ª sharding å­—æ®µã€‚ åœ¨åšåˆ†è¡¨ä¹‹å‰ä¹Ÿè°ƒç ”è¿‡ MyCAT åŠ sharding-jdbc(ç°å·²å‡çº§ä¸º shardingsphere)ï¼Œæœ€ç»ˆè€ƒè™‘åˆ°å¯¹å¼€å‘çš„å‹å¥½æ€§åŠä¸å¢åŠ è¿ç»´å¤æ‚åº¦è¿˜æ˜¯å†³å®šåœ¨ jdbc å±‚ sharding çš„æ–¹å¼ã€‚ ä½†ç”±äºå†å²åŸå› æˆ‘ä»¬å¹¶ä¸å¤ªå¥½é›†æˆ sharding-jdbcï¼Œä½†åŸºäº sharding çš„ç‰¹ç‚¹è‡ªå·±å®ç°äº†ä¸€ä¸ªåˆ†è¡¨ç­–ç•¥ã€‚ è¿™ä¸ªç®€å•ä¹Ÿå¥½ç†è§£ï¼š 123int index = hash(shardingå­—æ®µ) % åˆ†è¡¨æ•°é‡ ;select xx from 'busy_'+index where shardingå­—æ®µ = xxx; å…¶å®å°±æ˜¯ç®—å‡ºäº†è¡¨åï¼Œç„¶åè·¯ç”±è¿‡å»æŸ¥è¯¢å³å¯ã€‚ åªæ˜¯æˆ‘ä»¬å®ç°çš„éå¸¸ç®€å•ï¼šä¿®æ”¹äº†æ‰€æœ‰çš„åº•å±‚æŸ¥è¯¢æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½é‡Œéƒ½åšäº†è¿™æ ·çš„ä¸€ä¸ªåˆ¤æ–­ã€‚ å¹¶æ²¡æœ‰åƒ sharding-jdbc ä¸€æ ·ï¼Œä»£ç†äº†æ•°æ®åº“çš„æŸ¥è¯¢æ–¹æ³•ï¼›å…¶ä¸­è¿˜è¦åš SQLè§£æ-->SQLè·¯ç”±-->æ‰§è¡ŒSQL-->åˆå¹¶ç»“æœ è¿™ä¸€ç³»åˆ—çš„æµç¨‹ã€‚ å¦‚æœè‡ªå·±å†åšä¸€éæ— å¼‚äºé‡æ–°é€ äº†ä¸€ä¸ªè½®å­ï¼Œå¹¶ä¸”å¹¶ä¸ä¸“ä¸šï¼Œåªæ˜¯åœ¨ç°æœ‰çš„æŠ€æœ¯æ¡ä»¶ä¸‹é€‰æ‹©äº†ä¸€ä¸ªå¿«é€Ÿå®ç°è¾¾æˆæ•ˆæœçš„æ–¹æ³•ã€‚ ä¸è¿‡è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬èŠ‚çœäº†å°† sharding å­—æ®µå“ˆå¸Œçš„è¿‡ç¨‹ï¼Œå› ä¸ºæ¯ä¸€ä¸ª IMEI å·å…¶å®éƒ½æ˜¯ä¸€ä¸ªå”¯ä¸€çš„æ•´å‹ï¼Œç›´æ¥ç”¨å®ƒåš mod è¿ç®—å³å¯ã€‚ è¿˜æœ‰ä¸€ä¸ªæ˜¯éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„ç»„ä»¶ç”Ÿæˆè§„åˆ™ï¼Œåˆ†è¡¨åä¸èƒ½å†ä¾èµ–äºå•è¡¨çš„å­—æ®µè‡ªå¢äº†ï¼›æ–¹æ³•è¿˜æ˜¯æŒºå¤šçš„ï¼š æ¯”å¦‚æ—¶é—´æˆ³+éšæœºæ•°å¯æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡ã€‚ UUIDï¼Œç”Ÿæˆç®€å•ï¼Œä½†æ²¡æ³•åšæ’åºã€‚ é›ªèŠ±ç®—æ³•ç»Ÿä¸€ç”Ÿæˆä¸»é”®IDã€‚ å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µåšé€‰æ‹©ã€‚ ä¸šåŠ¡è°ƒæ•´å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ sharding-jdbc ç»„ä»¶ï¼Œæ‰€æœ‰æ²¡æœ‰åŠæ³•åšåˆ°å¯¹ä»£ç çš„ä½ä¾µå…¥æ€§ï¼›æ¯ä¸ªæ¶‰åŠåˆ°åˆ†è¡¨çš„ä¸šåŠ¡ä»£ç éƒ½éœ€è¦åšåº•å±‚æ–¹æ³•çš„æ”¹é€ ï¼ˆä¹Ÿå°±æ˜¯è·¯ç”±åˆ°æ­£ç¡®çš„è¡¨ï¼‰ã€‚ è€ƒè™‘åˆ°åç»­ä¸šåŠ¡çš„å‘å±•ï¼Œæˆ‘ä»¬å†³å®šå°†æ‹†åˆ†çš„è¡¨åˆ†ä¸º 64 å¼ ï¼›åŠ ä¸Šåç»­å¼•å…¥å¤§æ•°æ®å¹³å°è¶³ä»¥åº”å¯¹å‡ å¹´çš„æ•°æ®å¢é•¿ã€‚ è¿™é‡Œè¿˜æœ‰ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼šåˆ†è¡¨çš„æ•°é‡éœ€è¦ä¸º 2âˆ§N æ¬¡æ–¹ï¼Œå› ä¸ºåœ¨å–æ¨¡çš„è¿™ç§åˆ†è¡¨æ–¹å¼ä¸‹ï¼Œå³ä¾¿æ˜¯ä»Šåå†éœ€è¦åˆ†è¡¨å½±å“çš„æ•°æ®ä¹Ÿä¼šå°½é‡çš„å°ã€‚ å†ä¿®æ”¹æ—¶åªèƒ½å°†è¡¨åç§°è¿›è¡Œå…¨å±€æœç´¢ï¼Œç„¶ååŠ ä»¥ä¿®æ”¹ï¼ŒåŒæ—¶æ ¹æ®ä¿®æ”¹çš„æ–¹æ³•å€’æ¨åˆ°è¡¨ç°çš„ä¸šåŠ¡å¹¶è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿åç»­å›å½’æµ‹è¯•ã€‚ å½“ç„¶æ— æ³•é¿å…æŸ¥è¯¢æ—¶åˆ©ç”¨é sharding å­—æ®µå¯¼è‡´çš„å…¨è¡¨æ‰«æï¼Œè¿™æ˜¯æ‰€æœ‰åˆ†ç‰‡åéƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚ å› æ­¤æˆ‘ä»¬åœ¨ä¿®æ”¹åˆ†è¡¨æ–¹æ³•çš„åº•å±‚æŸ¥è¯¢æ—¶åŒæ—¶ä¹Ÿä¼šæŸ¥çœ‹æ˜¯å¦æœ‰èµ°åˆ†ç‰‡å­—æ®µï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£æ˜¯å¦å¯ä»¥è°ƒæ•´ä¸šåŠ¡ã€‚ æ¯”å¦‚å¯¹äºä¸€ä¸ªä¸Šäº¿çš„æ•°æ®æ˜¯å¦è¿˜æœ‰å¿…è¦å­˜åœ¨æŒ‰ç…§åˆ†é¡µæŸ¥è¯¢ã€æ—¥æœŸæŸ¥è¯¢ï¼Ÿè¿™æ ·çš„ä¸šåŠ¡æ˜¯å¦çœŸçš„å…·æœ‰æ„ä¹‰ï¼Ÿ æˆ‘ä»¬å°½å¯èƒ½çš„å¼•å¯¼äº§å“æŒ‰ç…§è¿™æ ·çš„æ–¹å¼æ¥è®¾è®¡äº§å“æˆ–è€…åšå‡ºè°ƒæ•´ã€‚ ä½†å¯¹äºæŠ¥è¡¨è¿™ç±»çš„éœ€æ±‚ç¡®å®ä¹Ÿæ²¡åŠæ³•ï¼Œæ¯”å¦‚ç»Ÿè®¡è¡¨ä¸­æŸç§ç±»å‹çš„æ•°æ®ï¼›è¿™ç§æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼å»å¹¶è¡ŒæŸ¥è¯¢ç„¶åæ±‡æ€»ç»Ÿè®¡æ¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ æœ‰æ—¶ä¹Ÿæœ‰ä¸€äº›å¦ç±»åœºæ™¯ï¼š æ¯”å¦‚ä¸€ä¸ªåƒä¸‡è¡¨ä¸­æœ‰æŸä¸€ç‰¹æ®Šç±»å‹çš„æ•°æ®åªå äº†å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚è¯´å‡ åƒä¸Šä¸‡æ¡ã€‚ è¿™æ—¶é¡µé¢ä¸Šéœ€è¦å¯¹å®ƒè¿›è¡Œåˆ†é¡µæŸ¥è¯¢æ˜¯æ¯”è¾ƒæ­£å¸¸çš„ï¼ˆæ¯”å¦‚æŸç§æŠ•è¯‰æ¶ˆæ¯ï¼Œå®¢æˆ·éœ€è¦ä¸€æ¡ä¸€æ¡çš„å•ç‹¬å¤„ç†ï¼‰ï¼Œä½†å¦‚æœæˆ‘ä»¬æŒ‰ç…§ IMEI å·æˆ–è€…æ˜¯ä¸»é”®è¿›è¡Œåˆ†ç‰‡åå†åˆ†é¡µæŸ¥è¯¢é‚£å°±æ¯”è¾ƒè›‹ç–¼äº†ã€‚ æ‰€ä»¥è¿™ç±»å‹çš„æ•°æ®å»ºè®®å•ç‹¬æ–°å»ºä¸€å¼ è¡¨æ¥ç»´æŠ¤ï¼Œä¸è¦å’Œå…¶ä»–æ•°æ®æ··åˆåœ¨ä¸€èµ·ï¼Œè¿™æ ·ä¸ç®¡æ˜¯åšåˆ†é¡µè¿˜æ˜¯ like éƒ½æ¯”è¾ƒç®€å•å’Œç‹¬ç«‹ã€‚ éªŒè¯ä»£ç æ”¹å®Œï¼Œå¼€å‘ä¹Ÿå•æµ‹å®Œæˆåæ€ä¹ˆæ¥éªŒè¯åˆ†è¡¨çš„ä¸šåŠ¡æ˜¯å¦æ­£å¸¸ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚ ä¸€ä¸ªæ˜¯æµ‹è¯•éº»çƒ¦ï¼Œå†ä¸€ä¸ªæ˜¯ä¸‡ä¸€å“ªé‡Œæ”¹æ¼äº†è¿˜æ˜¯æŸ¥è¯¢çš„åŸè¡¨ï¼Œä½†è¿™æ ·åœ¨æµ‹è¯•ç¯å¢ƒå¹¶ä¸ä¼šæœ‰å¼‚å¸¸ï¼Œä¸€æ—¦ä¸Šçº¿äº§ç”Ÿäº†ç”Ÿäº§æ•°æ®åˆ°æ–°çš„ 64 å¼ è¡¨åæƒ³è¦å†ä¿®å¤å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬å–äº†ä¸ªå·§ï¼Œç›´æ¥å°†åŸè¡¨çš„è¡¨åä¿®æ”¹ï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªåç¼€ï¼›è¿™æ ·åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­è§‚å¯Ÿå‰åå°æœ‰æ— æŠ¥é”™å°±æ¯”è¾ƒå®¹æ˜“æå‰å‘ç°è¿™ä¸ªé—®é¢˜ã€‚ ä¸Šçº¿æµç¨‹æµ‹è¯•éªŒæ”¶é€šè¿‡ååªæ˜¯åˆ†è¡¨è¿™ä¸ªéœ€æ±‚çš„80%ï¼Œå‰©ä¸‹å¦‚ä½•ä¸Šçº¿ä¹Ÿæ˜¯æ¯”è¾ƒå¤´ç–¼ã€‚ ä¸€æ—¦åº”ç”¨ä¸Šçº¿åæ‰€æœ‰çš„æŸ¥è¯¢ã€å†™å…¥ã€åˆ é™¤éƒ½ä¼šå…ˆèµ°è·¯ç”±ç„¶ååˆ°è¾¾æ–°è¡¨ï¼›è€Œè€æ•°æ®åœ¨åŸè¡¨é‡Œæ˜¯ä¸ä¼šå‘ç”Ÿæ”¹å˜çš„ã€‚ æ•°æ®è¿ç§»æ‰€ä»¥æˆ‘ä»¬ä¸Šçº¿å‰çš„ç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯éœ€è¦å°†åŸæœ‰çš„æ•°æ®è¿›è¡Œè¿ç§»ï¼Œè¿ç§»çš„ç›®çš„æ˜¯è¦åˆ†ç‰‡åˆ°æ–°çš„ 64 å¼ è¡¨ä¸­ï¼Œè¿™æ ·æ‰ä¼šå¯¹åŸæœ‰çš„ä¸šåŠ¡æ— å½±å“ã€‚ å› æ­¤æˆ‘ä»¬éœ€è¦é¢å¤–å‡†å¤‡ä¸€ä¸ªç¨‹åºï¼Œå®ƒéœ€è¦å°†è€è¡¨é‡Œçš„æ•°æ®æŒ‰ç…§åˆ†ç‰‡è§„åˆ™å¤åˆ¶åˆ°æ–°è¡¨ä¸­ï¼› åœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œç”Ÿäº§æ•°æ®æœ‰äº›å·²ç»ä¸Šäº¿äº†ï¼Œè¿™ä¸ªè¿ç§»è¿‡ç¨‹æˆ‘ä»¬åœ¨æµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿå‘ç°è€—æ—¶æ˜¯éå¸¸ä¹…çš„ã€‚è€Œä¸”æˆ‘ä»¬è€è¡¨ä¸­å¯¹äº create_time è¿™æ ·ç”¨äºç­›é€‰æ•°æ®çš„å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼ˆä»¥å‰çš„æŠ€æœ¯å€ºï¼‰ï¼Œæ‰€ä»¥æŸ¥è¯¢èµ·æ¥å°±æ›´åŠ æ…¢äº†ã€‚ æœ€åæ²¡åŠæ³•ï¼Œæˆ‘ä»¬åªèƒ½å’Œäº§å“åå•†å‘ŠçŸ¥ç”¨æˆ·å¯¹äºä¹‹å‰äº§ç”Ÿçš„æ•°æ®çŸ­æœŸå¯èƒ½ä¼šæŸ¥è¯¢ä¸åˆ°ï¼Œè¿™ä¸ªæ—¶é—´æœ€åå¯èƒ½ä¼šæŒç»­å‡ å¤©ï¼ˆæˆ‘ä»¬åªèƒ½åœ¨å‡Œæ™¨è¿ç§»ï¼Œç™½å¤©ä¼šå½±å“åˆ°æ•°æ®åº“è´Ÿè½½ï¼‰ã€‚ æ€»ç»“è¿™ä¾¿æ˜¯æˆ‘ä»¬è¿™æ¬¡çš„åˆ†è¡¨å®è·µï¼Œè™½è¯´ä¸å°‘è¿‡ç¨‹éƒ½ä¸ä¼˜é›…ï¼Œä½†å—é™äºæ¡ä»¶ä¹Ÿåªèƒ½æŠ˜ä¸­å¤„ç†ã€‚ ä½†æˆ‘ä»¬åç»­çš„è®¡åˆ’æ˜¯ï¼Œä¿®æ”¹æˆ‘ä»¬åº•å±‚çš„æ•°æ®è¿æ¥ï¼ˆç›®å‰æ˜¯è‡ªå·±å°è£…çš„ä¸€ä¸ª jar åŒ…ï¼Œå¯¼è‡´é›†æˆ sharding-jdbc æ¯”è¾ƒéº»çƒ¦ï¼‰æœ€ç»ˆé€æ¸è¿ç§»åˆ° sharding-jdbc . æœ€åå¾—å‡ºäº†å‡ ä¸ªç»“è®ºï¼š ä¸€ä¸ªå¥½çš„äº§å“è§„åˆ’éå¸¸æœ‰å¿…è¦ï¼Œå¯ä»¥åœ¨åˆç†çš„æ—¶é—´å¯¹æ•°æ®å¤„ç†ï¼ˆä¸ç®¡æ˜¯åˆ†è¡¨è¿˜æ˜¯åˆ‡å…¥å½’æ¡£ï¼‰ã€‚ æ¯å¼ è¡¨éƒ½éœ€è¦ä¸€ä¸ªå¯ä»¥ç”¨äºæ’åºæŸ¥è¯¢çš„å­—æ®µï¼ˆè‡ªå¢IDã€åˆ›å»ºæ—¶é—´ï¼‰ï¼Œæ•´ä¸ªè¿‡ç¨‹ç”±äºæ²¡æœ‰è¿™ä¸ªå­—æ®µå¯¼è‡´è€½æäº†å¾ˆé•¿æ—¶é—´ã€‚ åˆ†è¡¨å­—æ®µéœ€è¦è°¨æ…ï¼Œè¦å…¨ç›˜çš„è€ƒè™‘ä¸šåŠ¡æƒ…å†µï¼Œå°½é‡é¿å…å‡ºç°æŸ¥è¯¢æ‰«è¡¨çš„æƒ…å†µã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL5.7 GTIDåŸç†ä¸å®æˆ˜]]></title>
    <url>%2F2019%2F04%2F22%2Fmysql-GTID%2F</url>
    <content type="text"><![CDATA[å·¥ä½œå¤šå¹´ï¼Œå½“äººå®¶é—®ä½ æ˜¯ä¸æ˜¯åˆå…¥ç¤¾ä¼šï¼Œä¸æ˜¯å› ä¸ºä½ çœ‹èµ·æ¥å¹´è½»ï¼Œè€Œæ˜¯å› ä¸ºè§‰å¾—ä½ æ€ä¹ˆè¿™ä¹ˆç¬¨ã€‚ å‰è¨€GTIDæ˜¯ä»€ä¹ˆï¼ŸGTID æ˜¯Global Transaction Identifiersçš„ç¼©å†™ï¼Œç®€ç§°GTID GTIDç»„æˆå’Œæ¶æ„1) GTID = source_id:transaction_id2) server_uuid æ¥æºäº auto.cnf13E11FA47-71CA-11E1-9E33-C80AA9429562 3) GTID: åœ¨ä¸€ç»„å¤åˆ¶ä¸­ï¼Œå…¨å±€å”¯ä¸€ The syntax for a GTID set is as follows:1234567891011121314151617gtid_set: uuid_set [, uuid_set] ... | ''uuid_set: uuid:interval[:interval]...uuid: hhhhhhhh-hhhh-hhhh-hhhh-hhhhhhhhhhhhh: [0-9|A-F]interval: n[-n] (n >= 1) mysql.gtid_executedè¡¨çš„å‹ç¼©ç”±åä¸ºthread/sql/compress_gtid_tableçš„ä¸“ç”¨å‰å°çº¿ç¨‹æ‰§è¡Œã€‚ æ­¤çº¿ç¨‹æœªåœ¨SHOW PROCESSLISTçš„è¾“å‡ºä¸­åˆ—å‡ºï¼Œä½†å¯ä»¥å°†å…¶è§†ä¸ºçº¿ç¨‹è¡¨ä¸­çš„ä¸€è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š12345678910111213141516171819mysql> SELECT * FROM performance_schema.threads WHERE NAME LIKE '%gtid%'\G*************************** 1. row *************************** THREAD_ID: 26 NAME: thread/sql/compress_gtid_table TYPE: FOREGROUND PROCESSLIST_ID: 1 PROCESSLIST_USER: NULL PROCESSLIST_HOST: NULL PROCESSLIST_DB: NULLPROCESSLIST_COMMAND: Daemon PROCESSLIST_TIME: 1509 PROCESSLIST_STATE: Suspending PROCESSLIST_INFO: NULL PARENT_THREAD_ID: 1 ROLE: NULL INSTRUMENTED: YES HISTORY: YES CONNECTION_TYPE: NULL THREAD_OS_ID: 18677 GTIDå’ŒBinlogçš„å…³ç³» GTIDåœ¨binlogä¸­çš„ç»“æ„ GTID event ç»“æ„ Previous_gtid_log_event Previous_gtid_log_event åœ¨æ¯ä¸ªbinlog å¤´éƒ¨éƒ½ä¼šæœ‰ æ¯æ¬¡binlog rotateçš„æ—¶å€™å­˜å‚¨åœ¨binlogå¤´éƒ¨ Previous-GTIDsåœ¨binlogä¸­åªä¼šå­˜å‚¨åœ¨è¿™å°æœºå™¨ä¸Šæ‰§è¡Œè¿‡çš„æ‰€æœ‰binlogï¼Œä¸åŒ…æ‹¬æ‰‹åŠ¨è®¾ç½®gtid_purgedå€¼ã€‚ æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ æ‰‹åŠ¨set global gtid_purged=xx; é‚£ä¹ˆxxæ˜¯ä¸ä¼šè®°å½•åœ¨Previous_gtid_log_eventä¸­çš„ã€‚ GTIDå’ŒBinlogä¹‹é—´çš„å…³ç³»æ˜¯æ€ä¹ˆå¯¹åº”çš„å‘¢ å¦‚ä½•æ‰èƒ½æ‰¾åˆ°GTID=?å¯¹åº”çš„binlogæ–‡ä»¶å‘¢ï¼Ÿ12345678* å‡è®¾æœ‰4ä¸ªbinlog: bin.001,bin.002,bin.003,bin.004* bin.001 : Previous-GTIDs=empty; binlog_eventæœ‰ï¼š1-40 * bin.002 : Previous-GTIDs=1-40; binlog_eventæœ‰ï¼š41-80 * bin.003 : Previous-GTIDs=1-80; binlog_eventæœ‰ï¼š81-120 * bin.004 : Previous-GTIDs=1-120; binlog_eventæœ‰ï¼š121-160 1. å‡è®¾ç°åœ¨æˆ‘ä»¬è¦æ‰¾GTID=$Aï¼Œé‚£ä¹ˆMySQLçš„æ‰«æé¡ºåºä¸ºï¼š ä»æœ€åä¸€ä¸ªbinlogå¼€å§‹æ‰«æï¼ˆå³ï¼šbin.004ï¼‰ 2. bin.004çš„Previous-GTIDs=1-120ï¼Œå¦‚æœ$A=140 > Previous-GTIDs,é‚£ä¹ˆè‚¯å®šåœ¨bin.004ä¸­ 3. bin.004çš„Previous-GTIDs=1-120ï¼Œå¦‚æœ$A=88 åŒ…å«åœ¨Previous-GTIDsä¸­,é‚£ä¹ˆç»§ç»­å¯¹æ¯”ä¸Šä¸€ä¸ªbinlogæ–‡ä»¶ bin.003,ç„¶åå†å¾ªç¯å‰é¢2ä¸ªæ­¥éª¤ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ é‡è¦å‚æ•°çš„æŒä¹…åŒ– GTIDç›¸å…³å‚æ•° variables comment gtid_executed æ‰§è¡Œè¿‡çš„æ‰€æœ‰GTID gtid_purged ä¸¢å¼ƒæ‰çš„GTID gtid_mode gtidæ¨¡å¼ gtid_next sessionçº§åˆ«çš„å˜é‡ï¼Œä¸‹ä¸€ä¸ªgtid gtid_owned æ­£åœ¨è¿è¡Œçš„gtid enforce_gtid_consistency ä¿è¯GTIDå®‰å…¨çš„å‚æ•° é‡è¦å‚æ•°å¦‚ä½•æŒä¹…åŒ– å¦‚ä½•æŒä¹…åŒ–gtid_executed [ log-bin=on,log_slave_update=on ]123gtid_executed = mysql.gtid_executed #[normal]orgtid_executed = mysql.gtid_executed + last_binlog ä¸­æœ€åæ²¡å†™åˆ°mysql.gtid_executedä¸­çš„gtid_event #[recover] å¦‚ä½•æŒä¹…åŒ–é‡ç½®çš„gtid_purgedå€¼?12reset master;set global gtid_purged='$A:a-b'; 12341. ç”±äºæœ‰å¯èƒ½æ‰‹åŠ¨è®¾ç½®è¿‡gtid_purged=$A:a-b, binlog.indexä¸­ï¼Œlast_binlogçš„Previous-GTIDså¹¶ä¸ä¼šåŒ…å«$A:a-b 2. ç”±äºæœ‰å¯èƒ½æ‰‹åŠ¨è®¾ç½®è¿‡gtid_purged=$A:a-b, binlog.indexä¸­ï¼Œfirst_binlogçš„Previous-GTIDsè‚¯å®šä¸ä¼šå‡ºç°$A:a-b 3. é‡ç½®çš„gtid_purged = @@global.gtid_executed(mysql.gtid_executed:æ³¨æ„ï¼Œè€ƒè™‘åˆ°è¿™ä¸ªè¡¨çš„æ›´æ–°è§¦å‘æ¡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œç”¨@@global.gtid_executedä»£æ›¿) - last_binlogçš„Previous-GTIDs - last_binlogæ‰€æœ‰çš„gtid_event 4. ä¸‹é¢å°±ç”¨ $reset_gtid_purged æ¥è¡¨ç¤ºé‡ç½®çš„gtid å¦‚ä½•æŒä¹…åŒ–gtid_purged [ log-bin=on,log_slave_update=on ]1gtid_purged=binlog.index:first_binlogçš„Previous-GTIDs + $reset_gtid_purged å¼€å¯GTIDçš„å¿…å¤‡æ¡ä»¶ MySQL 5.6 1234gtid_mode=ON (å¿…é€‰) log_bin=ON (å¿…é€‰) log-slave-updates=ON (å¿…é€‰) enforce-gtid-consistency (å¿…é€‰) MySQL 5.7 MySQL5.7.13 or higher 1234gtid_mode=ON (å¿…é€‰) enforce-gtid-consistency ï¼ˆå¿…é€‰ï¼‰log_bin=ON ï¼ˆå¯é€‰ï¼‰--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON log-slave-updates=ON ï¼ˆå¯é€‰ï¼‰--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON æ–°çš„å¤åˆ¶åè®® COM_BINLOG_DUMP_GTID slaveä¼šå°†å·²ç»æ‰§è¡Œè¿‡çš„gtidï¼Œä»¥åŠä»¥åŠæ¥å—åˆ°relay logä¸­çš„gtidçš„å¹¶é›†å‘é€ç»™master 12* http://dev.mysql.com/doc/refman/5.7/en/change-master-to.htmlUNION(@@global.gtid_executed, Retrieved_gtid_set - last_received_GTID) Master send all other transactions to slave åŒæ ·çš„GTIDä¸èƒ½è¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œå¦‚æœæœ‰åŒæ ·çš„GTIDï¼Œä¼šè‡ªåŠ¨è¢«skipæ‰ã€‚ - slave1 : å°†è‡ªèº«çš„UUID1:1 å‘é€ç»™ masterï¼Œç„¶åæ¥æ”¶åˆ°äº† UUID1:2,UUID1:3 event - slave2 : å°†è‡ªèº«çš„UUID1:1,UUID1:2 å‘é€ç»™ masterï¼Œç„¶åæ¥æ”¶åˆ°äº†UUID1:3 event GTIDé‡è¦å‡½æ•°å’Œæ–°è¯­æ³• é‡è¦å‡½æ•° Name Description GTID_SUBSET(subset, set) returns true (1) if all GTIDs in subset are also in set GTID_SUBTRACT(set,subset) returns only those GTIDs from set that are not in subset WAIT_FOR_EXECUTED_GTID_SET(gtid_set[, timeout]) Wait until the given GTIDs have executed on slave. WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS(gtid_set[, timeout][,channel]) Wait until the given GTIDs have executed on slave. æ–°è¯­æ³• 12345678910START SLAVE [thread_types] [until_option] [connection_options]thread_types: [thread_type [, thread_type] ... ]thread_type: IO_THREAD | SQL_THREADuntil_option: UNTIL { {SQL_BEFORE_GTIDS | SQL_AFTER_GTIDS} = gtid_set | MASTER_LOG_FILE = 'log_name', MASTER_LOG_POS = log_pos | RELAY_LOG_FILE = 'log_name', RELAY_LOG_POS = log_pos | SQL_AFTER_MTS_GAPS } ä¸¾ä¸ªæ —å­: START SLAVE SQL_THREAD UNTIL SQL_BEFORE_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56 è¡¨ç¤ºï¼Œå½“SQL_thread æ‰§è¡Œåˆ°3E11FA47-71CA-11E1-9E33-C80AA9429562:10 çš„æ—¶å€™åœæ­¢ï¼Œä¸‹ä¸€ä¸ªäº‹åŠ¡æ˜¯11 START SLAVE SQL_THREAD UNTIL SQL_AFTER_GTIDS = 3E11FA47-71CA-11E1-9E33-C80AA9429562:11-56 è¡¨ç¤ºï¼Œå½“SQL_thread æ‰§è¡Œåˆ°3E11FA47-71CA-11E1-9E33-C80AA9429562:56 çš„æ—¶å€™åœæ­¢ï¼Œ56æ˜¯æœ€åä¸€ä¸ªæäº¤çš„äº‹åŠ¡ã€‚ GTIDæœ‰ä»€ä¹ˆå¥½å¤„classic replication [è¿ç»´ä¹‹ä¼¤] GTID replication [so easy] GTIDçš„Limitation ä¸å®‰å…¨çš„äº‹åŠ¡1è®¾ç½®enforce-gtid-consistency=ON 1231. CREATE TABLE ... SELECT statements 2. CREATE TEMPORARY TABLE or DROP TEMPORARY TABLE statements inside transactions3. åŒæ—¶æ›´æ–° äº‹åŠ¡å¼•æ“ å’Œ éäº‹åŠ¡å¼•æ“ã€‚ MySQL5.7 GTID crash-safeå…³äº GTID crash safe å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£åˆ—å‡ºçš„å®‰å…¨é…ç½® å•çº¿ç¨‹å¤åˆ¶Non-GTID æ¨èé…ç½®: relay_log_recovery=1 relay_log_info_repository=TABLE master_info_repository=TABLE GTID æ¨èé…ç½®: * MASTER_AUTO_POSITION=on * relay_log_recovery=0 å¤šçº¿ç¨‹å¤åˆ¶Non-GTID æ¨èé…ç½®: relay_log_recovery=1 sync_relay_log=1 relay_log_info_repository=TABLE master_info_repository=TABLEGTID æ¨èé…ç½®: MASTER_AUTO_POSITION=on relay_log_recovery=0 å®æˆ˜ä½¿ç”¨GTIDæ­å»ºReplicationä»0å¼€å§‹æ­å»º step 1: è®©æ‰€æœ‰serverå¤„äºåŒä¸€ä¸ªç‚¹ 1mysql> SET @@global.read_only = ON; step 2: å…³é—­æ‰€æœ‰MySQL 1shell> mysqladmin -uusername -p shutdown step 3: é‡å¯æ‰€æœ‰MySQLï¼Œå¹¶å¼€å¯GTID 1shell> mysqld --gtid-mode=ON --log-bin --enforce-gtid-consistency & å½“ç„¶ï¼Œåœ¨my.cnfä¸­é…ç½®å¥½æœ€ä½³ step 4: change master 123mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10; mysql> START SLAVE; step 5: è®©master å¯è¯»å¯å†™ 1mysql> SET @@global.read_only = OFF; ä»å¤‡ä»½ä¸­æ¢å¤&æ­å»º step 1: å¤‡ä»½ 123mysqldump xx è·å–å¹¶ä¸”è®°å½•gtid_purgedå€¼ orå†·å¤‡ä»½ --è·å–å¹¶ä¸”è®°å½•gtid_executedå€¼ï¼Œè¿™ä¸ªå°±ç›¸å½“äºmysqldumpä¸­å¾—åˆ°çš„gtid_purged step 2: åœ¨æ–°æœåŠ¡å™¨ä¸Šreset masterï¼Œå¯¼å…¥å¤‡ä»½ 123reset master; --æ¸…ç©ºgtidä¿¡æ¯ å¯¼å…¥å¤‡ä»½ï¼› --å¦‚æœæ˜¯é€»è¾‘å¯¼å…¥ï¼Œè¯·è®¾ç½®sql_log_bin=off set global gtid_purged='xx'; step 3: change master 123mysql> CHANGE MASTER TO MASTER_HOST = host, MASTER_PORT = port, MASTER_USER = user, MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1, MASTER_CONNECT_RETRY=10; mysql> START SLAVE; å¦‚ä½•ä»classic replication å‡çº§æˆ GTID replicationoffline æ–¹å¼å‡çº§offline çš„æ–¹å¼å‡çº§æœ€ç®€å•ã€‚å…¨éƒ¨å…³æœºï¼Œç„¶åé…ç½®å¥½GTIDï¼Œé‡å¯ï¼ŒCHANGE MASTER TO MASTER_AUTO_POSITION=1ã€‚ online æ–¹å¼å‡çº§è¿™é‡Œå…ˆä»‹ç»å‡ ä¸ªé‡è¦GTID_MODEçš„value GTID_MODE = OFF ä¸äº§ç”ŸNormal_GTIDï¼Œåªæ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID GTID_MODE = OFF_PERMISSIVE ä¸äº§ç”ŸNormal_GTIDï¼Œå¯ä»¥æ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID & Normal_GTID GTID_MODE = ON_PERMISSIVE äº§ç”ŸNormal_GTIDï¼Œå¯ä»¥æ¥å—æ¥è‡ªmasterçš„ANONYMOUS_GTID & Normal_GTID GTID_MODE = ON äº§ç”ŸNormal_GTIDï¼Œåªæ¥å—æ¥è‡ªmasterçš„Normal_GTID masterå’Œslaveçš„gtid_mode ç»„åˆæ­é…çŸ©é˜µå›¾ æ°´å¹³çš„GTID_MODEä¸ºï¼šmaster å‚ç›´çš„GTID_MODEä¸ºï¼šslave gtid_mode OFF(master) OFF_PERMISSIVE(master) ON_PERMISSIVE(master) ON(master) OFF(slave) Y Y N N OFF_PERMISSIVE(slave) Y Y Y Y(auto_positionå¯ä»¥å¼€å¯) ON_PERMISSIVE(slave) Y Y Y Y(auto_positionå¯ä»¥å¼€å¯) ON(slave) N N Y Y(auto_positionå¯ä»¥å¼€å¯) å½’çº³æ€»ç»“ï¼š å½“masteräº§ç”ŸNormal_GTIDçš„æ—¶å€™ï¼ˆON_PERMISSIVEï¼ŒONï¼‰ï¼Œå¦‚æœslaveçš„gtid_modeï¼ˆOFFï¼‰ä¸èƒ½æ¥å—Normal_GTIDï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™ å½“masteräº§ç”ŸANONYMOUS_GTIDçš„æ—¶å€™ï¼ˆOFF_PERMISSIVEï¼ŒOFFï¼‰ï¼Œå¦‚æœslaveçš„gtid_modeï¼ˆONï¼‰ä¸èƒ½æ¥å—ANONYMOUS_GTIDï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™ è®¾ç½®auto_positionçš„æ¡ä»¶ï¼š å½“master gtid_mode=ONæ—¶ï¼Œslaveå¯ä»¥ä¸ºOFF_PERMISSIVEï¼ŒON_PERMISSIVEï¼ŒONã€‚é™¤æ­¤ä¹‹å¤–ï¼Œéƒ½ä¸èƒ½è®¾ç½®auto_position = on ä¸‹é¢ç½—åˆ—ä¸‹ï¼Œå¦‚ä½•online å‡çº§ä¸ºGTIDæ¨¡å¼ã€‚ step 1: æ¯å°serveræ‰§è¡Œ æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼Œç›´åˆ°æ²¡æœ‰é”™è¯¯å‡ºç°ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ 1SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN; step 2: æ¯å°serveræ‰§è¡Œ 1SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON; step 3: æ¯å°serveræ‰§è¡Œ ä¸ç”¨å…³å¿ƒä¸€ç»„å¤åˆ¶é›†ç¾¤çš„serverçš„æ‰§è¡Œé¡ºåºï¼Œåªéœ€è¦ä¿è¯æ¯ä¸ªServeréƒ½æ‰§è¡Œäº†ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ 1SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE; step 4: æ¯å°serveræ‰§è¡Œ ä¸ç”¨å…³å¿ƒä¸€ç»„å¤åˆ¶é›†ç¾¤çš„serverçš„æ‰§è¡Œé¡ºåºï¼Œåªéœ€è¦ä¿è¯æ¯ä¸ªServeréƒ½æ‰§è¡Œäº†ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ 1SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE; step 5: åœ¨æ¯å°serverä¸Šæ‰§è¡Œï¼Œå¦‚æœONGOING_ANONYMOUS_TRANSACTION_COUNT=0å°±å¯ä»¥ ä¸éœ€è¦ä¸€ç›´ä¸º0ï¼Œåªè¦å‡ºç°è¿‡0ä¸€æ¬¡ï¼Œå°±ok 1SHOW STATUS LIKE 'ONGOING_ANONYMOUS_TRANSACTION_COUNT'; step 6ï¼š ç¡®ä¿æ‰€æœ‰anonymousäº‹åŠ¡ä¼ é€’åˆ°slaveä¸Šäº† master 1SHOW MASTER STATUS; æ¯ä¸ªslave 1SELECT MASTER_POS_WAIT(file, position); æˆ–è€…ï¼Œç­‰ä¸€æ®µæ—¶é—´ï¼Œåªè¦ä¸æ˜¯å¤§çš„å»¶è¿Ÿï¼Œä¸€èˆ¬éƒ½æ²¡é—®é¢˜ step 7: æ¯å°Serverä¸Šæ‰§è¡Œ 1SET @@GLOBAL.GTID_MODE = ON; step 8: åœ¨æ¯å°serverä¸Šå°†my.cnfä¸­æ·»åŠ å¥½gtidé…ç½® 1234gtid_mode=ON (å¿…é€‰) enforce-gtid-consistency (å¿…é€‰)log_bin=ON (å¯é€‰)--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON log-slave-updates=ON (å¯é€‰)--é«˜å¯ç”¨åˆ‡æ¢ï¼Œæœ€å¥½è®¾ç½®ON step 9: change master 123STOP SLAVE; CHANGE MASTER TO MASTER_AUTO_POSITION = 1; START SLAVE; GTID failoverMySQL crash> é…ç½®å¥½loss-less semi-sync replicationï¼Œå¯ä»¥æ›´å¯é çš„ä¿è¯æ•°æ®é›¶ä¸¢å¤±ã€‚ ä»¥ä¸‹è¯´çš„éƒ½æ˜¯crash åï¼Œèµ·ä¸æ¥çš„æƒ…å†µ binlog åœ¨masterè¿˜æœ‰æ—¥å¿—æ²¡æœ‰ä¼ é€’åˆ° slave123456781. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_position åŒæ­¥å¥½ 2. mysqlbinlog å°†æ²¡ä¼ é€’è¿‡æ¥çš„binlogåœ¨æ–°masterä¸Šreplay 3. æ‰“å¼€æ–° master çš„ SET GLOBAL surper_read_only=off;``` * binlog å·²ç»ä¼ é€’åˆ°slave```bash1. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_positionåŒæ­¥å¥½ 2. æ‰“å¼€æ–°masterçš„ SET GLOBAL surper_read_only=off; OS crash121. é€‰å–æœ€æ–°çš„slave, CHANGE MASTER TO maseter_auto_positionåŒæ­¥å¥½ 2. æ‰“å¼€æ–°masterçš„ SET GLOBAL surper_read_only=off; ä»¥ä¸Šæ“ä½œï¼Œåœ¨ä¼ ç»Ÿæ¨¡å¼å¤åˆ¶ä¸‹ï¼Œåªèƒ½é€šè¿‡MHAæ¥å®ç°ï¼ŒMHAæ¯”è¾ƒå¤æ‚ã€‚ ç°åœ¨ï¼Œåœ¨GTIDæ¨¡å¼ä¸‹ï¼Œå®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œä¸”éå¸¸æ–¹ä¾¿ã€‚ GTID è¿ç»´å’Œé”™è¯¯å¤„ç† ä½¿ç”¨GTIDåï¼Œå¯¹åŸæ¥ä¼ ç»Ÿçš„è¿ç»´æœ‰ä¸åŒä¹‹å¤„äº†ï¼Œéœ€è¦è°ƒæ•´è¿‡æ¥ã€‚ ä½¿ç”¨Rowæ¨¡å¼ä¸”å¤åˆ¶é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼ŒåŸºæœ¬ä¸Šå¾ˆå°‘å‘ç°æœ‰å¤åˆ¶å‡ºé”™çš„æƒ…å†µã€‚ slave è®¾ç½® super_read_only=on é”™è¯¯åœºæ™¯: Errant transactionå‡ºç°è¿™ç§é—®é¢˜åŸºæœ¬æœ‰ä¸¤ç§æƒ…å†µ å¤åˆ¶å‚æ•°æ²¡æœ‰é…ç½®æ­£ç¡®ï¼Œå½“slave crashåï¼Œä¼šå‡ºç°é‡å¤é”®é—®é¢˜ DBAæ“ä½œä¸æ­£ç¡®ï¼Œä¸å°å¿ƒåœ¨slaveä¸Šæ‰§è¡Œäº†äº‹åŠ¡ å¯¹äºç¬¬ä¸€ä¸ªé‡å¤é”®é—®é¢˜ å¯¹äºç¬¬ä¸€ä¸ªé‡å¤é”®é—®é¢˜ 123* skip transation; SQL> SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1;SQL> START SLAVE; GTIDæ¨¡å¼ 1234SQL> SET GTID_NEXT='b9b4712a-df64-11e3-b391-60672090eb04:7'; --è®¾ç½®éœ€è¦è·³è¿‡çš„gtid eventSQL> BEGIN;COMMIT;SQL> SET GTID_NEXT='AUTOMATIC';SQL> START SLAVE; å¯¹äºç¬¬äºŒç§ä¸å°å¿ƒå¤šæ‰§è¡Œäº†äº‹åŠ¡ è¿™ç§æƒ…å†µå°±æ¯”è¾ƒéš¾äº†ï¼Œè¿™æ ·å·²ç»å¯¼è‡´äº†æ•°æ®ä¸ä¸€è‡´ï¼Œå¤§å¤šæ•°æƒ…å†µï¼Œå»ºè®®slaveé‡åš å¦‚ä½•é¿å…ï¼š slave è®¾ç½® super_read_only=on; é‡ç‚¹ï¼š å½“å‘ç”Ÿinject empty transctionåï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤±äº‹åŠ¡ è¿™é‡Œè¯´ä¸‹inject empty transctionçš„éšæ‚£ å½“slaveä¸Šinject empty transctionï¼Œè¯´æ˜æœ‰ä¸€ä¸ªmasterçš„äº‹åŠ¡è¢«å¿½ç•¥äº†ï¼ˆè¿™é‡Œå‡è®¾æ˜¯ $uuid:100ï¼‰ äº‹åŠ¡ä¸¢å¤±ä¸€ï¼šå¦‚æœæ­¤æ—¶æ­¤åˆ»masteræŒ‚äº†ï¼Œè¿™ä¸ªslaveè¢«é€‰ä¸¾ä¸ºæ–°masterï¼Œé‚£ä¹ˆå…¶ä»–çš„slaveå¦‚æœè¿˜æ²¡æœ‰æ‰§è¡Œåˆ°$uuid:100,å°±ä¼šä¸¢å¤±æ‰$uuid:100è¿™ä¸ªäº‹åŠ¡ã€‚ äº‹åŠ¡ä¸¢å¤±äºŒï¼šå¦‚æœä»å¤‡ä»½ä¸­é‡æ–°æ­å»ºä¸€ä¸ªslaveï¼Œéœ€è¦é‡æ–°æ‰§è¡Œä¹‹å‰çš„æ‰€æœ‰äº‹åŠ¡ï¼Œè€Œæ­¤æ—¶ï¼ŒmasteræŒ‚äº†ï¼Œ åˆå›åˆ°äº†äº‹åŠ¡ä¸¢å¤±ä¸€çš„åœºæ™¯ã€‚ QAå¦‚ä½•é‡ç½®gtid_executedï¼Œgtid_purgedã€‚ è®¾ç½®gtid_executed ç°åœ¨åªèƒ½æ‰§è¡Œ: 1mysql> reset master; è®¾ç½®gtid_purged å½“gtid_executed éç©ºçš„æ—¶å€™ï¼Œä¸èƒ½è®¾ç½®gtid_purged å½“gtid_executed ä¸ºç©ºçš„æ—¶å€™(å³åˆšåˆšå¤‡ä»½å¥½çš„é•œåƒï¼Œåˆšæ­å»ºçš„mysql)1mysql> SET @@GLOBAL.GTID_PURGED='0ad6eae9-2d66-11e6-864f-ecf4bbf1f42c:1-3'; å¦‚æœauto.cnf è¢«åˆ æ‰äº†ï¼Œå¯¹äºGTIDçš„å¤åˆ¶ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ> å¦‚æœè¢«åˆ æ‰ï¼Œé‡å¯åï¼Œserver-uuid ä¼šå˜ æ‰‹åŠ¨è®¾ç½® set @@gtid_purged = xx:yy, mysqlä¼šå»ä¸»åŠ¨ä¿®æ”¹binlogçš„å¤´ä¹ˆ> ä¸ä¼š GTIDå’Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼ŸMySQLï¼Œtestè¿˜èƒ½æ„‰å¿«çš„è¿‡æ»¤æ‰å—ï¼Ÿ> å¯ä»¥ï¼Œæ”¹è¿‡æ»¤çš„ä¼šè‡ªå·±è¿‡æ»¤ï¼Œä¸ç”¨æ‹…å¿ƒ Automatic failover with mysqlfailover+GTIDmysqlfailover+GTID document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLæŸ¥è¯¢é‡å¤è®°å½•,åˆ é™¤é‡å¤è®°å½•æ–¹æ³•]]></title>
    <url>%2F2019%2F04%2F22%2Fmysql-duplicate%2F</url>
    <content type="text"><![CDATA[å–„è‰¯æ²¡ç”¨ï¼Œå› ä¸ºåªæœ‰ä½ å…ˆæ¼‚äº®ï¼Œåˆ«äººæ‰èƒ½çœ‹åˆ°ä½ çš„å–„è‰¯ã€‚ å‘½ä»¤æŸ¥æ‰¾å…¨éƒ¨é‡å¤è®°å½•1SELECT * FROM è¡¨ WHERE é‡å¤å­—æ®µ IN (SELECT é‡å¤å­—æ®µ FROM è¡¨ GROUP BY é‡å¤å­—æ®µ HAVING COUNT(*)>1); è¿‡æ»¤é‡å¤è®°å½•(åªæ˜¾ç¤ºä¸€æ¡)12SELECT * FROM è¡¨ WHERE ID IN (SELECT MAX(ID) FROM è¡¨ GROUP BY Title); #æ˜¾ç¤ºIDæœ€å¤§ä¸€æ¡è®°å½•SELECT * FROM è¡¨ WHERE ID IN (SELECT MIN(ID) FROM è¡¨ GROUP BY Title); #æ˜¾ç¤ºIDæœ€å°ä¸€æ¡è®°å½• åˆ é™¤å…¨éƒ¨é‡å¤è®°å½•1DELETE è¡¨ WHERE é‡å¤å­—æ®µ IN (SELECT é‡å¤å­—æ®µ FROM è¡¨ GROUP BY é‡å¤å­—æ®µ HAVING COUNT(*)>1); åˆ é™¤å…¨éƒ¨é‡å¤è®°å½•ä¿ç•™æœ€å¤§IDæœ€å¤§ä¸€æ¡è®°å½•12DELETE FROM è¡¨ WHERE ID NOT IN (SELECT MAX(ID) FROM è¡¨ GROUP BY Title) #ä¿ç•™IDæœ€å¤§ä¸€æ¡è®°å½•DELETE FROM è¡¨ WHERE ID NOT IN (SELECT MIN(ID) FROM è¡¨ GROUP BY Title) #ä¿ç•™IDæœ€å°ä¸€æ¡è®°å½• åˆ é™¤è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰ï¼Œåªç•™æœ‰rowidæœ€å°çš„è®°å½•1DELETE FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1) æŸ¥æ‰¾è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰ï¼Œä¸åŒ…å«rowidæœ€å°çš„è®°å½•1SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) AND rowid NOT IN (SELECT MIN(rowid) FROM vitae GROUP BY peopleId, seq HAVING COUNT(*)>1) æŸ¥æ‰¾è¡¨ä¸­å¤šä½™çš„é‡å¤è®°å½•ï¼ˆå¤šä¸ªå­—æ®µï¼‰1SELECT * FROM vitae a WHERE (a.peopleId, a.seq) IN (SELECT peopleId, seq FROM vitae GROUP BY peopleId, seq HAVING COUNT(*) > 1) æ€»ç»“è¯´æ˜ï¼š å•è¡¨çš„å”¯ä¸€æŸ¥è¯¢ç”¨ï¼šdistinct å¤šè¡¨çš„å”¯ä¸€æŸ¥è¯¢ç”¨ï¼šgroup by distinct æŸ¥è¯¢å¤šè¡¨æ—¶ï¼Œleft join è¿˜æœ‰æ•ˆï¼Œå…¨è¿æ¥æ— æ•ˆ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLä¿®æ”¹è¡¨ã€å­—æ®µã€åº“çš„å­—ç¬¦é›†åŠå­—ç¬¦é›†]]></title>
    <url>%2F2019%2F04%2F22%2Fmysql-character%2F</url>
    <content type="text"><![CDATA[ä¸€ç›´å¯¹å‘å‹å’Œèº«æä¸æ»¡æ„çš„äººï¼Œæœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šä¸è‚¯æ‰¿è®¤è¿™æ˜¯è„¸çš„é—®é¢˜ã€‚ å‘½ä»¤ä¿®æ”¹æ•°æ®åº“å­—ç¬¦é›†1ALTER DATABASE db_name DEFAULT CHARACTER SET character_name [COLLATE ...]; æŠŠè¡¨é»˜è®¤çš„å­—ç¬¦é›†å’Œæ‰€æœ‰å­—ç¬¦åˆ—ï¼ˆCHAR,VARCHAR,TEXTï¼‰æ”¹ä¸ºæ–°çš„å­—ç¬¦é›†ï¼š12ALTER TABLE tbl_name CONVERT TO CHARACTER SET character_name [COLLATE ...]å¦‚ï¼šALTER TABLE logtest CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci; åªæ˜¯ä¿®æ”¹è¡¨çš„é»˜è®¤å­—ç¬¦é›†12ALTER TABLE tbl_name DEFAULT CHARACTER SET character_name [COLLATE...];å¦‚ï¼šALTER TABLE logtest DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci; ä¿®æ”¹å­—æ®µçš„å­—ç¬¦é›†12ALTER TABLE tbl_name CHANGE c_name c_name CHARACTER SET character_name [COLLATE ...];å¦‚ï¼šALTER TABLE logtest CHANGE title title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci; æŸ¥çœ‹å­—æ®µç¼–ç 1SHOW FULL COLUMNS FROM tbl_name; æŸ¥çœ‹ç³»ç»Ÿçš„ç¼–ç å­—ç¬¦1SHOW VARIABLES WHERE Variable_name LIKE 'character\_set\_%' OR Variable_name LIKE 'collation%'; MySQLå­—ç¬¦é›†è®¾ç½®ç³»ç»Ÿå˜é‡ï¼š1234567â€“ character_set_serverï¼šé»˜è®¤çš„å†…éƒ¨æ“ä½œå­—ç¬¦é›†â€“ character_set_clientï¼šå®¢æˆ·ç«¯æ¥æºæ•°æ®ä½¿ç”¨çš„å­—ç¬¦é›†â€“ character_set_connectionï¼šè¿æ¥å±‚å­—ç¬¦é›†â€“ character_set_resultsï¼šæŸ¥è¯¢ç»“æœå­—ç¬¦é›†â€“ character_set_databaseï¼šå½“å‰é€‰ä¸­æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†â€“ character_set_systemï¼šç³»ç»Ÿå…ƒæ•°æ®(å­—æ®µåç­‰)å­—ç¬¦é›†â€“ è¿˜æœ‰ä»¥collation_å¼€å¤´çš„åŒä¸Šé¢å¯¹åº”çš„å˜é‡ï¼Œç”¨æ¥æè¿°å­—ç¬¦åºã€‚ ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†æ ¼å¼ä¸ºï¼š1[_charset] â€˜stringâ€™ [COLLATE collation] ä¾‹å­:123SELECT _latin1 â€˜stringâ€™;â€¢ SELECT _utf8 â€˜ä½ å¥½â€™ COLLATE utf8_general_ci;â€“ ç”±introducerä¿®é¥°çš„æ–‡æœ¬å­—ç¬¦ä¸²åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ä¸ç»è¿‡å¤šä½™çš„è½¬ç ï¼Œç›´æ¥è½¬æ¢ä¸ºå†…éƒ¨å­—ç¬¦é›†å¤„ç†ã€‚ MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹ MySQL Serveræ”¶åˆ°è¯·æ±‚æ—¶å°†è¯·æ±‚æ•°æ®ä»character_set_clientè½¬æ¢ä¸ºcharacter_set_connectionï¼› è¿›è¡Œå†…éƒ¨æ“ä½œå‰å°†è¯·æ±‚æ•°æ®ä»character_set_connectionè½¬æ¢ä¸ºå†…éƒ¨æ“ä½œå­—ç¬¦é›†ï¼Œå…¶ç¡®å®šæ–¹æ³•å¦‚ä¸‹ï¼š ä½¿ç”¨æ¯ä¸ªæ•°æ®å­—æ®µçš„CHARACTER SETè®¾å®šå€¼ï¼› è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®è¡¨çš„DEFAULT CHARACTER SETè®¾å®šå€¼(MySQLæ‰©å±•ï¼ŒéSQLæ ‡å‡†)ï¼› è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®åº“çš„DEFAULT CHARACTER SETè®¾å®šå€¼ï¼› è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨character_set_serverè®¾å®šå€¼ã€‚ å°†æ“ä½œç»“æœä»å†…éƒ¨æ“ä½œå­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_results document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux Systemdè¯¦è§£]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-systemd%2F</url>
    <content type="text"><![CDATA[ä¸€åœºè¯´èµ°å°±èµ°çš„æ—…è¡Œï¼Œå›æ¥ç­‰ç€ä½ çš„å°±æ˜¯ä¸€æ®µåƒåœŸçš„æ—¥å­ã€‚ ä»‹ç»Systemdæ˜¯Linuxç³»ç»Ÿå·¥å…·ï¼Œç”¨æ¥å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå·²æˆä¸ºå¤§å¤šæ•°å‘è¡Œç‰ˆçš„æ ‡é…ï¼ŒPIDä¸º1æœ€å…ˆå¯åŠ¨ï¼› å†å²ä¸Šï¼ŒLinux çš„å¯åŠ¨ä¸€ç›´é‡‡ç”¨initè¿›ç¨‹ã€‚123$ /etc/init.d/apache2 startæˆ–è€…$ service apache2 start è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚ ä¸€æ˜¯å¯åŠ¨æ—¶é—´é•¿ã€‚initè¿›ç¨‹æ˜¯ä¸²è¡Œå¯åŠ¨ï¼Œåªæœ‰å‰ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨å®Œï¼Œæ‰ä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªè¿›ç¨‹ã€‚ äºŒæ˜¯å¯åŠ¨è„šæœ¬å¤æ‚ã€‚initè¿›ç¨‹åªæ˜¯æ‰§è¡Œå¯åŠ¨è„šæœ¬ï¼Œä¸ç®¡å…¶ä»–äº‹æƒ…ã€‚è„šæœ¬éœ€è¦è‡ªå·±å¤„ç†å„ç§æƒ…å†µï¼Œè¿™å¾€å¾€ä½¿å¾—è„šæœ¬å˜å¾—å¾ˆé•¿ã€‚ Systemd å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼Œä¸ºç³»ç»Ÿçš„å¯åŠ¨å’Œç®¡ç†æä¾›ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚æ ¹æ® Linux æƒ¯ä¾‹ï¼Œå­—æ¯dæ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„ç¼©å†™ã€‚ Systemd è¿™ä¸ªåå­—çš„å«ä¹‰ï¼Œå°±æ˜¯å®ƒè¦å®ˆæŠ¤æ•´ä¸ªç³»ç»Ÿã€‚CentOS/RHEL7 ä»¥ä¸Šç‰ˆæœ¬ä¸­Systemd å–ä»£äº†initdï¼Œæˆä¸ºç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆPID ç­‰äº 1ï¼‰ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒçš„å­è¿›ç¨‹ã€‚æŸ¥çœ‹ç‰ˆæœ¬ï¼š1$ systemctl --version å¸¸ç”¨å‘½ä»¤systemctl å‘½ä»¤é‡å¯ç³»ç»Ÿ1systemctl reboot å…³é—­ç³»ç»Ÿï¼Œåˆ‡æ–­ç”µæº1systemctl poweroff CPUåœæ­¢å·¥ä½œ1systemctl halt æš‚åœç³»ç»Ÿ1systemctl suspend è®©ç³»ç»Ÿè¿›å…¥å†¬çœ çŠ¶æ€1systemctl hibernate è®©ç³»ç»Ÿè¿›å…¥äº¤äº’å¼ä¼‘çœ çŠ¶æ€1systemctl hybrid-sleep å¯åŠ¨è¿›å…¥æ•‘æ´çŠ¶æ€ï¼ˆå•ç”¨æˆ·çŠ¶æ€ï¼‰1systemctl rescue systemd-analyze æ˜¯æŸ¥çœ‹å¯åŠ¨è€—æ—¶ æŸ¥çœ‹å¯åŠ¨è€—æ—¶1systemd-analyze æŸ¥çœ‹æ¯ä¸ªæœåŠ¡çš„å¯åŠ¨è€—æ—¶1systemd-analyze blame æ˜¾ç¤ºç€‘å¸ƒçŠ¶çš„å¯åŠ¨è¿‡ç¨‹æµ1systemd-analyze critical-chain æ˜¾ç¤ºæŒ‡å®šæœåŠ¡çš„å¯åŠ¨æµ1systemd-analyze critical-chain atd.service hostnamectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚æ˜¾ç¤ºå½“å‰ä¸»æœºçš„ä¿¡æ¯12345hostnamectl```bashè®¾ç½®ä¸»æœºåã€‚```bashhostnamectl set-hostname rhel7 localectlå‘½ä»¤ç”¨äºæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚æŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®1localectl è®¾ç½®æœ¬åœ°åŒ–å‚æ•°ã€‚12localectl set-locale LANG=en_GB.utf8localectl set-keymap en_GB timedatectlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚æŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®1timedatectl æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æ—¶åŒº1timedatectl list-timezones è®¾ç½®å½“å‰æ—¶åŒº123timedatectl set-timezone America/New_Yorktimedatectl set-time YYYY-MM-DDtimedatectl set-time HH:MM:SS loginctlå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚åˆ—å‡ºå½“å‰session1loginctl list-sessions åˆ—å‡ºå½“å‰ç™»å½•ç”¨æˆ·1loginctl list-users åˆ—å‡ºæ˜¾ç¤ºæŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯1loginctl show-user ruanyf ä»‹ç»Systemd å¯ä»¥ç®¡ç†æ‰€æœ‰ç³»ç»Ÿèµ„æºã€‚ä¸åŒçš„èµ„æºç»Ÿç§°ä¸º Unitï¼ˆå•ä½ï¼‰ã€‚ Unit ä¸€å…±åˆ†æˆ12ç§ã€‚ Service unitï¼šç³»ç»ŸæœåŠ¡ Target unitï¼šå¤šä¸ª Unit æ„æˆçš„ä¸€ä¸ªç»„ Device Unitï¼šç¡¬ä»¶è®¾å¤‡ Mount Unitï¼šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ Automount Unitï¼šè‡ªåŠ¨æŒ‚è½½ç‚¹ Path Unitï¼šæ–‡ä»¶æˆ–è·¯å¾„ Scope Unitï¼šä¸æ˜¯ç”± Systemd å¯åŠ¨çš„å¤–éƒ¨è¿›ç¨‹ Slice Unitï¼šè¿›ç¨‹ç»„ Snapshot Unitï¼šSystemd å¿«ç…§ï¼Œå¯ä»¥åˆ‡å›æŸä¸ªå¿«ç…§ Socket Unitï¼šè¿›ç¨‹é—´é€šä¿¡çš„ socket Swap Unitï¼šswap æ–‡ä»¶ Timer Unitï¼šå®šæ—¶å™¨ systemctl list-unitså‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Unit ã€‚ åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„ Unit1systemctl list-units åˆ—å‡ºæ‰€æœ‰Unitï¼ŒåŒ…æ‹¬æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„æˆ–è€…å¯åŠ¨å¤±è´¥çš„1systemctl list-units --all åˆ—å‡ºæ‰€æœ‰æ²¡æœ‰è¿è¡Œçš„ Unit1systemctl list-units --all --state=inactive åˆ—å‡ºæ‰€æœ‰åŠ è½½å¤±è´¥çš„ Unit1systemctl list-units --failed åˆ—å‡ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ã€ç±»å‹ä¸º service çš„ Unit1systemctl list-units --type=service Unit çš„çŠ¶æ€systemctl statuså‘½ä»¤ç”¨äºæŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œå•ä¸ª Unit çš„çŠ¶æ€ã€‚ æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€1systemctl status æ˜¾ç¤ºå•ä¸ª Unit çš„çŠ¶æ€1sysystemctl status bluetooth.service æ˜¾ç¤ºè¿œç¨‹ä¸»æœºçš„æŸä¸ª Unit çš„çŠ¶æ€1systemctl -H root@rhel7.example.com status httpd.service é™¤äº†statuså‘½ä»¤ï¼Œsystemctlè¿˜æä¾›äº†ä¸‰ä¸ªæŸ¥è¯¢çŠ¶æ€çš„ç®€å•æ–¹æ³•ï¼Œä¸»è¦ä¾›è„šæœ¬å†…éƒ¨çš„åˆ¤æ–­è¯­å¥ä½¿ç”¨ã€‚ æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦æ­£åœ¨è¿è¡Œ1systemctl is-active application.service æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦å¤„äºå¯åŠ¨å¤±è´¥çŠ¶æ€1systemctl is-failed application.service æ˜¾ç¤ºæŸä¸ª Unit æœåŠ¡æ˜¯å¦å»ºç«‹äº†å¯åŠ¨é“¾æ¥1systemctl is-enabled application.service Unit ç®¡ç†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ä¸‹é¢è¿™äº›å‘½ä»¤ï¼Œç”¨äºå¯åŠ¨å’Œåœæ­¢ Unitï¼ˆä¸»è¦æ˜¯ serviceï¼‰ã€‚ ç«‹å³å¯åŠ¨ä¸€ä¸ªæœåŠ¡1systemctl start apache.service ç«‹å³åœæ­¢ä¸€ä¸ªæœåŠ¡1systemctl stop apache.service é‡å¯ä¸€ä¸ªæœåŠ¡1systemctl restart apache.service æ€æ­»ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å­è¿›ç¨‹1systemctl kill apache.service é‡æ–°åŠ è½½ä¸€ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶1systemctl reload apache.service é‡è½½æ‰€æœ‰ä¿®æ”¹è¿‡çš„é…ç½®æ–‡ä»¶1systemctl daemon-reload æ˜¾ç¤ºæŸä¸ª Unit çš„æ‰€æœ‰åº•å±‚å‚æ•°1systemctl show httpd.service æ˜¾ç¤ºæŸä¸ª Unit çš„æŒ‡å®šå±æ€§çš„å€¼1systemctl show -p CPUShares httpd.service è®¾ç½®æŸä¸ª Unit çš„æŒ‡å®šå±æ€§1systemctl set-property httpd.service CPUShares=500 ä¾èµ–å…³ç³»Unit ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼šA ä¾èµ–äº Bï¼Œå°±æ„å‘³ç€ Systemd åœ¨å¯åŠ¨ A çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šå»å¯åŠ¨ Bã€‚ systemctl list-dependencieså‘½ä»¤åˆ—å‡ºä¸€ä¸ª Unit çš„æ‰€æœ‰ä¾èµ–ã€‚12345systemctl list-dependencies nginx.service```bashä¸Šé¢å‘½ä»¤çš„è¾“å‡ºç»“æœä¹‹ä¸­ï¼Œæœ‰äº›ä¾èµ–æ˜¯ Target ç±»å‹ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œé»˜è®¤ä¸ä¼šå±•å¼€æ˜¾ç¤ºã€‚å¦‚æœè¦å±•å¼€ Targetï¼Œå°±éœ€è¦ä½¿ç”¨--allå‚æ•°ã€‚```bashsystemctl list-dependencies --all nginx.service Unit çš„é…ç½®æ–‡ä»¶æ¯ä¸€ä¸ª Unit éƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰ Systemd æ€ä¹ˆå¯åŠ¨è¿™ä¸ª Unit ã€‚ Systemd é»˜è®¤ä»ç›®å½•/etc/systemd/system/è¯»å–é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œé‡Œé¢å­˜æ”¾çš„å¤§éƒ¨åˆ†æ–‡ä»¶éƒ½æ˜¯ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘ç›®å½•/usr/lib/systemd/system/ï¼ŒçœŸæ­£çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨é‚£ä¸ªç›®å½•ã€‚ systemctl enableå‘½ä»¤ç”¨äºåœ¨ä¸Šé¢ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œå»ºç«‹ç¬¦å·é“¾æ¥å…³ç³»ã€‚1systemctl enable clamd@scan.service ç­‰åŒäº1ln -s '/usr/lib/systemd/system/clamd@scan.service' '/etc/systemd/system/multi-user.target.wants/clamd@scan.service' å¦‚æœé…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®äº†å¼€æœºå¯åŠ¨ï¼Œsystemctl enableå‘½ä»¤ç›¸å½“äºæ¿€æ´»å¼€æœºå¯åŠ¨ã€‚ ä¸ä¹‹å¯¹åº”çš„ï¼Œsystemctl disableå‘½ä»¤ç”¨äºåœ¨ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œæ’¤é”€ç¬¦å·é“¾æ¥å…³ç³»ï¼Œç›¸å½“äºæ’¤é”€å¼€æœºå¯åŠ¨ã€‚1systemctl disable clamd@scan.service é…ç½®æ–‡ä»¶çš„åç¼€åï¼Œå°±æ˜¯è¯¥ Unit çš„ç§ç±»ï¼Œæ¯”å¦‚sshd.socketã€‚å¦‚æœçœç•¥ï¼ŒSystemd é»˜è®¤åç¼€åä¸º.serviceï¼Œæ‰€ä»¥sshdä¼šè¢«ç†è§£æˆsshd.serviceã€‚ é…ç½®æ–‡ä»¶çš„çŠ¶æ€1systemctl list-unit-fileså‘½ä»¤ç”¨äºåˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶ã€‚ åˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶1systemctl list-unit-files åˆ—å‡ºæŒ‡å®šç±»å‹çš„é…ç½®æ–‡ä»¶12systemctl list-unit-files --type=serviceè¿™ä¸ªå‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªåˆ—è¡¨ã€‚ 1systemctl list-unit-files UNIT FILE STATE123chronyd.service enabledclamd@.service staticclamd@scan.service disabled è¿™ä¸ªåˆ—è¡¨æ˜¾ç¤ºæ¯ä¸ªé…ç½®æ–‡ä»¶çš„çŠ¶æ€ï¼Œä¸€å…±æœ‰å››ç§ã€‚ enabledï¼šå·²å»ºç«‹å¯åŠ¨é“¾æ¥ disabledï¼šæ²¡å»ºç«‹å¯åŠ¨é“¾æ¥ staticï¼šè¯¥é…ç½®æ–‡ä»¶æ²¡æœ‰[Install]éƒ¨åˆ†ï¼ˆæ— æ³•æ‰§è¡Œï¼‰ï¼Œåªèƒ½ä½œä¸ºå…¶ä»–é…ç½®æ–‡ä»¶çš„ä¾èµ– maskedï¼šè¯¥é…ç½®æ–‡ä»¶è¢«ç¦æ­¢å»ºç«‹å¯åŠ¨é“¾æ¥ æ³¨æ„ï¼Œä»é…ç½®æ–‡ä»¶çš„çŠ¶æ€æ— æ³•çœ‹å‡ºï¼Œè¯¥ Unit æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚è¿™å¿…é¡»æ‰§è¡Œå‰é¢æåˆ°çš„systemctl statuså‘½ä»¤ã€‚ 1systemctl status bluetooth.service ä¸€æ—¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°±è¦è®© SystemD é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡æ–°å¯åŠ¨ï¼Œå¦åˆ™ä¿®æ”¹ä¸ä¼šç”Ÿæ•ˆã€‚12systemctl daemon-reloadsystemctl restart httpd.service é…ç½®æ–‡ä»¶çš„æ ¼å¼é…ç½®æ–‡ä»¶å°±æ˜¯æ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ã€‚ systemctl catå‘½ä»¤å¯ä»¥æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚1systemctl cat atd.service unit é…ç½®æ–‡ä»¶1234567891011121314151617[Unit]Description=ATD daemon[Service]Type=forkingExecStart=/usr/bin/atd[Install]WantedBy=multi-user.targetä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œé…ç½®æ–‡ä»¶åˆ†æˆå‡ ä¸ªåŒºå—ã€‚æ¯ä¸ªåŒºå—çš„ç¬¬ä¸€è¡Œï¼Œæ˜¯ç”¨æ–¹æ‹¬å·è¡¨ç¤ºçš„åŒºåˆ«åï¼Œæ¯”å¦‚[Unit]ã€‚æ³¨æ„ï¼Œé…ç½®æ–‡ä»¶çš„åŒºå—åå’Œå­—æ®µåï¼Œéƒ½æ˜¯å¤§å°å†™æ•æ„Ÿçš„ã€‚æ¯ä¸ªåŒºå—å†…éƒ¨æ˜¯ä¸€äº›ç­‰å·è¿æ¥çš„é”®å€¼å¯¹ã€‚[Section]Directive1=valueDirective2=value. . . æ³¨æ„ï¼Œé”®å€¼å¯¹çš„ç­‰å·ä¸¤ä¾§ä¸èƒ½æœ‰ç©ºæ ¼ã€‚ é…ç½®æ–‡ä»¶çš„åŒºåŸŸ[Unit]åŒºå—é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰ Unit çš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸å…¶ä»– Unit çš„å…³ç³»ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚ Descriptionï¼šç®€çŸ­æè¿° Documentationï¼šæ–‡æ¡£åœ°å€ Requiresï¼šå½“å‰ Unit ä¾èµ–çš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¼šå¯åŠ¨å¤±è´¥ Wantsï¼šä¸å½“å‰ Unit é…åˆçš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¸ä¼šå¯åŠ¨å¤±è´¥ BindsToï¼šä¸Requiresç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ Beforeï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹åå¯åŠ¨ Afterï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹å‰å¯åŠ¨ Conflictsï¼šè¿™é‡ŒæŒ‡å®šçš„ Unit ä¸èƒ½ä¸å½“å‰ Unit åŒæ—¶è¿è¡Œ Conditionâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¸ä¼šè¿è¡Œ Assertâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥å¯åŠ¨å¤±è´¥ [Install]é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„æœ€åä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚ WantedByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .wantsåç¼€æ„æˆçš„å­ç›®å½•ä¸­ RequiredByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .requiredåç¼€æ„æˆçš„å­ç›®å½•ä¸­ Aliasï¼šå½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å Alsoï¼šå½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit [Service]åŒºå—ç”¨æ¥ Service çš„é…ç½®ï¼Œåªæœ‰ Service ç±»å‹çš„ Unit æ‰æœ‰è¿™ä¸ªåŒºå—ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚ Typeï¼šå®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚ Type=simpleï¼šé»˜è®¤å€¼ï¼Œæ‰§è¡ŒExecStartæŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹ Type=forkingï¼šä»¥ fork æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º Type=oneshotï¼šä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ Type=dbusï¼šå½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨ Type=notifyï¼šå½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥Systemdï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ Type=idleï¼šè‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ ExecStartï¼šå¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤ ExecStartPreï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤ ExecStartPostï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤ ExecReloadï¼šé‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤ ExecStopï¼šåœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤ ExecStopPostï¼šåœæ­¢å½“å…¶æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤ RestartSecï¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•° Restartï¼šå®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬alwaysï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€on-successã€on-failureã€on-abnormalã€on-abortã€on-watchdog TimeoutSecï¼šå®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•° Environmentï¼šæŒ‡å®šç¯å¢ƒå˜é‡ Unit é…ç½®æ–‡ä»¶çš„å®Œæ•´å­—æ®µæ¸…å•ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ Targetå¯åŠ¨è®¡ç®—æœºçš„æ—¶å€™ï¼Œéœ€è¦å¯åŠ¨å¤§é‡çš„ Unitã€‚å¦‚æœæ¯ä¸€æ¬¡å¯åŠ¨ï¼Œéƒ½è¦ä¸€ä¸€å†™æ˜æœ¬æ¬¡å¯åŠ¨éœ€è¦å“ªäº› Unitï¼Œæ˜¾ç„¶éå¸¸ä¸æ–¹ä¾¿ã€‚Systemd çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ Targetã€‚ç®€å•è¯´ï¼ŒTarget å°±æ˜¯ä¸€ä¸ª Unit ç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„ Unit ã€‚å¯åŠ¨æŸä¸ª Target çš„æ—¶å€™ï¼ŒSystemd å°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„ Unitã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTarget è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºâ€çŠ¶æ€ç‚¹â€ï¼Œå¯åŠ¨æŸä¸ª Target å°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚ä¼ ç»Ÿçš„initå¯åŠ¨æ¨¡å¼é‡Œé¢ï¼Œæœ‰ RunLevel çš„æ¦‚å¿µï¼Œè·Ÿ Target çš„ä½œç”¨å¾ˆç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒRunLevel æ˜¯äº’æ–¥çš„ï¼Œä¸å¯èƒ½å¤šä¸ª RunLevel åŒæ—¶å¯åŠ¨ï¼Œä½†æ˜¯å¤šä¸ª Target å¯ä»¥åŒæ—¶å¯åŠ¨ã€‚ æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Target1systemctl list-unit-files --type=target æŸ¥çœ‹ä¸€ä¸ª Target åŒ…å«çš„æ‰€æœ‰ Unit1systemctl list-dependencies multi-user.target æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤ Target1systemctl get-default è®¾ç½®å¯åŠ¨æ—¶çš„é»˜è®¤ Target1systemctl set-default multi-user.target åˆ‡æ¢ Target æ—¶ï¼Œé»˜è®¤ä¸å…³é—­å‰ä¸€ä¸ª Target å¯åŠ¨çš„è¿›ç¨‹ï¼Œsystemctl isolate å‘½ä»¤æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œå…³é—­å‰ä¸€ä¸ª Target é‡Œé¢æ‰€æœ‰ä¸å±äºåä¸€ä¸ª Target çš„è¿›ç¨‹1systemctl isolate multi-user.target Target ä¸ ä¼ ç»Ÿ RunLevel çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ã€‚123456789Traditional runlevel New target name Symbolically linked to...Runlevel 0 | runlevel0.target -> poweroff.targetRunlevel 1 | runlevel1.target -> rescue.targetRunlevel 2 | runlevel2.target -> multi-user.targetRunlevel 3 | runlevel3.target -> multi-user.targetRunlevel 4 | runlevel4.target -> multi-user.targetRunlevel 5 | runlevel5.target -> graphical.targetRunlevel 6 | runlevel6.target -> reboot.target å®ƒä¸initè¿›ç¨‹çš„ä¸»è¦å·®åˆ«å¦‚ä¸‹: é»˜è®¤çš„ RunLevelï¼ˆåœ¨/etc/inittabæ–‡ä»¶è®¾ç½®ï¼‰ç°åœ¨è¢«é»˜è®¤çš„ Target å–ä»£ï¼Œä½ç½®æ˜¯/etc/systemd/system/default.targetï¼Œé€šå¸¸ç¬¦å·é“¾æ¥åˆ°graphical.targetï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ–è€…multi-user.targetï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œï¼‰ã€‚ å¯åŠ¨è„šæœ¬çš„ä½ç½®ï¼Œä»¥å‰æ˜¯/etc/init.dç›®å½•ï¼Œç¬¦å·é“¾æ¥åˆ°ä¸åŒçš„ RunLevel ç›®å½• ï¼ˆæ¯”å¦‚/etc/rc3.dã€/etc/rc5.dç­‰ï¼‰ï¼Œç°åœ¨åˆ™å­˜æ”¾åœ¨/lib/systemd/systemå’Œ/etc/systemd/systemç›®å½•ã€‚ é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å‰initè¿›ç¨‹çš„é…ç½®æ–‡ä»¶æ˜¯/etc/inittabï¼Œå„ç§æœåŠ¡çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨/etc/sysconfigç›®å½•ã€‚ç°åœ¨çš„é…ç½®æ–‡ä»¶ä¸»è¦å­˜æ”¾åœ¨/lib/systemdç›®å½•ï¼Œåœ¨/etc/systemdç›®å½•é‡Œé¢çš„ä¿®æ”¹å¯ä»¥è¦†ç›–åŸå§‹è®¾ç½®ã€‚ æ—¥å¿—ç®¡ç†Systemd ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ Unit çš„å¯åŠ¨æ—¥å¿—ã€‚å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ï¼Œå¯ä»¥åªç”¨journalctlä¸€ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆå†…æ ¸æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—ï¼‰ã€‚æ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯/etc/systemd/journald.confã€‚ journalctlåŠŸèƒ½å¼ºå¤§ï¼Œç”¨æ³•éå¸¸å¤šã€‚ æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰1journalctl æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆä¸æ˜¾ç¤ºåº”ç”¨æ—¥å¿—ï¼‰1journalctl -k æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—12journalctl -bjournalctl -b -0 æŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼ˆéœ€æ›´æ”¹è®¾ç½®ï¼‰1journalctl -b -1 æŸ¥çœ‹æŒ‡å®šæ—¶é—´çš„æ—¥å¿—12345journalctl --since="2012-10-30 18:17:16"journalctl --since "20 min ago"journalctl --since yesterdayjournalctl --since "2015-01-10" --until "2015-01-11 03:00"journalctl --since 09:00 --until "1 hour ago" æ˜¾ç¤ºå°¾éƒ¨çš„æœ€æ–°10è¡Œæ—¥å¿—1journalctl -n æ˜¾ç¤ºå°¾éƒ¨æŒ‡å®šè¡Œæ•°çš„æ—¥å¿—1journalctl -n 20 å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—1journalctl -f æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—1journalctl /usr/lib/systemd/systemd æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—1journalctl _PID=1 æŸ¥çœ‹æŸä¸ªè·¯å¾„çš„è„šæœ¬çš„æ—¥å¿—1journalctl /usr/bin/bash æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ—¥å¿—1journalctl _UID=33 --since today æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—12journalctl -u nginx.servicejournalctl -u nginx.service --since today å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæŸä¸ª Unit çš„æœ€æ–°æ—¥å¿—1journalctl -u nginx.service -f åˆå¹¶æ˜¾ç¤ºå¤šä¸ª Unit çš„æ—¥å¿—1journalctl -u nginx.service -u php-fpm.service --since today æŸ¥çœ‹æŒ‡å®šä¼˜å…ˆçº§ï¼ˆåŠå…¶ä»¥ä¸Šçº§åˆ«ï¼‰çš„æ—¥å¿—ï¼Œå…±æœ‰8çº§ 0:emerg 1:alert 2:crit 3:err 4:warning 5:notice 6:info 7:debug1journalctl -p err -b æ—¥å¿—é»˜è®¤åˆ†é¡µè¾“å‡ºï¼Œâ€“no-pager æ”¹ä¸ºæ­£å¸¸çš„æ ‡å‡†è¾“å‡º1journalctl --no-pager ä»¥ JSON æ ¼å¼ï¼ˆå•è¡Œï¼‰è¾“å‡º1journalctl -b -u nginx.service -o json ä»¥ JSON æ ¼å¼ï¼ˆå¤šè¡Œï¼‰è¾“å‡ºï¼Œå¯è¯»æ€§æ›´å¥½1journalctl -b -u nginx.serviceqq -o json-pretty æ˜¾ç¤ºæ—¥å¿—å æ®çš„ç¡¬ç›˜ç©ºé—´1journalctl --disk-usage æŒ‡å®šæ—¥å¿—æ–‡ä»¶å æ®çš„æœ€å¤§ç©ºé—´1journalctl --vacuum-size=1G æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šä¹…1journalctl --vacuum-time=1years document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[LinuxæŸ¥çœ‹æœ€æ¶ˆè€—CPUå’Œå†…å­˜çš„è¿›ç¨‹]]></title>
    <url>%2F2019%2F04%2F22%2Fcpu-memory%2F</url>
    <content type="text"><![CDATA[çœŸæ­£åŠªåŠ›è¿‡çš„äººæ‰çŸ¥é“ï¼Œæ™ºå•†ä¸Šçš„å·®è·æ˜¯ä¸å¯é€¾è¶Šçš„ã€‚ å‘½ä»¤ CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š 1ps auxw|head -1;ps auxw|sort -rn -k3|head -10 å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ 1ps auxw|head -1;ps auxw|sort -rn -k4|head -10 è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ 1ps auxw|head -1;ps auxw|sort -rn -k5|head -10 å‡ ä¸ªå‚æ•°å«ä¹‰: %MEM è¿›ç¨‹çš„å†…å­˜å ç”¨ç‡ VSZ è¿›ç¨‹æ‰€ä½¿ç”¨çš„è™šå­˜çš„å¤§å° RSS è¿›ç¨‹ä½¿ç”¨çš„é©»ç•™é›†å¤§å°æˆ–è€…æ˜¯å®é™…å†…å­˜çš„å¤§å°(RSS is the â€œresident set sizeâ€ meaning physical memory used) TTY ä¸è¿›ç¨‹å…³è”çš„ç»ˆç«¯ï¼ˆttyï¼‰ ä¸²è¡Œç«¯å£ç»ˆç«¯ï¼ˆ/dev/ttySnï¼‰ ä¼ªç»ˆç«¯ï¼ˆ/dev/pty/ï¼‰ æ§åˆ¶ç»ˆç«¯ï¼ˆ/dev/ttyï¼‰ æ§åˆ¶å°ç»ˆç«¯ï¼ˆ/dev/ttyn, /dev/consoleï¼‰ è™šæ‹Ÿç»ˆç«¯(/dev/pts/n) STAT æ£€æŸ¥çš„çŠ¶æ€ï¼šè¿›ç¨‹çŠ¶æ€ä½¿ç”¨å­—ç¬¦è¡¨ç¤ºçš„ï¼Œå¦‚Rï¼ˆrunningæ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œï¼‰ã€Sï¼ˆsleepingç¡çœ ï¼‰ã€Iï¼ˆidleç©ºé—²ï¼‰ã€Z (åƒµæ­»)ã€Dï¼ˆä¸å¯ä¸­æ–­çš„ç¡çœ ï¼Œé€šå¸¸æ˜¯I/Oï¼‰ã€Pï¼ˆç­‰å¾…äº¤æ¢é¡µï¼‰ã€Wï¼ˆæ¢å‡º,è¡¨ç¤ºå½“å‰é¡µé¢ä¸åœ¨å†…å­˜ï¼‰ã€Nï¼ˆä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼‰T(terminateç»ˆæ­¢)ã€W has no resident pages D ä¸å¯ä¸­æ–­ Uninterruptible sleep (usually IO) R æ­£åœ¨è¿è¡Œï¼Œæˆ–åœ¨é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ S å¤„äºä¼‘çœ çŠ¶æ€ T åœæ­¢æˆ–è¢«è¿½è¸ª Z åƒµå°¸è¿›ç¨‹ W è¿›å…¥å†…å­˜äº¤æ¢ï¼ˆä»å†…æ ¸2.6å¼€å§‹æ— æ•ˆï¼‰ X æ­»æ‰çš„è¿›ç¨‹ < é«˜ä¼˜å…ˆçº§ N ä½ä¼˜å…ˆçº§ L æœ‰äº›é¡µè¢«é”è¿›å†…å­˜ s åŒ…å«å­è¿›ç¨‹ ä½äºåå°çš„è¿›ç¨‹ç»„ l å¤šçº¿ç¨‹ å…‹éš†çº¿ç¨‹ multi-threaded (using CLONE_THREAD, like NPTL pthreads do) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[NginxæŸ¥çœ‹æˆªå–åˆ‡å‰²æ—¥å¿—]]></title>
    <url>%2F2019%2F04%2F22%2Fnginx-log%2F</url>
    <content type="text"><![CDATA[è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é”™ï¼Œè°è®©ä½ é•¿å¾—ä¸å¥½çœ‹åˆæ²¡é’±ã€‚ ä»‹ç»nginxæ—¥å¿—æœ€å¥½å®ç°æ¯å¤©å®šæ—¶åˆ‡å‰²ä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨è®¿é—®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸å¤„ç†ï¼Œå¦‚æœæ²¡åˆ‡å‰²ï¼Œå¯ä»¥ç”¨sedç›´æ¥åˆ‡å‰² å‘½ä»¤æŸ¥æ‰¾7æœˆ17æ—¥è®¿é—®logå¯¼å‡ºåˆ°17.logæ–‡ä»¶ä¸­1cat gelin_web_access.log | egrep "17/Jul/2017" | sed -n '/00:00:00/,/23:59:59/p' > /tmp/17.log æŸ¥çœ‹è®¿é—®é‡å‰10çš„IP1awk '{print $1}' 17.log | sort | uniq -c | sort -nr | head -n 10 æŸ¥çœ‹è®¿é—®å‰10çš„URL1awk '{print $11}' gelin_web_access.log | sort | uniq -c | sort -nr | head -n 10 æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„URL1awk '{print $7}' gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more æŸ¥è¯¢è®¿é—®æœ€é¢‘ç¹çš„IP1awk '{print $1}' gelin_web_access.log | sort | uniq -c | sort -n -k 1 -r | more æ ¹æ®è®¿é—®IPç»Ÿè®¡UV1awk '{print $1}' gelin_web_access.log | sort | uniq -c | wc -l ç»Ÿè®¡è®¿é—®URLç»Ÿè®¡PV1awk '{print $7}' gelin_web_access.log | wc -l æ ¹æ®æ—¶é—´æ®µç»Ÿè®¡æŸ¥çœ‹æ—¥å¿—1cat gelin_web_access.log | sed -n '/17\/Jul\/2017:12/,/17\/Jul\/2017:13/p' | more document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux iptables æ•´ç†]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-iptables%2F</url>
    <content type="text"><![CDATA[ä½ æ€»å«Œæœ‰äº›äººæ‡’ï¼Œè¯´å¾—å¥½åƒä½ å‹¤å¿«äº†å°±çœŸèƒ½å¹²å‡ºä»€ä¹ˆå¤§äº‹å„¿ä¸€æ ·ã€‚ ä»‹ç»iptablesæ˜¯Linuxä¸­é‡è¦çš„è®¿é—®æ§åˆ¶æ‰‹æ®µï¼Œæ˜¯ä¿—ç§°çš„ Linux é˜²ç«å¢™ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¿™é‡Œè®°å½•äº†iptables é˜²ç«å¢™è§„åˆ™çš„ä¸€äº›å¸¸ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‚ iptablesçš„åŸºæœ¬è¯­æ³•ï¼š1iptables [-t filter/nat] [-A/I] [INPUT/OUTPUT/FORWARD] [-i/o interface] [-p tcp/udp/icmp/all] [-s ip/network] [--sport ports] [-d ip/network] [--dport ports] [-j ACCEPT/DROP] 12345678910111213141516171819202122232425262728å‚æ•°è¯´æ˜: ä¸åŠ -tæ—¶é»˜è®¤æ˜¯filter è¯­æ³•å‚æ•°ï¼š -Iï¼šç¬¬ä¸€è¡Œæ’å…¥ -Aï¼šæœ€åè¿½åŠ  -i/oï¼šæŒ‡çš„æ˜¯æ•°æ®è¦è¿›å…¥æˆ–å‡ºå»æ‰€è¦ç»è¿‡çš„ç«¯å£ï¼Œå¦‚eth1,eth0,pppoeç­‰ -pï¼šä½ æ‰€è¦æŒ‡å®šçš„åè®® -sï¼šæŒ‡å®šæ¥æºipï¼Œå¯ä»¥æ˜¯å•ä¸ªipå¦‚192.168.109.131ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘ç»œ 192.168.109.0/24ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªåŸŸåå¦‚163.comï¼Œå¦‚æœä½ å¡«å†™çš„æ˜¯åŸŸåç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå‡ºä»–çš„ipå¹¶åœ¨iptablesé‡Œæ˜¾ç¤º --sportï¼šæ¥æºç«¯å£ -dï¼šæŒ‡å®šç›®æ ‡ip --dportï¼šç›®æ ‡ç«¯å£ -jï¼šæ‰§è¡Œå‚æ•°ACCEPTæˆ–DROPï¼ŒREJECTä¸€èˆ¬ä¸ç”¨ -A åœ¨æŒ‡å®šé“¾çš„æœ«å°¾æ·»åŠ ï¼ˆappendï¼‰ä¸€æ¡æ–°çš„è§„åˆ™ -D åˆ é™¤ï¼ˆdeleteï¼‰æŒ‡å®šé“¾ä¸­çš„æŸä¸€æ¡è§„åˆ™ï¼Œå¯ä»¥æŒ‰è§„åˆ™åºå·å’Œå†…å®¹åˆ é™¤ -I åœ¨æŒ‡å®šé“¾ä¸­æ’å…¥ï¼ˆinsertï¼‰ä¸€æ¡æ–°çš„è§„åˆ™ï¼Œé»˜è®¤åœ¨ç¬¬ä¸€è¡Œæ·»åŠ  -R ä¿®æ”¹ã€æ›¿æ¢ï¼ˆreplaceï¼‰æŒ‡å®šé“¾ä¸­çš„æŸä¸€æ¡è§„åˆ™ï¼Œå¯ä»¥æŒ‰è§„åˆ™åºå·å’Œå†…å®¹æ›¿æ¢ -L åˆ—å‡ºï¼ˆlistï¼‰æŒ‡å®šé“¾ä¸­æ‰€æœ‰çš„è§„åˆ™è¿›è¡ŒæŸ¥çœ‹ -E é‡å‘½åç”¨æˆ·å®šä¹‰çš„é“¾ï¼Œä¸æ”¹å˜é“¾æœ¬èº« -F æ¸…ç©ºï¼ˆflushï¼‰ -N æ–°å»ºï¼ˆnew-chainï¼‰ä¸€æ¡ç”¨æˆ·è‡ªå·±å®šä¹‰çš„è§„åˆ™é“¾ -X åˆ é™¤æŒ‡å®šè¡¨ä¸­ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™é“¾ï¼ˆdelete-chainï¼‰ -P è®¾ç½®æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆpolicyï¼‰ -Z å°†æ‰€æœ‰è¡¨çš„æ‰€æœ‰é“¾çš„å­—èŠ‚å’Œæ•°æ®åŒ…è®¡æ•°å™¨æ¸…é›¶ -n ä½¿ç”¨æ•°å­—å½¢å¼ï¼ˆnumericï¼‰æ˜¾ç¤ºè¾“å‡ºç»“æœ -v æŸ¥çœ‹è§„åˆ™è¡¨è¯¦ç»†ä¿¡æ¯ï¼ˆverboseï¼‰çš„ä¿¡æ¯ -V æŸ¥çœ‹ç‰ˆæœ¬(version) -h è·å–å¸®åŠ©ï¼ˆhelpï¼‰ å¦‚æœé…ç½®çš„æ˜¯INPUTï¼ˆè¿›å…¥ï¼‰,åˆ™æ¥æºipæ˜¯è¿ç¨‹ipï¼Œç›®æ ‡ç«¯å£å°±æ˜¯æœ¬æœºï¼›OUTPUTç›¸å æµç¨‹å½“æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡ä¸»æœºæ—¶ï¼Œç»è¿‡PREROUTINGé“¾,ç»è·¯ç”±ä¹‹åå†³å®šæ˜¯å¦è½¬å‘ï¼Œä¸è½¬å‘åˆ™è¿›å…¥INPUTé“¾ï¼Œåˆ°è¾¾ç”¨æˆ·ç©ºé—´ã€‚è¿›ç¨‹å¯¹å¤–é€šä¿¡æ—¶ï¼Œç»ç”±OUTPUTé“¾å‡ºå»ï¼Œè·¯ç”±ä¹‹ååˆ°è¾¾POSTROUTINGé“¾ï¼Œç»ç½‘å¡å‡ºå»ã€‚å½“ä¸€æ•°æ®åŒ…ç»è¿‡PREROUTINGé“¾å‘ç°å…¶ä¸æ˜¯åˆ°è¾¾æœ¬ä¸»æœºï¼Œé‚£ä¹ˆæ•°æ®åŒ…ç»è¿‡FORWARDé“¾ï¼Œåˆ°è¾¾ POSTROUTINGé“¾è½¬å‘å‡ºå»ã€‚æœ¬æœºè¿›ç¨‹å¯¹å‘é€æ•°æ®æ—¶ï¼Œç»ç”±OUTPUTé“¾è·¯ç”±ä¹‹åè¿›å…¥POSTROUTINGé“¾å‡ºå»ã€‚iptablesåŒ¹é…è§„åˆ™æ—¶ï¼Œæ˜¯è‡ªä¸Šè€Œä¸‹åŒ¹é…çš„ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€æ¡è§„åˆ™æ—¶æ—¢è·³å‡ºï¼Œå¦åˆ™ä¸€ç›´å¾€ä¸‹åŒ¹é…ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤è§„åˆ™ã€‚iptablesè§„åˆ™å»ºç«‹æ—¶ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šåŠŸèƒ½ï¼ˆè¡¨ï¼‰ï¼Œç¡®å®šæŠ¥æ–‡æµå‘ï¼Œç¡®å®šè¦å®ç°çš„ç›®æ ‡ï¼Œç¡®å®šåŒ¹é…æ¡ä»¶ã€‚å°½é‡éµå¾ªä»¥ä¸‹è§„åˆ™ï¼šå°½é‡å‡å°‘è§„åˆ™æ¡ç›®ï¼Œå½¼æ­¤é—´æ— å…³è”ï¼Œè®¿é—®æ¡ç›®å¤§æ”¾ä¸Šé¢ï¼Œæœ‰å…³è”ï¼ˆåŒä¸€åŠŸèƒ½ï¼‰ï¼Œè§„åˆ™æ›´ä¸¥æ ¼çš„æ”¾ä¸Šé¢ äº”ä¸ªhookå‡½æ•°åˆ†åˆ«æ˜¯PREROUTING,INPUT ,OUTPUT,POSTROUTING,FORWARDï¼Œæˆ‘ä»¬æŠŠè¿™äº”ä¸ªé’©å­å‡½æ•°ç§°ä¸ºé“¾ï¼ŒNetfilterå®ç°äº†å‡ åŠŸèƒ½ï¼Œraw ï¼Œmangleï¼Œnatï¼Œfilterã€‚æˆ‘ä»¬ä¸€èˆ¬æŠŠè¿™å‡ ä¸ªåŠŸèƒ½ç§°ä¸ºè¡¨ï¼Œè¡¨ä¹‹é—´æœ‰ä¼˜å…ˆçº§å…³ç³»ï¼Œä»ä½åˆ°é«˜ä¸ºfilterâ€”-natâ€”-mangleâ€”-raw,è¡¨ä¸é“¾ä¹‹é—´æœ‰å¯¹åº”å…³ç³»ï¼Œå…·ä½“è§å›¾è¡¨ã€‚ è¡¨ rawè¡¨ï¼š å¯¹æŠ¥æ–‡è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œå†³å®šæ•°æ®åŒ…æ˜¯å¦è¢«çŠ¶æ€è·Ÿè¸ªæœºåˆ¶å¤„ç† mangleè¡¨ï¼š ä¸»è¦ç”¨äºä¿®æ”¹æ•°æ®åŒ… natè¡¨ï¼š ä¸»è¦ç”¨å¤„æ˜¯ç½‘ç»œåœ°å€è½¬æ¢ã€ç«¯å£æ˜ å°„ fileterè¡¨ï¼š ä¸»è¦ç”¨äºè¿‡æ»¤åŒ… ä¸€èˆ¬æƒ…å†µæˆ‘ä»¬å¯¹filterè¡¨åšé…ç½®çš„æ›´å¤šã€‚ é“¾ INPUTï¼š ä½œç”¨äºè¿›å…¥æœ¬æœºçš„åŒ… OUTPUTï¼š ä½œç”¨äºæœ¬æœºé€å‡ºçš„åŒ… FORWARDï¼š åŒ¹é…ç©¿è¿‡æœ¬æœºçš„æ•°æ®åŒ…ï¼ˆè½¬å‘ï¼‰ PREROUTINGï¼š ç”¨äºä¿®æ”¹ç›®çš„åœ°å€ï¼ˆDNATï¼‰ POSTROUTINGï¼šç”¨äºä¿®æ”¹æºåœ°å€ ï¼ˆSNATï¼‰ åŸºæœ¬æ“ä½œ12345678å¯åŠ¨æŒ‡ä»¤:service iptables start é‡å¯æŒ‡ä»¤:service iptables restart å…³é—­æŒ‡ä»¤:service iptables stopä¿å­˜æŒ‡ä»¤:service iptables saveæ¸…é™¤è§„åˆ™ï¼šiptables -F å°†é“¾çš„è®°æ•°çš„æµé‡æ¸…é›¶: iptables -Zæ¸…é™¤é“¾: iptables -Xæ¸…ç©ºiptablesæ—¶ä¸€èˆ¬-F -Z -Xä¸€èµ·ä½¿ç”¨ ä¸‰ç§çŠ¶æ€ ACCEPT å…è®¸ DROP ä¸¢å¼ƒ REJECT æ‹’ç» ROPå’ŒREJECTçš„åŒºåˆ«ï¼šDROPæ˜¯ç›´æ¥ä¸è®©è¿›å…¥ï¼Œè€ŒREJECTæ˜¯å…ˆè®©è¿›å…¥ç„¶åå†æ‹’ç»ï¼ŒLOGåœ¨/var/log/messagesæ–‡ä»¶ä¸­è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™. DROPæ›´å®‰å…¨ï¼Œæ‰€ä»¥ä¸€èˆ¬æ‹’ç»éƒ½ç”¨DROP -Aé»˜è®¤æ˜¯æ’å…¥åˆ°å°¾éƒ¨çš„ï¼Œå¯ä»¥-Iæ¥æ’å…¥åˆ°æŒ‡å®šä½ç½® iptablesçš„ä¸¤ç§é…ç½®æ€è·¯: é»˜è®¤å…è®¸ï¼Œæ‹’ç»ç‰¹åˆ« é»˜è®¤æ‹’ç»ï¼Œå…è®¸ç‰¹åˆ« äºŒè€…éƒ½æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼Œçœ‹æƒ…å†µè€Œå®šã€‚ä½†æ˜¯æ³¨æ„ï¼šå¦‚æœè¦é€‰æ‹©ç¬¬äºŒç§é…ç½®æ€è·¯ï¼Œé…ç½®å‰åˆ‡è®°å…ˆæŠŠsshè®¾ç½®ä¸ºACCEPTï¼Œå› ä¸ºä¸€èˆ¬æœºå™¨ä¸åœ¨æˆ‘ä»¬èº«è¾¹ï¼Œä¸€æ—¦é…ç½®é»˜è®¤æ‹’ç»ï¼Œé‚£æˆ‘ä»¬çš„è¿œç¨‹ç™»å½•å°±ä¼šæ–­å¼€è¿æ¥ï¼Œé‚£é—®é¢˜å°±å¤§äº†ã€‚é…ç½®é»˜è®¤æ‹’ç»å‰è®¾ç½®:12iptables -A INPUT -p tcp --dport 22 -j ACCEPT iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼šåšä¸€ä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œè®©iptableså®šæœŸåœæ­¢ï¼Œå³æ‰§è¡Œservice iptables stopï¼Œè¿™æ ·çš„è¯å³ä½¿é…ç½®é»˜è®¤æ‹’ç»å‰æ²¡æœ‰å…è®¸sshä¹Ÿæ²¡å…³ç³»ï¼Œç­‰åˆ°è®¡åˆ’ä»»åŠ¡ç”Ÿæ•ˆçš„æ—¶é—´iptableså°±ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰çš„é…ç½®ï¼ŒåŒ…æ‹¬é»˜è®¤è§„åˆ™ã€‚ iptablesçš„æ‰§è¡Œä¼˜å…ˆçº§: iptablesçš„æ‰§è¡Œé¡ºåºæ˜¯è‡ªä¸Šè€Œä¸‹ï¼Œå½“æœ‰é…ç½®äº§ç”Ÿå†²çªæ—¶ï¼Œå‰é¢æ‰§è¡Œçš„ç”Ÿæ•ˆã€‚ åˆ é™¤iptablesè§„åˆ™12345iptables -D INPUT 3 //åˆ é™¤inputçš„ç¬¬3æ¡è§„åˆ™iptables -t nat -D POSTROUTING 1 //åˆ é™¤natè¡¨ä¸­postroutingçš„ç¬¬ä¸€æ¡è§„åˆ™iptables -F INPUT //æ¸…ç©º filterè¡¨INPUTæ‰€æœ‰è§„åˆ™iptables -F //æ¸…ç©ºæ‰€æœ‰è§„åˆ™iptables -t nat -F POSTROUTING //æ¸…ç©ºnatè¡¨POSTROUTINGæ‰€æœ‰è§„åˆ™ åˆ é™¤è§„åˆ™ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶1234vim /etc/sysconfig/iptablesåˆ é™¤ç›¸åº”çš„è¡Œï¼Œç„¶åservice iptables restart service iptables save æ³¨æ„: ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ä¸èƒ½å…ˆsaveï¼Œä¸€å®šè¦å…ˆrestartæ‰èƒ½saveï¼Œè¦ä¸ç„¶å°±ç™½åšäº†ã€‚å› ä¸ºsaveä¼šåœ¨iptablesæœåŠ¡å¯åŠ¨æ—¶é‡æ–°åŠ è½½ï¼Œè¦æ˜¯åœ¨é‡å¯ä¹‹å‰ç›´æ¥å…ˆè°ƒç”¨äº†service iptables save é‚£ä¹ˆä½ çš„/etc/sysconfig/iptables é…ç½®å°±å›æ»šåˆ°ä¸Šæ¬¡å¯åŠ¨æœåŠ¡çš„é…ç½®äº†ã€‚ ç¬¬äºŒç§æ–¹æ³•ï¼šç›´æ¥ç”¨å‘½ä»¤åˆ é™¤ å¦‚æœä½ è®°å¾—é…ç½®æ—¶çš„å†™æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥iptables -D åè·Ÿä¸Šé…ç½®æ—¶çš„å†™æ³•ã€‚å¦‚ï¼š1iptables -D INPUT -s 10.72.11.12 -p tcp --sport 1234 -d 10.10.2.58 --dport 80 -j DROP æˆ–è€…æŸ¥çœ‹æ¯æ¡iptablesçš„åºå·123iptables -L INPUT --line-numbersç„¶ååˆ é™¤iptables -D INPUT 2 #åˆ é™¤ç¬¬2æ¡è§„åˆ™ï¼Œå³æ—¶ç”Ÿæ•ˆ é˜²ç«å¢™å¸¸ç”¨çš„ç­–ç•¥æ‹’ç»è¿›å…¥é˜²ç«å¢™çš„æ‰€æœ‰ICMPåè®®æ•°æ®åŒ…1iptables -I INPUT -p icmp -j REJECT å…è®¸é˜²ç«å¢™è½¬å‘é™¤ICMPåè®®ä»¥å¤–çš„æ‰€æœ‰æ•°æ®åŒ…1iptables -A FORWARD -p ! icmp -j ACCEPT æ‹’ç»è½¬å‘æ¥è‡ª192.168.1.10ä¸»æœºçš„æ•°æ®ï¼Œå…è®¸è½¬å‘æ¥è‡ª192.168.0.0/24ç½‘æ®µçš„æ•°æ®12iptables -A FORWARD -s 192.168.1.11 -j REJECT iptables -A FORWARD -s 192.168.0.0/24 -j ACCEPT ä¸¢å¼ƒä»å¤–ç½‘æ¥å£ï¼ˆeth1ï¼‰è¿›å…¥é˜²ç«å¢™æœ¬æœºçš„æºåœ°å€ä¸ºç§ç½‘åœ°å€çš„æ•°æ®åŒ…123iptables -A INPUT -i eth1 -s 192.168.0.0/16 -j DROP iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP å°å µç½‘æ®µï¼ˆ192.168.1.0/24ï¼‰ï¼Œä¸¤å°æ—¶åè§£å°ã€‚123iptables -I INPUT -s 10.20.30.0/24 -j DROP iptables -I FORWARD -s 10.20.30.0/24 -j DROP at now 2 hours at> iptables -D INPUT 1 at> iptables -D FORWARD 1 åªå…è®¸ç®¡ç†å‘˜ä»202.13.0.0/16ç½‘æ®µä½¿ç”¨SSHè¿œç¨‹ç™»å½•é˜²ç«å¢™ä¸»æœºã€‚12iptables -A INPUT -p tcp --dport 22 -s 202.13.0.0/16 -j ACCEPT iptables -A INPUT -p tcp --dport 22 -j DROP å…è®¸æœ¬æœºå¼€æ”¾ä»TCPç«¯å£20-1024æä¾›çš„åº”ç”¨æœåŠ¡12iptables -A INPUT -p tcp --dport 20:1024 -j ACCEPT iptables -A OUTPUT -p tcp --sport 20:1024 -j ACCEPT å…è®¸è½¬å‘æ¥è‡ª192.168.0.0/24å±€åŸŸç½‘æ®µçš„DNSè§£æè¯·æ±‚æ•°æ®åŒ…12iptables -A FORWARD -s 192.168.0.0/24 -p udp --dport 53 -j ACCEPT iptables -A FORWARD -d 192.168.0.0/24 -p udp --sport 53 -j ACCEPT ç¦æ­¢å…¶ä»–ä¸»æœºpingé˜²ç«å¢™ä¸»æœºï¼Œä½†æ˜¯å…è®¸ä»é˜²ç«å¢™ä¸Špingå…¶ä»–ä¸»æœº123iptables -I INPUT -p icmp --icmp-type Echo-Request -j DROP iptables -I INPUT -p icmp --icmp-type Echo-Reply -j ACCEPT iptables -I INPUT -p icmp --icmp-type destination-Unreachable -j ACCEPT ç¦æ­¢è½¬å‘æ¥è‡ªMACåœ°å€ä¸º00ï¼š0Cï¼š29ï¼š27ï¼š55ï¼š3Fçš„å’Œä¸»æœºçš„æ•°æ®åŒ…12iptables -A FORWARD -m mac --mac-source 00:0c:29:27:55:3F -j DROPè¯´æ˜ï¼šiptablesä¸­ä½¿ç”¨â€œ-m æ¨¡å—å…³é”®å­—â€çš„å½¢å¼è°ƒç”¨æ˜¾ç¤ºåŒ¹é…ã€‚è¿™é‡Œç”¨â€œ-m mac â€“mac-sourceâ€æ¥è¡¨ç¤ºæ•°æ®åŒ…çš„æºMACåœ°å€ã€‚ å…è®¸é˜²ç«å¢™æœ¬æœºå¯¹å¤–å¼€æ”¾TCPç«¯å£20ã€21ã€25ã€110ä»¥åŠè¢«åŠ¨æ¨¡å¼FTPç«¯å£1250-128012iptables -A INPUT -p tcp -m multiport --dport 20,21,25,110,1250:1280 -j ACCEPTè¯´æ˜ï¼šè¿™é‡Œç”¨â€œ-m multiport â€“dportâ€æ¥æŒ‡å®šç›®çš„ç«¯å£åŠèŒƒå›´ ç¦æ­¢è½¬å‘æºIPåœ°å€ä¸º192.168.1.20-192.168.1.99çš„TCPæ•°æ®åŒ…12iptables -A FORWARD -p tcp -m iprange --src-range 192.168.1.20-192.168.1.99 -j DROPè¯´æ˜ï¼šæ­¤å¤„ç”¨â€œ-m â€“iprange â€“src-rangeâ€æŒ‡å®šIPèŒƒå›´ã€‚ ç¦æ­¢è½¬å‘ä¸æ­£å¸¸TCPè¿æ¥æ— å…³çš„éâ€”synè¯·æ±‚æ•°æ®åŒ…12iptables -A FORWARD -m state --state NEW -p tcp ! --syn -j DROPè¯´æ˜ï¼šâ€œ-m stateâ€è¡¨ç¤ºæ•°æ®åŒ…çš„è¿æ¥çŠ¶æ€ï¼Œâ€œNEWâ€è¡¨ç¤ºä¸ä»»ä½•è¿æ¥æ— å…³çš„ æ‹’ç»è®¿é—®é˜²ç«å¢™çš„æ–°æ•°æ®åŒ…ï¼Œä½†å…è®¸å“åº”è¿æ¥æˆ–ä¸å·²æœ‰è¿æ¥ç›¸å…³çš„æ•°æ®åŒ…12iptables -A INPUT -p tcp -m state --state NEW -j DROP iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT è¯´æ˜ï¼šâ€œESTABLISHEDâ€è¡¨ç¤ºå·²ç»å“åº”è¯·æ±‚æˆ–è€…å·²ç»å»ºç«‹è¿æ¥çš„æ•°æ®åŒ…ï¼Œâ€œRELATEDâ€è¡¨ç¤ºä¸å·²å»ºç«‹çš„è¿æ¥æœ‰ç›¸å…³æ€§çš„ï¼Œæ¯”å¦‚FTPæ•°æ®è¿æ¥ç­‰ã€‚ åªå¼€æ”¾æœ¬æœºçš„webæœåŠ¡ï¼ˆ80ï¼‰ã€FTP(20ã€21ã€20450-20480)ï¼Œæ”¾è¡Œå¤–éƒ¨ä¸»æœºå‘ä½æœåŠ¡å™¨å…¶å®ƒç«¯å£çš„åº”ç­”æ•°æ®åŒ…ï¼Œå°†å…¶ä»–å…¥ç«™æ•°æ®åŒ…å‡äºˆä»¥ä¸¢å¼ƒå¤„ç†ã€‚1234iptables -I INPUT -p tcp -m multiport --dport 20,21,80 -j ACCEPT iptables -I INPUT -p tcp --dport 20450:20480 -j ACCEPT iptables -I INPUT -p tcp -m state --state ESTABLISHED -j ACCEPT iptables -P INPUT DROP ä¸‹é¢ä¸¤å¥è¯å¯ä»¥å®šä¹‰é»˜è®¤å…¨éƒ¨ä¸¢å¼ƒæ•°æ®åŒ…ï¼š12iptables -P INPUT DROPiptables -P OUTPUT DROP -På‚æ•°çš„æ„æ€æ˜¯policyï¼Œç¿»è¯‘æˆç­–ç•¥ï½é‚£ä¹ˆè¿™ä¸¤å¥è¯å°±å¥½ç†è§£äº†ã€‚ ç¬¬ä¸€å¥çš„æ„æ€æ˜¯ï¼š è¾“å…¥(INPUT)çš„æ•°æ®åŒ…é»˜è®¤çš„ç­–ç•¥(-P)æ˜¯ä¸¢å¼ƒ(DROP)çš„ ç¬¬äºŒå¥çš„æ„æ€æ˜¯ï¼š è¾“å‡º(OUTPUT)çš„æ•°æ®åŒ…é»˜è®¤çš„ç­–ç•¥(-P)æ˜¯ä¸¢å¼ƒ(DROP)çš„ å…¶å®åˆ°è¿™é‡Œå·²ç»æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„é˜²ç«å¢™äº†ï¼Œåªä¸è¿‡ï¼Œæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå’Œæ‹”æ‰ç½‘çº¿çš„æ¦‚å¿µæ²¡æœ‰ä»€ä¹ˆä¸åŒ é¦–å…ˆå†™ä¸‹è¿™6å¥è¯123456789101112iptables -A INPUT -p icmp --icmp-type any -j ACCEPTå…è®¸icmpåŒ…è¿›å…¥iptables -A INPUT -s localhost -d localhost -j ACCEPTå…è®¸æœ¬åœ°çš„æ•°æ®åŒ…iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPTå…è®¸å·²ç»å»ºç«‹å’Œç›¸å…³çš„æ•°æ®åŒ…è¿›å…¥iptables -A OUTPUT -p icmp --icmp any -j ACCEPTå…è®¸icmpåŒ…å‡ºå»iptables -A OUTPUT -s localhost -d localhost -j ACCEPTå…è®¸æœ¬åœ°æ•°æ®åŒ…iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPTå…è®¸å·²ç»å»ºç«‹å’Œç›¸å…³çš„æ•°æ®åŒ…å‡ºå» è¯´æ˜ä¸€ä¸‹ï¼Œè¿™6å¥åŸºæœ¬ä¸Šéƒ½æ˜¯è¦çš„ æŸ¥çœ‹natè¡¨1234iptables -t nat -vnL POSTROUTING --line-number Chain POSTROUTING (policy ACCEPT 38 packets, 2297 bytes) num pkts bytes target prot opt in out source destination 1 0 0 MASQUERADE all -- * * 192.168.10.0/24 0.0.0.0/0 æŸ¥çœ‹filterè¡¨12iptables -L -n --line-number |grep 21 //--line-numberå¯ä»¥æ˜¾ç¤ºè§„åˆ™åºå·ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™æ¯”è¾ƒæ–¹ä¾¿ 5 ACCEPT tcp -- 192.168.1.0/24 0.0.0.0/0 tcp dpt:21 æ€»ç»“é™„æœ€ç»å…¸çš„iptablesè„šæœ¬1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980#!/bin/sh#modprobe ipt_MASQUERADEmodprobe ip_conntrack_ftpmodprobe ip_nat_ftpiptables -Fiptables -t nat -Fiptables -Xiptables -t nat -X###########################INPUTé”®###################################iptables -P INPUT DROPiptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPTiptables -A INPUT -p tcp -m multiport --dports 110,80,25 -j ACCEPTiptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 139 -j ACCEPT#å…è®¸å†…ç½‘samba,smtp,pop3,è¿æ¥iptables -A INPUT -i eth1 -p udp -m multiport --dports 53 -j ACCEPT#å…è®¸dnsè¿æ¥iptables -A INPUT -p tcp --dport 1723 -j ACCEPTiptables -A INPUT -p gre -j ACCEPT#å…è®¸å¤–ç½‘vpnè¿æ¥iptables -A INPUT -s 192.186.0.0/24 -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPTiptables -A INPUT -i ppp0 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP#ä¸ºäº†é˜²æ­¢DOSå¤ªå¤šè¿æ¥è¿›æ¥,é‚£ä¹ˆå¯ä»¥å…è®¸æœ€å¤š15ä¸ªåˆå§‹è¿æ¥,è¶…è¿‡çš„ä¸¢å¼ƒiptables -A INPUT -s 192.186.0.0/24 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP#ä¸ºäº†é˜²æ­¢DOSå¤ªå¤šè¿æ¥è¿›æ¥,é‚£ä¹ˆå¯ä»¥å…è®¸æœ€å¤š15ä¸ªåˆå§‹è¿æ¥,è¶…è¿‡çš„ä¸¢å¼ƒiptables -A INPUT -p icmp -m limit --limit 3/s -j LOG --log-level INFO --log-prefix "ICMP packet IN: "iptables -A INPUT -p icmp -j DROP#ç¦æ­¢icmpé€šä¿¡-ping ä¸é€šiptables -t nat -A POSTROUTING -o ppp0 -s 192.168.0.0/24 -j MASQUERADE#å†…ç½‘è½¬å‘iptables -N syn-floodiptables -A INPUT -p tcp --syn -j syn-floodiptables -I syn-flood -p tcp -m limit --limit 3/s --limit-burst 6 -j RETURNiptables -A syn-flood -j REJECT#é˜²æ­¢SYNæ”»å‡» è½»é‡#######################FORWARDé“¾###########################iptables -P FORWARD DROPiptables -A FORWARD -p tcp -s 192.168.0.0/24 -m multiport --dports 80,110,21,25,1723 -j ACCEPTiptables -A FORWARD -p udp -s 192.168.0.0/24 --dport 53 -j ACCEPTiptables -A FORWARD -p gre -s 192.168.0.0/24 -j ACCEPTiptables -A FORWARD -p icmp -s 192.168.0.0/24 -j ACCEPT#å…è®¸ vpnå®¢æˆ·èµ°vpnç½‘ç»œè¿æ¥å¤–ç½‘iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPTiptables -I FORWARD -p udp --dport 53 -m string --string "tencent" -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROP#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqé€šä¿¡iptables -I FORWARD -p udp --dport 53 -m string --string "TENCENT" -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROP#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqé€šä¿¡iptables -I FORWARD -p udp --dport 53 -m string --string "tencent" -m time --timestart 13:30 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROPiptables -I FORWARD -p udp --dport 53 -m string --string "TENCENT" -m time --timestart 13:30 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROP#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„13:30-20:30ç¦æ­¢QQé€šä¿¡iptables -I FORWARD -s 192.168.0.0/24 -m string --string "qq.com" -m time --timestart 8:15 --timestop 12:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROP#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„8:00-12:30ç¦æ­¢qqç½‘é¡µiptables -I FORWARD -s 192.168.0.0/24 -m string --string "qq.com" -m time --timestart 13:00 --timestop 20:30 --days Mon,Tue,Wed,Thu,Fri,Sat -j DROP#æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸå…­çš„13:30-20:30ç¦æ­¢QQç½‘é¡µiptables -I FORWARD -s 192.168.0.0/24 -m string --string "ay2000.net" -j DROPiptables -I FORWARD -d 192.168.0.0/24 -m string --string "å®½é¢‘å½±é™¢" -j DROPiptables -I FORWARD -s 192.168.0.0/24 -m string --string "è‰²æƒ…" -j DROPiptables -I FORWARD -p tcp --sport 80 -m string --string "å¹¿å‘Š" -j DROP#ç¦æ­¢ay2000.netï¼Œå®½é¢‘å½±é™¢ï¼Œè‰²æƒ…ï¼Œå¹¿å‘Šç½‘é¡µè¿æ¥ ï¼ä½†ä¸­æ–‡ ä¸æ˜¯å¾ˆç†æƒ³iptables -A FORWARD -m ipp2p --edk --kazaa --bit -j DROPiptables -A FORWARD -p tcp -m ipp2p --ares -j DROPiptables -A FORWARD -p udp -m ipp2p --kazaa -j DROP#ç¦æ­¢BTè¿æ¥iptables -A FORWARD -p tcp --syn --dport 80 -m connlimit --connlimit-above 15 --connlimit-mask 24#######################################################################sysctl -w net.ipv4.ip_forward=1 &>/dev/null#æ‰“å¼€è½¬å‘#######################################################################sysctl -w net.ipv4.tcp_syncookies=1 &>/dev/null#æ‰“å¼€ syncookie ï¼ˆè½»é‡çº§é¢„é˜² DOS æ”»å‡»ï¼‰sysctl -w net.ipv4.netfilter.ip_conntrack_tcp_timeout_established=3800 &>/dev/null#è®¾ç½®é»˜è®¤ TCP è¿æ¥ç—´å‘†æ—¶é•¿ä¸º 3800 ç§’ï¼ˆæ­¤é€‰é¡¹å¯ä»¥å¤§å¤§é™ä½è¿æ¥æ•°ï¼‰sysctl -w net.ipv4.ip_conntrack_max=300000 &>/dev/null#è®¾ç½®æ”¯æŒæœ€å¤§è¿æ¥æ ‘ä¸º 30Wï¼ˆè¿™ä¸ªæ ¹æ®ä½ çš„å†…å­˜å’Œ iptables ç‰ˆæœ¬æ¥ï¼Œæ¯ä¸ª connection éœ€è¦ 300 å¤šä¸ªå­—èŠ‚ï¼‰#######################################################################iptables -I INPUT -s 192.168.0.50 -j ACCEPTiptables -I FORWARD -s 192.168.0.50 -j ACCEPT#192.168.0.50æ˜¯æˆ‘çš„æœºå­ï¼Œå…¨éƒ¨æ”¾è¡Œï¼############################å®Œ######################################### document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux awk å‘½ä»¤]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-awk%2F</url>
    <content type="text"><![CDATA[å¯¹ä»Šå¤©è§£å†³ä¸äº†çš„äº‹æƒ…ï¼Œä¹Ÿä¸è¦ç€æ€¥ã€‚å› ä¸ºæ˜å¤©ä¹Ÿå¯èƒ½è¿˜æ˜¯è§£å†³ä¸äº†ã€‚ awkå‘½ä»¤ä¾‹å­ï¼š123456æ‰“å°æ–‡ä»¶çš„ç¬¬ä¸€åˆ—(åŸŸ) awk '{print $1}' filenameæ‰“å°æ–‡ä»¶çš„å‰ä¸¤åˆ—(åŸŸ) awk '{print $1,$2}' filenameæ‰“å°å®Œç¬¬ä¸€åˆ—ï¼Œç„¶åæ‰“å°ç¬¬äºŒåˆ— awk '{print $1 $2}' filenameæ‰“å°æ–‡æœ¬æ–‡ä»¶çš„æ€»è¡Œæ•° awk 'END{print NR}' filenameæ‰“å°æ–‡æœ¬ç¬¬ä¸€è¡Œ awk 'NR==1{print}' filenameæ‰“å°æ–‡æœ¬ç¬¬äºŒè¡Œç¬¬ä¸€åˆ— sed -n "2, 1p" filename | awk 'print $1' Bashé‡Œé¢çš„èµ‹å€¼æ–¹æ³•æœ‰ä¸¤ç§ï¼Œæ ¼å¼ä¸º121) arg=`(å‘½ä»¤)`2) arg=$(å‘½ä»¤) æƒ³è¦æŠŠæŸä¸€æ–‡ä»¶çš„æ€»è¡Œæ•°èµ‹å€¼ç»™å˜é‡nlinesï¼Œå¯ä»¥è¡¨è¾¾ä¸ºï¼š1231) nlines=`(awk 'END{print NR}' filename)`æˆ–2) nlines=$(awk 'END{print NR}' filename) 123456awk '/[^0-9][0-9].*Starting the backup operation/{print $1,$2}' /data/backup/logs/all.log#181217 02:12:48#181217 02:12:48 innobackupex: Starting the backup operationawk '/[^0-9][0-9].*OK\!/{print $1,$2}' /data/backup/logs/all.log#181217 03:51:21#181217 03:51:21 completed OK! æ—¶é—´ç›¸å‡1awk 'BEGIN{tstamp1=mktime("2108 12 18 02 12 48");tstamp2=mktime("2018 12 19 03 51 12");print tstamp2-tstamp1;}' ä»åº“å‘¨æœŸæ€§å»¶è¿Ÿ éœ€è¦ä½ ä»binlogä¸­æ‰¾å‡ºæ‰¾ä¸ªbinlog å„ç§æ“ä½œçš„ç»Ÿè®¡1mysqlbinlog --no-defaults --base64-output='decode-rows' -v -v mysql-bin.004177 | awk '/UPDATE|INSERT|DELETE/{gsub("###","");gsub("INSERT.*INTO","INSERT");gsub("DELETE.*FROM","DELETE");count[$1" "$2]++}END{for(i in count)print i,"\t",count[i]}' |sort -k3nr|head -n 20 netstat and AWK123456789netstat -an | awk '/^tcp/ {++S[$NF]};END {for(a in S) print a,S[a]}'netstat -an | awk '/^tcp/ {++state[$NF]}; END {for(key in state) print key,"\t",state[key]}'netstat -ant | awk '{print $NF}' | grep -v '[a-z]' | sort | uniq -cnetstat -anlp | grep 3306 | grep tcp | awk '{print $5}' | awk -F: '{print $1}' | sort | uniq -c | sort -nr | head -n20netstat -ant | awk '/:3306/{split($5,ip,":");++A[ip[1]]}END{for(i in A) print A[i],i}' | sort -nr | head -n20netstat -an | grep SYN | awk '{print $5}' | awk -F: '{print $1}' | sort | uniq -c | sort -nr | moretcpdump -i eno16777736 -tnn dst port 80 -c 1000 | awk -F"." '{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort -nr | head -20 æŸ¥çœ‹è¡¨çš„å¤§å°æ’åº12du -s *|grep ibd|sort|uniq -u|sort -nr|awk '{print $2}'|xargs du -shdu -s *|grep ibd|sort|uniq -u|sort -nr|awk '{print $2}'|sort|uniq -u|xargs du -sh åƒµå°¸è¿›ç¨‹1ps -A -o stat,ppid,pid,cmd | grep -e '\''^[Zz]'\'' | awk '\''{print }'\'' | xargs kill -9' document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨FIOæµ‹è¯•ä¸»æœºIOPSåŠå†™å…¥è¯»å–é€Ÿåº¦]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-fio%2F</url>
    <content type="text"><![CDATA[åˆ«è¯´ä½ ä¸€æ— æ‰€é•¿ï¼Œç†¬å¤œç©æ‰‹æœºä½ æ˜¯ä¸€æŠŠå¥½æ‰‹ã€‚ å‰è¨€å®‰è£…FIO1yum install fio -y å‚æ•°è¯´æ˜:1234567891011bs=4k å•æ¬¡ioçš„å—æ–‡ä»¶å¤§å°ä¸º4kbsrange=512-2048 åŒä¸Šï¼Œæå®šæ•°æ®å—çš„å¤§å°èŒƒå›´size=5g æœ¬æ¬¡çš„æµ‹è¯•æ–‡ä»¶å¤§å°ä¸º5gï¼Œä»¥æ¯æ¬¡4kçš„ioè¿›è¡Œæµ‹è¯•numjobs=30 æœ¬æ¬¡çš„æµ‹è¯•çº¿ç¨‹ä¸º30runtime=1000 æµ‹è¯•æ—¶é—´ä¸º1000ç§’ï¼Œå¦‚æœä¸å†™åˆ™ä¸€ç›´å°†5gæ–‡ä»¶åˆ†4kæ¯æ¬¡å†™å®Œä¸ºæ­¢ioengine=psync ioå¼•æ“ä½¿ç”¨pyncæ–¹å¼ï¼Œå¦‚æœè¦ä½¿ç”¨libaioå¼•æ“ï¼Œéœ€è¦yum install libaio-develåŒ…rwmixwrite=30 åœ¨æ··åˆè¯»å†™çš„æ¨¡å¼ä¸‹ï¼Œå†™å 30%group_reporting å…³äºæ˜¾ç¤ºç»“æœçš„ï¼Œæ±‡æ€»æ¯ä¸ªè¿›ç¨‹çš„ä¿¡æ¯æ­¤å¤–lockmem=1g åªä½¿ç”¨1gå†…å­˜è¿›è¡Œæµ‹è¯•zero_buffers ç”¨0åˆå§‹åŒ–ç³»ç»Ÿbuffernrfiles=8 æ¯ä¸ªè¿›ç¨‹ç”Ÿæˆæ–‡ä»¶çš„æ•°é‡ FIO å‘½ä»¤12345678910111213141516171819202122232425262728293031323334fio -direct=1 -iodepth=128 -rw=write -ioengine=libaio -bs=4k -size=100G -numjobs=1 -runtime=1000 -group_reporting -name=test -filename=/data/test111è¿è¡Œç»“æœï¼štest: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=128fio-2.0.13Starting 1 processtest: Laying out IO file(s) (1 file(s) / 102400MB)Jobs: 1 (f=1): [W] [100.0% done] [0K/129.3M/0K /s] [0 /33.1K/0 iops] [eta 00m:00s]test: (groupid=0, jobs=1): err= 0: pid=594: Mon May 14 10:27:54 2018 write: io=102400MB, bw=129763KB/s, iops=32440 , runt=808070msec slat (usec): min=0 , max=80322 , avg=12.06, stdev=24.73 clat (usec): min=222 , max=254410 , avg=3932.47, stdev=5007.90 lat (usec): min=622 , max=254416 , avg=3944.82, stdev=5007.26 clat percentiles (usec): | 1.00th=[ 1288], 5.00th=[ 1560], 10.00th=[ 1736], 20.00th=[ 1992], | 30.00th=[ 2224], 40.00th=[ 2480], 50.00th=[ 2736], 60.00th=[ 3088], | 70.00th=[ 3536], 80.00th=[ 4320], 90.00th=[ 6624], 95.00th=[ 9664], | 99.00th=[21120], 99.50th=[37632], 99.90th=[54528], 99.95th=[78336], | 99.99th=[177152] bw (KB/s) : min=20720, max=215424, per=100.00%, avg=129801.50, stdev=19878.75 lat (usec) : 250=0.01%, 750=0.01%, 1000=0.09% lat (msec) : 2=20.47%, 4=56.01%, 10=18.78%, 20=3.20%, 50=1.33% lat (msec) : 100=0.09%, 250=0.02%, 500=0.01% cpu : usr=4.88%, sys=36.64%, ctx=9409837, majf=0, minf=23 IO depths : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, >=64=100.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.1% issued : total=r=0/w=26214400/d=0, short=r=0/w=0/d=0Run status group 0 (all jobs): WRITE: io=102400MB, aggrb=129763KB/s, minb=129763KB/s, maxb=129763KB/s, mint=808070msec, maxt=808070msecDisk stats (read/write): vdb: ios=0/26203032, merge=0/3962, ticks=0/90681446, in_queue=90672667, util=100.00% 100%éšæœºï¼Œ100%è¯»ï¼Œ4K12345678910111213141516171819202122232425262728293031323334353637383940414243444546fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=rand_100read_4kè¿è¡Œç»“æœï¼šrand_100read_4k: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1...rand_100read_4k: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1fio-2.0.13Starting 50 threadsJobs: 50 (f=50): [rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr] [100.0% done] [47544K/0K/0K /s] [11.9K/0 /0 iops] [eta 00m:00s]rand_100read_4k: (groupid=0, jobs=50): err= 0: pid=25884: Mon May 14 14:59:44 2018 read : io=8454.3MB, bw=48091KB/s, iops=12022 , runt=180018msec clat (usec): min=318 , max=167471 , avg=4156.60, stdev=8363.94 lat (usec): min=318 , max=167472 , avg=4156.89, stdev=8363.95 clat percentiles (usec): | 1.00th=[ 1032], 5.00th=[ 1176], 10.00th=[ 1240], 20.00th=[ 1352], | 30.00th=[ 1464], 40.00th=[ 1688], 50.00th=[ 1832], 60.00th=[ 1944], | 70.00th=[ 2064], 80.00th=[ 2288], 90.00th=[15808], 95.00th=[18560], | 99.00th=[20608], 99.50th=[39168], 99.90th=[134144], 99.95th=[144384], | 99.99th=[156672] bw (KB/s) : min= 231, max= 7248, per=2.00%, avg=961.78, stdev=384.46 lat (usec) : 500=0.05%, 750=0.20%, 1000=0.51% lat (msec) : 2=64.37%, 4=19.62%, 10=2.88%, 20=10.62%, 50=1.52% lat (msec) : 100=0.02%, 250=0.23% cpu : usr=0.00%, sys=0.02%, ctx=1813752, majf=18446744073709550866, minf=18446744073698419008 IO depths : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% issued : total=r=2164296/w=0/d=0, short=r=0/w=0/d=0Run status group 0 (all jobs): READ: io=8454.3MB, aggrb=48090KB/s, minb=48090KB/s, maxb=48090KB/s, mint=180018msec, maxt=180018msecDisk stats (read/write): vdb: ios=2163559/42, merge=23/10, ticks=8925036/223, in_queue=8922540, util=99.94%100%éšæœºï¼Œ100%å†™ï¼Œ 4K[root@test-db data]# fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randwrite -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=rand_100write_4kè¿è¡Œç»“æœï¼šrand_100write_4k: (g=0): rw=randwrite, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1...rand_100write_4k: (g=0): rw=randwrite, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1fio-2.0.13Starting 50 threadsJobs: 50 (f=50): [wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww] [100.0% done] [0K/47996K/0K /s] [0 /11.1K/0 iops] [eta 00m:00s]rand_100write_4k: (groupid=0, jobs=50): err= 0: pid=25963: Mon May 14 15:08:43 2018 write: io=8445.5MB, bw=48039KB/s, iops=12009 , runt=180024msec 100%é¡ºåºï¼Œ100%è¯» ï¼Œ4K1234567891011121314151617181920212223242526272829303132fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=read -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=sqe_100read_4kè¿è¡Œç»“æœï¼šsqe_100read_4k: (g=0): rw=read, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1fio-2.0.13Starting 50 threadsJobs: 50 (f=50): [RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR] [100.0% done] [59996K/0K/0K /s] [14.1K/0 /0 iops] [eta 00m:00s]sqe_100read_4k: (groupid=0, jobs=50): err= 0: pid=26047: Mon May 14 15:13:02 2018 read : io=10599MB, bw=60295KB/s, iops=15073 , runt=180006msec clat (usec): min=253 , max=550591 , avg=3315.70, stdev=26406.30 lat (usec): min=254 , max=550591 , avg=3315.95, stdev=26406.30 clat percentiles (usec): | 1.00th=[ 1176], 5.00th=[ 1240], 10.00th=[ 1256], 20.00th=[ 1288], | 30.00th=[ 1336], 40.00th=[ 1368], 50.00th=[ 1416], 60.00th=[ 1480], | 70.00th=[ 1528], 80.00th=[ 1592], 90.00th=[ 1736], 95.00th=[ 2800], | 99.00th=[17792], 99.50th=[18816], 99.90th=[522240], 99.95th=[528384], | 99.99th=[536576] bw (KB/s) : min= 15, max= 2475, per=2.00%, avg=1206.47, stdev=634.32 lat (usec) : 500=0.01%, 750=0.01%, 1000=0.04% lat (msec) : 2=92.64%, 4=3.87%, 10=1.05%, 20=2.03%, 50=0.01% lat (msec) : 250=0.01%, 500=0.17%, 750=0.15% cpu : usr=0.05%, sys=0.23%, ctx=2697397, majf=0, minf=18446744073708900853 IO depths : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% issued : total=r=2713362/w=0/d=0, short=r=0/w=0/d=0Run status group 0 (all jobs): READ: io=10599MB, aggrb=60294KB/s, minb=60294KB/s, maxb=60294KB/s, mint=180006msec, maxt=180006msecDisk stats (read/write): vdb: ios=2711304/55, merge=1805/10, ticks=8899022/202, in_queue=8898860, util=100.00% 100%é¡ºåºï¼Œ100%å†™ ï¼Œ4K12345678910111213141516171819202122232425262728293031323334fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=sqe_100write_4kè¿è¡Œç»“æœï¼šsqe_100write_4k: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1...sqe_100write_4k: (g=0): rw=write, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1fio-2.0.13Starting 50 threadsJobs: 50 (f=50): [WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW] [100.0% done] [0K/55788K/0K /s] [0 /13.1K/0 iops] [eta 00m:00s]sqe_100write_4k: (groupid=0, jobs=50): err= 0: pid=26100: Mon May 14 15:17:24 2018 write: io=10002MB, bw=56896KB/s, iops=14224 , runt=180019msec clat (usec): min=583 , max=457330 , avg=3513.01, stdev=9958.13 lat (usec): min=584 , max=457331 , avg=3513.60, stdev=9958.13 clat percentiles (usec): | 1.00th=[ 1224], 5.00th=[ 1384], 10.00th=[ 1480], 20.00th=[ 1592], | 30.00th=[ 1672], 40.00th=[ 1752], 50.00th=[ 1832], 60.00th=[ 1928], | 70.00th=[ 2096], 80.00th=[ 2480], 90.00th=[ 6368], 95.00th=[12480], | 99.00th=[20608], 99.50th=[37120], 99.90th=[166912], 99.95th=[268288], | 99.99th=[346112] bw (KB/s) : min= 152, max= 2432, per=2.01%, avg=1141.03, stdev=401.10 lat (usec) : 750=0.01%, 1000=0.11% lat (msec) : 2=65.06%, 4=21.62%, 10=7.36%, 20=4.40%, 50=1.24% lat (msec) : 100=0.08%, 250=0.06%, 500=0.07% cpu : usr=0.05%, sys=0.38%, ctx=2547790, majf=0, minf=18446744073708899536 IO depths : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% issued : total=r=0/w=2560604/d=0, short=r=0/w=0/d=0Run status group 0 (all jobs): WRITE: io=10002MB, aggrb=56896KB/s, minb=56896KB/s, maxb=56896KB/s, mint=180019msec, maxt=180019msecDisk stats (read/write): vdb: ios=63/2558949, merge=0/275, ticks=12/8897256, in_queue=8895411, util=100.00% 100%éšæœºï¼Œ70%è¯»ï¼Œ30%å†™ 4K123456789101112131415161718192021222324252627282930313233343536373839404142434445fio -filename=/dev/vdb1 -direct=1 -iodepth 1 -thread -rw=randrw -rwmixread=70 -ioengine=psync -bs=4k -size=100G -numjobs=50 -runtime=180 -group_reporting -name=randrw_70read_4kè¿è¡Œç»“æœï¼šrandrw_70read_4k: (g=0): rw=randrw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1...randrw_70read_4k: (g=0): rw=randrw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1fio-2.0.13Starting 50 threadsJobs: 50 (f=50): [mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm] [100.0% done] [48012K/20800K/0K /s] [12.3K/5200 /0 iops] [eta 00m:00s]randrw_70read_4k: (groupid=0, jobs=50): err= 0: pid=26162: Mon May 14 15:29:18 2018 read : io=8430.4MB, bw=47954KB/s, iops=11988 , runt=180020msec clat (usec): min=304 , max=177969 , avg=3045.60, stdev=5103.08 lat (usec): min=304 , max=177970 , avg=3045.87, stdev=5103.08 clat percentiles (usec): | 1.00th=[ 860], 5.00th=[ 1048], 10.00th=[ 1160], 20.00th=[ 1320], | 30.00th=[ 1448], 40.00th=[ 1560], 50.00th=[ 1656], 60.00th=[ 1768], | 70.00th=[ 1896], 80.00th=[ 2128], 90.00th=[ 4384], 95.00th=[17792], | 99.00th=[20352], 99.50th=[28544], 99.90th=[41216], 99.95th=[57088], | 99.99th=[127488] bw (KB/s) : min= 206, max= 4424, per=2.00%, avg=959.77, stdev=408.18 write: io=3613.8MB, bw=20556KB/s, iops=5138 , runt=180020msec clat (usec): min=569 , max=157336 , avg=2617.23, stdev=2821.20 lat (usec): min=570 , max=157337 , avg=2617.81, stdev=2821.20 clat percentiles (usec): | 1.00th=[ 1096], 5.00th=[ 1432], 10.00th=[ 1592], 20.00th=[ 1768], | 30.00th=[ 1912], 40.00th=[ 2040], 50.00th=[ 2160], 60.00th=[ 2288], | 70.00th=[ 2416], 80.00th=[ 2576], 90.00th=[ 2864], 95.00th=[ 3472], | 99.00th=[19328], 99.50th=[20352], 99.90th=[22400], 99.95th=[37632], | 99.99th=[52992] bw (KB/s) : min= 62, max= 1888, per=2.00%, avg=411.23, stdev=178.61 lat (usec) : 500=0.06%, 750=0.22%, 1000=2.28% lat (msec) : 2=61.13%, 4=27.68%, 10=3.02%, 20=4.48%, 50=1.07% lat (msec) : 100=0.04%, 250=0.01% cpu : usr=0.01%, sys=0.08%, ctx=2743663, majf=0, minf=18446744073698904078 IO depths : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0% issued : total=r=2158165/w=925122/d=0, short=r=0/w=0/d=0Run status group 0 (all jobs): READ: io=8430.4MB, aggrb=47953KB/s, minb=47953KB/s, maxb=47953KB/s, mint=180020msec, maxt=180020msec WRITE: io=3613.8MB, aggrb=20555KB/s, minb=20555KB/s, maxb=20555KB/s, mint=180020msec, maxt=180020msecDisk stats (read/write): vdb: ios=2154562/923535, merge=0/0, ticks=6503566/2394699, in_queue=8896553, util=99.93% æ€»ç»“æ‰§è¡Œç»“æœè¯´æ˜:123456789101112131415161718192021222324252627io=æ‰§è¡Œäº†å¤šå°‘Mçš„IObw=å¹³å‡IOå¸¦å®½iops=IOPSrunt=çº¿ç¨‹è¿è¡Œæ—¶é—´slat=æäº¤å»¶è¿Ÿclat=å®Œæˆå»¶è¿Ÿlat=å“åº”æ—¶é—´bw=å¸¦å®½cpu=åˆ©ç”¨ç‡IO depths=ioé˜Ÿåˆ—IO submit=å•ä¸ªIOæäº¤è¦æäº¤çš„IOæ•°IO complete=Like the above submit number, but for completions instead.IO issued=The number of read/write requests issued, and how many of them were short.IO latencies=IOå®Œå»¶è¿Ÿçš„åˆ†å¸ƒio=æ€»å…±æ‰§è¡Œäº†å¤šå°‘sizeçš„IOaggrb=groupæ€»å¸¦å®½minb=æœ€å°.å¹³å‡å¸¦å®½.maxb=æœ€å¤§å¹³å‡å¸¦å®½.mint=groupä¸­çº¿ç¨‹çš„æœ€çŸ­è¿è¡Œæ—¶é—´.maxt=groupä¸­çº¿ç¨‹çš„æœ€é•¿è¿è¡Œæ—¶é—´.ios=æ‰€æœ‰groupæ€»å…±æ‰§è¡Œçš„IOæ•°.merge=æ€»å…±å‘ç”Ÿçš„IOåˆå¹¶æ•°.ticks=Number of ticks we kept the disk busy.io_queue=èŠ±è´¹åœ¨é˜Ÿåˆ—ä¸Šçš„æ€»å…±æ—¶é—´.util=ç£ç›˜åˆ©ç”¨ç‡ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[curl æ¥æµ‹è¯•ç½‘ç«™-dnsè§£ææ—¶é—´,å“åº”æ—¶é—´,ä¼ è¾“æ—¶é—´]]></title>
    <url>%2F2019%2F04%2F22%2Fcurl-dns-time%2F</url>
    <content type="text"><![CDATA[æœ‰äº›äººåŠªåŠ›äº†ä¸€è¾ˆå­ï¼Œä¹Ÿå°±ä»ç¤¾ä¼šçš„å››æµè¿›å…¥äº†ä¸‰æµã€‚ è·å– è§£ææ—¶é—´:å“åº”æ—¶é—´:ä¼ è¾“æ—¶é—´12test_dbs2 ~ # curl -o /dev/null -s -w %{time_connect}:%{time_starttransfer}:%{time_total} https://jiemin.wang 0.104:0.000:18.174 ç»™å‡ºå¯¹ç«™ç‚¹æ‰§è¡Œ curl å‘½ä»¤çš„æƒ…å†µ.è¾“å‡ºé€šå¸¸æ˜¯ HTML ä»£ç ,é€šè¿‡ -o å‚æ•°å‘é€åˆ° /dev/null. -s å‚æ•°å»æ‰æ‰€æœ‰çŠ¶æ€ä¿¡æ¯. -w å‚æ•°è®© curl å†™å‡ºè®¡æ—¶å™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚ å‚æ•°è¯´æ˜:12345time_connect å»ºç«‹åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥æ‰€ç”¨çš„æ—¶é—´time_starttransfer åœ¨å‘å‡ºè¯·æ±‚ä¹‹å,Web æœåŠ¡å™¨è¿”å›æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€ç”¨çš„æ—¶é—´time_total å®Œæˆè¯·æ±‚æ‰€ç”¨çš„æ—¶é—´time_namelookup DNSè§£ææ—¶é—´,ä»è¯·æ±‚å¼€å§‹åˆ°DNSè§£æå®Œæ¯•æ‰€ç”¨æ—¶é—´(è®°å¾—å…³æ‰ Linux çš„ nscd çš„æœåŠ¡æµ‹è¯•)speed_download ä¸‹è½½é€Ÿåº¦ï¼Œå•ä½-å­—èŠ‚æ¯ç§’ã€‚ è¿™äº›è®¡æ—¶å™¨éƒ½ç›¸å¯¹äºäº‹åŠ¡çš„èµ·å§‹æ—¶é—´,ç”šè‡³è¦å…ˆäº Domain Name Serviceï¼ˆDNSï¼‰æŸ¥è¯¢.å› æ­¤,åœ¨å‘å‡ºè¯·æ±‚ä¹‹å,Web æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶å¼€å§‹å‘å›æ•°æ®æ‰€ç”¨çš„æ—¶é—´æ˜¯ 0.000 - 0.104 = 0 ç§’.å®¢æˆ·æœºä»æœåŠ¡å™¨ä¸‹è½½æ•°æ®æ‰€ç”¨çš„æ—¶é—´æ˜¯ 18.174 - 0.000 = 18 ç§’. é€šè¿‡è§‚å¯Ÿ curl æ•°æ®åŠå…¶éšæ—¶é—´å˜åŒ–çš„è¶‹åŠ¿,å¯ä»¥å¾ˆå¥½åœ°äº†è§£ç«™ç‚¹å¯¹ç”¨æˆ·çš„å“åº”æ€§.ä»¥ä¸Šå˜é‡ä¼šæŒ‰CURLè®¤ä¸ºåˆé€‚çš„æ ¼å¼è¾“å‡ºï¼Œè¾“å‡ºå˜é‡éœ€è¦æŒ‰ç…§%{variable_name}çš„æ ¼å¼ï¼Œå¦‚æœéœ€è¦è¾“å‡º%ï¼Œdoubleä¸€ä¸‹å³å¯ï¼Œå³%%ï¼ŒåŒæ—¶ï¼Œnæ˜¯æ¢è¡Œï¼Œræ˜¯å›è½¦ï¼Œtæ˜¯TABã€‚ å½“ç„¶,Web ç«™ç‚¹ä¸ä»…ä»…ç”±é¡µé¢ç»„æˆ.å®ƒè¿˜æœ‰å›¾åƒã€JavaScript ä»£ç ã€CSS å’Œ cookie è¦å¤„ç†.curl å¾ˆé€‚åˆäº†è§£å•ä¸€å…ƒç´ çš„å“åº”æ—¶é—´,ä½†æ˜¯æœ‰æ—¶å€™éœ€è¦äº†è§£æ•´ä¸ªé¡µé¢çš„è£…è½½é€Ÿåº¦. document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux-TIME-WAIT]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-TIME-WAIT%2F</url>
    <content type="text"><![CDATA[æ²¡äº‹å¬å¬åˆ«äººå£ä¸­çš„è‡ªå·±ï¼Œè¿™æ¯”çœ‹å¤§ç‰‡è¿˜åˆºæ¿€ï¼Œä½ ä¼šå‘ç°ä½ ä»€ä¹ˆéƒ½æ²¡åšï¼Œä½†å·²ç»æ¼”äº†å¥½å¤šç‰ˆæœ¬ï¼Œéƒ½æ˜¯å¤§è§’è‰²ã€‚ å‰è¨€TIME_WAIT çŠ¶æ€åŸç†å½“å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥æ—¶ï¼Œä¼šå‘é€æœ€åä¸€ä¸ªACKï¼Œç„¶åä¼šè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œå†åœç•™2ä¸ªMSLæ—¶é—´(çº¦1-4åˆ†é’Ÿ)ï¼Œè¿›å…¥CLOSEDçŠ¶æ€ã€‚ è¯¦ç»†CentOS6/7.xé»˜è®¤æ²¡æœ‰å¯¹ç³»ç»Ÿå‚æ•°è¿›è¡Œè®¾ç½®ï¼Œå½“å¤§é‡TIME_WAITäº§ç”Ÿçš„æ—¶å€™ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œ ç»Ÿè®¡TIME_WAITçŠ¶æ€æ•°é‡1netstat -ano | grep TIME_WAIT | wc -l æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿æ¥çŠ¶æ€1234567netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'TIME_WAIT 1280FIN_WAIT1 7SYN_SENT 1FIN_WAIT2 7ESTABLISHED 247LAST_ACK 1 æˆ‘ä»¬åªç”¨å…³å¿ƒTIME_WAITçš„ä¸ªæ•°ï¼Œåœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰1280å¤šä¸ªTIME_WAITï¼Œè¿™æ ·å°±å ç”¨äº†1280å¤šä¸ªç«¯å£ï¼Œç«¯å£çš„æ•°é‡åªæœ‰65535ä¸ªï¼Œå ç”¨ä¸€ä¸ªå°‘ä¸€ä¸ªï¼Œä¼šä¸¥é‡çš„å½±å“åˆ°åç»§çš„æ–°è¿æ¥ï¼Œå°±éœ€è°ƒæ•´ä¸‹Linuxçš„TCPå†…æ ¸å‚æ•°ï¼Œè®©ç³»ç»Ÿæ›´å¿«çš„é‡Šæ”¾TIME_WAITè¿æ¥ã€‚ è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š ä¿®æ”¹å†…æ ¸é…ç½®vim /etc/sysctl.conf ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š1234net.ipv4.tcp_syncookies = 1 #è¡¨ç¤ºå¼€å¯SYN Cookiesã€‚å½“å‡ºç°SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨cookiesæ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡SYNæ”»å‡»ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_tw_reuse = 1 #è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_tw_recycle = 1 #è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_fin_timeout = 30 #ä¿®æ”¹ç³»çµ±é»˜è®¤çš„ TIMEOUT æ—¶é—´ã€‚ ç„¶åæ‰§è¡Œ1/sbin/sysctl -p è®©å‚æ•°ç”Ÿæ•ˆã€‚ å‚æ•°è¯´æ˜:1234567891011121314151617181920212223242526272829303132net.ipv4.tcp_keepalive_time = 1200 #è¡¨ç¤ºå½“keepaliveèµ·ç”¨çš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2å°æ—¶ï¼Œæ”¹ä¸º20åˆ†é’Ÿã€‚net.ipv4.ip_local_port_range = 10000 65000 #è¡¨ç¤ºç”¨äºå‘å¤–è¿æ¥çš„ç«¯å£èŒƒå›´ã€‚ç¼ºçœæƒ…å†µä¸‹å¾ˆå°ï¼š32768åˆ°61000ï¼Œæ”¹ä¸º10000åˆ°65000ã€‚ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¸è¦å°†æœ€ä½å€¼è®¾çš„å¤ªä½ï¼Œå¦åˆ™å¯èƒ½ä¼šå ç”¨æ‰æ­£å¸¸çš„ç«¯å£ï¼ï¼‰net.ipv4.tcp_max_syn_backlog = 8192 #è¡¨ç¤ºSYNé˜Ÿåˆ—çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º1024ï¼ŒåŠ å¤§é˜Ÿåˆ—é•¿åº¦ä¸º8192ï¼Œå¯ä»¥å®¹çº³æ›´å¤šç­‰å¾…è¿æ¥çš„ç½‘ç»œè¿æ¥æ•°ã€‚net.ipv4.tcp_max_tw_buckets = 6000 #è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒTIME_WAITçš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚é»˜è®¤180000ï¼Œæ”¹ä¸º6000ã€‚å¯¹äºApacheã€Nginxç­‰æœåŠ¡å™¨ï¼Œä¸Šå‡ è¡Œçš„å‚æ•°å¯ä»¥å¾ˆå¥½åœ°å‡å°‘TIME_WAITå¥—æ¥å­—æ•°é‡ï¼Œä½†æ˜¯å¯¹äº Squidï¼Œæ•ˆæœå´ä¸å¤§ã€‚æ­¤é¡¹å‚æ•°å¯ä»¥æ§åˆ¶TIME_WAITçš„æœ€å¤§æ•°é‡ï¼Œé¿å…SquidæœåŠ¡å™¨è¢«å¤§é‡çš„TIME_WAITæ‹–æ­»ã€‚å†…æ ¸å…¶ä»–TCPå‚æ•°è¯´æ˜ï¼šnet.ipv4.tcp_max_syn_backlog = 65536 #è®°å½•çš„é‚£äº›å°šæœªæ”¶åˆ°å®¢æˆ·ç«¯ç¡®è®¤ä¿¡æ¯çš„è¿æ¥è¯·æ±‚çš„æœ€å¤§å€¼ã€‚å¯¹äºæœ‰128Må†…å­˜çš„ç³»ç»Ÿè€Œè¨€ï¼Œç¼ºçœå€¼æ˜¯1024ï¼Œå°å†…å­˜çš„ç³»ç»Ÿåˆ™æ˜¯128ã€‚net.core.netdev_max_backlog = 32768 #æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚net.core.somaxconn = 32768 #webåº”ç”¨ä¸­listenå‡½æ•°çš„backlogé»˜è®¤ä¼šç»™æˆ‘ä»¬å†…æ ¸å‚æ•°çš„net.core.somaxconné™åˆ¶åˆ°128ï¼Œè€Œnginxå®šä¹‰çš„NGX_LISTEN_BACKLOGé»˜è®¤ä¸º511ï¼Œæ‰€ä»¥æœ‰å¿…è¦è°ƒæ•´è¿™ä¸ªå€¼ã€‚net.core.wmem_default = 8388608net.core.rmem_default = 8388608net.core.rmem_max = 16777216 #æœ€å¤§socketè¯»buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼:873200net.core.wmem_max = 16777216 #æœ€å¤§socketå†™buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼:873200net.ipv4.tcp_timestsmps = 0 #æ—¶é—´æˆ³å¯ä»¥é¿å…åºåˆ—å·çš„å·ç»•ã€‚ä¸€ä¸ª1Gbpsçš„é“¾è·¯è‚¯å®šä¼šé‡åˆ°ä»¥å‰ç”¨è¿‡çš„åºåˆ—å·ã€‚æ—¶é—´æˆ³èƒ½å¤Ÿè®©å†…æ ¸æ¥å—è¿™ç§â€œå¼‚å¸¸â€çš„æ•°æ®åŒ…ã€‚è¿™é‡Œéœ€è¦å°†å…¶å…³æ‰ã€‚net.ipv4.tcp_synack_retries = 2 #ä¸ºäº†æ‰“å¼€å¯¹ç«¯çš„è¿æ¥ï¼Œå†…æ ¸éœ€è¦å‘é€ä¸€ä¸ªSYNå¹¶é™„å¸¦ä¸€ä¸ªå›åº”å‰é¢ä¸€ä¸ªSYNçš„ACKã€‚ä¹Ÿå°±æ˜¯æ‰€è°“ä¸‰æ¬¡æ¡æ‰‹ä¸­çš„ç¬¬äºŒæ¬¡æ¡æ‰‹ã€‚è¿™ä¸ªè®¾ç½®å†³å®šäº†å†…æ ¸æ”¾å¼ƒè¿æ¥ä¹‹å‰å‘é€SYN+ACKåŒ…çš„æ•°é‡ã€‚net.ipv4.tcp_syn_retries = 2 #åœ¨å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYNåŒ…çš„æ•°é‡ã€‚net.ipv4.tcp_tw_reuse = 1 # å¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ã€‚net.ipv4.tcp_wmem = 8192 436600 873200 # TCPå†™buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼: 8192 436600 873200net.ipv4.tcp_rmem = 32768 436600 873200 # TCPè¯»buffer,å¯å‚è€ƒçš„ä¼˜åŒ–å€¼: 32768 436600 873200net.ipv4.tcp_mem = 94500000 91500000 92700000 # åŒæ ·æœ‰3ä¸ªå€¼,æ„æ€æ˜¯:net.ipv4.tcp_mem[0]:ä½äºæ­¤å€¼ï¼ŒTCPæ²¡æœ‰å†…å­˜å‹åŠ›ã€‚net.ipv4.tcp_mem[1]:åœ¨æ­¤å€¼ä¸‹ï¼Œè¿›å…¥å†…å­˜å‹åŠ›é˜¶æ®µã€‚net.ipv4.tcp_mem[2]:é«˜äºæ­¤å€¼ï¼ŒTCPæ‹’ç»åˆ†é…socketã€‚ä¸Šè¿°å†…å­˜å•ä½æ˜¯é¡µï¼Œè€Œä¸æ˜¯å­—èŠ‚ã€‚å¯å‚è€ƒçš„ä¼˜åŒ–å€¼æ˜¯:786432 1048576 1572864net.ipv4.tcp_max_orphans = 3276800 #ç³»ç»Ÿä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªTCPå¥—æ¥å­—ä¸è¢«å…³è”åˆ°ä»»ä½•ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶å¥æŸ„ä¸Šã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œè¿æ¥å°†å³åˆ»è¢«å¤ä½å¹¶æ‰“å°å‡ºè­¦å‘Šä¿¡æ¯ã€‚è¿™ä¸ªé™åˆ¶ä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢ç®€å•çš„DoSæ”»å‡»ï¼Œä¸èƒ½è¿‡åˆ†ä¾é å®ƒæˆ–è€…äººä¸ºåœ°å‡å°è¿™ä¸ªå€¼ï¼Œæ›´åº”è¯¥å¢åŠ è¿™ä¸ªå€¼(å¦‚æœå¢åŠ äº†å†…å­˜ä¹‹å)ã€‚net.ipv4.tcp_fin_timeout = 30 #å¦‚æœå¥—æ¥å­—ç”±æœ¬ç«¯è¦æ±‚å…³é—­ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†å®ƒä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ã€‚å¯¹ç«¯å¯ä»¥å‡ºé”™å¹¶æ°¸è¿œä¸å…³é—­è¿æ¥ï¼Œç”šè‡³æ„å¤–å½“æœºã€‚ç¼ºçœå€¼æ˜¯60ç§’ã€‚2.2 å†…æ ¸çš„é€šå¸¸å€¼æ˜¯180ç§’ï¼Œä½ å¯ä»¥æŒ‰è¿™ä¸ªè®¾ç½®ï¼Œä½†è¦è®°ä½çš„æ˜¯ï¼Œå³ä½¿ä½ çš„æœºå™¨æ˜¯ä¸€ä¸ªè½»è½½çš„WEBæœåŠ¡å™¨ï¼Œä¹Ÿæœ‰å› ä¸ºå¤§é‡çš„æ­»å¥—æ¥å­—è€Œå†…å­˜æº¢å‡ºçš„é£é™©ï¼ŒFIN- WAIT-2çš„å±é™©æ€§æ¯”FIN-WAIT-1è¦å°ï¼Œå› ä¸ºå®ƒæœ€å¤šåªèƒ½åƒæ‰1.5Kå†…å­˜ï¼Œä½†æ˜¯å®ƒä»¬çš„ç”Ÿå­˜æœŸé•¿äº›ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux dd å‘½ä»¤è¯¦è§£]]></title>
    <url>%2F2019%2F04%2F22%2Flinux-dd%2F</url>
    <content type="text"><![CDATA[ä¸€ç›´å¯¹å‘å‹å’Œèº«æä¸æ»¡æ„çš„äººï¼Œæœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šä¸è‚¯æ‰¿è®¤è¿™æ˜¯è„¸çš„é—®é¢˜ã€‚ å‰è¨€ddï¼šç”¨æŒ‡å®šå¤§å°çš„å—æ‹·è´ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨æ‹·è´çš„åŒæ—¶è¿›è¡ŒæŒ‡å®šçš„è½¬æ¢ã€‚ æ³¨æ„ï¼šæŒ‡å®šæ•°å­—çš„åœ°æ–¹è‹¥ä»¥ä¸‹åˆ—å­—ç¬¦ç»“å°¾ï¼Œåˆ™ä¹˜ä»¥ç›¸åº”çš„æ•°å­— b=512 c=1 k=1024 w=2 dd å‘½ä»¤ä¾‹å­dd åˆ›å»ºæµ‹è¯•æ–‡ä»¶12è¯­æ³•ï¼šCODE:[Copy to clipboard]dd ã€”é€‰é¡¹ã€• 123456789101112131415161718192021if =è¾“å…¥æ–‡ä»¶(æˆ–è®¾å¤‡åç§°)ã€‚of =è¾“å‡ºæ–‡ä»¶(æˆ–è®¾å¤‡åç§°)ã€‚ibs = bytes ä¸€æ¬¡è¯»å–byteså­—èŠ‚ï¼Œå³è¯»å…¥ç¼“å†²åŒºçš„å­—èŠ‚æ•°ã€‚skip = blocks è·³è¿‡è¯»å…¥ç¼“å†²åŒºå¼€å¤´çš„ibs*blockså—ã€‚obs = bytes ä¸€æ¬¡å†™å…¥byteså­—èŠ‚ï¼Œå³å†™ å…¥ç¼“å†²åŒºçš„å­—èŠ‚æ•°ã€‚bs = bytes åŒæ—¶è®¾ç½®è¯»/å†™ç¼“å†²åŒºçš„å­—èŠ‚æ•°(ç­‰äºè®¾ç½®obså’Œobs)ã€‚cbs = bytes ä¸€æ¬¡è½¬æ¢byteså­—èŠ‚ã€‚count = blocks åªæ‹·è´è¾“å…¥çš„blockså—ã€‚conv = ASCII æŠŠEBCDICç è½¬æ¢ä¸ºASCIIç ã€‚conv = ebcdic æŠŠASCIIç è½¬æ¢ä¸ºEBCDICç ã€‚conv = ibm æŠŠASCIIç è½¬æ¢ä¸ºalternate EBCDICç ã€‚conv = blick æŠŠå˜åŠ¨ä½è½¬æ¢æˆå›ºå®šå­—ç¬¦ã€‚conv = ublock æŠŠå›ºå®šä»¬è½¬æ¢æˆå˜åŠ¨ä½conv = ucase æŠŠå­—æ¯ç”±å°å†™å˜ä¸ºå¤§å†™ã€‚conv = lcase æŠŠå­—æ¯ç”±å¤§å†™å˜ä¸ºå°å†™ã€‚conv = notrunc ä¸æˆªçŸ­è¾“å‡ºæ–‡ä»¶ã€‚conv = swab äº¤æ¢æ¯ä¸€å¯¹è¾“å…¥å­—èŠ‚ã€‚conv = noerror å‡ºé”™æ—¶ä¸åœæ­¢å¤„ç†ã€‚conv = sync æŠŠæ¯ä¸ªè¾“å…¥è®°å½•çš„å¤§å°éƒ½è°ƒåˆ°ibsçš„å¤§å°(ç”¨ibså¡«å……)ã€‚fdformatå‘½ä»¤ä½çº§æ ¼å¼åŒ–è½¯ç›˜ã€‚ åˆ›å»ºä¸€ä¸ª2Gçš„æ–‡ä»¶1dd if=/dev/zero of=/tmp/test bs=1M count=2048 æµ‹è¯•ç¡¬ç›˜è¯»å†™é€Ÿåº¦é€šè¿‡ä¸¤ä¸ªå‘½ä»¤è¾“å‡ºçš„æ‰§è¡Œæ—¶é—´ï¼Œå¯ä»¥è®¡ç®—å‡ºæµ‹è¯•ç¡¬ç›˜çš„è¯»ï¼å†™é€Ÿåº¦:12dd if=/root/1Gb.file bs=64k | dd of=/dev/nulldd if=/dev/zero of=/root/1Gb.file bs=1024 count=1000000 é”€æ¯ç£ç›˜æ•°æ®1dd if=/dev/urandom of=/dev/hda1 æ³¨æ„ï¼šåˆ©ç”¨éšæœºçš„æ•°æ®å¡«å……ç¡¬ç›˜ï¼Œåœ¨æŸäº›å¿…è¦çš„åœºåˆå¯ä»¥ç”¨æ¥é”€æ¯æ•°æ®ã€‚ ç¡®å®šç¡¬ç›˜çš„æœ€ä½³å—å¤§å°1234dd if=/dev/zero bs=1024 count=1000000 of=/root/1Gb.filedd if=/dev/zero bs=2048 count=500000 of=/root/1Gb.filedd if=/dev/zero bs=4096 count=250000 of=/root/1Gb.filedd if=/dev/zero bs=8192 count=125000 of=/root/1Gb.file é€šè¿‡æ¯”è¾ƒä»¥ä¸Šå‘½ä»¤è¾“å‡ºä¸­æ‰€æ˜¾ç¤ºçš„å‘½ä»¤æ‰§è¡Œæ—¶é—´ï¼Œå³å¯ç¡®å®šç³»ç»Ÿæœ€ä½³çš„å—å¤§å°ã€‚ å¤‡ä»½ä¸æ¢å¤MBRå¤‡ä»½ç£ç›˜å¼€å§‹çš„512ä¸ªå­—èŠ‚å¤§å°çš„MBRä¿¡æ¯åˆ°æŒ‡å®šæ–‡ä»¶ï¼š12dd if=/dev/hda of=/root/image count=1 bs=512# count=1æŒ‡ä»…æ‹·è´ä¸€ä¸ªå—ï¼›bs=512æŒ‡å—å¤§å°ä¸º512ä¸ªå­—èŠ‚ã€‚ å°†å¤‡ä»½çš„MBRä¿¡æ¯å†™åˆ°ç£ç›˜å¼€å§‹éƒ¨åˆ†1dd if=/root/image of=/dev/had æ‹·è´å†…å­˜å†…å®¹åˆ°ç¡¬ç›˜12dd if=/dev/mem of=/root/mem.bin bs=1024# æŒ‡å®šå—å¤§å°ä¸º1k ä¿®å¤ç¡¬ç›˜123dd if=/dev/sda of=/dev/sdaæˆ–è€…dd if=/dev/hda of=/dev/hda å°†ä¸€ä¸ªå¾ˆå¤§çš„è§†é¢‘æ–‡ä»¶ä¸­çš„ç¬¬iä¸ªå­—èŠ‚çš„å€¼æ”¹æˆ0x41ï¼ˆä¹Ÿå°±æ˜¯å¤§å†™å­—æ¯Açš„ASCIIå€¼ï¼‰1echo A | dd of=bigfile seek=$i bs=1 count=1 conv=notrunc ç»“å°¾æ€»ç»“/dev/nullå’Œ/dev/zeroçš„åŒºåˆ« /dev/nullï¼Œå¤–å·å«æ— åº•æ´ï¼Œä½ å¯ä»¥å‘å®ƒè¾“å‡ºä»»ä½•æ•°æ®ï¼Œå®ƒé€šåƒï¼Œå¹¶ä¸”ä¸ä¼šæ’‘ç€ï¼ /dev/nullï¼Œå¤–å·å«æ— åº•æ´ï¼Œä½ å¯ä»¥å‘å®ƒè¾“å‡ºä»»ä½•æ•°æ®ï¼Œå®ƒé€šåƒï¼Œå¹¶ä¸”ä¸ä¼šæ’‘ç€ï¼ /dev/nullï¼Œå®ƒæ˜¯ç©ºè®¾å¤‡ï¼Œä¹Ÿç§°ä¸ºä½æ¡¶ï¼ˆbit bucketï¼‰ã€‚ä»»ä½•å†™å…¥å®ƒçš„è¾“å‡ºéƒ½ä¼šè¢«æŠ›å¼ƒã€‚å¦‚æœä¸æƒ³è®©æ¶ˆæ¯ä»¥æ ‡å‡†è¾“å‡ºæ˜¾ç¤ºæˆ–å†™å…¥æ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ¶ˆæ¯é‡å®šå‘åˆ°ä½æ¡¶ã€‚ /dev/zero,æ˜¯ä¸€ä¸ªè¾“å…¥è®¾å¤‡ï¼Œä½ å¯ä½ ç”¨å®ƒæ¥åˆå§‹åŒ–æ–‡ä»¶ã€‚ /dev/zero,æ˜¯ä¸€ä¸ªè¾“å…¥è®¾å¤‡ï¼Œä½ å¯ä½ ç”¨å®ƒæ¥åˆå§‹åŒ–æ–‡ä»¶ã€‚ /dev/zeroï¼Œè¯¥è®¾å¤‡æ— ç©·å°½åœ°æä¾›0ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•ä½ éœ€è¦çš„æ•°ç›®â€”â€”è®¾å¤‡æä¾›çš„è¦å¤šçš„å¤šã€‚ä»–å¯ä»¥ç”¨äºå‘è®¾å¤‡æˆ–æ–‡ä»¶å†™å…¥å­—ç¬¦ä¸²0ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¿®æ”¹sync_binlog innodb_flush_log_at_trx_commitå’Œsync_binlogå‚æ•° æé«˜å†™å…¥é€Ÿåº¦]]></title>
    <url>%2F2019%2F04%2F22%2Fsync-binlog-innodb-flush-log-at-trx-commit%2F</url>
    <content type="text"><![CDATA[èƒ¸å°çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¤§ï¼Œèƒ¸å¤§çš„å§‘å¨˜ä¸€èˆ¬è„¾æ°”éƒ½ç‰¹å¥½ï¼Œå› ä¸ºå¤è¯­æœ‰äº‘ï¼šç©·å‡¶ææ¶æœ‰å®¹ä¹ƒå¤§ï¼ å‰è¨€innodb_flush_log_at_trx_commitå’Œsync_binlog ä¸¤ä¸ªå‚æ•°æ˜¯æ§åˆ¶MySQL ç£ç›˜å†™å…¥ç­–ç•¥ä»¥åŠæ•°æ®å®‰å…¨æ€§çš„å…³é”®å‚æ•°ã€‚ è¯¦ç»†innodb_flush_log_at_trx_commit å¦‚æœinnodb_flush_log_at_trx_commitè®¾ç½®ä¸º0ï¼Œlog bufferå°†æ¯ç§’ä¸€æ¬¡åœ°å†™å…¥log fileä¸­ï¼Œå¹¶ä¸”log fileçš„flush(åˆ·åˆ°ç£ç›˜)æ“ä½œåŒæ—¶è¿›è¡Œï¼Œè¯¥æ¨¡å¼ä¸‹ï¼Œåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¸ä¼šä¸»åŠ¨è§¦å‘å†™å…¥ç£ç›˜çš„æ“ä½œã€‚ å¦‚æœinnodb_flush_log_at_trx_commitè®¾ç½®ä¸º1ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶MySQLéƒ½ä¼šæŠŠlog bufferçš„æ•°æ®å†™å…¥log fileï¼Œå¹¶ä¸”flush(åˆ·åˆ°ç£ç›˜)ä¸­å»ã€‚ å¦‚æœinnodb_flush_log_at_trx_commitè®¾ç½®ä¸º2ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶MySQLéƒ½ä¼šæŠŠlog bufferçš„æ•°æ®å†™å…¥log file.ä½†æ˜¯flush(åˆ·åˆ°ç£ç›˜)æ“ä½œå¹¶ä¸ä¼šåŒæ—¶è¿›è¡Œã€‚è¯¥æ¨¡å¼ä¸‹,MySQLä¼šæ¯ç§’æ‰§è¡Œä¸€æ¬¡ flush(åˆ·åˆ°ç£ç›˜)æ“ä½œã€‚ æ³¨ï¼šç”±äºè¿›ç¨‹è°ƒåº¦ç­–ç•¥é—®é¢˜,è¿™ä¸ªâ€æ¯ç§’æ‰§è¡Œä¸€æ¬¡ flush(åˆ·åˆ°ç£ç›˜)æ“ä½œâ€å¹¶ä¸æ˜¯ä¿è¯100%çš„â€æ¯ç§’â€ã€‚ sync_binlogsync_binlog çš„é»˜è®¤å€¼æ˜¯0ï¼Œåƒæ“ä½œç³»ç»Ÿåˆ·å…¶ä»–æ–‡ä»¶çš„æœºåˆ¶ä¸€æ ·ï¼ŒMySQLä¸ä¼šåŒæ­¥åˆ°ç£ç›˜ä¸­å»è€Œæ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿæ¥åˆ·æ–°binary logã€‚ å½“sync_binlog =N (N>0) ï¼ŒMySQL åœ¨æ¯å†™ Næ¬¡ äºŒè¿›åˆ¶æ—¥å¿—binary logæ—¶ï¼Œä¼šä½¿ç”¨fdatasync()å‡½æ•°å°†å®ƒçš„å†™äºŒè¿›åˆ¶æ—¥å¿—binary logåŒæ­¥åˆ°ç£ç›˜ä¸­å»ã€‚ å¦‚æœå¯ç”¨äº†autocommitï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªè¯­å¥statementå°±ä¼šæœ‰ä¸€æ¬¡å†™æ“ä½œï¼›å¦åˆ™æ¯ä¸ªäº‹åŠ¡å¯¹åº”ä¸€ä¸ªå†™æ“ä½œã€‚ ç”±æ­¤å¯è§ï¼Œå½“ä¸¤ä¸ªå‚æ•°è®¾ç½®ä¸ºåŒ1çš„æ—¶å€™ï¼Œå†™å…¥æ€§èƒ½æœ€å·®ï¼Œsync_binlog=N (N>1 ) and innodb_flush_log_at_trx_commit=2 æ—¶ï¼Œ(åœ¨å½“å‰æ¨¡å¼ä¸‹)MySQLçš„å†™æ“ä½œæ‰èƒ½è¾¾åˆ°æœ€é«˜æ€§èƒ½ã€‚ å½“innodb_flush_log_at_trx_commitå’Œsync_binlog éƒ½ä¸º 1 æ—¶æ˜¯æœ€å®‰å…¨çš„ï¼Œåœ¨mysqld æœåŠ¡å´©æºƒæˆ–è€…æœåŠ¡å™¨ä¸»æœºcrashçš„æƒ…å†µä¸‹ï¼Œbinary log åªæœ‰å¯èƒ½ä¸¢å¤±æœ€å¤šä¸€ä¸ªè¯­å¥æˆ–è€…ä¸€ä¸ªäº‹åŠ¡ã€‚ä½†æ˜¯é±¼ä¸ç†ŠæŒä¸å¯å…¼å¾—ï¼ŒåŒ11 ä¼šå¯¼è‡´é¢‘ç¹çš„ioæ“ä½œï¼Œå› æ­¤è¯¥æ¨¡å¼ä¹Ÿæ˜¯æœ€æ…¢çš„ä¸€ç§æ–¹å¼ã€‚ å½“innodb_flush_log_at_trx_commitè®¾ç½®ä¸º0ï¼Œmysqldè¿›ç¨‹çš„å´©æºƒä¼šå¯¼è‡´ä¸Šä¸€ç§’é’Ÿæ‰€æœ‰äº‹åŠ¡æ•°æ®çš„ä¸¢å¤±ã€‚ å½“innodb_flush_log_at_trx_commitè®¾ç½®ä¸º2ï¼Œåªæœ‰åœ¨æ“ä½œç³»ç»Ÿå´©æºƒæˆ–è€…ç³»ç»Ÿæ‰ç”µçš„æƒ…å†µä¸‹ï¼Œä¸Šä¸€ç§’é’Ÿæ‰€æœ‰äº‹åŠ¡æ•°æ®æ‰å¯èƒ½ä¸¢å¤±ã€‚ åŒ1é€‚åˆæ•°æ®å®‰å…¨æ€§è¦æ±‚éå¸¸é«˜ï¼Œè€Œä¸”ç£ç›˜IOå†™èƒ½åŠ›è¶³å¤Ÿæ”¯æŒä¸šåŠ¡ï¼Œæ¯”å¦‚è®¢å•,äº¤æ˜“,å……å€¼,æ”¯ä»˜æ¶ˆè´¹ç³»ç»Ÿã€‚ æ¨èçš„åšæ³•æ˜¯ innodb_flush_log_at_trx_commit=2 ï¼Œsync_binlog=N (Nä¸º500 æˆ–1000) ä¸”ä½¿ç”¨å¸¦è“„ç”µæ± åå¤‡ç”µæºçš„ç¼“å­˜cacheï¼Œé˜²æ­¢ç³»ç»Ÿæ–­ç”µå¼‚å¸¸ã€‚ ç³»ç»Ÿæ€§èƒ½å’Œæ•°æ®å®‰å…¨æ˜¯ä¸šåŠ¡ç³»ç»Ÿé«˜å¯ç”¨ç¨³å®šçš„å¿…è¦å› ç´ ã€‚æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„ä¼˜åŒ–éœ€è¦å¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½çš„ï¼Œæ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€æ±‚ï¼Œå¯ä»¥å°†ä¸¤ä¸ªå‚æ•°åšç»„åˆè°ƒæ•´ï¼Œä»¥ä¾¿æ˜¯dbç³»ç»Ÿçš„æ€§èƒ½è¾¾åˆ°æœ€ä¼˜åŒ–ã€‚ PS: ä¸¤ä¸ªéƒ½ä¸º1çš„æ—¶å€™ï¼Œå¯¼å…¥æ•°æ®çº¦18åˆ†é’Ÿï¼Œä¼˜åŒ–åå¯¼å…¥æ•´åº“çº¦3åˆ†é’Ÿã€‚12innodb_flush_log_at_trx_commit=2 sync_binlog=1000 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang æ‰§è¡Œ command]]></title>
    <url>%2F2019%2F04%2F20%2Fgo-command%2F</url>
    <content type="text"><![CDATA[ä½ å¹¶ä¸æ˜¯ä¸€æ— æ‰€æœ‰ï¼Œè‡³å°‘ä½ æœ‰è‚‰ã€‚ ä»£ç golangä¸­ä¼šç»å¸¸é‡åˆ°è¦ fork å­è¿›ç¨‹çš„éœ€æ±‚ã€‚go æ ‡å‡†åº“ä¸ºæˆ‘ä»¬å°è£…äº† os/execæ ‡å‡†åŒ…,å½“æˆ‘ä»¬è¦è¿è¡Œå¤–éƒ¨å‘½ä»¤æ—¶åº”è¯¥ä¼˜å…ˆä½¿ç”¨è¿™ä¸ªåº“ã€‚è¿™é‡Œæˆ‘ç®€å•ç»“åˆcontext å’Œ Cmd æ¨¡å—å†™ä¸€ä¸ªé€šç”¨çš„æ‰§è¡Œ command æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹:12345678910111213141516171819202122232425262728293031323334353637383940package mainimport ( "context" "os/exec" "syscall")func RunCmd(ctx context.Context, cmd *exec.Cmd) error { cmd.SysProcAttr = &syscall.SysProcAttr{ Setpgid: true, } if err := cmd.Start(); err != nil { return err } errCh := make(chan error, 1) go func() { errCh { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLé—ªå›åŸç†ä¸å®æˆ˜]]></title>
    <url>%2F2019%2F04%2F19%2Fmysql-flashback-priciple-and-practice%2F</url>
    <content type="text"><![CDATA[èƒ½ç”¨é’±è§£å†³çš„é—®é¢˜éƒ½ä¸æ˜¯é—®é¢˜ï¼Œå¯é—®é¢˜æ˜¯æˆ‘æ˜¯ç©·äººã€‚ DBAæˆ–å¼€å‘äººå‘˜ï¼Œæœ‰æ—¶ä¼šè¯¯åˆ æˆ–è€…è¯¯æ›´æ–°æ•°æ®ï¼Œå¦‚æœæ˜¯çº¿ä¸Šç¯å¢ƒå¹¶ä¸”å½±å“è¾ƒå¤§ï¼Œå°±éœ€è¦èƒ½å¿«é€Ÿå›æ»šã€‚ä¼ ç»Ÿæ¢å¤æ–¹æ³•æ˜¯åˆ©ç”¨å¤‡ä»½é‡æ­å®ä¾‹ï¼Œå†åº”ç”¨å»é™¤é”™è¯¯sqlåçš„binlogæ¥æ¢å¤æ•°æ®ã€‚æ­¤æ³•è´¹æ—¶è´¹åŠ›ï¼Œç”šè‡³éœ€è¦åœæœºç»´æŠ¤ï¼Œå¹¶ä¸é€‚åˆå¿«é€Ÿå›æ»šã€‚ä¹Ÿæœ‰å›¢é˜Ÿåˆ©ç”¨LVMå¿«ç…§æ¥ç¼©çŸ­æ¢å¤æ—¶é—´ï¼Œä½†å¿«ç…§çš„ç¼ºç‚¹æ˜¯ä¼šå½±å“mysqlçš„æ€§èƒ½ã€‚ MySQLé—ªå›(flashback)åˆ©ç”¨binlogç›´æ¥è¿›è¡Œå›æ»šï¼Œèƒ½å¿«é€Ÿæ¢å¤ä¸”ä¸ç”¨åœæœºã€‚æœ¬æ–‡å°†ä»‹ç»é—ªå›åŸç†ï¼Œç»™å‡ºç¬”è€…çš„å®æˆ˜ç»éªŒï¼Œå¹¶å¯¹ç°å­˜çš„é—ªå›å·¥å…·ä½œæ¯”è¾ƒã€‚ å¼€èƒƒèœæŸå¤©ï¼Œå°æ˜å› ç§ç§åŸå› ï¼Œè¯¯åˆ äº†å¤§æ‰¹çº¿ä¸Šç”¨æˆ·è¡¨çš„æ•°æ®ã€‚ä»–æ€¥å¿™æ‰¾åˆ°å…¬å¸DBAè¯·æ±‚å¸®åŠ©ï¼Œâ€œå®¢æœç”µè¯å·²è¢«æ‰“çˆ†ï¼Œå¤§é‡ç”¨æˆ·æŠ•è¯‰æ— æ³•ç™»é™†ï¼Œé¢†å¯¼éå¸¸æ¼ç«ã€‚è¯·é—®å¤šä¹…èƒ½æ¢å¤æ•°æ®ï¼Ÿâ€DBAä¸€è„¸æ‡µé€¼ï¼Œæ²‰é»˜åç§’åï¼Œä¼¸å‡ºä¸€æ ¹æ‰‹æŒ‡ã€‚â€œä½ çš„æ„æ€æ˜¯ä¸€åˆ†é’Ÿå°±èƒ½æ¢å¤ï¼Ÿå¤ªå¥½äº†ã€‚â€å°æ˜ç»ˆäºæœ‰äº›æ”¾æ¾ï¼Œéœ²å‡ºäº†ä¸€ä¸ç¬‘å®¹ã€‚â€œä¸ï¼Œæˆ‘ä»¬ä¸­æœ‰ä¸ªäººå°†ä¼šç¦»å¼€å…¬å¸ã€‚â€DBAæ²‰ç—›çš„è¯´é“ã€‚ å‹¿è®©æ‚²å‰§å‘ç”Ÿï¼Œå°½æ—©å°†æ­¤æ–‡è½¬ç»™å…¬å¸DBAã€‚ é—ªå›åŸç†binlogæ¦‚è¿° MySQL binlogä»¥eventçš„å½¢å¼ï¼Œè®°å½•äº†MySQL serverä»å¯ç”¨binlogä»¥æ¥æ‰€æœ‰çš„å˜æ›´ä¿¡æ¯ï¼Œèƒ½å¤Ÿå¸®åŠ©é‡ç°è¿™ä¹‹é—´çš„æ‰€æœ‰å˜åŒ–ã€‚MySQLå¼•å…¥binlogä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ï¼šä¸€æ˜¯ä¸ºäº†ä¸»ä»å¤åˆ¶ï¼›äºŒæ˜¯æŸäº›å¤‡ä»½è¿˜åŸæ“ä½œåéœ€è¦é‡æ–°åº”ç”¨binlogã€‚ æœ‰ä¸‰ç§å¯é€‰çš„binlogæ ¼å¼ï¼Œå„æœ‰ä¼˜ç¼ºç‚¹ï¼š statementï¼šåŸºäºSQLè¯­å¥çš„æ¨¡å¼ï¼Œbinlogæ•°æ®é‡å°ï¼Œä½†æ˜¯æŸäº›è¯­å¥å’Œå‡½æ•°åœ¨å¤åˆ¶è¿‡ç¨‹å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ç”šè‡³å‡ºé”™ï¼› rowï¼šåŸºäºè¡Œçš„æ¨¡å¼ï¼Œè®°å½•çš„æ˜¯è¡Œçš„å®Œæ•´å˜åŒ–ã€‚å¾ˆå®‰å…¨ï¼Œä½†æ˜¯binlogä¼šæ¯”å…¶ä»–ä¸¤ç§æ¨¡å¼å¤§å¾ˆå¤šï¼› mixedï¼šæ··åˆæ¨¡å¼ï¼Œæ ¹æ®è¯­å¥æ¥é€‰ç”¨æ˜¯statementè¿˜æ˜¯rowæ¨¡å¼ï¼› åˆ©ç”¨binlogé—ªå›ï¼Œéœ€è¦å°†binlogæ ¼å¼è®¾ç½®ä¸ºrowã€‚rowæ¨¡å¼ä¸‹ï¼Œä¸€æ¡ä½¿ç”¨innodbçš„insertä¼šäº§ç”Ÿå¦‚ä¸‹æ ¼å¼çš„binlogï¼š 123456789101112131415161718# at 1129#161225 23:15:38 server id 3773306082 end_log_pos 1197 Query thread_id=1903021 exec_time=0 error_code=0SET TIMESTAMP=1482678938/*!*/;BEGIN/*!*/;# at 1197#161225 23:15:38 server id 3773306082 end_log_pos 1245 Table_map: `test`.`user` mapped to number 290# at 1245#161225 23:15:38 server id 3773306082 end_log_pos 1352 Write_rows: table id 290 flags: STMT_END_FBINLOG 'muJfWBPiFOjgMAAAAN0EAAAAACIBAAAAAAEABHRlc3QABHVzZXIAAwMPEQMeAAACmuJfWB7iFOjgawAAAEgFAAAAACIBAAAAAAEAAgAD//gBAAAABuWwj+i1tVhK1hH4AgAAAAblsI/pkrFYStYg+AMAAAAG5bCP5a2ZWE/onPgEAAAABuWwj+adjlhNeAD4BQAAAAJ0dFhRYJM='/*!*/;# at 1352#161225 23:15:38 server id 3773306082 end_log_pos 1379 Xid = 5327954COMMIT/*!*/; é—ªå›åŸç† æ—¢ç„¶binlogä»¥eventå½¢å¼è®°å½•äº†æ‰€æœ‰çš„å˜æ›´ä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠéœ€è¦å›æ»šçš„eventï¼Œä»åå¾€å‰å›æ»šå›å»å³å¯ã€‚ å¯¹äºå•ä¸ªeventçš„å›æ»šï¼Œæˆ‘ä»¬ä»¥è¡¨test.useræ¥æ¼”ç¤ºåŸç† 12345678mysql> show create table test.user\G*************************** 1. row *************************** Table: userCreate Table: CREATE TABLE `user` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(10) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8 å¯¹äºdeleteæ“ä½œï¼Œæˆ‘ä»¬ä»binlogæå–å‡ºdeleteä¿¡æ¯ï¼Œç”Ÿæˆçš„å›æ»šè¯­å¥æ˜¯insertã€‚(æ³¨ï¼šä¸ºäº†æ–¹ä¾¿è§£é‡Šï¼Œæˆ‘ä»¬ç”¨binlog2sqlå°†åŸå§‹binlogè½¬åŒ–æˆäº†å¯è¯»SQL) 12åŸå§‹ï¼šDELETE FROM `test`.`user` WHERE `id`=1 AND `name`='å°èµµ';å›æ»šï¼šINSERT INTO `test`.`user`(`id`, `name`) VALUES (1, 'å°èµµ'); å¯¹äºinsertæ“ä½œï¼Œå›æ»šSQLæ˜¯deleteã€‚ 12åŸå§‹ï¼šINSERT INTO `test`.`user`(`id`, `name`) VALUES (2, 'å°é’±');å›æ»šï¼šDELETE FROM `test`.`user` WHERE `id`=2 AND `name`='å°é’±'; å¯¹äºupdateæ“ä½œï¼Œå›æ»šsqlåº”è¯¥äº¤æ¢SETå’ŒWHEREçš„å€¼ã€‚ 12åŸå§‹ï¼šUPDATE `test`.`user` SET `id`=3, `name`='å°æ' WHERE `id`=3 AND `name`='å°å­™';å›æ»šï¼šUPDATE `test`.`user` SET `id`=3, `name`='å°å­™' WHERE `id`=3 AND `name`='å°æ'; TIPS é—ªå›çš„ç›®æ ‡ï¼šå¿«é€Ÿç­›é€‰å‡ºçœŸæ­£éœ€è¦å›æ»šçš„æ•°æ®ã€‚ å…ˆæ ¹æ®åº“ã€è¡¨ã€æ—¶é—´åšä¸€æ¬¡è¿‡æ»¤ï¼Œå†æ ¹æ®ä½ç½®åšæ›´å‡†ç¡®çš„è¿‡æ»¤ã€‚ ç”±äºæ•°æ®ä¸€ç›´åœ¨å†™å…¥ï¼Œè¦ç¡®ä¿å›æ»šsqlä¸­ä¸åŒ…å«å…¶ä»–æ•°æ®ã€‚å¯æ ¹æ®æ˜¯å¦æ˜¯åŒä¸€äº‹åŠ¡ã€è¯¯æ“ä½œè¡Œæ•°ã€å­—æ®µå€¼çš„ç‰¹å¾ç­‰ç­‰æ¥å¸®åŠ©åˆ¤æ–­ã€‚ æ‰§è¡Œå›æ»šsqlæ—¶å¦‚æœ‰æŠ¥é”™ï¼Œéœ€è¦æŸ¥å®å…·ä½“åŸå› ï¼Œä¸€èˆ¬æ˜¯å› ä¸ºå¯¹åº”çš„æ•°æ®å·²å‘ç”Ÿå˜åŒ–ã€‚ç”±äºæ˜¯ä¸¥æ ¼çš„è¡Œæ¨¡å¼ï¼Œåªè¦æœ‰å”¯ä¸€é”®(åŒ…æ‹¬ä¸»é”®)å­˜åœ¨ï¼Œå°±åªä¼šæŠ¥æŸæ¡æ•°æ®ä¸å­˜åœ¨çš„é”™ï¼Œä¸å¿…æ‹…å¿ƒä¼šæ›´æ–°ä¸è¯¥æ“ä½œçš„æ•°æ®ã€‚ä¸šåŠ¡å¦‚æœæœ‰ç‰¹æ®Šé€»è¾‘ï¼Œæ•°æ®å›æ»šå¯èƒ½ä¼šå¸¦æ¥å½±å“ã€‚ å¦‚æœåªå›æ»šæŸå¼ è¡¨ï¼Œå¹¶ä¸”è¯¥è¡¨æœ‰å…³è”è¡¨ï¼Œå…³è”è¡¨å¹¶ä¸ä¼šè¢«å›æ»šï¼Œéœ€ä¸ä¸šåŠ¡æ–¹æ²Ÿé€šæ¸…æ¥šã€‚ å“ªäº›æ•°æ®éœ€è¦å›æ»šï¼Œè®©ä¸šåŠ¡æ–¹æ¥åˆ¤æ–­ï¼é—ªå›å·¥å…·MySQLé—ªå›ç‰¹æ€§æœ€æ—©ç”±é˜¿é‡Œå½­ç«‹å‹‹å¼€å‘ï¼Œå½­åœ¨2012å¹´ç»™å®˜æ–¹æäº¤äº†ä¸€ä¸ªpatchï¼Œå¹¶å¯¹é—ªå›è®¾è®¡æ€è·¯åšäº†è¯´æ˜(è®¾è®¡æ€è·¯å¾ˆæœ‰å¯å‘æ€§ï¼Œå¼ºçƒˆæ¨èé˜…è¯»)ã€‚ä½†æ˜¯å› ä¸ºç§ç§åŸå› ï¼Œä¸šå†…å®‰è£…è¿™ä¸ªpatchçš„å›¢é˜Ÿè‡³ä»Šè¿˜æ˜¯å°‘æ•°ï¼ŒçœŸæ­£åº”ç”¨åˆ°çº¿ä¸Šçš„æ›´æ˜¯å°‘ä¹‹åˆå°‘ã€‚å½­ä¹‹åï¼Œåˆæœ‰å¤šä½äººå‘˜é’ˆå¯¹ä¸åŒmysqlç‰ˆæœ¬ä¸åŒè¯­è¨€å¼€å‘äº†é—ªå›å·¥å…·ï¼ŒåŸç†ç”¨çš„éƒ½æ˜¯å½­çš„æ€è·¯ã€‚ æˆ‘å°†è¿™äº›é—ªå›å·¥å…·æŒ‰å®ç°æ–¹å¼åˆ†æˆäº†ä¸‰ç±»ã€‚ ç¬¬ä¸€ç±»æ˜¯ä»¥patchå½¢å¼é›†æˆåˆ°å®˜æ–¹å·¥å…·mysqlbinlogä¸­ã€‚ä»¥å½­æäº¤çš„patchä¸ºä»£è¡¨ã€‚ ä¼˜ç‚¹ ä¸Šæ‰‹æˆæœ¬ä½ã€‚mysqlbinlogåŸæœ‰çš„é€‰é¡¹éƒ½èƒ½ç›´æ¥åˆ©ç”¨ï¼Œåªæ˜¯å¤šåŠ äº†ä¸€ä¸ªé—ªå›é€‰é¡¹ã€‚é—ªå›ç‰¹æ€§æœªæ¥æœ‰å¯èƒ½è¢«å®˜æ–¹æ”¶å½•ã€‚ æ”¯æŒç¦»çº¿è§£æã€‚ ç¼ºç‚¹ å…¼å®¹æ€§å·®ã€é¡¹ç›®æ´»è·ƒåº¦ä¸é«˜ã€‚ç”±äºbinlogæ ¼å¼çš„å˜åŠ¨ï¼Œå¦‚æœé—ªå›å·¥å…·ä½œè€…ä¸åŠæ—¶å¯¹è¡¥ä¸å‡çº§ï¼Œåˆ™é—ªå›å·¥å…·å°†æ— æ³•ä½¿ç”¨ã€‚ç›®å‰å·²æœ‰å¤šä½äººå‘˜åˆ†åˆ«é’ˆå¯¹mysql5.5ï¼Œ5.6ï¼Œ5.7å¼€å‘äº†patchï¼Œéƒ¨åˆ†é¡¹ç›®ä»£ç å…¬å¼€ï¼Œä½†æ€»ä½“ä¸Šæ´»è·ƒåº¦éƒ½ä¸é«˜ã€‚ éš¾ä»¥æ·»åŠ æ–°åŠŸèƒ½ï¼Œå®æˆ˜æ•ˆæœæ¬ ä½³ã€‚åœ¨å®æˆ˜ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°ç°æœ‰patchä¸æ»¡è¶³éœ€æ±‚çš„æƒ…å†µï¼Œæ¯”å¦‚è¦åŠ ä¸ªè¡¨è¿‡æ»¤ï¼Œå¾ˆç®€å•çš„ä¸€ä¸ªéœ€æ±‚ï¼Œä»£ç æ”¹åŠ¨ä¹Ÿä¸ä¼šå¤§ï¼Œä½†å¯¹å¤§éƒ¨åˆ†DBAæ¥è¯´ï¼Œæ”¹mysqlæºç è¿˜æ˜¯å¾ˆå›°éš¾çš„äº‹ã€‚ å®‰è£…ç¨æ˜¾éº»çƒ¦ã€‚éœ€è¦å¯¹mysqlæºç æ‰“è¡¥ä¸å†ç¼–è¯‘ç”Ÿæˆã€‚ è¿™äº›ç¼ºç‚¹ï¼Œå¯èƒ½éƒ½æ˜¯é—ªå›æ²¡æœ‰æµè¡Œå¼€æ¥çš„åŸå› ã€‚ ç¬¬äºŒç±»æ˜¯ç‹¬ç«‹å·¥å…·ï¼Œé€šè¿‡ä¼ªè£…æˆslaveæ‹‰å–binlogæ¥è¿›è¡Œå¤„ç†ã€‚ä»¥binlog2sqlä¸ºä»£è¡¨ã€‚ ä¼˜ç‚¹ å…¼å®¹æ€§å¥½ã€‚ä¼ªè£…æˆslaveæ‹‰binlogè¿™é¡¹æŠ€æœ¯åœ¨ä¸šç•Œåº”ç”¨çš„éå¸¸å¹¿æ³›ï¼Œå¤šä¸ªå¼€å‘è¯­è¨€éƒ½æœ‰è¿™æ ·çš„æ´»è·ƒé¡¹ç›®ï¼ŒMySQLç‰ˆæœ¬çš„å…¼å®¹æ€§ç”±è¿™äº›é¡¹ç›®æå®šï¼Œé—ªå›å·¥å…·çš„å…¼å®¹é—®é¢˜ä¸å†çªå‡ºã€‚ æ·»åŠ æ–°åŠŸèƒ½çš„éš¾åº¦å°ã€‚æ›´å®¹æ˜“è¢«æ”¹é€ æˆDBAè‡ªå·±å–œæ¬¢çš„å½¢å¼ã€‚æ›´é€‚åˆå®æˆ˜ã€‚ å®‰è£…å’Œä½¿ç”¨ç®€å•ã€‚ ç¼ºç‚¹ å¿…é¡»å¼€å¯MySQL serverã€‚ ç¬¬ä¸‰ç±»æ˜¯ç®€å•è„šæœ¬ã€‚å…ˆç”¨mysqlbinlogè§£æå‡ºæ–‡æœ¬æ ¼å¼çš„binlogï¼Œå†æ ¹æ®å›æ»šåŸç†ç”¨æ­£åˆ™è¿›è¡ŒåŒ¹é…å¹¶æ›¿æ¢ã€‚ ä¼˜ç‚¹ è„šæœ¬å†™èµ·æ¥æ–¹ä¾¿ï¼Œå¾€å¾€èƒ½å¿«é€Ÿæå®šæŸä¸ªç‰¹å®šé—®é¢˜ã€‚ å®‰è£…å’Œä½¿ç”¨ç®€å•ã€‚ æ”¯æŒç¦»çº¿è§£æã€‚ ç¼ºç‚¹ é€šç”¨æ€§ä¸å¥½ã€‚ å¯é æ€§ä¸å¥½ã€‚ å°±ç›®å‰çš„é—ªå›å·¥å…·è€Œè¨€ï¼Œçº¿ä¸Šç¯å¢ƒçš„é—ªå›ï¼Œç¬”è€…å»ºè®®ä½¿ç”¨binlog2sqlï¼Œç¦»çº¿è§£æä½¿ç”¨mysqlbinlogã€‚ å…³äºDDLçš„flashbackæœ¬æ–‡æ‰€è¿°çš„flashbackä»…é’ˆå¯¹DMLè¯­å¥çš„å¿«é€Ÿå›æ»šã€‚ä½†å¦‚æœè¯¯æ“ä½œæ˜¯DDLçš„è¯ï¼Œæ˜¯æ— æ³•åˆ©ç”¨binlogåšå¿«é€Ÿå›æ»šçš„ï¼Œå› ä¸ºå³ä½¿åœ¨rowæ¨¡å¼ä¸‹ï¼Œbinlogå¯¹äºDDLæ“ä½œä¹Ÿä¸ä¼šè®°å½•æ¯è¡Œæ•°æ®çš„å˜åŒ–ã€‚è¦å®ç°DDLå¿«é€Ÿå›æ»šï¼Œå¿…é¡»ä¿®æ”¹MySQLæºç ï¼Œä½¿å¾—åœ¨æ‰§è¡ŒDDLå‰å…ˆå¤‡ä»½è€æ•°æ®ã€‚ç›®å‰æœ‰å¤šä¸ªmysqlå®šåˆ¶ç‰ˆæœ¬å®ç°äº†DDLé—ªå›ç‰¹æ€§ï¼Œé˜¿é‡Œæ—æ™“æ–Œå›¢é˜Ÿæäº¤äº†patchç»™MySQLå®˜æ–¹ï¼ŒMariaDBé¢„è®¡åœ¨ä¸ä¹…ååŠ å…¥åŒ…å«DDLçš„flashbackç‰¹æ€§ã€‚DDLé—ªå›çš„å‰¯ä½œç”¨æ˜¯ä¼šå¢åŠ é¢å¤–å­˜å‚¨ã€‚è€ƒè™‘åˆ°å…¶åº”ç”¨é¢‘æ¬¡å®åœ¨è¿‡ä½ï¼Œæœ¬æ–‡ä¸åšè¯¦è¿°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å»äº†è§£ï¼Œé‡è¦çš„å‡ ç¯‡æ–‡ç« æˆ‘åœ¨å‚è€ƒèµ„æ–™ä¸­åšäº†å¼•ç”¨ã€‚ å‚è€ƒèµ„æ–™[1] MySQL Internals Manual, Chapter 20 The Binary Log [2] å½­ç«‹å‹‹ï¼ŒMySQLä¸‹å®ç°é—ªå›çš„è®¾è®¡æ€è·¯ [3] Lixun Peng, Provide the flashback feature by binlog [4] ç‹å¹¿å‹ï¼Œmysqlbinlog flashback 5.6å®Œå…¨ä½¿ç”¨æ‰‹å†Œä¸åŸç† [5] å§œæ‰¿å°§, æ‹¿èµ°ä¸è°¢ï¼ŒFlashback for MySQL 5.7 [6] æ—æ™“æ–Œ, MySQLé—ªå›æ–¹æ¡ˆè®¨è®ºåŠå®ç° [7] xiaobin lin, flashback from binlog for MySQL [8] mariadb.com, AliSQL and some features that have made it into MariaDB Server [9] danfengcao, binlog2sql: Parse MySQL binlog to SQL you want æ–‡ç« æ¥è‡ªMySQLé—ªå›åŸç†ä¸å®æˆ˜ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MongoDB æ·»åŠ ç´¢å¼•å¼•å‘çš„æ•…éšœ]]></title>
    <url>%2F2019%2F04%2F17%2Fmongodb-creata-index%2F</url>
    <content type="text"><![CDATA[å’¸é±¼ç¿»èº«ï¼Œè¿˜æ˜¯å’¸é±¼ã€‚ åŸå› çº¿ä¸ŠMongoDBæœåŠ¡å™¨èµ„æºæŠ¥è­¦ï¼ŒæŸ¥çœ‹MongoDB logå‘ç°æœ‰å¤§é‡çš„æŸ¥è¯¢æ²¡æœ‰èµ°ç´¢å¼•ã€‚äºæ˜¯æ·»åŠ ç´¢å¼• æ“ä½œå…·ä½“çš„æŸ¥è¯¢è¯­å¥åˆ—å­:1command feeds.content_medium_hismatch command: count { count: "content_medium_hismatch", query: { update_time: { $gte: 1384099200000, $lt: 1384185600000 }, content_type_id: "28" } } planSummary: IXSCAN { content_type_id: 1 } keysExamined:191146 docsExamined:191146 fromMultiPlanner:1 replanned:1 numYields:10767 reslen:44 locks:{ Global: { acquireCount: { r: 21536 } }, Database: { acquireCount: { r: 10768 } }, Collection: { acquireCount: { r: 10768 } } } protocol:op_query 84011ms é€šè¿‡MongoDB explain()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122repset:PRIMARY> db.content_medium_hismatch.find({ count: "content_medium_hismatch", query: { update_time: { $gte: 1384099200000, $lt: 1384185600000 }, content_type_id: "28" }}).explain(){ "queryPlanner" : { "plannerVersion" : 1, "namespace" : "feeds.content_medium_hismatch", "indexFilterSet" : false, "parsedQuery" : { "$and" : [ { "count" : { "$eq" : "content_medium_hismatch" } }, { "query" : { "$eq" : { "update_time" : { "$gte" : 1384099200000, "$lt" : 1384185600000 }, "content_type_id" : "28" } } } ] }, "winningPlan" : { "stage" : "COLLSCAN", "filter" : { "$and" : [ { "count" : { "$eq" : "content_medium_hismatch" } }, { "query" : { "$eq" : { "update_time" : { "$gte" : 1384099200000, "$lt" : 1384185600000 }, "content_type_id" : "28" } } } ] }, "direction" : "forward" }, "rejectedPlans" : [ ] }, "serverInfo" : { "host" : "public-ops-mongodb2.wj.babytree-ops.org", "port" : 29001, "version" : "3.4.2", "gitVersion" : "3f76e40c105fc223b3e5aac3e20dcd026b83b38b" }, "ok" : 1}repset:PRIMARY> repset:PRIMARY> db.content_medium_hismatch.find({ count: "content_medium_hismatch", query: { update_time: { $gte: 1384099200000, $lt: 1384185600000 }, content_type_id: "28" }}).explain(){ "queryPlanner" : { "plannerVersion" : 1, "namespace" : "feeds.content_medium_hismatch", "indexFilterSet" : false, "parsedQuery" : { "$and" : [ { "count" : { "$eq" : "content_medium_hismatch" } }, { "query" : { "$eq" : { "update_time" : { "$gte" : 1384099200000, "$lt" : 1384185600000 }, "content_type_id" : "28" } } } ] }, "winningPlan" : { "stage" : "COLLSCAN", "filter" : { "$and" : [ { "count" : { "$eq" : "content_medium_hismatch" } }, { "query" : { "$eq" : { "update_time" : { "$gte" : 1384099200000, "$lt" : 1384185600000 }, "content_type_id" : "28" } } } ] }, "direction" : "forward" }, "rejectedPlans" : [ ] }, "serverInfo" : { "host" : "public-ops-mongodb2.wj.babytree-ops.org", "port" : 29001, "version" : "3.4.2", "gitVersion" : "3f76e40c105fc223b3e5aac3e20dcd026b83b38b" }, "ok" : 1} äºæ˜¯å¾ˆé²è½çš„æ·»åŠ äº†ç´¢å¼•æ“ä½œ1db.content_medium_hismatch.ensureIndex({update_time: 1, content_type_id: 1}) å‘ç°æ—¶é—´å¾ˆé•¿ï¼Œäºæ˜¯å°±crtl+cä¸­æ–­æ“ä½œï¼Œåœ¨æ‰§è¡Œç™»å½•MongoDB shell å‘ç°æ“ä½œéƒ½å µå¡ã€‚æ‰§è¡Œtail -f /data/repset/log/mongod.logå‘ç°12345678910112019-04-04T16:54:54.984+0800 I INDEX [conn2744778] build index on: feeds.content_medium_hismatch properties: { v: 2, key: { update_time: 1.0, content_type_id: 1.0 }, name: "update_time_1_content_type_id_1", ns: "feeds.content_medium_hismatch" }Index Build: 33461300/138238312 0%â€¦â€¦Index Build: 33461300/138238312 99%Index: (2/3) BTree Bottom Up Progress: 99135500/138238312 1%â€¦â€¦Index: (2/3) BTree Bottom Up Progress: 99135500/138238312 71%2019-04-04T18:22:05.817+0800 I INDEX [conn2744778] build index done. scanned 138238312 total records. 5230 secs è¿˜åœ¨æ‰§è¡Œåˆ›å»ºç´¢å¼•æ“ä½œã€‚ç»è¿‡æ’æŸ¥å‘ç°ã€‚MongoDB ä¸æ˜¯å’ŒMySQLä¸€æ ·ã€‚ä¸­æ–­äº†å°±ä¸æ‰§è¡Œäº†ã€‚è€Œä¸”MongoDB åœ¨å‰å°åˆ›å»ºç´¢å¼•æ“ä½œã€‚ä¼šæŠŠæ•´ä¸ªæœåŠ¡é˜»å¡ã€‚ç›´åˆ°ç´¢å¼•åˆ›å»ºæˆåŠŸï¼Œæ‰ä¼šæ”¾å¼€é˜»å¡ã€‚è¿™æ ·æ“ä½œç›´æ¥é€ æˆäº†ä¸šåŠ¡ä¸å¯ç”¨çŠ¶æ€ï¼Œæ—¶é—´æ•´æ•´87åˆ†é’Ÿã€‚é²è½æƒ¹çš„ç¥¸ã€‚ æ€»ç»“å½“ç³»ç»Ÿå·²æœ‰å¤§é‡æ•°æ®æ—¶ï¼Œåˆ›å»ºç´¢å¼•å°±æ˜¯ä¸ªéå¸¸è€—æ—¶çš„æ´»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åå°æ‰§è¡Œï¼Œåªéœ€æŒ‡å®šâ€backgroud: trueâ€å³å¯ã€‚1db.content_medium_hismatch.ensureIndex({update_time: 1, content_type_id: 1}, {backgroud: true}) å›é¡¾æœ€ååœ¨çœ‹ä¸€ä¸‹å¦‚æ­¤ä¹‹å¤§çš„ä»£ä»·åˆ›å»ºçš„ç´¢å¼•ä¹‹åä½¿ç”¨çš„æƒ…å†µ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175repset:PRIMARY> db.content_medium_hismatch.find({ update_time: { $gte: 1384099200000, $lt: 1384185600000 }, content_type_id: "28" }).explain(){ "queryPlanner" : { "plannerVersion" : 1, "namespace" : "feeds.content_medium_hismatch", "indexFilterSet" : false, "parsedQuery" : { "$and" : [ { "content_type_id" : { "$eq" : "28" } }, { "update_time" : { "$lt" : 1384185600000 } }, { "update_time" : { "$gte" : 1384099200000 } } ] }, "winningPlan" : { "stage" : "FETCH", "inputStage" : { "stage" : "IXSCAN", "keyPattern" : { "update_time" : 1, "content_type_id" : 1 }, "indexName" : "update_time_1_content_type_id_1", "isMultiKey" : false, "multiKeyPaths" : { "update_time" : [ ], "content_type_id" : [ ] }, "isUnique" : false, "isSparse" : false, "isPartial" : false, "indexVersion" : 2, "direction" : "forward", "indexBounds" : { "update_time" : [ "[1384099200000.0, 1384185600000.0)" ], "content_type_id" : [ "[\"28\", \"28\"]" ] } } }, "rejectedPlans" : [ { "stage" : "FETCH", "filter" : { "content_type_id" : { "$eq" : "28" } }, "inputStage" : { "stage" : "IXSCAN", "keyPattern" : { "update_time" : 1 }, "indexName" : "update_time_1", "isMultiKey" : false, "multiKeyPaths" : { "update_time" : [ ] }, "isUnique" : false, "isSparse" : false, "isPartial" : false, "indexVersion" : 2, "direction" : "forward", "indexBounds" : { "update_time" : [ "[1384099200000.0, 1384185600000.0)" ] } } }, { "stage" : "FETCH", "filter" : { "$and" : [ { "update_time" : { "$lt" : 1384185600000 } }, { "update_time" : { "$gte" : 1384099200000 } } ] }, "inputStage" : { "stage" : "IXSCAN", "keyPattern" : { "content_type_id" : 1 }, "indexName" : "content_type_id_1", "isMultiKey" : false, "multiKeyPaths" : { "content_type_id" : [ ] }, "isUnique" : false, "isSparse" : false, "isPartial" : false, "indexVersion" : 2, "direction" : "forward", "indexBounds" : { "content_type_id" : [ "[\"28\", \"28\"]" ] } } }, { "stage" : "FETCH", "filter" : { "$and" : [ { "update_time" : { "$lt" : 1384185600000 } }, { "update_time" : { "$gte" : 1384099200000 } } ] }, "inputStage" : { "stage" : "IXSCAN", "keyPattern" : { "content_type_id" : 1, "content_id" : 1 }, "indexName" : "content_type_id_1_content_id_1", "isMultiKey" : false, "multiKeyPaths" : { "content_type_id" : [ ], "content_id" : [ ] }, "isUnique" : true, "isSparse" : false, "isPartial" : false, "indexVersion" : 2, "direction" : "forward", "indexBounds" : { "content_type_id" : [ "[\"28\", \"28\"]" ], "content_id" : [ "[MinKey, MaxKey]" ] } } } ] }, "serverInfo" : { "host" : "public-ops-mongodb2.wj.babytree-ops.org", "port" : 29001, "version" : "3.4.2", "gitVersion" : "3f76e40c105fc223b3e5aac3e20dcd026b83b38b" }, "ok" : 1} å‘ç°æ­£å¸¸èµ°äº†ç´¢å¼•ã€‚æ€»ç®—æ²¡æœ‰ç™½åšã€‚å¯æ˜¯ä»£ä»·å¤ªå¤§äº†ã€‚è¿™ä¸ªæ•™è®­å‘Šè¯‰æˆ‘ï¼Œåœ¨ä¸ç†Ÿæ‚‰çš„æ•°æ®åº“æ“ä½œä¸€å®šè¦æ…é‡ã€‚é’ˆå¯¹çº¿ä¸Šæ“ä½œï¼Œä¸€å®šè¦å†ä¸‰æ…é‡ã€‚å¼•ä»¥ä¸ºæˆ’ï¼ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MongoDB å®ç° MySQL çš„ INSERT INTO SELECT]]></title>
    <url>%2F2019%2F04%2F15%2Fmongodb-inset-into-select%2F</url>
    <content type="text"><![CDATA[è¯´é‡‘é’±æ˜¯ç½ªæ¶ï¼Œéƒ½åœ¨æï¼›è¯´ç¾å¥³æ˜¯ç¥¸æ°´ï¼Œéƒ½æƒ³è¦ï¼›è¯´é«˜å¤„ä¸èƒœå¯’ï¼Œéƒ½åœ¨çˆ¬ï¼›è¯´çƒŸé…’ä¼¤èº«ä½“ï¼Œéƒ½ä¸æˆ’ï¼›è¯´å¤©å ‚æœ€ç¾å¥½ï¼Œéƒ½ä¸å»ï¼ åŸå› å…¬å¸ä¸šåŠ¡æœ‰è¦å°†ä¸€ä¸ªé›†åˆéœ€è¦æ›´æ”¹åç§°ï¼Œéœ€è¦DBAåšé…åˆ æ“ä½œæµç¨‹ åœæ­¢å…¥åº“ ç¡®è®¤å·²ç»æŠŠåº“å…¥æ•°æ®å®¡å®Œ é‡å‘½åcollections åˆ›å»ºæ–°é›†åˆç´¢å¼•db.antispam_resource.renameCollection("antispam_resource_20190415");db.createCollection("antispam_resource");db.antispam_resource.ensureIndex({createTs: 1, groupId: 1});db.antispam_resource.ensureIndex({handleTs: 1, opUserId: 1});db.antispam_resource.getIndexes(); æ–°æ•°æ®å…¥åº“ çœ‹å®¡æ ¸åå°æ˜¯å¦æœ‰æ–°æ•°æ®å…¥åº“å¹¶å®¡æ ¸ æŠŠæœ€è¿‘1ä¸ªæœˆæ•°æ®(antispam_resource_20190415)å¯¼å…¥åˆ°antispam_resource å®Œæ¯• æ“ä½œæŸ¥çœ‹ä¸€ä¸‹åŸé›†åˆæ•°æ®é‡1db.antispam_resource.find().count(); è¿›è¡Œæ›´æ”¹åç§°æ“ä½œ1db.antispam_resource.renameCollection("antispam_resource_20190415") è¿›è¡Œåˆ›å»ºç´¢å¼•123db.antispam_resource.ensureIndex({createTs: 1, groupId: 1});db.antispam_resource.ensureIndex({handleTs: 1, opUserId: 1});db.antispam_resource.getIndexes(); è¿›è¡Œæ“ä½œ MongoDB ç‰ˆæœ¬çš„ INSERT INTO SELECT12345ç¤ºä¾‹:db.antispam_resource.find().forEach(function(doc){ print(doc._id); db.antispam_resource.insert(doc)} ); æ“ä½œè¯¦ç»†æ­¥éª¤æŸ¥çœ‹åŸé›†åˆå¤§äº4æœˆ1å·çš„æ•°æ®123456789101112mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { $gte: NumberLong(1554048000) }}).count()2726271mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { $lte: NumberLong(1554048000) }}).count()22264682mgset-11469021:PRIMARY> db.antispam_resource.find().count()27824mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { $gte: NumberLong(1554048000) }}).count()27861mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { $lte: NumberLong(1554048000) }}).count()0mgset-11469021:PRIMARY> db.antispam_resource.find({ createTs: { $gte: NumberLong(1554048000) }}).count()28074 è¿›è¡Œæ“ä½œ12mgset-11469021:PRIMARY> var docs = db.antispam_resource_20190415.find({createTs: { $gte: NumberLong(1554048000) }});mgset-11469021:PRIMARY> docs.forEach( function(d){ db.antispam_resource.insert(d) }); æ•°æ®åœ¨æ…¢æ…¢æ’å…¥åˆ°æ–°çš„é›†åˆä¸­ 1234mgset-11469021:PRIMARY> db.antispam_resource_20190415.find({createTs: { $gte:1554048000, $lte:1555311600}}).count()2726271mgset-11469021:PRIMARY> db.antispam_resource.find({createTs: { $gte:1554048000, $lte:1555311600}}).count()2726271 ç»ˆäºå¯¼å®Œ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL BINLOG Server]]></title>
    <url>%2F2019%2F04%2F03%2Fmysql-binlog-server%2F</url>
    <content type="text"><![CDATA[é›·é”‹åšäº†å¥½äº‹ä¸ç•™åï¼Œä½†æ˜¯æ¯ä¸€ä»¶äº‹æƒ…éƒ½è®°åˆ°æ—¥è®°é‡Œé¢ã€‚ å‰è¨€MySQL Binlog Server: å®ƒä½¿ç”¨ mysqlbinlog å‘½ä»¤ä»¥ daemon è¿›ç¨‹çš„æ–¹å¼æ¨¡æ‹Ÿä¸€ä¸ª slave çš„ IO çº¿ç¨‹ä¸ä¸»åº“è¿æ¥ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å³æ—¶åŒæ­¥ä¸»åº“çš„ binlogï¼Œä»¥ä¾¿å¼¥è¡¥å®šæ—¶å¤‡ä»½ç­–ç•¥ä¸­æœ€è¿‘ä¸€æ¬¡å¤‡ä»½åˆ°ä¸‹ä¸€æ¬¡å¤‡ä»½å®Œæˆä¹‹å‰è¿™æ®µæ—¶é—´å†…çš„æ•°æ®å®¹æ˜“ä¸¢å¤±çš„é—®é¢˜ã€‚ åšå¥½ MySQL æ—¥å¿—çš„å¤‡ä»½ï¼Œæ˜¯æ•°æ®å®‰å…¨çš„ä¸€ä¸ªé‡è¦ä¿è¯ã€‚ä»¥å‰é€šè¿‡å†™ç¨‹åºæ¥å®ç°ï¼Œä» MySQL 5.6 å‡ºç°ä»¥åï¼Œå¯ä»¥ä½¿ç”¨ mysqlbinlog å‘½ä»¤å®ç°ï¼Œä¸ç”¨å†™ç¨‹åºäº†ã€‚ æƒé™åˆ›å»ºå¤åˆ¶è´¦å·1GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY 'repl'; 123mysql 5.7CREATE USER 'repl'@'%' IDENTIFIED BY 'repl';GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' 1FLUSH PRIVILEGES; åˆ›å»ºBINLOG SERVER1# mysqlbinlog -R --raw --host='192.168.199.230' --port=3306 --user='repl' --password='unixfbi' --stop-never --stop-never-slave-server-id=2313306 mysql-bin.000001 --result-file=/data/mysql/mysql3306/logs/ & å‘½ä»¤å‚æ•°ä»‹ç»ï¼š -R â€“read-from-remote-server :è¡¨ç¤ºä»è¿œç¨‹æœºå™¨ä¸Šè¯»å– binlog,è¦ç¡®ä¿è¿œç¨‹ mysql å­˜å‚¨ï¼Œéœ€è¦æä¾›â€“host, â€“user, â€“password å‚æ•°; ä½¿ç”¨è¯¥é€‰é¡¹æ—¶ï¼Œmysqlbinlog ä¼šä¼ªè£…æˆä¸€ä¸ª slaveï¼Œè¿æ¥è¯»å–ï¼Œè¯·æ±‚æŒ‡å®šçš„ binlog fileï¼Œä¸»åº“è·å–æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä¹‹åå°±åˆ›å»ºä¸€ä¸ª binlog dump çº¿ç¨‹æ¨é€ binlog ç»™ mysqlbinlog serverã€‚ â€“raw: ä»¥ binlog æ ¼å¼å­˜å‚¨æ—¥å¿—ï¼Œæ–¹ä¾¿åæœŸä½¿ç”¨; â€“host: è¿œç¨‹åº“çš„ä¸»æœº IP æˆ–è€…ä¸»æœºå; â€“port: è¿œç«¯åº“çš„ç«¯å£å·; â€“user: è¿œç¨‹åº“ä¸Šç”¨äºå¤åˆ¶çš„è´¦å·; â€“password: è¿œç«¯åº“ä¸Šå¤åˆ¶è´¦å·çš„å¯†ç ; â€“stop-never: ä¸€ç›´è¿æ¥åˆ°è¿œç¨‹çš„ server ä¸Šè¯»å– binlog æ—¥å¿—ï¼Œç›´æ¥åˆ°è¿œç¨‹çš„ server å…³é—­åæ‰ä¼šé€€å‡ºã€‚æˆ–æ˜¯è¢« pkill æ‰; â€“stop-never-slave-server-id: å¦‚æœéœ€è¦å¯åŠ¨å¤šä¸ª binlog server ï¼Œéœ€è¦ç»™ binlog server æŒ‡å®š server-id ã€‚å¦‚æœéœ€è¦å¯åŠ¨å¤šä¸ª binlog server,éœ€è¦ç»™ binlog server æŒ‡å®š server-id(é»˜è®¤æ˜¯ 65535)ï¼Œå¯ä»¥åˆ©ç”¨ â€“stop-never-slave-server-id å˜æ›´; mysql-bin.0000001 è¿™ä¸ªæ—¥å¿—åè¡¨ç¤ºä»é‚£ä¸ªæ—¥å¿—å¼€å§‹è¯»å–; â€“result-file: æŒ‡å®šå­˜å‚¨åˆ°æœ¬åœ°çš„ç›®å½•ï¼Œæ³¨æ„åç¼€éœ€è¦åŠ ä¸Š/ï¼Œå¦åˆ™ mysqlbinlog å‘½ä»¤ä¼šè®¤ä¸ºæ˜¯ä¿å­˜æ–‡ä»¶çš„å‰ç¼€ã€‚è‹¥æŒ‡å®šäº†â€“raw å‚æ•°ï¼Œ-r çš„å€¼æŒ‡å®š binlog çš„å­˜æ”¾ç›®å½•å’Œæ–‡ä»¶åå‰ç¼€ï¼›è‹¥æ²¡æœ‰æŒ‡å®šâ€“raw å‚æ•°ï¼Œ-r çš„å€¼æŒ‡å®šæ–‡æœ¬å­˜æ”¾çš„ç›®å½•å’Œæ–‡ä»¶åã€‚ æ³¨æ„ï¼š ä½¿ç”¨â€“raw è¿æ¥ master æ—¶ï¼Œä»¥ 4k ä¸ºå•ä½å†™å…¥ç£ç›˜ã€‚å¹¶ä¸èƒ½å®æ—¶å†™å…¥ç£ç›˜ã€‚é‚£ä¹ˆä¸å¤Ÿ 4k æ—¶ï¼Œbinlog server ä»€ä¹ˆæ—¶å€™æ‰ä¼šæŠŠæ—¥å¿—å†™å…¥ç£ç›˜å‘¢ï¼Ÿ æœ‰ä¸¤ç§æƒ…å†µï¼š ç¬¬ä¸€ï¼šbinlog server å’Œä¸»åº“æ–­å¼€æ—¶ï¼Œ ç¬¬äºŒï¼šmaster æ‰§è¡Œ flush logs éƒ½ä¼šå®æ—¶æŠŠæ—¥å¿—å†™å…¥ç£ç›˜ã€‚ mysqlbinlog raw æœ‰ä¸€ä¸ª 4k çš„ Buffer ï¼Œå¤Ÿ 4k å°±å‘è½¦ã€‚ è®¾ç½® mysqlbinlog ä¸ºå®ˆæŠ¤è¿›ç¨‹å¦‚æœ master é‡å¯çš„è¯ï¼Œbinlog server ä¸Šçš„ mysqlbinlog è¿›ç¨‹å°±ä¼šé€€å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å†™ä¸ªè„šæœ¬æŠŠ mysqlbinlog è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ1234567891011121314151617181920212223242526#!/bin/bash BACKUP_BIN=/usr/local/mysql/bin/mysqlbinlogLOCAL_BACKUP_DIR=/data/mysql/mysql3306/logs/BACKUP_LOG=/tmp/backup.logREMOTE_HOST=192.168.199.230REMOTE_PORT=3306REMOTE_USER=replREMOTE_PASS=unixfbiFIRST_BINLOG=mysql-bin.000001SLAVE_SERVER_ID=2313306# wait for 10sSLEEP_SECONDS=10cd ${LOCAL_BACKUP_DIR}while :do if [ `ls -A "${LOCAL_BACKUP_DIR}" |wc -l` -eq 0 ];then LAST_FILE=${FIRST_BINLOG} else LAST_FILE=`ls -l ${LOCAL_BACKUP_DIR} |tail -n 1 |awk '{print $NF}'` fi ${BACKUP_BIN} --raw -R --stop-never --host=${REMOTE_HOST} --port=${REMOTE_PORT} --user=${REMOTE_USER} --password=${REMOTE_PASS} --stop-never --stop-never-slave-server-id=${SLAVE_SERVER_ID} ${LAST_FILE} --result-file=${LOCAL_BACKUP_DIR} echo "`date +"%Y/%m/%d %H:%M:%S"` mysqlbinlog is stoped,return code: $?" | tee -a ${BACKUP_LOG} echo "${SLEEP_SECONDS}s will continue !" | tee -a ${BACKUP_LOG} sleep ${SLEEP_SECONDS}done æ‰§è¡Œè„šæœ¬1# nohup binlog_cp.sh & å‚è€ƒUnixFBI è¿ç»´ç‰¹å·¥ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL Innodbè¡¨ç©ºé—´ä¼ è¾“]]></title>
    <url>%2F2019%2F04%2F03%2Finnodb-tablespace-copying%2F</url>
    <content type="text"><![CDATA[ä¸åƒé¥±å“ªæœ‰åŠ›æ°”å‡è‚¥å•Šã€‚ innodbè¡¨ç©ºé—´ä¼ è¾“ï¼Œæ˜¯MySQL5.6å¼€å§‹åŠ å…¥çš„æ–°ç‰¹æ€§ï¼Œæ”¯æŒæ™®é€šè¡¨ç©ºé—´æ‹·è´åˆ°å…¶ä»–å®ä¾‹ä¸‹ï¼ŒMySQL5.7æ”¯æŒåˆ†åŒºè¡¨çš„è¡¨ç©ºé—´ä¼ è¾“ï¼Œä½¿innodbè¡¨çš„æ‹·è´å˜å¾—æ›´åŠ ç®€å•å®¹æ˜“ã€‚ æ–¹ä¾¿æ˜¯æ–¹ä¾¿äº†ï¼Œä½†ä¹Ÿè¦éœ€è¦æ³¨æ„: innodbè¡¨ç©ºé—´ä¼ è¾“ä¸è¦ç”¨æ¥åšä¸»ä»å¤åˆ¶ï¼Œå¦åˆ™ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜; ä½¿ç”¨ä¹‹å‰ï¼Œè¦ç¡®è®¤ä½¿ç”¨äº†innodb_file_per_tableå³ç‹¬ç«‹è¡¨ç©ºé—´; åœ¨è¡¨ç©ºé—´å¯¼å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡ä¸èƒ½è¿›è¡Œå†™æ“ä½œ, åº”è¯¥æ³¨æ„é€‰æ‹©æ“ä½œæ—¶é—´, åº”è¯¥é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ“ä½œ; é»˜è®¤ä¸æ”¯æŒå¯¼å‡ºæœ‰å¤–é”®çš„è¡¨, å¯ä»¥é€šè¿‡set foreign_key_checks=0å¼ºåˆ¶å¿½ç•¥, ä½†ä»…é™äºæ™®é€šè¡¨, è€Œåˆ†åŒºè¡¨æš‚æ—¶ä¸æ”¯æŒè¿™æ ·æ“ä½œã€‚ æˆ‘ä»¬çŸ¥é“äº†innodbè¡¨ç©ºé—´ä¼ è¾“çš„ç‰¹ç‚¹å’Œä½¿ç”¨æ³¨æ„äº‹é¡¹, ç°åœ¨è€ƒè™‘ä¸€ä¸‹åº”ç”¨åœºæ™¯ã€‚å› ä¸ºä¸åšä¸»ä»å¤åˆ¶ï¼Œå°±åªèƒ½åšä¸€äº›ç¦»çº¿æ–¹é¢çš„ä½¿ç”¨ï¼Œæ¯”å¦‚æŠŠçº¿ä¸ŠæŸä¸ªç”Ÿäº§è¡¨æ‹¿åˆ°ç¦»çº¿ç¯å¢ƒåšç»Ÿè®¡åˆ†æç­‰ç­‰ã€‚ ä¸‹é¢ä»‹ç»innodbæ™®é€šè¡¨ç©ºé—´ä¼ è¾“å’Œåˆ†åŒºè¡¨ç©ºé—´ä¼ è¾“çš„æ“ä½œè¿‡ç¨‹1.innodbæ™®é€šè¡¨ç©ºé—´ä¼ è¾“ 1.1ç›®æ ‡åº“123mysql> create table t2(id int auto_increment, name varchar(20), primary key(id));mysql> insert into t2(name) values('aa'),('bb'),('cc');mysql> alter table t2 discard tablespace; 1.2 æºåº“12345mysql> flush tables t2 for export;shell> scp -P2222 /data/mysql/mysql_3306/data/db1/t2.{cfg,ibd} 172.16.123.103:/data/mysql/mysql_3306/data/test/mysql> unlock tables; 1.3 ç›®æ ‡åº“123shell> chown mysql.mysql /data/mysql/mysql_3306/data/test/t2.*mysql> alter table t2 import tablespace; 2.innodbåˆ†åŒºè¡¨ç©ºé—´ä¼ è¾“æµ‹è¯•åˆ†åŒºè¡¨ç»“æ„1mysql> create table t3(id int auto_increment, name varchar(20), primary key(id)) partition by key(id) partitions 4; 2.1 ç›®æ ‡åº“1mysql> create table t3(id int auto_increment, name varchar(20), primary key(id)) partition by key(id) partitions 4; æ’å…¥æµ‹è¯•æ•°æ®(çœç•¥)2.2 æºåº“12345mysql> flush tables t3 for export; #å¯¼å‡ºæ•´ä¸ªåˆ†åŒºè¡¨shell> cp -a /data/mysql/mysql_3306/data/db1/t3* /var/tmp/mysql> unlock tables; 2.3 ç›®æ ‡åº“ 2.3.1 å¯¼å…¥å…¨æ•°åˆ†åŒº1234ç›®æ ‡åº“mysql> alter table t3 discard tablespace;æˆ–mysql> alter table t3 discard partition all tablespace; 123æºåº“shell> scp -P2222 -r t3* 172.16.123.103:/data/mysql/mysql_3306/data/test/shell> chown mysql.mysql /data/mysql/mysql_3306/data/test/ -R 12ç›®æ ‡åº“mysql> alter table t3 import tablespace; 2.3.2 å¯¼å…¥æŒ‡å®šåˆ†åŒºåªå¯¼p1åˆ†åŒº12ç›®æ ‡åº“mysql> alter table t3 discard partition p1 tablespace; 12æºåº“shell> scp -P2222 -r t3p1 172.16.123.103:/data/mysql/mysql_3306/data/test/ 12ç›®æ ‡åº“mysql> alter table t3 import partition p1 tablespace; æ€»ç»“æºåº“ä¸Šflush tables tbname for export;â€”>æ‹·è´æ–‡ä»¶â€“>unlock tables; ç›®æ ‡åº“ä¸Šalter table tbname discard [partition partition_names | ALL] tablespace;â€“>æ‹·è´æ–‡ä»¶è¿‡æ¥,æ”¹æƒé™â€“>alter table tbname IMPORT [PARTITION partition_names | ALL] TABLESPACE; å†æ¬¡æé†’ åšflush tables xx discard tablespaceä¹‹å‰ï¼ŒåŠ¡å¿…ä¸‰æ€, ä¸€å®šè¦ææ¸…æ¥šåœ¨å“ªä¸ªåº“æ“ä½œ, ä¸‡ä¸€åœ¨ç”Ÿäº§åº“ä¸Šæ“ä½œï¼Œè¿™å°±æ‚²å‰§äº†! è½¬è½½Huang Jinqiang document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»MySQLæºç å­¦ä¹ è¿ç»´Innodb bufferå‘½ä¸­ç‡è®¡ç®—]]></title>
    <url>%2F2019%2F04%2F03%2Fmysql-innodb-buffer-pool-hit%2F</url>
    <content type="text"><![CDATA[å¤©æ²¡é™å¤§ä»»äºæˆ‘ï¼Œç…§æ ·è‹¦æˆ‘å¿ƒæ™ºï¼ŒåŠ³æˆ‘ç­‹éª¨ã€‚ è®¡ç®—å…¬å¼æŒ‰å®˜æ–¹æ‰‹å†Œæ¨èInnodb buffer Hit Ratiosçš„è®¡ç®—æ˜¯:123100-((iReads / iReadRequests)*100)iReads : mysql->status->Innodb_buffer_pool_readsiReadRequests: mysql->status->Innodb_buffer_pool_read_requests mysqlsqlreportä¸­å…³äºbufferå‘½ä¸­è®¡ç®—æ˜¯:1ib_bp_hit=100-(Innodb_buffer_pool_reads/Innodb_buffer_pool_read_requests)*100 å¦å¤–æˆ‘ä»¬çŸ¥é“æŸ¥çœ‹Innodb Buffer Hit Ratiosçš„åœ°æ–¹æ˜¯:12show engine innodb status\G;Buffer pool hit rate : XXXX/1000; é‚£ä¸ªXXX/1000å³æ˜¯buffer pool hit ratiosçš„å‘½ä¸­. innodb buffer hit Ratiosçš„å‘½ä¸­è®¡ç®—éœ€è¦æœ¬æ¬¡å–çš„å€¼å’Œä¸Šæ¬¡å€¼åšä¸€ä¸ªå‡æ³•å…¬å¼åº”è¯¥ä¸º1ib_bp_hit=1000 â€“ (t2.iReads â€“ t1.iReads)/(t2.iReadRequest â€“ t1.iReadRequest)*1000 t(n): æ—¶é—´ç‚¹ ä¸¤ä¸ªæ—¶é—´é—´éš”æœ€å°‘æ˜¯30ç§’ä»¥ä¸Š,åœ¨å°æ„ä¹‰ä¸å¤§. iReads: Innodb_buffer_pool_reads iReadRequest: Innodb_buffer_pool_read_requests æ€è€ƒ:å¯¹äºinnodb_buffer_pool_read_requests, innodb_buffer_pool_readsè¿™ç§ç´¯åŠ å€¼,å½“å¾ˆå¤§æ—¶è¿›è¡Œ: innodb_buffer_pool_reads/innodb_buffer_pool_read_requests ç›¸æ¥è®²åªèƒ½å¾—åˆ°ä»å¼€å§‹åˆ°ç°åœ¨çš„å‘½ä¸­ç‡çš„è¡¨ç°äº†. å¦‚æœæƒ³å¾—åˆ°ç°åœ¨è¿‘äº”åˆ†é’Ÿ,è¿‘ä¸€åˆ†é’Ÿæˆ–æ˜¯8ç‚¹åˆ°9ç‚¹æ¯åˆ†é’Ÿçš„å‘½ä¸­ç‡æƒ…å†µ,å¦‚æœè¿˜æ˜¯æŒ‰ç€innodb_buffer_pool_reads/innodb_buffer_pool_read_requests è¿›è¡Œè®¡ç®—,åªèƒ½å¾—åˆ°mysqldå¼€èµ·ç´¯è®¡åœ¨8ç‚¹-9ç‚¹çš„æ¯åˆ†é’Ÿçš„ç´¯è®¡å¹³å‡å‘½ä¸­æƒ…å†µ. æ‰€ä»¥å¦‚æœæƒ³åˆ°æ¯(äº”)åˆ†é’Ÿçš„å‘½ä¸­æƒ…å†µ,å°±éœ€è¦æœ¬æ¬¡å–å¾—çš„å€¼å’Œä¸€(äº”)åˆ†é’Ÿå‰çš„å€¼è¿›è¡Œç›¸å‡,ç„¶åè¿›è¡Œè¿ç®—.è¿™æ ·æ‰èƒ½å¾—åˆ°ä¸€ä¸ªå½“ä¸‹çš„bpå‘½ä¸­æƒ…å†µ. ä¸¤ç§æ–¹æ³•æ²¡å®è´¨çš„å¯¹é”™çš„é—®é¢˜,ä½†ç›¸å¯¹äºæºç ä¸­çš„é‚£ç§è®¡ç®—æ–¹å¼æ›´å®¹è®©å‘ç°æ•°æ®åº“çš„æŠ–åŠ¨é—®é¢˜. èƒ½è§£å†³çš„é—®é¢˜: å¶è€Œçš„æ•°æ®åº“æ€§èƒ½æŠ–åŠ¨èƒ½ç›´è§‚çš„ååº”å‡ºæ¥. è½¬è½½å´ ç‚³é”¡(æ•°æ®åº“æ¶æ„å¸ˆ):ä»MySQLæºç å­¦ä¹ è¿ç»´Innodb bufferå‘½ä¸­ç‡è®¡ç®— document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linuxä¸­SHELLå†…ç½®getoptså‘½ä»¤è·å–å‘½ä»¤è¡Œå‚æ•°]]></title>
    <url>%2F2019%2F04%2F03%2Fshell-getopts%2F</url>
    <content type="text"><![CDATA[åšäººå¦‚æœæ²¡æœ‰æ¢¦æƒ³ï¼Œé‚£å’Œå’¸é±¼æœ‰ä½•åŒºåˆ«ï¼Ÿ å‰è¨€å†™ç¨‹åºçš„æ—¶å€™ç»å¸¸è¦å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œæœ¬æ–‡æè¿°åœ¨Bashä¸‹çš„å‘½ä»¤è¡Œå¤„ç†æ–¹å¼ã€‚ é€‰é¡¹ä¸å‚æ•°: å¦‚ä¸‹ä¸€ä¸ªå‘½ä»¤è¡Œ:1/test.sh -f config.conf -v --prefix=/home æˆ‘ä»¬ç§°-fä¸ºé€‰é¡¹ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå³config.conf, -v ä¹Ÿæ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œä½†å®ƒä¸éœ€è¦å‚æ•°ã€‚ â€“prefixæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ªé•¿é€‰é¡¹ï¼Œå³é€‰é¡¹æœ¬èº«å¤šäºä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒä¹Ÿéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œç”¨ç­‰å·è¿æ¥ï¼Œå½“ç„¶ç­‰å·ä¸æ˜¯å¿…é¡»çš„ï¼Œ/homeå¯ä»¥ç›´æ¥å†™åœ¨â€“prefixåé¢ï¼Œå³â€“prefix/home,æ›´å¤šçš„é™åˆ¶åé¢å…·ä½“ä¼šè®²åˆ°ã€‚ åœ¨bashä¸­ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹ä¸‰ç§æ–¹å¼æ¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œæ¯ç§æ–¹å¼éƒ½æœ‰è‡ªå·±çš„åº”ç”¨åœºæ™¯ã€‚ æ‰‹å·¥å¤„ç†æ–¹å¼ getopts getopt ç”±äºshellå‘½ä»¤è¡Œçš„çµæ´»æ€§ï¼Œè‡ªå·±ç¼–å†™ä»£ç åˆ¤æ–­æ—¶ï¼Œå¤æ‚åº¦ä¼šæ¯”è¾ƒé«˜ã€‚ä½¿ç”¨å†…éƒ¨å‘½ä»¤ getopts å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚ä¸€èˆ¬æ ¼å¼ä¸ºï¼š è°ƒç”¨æ ¼å¼ï¼š1getopts options variable getopts çš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨å¾ªç¯ä¸­è¿è¡Œï¼Œæ¯æ¬¡æ‰§è¡Œå¾ªç¯ï¼Œgetopts å°±æ£€æŸ¥ä¸‹ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦åˆæ³•ã€‚å³æ£€æŸ¥å‚æ•°æ˜¯å¦ä»¥ - å¼€å¤´ï¼Œåé¢è·Ÿä¸€ä¸ªåŒ…å«åœ¨ options ä¸­çš„å­—æ¯ã€‚å¦‚æœæ˜¯ï¼Œå°±æŠŠåŒ¹é…çš„é€‰é¡¹å­—æ¯å­˜åœ¨æŒ‡å®šçš„å˜é‡ variable ä¸­ï¼Œå¹¶è¿”å›é€€å‡ºçŠ¶æ€0ï¼›å¦‚æœ - åé¢çš„å­—æ¯æ²¡æœ‰åŒ…å«åœ¨ options ä¸­ï¼Œå°±åœ¨ variable ä¸­å­˜å…¥ä¸€ä¸ª ï¼Ÿï¼Œå¹¶è¿”å›é€€å‡ºçŠ¶æ€0ï¼›å¦‚æœå‘½ä»¤è¡Œä¸­å·²ç»æ²¡æœ‰å‚æ•°ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªå‚æ•°ä¸ä»¥ - å¼€å¤´ï¼Œå°±è¿”å›ä¸ä¸º0çš„é€€å‡ºçŠ¶æ€ã€‚ å‚æ•°è¯´æ˜ï¼š option_string é€‰é¡¹åç§° variable é€‰é¡¹çš„å€¼ é€‰é¡¹ä¹‹é—´ä½¿ç”¨å†’å·:åˆ†éš”ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿æ¥ï¼Œ : è¡¨ç¤ºé€‰é¡¹åé¢æœ‰ä¼ å€¼ã€‚ å½“getoptså‘½ä»¤å‘ç°å†’å·åï¼Œä¼šä»å‘½ä»¤è¡Œè¯¥é€‰é¡¹åè¯»å–è¯¥å€¼ã€‚å¦‚è¯¥å€¼å­˜åœ¨ï¼Œå°†ä¿å­˜åœ¨ç‰¹æ®Šçš„å˜é‡OPTARGä¸­ã€‚ å½“option_stringç”¨:å¼€å¤´ï¼Œgetoptsä¼šåŒºåˆ†invalid optioné”™è¯¯å’Œmiss option argumenté”™è¯¯ã€‚ invalid optionæ—¶, varnameä¼šè¢«è®¾æˆ? miss option argumentæ—¶ï¼Œvarnameä¼šè¢«è®¾æˆ: å¦‚æœoption_stringä¸ç”¨:å¼€å¤´ï¼Œinvalid optioné”™è¯¯å’Œmiss option argumenté”™è¯¯éƒ½ä¼šä½¿varnameè¢«è®¾æˆ?ã€‚ getoptsåŒ…å«ä¸¤ä¸ªå†…ç½®å˜é‡ï¼ŒOPTARGå’ŒOPTIND OPTARG ä¿å­˜é€‰é¡¹åçš„å‚æ•°å€¼ OPTIND è¡¨ç¤ºå‘½ä»¤è¡Œä¸‹ä¸€ä¸ªé€‰é¡¹æˆ–å‚æ•°çš„ç´¢å¼• ä½¿ç”¨ç¤ºä¾‹ä¾‹å­1: ä½¿ç”¨getoptså‘½ä»¤è·å–å‚æ•°123456789101112131415161718#!/bin/bashwhile getopts a:b:c:d opts; do case $opts in a) a=$OPTARG ;; b) b=$OPTARG ;; c) c=$OPTARG ;; d) d=$OPTARG ;; ?) ;; esacdoneecho "a=$a"echo "b=$b"echo "c=$c"echo "d=$d"exit 0 æ‰§è¡Œè¾“å‡º12345./test.sh -a 1 -b 2 -c 3 -d 4a=1b=2c=3d= option_string ağŸ…±c:d a,b,cåéƒ½æœ‰: dåæ²¡æœ‰: æ‰€ä»¥å¯ä»¥è·å–åˆ°a,b,cçš„å€¼ ä¾‹å­2: option_stringå‰åŠ :ä¸Šä¾‹ä¸­ï¼Œå¦‚æœa,b,cä»»æ„ä¸€ä¸ªæ²¡æœ‰ä¼ å€¼ï¼Œå°†ä¼šæç¤ºå‡ºé”™ã€‚ä¾‹å¦‚ -c ä¸ä¼ å€¼ã€‚123456./test.sh -a 1 -b 2 -c./test.sh: option requires an argument -- ca=1b=2c=d= æˆ‘ä»¬åœ¨option_stringå‰åŠ ä¸Š:ï¼Œåˆ™å¯ä»¥å±è”½è¿™ä¸ªé”™è¯¯123456789101112131415161718#!/bin/bashwhile getopts :a:b:c:d opts; do case $opts in a) a=$OPTARG ;; b) b=$OPTARG ;; c) c=$OPTARG ;; d) d=$OPTARG ;; ?) ;; esacdoneecho "a=$a"echo "b=$b"echo "c=$c"echo "d=$d"exit 0 æ‰§è¡Œè¾“å‡º12345./test.sh -a 1 -b 2 -ca=1b=2c=d= åœ¨option_stringå‰åŠ ä¸Š:ï¼Œå¯ä»¥å±è”½ç¼ºå¤±ä¼ å€¼çš„é”™è¯¯ï¼Œä½†å¦‚æœç¼ºå¤±çš„æ˜¯å‰é¢é€‰é¡¹çš„å€¼ï¼Œé‚£ä¹ˆè·å–åˆ°çš„å€¼å°†ä¼šé”™è¯¯ã€‚ ä¾‹å¦‚ç¼ºå¤±açš„ä¼ å€¼ï¼Œå‘½ä»¤ä¼šæŠŠ-aåçš„-bä½œä¸ºäº†-açš„å€¼ï¼Œå¯¼è‡´é”™è¯¯ã€‚12345./test.sh -a -b 2 -c 3a=-bb=c=d= å› æ­¤ä½¿ç”¨getoptså‘½ä»¤æ—¶ï¼Œå¯¹äºæ²¡æœ‰ä¼ å€¼çš„é€‰é¡¹ï¼Œé€‰é¡¹åç§°ä¹Ÿä¸è¦åŠ å…¥å‘½ä»¤è¡Œä¸­ã€‚ä¾‹å¦‚aä¸ä¼ å€¼ï¼Œåˆ™-aä¸è¦åŠ å…¥å‘½ä»¤è¡Œã€‚12345./test.sh -b 2 -c 3a=b=2c=3d= SHELL ä»£ç ä»¥ä¸Šæ˜¯ç¤ºä¾‹ï¼Œä¸‹é¢è´´ä¸Šæˆ‘å†™çš„è„šæœ¬ä»£ç ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445#!/bin/bash## Author: Created by jiemin.wang# QQ: 278667010# E-mail: 278661010@qq.com or wangjiemin880228@gmail.com# Created Time: Wed Apr 3 14:15:12 CST 2019# function: This is tcpdump grabs SQL executed by MySQL# version: 1.0function usage(){ echo "Usage:" echo " $(basename $0) [OPTION]:" echo " -n net" echo " -P port"}if [ $# -eq "0" ];then usage exit 1fiwhile getopts :n:P: argdo case $arg in n) net=$OPTARG ;; P) port=$OPTARG ;; esacdone#tcpdump -i "$net" -s 0 -l -w - dst port "$port" | strings | perl -e 'tcpdump -i "$net" -s 0 -l -w file dst port "$port" | strings | perl -e '#!/bin/bashwhile() { chomp; next if /^[^ ]+[ ]*$/; if(/^(SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL)/i) { if (defined $q) { print "$q\n"; } $q=$_; } else { $_ =~ s/^[ \t]+//; $q.=" $_"; }}' å…¶ä»–ç¤ºä¾‹åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªç¤ºä¾‹,è´´ä¸Šæ¥,ä»…ä¾›å‚è€ƒ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556#!/bin/bash QUIET=VERBOSE=DEVICE=LOGFILE=/tmp/defaultusage(){ echo "Usage: `basename $0` [-qv] [-l LOGFILE] -d DEVICE input_file [input_file2...]" exit 1}[ $# -eq 0 ] && usage#option_stringä»¥å†’å·å¼€å¤´è¡¨ç¤ºå±è”½è„šæœ¬çš„ç³»ç»Ÿæç¤ºé”™è¯¯ï¼Œè‡ªå·±å¤„ç†é”™è¯¯æç¤ºã€‚#åé¢æ¥åˆæ³•çš„å•å­—æ¯é€‰é¡¹ï¼Œé€‰é¡¹åè‹¥æœ‰å†’å·ï¼Œåˆ™è¡¨ç¤ºè¯¥é€‰é¡¹å¿…é¡»æ¥å…·ä½“çš„å‚æ•°while getopts :qvd:l: OPTIONdo case $OPTION in q) QUIET=y ;; v) VERBOSE=y ;; d) DEVICE=$OPTARG #$OPTARGä¸ºç‰¹æ®Šå˜é‡ï¼Œè¡¨ç¤ºé€‰é¡¹çš„å…·ä½“å‚æ•° ;; l) LOGFILE=$OPTARG ;; \?) #å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™è§£æä¸º? usage ;; esacdone#$OPTINDä¸ºç‰¹æ®Šå˜é‡ï¼Œè¡¨ç¤ºç¬¬å‡ ä¸ªé€‰é¡¹ï¼Œåˆå§‹å€¼ä¸º1shift $(($OPTIND - 1)) #é™¤äº†é€‰é¡¹ä¹‹å¤–ï¼Œè¯¥è„šæœ¬å¿…é¡»æ¥è‡³å°‘ä¸€ä¸ªå‚æ•°if [ $# -eq 0 ]; then usagefiif [ -z "$DEVICE" ]; then #è¯¥è„šæœ¬å¿…é¡»æä¾›-dé€‰é¡¹ echo "You must specify DEVICE with -d option" exitfiecho "you chose the following options.."echo "Quiet=$QUIET VERBOSE=$VERBOSE DEVICE=$DEVICE LOGFILE=$LOGFILE"for file in $@ #ä¾æ¬¡å¤„ç†å‰©ä½™çš„å‚æ•°do echo "Processing $file"done document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux æŠ€å·§ï¼šä½¿ç”¨ screen ç®¡ç†ä½ çš„è¿œç¨‹ä¼šè¯]]></title>
    <url>%2F2019%2F04%2F02%2Flinux-screen%2F</url>
    <content type="text"><![CDATA[æœ‰æœ¬äº‹ï¼Œä½ æ¥é¡ºç€ç½‘çº¿çˆ¬è¿‡æ¥ï¼Œä½ æ¥å’¬æˆ‘å‘€ å‰è¨€ä½ æ˜¯ä¸æ˜¯ç»å¸¸éœ€è¦ SSH æˆ–è€… telent è¿œç¨‹ç™»å½•åˆ° Linux æœåŠ¡å™¨ï¼Ÿä½ æ˜¯ä¸æ˜¯ç»å¸¸ä¸ºä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è€Œå¤´ç–¼ï¼Œæ¯”å¦‚ç³»ç»Ÿå¤‡ä»½ã€ftp ä¼ è¾“ç­‰ç­‰ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä¸ºæ¯ä¸€ä¸ªè¿™æ ·çš„ä»»åŠ¡å¼€ä¸€ä¸ªè¿œç¨‹ç»ˆç«¯çª—å£ï¼Œå› ä¸ºä»–ä»¬æ‰§è¡Œçš„æ—¶é—´å¤ªé•¿äº†ã€‚å¿…é¡»ç­‰å¾…å®ƒæ‰§è¡Œå®Œæ¯•ï¼Œåœ¨æ­¤æœŸé—´å¯ä¸èƒ½å…³æ‰çª—å£æˆ–è€…æ–­å¼€è¿æ¥ï¼Œå¦åˆ™è¿™ä¸ªä»»åŠ¡å°±ä¼šè¢«æ€æ‰ï¼Œä¸€åˆ‡åŠé€”è€ŒåºŸäº†ã€‚ å…ƒå‡¶ï¼šSIGHUP ä¿¡å·è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆå…³æ‰çª—å£/æ–­å¼€è¿æ¥ä¼šä½¿å¾—æ­£åœ¨è¿è¡Œçš„ç¨‹åºæ­»æ‰ã€‚ åœ¨Linux/Unixä¸­ï¼Œæœ‰è¿™æ ·å‡ ä¸ªæ¦‚å¿µ: è¿›ç¨‹ç»„ï¼ˆprocess groupï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹çš„é›†åˆï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ç»„æœ‰å”¯ä¸€ä¸€ä¸ªè¿›ç¨‹ç»„IDï¼Œå³è¿›ç¨‹ç»„é•¿è¿›ç¨‹çš„IDã€‚ ä¼šè¯æœŸï¼ˆsessionï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ç»„çš„é›†åˆï¼Œæœ‰å”¯ä¸€ä¸€ä¸ªä¼šè¯æœŸé¦–è¿›ç¨‹ï¼ˆsession leaderï¼‰ã€‚ä¼šè¯æœŸIDä¸ºé¦–è¿›ç¨‹çš„IDã€‚ ä¼šè¯æœŸå¯ä»¥æœ‰ä¸€ä¸ªå•ç‹¬çš„æ§åˆ¶ç»ˆç«¯ï¼ˆcontrolling terminalï¼‰ã€‚ä¸æ§åˆ¶ç»ˆç«¯è¿æ¥çš„ä¼šè¯æœŸé¦–è¿›ç¨‹å«åšæ§åˆ¶è¿›ç¨‹ï¼ˆcontrolling processï¼‰ã€‚å½“å‰ä¸ç»ˆç«¯äº¤äº’çš„è¿›ç¨‹ç§°ä¸ºå‰å°è¿›ç¨‹ç»„ã€‚å…¶ä½™è¿›ç¨‹ç»„ç§°ä¸ºåå°è¿›ç¨‹ç»„ã€‚ æ ¹æ®POSIX.1å®šä¹‰: æŒ‚æ–­ä¿¡å·ï¼ˆSIGHUPï¼‰é»˜è®¤çš„åŠ¨ä½œæ˜¯ç»ˆæ­¢ç¨‹åºã€‚ å½“ç»ˆç«¯æ¥å£æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥æ–­å¼€ï¼Œå°†æŒ‚æ–­ä¿¡å·å‘é€ç»™æ§åˆ¶è¿›ç¨‹ï¼ˆä¼šè¯æœŸé¦–è¿›ç¨‹ï¼‰ã€‚ å¦‚æœä¼šè¯æœŸé¦–è¿›ç¨‹ç»ˆæ­¢ï¼Œåˆ™è¯¥ä¿¡å·å‘é€åˆ°è¯¥ä¼šè¯æœŸå‰å°è¿›ç¨‹ç»„ã€‚ ä¸€ä¸ªè¿›ç¨‹é€€å‡ºå¯¼è‡´ä¸€ä¸ªå­¤å„¿è¿›ç¨‹ç»„ä¸­äº§ç”Ÿæ—¶ï¼Œå¦‚æœä»»æ„ä¸€ä¸ªå­¤å„¿è¿›ç¨‹ç»„è¿›ç¨‹å¤„äºSTOPçŠ¶æ€ï¼Œå‘é€SIGHUPå’ŒSIGCONTä¿¡å·åˆ°è¯¥è¿›ç¨‹ç»„ä¸­æ‰€æœ‰è¿›ç¨‹ã€‚ å› æ­¤å½“ç½‘ç»œæ–­å¼€æˆ–ç»ˆç«¯çª—å£å…³é—­åï¼Œæ§åˆ¶è¿›ç¨‹æ”¶åˆ°SIGHUPä¿¡å·é€€å‡ºï¼Œä¼šå¯¼è‡´è¯¥ä¼šè¯æœŸå†…å…¶ä»–è¿›ç¨‹é€€å‡ºã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚æ‰“å¼€ä¸¤ä¸ªSSHç»ˆç«¯çª—å£ï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªè¿è¡Œtopå‘½ä»¤ã€‚1test_dbs2 ~ # top åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæ‰¾åˆ°topçš„è¿›ç¨‹IDä¸º15371ï¼Œå…¶çˆ¶è¿›ç¨‹IDä¸º10034ï¼Œå³ç™»å½•shellã€‚1test_dbs2 ~ # ps -ef|grep top 12345root 5 2 0 Apr01 ? 00:00:00 [stopper/0]root 8 2 0 Apr01 ? 00:00:00 [stopper/1]root 15371 10034 0 18:37 pts/1 00:00:00 toproot 15380 15352 0 18:37 pts/2 00:00:00 grep --colour=auto toptest_dbs2 ~ # ä½¿ç”¨pstreeå‘½ä»¤å¯ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸ªå…³ç³»ï¼š123test_dbs2 ~ # pstree -H 15371|grep top | |-sshd---sshd---bash---sudo---bash---sudo---bash---toptest_dbs2 ~ # ä½¿ç”¨ps-xjå‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œç™»å½•shellï¼ˆPID 15371ï¼‰å’Œtopåœ¨åŒä¸€ä¸ªä¼šè¯æœŸï¼Œshellä¸ºä¼šè¯æœŸé¦–è¿›ç¨‹ï¼Œæ‰€åœ¨è¿›ç¨‹ç»„PGIDä¸º15371ï¼Œtopæ‰€åœ¨è¿›ç¨‹ç»„PGIDä¸º9410ï¼Œä¸ºå‰å°è¿›ç¨‹ç»„ã€‚12345678test_dbs2 ~ # ps -xj|grep 15371Warning: bad syntax, perhaps a bogus '-'? See /usr/share/doc/procps-3.2.8/FAQ 9410 10020 10020 9410 pts/1 15371 S 0 0:00 sudo bash10020 10021 10021 9410 pts/1 15371 S 0 0:00 bash10021 10033 10033 9410 pts/1 15371 S 0 0:00 sudo bash10033 10034 10034 9410 pts/1 15371 S 0 0:00 bash10034 15371 15371 9410 pts/1 15371 S+ 0 0:00 top15352 15485 15484 15327 pts/2 15484 R+ 0 0:00 grep --colour=auto 15371 å…³é—­ç¬¬ä¸€ä¸ªSSHçª—å£ï¼Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯ä»¥çœ‹åˆ°topä¹Ÿè¢«æ€æ‰äº†ã€‚123test_dbs2 ~ # ps -ef|grep 15371root 15511 15352 0 18:42 pts/2 00:00:00 grep --colour=auto 15371test_dbs2 ~ # å¦‚æœæˆ‘ä»¬å¯ä»¥å¿½ç•¥SIGHUPä¿¡å·ï¼Œå…³æ‰çª—å£åº”è¯¥å°±ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œäº†ã€‚nohupå‘½ä»¤å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå¦‚æœç¨‹åºçš„æ ‡å‡†è¾“å‡º/æ ‡å‡†é”™è¯¯æ˜¯ç»ˆç«¯ï¼Œnohupé»˜è®¤å°†å…¶é‡å®šå‘åˆ°nohup.outæ–‡ä»¶ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯nohupå‘½ä»¤åªæ˜¯ä½¿å¾—ç¨‹åºå¿½ç•¥SIGHUPä¿¡å·ï¼Œè¿˜éœ€è¦ä½¿ç”¨æ ‡è®°&æŠŠå®ƒæ”¾åœ¨åå°è¿è¡Œã€‚1nohup [argumentâ€¦] & è™½ç„¶nohupå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æ¯”è¾ƒâ€œç®€é™‹â€çš„ï¼Œå¯¹äºç®€å•çš„å‘½ä»¤èƒ½å¤Ÿåº”ä»˜è¿‡æ¥ï¼Œå¯¹äºå¤æ‚çš„éœ€è¦äººæœºäº¤äº’çš„ä»»åŠ¡å°±éº»çƒ¦äº†ã€‚ å…¶å®æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ›´ä¸ºå¼ºå¤§çš„å®ç”¨ç¨‹åºscreenã€‚æµè¡Œçš„Linuxå‘è¡Œç‰ˆï¼ˆä¾‹å¦‚Red Hat Enterprise Linux ï¼‰ é€šå¸¸ä¼šè‡ªå¸¦screenå®ç”¨ç¨‹åºï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥ä»GNU screençš„å®˜æ–¹ç½‘ç«™ä¸‹è½½ã€‚ å¼€å§‹ä½¿ç”¨Screenç®€å•æ¥è¯´ï¼ŒScreenæ˜¯ä¸€ä¸ªå¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å¤šè·¯å¤ç”¨ä¸€ä¸ªç‰©ç†ç»ˆç«¯çš„çª—å£ç®¡ç†å™¨ã€‚Screenä¸­æœ‰ä¼šè¯çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸€ä¸ªscreenä¼šè¯ä¸­åˆ›å»ºå¤šä¸ªscreençª—å£ï¼Œåœ¨æ¯ä¸€ä¸ªscreençª—å£ä¸­å°±åƒæ“ä½œä¸€ä¸ªçœŸå®çš„telnet/SSHè¿æ¥çª—å£é‚£æ ·ã€‚åœ¨screenä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£æœ‰è¿™æ ·å‡ ç§æ–¹å¼ï¼š1234567891011121314151617181920212223242526272829303132333435363738test_dbs2 ~ # yum install -y screentest_dbs2 ~ # test_dbs2 ~ # screen --helpUse: screen [-opts] [cmd [args]] or: screen -r [host.tty]Options:-4 Use IPv4.-6 Use IPv6.-a Force all capabilities into each window's termcap.-A -[r|R] Adapt all windows to the new display width & height.-c file Read configuration file instead of '.screenrc'.-d (-r) Detach the elsewhere running screen (and reattach here).-dmS name Start as daemon: Screen session in detached mode.-D (-r) Detach and logout remote (and reattach here).-D -RR Do whatever is needed to get a screen session.-e xy Change command characters.-f Flow control on, -fn = off, -fa = auto.-h lines Set the size of the scrollback history buffer.-i Interrupt output sooner when flow control is on.-l Login mode on (update /var/run/utmp), -ln = off.-list or -ls. Do nothing, just list our SockDir.-L Turn on output logging.-m ignore $STY variable, do create a new screen session.-O Choose optimal output rather than exact vt100 emulation.-p window Preselect the named window if it exists.-q Quiet startup. Exits with non-zero return code if unsuccessful.-r Reattach to a detached screen process.-R Reattach if possible, otherwise start a new session.-s shell Shell to execute rather than $SHELL.-S sockname Name this session .sockname instead of ...-t title Set title. (window's name).-T term Use term as $TERM for windows, rather than "screen".-U Tell screen to use UTF-8 encoding.-v Print "Screen version 4.00.03 (FAU) 23-Oct-06".-wipe Do nothing, just clean up SockDir.-x Attach to a not detached screen. (Multi display mode).-X Execute as a screen command in the specified session. ç›´æ¥åœ¨å‘½ä»¤è¡Œé”®å…¥screenå‘½ä»¤1test_dbs2 ~ # screen æˆ–è€…æ·»åŠ ä¸€ä¸ªåç§°ä¸ºmysqldump1test_dbs2 ~ # screen -S mysqldump ä¹‹åæˆ‘ä»¬æƒ³æš‚æ—¶é€€å‡ºåšç‚¹åˆ«çš„äº‹æƒ…ï¼Œæ¯”å¦‚å‡ºå»æ•£æ•£æ­¥ï¼Œé‚£ä¹ˆåœ¨screençª—å£é”®å…¥C-a dï¼ŒScreenä¼šç»™å‡ºdetachedæç¤ºï¼š æš‚æ—¶ä¸­æ–­ä¼šè¯ åŠä¸ªå°æ—¶ä¹‹åå›æ¥äº†ï¼Œæ‰¾åˆ°è¯¥screenä¼šè¯ï¼š1test_dbs2 ~ # screen -ls é‡æ–°è¿æ¥ä¼šè¯ï¼š123test_dbs2 ~ # screen -r -S mysqldump#æˆ–è€…test_dbs2 ~ # screen -r 16582 çœ‹çœ‹å‡ºç°ä»€ä¹ˆäº†ï¼Œå¤ªæ£’äº†ï¼Œä¸€åˆ‡éƒ½åœ¨ã€‚ç»§ç»­å¹²å§ã€‚ ä½ å¯èƒ½æ³¨æ„åˆ°ç»™screenå‘é€å‘½ä»¤ä½¿ç”¨äº†ç‰¹æ®Šçš„é”®ç»„åˆC-aã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šé”®å…¥çš„ä¿¡æ¯æ˜¯ç›´æ¥å‘é€ç»™å½“å‰screençª—å£ï¼Œå¿…é¡»ç”¨å…¶ä»–æ–¹å¼å‘screençª—å£ç®¡ç†å™¨å‘å‡ºå‘½ä»¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œscreenæ¥æ”¶ä»¥C-aå¼€å§‹çš„å‘½ä»¤ã€‚è¿™ç§å‘½ä»¤å½¢å¼åœ¨screenä¸­å«åšé”®ç»‘å®šï¼ˆkey bindingï¼‰ï¼ŒC-aå«åšå‘½ä»¤å­—ç¬¦ï¼ˆcommand characterï¼‰ã€‚ å¯ä»¥é€šè¿‡C-a ?æ¥æŸ¥çœ‹æ‰€æœ‰çš„é”®ç»‘å®šï¼Œå¸¸ç”¨çš„é”®ç»‘å®šæœ‰ï¼š C-a ? æ˜¾ç¤ºæ‰€æœ‰é”®ç»‘å®šä¿¡æ¯ C-a w æ˜¾ç¤ºæ‰€æœ‰çª—å£åˆ—è¡¨ C-a C-a åˆ‡æ¢åˆ°ä¹‹å‰æ˜¾ç¤ºçš„çª—å£ C-a c åˆ›å»ºä¸€ä¸ªæ–°çš„è¿è¡Œshellçš„çª—å£å¹¶åˆ‡æ¢åˆ°è¯¥çª—å£ C-a n åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçª—å£ C-a p åˆ‡æ¢åˆ°å‰ä¸€ä¸ªçª—å£(ä¸C-a nç›¸å¯¹) C-a 0..9 åˆ‡æ¢åˆ°çª—å£0..9 C-a a å‘é€ C-aåˆ°å½“å‰çª—å£ C-a d æš‚æ—¶æ–­å¼€screenä¼šè¯ C-a k æ€æ‰å½“å‰çª—å£ C-a [ è¿›å…¥æ‹·è´/å›æ»šæ¨¡å¼ ä½¿ç”¨é”®ç»‘å®šC-a ?å‘½ä»¤å¯ä»¥çœ‹åˆ°, é»˜è®¤çš„å‘½ä»¤å­—ç¬¦ï¼ˆCommand keyï¼‰ä¸ºC-aï¼Œè½¬ä¹‰C-aï¼ˆliteral ^aï¼‰çš„å­—ç¬¦ä¸ºaï¼š å¦‚æœç”±äºæŸç§åŸå› å…¶ä¸­ä¸€ä¸ªä¼šè¯æ­»æ‰äº†ï¼ˆä¾‹å¦‚äººä¸ºæ€æ‰è¯¥ä¼šè¯ï¼‰ï¼Œè¿™æ—¶screen -listä¼šæ˜¾ç¤ºè¯¥ä¼šè¯ä¸ºdeadçŠ¶æ€ã€‚ä½¿ç”¨screen -wipeå‘½ä»¤æ¸…é™¤è¯¥ä¼šè¯ï¼š123test_dbs2 ~ # kill -9 8462test_dbs2 ~ # screen -wipetest_dbs2 ~ # screen -ls document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL ä¼˜åŒ–åŸç†(ä¸‰)]]></title>
    <url>%2F2019%2F03%2F29%2Fmysql-optimization-principle-3%2F</url>
    <content type="text"><![CDATA[æˆ´ä¸Šå®ƒã€‚éƒ½å‡ åå²çš„äººäº†ï¼Œä½ çœ‹ä½ å¤šè´±ï¼Œä½ æ²¡å°Šä¸¥å•Šï¼Ÿæˆ‘ä¸æƒ³çœ‹è§ä½ ï¼Œå¿«ç‚¹æˆ´ä¸Šï¼Œç„¶åå»çœ‹åŒ»ç”Ÿã€‚ å‰è¨€èŠèŠ MySQL é…ç½®ã€‚ å¤§å¤šæ•°å¼€å‘è€…å¯èƒ½ä¸å¤ªä¼šå…³æ³¨ MySQL çš„é…ç½®ï¼Œæ¯•ç«Ÿåœ¨åŸºæœ¬é…ç½®æ²¡æœ‰é—®é¢˜çš„æƒ…å†µä¸‹ï¼ŒæŠŠæ›´å¤šçš„ç²¾åŠ›æ”¾åœ¨ schema è®¾è®¡ã€ç´¢å¼•ä¼˜åŒ–å’Œ SQL ä¼˜åŒ–ä¸Šï¼Œæ˜¯éå¸¸åŠ¡å®çš„ç­–ç•¥ã€‚è¿™æ—¶ï¼Œå¦‚æœå†èŠ±åŠ›æ°”å»ä¼˜åŒ–é…ç½®é¡¹ï¼Œè·å¾—çš„æ”¶ç›Šé€šå¸¸éƒ½æ¯”è¾ƒå°ã€‚æ›´å¤šçš„æ—¶å€™ï¼ŒåŸºäºå®‰å…¨å› ç´ çš„è€ƒé‡ï¼Œæ™®é€šå¼€å‘è€…å¾ˆå°‘èƒ½å¤Ÿæ¥è§¦åˆ°ç”Ÿäº§ç¯å¢ƒçš„ MySQL é…ç½®ã€‚æ­£æ˜¯è¿™æ ·ï¼Œå¯¼è‡´å¼€å‘è€…ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰å¯¹ MySQL çš„é…ç½®ä¸ç”šäº†è§£ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¸®ä½ æ›´å¥½çš„äº†è§£ MySQL é…ç½®ã€‚ å¦‚æœè®©ä½ åœ¨æŸç§ç¯å¢ƒä¸Šå®‰è£…é…ç½® MySQLï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿå®‰è£…åï¼Œç›´æ¥ copy ä¿®æ”¹ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯å¤§å¤šæ•°äººçš„åšæ³•ã€‚ä½†å¼ºçƒˆå»ºè®®ä¸è¦æ€ä¹ˆåšï¼Œé¦–å…ˆï¼Œç¤ºä¾‹é…ç½®æ–‡ä»¶æœ‰éå¸¸å¤šæ³¨é‡Šæ‰çš„é…ç½®é¡¹ï¼Œå®ƒå¯èƒ½ä¼šè¯±ä½¿ä½ æ‰“å¼€ä¸€ä¸ªä½ å¹¶ä¸äº†è§£çš„é…ç½®ï¼Œè€Œä¸”è¿™äº›æ³¨é‡Šè¿˜ä¸ä¸€å®šå‡†ç¡®ã€‚å…¶æ¬¡ï¼ŒMySQL çš„ä¸€äº›é…ç½®å¯¹äºç°ä»£åŒ–çš„ç¡¬ä»¶å’Œå·¥ä½œè´Ÿè½½æ¥è¯´ï¼Œæœ‰ç‚¹è¿‡æ—¶äº†ã€‚ MySQL æœ‰éå¸¸å¤šçš„é…ç½®é¡¹å¯ä»¥ä¿®æ”¹ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ éƒ½ä¸åº”è¯¥éšä¾¿ä¿®æ”¹å®ƒï¼Œå› ä¸ºé”™è¯¯æˆ–è€…æ²¡ç”¨çš„é…ç½®å¯¼è‡´çš„æ½œåœ¨é£é™©éå¸¸å¤§ï¼Œè€Œä¸”è¿˜å¾ˆéš¾å®šä½é—®é¢˜ã€‚ç¡®ä¿åŸºæœ¬é…ç½®æ­£ç¡®ï¼Œç„¶åå°å¿ƒè¯Šæ–­é—®é¢˜ï¼Œç¡®è®¤é—®é¢˜æ°å¥½å¯ä»¥é€šè¿‡æŸä¸ªé…ç½®é¡¹è§£å†³ï¼Œç´§æ¥ç€å†ä¿®æ”¹è¿™ä¸ªé…ç½®å§ã€‚ å…¶å®ï¼Œåˆ›å»ºä¸€ä¸ªå¥½çš„é…ç½®ï¼Œæœ€å¿«æ–¹æ³•ä¸æ˜¯ä»å­¦ä¹ é…ç½®é¡¹å¼€å§‹ï¼Œä¹Ÿä¸æ˜¯é—®å“ªä¸ªé…ç½®é¡¹åº”è¯¥æ€ä¹ˆè®¾ç½®æˆ–è€…æ€ä¹ˆä¿®æ”¹å¼€å§‹ï¼Œæ›´ä¸æ˜¯ä»æ£€æŸ¥æœåŠ¡å™¨è¡Œä¸ºå’Œè¯¢é—®å“ªä¸ªé…ç½®é¡¹å¯ä»¥æå‡æ€§èƒ½å¼€å§‹ã€‚æœ€å¥½æ˜¯ä»ç†è§£ MySQL å†…æ ¸å’Œè¡Œä¸ºå¼€å§‹ï¼Œç„¶ååˆ©ç”¨è¿™äº›çŸ¥è¯†æ¥æŒ‡å¯¼ä½ é…ç½® MySQLã€‚ å°±ä»ç†è§£ MySQL é…ç½®çš„å·¥ä½œåŸç†å¼€å§‹å§ã€‚ MySQL é…ç½®çš„å·¥ä½œåŸç†MySQL ä»å“ªå„¿è·å¾—é…ç½®ä¿¡æ¯ï¼šå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶ã€‚ç±» Unix ç³»ç»Ÿä¸­ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬ä½äº /etc/my.cnf æˆ–è€… /etc/mysql/my.cnfã€‚åœ¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œå½“ç„¶å‘½ä»¤è¡Œä¸­ä¹Ÿå¯ä»¥æŒ‡å®šå…¶å®ƒå‚æ•°ï¼ŒæœåŠ¡å™¨ä¼šè¯»å–é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œåˆ é™¤æ‰€æœ‰æ³¨é‡Šå’Œæ¢è¡Œï¼Œç„¶åå’Œå‘½ä»¤è¡Œé€‰é¡¹ä¸€èµ·å¤„ç†ã€‚ ä»»ä½•æ‰“ç®—é•¿æœŸä½¿ç”¨çš„é…ç½®é¡¹éƒ½åº”è¯¥å†™å…¥é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šã€‚ä¸€å®šè¦æ¸…æ¥šçš„çŸ¥é“ MySQL ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä½ç½®ï¼Œåœ¨ä¿®æ”¹æ—¶ä¸èƒ½æƒ³å½“ç„¶ï¼Œæ¯”å¦‚ï¼Œä¿®æ”¹äº† /etc/my.cnf çš„é…ç½®é¡¹ï¼Œä½† MySQL å®é™…å¹¶æœªä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚å¦‚æœä½ ä¸çŸ¥é“å½“å‰ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥å°è¯•ï¼š12345$ which mysqld/usr/sbin/mysqld$ /usr/sbin/mysqld --verbose --help |grep -A 1 'Default options'Default options are read from the following files in the given order:/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf ä¸€ä¸ªå…¸å‹çš„é…ç½®æ–‡ä»¶åŒ…å«å¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†çš„å¼€å¤´æ˜¯ä¸€ä¸ªæ–¹æ‹¬å·æ‹¬èµ·æ¥çš„åˆ†æ®µåç§°ã€‚MySQL ç¨‹åºé€šå¸¸è¯»å–è·Ÿå®ƒåŒåçš„åˆ†æ®µéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼Œè®¸å¤šå®¢æˆ·ç«¯ç¨‹åºè¯»å–[client]éƒ¨åˆ†ã€‚æœåŠ¡å™¨é€šå¸¸è¯»å–[mysqld]è¿™ä¸€æ®µï¼Œä¸€å®šè¦ç¡®è®¤é…ç½®é¡¹æ”¾åœ¨äº†æ–‡ä»¶æ­£ç¡®çš„åˆ†æ®µä¸­ï¼Œå¦åˆ™é…ç½®æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚ MySQL æ¯ä¸€ä¸ªé…ç½®é¡¹å‡ä½¿ç”¨å°å†™ï¼Œå•è¯ä¹‹é—´ç”¨ä¸‹åˆ’çº¿æˆ–è€…æ¨ªçº¿éš”å¼€ï¼Œè™½ç„¶æˆ‘ä»¬å¸¸ç”¨çš„åˆ†éš”ç¬¦æ˜¯ä¸‹åˆ’çº¿ï¼Œä½†å¦‚æœåœ¨å‘½ä»¤è¡Œæˆ–è€…é…ç½®æ–‡ä»¶ä¸­è§åˆ°å¦‚ä¸‹é…ç½®ï¼Œä½ è¦çŸ¥é“ï¼Œå®ƒä»¬å…¶å®æ˜¯ç­‰ä»·çš„ï¼š123456# é…ç½®æ–‡ä»¶max_connections=5000max-connections=5000# å‘½ä»¤è¡Œ/usr/sbin/mysqld --max_connections=5000/usr/sbin/mysqld --max-connections=5000 é…ç½®é¡¹å¯ä»¥æœ‰å¤šä¸ªä½œç”¨åŸŸï¼šå…¨å±€ä½œç”¨åŸŸã€ä¼šè¯ä½œç”¨åŸŸ (æ¯ä¸ªè¿æ¥ä½œç”¨ä¸åŒ)ã€å¯¹è±¡ä½œç”¨åŸŸã€‚å¾ˆå¤šä¼šè¯çº§é…ç½®é¡¹è·Ÿå…¨å±€é…ç½®ç›¸ç­‰ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯é»˜è®¤å€¼ï¼Œå¦‚æœæ”¹å˜ä¼šè¯çº§é…ç½®é¡¹ï¼Œå®ƒåªå½±å“æ”¹åŠ¨çš„å½“å‰è¿æ¥ï¼Œå½“è¿æ¥å…³é—­æ—¶ï¼Œæ‰€æœ‰çš„å‚æ•°å˜æ›´éƒ½ä¼šå¤±æ•ˆã€‚ä¸‹é¢æœ‰å‡ ä¸ªç¤ºä¾‹é…ç½®é¡¹ï¼š query-cache-size å…¨å±€é…ç½®é¡¹ sort-buffer-size é»˜è®¤å…¨å±€ç›¸åŒï¼Œä½†æ¯ä¸ªçº¿ç¨‹é‡Œä¹Ÿå¯ä»¥è®¾ç½® join-buffer-size é»˜è®¤å…¨å±€ï¼Œä¸”æ¯ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥è®¾ç½®ã€‚ä½†è‹¥ä¸€ä¸ªæŸ¥è¯¢ä¸­å…³è”å¤šå¼ è¡¨ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå…³è”åˆ†é…ä¸€ä¸ªå…³è”ç¼“å­˜ (join-buffer)ï¼Œæ‰€ä»¥ä¸€ä¸ªæŸ¥è¯¢å¯èƒ½æœ‰å¤šä¸ªå…³è”ç¼“å†²ã€‚ é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡ (é…ç½®é¡¹) æœ‰å¾ˆå¤š (ä½†ä¸æ˜¯æ‰€æœ‰) å¯ä»¥åœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ä¿®æ”¹ï¼ŒMySQL æŠŠè¿™äº›å½’ä¸ºåŠ¨æ€é…ç½®å˜é‡ï¼š12345678910111213141516-- è®¾ç½®å…¨å±€å˜é‡ï¼ŒGLOBALå’Œ@@globalä½œç”¨æ˜¯ä¸€æ ·çš„set GLOBAL sort-buffer-size = set @@global.sort-buffer-size := -- è®¾ç½®ä¼šè¯çº§å˜é‡ï¼Œä¸‹é¢6ç§æ–¹å¼ä½œç”¨æ˜¯ä¸€æ ·çš„-- å³ï¼šæ²¡æœ‰ä¿®é¥°ç¬¦ã€SESSIONã€LOCALç­‰ä¿®é¥°ç¬¦ä½œç”¨æ˜¯ä¸€è‡´çš„set SESSION sort-buffer-size = set @@session.sort-buffer-size := set @@sort-buffer-size = set LOCAL sort-buffer-size = set @@ocal.sort-buffer-size := set sort-buffer-size = -- setå‘½ä»¤å¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªå˜é‡ï¼Œä½†å…¶ä¸­åªè¦æœ‰ä¸€ä¸ªå˜é‡è®¾ç½®å¤±è´¥ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½æœªç”Ÿæ•ˆSET GLOBAL sort-buffer-size = 100, SESSION sort-buffer-size = 1000;SET GLOBAL max-connections = 1000, sort-buffer-size = 1000000; åŠ¨æ€çš„è®¾ç½®å˜é‡ï¼ŒMySQL å…³é—­æ—¶è¿™äº›å˜é‡éƒ½ä¼šå¤±æ•ˆã€‚å¦‚æœåœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ä¿®æ”¹äº†å˜é‡çš„å…¨å±€å€¼ï¼Œè¿™ä¸ªå€¼å¯¹å½“å‰ä¼šè¯å’Œå…¶ä»–ä»»ä½•å·²ç»å­˜åœ¨çš„ä¼šè¯éƒ½ä¸èµ·æ•ˆæœï¼Œè¿™æ˜¯å› ä¸ºä¼šè¯çš„å˜é‡å€¼æ˜¯åœ¨è¿æ¥åˆ›å»ºæ—¶ä»å…¨å±€å€¼åˆå§‹åŒ–è€Œæ¥çš„ã€‚æ³¨æ„ï¼Œåœ¨é…ç½®ä¿®æ”¹åï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦ä¿®æ”¹æˆåŠŸã€‚ ä½ å¯èƒ½æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰äº›ä½¿ç”¨ â€˜=â€™ï¼Œæœ‰äº›ä½¿ç”¨ â€˜:=â€™ã€‚å¯¹äº set å‘½ä»¤æœ¬èº«æ¥è¯´ï¼Œä¸¤ç§èµ‹å€¼è¿ç®—ç¬¦æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ä»»ä¸€è¿ç®—ç¬¦ç¬¦ï¼Œå‡å¯ä»¥ç”Ÿæ•ˆã€‚è€Œåœ¨å…¶ä»–è¯­å¥ä¸­ï¼Œèµ‹å€¼è¿ç®—ç¬¦å¿…é¡»æ˜¯ â€˜:=â€™ï¼Œå› ä¸ºåœ¨é set è¯­å¥ä¸­ â€˜=â€™ è¢«è§†ä¸ºæ¯”è¾ƒè¿ç®—ç¬¦ã€‚å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼š è¯¦ç»†ç¤ºä¾‹å¯ä»¥å‚è€ƒï¼š12345678910-- @exp è¡¨ç¤ºç”¨æˆ·å˜é‡ï¼Œä¸Šé¢çš„ç¤ºä¾‹å‡æ˜¯ç³»ç»Ÿå˜é‡-- é”™è¯¯set @user = 123456;set @group = select GROUP from USER where User = @user;select * from USER where GROUP = @group;-- æ­£ç¡®SET @user := 123456;SELECT @group := `group` FROM user WHERE user = @user;SELECT * FROM user WHERE `group` = @group; æœ‰ä¸€äº›é…ç½®ä½¿ç”¨äº†ä¸åŒçš„å•ä½ï¼Œæ¯”å¦‚table-cacheå˜é‡æŒ‡å®šè¡¨å¯ä»¥è¢«ç¼“å­˜çš„æ•°é‡ï¼Œè€Œä¸æ˜¯è¡¨å¯ä»¥è¢«ç¼“å­˜çš„å­—èŠ‚æ•°ã€‚è€Œkey-buffer-sizeåˆ™æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚ è¿˜æœ‰ä¸€äº›é…ç½®å¯ä»¥æŒ‡å®šåç¼€å•ä½ï¼Œæ¯”å¦‚1M=10241024å­—èŠ‚ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™åªèƒ½åœ¨é…ç½®æ–‡ä»¶æˆ–è€…ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°æ—¶æœ‰æ•ˆã€‚å½“ä½¿ç”¨ SQL çš„ SET å‘½ä»¤æ—¶ï¼Œå¿…é¡»ä½¿ç”¨æ•°å­—å€¼ 1048576 æˆ–è€… 10241024 è¿™æ ·çš„è¡¨è¾¾å¼ï¼Œä½†åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸èƒ½ä½¿ç”¨è¡¨è¾¾å¼ã€‚ å°å¿ƒç¿¼ç¿¼çš„é…ç½® MySQLæˆ‘ä»¬å¸¸å¸¸åŠ¨æ€çš„ä¿®æ”¹é…ç½®ï¼Œä½†è¯·åŠ¡å¿…å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å¯¼è‡´æ•°æ®åº“åšå¤§é‡è€—æ—¶çš„å·¥ä½œï¼Œä»è€Œå½±å“æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚æ¯”å¦‚ä»ç¼“å­˜ä¸­åˆ·æ–°è„å—ï¼Œä¸åŒçš„åˆ·æ–°æ–¹å¼å¯¹ I/O çš„å½±å“å·®åˆ«å¾ˆå¤§ (åæ–‡ä¼šå…·ä½“è¯´æ˜)ã€‚æœ€å¥½æŠŠä¸€äº›å¥½çš„ä¹ æƒ¯ä½œä¸ºè§„èŒƒåˆå¹¶åˆ°å·¥ä½œæµç¨‹ä¸­å»ï¼Œå°±æ¯”å¦‚ï¼š å¥½ä¹ æƒ¯ 1ï¼šä¸è¦é€šè¿‡é…ç½®é¡¹çš„åç§°æ¥æ¨æ–­ä¸€ä¸ªå˜é‡çš„ä½œç”¨ ä¸è¦é€šè¿‡é…ç½®é¡¹çš„åç§°æ¥æ¨æ–­ä¸€ä¸ªå˜é‡çš„ä½œç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½è·Ÿä½ æƒ³è±¡çš„å®Œå…¨ä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼š read-buffer-sizeï¼šå½“ MySQL éœ€è¦é¡ºåºè¯»å–æ•°æ®æ—¶ï¼Œå¦‚æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå…¶å°†è¿›è¡Œå…¨è¡¨æ‰«ææˆ–è€…å…¨ç´¢å¼•æ‰«æã€‚è¿™æ—¶ï¼ŒMySQL æŒ‰ç…§æ•°æ®çš„å­˜å‚¨é¡ºåºä¾æ¬¡è¯»å–æ•°æ®å—ï¼Œæ¯æ¬¡è¯»å–çš„æ•°æ®å—é¦–å…ˆä¼šæš‚å­˜åœ¨ç¼“å­˜ä¸­ï¼Œå½“ç¼“å­˜ç©ºé—´è¢«å†™æ»¡æˆ–è€…å…¨éƒ¨æ•°æ®è¯»å–ç»“æŸåï¼Œå†å°†ç¼“å­˜ä¸­çš„æ•°æ®è¿”å›ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œä»¥æé«˜æ•ˆç‡ã€‚ read-rnd-buffer-sizeï¼šå’Œé¡ºåºè¯»å–ç›¸å¯¹åº”ï¼Œå½“ MySQL è¿›è¡Œéé¡ºåºè¯»å–ï¼ˆéšæœºè¯»å–ï¼‰æ•°æ®å—çš„æ—¶å€™ï¼Œä¼šåˆ©ç”¨è¿™ä¸ªç¼“å†²åŒºæš‚å­˜è¯»å–çš„æ•°æ®ã€‚æ¯”å¦‚ï¼šæ ¹æ®ç´¢å¼•ä¿¡æ¯è¯»å–è¡¨æ•°æ®ã€æ ¹æ®æ’åºåçš„ç»“æœé›†ä¸è¡¨è¿›è¡Œ Join ç­‰ç­‰ã€‚æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å½“æ•°æ®å—çš„è¯»å–éœ€è¦æ»¡è¶³ä¸€å®šçš„é¡ºåºçš„æƒ…å†µä¸‹ï¼ŒMySQL å°±éœ€è¦äº§ç”Ÿéšæœºè¯»å–ï¼Œè¿›è€Œä½¿ç”¨åˆ°read-rnd-buffer-sizeå‚æ•°æ‰€è®¾ç½®çš„å†…å­˜ç¼“å†²åŒºã€‚ è¿™ä¸¤ä¸ªé…ç½®éƒ½æ˜¯åœ¨æ‰«æ MyISAM è¡¨æ—¶æœ‰æ•ˆï¼Œä¸” MySQL ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…å†…å­˜ã€‚å¯¹äºå‰è€…ï¼ŒMySQL åªä¼šåœ¨æŸ¥è¯¢éœ€è¦ä½¿ç”¨æ—¶æ‰ä¼šä¸ºè¯¥ç¼“å­˜åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§åˆ†é…è¯¥å‚æ•°æŒ‡å®šå¤§å°çš„å…¨éƒ¨å†…å­˜ï¼Œè€Œåè€…åŒæ ·æ˜¯éœ€è¦æ—¶æ‰åˆ†é…å†…å­˜ï¼Œä½†åªåˆ†é…éœ€è¦çš„å†…å­˜å¤§å°è€Œä¸æ˜¯å‚æ•°æŒ‡å®šçš„æ•°å€¼ï¼Œmax-read-rnd-buffer-size(å®é™…ä¸Šæ²¡æœ‰è¿™ä¸ªé…ç½®é¡¹) è¿™ä¸ªåå­—æ›´èƒ½è¡¨è¾¾è¿™ä¸ªå˜é‡çš„å®é™…å«ä¹‰ã€‚ å¥½ä¹ æƒ¯ 2ï¼šä¸è¦è½»æ˜“åœ¨å…¨å±€ä¿®æ”¹ä¼šè¯çº§åˆ«çš„é…ç½® å¯¹äºæŸäº›ä¼šè¯çº§åˆ«çš„è®¾ç½®ï¼Œä¸è¦è½»æ˜“çš„åœ¨å…¨å±€å¢åŠ å®ƒä»¬çš„å€¼ï¼Œé™¤éä½ ç¡®è®¤è¿™æ ·åšæ˜¯å¯¹çš„ã€‚æ¯”å¦‚ï¼šsort-buffer-sizeï¼Œè¯¥å‚æ•°æ§åˆ¶æ’åºæ“ä½œçš„ç¼“å­˜å¤§å°ï¼ŒMySQL åªä¼šåœ¨æŸ¥è¯¢éœ€è¦åšæ’åºæ“ä½œæ—¶æ‰ä¼šä¸ºè¯¥ç¼“å†²åˆ†é…å†…å­˜ï¼Œä¸€æ—¦éœ€è¦æ’åºï¼Œå°±ä¼šä¸€æ¬¡æ€§åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜ï¼Œå³ä½¿æ˜¯éå¸¸å°çš„æ’åºæ“ä½œã€‚å› æ­¤åœ¨é…ç½®æ–‡ä»¶ä¸­åº”è¯¥é…ç½®çš„å°ä¸€äº›ï¼Œç„¶ååœ¨æŸäº›æŸ¥è¯¢éœ€è¦æ’åºæ—¶ï¼Œå†åœ¨è¿æ¥ä¸­æŠŠå®ƒè°ƒå¤§ã€‚æ¯”å¦‚ï¼š1234SET @@seession.sort-buffer-size := -- æ‰§è¡ŒæŸ¥è¯¢çš„sqlSET @@seession.sort-buffer-size := DEFAULT -- æ¢å¤é»˜è®¤å€¼-- å¯ä»¥å°†ç±»ä¼¼çš„ä»£ç å°è£…åœ¨å‡½æ•°ä¸­æ–¹ä¾¿ä½¿ç”¨ã€‚ å¥½ä¹ æƒ¯ 3ï¼šé…ç½®å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å€¼è¶Šå¤§è¶Šå¥½é…ç½®å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å€¼è¶Šå¤§è¶Šå¥½ï¼Œè€Œä¸”å¦‚æœè®¾ç½®çš„å€¼å¤ªé«˜ï¼Œå¯èƒ½æ›´å®¹æ˜“å¯¼è‡´å†…å­˜é—®é¢˜ã€‚åœ¨ä¿®æ”¹å®Œæˆåï¼Œåº”è¯¥é€šè¿‡ç›‘æ§æ¥ç¡®è®¤å˜é‡çš„ä¿®æ”¹å¯¹æœåŠ¡å™¨æ•´ä½“æ€§èƒ½çš„å½±å“ã€‚ å¥½ä¹ æƒ¯ 4ï¼šè§„èŒƒæ³¨é‡Šï¼Œç‰ˆæœ¬æ§åˆ¶åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¥½æ³¨é‡Šï¼Œå¯èƒ½ä¼šèŠ‚çœè‡ªå·±å’ŒåŒäº‹å¤§é‡çš„å·¥ä½œï¼Œä¸€ä¸ªæ›´å¥½çš„ä¹ æƒ¯æ˜¯æŠŠé…ç½®æ–‡ä»¶ç½®äºç‰ˆæœ¬æ§åˆ¶ä¹‹ä¸‹ã€‚ è¯´å®Œäº†å¥½ä¹ æƒ¯ï¼Œå†æ¥è¯´è¯´ä¸å¥½çš„ä¹ æƒ¯ã€‚ åä¹ æƒ¯ 1ï¼šæ ¹æ®ä¸€äº› â€œæ¯”ç‡â€ æ¥è°ƒä¼˜ä¸€ä¸ªç»å…¸çš„æŒ‰ â€œæ¯”ç‡â€ è°ƒä¼˜çš„ç»éªŒæ³•åˆ™æ˜¯ï¼Œç¼“å­˜çš„å‘½ä¸­ç‡åº”è¯¥é«˜äºæŸä¸ªç™¾åˆ†æ¯”ï¼Œå¦‚æœå‘½ä¸­ç‡è¿‡ä½ï¼Œåˆ™åº”è¯¥å¢åŠ ç¼“å­˜çš„å¤§å°ã€‚è¿™æ˜¯éå¸¸é”™è¯¯çš„æ„è§ï¼Œå¤§å®¶å¯ä»¥ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼šç¼“å­˜çš„å‘½ä¸­ç‡è·Ÿç¼“å­˜å¤§å°æœ‰å¿…ç„¶è”ç³»å—ï¼Ÿ(åˆ†æ¯å˜å¤§ï¼Œå€¼å°±å˜å¤§äº†ï¼Ÿ) é™¤éç¡®å®æ˜¯ç¼“å­˜å¤ªå°äº†ã€‚å…³äº MyISAM é”®ç¼“å†²å‘½ä¸­ç‡ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è¯´æ˜ã€‚ åä¹ æƒ¯ 2ï¼šéšä¾¿ä½¿ç”¨è°ƒä¼˜è„šæœ¬å°½é‡ä¸è¦ä½¿ç”¨è°ƒä¼˜è„šæœ¬ï¼ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€ä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒå¯¹ MySQL çš„æ€§èƒ½è¦æ±‚æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚æœ‰äº›ä¸šåŠ¡å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚è¾ƒé«˜ï¼Œé‚£ä¹ˆå°±ä¸€å®šè¦ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå‡ºç°æ•…éšœåå¯æ¢å¤æ•°æ®ï¼Œè€Œæœ‰äº›ä¸šåŠ¡å´å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚æ²¡é‚£ä¹ˆé«˜ï¼Œä½†å¯¹æ€§èƒ½è¦æ±‚æ›´é«˜ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œåœ¨è¿™ä¸¤ä¸ªä¸åŒåœºæ™¯ä¸‹ï¼Œå…¶é…ç½®çš„å€¼ä¹Ÿåº”è¯¥æ˜¯ä¸åŒçš„ã€‚é‚£ä½ è¿˜èƒ½æ”¾å¿ƒçš„ä½¿ç”¨ç½‘ä¸Šæ‰¾åˆ°çš„è„šæœ¬å— ï¼Ÿ æœ¬å°èŠ‚ç¤ºä¾‹çš„å‡ ä¸ªé…ç½®é¡¹ï¼Œä»…ç”¨äºä¸¾ä¾‹è¯´æ˜ï¼Œå¹¶ä¸ä»£è¡¨å®ƒä»¬æœ‰å¤šä¹ˆé‡è¦ï¼Œè¯·æ ¹æ®å®é™…åº”ç”¨åœºæ™¯é…ç½®å®ƒä»¬ã€‚å°±æ¯”å¦‚sort-buffer-sizeï¼Œä½ çœŸçš„éœ€è¦ 100M å†…å­˜æ¥ç¼“å­˜ 10 è¡Œæ•°æ®ï¼Ÿ åˆ†æ®µMySQL é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸ºé›†ä¸­å¼ï¼Œé€šå¸¸ä¼šåˆ†æˆå¥½å‡ éƒ¨åˆ†ï¼Œå¯ä»¥ä¸ºå¤šä¸ªç¨‹åºæä¾›é…ç½®ï¼Œå¦‚[client]ã€[mysqld]ã€[mysql]ç­‰ç­‰ã€‚MySQL ç¨‹åºé€šå¸¸æ˜¯è¯»å–ä¸å®ƒåŒåçš„åˆ†æ®µéƒ¨åˆ†ã€‚ [client]å®¢æˆ·ç«¯é»˜è®¤è®¾ç½®å†…å®¹ [mysql]ä½¿ç”¨ mysql å‘½ä»¤ç™»å½• MySQL æ•°æ®åº“æ—¶çš„é»˜è®¤è®¾ç½® [mysqld]æ•°æ®åº“æœ¬èº«çš„é»˜è®¤è®¾ç½® ä¾‹å¦‚æœåŠ¡å™¨ mysqld é€šå¸¸è¯»å–[mysqld]åˆ†æ®µä¸‹çš„ç›¸å…³é…ç½®é¡¹ã€‚å¦‚æœé…ç½®é¡¹ä½ç½®ä¸æ­£ç¡®ï¼Œè¯¥é…ç½®æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚ GENERALé¦–å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ· mysql æ¥è¿è¡Œ mysqld è¿›ç¨‹ï¼Œè¯·ç¡®ä¿è¿™ä¸ªç”¨æˆ·æ‹¥æœ‰æ“ä½œæ•°æ®ç›®å½•çš„æƒé™ã€‚è®¾ç½®é»˜è®¤ç«¯å£ä¸º 3306ï¼Œæœ‰æ—¶ä¸ºäº†å®‰å…¨ï¼Œå¯èƒ½ä¼šä¿®æ”¹ä¸€ä¸‹ã€‚é»˜è®¤é€‰æ‹© Innodb å­˜å‚¨å¼•æ“ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ä½†å¦‚æœé»˜è®¤æ˜¯ InnoDBï¼Œå´éœ€è¦ä½¿ç”¨ MyISAM å­˜å‚¨å¼•æ“ï¼Œè¯·æ˜¾å¼åœ°è¿›è¡Œé…ç½®ã€‚è®¸å¤šç”¨æˆ·è®¤ä¸ºå…¶æ•°æ®åº“ä½¿ç”¨äº†æŸç§å­˜å‚¨å¼•æ“ä½†å®é™…ä¸Šå´ä½¿ç”¨çš„æ˜¯å¦å¤–ä¸€ç§ï¼Œå°±æ˜¯å› ä¸ºé»˜è®¤é…ç½®çš„é—®é¢˜ã€‚ æ¥ç€è®¾ç½®æ•°æ®æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™é‡ŒæŠŠ pid æ–‡ä»¶å’Œ socket æ–‡ä»¶æ”¾åˆ°ç›¸åŒçš„ä½ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶å®ƒä½ç½®ï¼Œä½†è¦æ³¨æ„çš„æ˜¯ä¸è¦å°† socket æ–‡ä»¶å’Œ pid æ–‡ä»¶æ”¾åˆ° MySQL ç¼–è¯‘çš„é»˜è®¤ä½ç½®ï¼Œå› ä¸ºä¸åŒç‰ˆæœ¬çš„ MySQLï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„é»˜è®¤è·¯å¾„å¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œæœ€å¥½æ˜ç¡®åœ°è®¾ç½®è¿™äº›æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å…ç‰ˆæœ¬å‡çº§æ—¶å‡ºç°é—®é¢˜ã€‚ åœ¨ç±» UNIX ç³»ç»Ÿä¸‹æœ¬åœ°è¿æ¥ MySQL å¯ä»¥é‡‡ç”¨ UNIX åŸŸå¥—æ¥å­—æ–¹å¼ï¼Œè¿™ç§æ–¹å¼éœ€è¦ä¸€ä¸ªå¥—æ¥å­—ï¼ˆsocketï¼‰æ–‡ä»¶ï¼Œå³é…ç½®ä¸­çš„mysql.sockæ–‡ä»¶ã€‚ å½“ MySQL å®ä¾‹å¯åŠ¨æ—¶ï¼Œä¼šå°†è‡ªå·±çš„è¿›ç¨‹ ID å†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”è¯¥æ–‡ä»¶å³ä¸º pid æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ç”±å‚æ•°pid-fileæ§åˆ¶ï¼Œé»˜è®¤ä½äºæ•°æ®åº“ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ºä¸»æœºå.pidã€‚ DATA STORAGEdatadirç”¨äºé…ç½®æ•°æ®æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ã€‚ ä¸ºç¼“å­˜åˆ†é…å†…å­˜æ¥ä¸‹æ¥æœ‰è®¸å¤šæ¶‰åŠåˆ°ç¼“å­˜çš„é…ç½®é¡¹ï¼Œç¼“å­˜è®¾ç½®å¤šå¤§ï¼Œæœ€ç›´æ¥çš„å› ç´ è‚¯å®šæ˜¯æœåŠ¡å™¨å†…å­˜çš„å¤§å°ã€‚å¦‚æœæœåŠ¡å™¨åªè¿è¡Œ MySQLï¼Œæ‰€æœ‰ä¸éœ€è¦ä¸º OS ä»¥åŠæŸ¥è¯¢å¤„ç†ä¿ç•™çš„å†…å­˜éƒ½å¯ä»¥ç”¨åœ¨ MySQL ç¼“å­˜ã€‚ä¸º MySQL ç¼“å­˜åˆ†é…æ›´å¤šå†…å­˜ï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…ç£ç›˜è®¿é—®ï¼Œæå‡æ•°æ®åº“æ€§èƒ½ã€‚å¤§éƒ¨åˆ†æƒ…å†µæ¥è¯´æœ€ä¸ºé‡è¦çš„ç¼“å­˜ï¼š InnoDB ç¼“å†²æ±  InnoDB æ—¥å¿—æ–‡ä»¶å’Œ MyISAM æ•°æ®çš„æ“ä½œç³»ç»Ÿç¼“å­˜ (MyISAM ä¾èµ–äº OS ç¼“å­˜æ•°æ®) MyISAM é”®ç¼“å­˜ æŸ¥è¯¢ç¼“å­˜ æ— æ³•é…ç½®çš„ç¼“å­˜ï¼Œæ¯”å¦‚ï¼šbin-log æˆ–è€…è¡¨å®šä¹‰æ–‡ä»¶çš„ OS ç¼“å­˜ è¿˜æœ‰ä¸€äº›å…¶ä»–ç¼“å­˜ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸ä¼šä½¿ç”¨å¤ªå¤šå†…å­˜ã€‚å…³äºæŸ¥è¯¢ç¼“å­˜ï¼Œå‰é¢æ–‡ç«  (å‚è€ƒæœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡) å·²æœ‰ä»‹ç»ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ä¸å»ºè®®å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼Œå› æ­¤ä¸Šæ–‡çš„é…ç½®ä¸­query-cache-type=0è¡¨ç¤ºç¦ç”¨äº†æŸ¥è¯¢ç¼“å­˜ï¼Œç›¸åº”çš„æŸ¥è¯¢ç¼“å­˜å¤§å°query-cache-size=0ã€‚é™¤å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå‰©ä¸‹å…³äº InnoDB å’Œ MyISAM çš„ç›¸å…³ç¼“å­˜ï¼Œåœ¨æ¥ä¸‹æ¥ä¼šåšè¯¦ç»†ä»‹ç»ã€‚ å¦‚æœåªä½¿ç”¨å•ä¸€å­˜å‚¨å¼•æ“ï¼Œé…ç½®æœåŠ¡å™¨å°±ä¼šç®€å•è®¸å¤šã€‚å¦‚æœåªä½¿ç”¨ MyISAM è¡¨ï¼Œå°±å¯ä»¥å®Œå…¨å…³é—­ InnoDBï¼Œè€Œå¦‚æœåªä½¿ç”¨ InnoDBï¼Œå°±åªéœ€è¦åˆ†é…æœ€å°‘çš„èµ„æºç»™ MyISAMï¼ˆMySQL å†…éƒ¨ç³»ç»Ÿè¡¨ä½¿ç”¨ MyISAM å¼•æ“ï¼‰ã€‚ä½†å¦‚æœæ˜¯æ··åˆä½¿ç”¨å„ç§å­˜å‚¨å¼•æ“ï¼Œå°±å¾ˆéš¾åœ¨ä»–ä»¬ä¹‹é—´æ‰¾åˆ°æ°å½“çš„å¹³è¡¡ï¼Œå› æ­¤åªèƒ½æ ¹æ®ä¸šåŠ¡åšä¸€ä¸ªçŒœæµ‹ï¼Œç„¶ååœ¨è¿è¡Œä¸­è§‚å¯ŸæœåŠ¡å™¨è¿è¡ŒçŠ¶å†µååšå‡ºè°ƒæ•´ã€‚ MyISAMkey-buffer-size key-buffer-sizeç”¨äºé…ç½® MyISAMé”®ç¼“å­˜å¤§å°ï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ªé”®ç¼“å­˜ï¼Œä½†æ˜¯å¯ä»¥åˆ›å»ºå¤šä¸ªã€‚MyISAM è‡ªèº«åªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜æ•°æ® (ä¾èµ– OS ç¼“å­˜æ•°æ®)ã€‚å¦‚æœå¤§éƒ¨åˆ†è¡¨éƒ½æ˜¯ MyISAMï¼Œé‚£ä¹ˆåº”è¯¥ä¸ºé”®ç¼“å­˜è®¾ç½®è¾ƒå¤šçš„å†…å­˜ã€‚ä½†å¦‚ä½•ç¡®å®šè¯¥è®¾ç½®å¤šå¤§ï¼Ÿå‡è®¾æ•´ä¸ªæ•°æ®åº“ä¸­è¡¨çš„ç´¢å¼•å¤§å°ä¸º Xï¼Œè‚¯å®šä¸éœ€è¦æŠŠç¼“å­˜è®¾ç½®å¾—æ¯” X è¿˜å¤§ï¼Œæ‰€ä»¥å½“å‰çš„ç´¢å¼•å¤§å°å°±æˆä¸ºè¿™ä¸ªé…ç½®é¡¹çš„é‡è¦ä¾æ®ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼æ¥æŸ¥è¯¢å½“å‰ç´¢å¼•çš„å¤§å°ï¼š 1.é€šè¿‡ SQL è¯­å¥æŸ¥è¯¢1SELECT SUM(INDEX_LENGTH) FROM INFORMATION_SCHEMA.TABLES WHERE ENGINE = 'MYISAM' 2.ç»Ÿè®¡ç´¢å¼•æ–‡ä»¶çš„å¤§å°123456789101112131415$ du -sch `find /path/to/mysql/data/directory/ -name "*.MYI"`æ¯”å¦‚ï¼šroot@dev-msc3:# du -sch `find /var/lib/mysql -name "*.MYI"`72K /var/lib/mysql/static/t_global_region.MYI40K /var/lib/mysql/mysql/db.MYI12K /var/lib/mysql/mysql/proxies_priv.MYI12K /var/lib/mysql/mysql/tables_priv.MYI4.0K /var/lib/mysql/mysql/func.MYI4.0K /var/lib/mysql/mysql/columns_priv.MYI4.0K /var/lib/mysql/mysql/proc.MYI4.0K /var/lib/mysql/mysql/event.MYI4.0K /var/lib/mysql/mysql/user.MYI4.0K /var/lib/mysql/mysql/procs_priv.MYI4.0K /var/lib/mysql/mysql/ndb_binlog_index.MYI164K total ä½ å¯èƒ½ä¼šé—®ï¼Œåˆšåˆ›å»ºå¥½çš„æ•°æ®åº“ï¼Œæ ¹æœ¬å°±æ²¡ä»€ä¹ˆæ•°æ®ï¼Œç´¢å¼•æ–‡ä»¶å¤§å°ä¸º 0ï¼Œé‚£å¦‚ä½•é…ç½®é”®ç¼“å­˜å¤§å°ï¼Ÿè¿™æ—¶å€™åªèƒ½æ ¹æ®ç»éªŒå€¼ï¼šä¸è¶…è¿‡ä¸ºæ“ä½œç³»ç»Ÿç¼“å­˜ä¿ç•™å†…å­˜çš„ 25% ~ 50%ã€‚è®¾ç½®ä¸€ä¸ªåŸºæœ¬å€¼ï¼Œç­‰è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ ¹æ®è¿è¡Œæƒ…å†µæ¥è°ƒæ•´é”®ç¼“å­˜å¤§å°ã€‚æ€»ç»“æ¥è¯´ï¼Œç´¢å¼•å¤§å°ä¸ OS ç¼“å­˜çš„ 25%~50% ä¸¤è€…é—´å–å°è€…ã€‚å½“ç„¶è¿˜å¯ä»¥è®¡ç®—é”®ç¼“å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœä¸€æ®µæ—¶é—´åè¿˜æ˜¯æ²¡æœ‰ä½¿ç”¨å®Œæ‰€æœ‰çš„é”®ç¼“å­˜ï¼Œå°±å¯ä»¥æŠŠç¼“å†²åŒºè°ƒå°ä¸€ç‚¹ï¼Œè®¡ç®—ç¼“å­˜åŒºçš„ä½¿ç”¨ç‡å¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼ï¼š(key_blocks_unused * key_cache_block_size) / key_buffer_size è¯´æ˜ï¼š key_blocks_unused çš„å€¼å¯ä»¥é€šè¿‡ SHOW STATUS è·å– key_cache_block_size çš„å€¼å¯ä»¥é€šè¿‡ SHOW VARIABLES è·å– é”®ç¼“å­˜å—å¤§å°æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å€¼ï¼Œå› ä¸ºå®ƒå½±å“ MyISAMã€OS ç¼“å­˜ä»¥åŠæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„äº¤äº’ã€‚å¦‚æœç¼“å­˜å—å¤ªå°ï¼Œå¯èƒ½ä¼šç¢°åˆ°å†™æ—¶è¯»å– (OS åœ¨å†™æ•°æ®ä¹‹å‰å¿…é¡»å…ˆä»ç£ç›˜ä¸Šè¯»å–ä¸€äº›æ•°æ®)ï¼Œå…³äºå†™æ—¶è¯»å–çš„ç›¸å…³çŸ¥è¯†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ å…³äºç¼“å­˜å‘½ä¸­ç‡ï¼Œè¿™é‡Œå†è¯´ä¸€ç‚¹ã€‚ç¼“å­˜å‘½ä¸­ç‡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿå…¶å®è¿™ä¸ªæ•°å­—æ²¡å¤ªå¤§çš„ä½œç”¨ã€‚æ¯”å¦‚ 99% å’Œ 99.9% ä¹‹é—´çœ‹èµ·æ¥å·®è·å¾ˆå°ï¼Œä½†å®é™…ä¸Šä»£è¡¨äº† 10 å€çš„å·®è·ã€‚ç¼“å­˜å‘½ä¸­ç‡çš„å®é™…æ„ä¹‰ä¸åº”ç”¨ä¹Ÿæœ‰å¾ˆå¤§å…³ç³»ï¼Œæœ‰äº›åº”ç”¨å¯ä»¥åœ¨å‘½ä¸­ç‡ 99% ä¸‹è‰¯å¥½çš„å·¥ä½œï¼Œæœ‰äº› I/O å¯†é›†å‹åº”ç”¨ï¼Œå¯èƒ½éœ€è¦ 99.99%ã€‚æ‰€ä»¥ä»ç»éªŒä¸Šæ¥è¯´ï¼Œæ¯ç§’æœªå‘½ä¸­æ¬¡æ•°è¿™ä¸ªæŒ‡æ ‡å®é™…ä¸Šä¼šæ›´æœ‰ç”¨ä¸€äº›ã€‚æ¯”å¦‚æ¯ç§’ 5 æ¬¡æœªå‘½ä¸­å¯èƒ½ä¸ä¼šå¯¼è‡´ IO ç¹å¿™ï¼Œä½†æ¯ç§’ 100 æ¬¡ç¼“å­˜æœªå‘½ä¸­åˆ™å¯èƒ½å‡ºç°é—®é¢˜ã€‚ MyISAM é”®ç¼“å­˜çš„æ¯ç§’æœªå‘½ä¸­æ¬¡æ•°å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç›‘æ§ï¼š123# è®¡ç®—æ¯éš”10sç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°çš„å¢é‡# ä½¿ç”¨æ­¤å‘½ä»¤æ—¶è¯·å¸¦ä¸Šç”¨æˆ·å’Œå¯†ç å‚æ•°ï¼šmysqladmin -uroot -pxxx extended-status -r -i 10 | grep Key_reads$ mysqladmin extended-status -r -i 10 | grep Key_reads æœ€åï¼Œå³ä½¿æ²¡æœ‰ä½¿ç”¨ä»»ä½• MyISAM è¡¨ï¼Œä¾ç„¶éœ€è¦å°†key-buffer-sizeè®¾ç½®ä¸ºè¾ƒå°å€¼ï¼Œæ¯”å¦‚ 32Mï¼Œå› ä¸º MySQL å†…éƒ¨ä¼šä½¿ç”¨ MyISAM è¡¨ï¼Œæ¯”å¦‚ GROUP BY è¯­å¥å¯èƒ½ä¼šåˆ›å»º MyISAM ä¸´æ—¶è¡¨ã€‚ myisam-recovermyisam-recoveré€‰é¡¹ç”¨äºé…ç½® MyISAM æ€æ ·å¯»æ‰¾å’Œä¿®å¤é”™è¯¯ã€‚æ‰“å¼€è¿™ä¸ªé€‰é¡¹ä¼šé€šçŸ¥ MySQL åœ¨æ‰“å¼€è¡¨æ—¶ï¼Œæ£€æŸ¥è¡¨æ˜¯å¦æŸåï¼Œå¹¶åœ¨æ‰¾åˆ°é—®é¢˜æ—¶è¿›è¡Œä¿®å¤ï¼Œå®ƒå¯ä»¥è®¾ç½®å¦‚ä¸‹å€¼ï¼š DEFAULTï¼šè¡¨ç¤ºä¸è®¾ç½®ï¼Œä¼šå°è¯•ä¿®å¤å´©æºƒæˆ–è€…æœªå®Œå…¨å…³é—­çš„è¡¨ï¼Œä½†åœ¨æ¢å¤æ•°æ®æ—¶ä¸ä¼šæ‰§è¡Œå…¶å®ƒåŠ¨ä½œ BACKUPï¼šå°†æ•°æ®æ–‡ä»¶å¤‡ä»½åˆ°. bak æ–‡ä»¶ï¼Œä»¥ä¾¿éšåè¿›è¡Œæ£€æŸ¥ FORCEï¼šå³ä½¿. myd æ–‡ä»¶ä¸­ä¸¢å¤±çš„æ•°æ®è¶…è¿‡ 1 è¡Œï¼Œä¹Ÿè®©æ¢å¤åŠ¨ä½œç»§ç»­æ‰§è¡Œ QUICKï¼šé™¤éæœ‰åˆ é™¤å—ï¼Œå¦åˆ™è·³è¿‡æ¢å¤ å¯ä»¥è®¾ç½®å¤šä¸ªå€¼ï¼Œæ¯ä¸ªå€¼ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚é…ç½®æ–‡ä»¶ä¸­çš„BACKUP,FORCEä¼šå¼ºåˆ¶æ¢å¤å¹¶ä¸”åˆ›å»ºå¤‡ä»½ï¼Œè¿™æ ·é…ç½®åœ¨åªæœ‰ä¸€äº›å°çš„ MyISAM è¡¨æ—¶æœ‰ç”¨ï¼Œå› ä¸ºæœåŠ¡å™¨è¿è¡Œç€ä¸€äº›æŸåçš„ MyISAM è¡¨æ˜¯éå¸¸å±é™©çš„ï¼Œå®ƒä»¬æœ‰æ—¶å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šæ•°æ®æŸåï¼Œç”šè‡³æœåŠ¡å™¨å´©æºƒã€‚ç„¶è€Œå¦‚æœæœ‰å¾ˆå¤§çš„è¡¨ï¼Œå®ƒä¼šå¯¼è‡´æœåŠ¡å™¨æ‰“å¼€æ‰€æœ‰çš„ MyISAM è¡¨æ—¶éƒ½æ£€æŸ¥å’Œä¿®å¤ï¼Œå¤§è¡¨çš„æ£€æŸ¥å’Œä¿®å¤å¯èƒ½ä¼šè€—è´¹å¤§é‡æ—¶é—´ï¼Œä¸”åœ¨è¿™æ®µæ—¶é—´é‡Œï¼ŒMySQL ä¼šé˜»æ­¢è¿™ä¸ªè¿æ¥åšå…¶å®ƒä»»ä½•æ“ä½œï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆ‡å®é™…çš„ã€‚ å› æ­¤ï¼Œåœ¨é»˜è®¤ä½¿ç”¨ InnoDB å­˜å‚¨å¼•æ“æ—¶ï¼Œæ•°æ®åº“ä¸­åªæœ‰éå¸¸å°çš„ MyISAM è¡¨æ—¶ï¼Œåªéœ€è¦é…ç½®key-buffe-sizeäºä¸€ä¸ªå¾ˆå°çš„å€¼ (32M) ä»¥åŠmyisam-recover=BACKUP,FORCEã€‚å½“æ•°æ®åº“ä¸­å¤§éƒ¨åˆ†è¡¨ä¸º MyISAM è¡¨æ—¶ï¼Œè¯·æ ¹æ®ä¸Šæ–‡çš„å…¬å¼åˆç†é…ç½®key-buffer-sizeï¼Œè€Œmyisam-recoveråˆ™å¯ä»¥å…³é—­ï¼Œåœ¨å¯åŠ¨åä½¿ç”¨CHECK TABLESå’ŒREPAIR TABLESå‘½ä»¤æ¥åšæ£€æŸ¥å’Œä¿®å¤ï¼Œè¿™æ ·å¯¹æœåŠ¡å™¨çš„å½±å“æ¯”è¾ƒå°ã€‚ SAFETYåŸºæœ¬é…ç½®è®¾ç½®åˆ°ä½åï¼ŒMySQL å·²ç»æ¯”è¾ƒå®‰å…¨äº†ï¼Œè¿™é‡Œä»…ä»…åˆ—å‡ºä¸¤ä¸ªéœ€è¦æ³¨æ„çš„é…ç½®é¡¹ï¼Œå¦‚æœéœ€è¦å¯ç”¨ä¸€äº›ä½¿æœåŠ¡å™¨æ›´å®‰å…¨å’Œå¯é çš„è®¾ç½®ï¼Œå¯ä»¥å‚è€ƒ MySQL å®˜æ–¹æ‰‹å†Œï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬å…¶ä¸­çš„ä¸€äº›é€‰é¡¹å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œæ¯•ç«Ÿä¿è¯å®‰å…¨å’Œå¯é éœ€è¦ä»˜å‡ºä¸€äº›ä»£ä»·ã€‚ max-allowed-packetmax-allowed-packeté˜²æ­¢æœåŠ¡å™¨å‘é€å¤ªå¤§çš„æ•°æ®åŒ…ï¼Œä¹Ÿæ§åˆ¶æœåŠ¡å™¨å¯ä»¥æ¥æ”¶å¤šå¤§çš„åŒ…ã€‚é»˜è®¤å€¼ 4Mï¼Œå¯èƒ½ä¼šæ¯”è¾ƒå°ã€‚å¦‚æœè®¾ç½®å¤ªå°ï¼Œæœ‰æ—¶å¤åˆ¶ä¸Šä¼šå‡ºé—®é¢˜ï¼Œè¡¨ç°ä¸ºä»åº“ä¸èƒ½æ¥æ”¶ä¸»åº“å‘è¿‡æ¥çš„å¤åˆ¶æ•°æ®ã€‚å¦‚æœè¡¨ä¸­æœ‰ Blob æˆ–è€… Text å­—æ®µï¼Œä¸”æ•°æ®é‡è¾ƒå¤§çš„è¯ï¼Œè¦å°å¿ƒï¼Œå¦‚æœæ•°æ®é‡è¶…è¿‡è¿™ä¸ªå˜é‡çš„å¤§å°ï¼Œå®ƒä»¬å¯èƒ½è¢«æˆªæ–­æˆ–è€…ç½®ä¸º NULLï¼Œè¿™é‡Œå»ºè®®è®¾ç½®ä¸º 16Mã€‚ max-connect-errorsè¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ª MySQL ä¸­ä¸å®‰å…¨ç›¸å…³çš„è®¡æ•°å™¨å€¼ï¼Œå®ƒä¸»è¦é˜²æ­¢å®¢æˆ·ç«¯æš´åŠ›ç ´è§£å¯†ç ã€‚å¦‚æœæŸä¸€ä¸ªå®¢æˆ·ç«¯å°è¯•è¿æ¥ MySQL æœåŠ¡å™¨å¤±è´¥è¶…è¿‡ n æ¬¡ï¼Œåˆ™ MySQL ä¼šæ— æ¡ä»¶å¼ºåˆ¶é˜»æ­¢æ­¤å®¢æˆ·ç«¯è¿æ¥ï¼Œç›´åˆ°å†æ¬¡åˆ·æ–°ä¸»æœºç¼“å­˜æˆ–è€…é‡å¯ MySQL æœåŠ¡å™¨ã€‚ è¿™ä¸ªå€¼é»˜è®¤ä¸º 10ï¼Œå¤ªå°äº†ï¼Œæœ‰æ—¶å€™ç½‘ç»œæŠ½é£æˆ–è€…åº”ç”¨é…ç½®å‡ºç°é”™è¯¯å¯¼è‡´çŸ­æ—¶é—´å†…ä¸æ–­å°è¯•é‡è¿æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å°±ä¼šè¢«åˆ—å…¥é»‘åå•ï¼Œå¯¼è‡´æ— æ³•è¿æ¥ã€‚å¦‚æœåœ¨å†…ç½‘ç¯å¢ƒï¼Œå¯ä»¥ç¡®è®¤æ²¡æœ‰å®‰å…¨é—®é¢˜å¯ä»¥æŠŠè¿™ä¸ªå€¼è®¾ç½®çš„å¤§ä¸€ç‚¹ï¼Œé»˜è®¤å€¼å¤ªå®¹æ˜“å¯¼è‡´é—®é¢˜ã€‚ LOGGINGæ¥ä¸‹æ¥çœ‹ä¸‹æ—¥å¿—çš„é…ç½®ï¼Œå¯¹äº MySQL æ¥è¯´ï¼Œæ…¢æ—¥å¿—å’Œ bin-log æ˜¯éå¸¸é‡è¦çš„ä¸¤ç§æ—¥å¿—ï¼Œå‰è€…å¯ä»¥å¸®åŠ©åº”ç”¨ç¨‹åºç›‘æ§æ€§èƒ½é—®é¢˜ï¼Œåè€…åœ¨æ•°æ®åŒæ­¥ã€å¤‡ä»½ç­‰æ–¹é¢å‘æŒ¥ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚ å…³äº bin-log çš„ 3 ä¸ªé…ç½®ï¼Œlog-binç”¨äºé…ç½®æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼Œexpire_logs_daysè®©æœåŠ¡å™¨åœ¨æŒ‡å®šå¤©æ•°ä¹‹åæ¸…ç†æ—§çš„æ—¥å¿—ï¼Œå³é…ç½®ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„æ—¥å¿—ã€‚é™¤éæœ‰è¿ç»´æ‰‹åŠ¨å¤‡ä»½æ¸…ç† bin-logï¼Œå¦åˆ™å¼ºçƒˆå»ºè®®æ‰“å¼€æ­¤é…ç½®ï¼Œå¦‚æœä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨ç©ºé—´æœ€ç»ˆå°†ä¼šè¢«è€—å°½ï¼Œå¯¼è‡´æœåŠ¡å™¨å¡ä½æˆ–è€…å´©æºƒã€‚ sync-binlogsync-binlogæ§åˆ¶å½“äº‹åŠ¡æäº¤ä¹‹åï¼ŒMySQL æ˜¯å¦å°† bin-log åˆ·æ–°åˆ°ç£ç›˜ã€‚å¦‚æœå…¶å€¼ç­‰äº 0 æˆ–è€…å¤§äº 1 æ—¶ï¼Œå½“äº‹åŠ¡æäº¤ä¹‹åï¼ŒMySQL ä¸ä¼šå°† bin-log åˆ·æ–°åˆ°ç£ç›˜ï¼Œå…¶æ€§èƒ½æœ€é«˜ï¼Œä½†å­˜åœ¨çš„é£é™©ä¹Ÿæ˜¯æœ€å¤§çš„ï¼Œå› ä¸ºä¸€æ—¦ç³»ç»Ÿå´©æºƒï¼Œbin-log å°†ä¼šä¸¢å¤±ã€‚è€Œå½“å…¶å€¼ç­‰äº 1 æ—¶ï¼Œæ˜¯æœ€å®‰å…¨çš„ï¼Œè¿™æ—¶å€™å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œæœ€å¤šä¹Ÿå°±ä¸¢å¤±æœ¬æ¬¡æœªå®Œæˆçš„äº‹åŠ¡ï¼Œå¯¹å®é™…çš„æ•°æ®æ²¡æœ‰å®è´¨æ€§çš„å½±å“ï¼Œä½†æ€§èƒ½è¾ƒå·®ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ 5.7.7 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªé€‰æ‹©çš„é»˜è®¤å€¼ä¸º 0ï¼Œè€Œä¹‹åçš„ç‰ˆæœ¬é»˜è®¤å€¼ä¸º 1ï¼Œä¹Ÿå°±æ˜¯æœ€å®‰å…¨çš„ç­–ç•¥ã€‚å¯¹äºé«˜å¹¶å‘çš„æ€§èƒ½ï¼Œéœ€è¦å…³æ³¨è¿™ä¸€ç‚¹ï¼Œé˜²æ­¢ç‰ˆæœ¬å‡çº§åå‡ºç°æ€§èƒ½é—®é¢˜ã€‚ å‰©ä¸‹çš„ 4 ä¸ªé…ç½®é¡¹å°±æ²¡å¤ªå¤šè¦è¯´çš„ã€‚ log-errorï¼šç”¨äºé…ç½®é”™è¯¯æ—¥å¿—çš„å­˜æ”¾ç›®å½• slow-query-logï¼šæ‰“å¼€æ…¢æ—¥å¿—ï¼Œé»˜è®¤å…³é—­ slow-query-log-fileï¼šé…ç½®æ…¢æ—¥å¿—çš„å­˜æ”¾ç›®å½• log-queries-not-using-indexesï¼šå¦‚æœè¯¥ sql æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œä¼šå°†å…¶å†™å…¥åˆ°æ…¢æ—¥å¿—ï¼Œä½†æ˜¯å¦çœŸçš„æ‰§è¡Œå¾ˆæ…¢ï¼Œéœ€è¦åŒºåˆ†ï¼Œé»˜è®¤å…³é—­ã€‚ CACHES AND LIMITStmp-table-size && max-heap-table-sizeè¿™ä¸¤ä¸ªé…ç½®æ§åˆ¶ä½¿ç”¨ Memory å¼•æ“çš„å†…å­˜ä¸´æ—¶è¡¨å¯ä»¥ä½¿ç”¨å¤šå¤§çš„å†…å­˜ã€‚å¦‚æœéšå¼å†…å­˜ä¸´æ—¶è¡¨çš„å¤§å°è¶…è¿‡è¿™ä¸¤ä¸ªå€¼ï¼Œå°†ä¼šè¢«è½¬ä¸ºç£ç›˜ MyISAM è¡¨ (éšå¼ä¸´æ—¶è¡¨ç”±æœåŠ¡å™¨åˆ›å»ºï¼Œç”¨æˆ·ä¿å­˜æ‰§è¡Œä¸­çš„æŸ¥è¯¢çš„ä¸­é—´ç»“æœ)ã€‚ å¦‚æœæŸ¥è¯¢è¯­å¥æ²¡æœ‰åˆ›å»ºåºå¤§çš„ä¸´æ—¶è¡¨ (é€šè¿‡åˆç†çš„ç´¢å¼•å’ŒæŸ¥è¯¢è®¾è®¡æ¥é¿å…)ï¼Œå¯ä»¥æŠŠè¿™ä¸ªå€¼è®¾å¤§ä¸€ç‚¹ï¼Œä»¥å…éœ€è¦æŠŠå†…å­˜ä¸´æ—¶è¡¨è½¬æ¢ä¸ºç£ç›˜ä¸´æ—¶è¡¨ã€‚ä½†è¦è°¨é˜²è¿™ä¸ªå€¼è®¾ç½®å¾—è¿‡å¤§ï¼Œå¦‚æœæŸ¥è¯¢ç¡®å®ä¼šåˆ›å»ºå¾ˆå¤§çš„ä¸´æ—¶è¡¨ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ç£ç›˜æ¯”è¾ƒå¥½ï¼Œæ¯•ç«Ÿå¹¶å‘æ•°ä¸€èµ·æ¥ï¼Œæ‰€éœ€è¦çš„å†…å­˜å°±ä¼šæ€¥å‰§å¢é•¿ã€‚ åº”è¯¥ç®€å•çš„æŠŠè¿™ä¸¤ä¸ªå˜é‡è®¾ä¸ºåŒæ ·çš„å€¼ï¼Œè¿™é‡Œé€‰æ‹©äº† 32Mï¼Œå¯ä»¥é€šè¿‡ä»”ç»†æ£€æŸ¥created-tmp-disk-tableså’Œcreated-tmp-tablesä¸¤ä¸ªå˜é‡æ¥æŒ‡å¯¼ä½ è®¾ç½®ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å€¼å°†å±•ç¤ºä¸´æ—¶è¡¨çš„åˆ›å»ºæœ‰å¤šé¢‘ç¹ã€‚ max-connections ç”¨äºè®¾ç½®ç”¨æˆ·çš„æœ€å¤§è¿æ¥æ•°ï¼Œä¿è¯æœåŠ¡å™¨ä¸ä¼šåº”ä¸ºåº”ç”¨ç¨‹åºæ¿€å¢çš„è¿æ¥è€Œä¸å ªé‡è´Ÿã€‚å¦‚æœåº”ç”¨ç¨‹åºæœ‰é—®é¢˜ï¼Œæˆ–è€…æœåŠ¡å™¨é‡åˆ°è¿æ¥å»¶è¿Ÿé—®é¢˜ï¼Œä¼šåˆ›å»ºå¾ˆå¤šæ–°è¿æ¥ã€‚ä½†å¦‚æœè¿™äº›è¿æ¥ä¸èƒ½æ‰§è¡ŒæŸ¥è¯¢ï¼Œé‚£æ‰“å¼€ä¸€ä¸ªè¿æ¥æ²¡ä»€ä¹ˆå¥½å¤„ï¼Œæ‰€ä»¥è¢« â€œå¤ªå¤šçš„è¿æ¥â€ é”™è¯¯æ‹’ç»æ˜¯ä¸€ç§å¿«é€Ÿè€Œä¸”ä»£ä»·å°çš„å¤±è´¥æ–¹å¼ã€‚ åœ¨æœåŠ¡å™¨èµ„æºå…è®¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æŠŠmax-connectionsè®¾ç½®çš„è¶³å¤Ÿå¤§ï¼Œä»¥å®¹çº³æ­£å¸¸å¯èƒ½è¾¾åˆ°çš„è´Ÿè½½ã€‚è‹¥è®¤ä¸ºæ­£å¸¸æƒ…å†µå°†æœ‰ 300 æˆ–è€…æ›´å¤šè¿æ¥ï¼Œå¯ä»¥è®¾ç½®ä¸º 500 æˆ–è€…æ›´å¤š (åº”å¯¹é«˜å³°æœŸ)ã€‚é»˜è®¤å€¼æ˜¯ 100ï¼Œå¤ªå°äº†ï¼Œè¿™é‡Œè®¾ç½®ä¸º 500ï¼Œä½†å¹¶ä¸æ„å‘³ç€å…¶æ˜¯ä¸€ä¸ªåˆç†çš„å€¼ï¼Œåº”è¯¥ç›‘æ§åº”ç”¨æœ‰å¤šå°‘è¿æ¥ï¼Œç„¶åæ ¹æ®ç›‘æ§å€¼ (è§‚å¯Ÿmax_used_connectionséšæ—¶é—´çš„å˜åŒ–) æ¥è®¾ç½®ã€‚ thread-cache-size çº¿ç¨‹ç¼“å­˜ä¿å­˜é‚£äº›å½“å‰æ²¡æœ‰ä¸è¿æ¥å…³è”ä½†æ˜¯å‡†å¤‡ä¸ºåé¢æ–°è¿æ¥æœåŠ¡çš„çº¿ç¨‹ã€‚å½“ä¸€ä¸ªæ–°çš„è¿æ¥åˆ›å»ºæ—¶ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰çº¿ç¨‹å­˜åœ¨ï¼ŒMySQL åˆ™ä»ç¼“å­˜ä¸­åˆ é™¤ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”æŠŠå®ƒåˆ†é…ç»™è¿™ä¸ªæ–°è¿æ¥ã€‚å½“è¿æ¥å…³é—­æ—¶ï¼Œå¦‚æœçº¿ç¨‹ç¼“å­˜è¿˜æœ‰ç©ºé—´çš„è¯ï¼ŒMySQL åˆä¼šæŠŠçº¿ç¨‹æ”¾å›ç¼“å­˜ã€‚å¦‚æœæ²¡æœ‰ç©ºé—´çš„è¯ï¼ŒMySQL ä¼šé”€æ¯è¿™ä¸ªçº¿ç¨‹ã€‚åªè¦ MySQL åœ¨ç¼“å­˜é‡Œè¿˜æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œå®ƒå°±å¯ä»¥è¿…é€Ÿå“åº”è¿æ¥è¯·æ±‚ï¼Œå› ä¸ºè¿™æ ·å°±ä¸ç”¨ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºæ–°çº¿ç¨‹ã€‚thread-cache-sizeæŒ‡å®š MySQL å¯ä»¥ä¿å­˜åœ¨ç¼“å­˜ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚å¦‚æœæœåŠ¡å™¨æ²¡æœ‰å¾ˆå¤šçš„è¿æ¥è¯·æ±‚ï¼Œä¸€èˆ¬ä¸éœ€è¦é…ç½®è¿™ä¸ªå€¼ã€‚ å¦‚ä½•åˆ¤æ–­è¿™ä¸ªå€¼è¯¥è®¾ç½®å¤šå¤§ï¼Ÿ è§‚å¯Ÿthreads-connectedå˜é‡ï¼Œå¦‚æœthreads-connectedåœ¨ 100-120ï¼Œé‚£ä¹ˆthread-cache-sizeè®¾ç½®ä¸º 20ã€‚å¦‚æœå®ƒä¿æŒåœ¨ 500-700ï¼Œ200 çš„çº¿ç¨‹ç¼“å­˜åº”è¯¥è¶³å¤Ÿå¤§äº†ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼šå½“åŒæ—¶æœ‰ 700 ä¸ªè¿æ¥æ—¶ï¼Œå¯èƒ½ç¼“å­˜ä¸­æ²¡æœ‰çº¿ç¨‹ã€‚åœ¨ 500 ä¸ªè¿æ¥æ—¶ï¼Œæœ‰ 200 ä¸ªç¼“å­˜çš„çº¿ç¨‹å‡†å¤‡ä¸ºè´Ÿè½½å†æ¬¡å¢åŠ åˆ° 700 ä¸ªè¿æ¥æ—¶ä½¿ç”¨ã€‚ open-files-limit åœ¨ç±» Uinux ç³»ç»Ÿä¸Šæˆ‘ä»¬æŠŠå®ƒè®¾ç½®å¾—å°½å¯èƒ½å¤§ã€‚ç°ä»£ OS ä¸­æ‰“å¼€å¥æŸ„å¼€é”€éƒ½å¾ˆå°ï¼Œå¦‚æœæ­¤å‚æ•°è®¾ç½®è¿‡å°ï¼Œå¯èƒ½ä¼šé‡åˆ° â€œæ‰“å¼€çš„æ–‡ä»¶å¤ªå¤š (too many open files)â€ é”™è¯¯ã€‚ table_cache_size è¡¨ç¼“å­˜è·Ÿçº¿ç¨‹ç¼“å­˜ç±»ä¼¼ï¼Œä½†å­˜å‚¨çš„å¯¹è±¡æ˜¯è¡¨ï¼Œå…¶åŒ…å«è¡¨. frm æ–‡ä»¶çš„è§£æç»“æœå’Œä¸€äº›å…¶ä»–æ•°æ®ã€‚å‡†ç¡®çš„è¯´ï¼Œç¼“å­˜çš„æ•°æ®ä¾èµ–äºå­˜å‚¨å¼•æ“ï¼Œæ¯”å¦‚ï¼Œå¯¹äº MyISAMï¼Œç¼“å­˜è¡¨çš„æ•°æ®å’Œç´¢å¼•çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¡¨ç¼“å­˜å¯¹ InnoDB çš„å­˜å‚¨å¼•æ“æ¥è¯´ï¼Œé‡è¦æ€§ä¼šå°å¾ˆå¤šï¼Œå› ä¸º InnoDB ä¸ä¾èµ–å®ƒæ¥åšé‚£ä¹ˆå¤šçš„äº‹ã€‚ ä» 5.1 ç‰ˆæœ¬åŠä»¥åï¼Œè¡¨ç¼“å­˜å°±è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ‰“å¼€è¡¨ç¼“å­˜å’Œå®šä¹‰è¡¨ç¼“å­˜ï¼Œåˆ†åˆ«é€šè¿‡table-open-cache-sizeå’Œtable-definition-cache-sizeå˜é‡æ¥é…ç½®ã€‚é€šå¸¸å¯ä»¥æŠŠtable-definition-cache-sizeè®¾ç½®å¾—è¶³å¤Ÿé«˜ï¼Œä»¥ç¼“å­˜æ‰€æœ‰çš„è¡¨å®šä¹‰ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å­˜å‚¨å¼•æ“éƒ½èƒ½ä»table-definition-cacheè·ç›Šã€‚ InnoDB InnoDB åº”è¯¥æ˜¯ä½¿ç”¨æœ€å¹¿å‘çš„å­˜å‚¨å¼•æ“ï¼Œæœ€é‡è¦çš„é…ç½®é€‰é¡¹æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªï¼šinnodb-buffer-pool-sizeä¸innodb-log-file-sizeï¼Œè§£å†³è¿™ä¸¤ä¸ªé…ç½®åŸºæœ¬ä¸Šå°±è§£å†³äº†çœŸå®åœºæ™¯ä¸‹çš„å¤§éƒ¨åˆ†é…ç½®é—®é¢˜ã€‚ innodb-buffer-pool-size å¦‚æœå¤§éƒ¨åˆ†æ˜¯ InnoDB è¡¨ï¼Œé‚£ä¹ˆ InnoDB ç¼“å†²æ± æˆ–è®¸æ¯”å…¶ä»–ä»»ä½•ä¸œè¥¿éƒ½æ›´éœ€è¦å†…å­˜ï¼ŒInnoDB ç¼“å†²æ± ç¼“å†²çš„æ•°æ®ï¼šç´¢å¼•ã€è¡Œæ•°æ®ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€æ’å…¥ç¼“å†²ã€é”ä»¥åŠå…¶ä»–å†…éƒ¨æ•°æ®ç»“æ„ã€‚InnoDB è¿˜ä½¿ç”¨ç¼“å†²æ± æ¥å¸®åŠ©å»¶è¿Ÿå†™å…¥ï¼Œè¿™æ ·å°±å¯ä»¥åˆå¹¶å¤šä¸ªå†™å…¥æ“ä½œï¼Œç„¶åä¸€èµ·é¡ºåºå†™å…¥ï¼Œæå‡æ€§èƒ½ã€‚æ€»ä¹‹ï¼ŒInnoDB ä¸¥é‡ä¾èµ–ç¼“å†²æ± ï¼Œå¿…é¡»ä¸ºå…¶åˆ†é…è¶³å¤Ÿçš„å†…å­˜ã€‚ å½“ç„¶ï¼Œå¦‚æœæ•°æ®é‡ä¸å¤§ä¸”ä¸ä¼šå¿«é€Ÿå¢é•¿ï¼Œå°±æ²¡æœ‰å¿…è¦ä¸ºç¼“å†²æ± åˆ†é…è¿‡å¤šçš„å†…å­˜ï¼ŒæŠŠç¼“å†²æ± é…ç½®å¾—æ¯”éœ€è¦ç¼“å­˜çš„è¡¨å’Œç´¢å¼•è¿˜è¦å¤§å¾ˆå¤šï¼Œå®é™…ä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚å¾ˆå¤§çš„ç¼“å†²æ± ä¹Ÿä¼šå¸¦æ¥ä¸€äº›æŒ‘æˆ˜ï¼Œä¾‹å¦‚ï¼Œé¢„çƒ­å’Œå…³é—­éƒ½ä¼šèŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚å¦‚æœæœ‰å¾ˆå¤šè„é¡µåœ¨ç¼“å†²æ± é‡Œï¼ŒInnoDB å…³é—­æ—¶å¯èƒ½ä¼šèŠ±å¾ˆé•¿æ—¶é—´æ¥æŠŠè„é¡µå†™å›æ•°æ®æ–‡ä»¶ã€‚è™½ç„¶å¯ä»¥å¿«é€Ÿå…³é—­ï¼Œä½†æ˜¯åœ¨å¯åŠ¨æ—¶éœ€è¦åšæ›´å¤šçš„æ¢å¤å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•åŒæ—¶åŠ é€Ÿå…³é—­å’Œé‡å¯ä¸¤ä¸ªæ“ä½œã€‚å½“æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼“å†²æ± ï¼Œé‡å¯æœåŠ¡éœ€è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼ˆå‡ å°æ—¶æˆ–è€…å‡ å¤©ï¼‰æ¥é¢„çƒ­ï¼Œå°¤å…¶æ˜¯ç£ç›˜å¾ˆæ…¢çš„æ—¶å€™ï¼Œå¦‚æœæƒ³åŠ å¿«é¢„çƒ­æ—¶é—´ï¼Œå¯ä»¥åœ¨é‡å¯åç«‹åˆ»è¿›è¡Œå…¨è¡¨æ‰«ææˆ–è€…ç´¢å¼•æ‰«æï¼ŒæŠŠç´¢å¼•è½½å…¥ç¼“å†²æ± ã€‚ å¯ä»¥çœ‹åˆ°ç¤ºä¾‹çš„é…ç½®æ–‡ä»¶ä¸­æŠŠè¿™ä¸ªå€¼é…ç½®ä¸º 12Gï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†é…ç½®ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„ç¡¬ä»¶æ¥ä¼°ç®—ã€‚é‚£å¦‚ä½•ä¼°ç®—ï¼Ÿ å‰é¢çš„å°èŠ‚ï¼Œæˆ‘ä»¬è¯´åˆ°ï¼ŒMySQL ä¸­æœ€é‡è¦çš„ç¼“å­˜æœ‰ 5 ç§ï¼Œå¯ä»¥ç®€å•çš„ä½¿ç”¨ä¸‹é¢çš„å…¬å¼è®¡ç®—ï¼š InnoDB ç¼“å†²æ±  = æœåŠ¡å™¨æ€»å†…å­˜ - OS é¢„ç•™ - æœåŠ¡å™¨ä¸Šçš„å…¶ä»–åº”ç”¨å ç”¨å†…å­˜ - MySQL è‡ªèº«éœ€è¦çš„å†…å­˜ - InnoDB æ—¥å¿—æ–‡ä»¶å ç”¨å†…å­˜ - å…¶å®ƒå†…å­˜ (MyISAM é”®ç¼“å­˜ã€æŸ¥è¯¢ç¼“å­˜ç­‰) å…·ä½“æ¥çœ‹ï¼Œè‡³å°‘éœ€è¦ä¸º OS ä¿ç•™ 1~2G å†…å­˜ï¼Œå¦‚æœæœºå™¨å†…å­˜å¤§çš„è¯å¯ä»¥é¢„ç•™å¤šä¸€äº›ï¼Œå»ºè®® 2GB å’Œæ€»å†…å­˜çš„ 5% ä¸ºåŸºå‡†ï¼Œä»¥è¾ƒå¤§è€…ä¸ºå‡†ï¼Œå¦‚æœæœºå™¨ä¸Šè¿˜è¿è¡Œç€ä¸€äº›å†…å­˜å¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼Œå¤‡ä»½ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ä¸º OS å†é¢„ç•™å¤šä¸€äº›å†…å­˜ã€‚ä¸è¦ä¸º OS ç¼“å­˜å¢åŠ ä»»ä½•å†…å­˜ï¼Œå› ä¸º OS é€šå¸¸ä¼šåˆ©ç”¨æ‰€æœ‰å‰©ä¸‹çš„å†…å­˜æ¥åšæ–‡ä»¶ç¼“å­˜ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œè¿è¡Œ MySQL çš„æœåŠ¡å™¨å¾ˆå°‘ä¼šè¿è¡Œå…¶ä»–åº”ç”¨ç¨‹åºï¼Œä½†å¦‚æœæœ‰çš„è¯ï¼Œè¯·ä¸ºè¿™äº›åº”ç”¨ç¨‹åºé¢„ç•™è¶³å¤Ÿå¤šçš„å†…å­˜ã€‚ MySQL è‡ªèº«è¿è¡Œè¿˜éœ€è¦ä¸€äº›å†…å­˜ï¼Œä½†é€šå¸¸éƒ½ä¸ä¼šå¤ªå¤§ã€‚éœ€è¦è€ƒè™‘ MySQL æ¯ä¸ªè¿æ¥éœ€è¦çš„å†…å­˜ï¼Œè™½ç„¶æ¯ä¸ªè¿æ¥éœ€è¦çš„å†…å­˜éƒ½å¾ˆå°‘ï¼Œä½†å®ƒè¿˜è¦æ±‚ä¸€ä¸ªåŸºæœ¬é‡çš„å†…å­˜æ¥æ‰§è¡Œä»»ä½•ç»™å®šçš„æŸ¥è¯¢ï¼Œè€Œä¸”æŸ¥è¯¢è¿‡ç¨‹ä¸­è¿˜éœ€è¦ä¸ºæ’åºã€GROUP BY ç­‰æ“ä½œåˆ†é…ä¸´æ—¶è¡¨å†…å­˜ï¼Œå› æ­¤éœ€è¦ä¸ºé«˜å³°æœŸæ‰§è¡Œå¤§é‡çš„æŸ¥è¯¢é¢„ç•™è¶³å¤Ÿçš„å†…å­˜ã€‚è¿™ä¸ªå†…å­˜æœ‰å¤šå¤§ï¼Ÿåªèƒ½åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç›‘æ§ã€‚ å¦‚æœå¤§éƒ¨åˆ†è¡¨éƒ½æ˜¯ InnoDBï¼ŒMyISAM é”®ç¼“å­˜é…ç½®ä¸€ä¸ªå¾ˆå°å€¼è¶³çŸ£ï¼ŒæŸ¥è¯¢ç¼“å­˜ä¹Ÿå»ºè®®å…³é—­ã€‚ å…¬å¼ä¸­å°±å‰©ä¸‹ InnoDB æ—¥å¿—æ–‡ä»¶äº†ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è¯´çš„ã€‚ innodb-log-file-size && innodb-log-files-in-group å¦‚æœå¯¹ InnoDB æ•°æ®è¡¨æœ‰å¤§é‡çš„å†™å…¥æ“ä½œï¼Œé‚£ä¹ˆé€‰æ‹©åˆé€‚çš„innodb-log-file-sizeå€¼å¯¹æå‡ MySQL æ€§èƒ½å¾ˆé‡è¦ã€‚InnoDB ä½¿ç”¨æ—¥å¿—æ¥å‡å°‘æäº¤äº‹åŠ¡æ—¶çš„å¼€é”€ã€‚æ—¥å¿—ä¸­è®°å½•äº†äº‹åŠ¡ï¼Œå°±æ— é¡»åœ¨æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶æŠŠç¼“å†²æ± çš„è„å— (ç¼“å­˜ä¸­ä¸ç£ç›˜ä¸Šæ•°æ®ä¸ä¸€è‡´çš„é¡µ) åˆ·æ–°åˆ°ç£ç›˜ã€‚äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®å’Œç´¢å¼•é€šå¸¸ä¼šæ˜ å°„åˆ°è¡¨ç©ºé—´çš„éšæœºä½ç½®ï¼Œæ‰€ä»¥åˆ·æ–°è¿™äº›å˜æ›´åˆ°ç£ç›˜éœ€è¦å¾ˆå¤šéšæœº I/Oã€‚ä¸€æ—¦æ—¥å¿—å®‰å…¨çš„å†™å…¥ç£ç›˜ï¼Œäº‹åŠ¡å°±æŒä¹…åŒ–äº†ï¼Œå³ä½¿å˜æ›´è¿˜æ²¡æœ‰å†™åˆ°æ•°æ®æ–‡ä»¶ï¼Œåœ¨ä¸€äº›æ„å¤–æƒ…å†µå‘ç”Ÿæ—¶ (æ¯”å¦‚æ–­ç”µäº†)ï¼ŒInnoDB å¯ä»¥é‡æ”¾æ—¥å¿—å¹¶ä¸”æ¢å¤å·²ç»æäº¤çš„äº‹åŠ¡ã€‚ InnoDB ä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹æ™ºèƒ½åœ°åˆ·æ–°è¿™äº›å˜æ›´åˆ°æ•°æ®æ–‡ä»¶ã€‚å®é™…ä¸Šï¼Œäº‹åŠ¡æ—¥å¿—æŠŠæ•°æ®æ–‡ä»¶çš„éšæœº I/O è½¬æ¢ä¸ºå‡ ä¹é¡ºåºåœ°æ—¥å¿—æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶ I/Oï¼Œè®©åˆ·æ–°æ“ä½œåœ¨åå°å¯ä»¥æ›´å¿«çš„å®Œæˆï¼Œå¹¶ä¸”ç¼“å­˜ I/O å‹åŠ›ã€‚ æ•´ä½“çš„æ—¥å¿—æ–‡ä»¶å¤§å°å—æ§äºinnodb-log-file-sizeå’Œinnodb-log-files-in-groupä¸¤ä¸ªå‚æ•°ï¼Œè¿™å¯¹å†™æ€§èƒ½éå¸¸é‡è¦ã€‚æ—¥å¿—æ–‡ä»¶çš„æ€»å¤§å°æ˜¯æ¯ä¸ªæ–‡ä»¶çš„å¤§å°ä¹‹å’Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ª 5M çš„æ–‡ä»¶ï¼Œæ€»å…± 10Mï¼Œå¯¹é«˜æ€§èƒ½å·¥ä½œæ¥è¯´å¤ªå°äº†ï¼Œè‡³å°‘éœ€è¦å‡ ç™¾ M æˆ–è€…ä¸Š G çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™é‡Œè¦æ³¨æ„innodb-log-files-in-groupè¿™ä¸ªå‚æ•°ï¼Œå®ƒæ§åˆ¶æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼Œä»åå­—ä¸Šçœ‹å¥½ä¼¼é…ç½®ä¸€ä¸ªæ—¥å¿—ç»„æœ‰å‡ ä¸ªæ–‡ä»¶ï¼Œå®é™…ä¸Šï¼Œlog groupè¡¨ç¤ºä¸€ä¸ªé‡åšæ—¥å¿—çš„æ–‡ä»¶é›†åˆï¼Œæ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰å¿…è¦é…ç½®æœ‰å¤šå°‘ä¸ªæ—¥å¿—ç»„ã€‚ ä¿®æ”¹æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œéœ€è¦å®Œå…¨å…³é—­ MySQLï¼Œç„¶åå°†æ—§çš„æ—¥å¿—æ–‡ä»¶è¿ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œé‡æ–°é…ç½®å‚æ•°ï¼Œç„¶åé‡å¯ã€‚é‡å¯æ—¶éœ€è¦å°†æ—§çš„æ—¥å¿—è¿ç§»å›æ¥ï¼Œç„¶åç­‰å¾… MySQL æ¢å¤æ•°æ®åï¼Œå†åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œè¯·ä¸€å®šè¦æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¡®è®¤ MySQL é‡å¯æˆåŠŸåå†åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ã€‚ æƒ³è¦ç¡®å®šç†æƒ³çš„æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œéœ€è¦æƒè¡¡æ­£å¸¸æ•°æ®å˜æ›´çš„å¼€é”€ï¼Œä»¥åŠå´©æºƒæ—¶æ¢å¤éœ€è¦çš„æ—¶é—´ã€‚å¦‚æœæ—¥å¿—å¤ªå°ï¼ŒInnoDB å°†å¿…é¡»è¦åšæ›´å¤šçš„æ£€æŸ¥ç‚¹ï¼Œå¯¼è‡´æ›´å¤šçš„æ—¥å¿—å†™ï¼Œåœ¨æä¸ªåˆ«æƒ…å†µä¸‹ï¼Œå†™è¯­å¥è¿˜ä¼šè¢«æ‹–ç´¯ï¼Œåœ¨æ—¥å¿—æ²¡æœ‰ç©ºé—´ç»§ç»­å†™å…¥å‰ï¼Œå¿…é¡»ç­‰å¾…å˜æ›´è¢«åˆ·æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ—¥å¿—å¤ªå¤§ï¼Œåœ¨å´©æºƒæ—¶æ¢å¤å°±å¾—åšå¤§é‡çš„å·¥ä½œï¼Œè¿™å¯èƒ½å¢å¤§æ¢å¤æ—¶é—´ã€‚InnoDB ä¼šé‡‡ç”¨ checkpoint æœºåˆ¶æ¥åˆ·æ–°å’Œæ¢å¤æ•°æ®ï¼Œè¿™ä¼šåŠ å¿«æ¢å¤æ•°æ®çš„æ—¶é—´ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š MySQL-checkpoint æŠ€æœ¯ How InnoDB performs a checkpoint innodb-flush-log-at-trx-commit å‰é¢è®¨è®ºäº†å¾ˆå¤šç¼“å­˜ï¼ŒInnoDB æ—¥å¿—ä¹Ÿæ˜¯æœ‰ç¼“å­˜çš„ã€‚å½“ InnoDB å˜æ›´ä»»ä½•æ•°æ®æ—¶ï¼Œä¼šå†™ä¸€æ¡å˜æ›´è®°å½•åˆ°æ—¥å¿—ç¼“å­˜åŒºã€‚åœ¨ç¼“å†²æ…¢çš„æ—¶å€™ã€äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œæˆ–è€…æ¯ä¸€ç§’é’Ÿï¼ŒInnoDB éƒ½ä¼šå°†ç¼“å†²åŒºçš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœæœ‰å¤§äº‹åŠ¡ï¼Œå¢åŠ æ—¥å¿—ç¼“å†²åŒºå¤§å°å¯ä»¥å¸®åŠ©å‡å°‘ I/Oï¼Œå˜é‡innodb-log-buffer-sizeå¯ä»¥æ§åˆ¶æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°ã€‚é€šå¸¸ä¸éœ€è¦æŠŠæ—¥å¿—ç¼“å†²åŒºè®¾ç½®çš„éå¸¸å¤§ï¼Œæ¯•ç«Ÿä¸Šè¿° 3 ä¸ªæ¡ä»¶ï¼Œä»»ä¸€æ¡ä»¶å…ˆè§¦å‘éƒ½ä¼šæŠŠç¼“å†²åŒºçš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ‰€ä»¥ç¼“å†²åŒºçš„æ•°æ®è‚¯å®šä¸ä¼šå¤ªå¤šï¼Œå‡ºå…¥ä½ çš„æ•°æ®ä¸­æœ‰å¾ˆå¤šç›¸å½“å¤§çš„ BLOB è®°å½•ã€‚é€šå¸¸æ¥è¯´ï¼Œé…ç½® 1M~8M å³å¯ã€‚ æ—¢ç„¶å­˜åœ¨ç¼“å†²åŒºï¼Œæ€æ ·åˆ·æ–°æ—¥å¿—ç¼“å†²å°±æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚æ—¥å¿—ç¼“å†²å¿…é¡»åˆ·æ–°åˆ°ç£ç›˜ï¼Œä»¥ç¡®ä¿æäº¤çš„äº‹åŠ¡å®Œå…¨è¢«æŒä¹…åŒ–ã€‚å¦‚æœå’ŒæŒä¹…åŒ–ç›¸æ¯”ï¼Œæ›´åœ¨ä¹æ€§èƒ½ï¼Œå¯ä»¥ä¿®æ”¹ innodb-flush-log-at-trx-commit å˜é‡æ¥æ§åˆ¶æ—¥å¿—ç¼“å†²åˆ·æ–°çš„é¢‘ç‡ã€‚ 0ï¼šæ¯ 1 ç§’é’Ÿå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶å¹¶åˆ·æ–°åˆ°ç£ç›˜ï¼Œäº‹åŠ¡æäº¤æ—¶ä¸åšä»»ä½•å¤„ç† 1ï¼šæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶å¹¶åˆ·æ–°åˆ°ç£ç›˜ 2ï¼šæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œå°†æ—¥å¿—ç¼“å†²å†™åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åæ¯ç§’åˆ·æ–°ä¸€æ¬¡åˆ°ç£ç›˜ 1 æ˜¯æœ€å®‰å…¨çš„è®¾ç½®ï¼Œä¿è¯ä¸ä¼šä¸¢å¤±ä»»ä½•å·²ç»æäº¤çš„äº‹åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„è®¾ç½®ã€‚ 0 å’Œ 2 æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œå¦‚æœ MySQL æŒ‚äº†ï¼Œ2 ä¸ä¼šä¸¢å¤±äº‹åŠ¡ï¼Œä½† 0 æœ‰å¯èƒ½ï¼Œ 2 åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ï¼Œè‡³å°‘å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œè€Œ 0 åˆ™ä¸ä¼šã€‚å¦‚æœæ•´ä¸ªæœåŠ¡å™¨æŒ‚äº†æˆ–è€…æ–­ç”µäº†ï¼Œåˆ™è¿˜æ˜¯å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›äº‹åŠ¡ã€‚ innodb-flush-method å‰é¢éƒ½åœ¨è®¨è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„ç­–ç•¥åˆ·æ–°ã€ä»¥åŠä½•æ—¶åˆ·æ–°æ—¥å¿—æˆ–è€…æ•°æ®ï¼Œé‚£ InnoDB å…·ä½“æ˜¯æ€æ ·åˆ·æ–°æ•°æ®çš„ï¼Ÿä½¿ç”¨innodb-flush-methodé€‰é¡¹å¯ä»¥é…ç½® InnoDB å¦‚ä½•è·Ÿæ–‡ä»¶ç³»ç»Ÿç›¸äº’ä½œç”¨ã€‚ä»åå­—ä¸Šçœ‹ï¼Œä¼šä»¥ä¸ºåªèƒ½å½±å“ InnoDB æ€ä¹ˆå†™æ•°æ®ï¼Œå®é™…ä¸Šè¿˜å½±å“äº† InnoDB Windows å’Œé Windows æ“ä½œç³»ç»Ÿä¸‹è¿™ä¸ªé€‰é¡¹çš„å€¼æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº›å€¼åªèƒ½ Windows ä¸‹ä½¿ç”¨ï¼Œæœ‰äº›åªèƒ½åœ¨é Windows ä¸‹ä½¿ç”¨ï¼Œå…¶ä¸­ Windows ä¸‹å¯å–å€¼ï¼šasync_unbufferedã€unbufferedã€normalã€Nosyncä¸littlesyncï¼Œé Windows å–å€¼ï¼šfdatasyncã€0_DIRECTã€ 0_DSYNCã€‚ è¿™ä¸ªé€‰é¡¹æ—¢ä¼šå½±å“æ—¥å¿—æ–‡ä»¶ï¼Œä¹Ÿä¼šå½±å“æ•°æ®æ–‡ä»¶ï¼Œè€Œä¸”æœ‰æ—¶å€™å¯¹ä¸åŒç±»å‹çš„æ–‡ä»¶çš„å¤„ç†ä¹Ÿä¸ä¸€æ ·ï¼Œå¯¼è‡´è¿™ä¸ªé€‰é¡¹æœ‰äº›éš¾ä»¥ç†è§£ã€‚å¦‚æœæœ‰ä¸€ä¸ªé€‰é¡¹æ¥é…ç½®æ—¥å¿—æ–‡ä»¶ï¼Œä¸€ä¸ªé€‰é¡¹æ¥é…ç½®æ•°æ®æ–‡ä»¶ï¼Œåº”è¯¥ä¼šæ›´å¥½ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ··åˆåœ¨åŒä¸€ä¸ªé…ç½®é¡¹ä¸­ã€‚è¿™é‡Œåªä»‹ç»ç±» Unix æ“ä½œç³»ç»Ÿä¸‹çš„é€‰é¡¹ã€‚ fdatasync InnoDB è°ƒç”¨fsync()å’Œfdatasync()å‡½æ•°æ¥åˆ·æ–°æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶ï¼Œå…¶ä¸­fdatasync()åªåˆ·æ–‡ä»¶çš„æ•°æ®ï¼Œä½†ä¸åŒ…å«å…ƒæ•°æ® (æ¯”å¦‚ï¼šè®¿é—®æƒé™ã€æ–‡ä»¶æ‹¥æœ‰è€…ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰æè¿°æ–‡ä»¶ç‰¹å¾çš„ç³»ç»Ÿæ•°æ®)ï¼Œå› æ­¤fsync()ç›¸æ¯”fdatasync()ä¼šäº§ç”Ÿæ›´å¤šçš„ I/Oï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹fdatasync()ä¼šå¯¼è‡´æ•°æ®æŸåï¼Œå› æ­¤ InnoDB å¼€å‘è€…å†³å®šç”¨fsync()æ¥ä»£æ›¿fdatasync()ã€‚ fsync()çš„ç¼ºç‚¹æ˜¯æ“ä½œç³»ç»Ÿä¼šåœ¨è‡ªå·±çš„ç¼“å­˜ä¸­ç¼“å†²ä¸€äº›æ•°æ®ï¼Œç†è®ºä¸ŠåŒé‡ç¼“å†²æ˜¯æµªè´¹çš„ï¼Œå› ä¸º InnoDB è‡ªå·±ä¼šç®¡ç†ç¼“å†²ï¼Œè€Œä¸”æ¯”æ“ä½œç³»ç»Ÿæ›´åŠ æ™ºèƒ½ã€‚ä½†å¦‚æœæ–‡ä»¶ç³»ç»Ÿèƒ½æœ‰æ›´æ™ºèƒ½çš„ I/O è°ƒåº¦å’Œæ‰¹é‡æ“ä½œï¼ŒåŒé‡ç¼“å†²ä¹Ÿå¹¶ä¸ä¸€å®šæ˜¯åäº‹ï¼š æœ‰çš„æ–‡ä»¶ç³»ç»Ÿå’Œ os å¯ä»¥ç´¯ç§¯å†™æ“ä½œååˆå¹¶æ‰§è¡Œï¼Œé€šè¿‡å¯¹ I/O çš„é‡æ’åºæ¥æå‡æ•ˆç‡ã€æˆ–è€…å¹¶å‘å†™å…¥å¤šä¸ªè®¾å¤‡ æœ‰çš„è¿˜å¯ä»¥åšé¢„è¯»ä¼˜åŒ–ï¼Œæ¯”å¦‚è¿ç»­è¯·æ±‚å‡ ä¸ªé¡ºåºçš„å—ï¼Œå®ƒä¼šé€šçŸ¥ç¡¬ç›˜é¢„è¯»ä¸‹ä¸€ä¸ªå— è¿™äº›ä¼˜åŒ–åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹æ‰ä¼šèµ·ä½œç”¨ï¼Œfdatasyncä¸ºinnodb-flush-methodçš„é»˜è®¤å€¼ã€‚ 0_DIRCET è¿™ä¸ªè®¾ç½®ä¸å½±å“æ—¥å¿—æ–‡ä»¶å¹¶ä¸”ä¸æ˜¯æ‰€æœ‰çš„ç±» Unix ç³»ç»Ÿéƒ½æœ‰æ•ˆï¼Œä½†è‡³å°‘åœ¨ Linuxã€FreeBSD ä»¥åŠ Solaris æ˜¯æ”¯æŒçš„ã€‚è¿™ä¸ªè®¾ç½®ä¾ç„¶ä½¿ç”¨ fsync æ¥åˆ·æ–°æ–‡ä»¶åˆ°ç£ç›˜ï¼Œä½†æ˜¯å®ƒå®Œå…¨å…³é—­äº†æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œå¹¶ä¸”æ˜¯æ‰€æœ‰çš„è¯»å’Œå†™éƒ½ç›´æ¥é€šè¿‡å­˜å‚¨è®¾ç½®ï¼Œé¿å…äº†åŒé‡ç¼“å†²ã€‚å¦‚æœå­˜å‚¨è®¾å¤‡æ”¯æŒå†™ç¼“å†²æˆ–é¢„è¯»ï¼Œé‚£ä¹ˆè¿™ä¸ªé€‰é¡¹å¹¶ä¸ä¼šå½±å“åˆ°è®¾å¤‡çš„è®¾ç½®ï¼Œæ¯”å¦‚ RAID å¡ã€‚ 0_DSYNC è¿™ä¸ªé€‰é¡¹ä½¿å¾—æ‰€æœ‰çš„å†™åŒæ­¥ï¼Œå³åªæœ‰æ•°æ®å†™åˆ°ç£ç›˜åå†™æ“ä½œæ‰è¿”å›ï¼Œä½†å®ƒåªå½±å“æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸å½±å“æ•°æ®æ–‡ä»¶ã€‚ è¯´å®Œäº†æ¯ä¸ªé…ç½®çš„ä½œç”¨ï¼Œæœ€åæ˜¯ä¸€äº›å»ºè®®ï¼šå¦‚æœä½¿ç”¨ç±» Unix æ“ä½œç³»ç»Ÿå¹¶ä¸” RAID æ§åˆ¶å™¨å¸¦æœ‰ç”µæ± ä¿æŠ¤çš„å†™ç¼“å­˜ï¼Œå»ºè®®ä½¿ç”¨ 0_DIRECTï¼Œå¦‚æœä¸æ˜¯ï¼Œé»˜è®¤å€¼æˆ–è€… 0_DIRECT éƒ½å¯èƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ innodb-file-per-table æœ€åä¸€ä¸ªé…ç½®ï¼Œè¯´è¯´ InnoDB è¡¨ç©ºé—´ï¼ŒInnoDB æŠŠæ•°æ®ä¿å­˜åœ¨è¡¨ç©ºé—´å†…ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªç£ç›˜æ–‡ä»¶ç»„æˆçš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚InnoDB è¡¨ç©ºé—´å¹¶ä¸åªæ˜¯å­˜å‚¨è¡¨å’Œç´¢å¼•ï¼Œå®ƒè¿˜ä¿å­˜äº†å›æ»šæ—¥å¿—ã€æ’å…¥ç¼“å†²ã€åŒå†™ç¼“å†²ä»¥åŠå…¶ä»–å†…éƒ¨æ•°æ®ç»“æ„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¡¨ç©ºé—´è¿˜å®ç°äº†å¾ˆå¤šå…¶å®ƒçš„åŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡ innodb-data-file-path é…ç½®é¡¹å®šåˆ¶è¡¨ç©ºé—´æ–‡ä»¶ï¼Œinnodb-data-home-diré…ç½®è¡¨ç©ºé—´æ–‡ä»¶å­˜æ”¾çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š12innodb-data-home-dir = /var/lib/mysqlinnodb-data-file-path = ibdata1:1G;ibdata2:1G;ibdata3:1G è¿™é‡Œåœ¨ 3 ä¸ªæ–‡ä»¶ä¸­åˆ›å»ºäº† 3G è¡¨ç©ºé—´ï¼Œä¸ºäº†å…è®¸è¡¨ç©ºé—´åœ¨è¶…è¿‡äº†åˆ†é…çš„ç©ºé—´æ—¶è¿˜èƒ½å¢é•¿ï¼Œå¯ä»¥åƒè¿™æ ·é…ç½®æœ€åä¸€ä¸ªæ–‡ä»¶è‡ªåŠ¨æ‰©å±•1innodb-data-file-path = ibdata1:1G;ibdata2:1G;ibdata3:1G:autoextend innodb-file-per-tableé€‰é¡¹è®© InnoDB ä¸ºæ¯å¼ è¡¨ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä½¿å¾—åœ¨åˆ é™¤ä¸€å¼ è¡¨æ—¶å›æ”¶ç©ºé—´å®¹æ˜“å¾ˆå¤šï¼Œè€Œä¸”ç‰¹åˆ«å®¹æ˜“ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡ä»¶å¤§å°æ¥ç¡®å®šè¡¨å¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®æ‰“å¼€è¿™ä¸ªé…ç½®ã€‚ æ€»ç»“MySQL æœ‰å¤ªå¤šçš„é…ç½®é¡¹ï¼Œè¿™é‡Œæ²¡æœ‰åŠæ³•ä¸€ä¸€åˆ—ä¸¾ï¼Œé‡è¦çš„æ˜¯äº†è§£æ¯ä¸ªé…ç½®çš„å·¥ä½œåŸç†ï¼Œä»ä¸€ä¸ªåŸºç¡€é…ç½®æ–‡ä»¶å¼€å§‹ï¼Œè®¾ç½®ç¬¦åˆæœåŠ¡å™¨è½¯ç¡¬ä»¶ç¯å¢ƒä¸å·¥ä½œè´Ÿè½½çš„åŸºæœ¬é€‰é¡¹ã€‚ å‚è€ƒèµ„æ–™é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL ä¼˜åŒ–åŸç†(äºŒ)]]></title>
    <url>%2F2019%2F03%2F29%2Fmysql-optimization-principle-2%2F</url>
    <content type="text"><![CDATA[æˆ‘æ‰“ä½ åº”è¯¥ï¼Œä¸æ‰“ä½ æ‚²å“€~ å‰è¨€å¦‚æœæœ‰åŒå­¦çœ‹å®Œä¸Šä¸€ç¯‡å…³äº MySQL æ–‡ç« ï¼Œæ–‡æœ«ç•™æœ‰ä¸¤ä¸ªå¾ˆå¼€æ”¾çš„é—®é¢˜ï¼Œå¦‚æœ‰å…´è¶£å¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ã€‚æœ¬æ–‡ä¹Ÿä¼šè¯•ç€å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå¸Œæœ›èƒ½ç»™ä½ ä¸€äº›å‚è€ƒã€‚ç°åœ¨å¯ä»¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡éå¸¸å¤§çš„æƒ…å†µä¸‹ï¼Œæ‚¨æ ¹æ®ä¸šåŠ¡é€‰æ‹©äº†åˆé€‚çš„å­—æ®µï¼Œç²¾å¿ƒè®¾è®¡äº†è¡¨å’Œç´¢å¼•ï¼Œè¿˜ä»”ç»†çš„æ£€æŸ¥äº†æ‰€æœ‰çš„ SQLï¼Œå¹¶ç¡®è®¤å·²ç»æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ€§èƒ½ä»ç„¶ä¸èƒ½æ»¡è¶³æ‚¨çš„è¦æ±‚ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿˜æœ‰å…¶ä»–ä¼˜åŒ–ç­–ç•¥å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¥ä¸‹æ¥ç»§ç»­å’Œæ‚¨è®¨è®ºä¸€äº›å¸¸ç”¨çš„ MySQL é«˜çº§ç‰¹æ€§ä»¥åŠå…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚ åˆ†åŒºè¡¨åˆç†çš„ä½¿ç”¨ç´¢å¼•å¯ä»¥æå¤§æå‡ MySQL çš„æŸ¥è¯¢æ€§èƒ½ï¼Œä½†å¦‚æœå•è¡¨æ•°æ®é‡è¾¾åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œç´¢å¼•å°±æ— æ³•èµ·ä½œç”¨ï¼Œå› ä¸ºåœ¨æ•°æ®é‡è¶…å¤§çš„æƒ…å†µä¸‹ï¼Œé™¤éè¦†ç›–ç´¢å¼•ï¼Œå› å›è¡¨æŸ¥è¯¢ä¼šäº§ç”Ÿå¤§é‡çš„éšæœº I/Oï¼Œæ•°æ®åº“çš„å“åº”æ—¶é—´å¯èƒ½ä¼šè¾¾åˆ°ä¸å¯æ¥å—çš„ç¨‹åº¦ã€‚è€Œä¸”ç´¢å¼•ç»´æŠ¤ï¼ˆç£ç›˜ç©ºé—´ã€I/O æ“ä½œï¼‰çš„ä»£ä»·ä¹Ÿä¼šéå¸¸å¤§ã€‚ å› æ­¤ï¼Œå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼ˆåœ¨ MySQL4.x æ—¶ä»£ï¼ŒMyISAM å­˜å‚¨å¼•æ“ä¸šå†…å…¬è®¤çš„æ€§èƒ½æ‹ç‚¹æ˜¯ 500W è¡Œï¼ŒMySQL5.x æ—¶ä»£çš„æ€§èƒ½æ‹ç‚¹åˆ™ä¸º 1KW ~ 2KW è¡Œçº§åˆ«ï¼Œå…·ä½“éœ€æ ¹æ®å®é™…æƒ…å†µæµ‹è¯•ï¼‰ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œæœ€ä¸ºå¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯åˆ†è¡¨ã€‚åˆ†è¡¨çš„ç­–ç•¥å¯ä»¥æ˜¯å‚ç›´æ‹†åˆ†ï¼ˆæ¯”å¦‚ï¼šä¸åŒè®¢å•çŠ¶æ€çš„è®¢å•æ‹†åˆ†åˆ°ä¸åŒçš„è¡¨ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ°´å¹³æ‹†åˆ†ï¼ˆæ¯”å¦‚ï¼šæŒ‰æœˆå°†è®¢å•æ‹†åˆ†åˆ°ä¸åŒè¡¨ï¼‰ã€‚ä½†æ€»çš„æ¥è¯´ï¼Œåˆ†è¡¨å¯ä»¥çœ‹ä½œæ˜¯ä»ä¸šåŠ¡è§’åº¦æ¥è§£å†³å¤§æ•°æ®é‡é—®é¢˜ï¼Œå®ƒåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æå‡æ€§èƒ½ï¼Œä½†ä¹Ÿå¤§å¤§æå‡äº†ç¼–ç çš„å¤æ‚åº¦ï¼Œæœ‰è¿‡è¿™ç§ç»å†çš„åŒå­¦å¯èƒ½æ·±æœ‰ä½“ä¼šã€‚ åœ¨ä¸šåŠ¡å±‚åˆ†è¡¨å¤§å¤§å¢åŠ äº†ç¼–ç çš„å¤æ‚ç¨‹åº¦ï¼Œè€Œä¸”å¤„ç†æ•°æ®åº“çš„ç›¸å…³ä»£ç ä¼šå¤§é‡æ•£è½åœ¨åº”ç”¨å„å¤„ï¼Œç»´æŠ¤å›°éš¾ã€‚é‚£æ˜¯å¦å¯ä»¥å°†åˆ†è¡¨çš„é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼Œç»Ÿä¸€å¤„ç†ï¼Œè¿™æ ·ä¸šåŠ¡å±‚å°±ä¸ç”¨å…³å¿ƒåº•å±‚æ˜¯å¦åˆ†è¡¨ï¼Œåªéœ€è¦ä¸“æ³¨åœ¨ä¸šåŠ¡å³å¯ã€‚ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œç›®å‰æœ‰éå¸¸å¤šçš„æ•°æ®åº“ä¸­é—´ä»¶éƒ½å¯ä»¥å±è”½åˆ†è¡¨åçš„ç»†èŠ‚ï¼Œè®©ä¸šåŠ¡å±‚åƒæŸ¥è¯¢å•è¡¨ä¸€æ ·æŸ¥è¯¢åˆ†è¡¨åçš„æ•°æ®ã€‚å¦‚æœå†å°†æŠ½è±¡çš„é€»è¾‘ä¸‹ç§»åˆ°æ•°æ®åº“çš„æœåŠ¡å±‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„åˆ†åŒºè¡¨ã€‚ åˆ†åŒºå¯ä»¥çœ‹ä½œæ˜¯ä»æŠ€æœ¯å±‚é¢è§£å†³å¤§æ•°æ®é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ï¼Œç®€å•çš„ç†è§£ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ MySQL åº•å±‚å¸®æˆ‘ä»¬å®ç°åˆ†è¡¨ï¼Œåˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘è¡¨ï¼Œåº•å±‚ç”±å¤šä¸ªç‰©ç†å­è¡¨ç»„æˆã€‚å­˜å‚¨å¼•æ“ç®¡ç†åˆ†åŒºçš„å„ä¸ªåº•å±‚è¡¨å’Œç®¡ç†æ™®é€šè¡¨ä¸€æ ·ï¼ˆæ‰€æœ‰åº•å±‚è¡¨å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ï¼‰ï¼Œåˆ†åŒºè¡¨çš„ç´¢å¼•ä¹Ÿæ˜¯åœ¨å„ä¸ªåº•å±‚è¡¨ä¸Šå„è‡ªåŠ ä¸Šä¸€ä¸ªå®Œå…¨ç›¸åŒçš„ç´¢å¼•ã€‚ä»å­˜å‚¨å¼•æ“çš„è§’åº¦æ¥çœ‹ï¼Œåº•å±‚è¡¨å’Œæ™®é€šè¡¨æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œå­˜å‚¨å¼•æ“ä¹Ÿæ— é¡»çŸ¥é“ã€‚åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®åˆ†åŒºçš„å®šä¹‰è¿‡æ»¤é‚£äº›æ²¡æœ‰æˆ‘ä»¬éœ€è¦æ•°æ®çš„åˆ†åŒºï¼Œè¿™æ ·æŸ¥è¯¢å°±æ— éœ€æ‰«ææ‰€æœ‰åˆ†åŒºï¼Œåªéœ€è¦æŸ¥æ‰¾åŒ…å«éœ€è¦æ•°æ®çš„åˆ†åŒºå°±å¯ä»¥äº†ã€‚ æ›´å¥½çš„ç†è§£åˆ†åŒºè¡¨ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªç¤ºä¾‹å…¥æ‰‹ï¼šä¸€å¼ è®¢å•è¡¨ï¼Œæ•°æ®é‡å¤§æ¦‚æœ‰ 10TBï¼Œå¦‚ä½•è®¾è®¡æ‰èƒ½ä½¿æ€§èƒ½è¾¾åˆ°æœ€ä¼˜ï¼Ÿ é¦–å…ˆå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œå› ä¸ºæ•°æ®é‡å·¨å¤§ï¼Œè‚¯å®šä¸èƒ½èµ°å…¨è¡¨æ‰«æã€‚ä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œä½ ä¼šå‘ç°æ•°æ®å¹¶ä¸æ˜¯æŒ‰ç…§æƒ³è¦çš„æ–¹å¼èšé›†ï¼Œè€Œä¸”ä¼šäº§ç”Ÿå¤§é‡çš„ç¢ç‰‡ï¼Œæœ€ç»ˆä¼šå¯¼è‡´ä¸€ä¸ªæŸ¥è¯¢äº§ç”Ÿæˆåƒä¸Šä¸‡çš„éšæœº I/Oï¼Œåº”ç”¨éšä¹‹åƒµæ­»ã€‚æ‰€ä»¥éœ€è¦é€‰æ‹©ä¸€äº›æ›´ç²—ç²’åº¦å¹¶ä¸”æ¶ˆè€—æ›´å°‘çš„æ–¹å¼æ¥æ£€ç´¢æ•°æ®ã€‚æ¯”å¦‚å…ˆæ ¹æ®ç´¢å¼•æ‰¾åˆ°ä¸€å¤§å—æ•°æ®ï¼Œç„¶åå†åœ¨è¿™å—æ•°æ®ä¸Šé¡ºåºæ‰«æã€‚ è¿™æ­£æ˜¯åˆ†åŒºè¦åšçš„äº‹æƒ…ï¼Œç†è§£åˆ†åŒºæ—¶è¿˜å¯ä»¥å°†å…¶å½“ä½œç´¢å¼•çš„æœ€åˆå½¢æ€ï¼Œä»¥ä»£ä»·éå¸¸å°çš„æ–¹å¼å®šä½åˆ°éœ€è¦çš„æ•°æ®åœ¨å“ªä¸€ç‰‡ â€œåŒºåŸŸâ€ï¼Œåœ¨è¿™ç‰‡ â€œåŒºåŸŸâ€ ä¸­ï¼Œä½ å¯ä»¥é¡ºåºæ‰«æï¼Œå¯ä»¥å»ºç´¢å¼•ï¼Œè¿˜å¯ä»¥å°†æ•°æ®éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚å› ä¸ºåˆ†åŒºæ— é¡»é¢å¤–çš„æ•°æ®ç»“æ„è®°å½•æ¯ä¸ªåˆ†åŒºæœ‰å“ªäº›æ•°æ®ï¼Œæ‰€ä»¥å…¶ä»£ä»·éå¸¸ä½ã€‚åªéœ€è¦ä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼å°±å¯ä»¥è¡¨è¾¾æ¯ä¸ªåˆ†åŒºå­˜æ”¾çš„æ˜¯ä»€ä¹ˆæ•°æ®ã€‚ å¯¹è¡¨åˆ†åŒºï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨æ—¶ï¼Œä½¿ç”¨å¦‚ä¸‹è¯­å¥ï¼š12345678910CREATE TABLE sales { order_date DATETIME NOT NULL -- other columns} ENGINE=InnoDB PARTITION BY RANGE(YEAR(order_date)) ( PARTITION p_2014 VALUES LESS THAN (2014), PARTITION p_2015 VALUES LESS THAN (2015) PARTITION p_2016 VALUES LESS THAN (2016) PARTITION p_2017 VALUES LESS THAN (2017) PARTITION p_catchall VALUES LESS THAN MAXVALUE) åˆ†åŒºå­å¥ä¸­å¯ä»¥ä½¿ç”¨å„ç§å‡½æ•°ï¼Œä½†è¡¨è¾¾å¼çš„è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•´æ•°ï¼Œä¸”ä¸èƒ½æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚MySQL è¿˜æ”¯æŒä¸€äº›å…¶ä»–åˆ†åŒºï¼Œæ¯”å¦‚é”®å€¼ã€å“ˆå¸Œã€åˆ—è¡¨åˆ†åŒºï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå°‘è§åˆ°ã€‚åœ¨ MySQL5.5 ä»¥åå¯ä»¥ä½¿ç”¨ RANGE COLUMNS ç±»å‹åˆ†åŒºï¼Œè¿™æ ·å³ä½¿æ˜¯åŸºäºæ—¶é—´åˆ†åŒºï¼Œä¹Ÿæ— éœ€å†å°†å…¶è½¬åŒ–æˆä¸€ä¸ªæ•´æ•°ã€‚ æ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹åˆ†åŒºè¡¨ä¸Šçš„å„ç§æ“ä½œé€»è¾‘ï¼š SELECTï¼šå½“æŸ¥è¯¢ä¸€ä¸ªåˆ†åŒºè¡¨æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨ï¼Œä¼˜åŒ–å™¨å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥è¿‡æ»¤éƒ¨åˆ†åˆ†åŒºï¼Œç„¶ååœ¨è°ƒç”¨å¯¹åº”çš„å­˜å‚¨å¼•æ“æ¥å£è®¿é—®å„ä¸ªåˆ†åŒºçš„æ•°æ® INSERTï¼šå½“æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨ï¼Œç„¶åç¡®å®šå“ªä¸ªåˆ†åŒºæ¥æ”¶è¿™æ¡è®°å½•ï¼Œå†å°†è®°å½•å†™å…¥å¯¹åº”çš„åº•å±‚è¡¨ï¼ŒDELETEæ“ä½œä¸å…¶ç±»ä¼¼ UPDATEï¼šå½“æ›´æ–°ä¸€æ¡æ•°æ®æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨ï¼Œç„¶åç¡®å®šæ•°æ®å¯¹åº”çš„åˆ†åŒºï¼Œç„¶åå–å‡ºæ•°æ®å¹¶æ›´æ–°ï¼Œå†åˆ¤æ–­æ›´æ–°åçš„æ•°æ®åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªåˆ†åŒºï¼Œæœ€åå¯¹åº•å±‚è¡¨è¿›è¡Œå†™å…¥æ“ä½œï¼Œå¹¶å¯¹åŸæ•°æ®æ‰€åœ¨çš„åº•å±‚è¡¨è¿›è¡Œåˆ é™¤æ“ä½œ æœ‰äº›æ“ä½œæ˜¯æ”¯æŒæ¡ä»¶è¿‡æ»¤çš„ã€‚ä¾‹å¦‚ï¼Œå½“åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼ŒMySQL éœ€è¦å…ˆæ‰¾åˆ°è¿™æ¡è®°å½•ï¼Œå¦‚æœWHEREæ¡ä»¶æ°å¥½å’Œåˆ†åŒºè¡¨è¾¾å¼åŒ¹é…ï¼Œå°±å¯ä»¥å°†æ‰€æœ‰ä¸åŒ…å«è¿™æ¡è®°å½•çš„åˆ†åŒºéƒ½è¿‡æ»¤æ‰ï¼Œè¿™å¯¹UPDATEè¯­å¥åŒæ ·æœ‰æ•ˆã€‚å¦‚æœæ˜¯INSERTæ“ä½œï¼Œæœ¬èº«å°±åªå‘½ä¸­ä¸€ä¸ªåˆ†åŒºï¼Œå…¶ä»–åˆ†åŒºéƒ½ä¼šè¢«è¿‡æ»¤ã€‚ è™½ç„¶æ¯ä¸ªæ“ä½œéƒ½ä¼š â€œå…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨â€ï¼Œä½†è¿™å¹¶ä¸æ˜¯è¯´åˆ†åŒºè¡¨åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ˜¯é”ä½å…¨è¡¨çš„ã€‚å¦‚æœå­˜å‚¨å¼•æ“èƒ½å¤Ÿè‡ªå·±å®ç°è¡Œçº§é”ï¼Œä¾‹å¦‚ InnoDBï¼Œåˆ™ä¼šåœ¨åˆ†åŒºå±‚é‡Šæ”¾å¯¹åº”è¡¨é”ã€‚è¿™ä¸ªåŠ é”å’Œè§£é”çš„æ“ä½œè¿‡ç¨‹ä¸æ™®é€š InnoDB ä¸Šçš„æŸ¥è¯¢ç±»ä¼¼ã€‚ åœ¨ä½¿ç”¨åˆ†åŒºè¡¨æ—¶ï¼Œä¸ºäº†ä¿è¯å¤§æ•°æ®é‡çš„å¯æ‰©å±•æ€§ï¼Œä¸€èˆ¬æœ‰ä¸¤ä¸ªç­–ç•¥ï¼š å…¨é‡æ‰«ææ•°æ®ï¼Œä¸ç”¨ç´¢å¼•ã€‚å³åªè¦èƒ½å¤Ÿæ ¹æ® WHERE æ¡ä»¶å°†éœ€è¦æŸ¥è¯¢çš„æ•°æ®é™åˆ¶åœ¨å°‘æ•°åˆ†åŒºä¸­ï¼Œæ•ˆç‡æ˜¯ä¸é”™çš„ ç´¢å¼•æ•°æ®ï¼Œåˆ†ç¦»çƒ­ç‚¹ã€‚å¦‚æœæ•°æ®æœ‰æ˜æ˜¾çš„ â€œçƒ­ç‚¹â€ï¼Œè€Œä¸”é™¤äº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œå…¶ä»–æ•°æ®å¾ˆå°‘è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™éƒ¨åˆ†çƒ­ç‚¹æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºä¸­ï¼Œè®©è¿™ä¸ªåˆ†åŒºçš„æ•°æ®èƒ½å¤Ÿæœ‰æœºä¼šéƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚è¿™æ ·æŸ¥è¯¢å°±å¯ä»¥åªè®¿é—®ä¸€ä¸ªå¾ˆå°çš„åˆ†åŒºè¡¨ï¼Œèƒ½å¤Ÿä½¿ç”¨ç´¢å¼•ï¼Œä¹Ÿèƒ½å¤Ÿæœ‰æ•ˆçš„åˆ©ç”¨ç¼“å­˜ã€‚ åˆ†åŒºè¡¨çš„ä¼˜ç‚¹æ˜¯ä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®åˆ†åŒºå‡½æ•°æ¥è¿‡æ»¤ä¸€äº›åˆ†åŒºï¼Œä½†å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯è¦åœ¨WHEREæ¡ä»¶ä¸­å¸¦å…¥åˆ†åŒºåˆ—ï¼Œæœ‰æ—¶å€™å³ä½¿çœ‹ä¼¼å¤šä½™çš„ä¹Ÿè¦å¸¦ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥è®©ä¼˜åŒ–å™¨èƒ½å¤Ÿè¿‡æ»¤æ‰æ— é¡»è®¿é—®çš„åˆ†åŒºï¼Œå¦‚æœæ²¡æœ‰è¿™äº›æ¡ä»¶ï¼ŒMySQL å°±éœ€è¦è®©å¯¹åº”çš„å­˜å‚¨å¼•æ“è®¿é—®è¿™ä¸ªè¡¨çš„æ‰€æœ‰åˆ†åŒºï¼Œå¦‚æœè¡¨éå¸¸å¤§çš„è¯ï¼Œå°±å¯èƒ½ä¼šéå¸¸æ…¢ã€‚ ä¸Šé¢ä¸¤ä¸ªåˆ†åŒºç­–ç•¥åŸºäºä¸¤ä¸ªéå¸¸é‡è¦çš„å‰æï¼šæŸ¥è¯¢éƒ½èƒ½å¤Ÿè¿‡æ»¤æ‰å¾ˆå¤šé¢å¤–çš„åˆ†åŒºï¼Œåˆ†åŒºæœ¬èº«å¹¶ä¸ä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„ä»£ä»·ã€‚è€Œè¿™ä¸¤ä¸ªå‰æåœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚ï¼š 1ã€NULL å€¼ä¼šä½¿åˆ†åŒºè¿‡æ»¤æ— æ•ˆ å‡è®¾æŒ‰ç…§PARTITION BY RANGE YEAR(order_date)åˆ†åŒºï¼Œé‚£ä¹ˆæ‰€æœ‰order_dateä¸º NULL æˆ–è€…éæ³•å€¼æ—¶ï¼Œè®°å½•éƒ½ä¼šè¢«å­˜æ”¾åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºã€‚æ‰€ä»¥WHERE order_date BETWEEN '2017-05-01' AND '2017-05-31'ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šæ£€æŸ¥ä¸¤ä¸ªåˆ†åŒºï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„ 2017 å¹´è¿™ä¸ªåˆ†åŒºï¼ˆä¼šé¢å¤–çš„æ£€æŸ¥ç¬¬ä¸€ä¸ªåˆ†åŒºï¼‰ï¼Œæ˜¯å› ä¸ºYEAR()åœ¨æ¥æ”¶éæ³•å€¼æ—¶ä¼šè¿”å› NULLã€‚å¦‚æœç¬¬ä¸€ä¸ªåˆ†åŒºçš„æ•°æ®é‡éå¸¸å¤§ï¼Œè€Œä¸”ä½¿ç”¨å…¨è¡¨æ‰«æçš„ç­–ç•¥æ—¶ï¼Œä»£ä»·ä¼šéå¸¸å¤§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ— ç”¨çš„åˆ†åŒºï¼Œæ¯”å¦‚ï¼šPARTITION p_null values less than (0)ã€‚å¦‚æœæ’å…¥çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¯ï¼Œç¬¬ä¸€ä¸ªåˆ†åŒºå°±æ˜¯ç©ºçš„ã€‚ åœ¨ MySQL5.5 ä»¥åå°±ä¸éœ€è¦è¿™ä¸ªæŠ€å·§äº†ï¼Œå› ä¸ºå¯ä»¥ç›´æ¥ä½¿ç”¨åˆ—æœ¬èº«è€Œä¸æ˜¯åŸºäºåˆ—çš„å‡½æ•°è¿›è¡Œåˆ†åŒºï¼šPARTITION BY RANGE COLUMNS(order_date)ã€‚ç›´æ¥ä½¿ç”¨è¿™ä¸ªè¯­æ³•å¯é¿å…è¿™ä¸ªé—®é¢˜ã€‚ 2ã€åˆ†åŒºåˆ—å’Œç´¢å¼•åˆ—ä¸åŒ¹é… å½“åˆ†åŒºåˆ—å’Œç´¢å¼•åˆ—ä¸åŒ¹é…æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢æ— æ³•è¿›è¡Œåˆ†åŒºè¿‡æ»¤ï¼Œé™¤éæ¯ä¸ªæŸ¥è¯¢æ¡ä»¶ä¸­éƒ½åŒ…å«åˆ†åŒºåˆ—ã€‚å‡è®¾åœ¨åˆ— a ä¸Šå®šä¹‰äº†ç´¢å¼•ï¼Œè€Œåœ¨åˆ— b ä¸Šè¿›è¡Œåˆ†åŒºã€‚å› ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½æœ‰å…¶ç‹¬ç«‹çš„ç´¢å¼•ï¼Œæ‰€ä»¥åœ¨æ‰«æåˆ— b ä¸Šçš„ç´¢å¼•å°±éœ€è¦æ‰«ææ¯ä¸€ä¸ªåˆ†åŒºå†…å¯¹åº”çš„ç´¢å¼•ï¼Œå½“ç„¶è¿™ç§é€Ÿåº¦ä¸ä¼šå¤ªæ…¢ï¼Œä½†æ˜¯èƒ½å¤Ÿè·³è¿‡ä¸åŒ¹é…çš„åˆ†åŒºè‚¯å®šä¼šæ›´å¥½ã€‚è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥å¾ˆå®¹æ˜“é¿å…ï¼Œä½†éœ€è¦æ³¨æ„ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œå…³è”æŸ¥è¯¢ã€‚å¦‚æœåˆ†åŒºè¡¨æ˜¯å…³è”é¡ºåºçš„ç¬¬ 2 å¼ è¡¨ï¼Œå¹¶ä¸”å…³è”ä½¿ç”¨çš„ç´¢å¼•ä¸åˆ†åŒºæ¡ä»¶å¹¶ä¸åŒ¹é…ï¼Œé‚£ä¹ˆå…³è”æ—¶å¯¹ç¬¬ä¸€å¼ è¡¨ä¸­ç¬¦åˆæ¡ä»¶çš„æ¯ä¸€è¡Œéƒ½éœ€è¦è®¿é—®å¹¶æœç´¢ç¬¬äºŒå¼ è¡¨çš„æ‰€æœ‰åˆ†åŒºï¼ˆå…³è”æŸ¥è¯¢åŸç†ï¼Œè¯·å‚è€ƒå‰ä¸€ç¯‡æ–‡ç« ï¼‰ 3ã€é€‰æ‹©åˆ†åŒºçš„æˆæœ¬å¯èƒ½å¾ˆé«˜ åˆ†åŒºæœ‰å¾ˆå¤šç§ç±»å‹ï¼Œä¸åŒç±»å‹çš„åˆ†åŒºå®ç°æ–¹å¼ä¹Ÿä¸åŒï¼Œæ‰€ä»¥å®ƒä»¬çš„æ€§èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œå°¤å…¶æ˜¯èŒƒå›´åˆ†åŒºï¼Œåœ¨ç¡®è®¤è¿™ä¸€è¡Œå±äºå“ªä¸ªåˆ†åŒºæ—¶ä¼šæ‰«ææ‰€æœ‰çš„åˆ†åŒºå®šä¹‰ï¼Œè¿™æ ·çš„çº¿æ€§æ‰«ææ•ˆç‡å¹¶ä¸é«˜ï¼Œæ‰€ä»¥éšç€åˆ†åŒºæ•°çš„å¢é•¿ï¼Œæˆæœ¬ä¼šè¶Šæ¥è¶Šé«˜ã€‚ç‰¹åˆ«æ˜¯åœ¨æ‰¹é‡æ’å…¥æ•°æ®æ—¶ï¼Œç”±äºæ¯æ¡è®°å½•åœ¨æ’å…¥å‰ï¼Œéƒ½éœ€è¦ç¡®è®¤å…¶å±äºå“ªä¸€ä¸ªåˆ†åŒºï¼Œå¦‚æœåˆ†åŒºæ•°å¤ªå¤§ï¼Œä¼šé€ æˆæ’å…¥æ€§èƒ½çš„æ€¥å‰§ä¸‹é™ã€‚å› æ­¤æœ‰å¿…è¦é™åˆ¶åˆ†åŒºæ•°é‡ï¼Œä½†ä¹Ÿä¸ç”¨å¤ªè¿‡æ‹…å¿ƒï¼Œå¯¹äºå¤§å¤šæ•°ç³»ç»Ÿï¼Œ100 ä¸ªå·¦å³çš„åˆ†åŒºæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ 4ã€æ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨çš„æˆæœ¬åœ¨æŸäº›æ—¶å€™ä¼šå¾ˆé«˜ å‰é¢è¯´è¿‡ï¼Œæ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨å¹¶ä¸ä¼šå¯¹æ€§èƒ½æœ‰å¤ªå¤§çš„å½±å“ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åªéœ€è¦æŸ¥è¯¢ä¸»é”®ï¼Œé‚£ä¹ˆé”ä½çš„æˆæœ¬ç›¸å¯¹äºä¸»é”®çš„æŸ¥è¯¢æ¥è¯´ï¼Œæˆæœ¬å°±ç•¥é«˜ã€‚ 5ã€ç»´æŠ¤åˆ†åŒºçš„æˆæœ¬å¯èƒ½ä¼šå¾ˆé«˜ æ–°å¢å’Œåˆ é™¤åˆ†åŒºçš„é€Ÿåº¦éƒ½å¾ˆå¿«ï¼Œä½†æ˜¯ä¿®æ”¹åˆ†åŒºä¼šé€ æˆæ•°æ®çš„å¤åˆ¶ï¼Œè¿™ä¸ALTER TABLEçš„åŸç†ç±»ä¼¼ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå†å²åˆ†åŒºï¼Œç„¶åå°†æ•°æ®å¤åˆ¶åˆ°å…¶ä¸­ï¼Œæœ€ååˆ é™¤åŸåˆ†åŒºã€‚å› æ­¤ï¼Œè®¾è®¡æ•°æ®åº“æ—¶ï¼Œè€ƒè™‘ä¸šåŠ¡çš„å¢é•¿éœ€è¦ï¼Œåˆç†çš„åˆ›å»ºåˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚åœ¨ MySQL5.6 ä»¥åçš„ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ALTER TABLE EXCHAGE PARTITIONè¯­å¥æ¥ä¿®æ”¹åˆ†åŒºï¼Œå…¶æ€§èƒ½ä¼šæœ‰å¾ˆå¤§æå‡ã€‚ åˆ†åŒºè¡¨è¿˜æœ‰ä¸€äº›å…¶ä»–é™åˆ¶ï¼Œæ¯”å¦‚æ‰€æœ‰çš„åº•å±‚è¡¨å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ï¼ŒæŸäº›å­˜å‚¨å¼•æ“ä¹Ÿä¸æ”¯æŒåˆ†åŒºã€‚åˆ†åŒºä¸€èˆ¬åº”ç”¨äºä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä½†ä¸€å°æœåŠ¡å™¨çš„ç‰©ç†èµ„æºæ€»æ˜¯æœ‰é™çš„ï¼Œå½“æ•°æ®è¾¾åˆ°è¿™ä¸ªæé™æ—¶ï¼Œå³ä½¿åˆ†åŒºï¼Œæ€§èƒ½ä¹Ÿå¯èƒ½ä¼šå¾ˆä½ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™åˆ†åº“æ˜¯å¿…é¡»çš„ã€‚ä½†ä¸ç®¡æ˜¯åˆ†åŒºã€åˆ†åº“è¿˜æ˜¯åˆ†è¡¨ï¼Œå®ƒä»¬çš„æ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¤§å®¶å¯ä»¥å¥½å¥½ä½“ä¼šä¸‹ã€‚ è§†å›¾å¯¹äºä¸€äº›å…³è”è¡¨çš„å¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨è§†å›¾æœ‰æ—¶å€™ä¼šå¤§å¤§ç®€åŒ–é—®é¢˜ï¼Œå› æ­¤åœ¨è®¸å¤šåœºåˆä¸‹éƒ½å¯ä»¥çœ‹åˆ°è§†å›¾çš„èº«å½±ï¼Œä½†è§†å›¾çœŸå¦‚æˆ‘ä»¬æ‰€æƒ³é‚£æ ·ç®€å•å—ï¼Ÿå®ƒå’Œç›´æ¥ä½¿ç”¨JOINçš„ SQL è¯­å¥æœ‰ä½•åŒºåˆ«ï¼Ÿè§†å›¾èƒŒåçš„åŸç†åˆäº†è§£å¤šå°‘ï¼Ÿ è§†å›¾æœ¬èº«æ˜¯ä¸€ä¸ªè™šæ‹Ÿè¡¨ï¼Œä¸å­˜æ”¾ä»»ä½•æ•°æ®ï¼ŒæŸ¥è¯¢è§†å›¾çš„æ•°æ®é›†ç”±å…¶ä»–è¡¨ç”Ÿæˆã€‚MySQL åº•å±‚é€šè¿‡ä¸¤ç§ç®—æ³•æ¥å®ç°è§†å›¾ï¼šä¸´æ—¶è¡¨ç®—æ³•ï¼ˆTEMPTABLEï¼‰å’Œåˆå¹¶ç®—æ³•ï¼ˆMERGEï¼‰ã€‚æ‰€è°“ä¸´æ—¶è¡¨ç®—æ³•å°±æ˜¯å°† SELECT è¯­å¥çš„ç»“æœå­˜æ”¾åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œå½“éœ€è¦è®¿é—®è§†å›¾çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®è¿™ä¸ªä¸´æ—¶è¡¨å³å¯ã€‚è€Œåˆå¹¶ç®—æ³•åˆ™æ˜¯é‡å†™åŒ…å«è§†å›¾çš„æŸ¥è¯¢ï¼Œå°†è§†å›¾å®šä¹‰çš„ SQL ç›´æ¥åŒ…å«è¿›æŸ¥è¯¢ SQL ä¸­ã€‚é€šè¿‡ä¸¤ä¸ªç®€å•çš„ç¤ºä¾‹æ¥ä½“ä¼šä¸¤ä¸ªç®—æ³•çš„å·®å¼‚ï¼Œåˆ›å»ºå¦‚ä¸‹è§†å›¾ï¼š1234-- è§†å›¾çš„ä½œç”¨æ˜¯æŸ¥è¯¢æœªæ”¯ä»˜è®¢å•CREATE VIEW unpay_order ASSELECT * FROM sales WHERE status = 'new'WITH CHECK OPTION; -- å…¶ä½œç”¨ä¸‹æ–‡ä¼šè®² ç°è¦ä»æœªæ”¯ä»˜è®¢å•ä¸­æŸ¥è¯¢è´­ä¹°è€…ä¸ºcscçš„è®¢å•ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŸ¥è¯¢ï¼š12-- æŸ¥è¯¢è´­ä¹°è€…ä¸ºcscä¸”æœªæ”¯ä»˜çš„è®¢å•SELECT order_id,order_amount,buyer FROM unpay_order WHERE buyer = 'csc'; ä½¿ç”¨ä¸´æ—¶è¡¨æ¥æ¨¡æ‹Ÿè§†å›¾ï¼š12CREATE TEMPORARY TABLE tmp_order_unpay AS SELECT * FROM sales WHERE status = 'new';SELECT order_id,order_amount,buyer FROM tmp_order_unpay WHERE buyer = 'csc'; ä½¿ç”¨åˆå¹¶ç®—æ³•å°†è§†å›¾å®šä¹‰çš„ SQL åˆå¹¶è¿›æŸ¥è¯¢ SQL åçš„æ ·å­ï¼š1SELECT order_id,order_amount,buyer FROM sales WHERE status = 'new' AND buyer = 'csc'; MySQL å¯ä»¥åµŒå¥—å®šä¹‰è§†å›¾ï¼Œå³åœ¨ä¸€ä¸ªè§†å›¾ä¸Šåœ¨å®šä¹‰å¦ä¸€ä¸ªè§†å›¾ï¼Œå¯ä»¥åœ¨EXPLAIN EXTENDEDä¹‹åä½¿ç”¨SHOW WARNINGSæ¥æŸ¥çœ‹ä½¿ç”¨è§†å›¾çš„æŸ¥è¯¢é‡å†™åçš„ç»“æœã€‚å¦‚æœé‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ï¼ŒEXPLAINä¸­ä¼šæ˜¾ç¤ºä¸ºæ´¾ç”Ÿè¡¨ï¼ˆDERIVEDï¼‰ï¼Œæ³¨æ„EXPLAINæ—¶éœ€è¦å®é™…æ‰§è¡Œå¹¶äº§ç”Ÿä¸´æ—¶è¡¨ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šå¾ˆæ…¢ã€‚ æ˜æ˜¾åœ°ï¼Œä¸´æ—¶è¡¨ä¸Šæ²¡æœ‰ä»»ä½•ç´¢å¼•ï¼Œè€Œä¸”ä¼˜åŒ–å™¨ä¹Ÿå¾ˆéš¾ä¼˜åŒ–ä¸´æ—¶è¡¨ä¸Šçš„æŸ¥è¯¢ï¼Œå› æ­¤ï¼Œå¦‚æœ‰å¯èƒ½ï¼Œå°½é‡ä½¿ç”¨åˆå¹¶ç®—æ³•ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šåˆå¹¶ç®—æ³•ï¼ˆç±»ä¼¼äºç›´æ¥æŸ¥è¯¢ï¼‰æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨è§†å›¾ï¼Ÿ é¦–å…ˆè§†å›¾å¯ä»¥ç®€åŒ–åº”ç”¨ä¸Šå±‚çš„æ“ä½œï¼Œè®©åº”ç”¨æ›´ä¸“æ³¨äºå…¶æ‰€å…³å¿ƒçš„æ•°æ®ã€‚å…¶æ¬¡ï¼Œè§†å›¾èƒ½å¤Ÿå¯¹æ•æ„Ÿæ•°æ®æä¾›å®‰å…¨ä¿æŠ¤ï¼Œæ¯”å¦‚ï¼šå¯¹ä¸åŒçš„ç”¨æˆ·å®šä¹‰ä¸åŒçš„è§†å›¾ï¼Œå¯ä»¥ä½¿æ•æ„Ÿæ•°æ®ä¸å‡ºç°åœ¨ä¸åº”è¯¥çœ‹åˆ°è¿™äº›æ•°æ®çš„ç”¨æˆ·è§†å›¾ä¸Šï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨è§†å›¾å®ç°åŸºäºåˆ—çš„æƒé™æ§åˆ¶ï¼Œè€Œä¸éœ€è¦çœŸæ­£çš„åœ¨æ•°æ®åº“ä¸­åˆ›å»ºåˆ—æƒé™ã€‚å†è€…ï¼Œè§†å›¾å¯ä»¥æ–¹ä¾¿ç³»ç»Ÿè¿ç»´ï¼Œæ¯”å¦‚ï¼šåœ¨é‡æ„ schema çš„æ—¶å€™ä½¿ç”¨è§†å›¾ï¼Œä½¿å¾—åœ¨ä¿®æ”¹è§†å›¾åº•å±‚è¡¨ç»“æ„çš„æ—¶å€™ï¼Œåº”ç”¨ä»£ç è¿˜å¯ä»¥ç»§ç»­è¿è¡Œä¸æŠ¥é”™ã€‚ åŸºäºæ­¤ï¼Œä½¿ç”¨è§†å›¾å…¶å®æ›´å¤šçš„æ˜¯åŸºäºä¸šåŠ¡æˆ–è€…ç»´æŠ¤æˆæœ¬ä¸Šçš„è€ƒè™‘ï¼Œå…¶æœ¬èº«å¹¶ä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå¤§ä½œç”¨ï¼ˆæ³¨æ„ï¼šæ­¤å¤„åªæ˜¯åŸºäº MySQL è€ƒè™‘ï¼Œå…¶ä»–å…³ç³»æ€§æ•°æ®åº“ä¸­è§†å›¾å¯èƒ½ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæ¯”å¦‚ORACLEå’ŒMS SQL SERVERéƒ½æ”¯æŒç‰©åŒ–è§†å›¾ï¼Œå®ƒä»¬éƒ½æ¯” MySQL è§†å›¾æœ‰æ›´å¥½çš„æ€§èƒ½ï¼‰ã€‚è€Œä¸”ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ï¼Œåœ¨æŸäº›æ—¶å€™æ€§èƒ½å¯èƒ½ä¼šéå¸¸ç³Ÿç³•ï¼Œæ¯”å¦‚ï¼š123-- è§†å›¾çš„ä½œç”¨æ˜¯ç»Ÿè®¡æ¯æ—¥æ”¯å‡ºé‡‘é¢ï¼ŒDATE('2017-06-15 12:00:23') = 2017-06-15CREATE VIEW cost_per_day ASSELECT DATE(create_time) AS date,SUM(cost) AS cost FROM costs GROUP BY date; ç°è¦ç»Ÿè®¡æ¯æ—¥çš„æ”¶å…¥ä¸æ”¯å‡ºï¼Œæœ‰ç±»ä¼¼äºä¸Šé¢çš„æ”¶å…¥è¡¨ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ SQLï¼š1234SELECT c.date,c.cost,s.amountFROM cost_per_day AS cJOIN sale_per_day AS s USING(date)WHERE date BETWEEN '2017-06-01' AND '2017-06-30' è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼ŒMySQL å…ˆæ‰§è¡Œè§†å›¾çš„ SQLï¼Œç”Ÿæˆä¸´æ—¶è¡¨ï¼Œç„¶åå†å°†sale_per_dayè¡¨å’Œä¸´æ—¶è¡¨è¿›è¡Œå…³è”ã€‚è¿™é‡ŒWHEREå­—å¥ä¸­çš„BETWEENæ¡ä»¶å¹¶ä¸èƒ½ä¸‹æ¨åˆ°è§†å›¾ä¸­ï¼Œå› è€Œè§†å›¾åœ¨åˆ›å»ºæ—¶ï¼Œä¼šå°†æ‰€æœ‰çš„æ•°æ®æ”¾åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæœˆæ•°æ®ï¼Œå¹¶ä¸”è¿™ä¸ªä¸´æ—¶è¡¨ä¹Ÿä¸ä¼šæœ‰ç´¢å¼•ã€‚ å½“ç„¶è¿™ä¸ªç¤ºä¾‹ä¸­çš„ä¸´æ—¶è¡¨æ•°æ®ä¸ä¼šå¤ªå¤§ï¼Œæ¯•ç«Ÿæ—¥æœŸçš„æ•°é‡ä¸ä¼šå¤ªå¤šï¼Œä½†ä»ç„¶è¦è€ƒè™‘ç”Ÿæˆä¸´æ—¶è¡¨çš„æ€§èƒ½ï¼ˆå¦‚æœ costs è¡¨æ•°æ®è¿‡å¤§ï¼ŒGROUP BYæœ‰å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼‰ã€‚è€Œä¸”æœ¬ç¤ºä¾‹ä¸­ç´¢å¼•ä¹Ÿä¸æ˜¯é—®é¢˜ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœ MySQL å°†ä¸´æ—¶è¡¨ä½œä¸ºå…³è”é¡ºåºä¸­çš„ç¬¬ä¸€å¼ è¡¨ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨sale_per_dayä¸­çš„ç´¢å¼•ã€‚ä½†å¦‚æœæ˜¯å¯¹ä¸¤ä¸ªè§†å›¾åšå…³è”çš„è¯ï¼Œä¼˜åŒ–å™¨å°±æ²¡æœ‰ä»»ä½•ç´¢å¼•å¯ä»¥ä½¿ç”¨ï¼Œè¿™æ—¶å°±éœ€è¦ä¸¥æ ¼æµ‹è¯•åº”ç”¨çš„æ€§èƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚ã€‚ æˆ‘ä»¬å¾ˆå°‘ä¼šåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­å»æ›´æ–°è§†å›¾ï¼Œå› æ­¤å°è±¡ä¸­ï¼Œè§†å›¾æ˜¯ä¸èƒ½æ›´æ–°çš„ã€‚ä½†å®é™…ä¸Šï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè§†å›¾æ˜¯å¯ä»¥æ›´æ–°çš„ã€‚å¯æ›´æ–°è§†å›¾æ˜¯æŒ‡é€šè¿‡æ›´æ–°è¿™ä¸ªè§†å›¾æ¥æ›´æ–°è§†å›¾æ¶‰åŠçš„ç›¸å…³è¡¨ï¼Œåªè¦æŒ‡å®šäº†åˆé€‚çš„æ¡ä»¶ï¼Œå°±å¯ä»¥æ›´æ–°ã€åˆ é™¤ç”šè‡³æ˜¯å‘è§†å›¾ä¸­æ’å…¥æ•°æ®ã€‚é€šè¿‡ä¸Šæ–‡çš„äº†è§£ï¼Œä¸éš¾æ¨æ–­å‡ºï¼šæ›´æ–°è§†å›¾çš„å®è´¨å°±æ˜¯æ›´æ–°è§†å›¾å…³è”çš„è¡¨ï¼Œå°†åˆ›å»ºè§†å›¾çš„WHEREå­å¥è½¬åŒ–ä¸ºUPDATEè¯­å¥çš„WHEREå­å¥ï¼Œåªæœ‰ä½¿ç”¨åˆå¹¶ç®—æ³•çš„è§†å›¾æ‰èƒ½æ›´æ–°ï¼Œå¹¶ä¸”æ›´æ–°çš„åˆ—å¿…é¡»æ¥è‡ªåŒä¸€ä¸ªè¡¨ä¸­ã€‚å›é¡¾ä¸Šæ–‡åˆ›å»ºè§†å›¾çš„ SQL è¯­å¥ï¼Œå…¶ä¸­æœ‰ä¸€å¥ï¼šWITH CHECK OPTIONï¼Œå…¶ä½œç”¨å°±æ˜¯è¡¨ç¤ºé€šè¿‡è§†å›¾æ›´æ–°çš„è¡Œï¼Œéƒ½å¿…é¡»ç¬¦åˆè§†å›¾æœ¬èº«çš„WHEREæ¡ä»¶å®šä¹‰ï¼Œä¸èƒ½æ›´æ–°è§†å›¾å®šä¹‰åˆ—ä»¥å¤–çš„åˆ—ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºcheck option failedé”™è¯¯ã€‚ è§†å›¾è¿˜æœ‰ä¸€ä¸ªå®¹æ˜“é€ æˆè¯¯è§£çš„åœ°æ–¹ï¼šâ€œå¯¹äºä¸€äº›ç®€å•çš„æŸ¥è¯¢ï¼Œè§†å›¾ä¼šä½¿ç”¨åˆå¹¶ç®—æ³•ï¼Œè€Œå¯¹äºä¸€äº›æ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢ï¼Œè§†å›¾å°±ä¼šä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•â€ã€‚ä½†å®é™…ä¸Šï¼Œè§†å›¾çš„å®ç°ç®—æ³•æ˜¯è§†å›¾æœ¬èº«çš„å±æ€§å†³å®šçš„ï¼Œè·Ÿä½œç”¨åœ¨è§†å›¾ä¸Šçš„ SQL æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚é‚£ä»€ä¹ˆæ—¶å€™è§†å›¾é‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•ï¼Œä»€ä¹ˆæ—¶å€™é‡‡ç”¨åˆå¹¶ç®—æ³•å‘¢ï¼Ÿä¸€èˆ¬æ¥è¯´ï¼Œåªè¦åŸè¡¨è®°å½•å’Œè§†å›¾ä¸­çš„è®°å½•æ— æ³•å»ºç«‹ä¸€ä¸€æ˜ å°„çš„å…³ç³»æ—¶ï¼ŒMySQL éƒ½å°†ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•æ¥å®ç°è§†å›¾ã€‚æ¯”å¦‚åˆ›å»ºè§†å›¾çš„ SQL ä¸­åŒ…å«GROUP BYã€DISTINCTã€UNIONã€èšåˆå‡½æ•°ã€å­æŸ¥è¯¢çš„æ—¶å€™ï¼Œè§†å›¾éƒ½å°†é‡‡ç”¨ä¸´æ—¶è¡¨ç®—æ³•ï¼ˆè¿™äº›è§„åˆ™åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå…·ä½“è¯·å‚è€ƒå®˜æ–¹æ‰‹å†Œï¼‰ã€‚ ç›¸æ¯”äºå…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„è§†å›¾ï¼ŒMySQL çš„è§†å›¾åœ¨åŠŸèƒ½ä¸Šä¼šå¼±å¾ˆå¤šï¼Œæ¯”å¦‚ORACLEå’ŒMS SQL SERVERéƒ½æ”¯æŒç‰©åŒ–è§†å›¾ã€‚ç‰©åŒ–è§†å›¾æ˜¯æŒ‡å°†è§†å›¾ç»“æœæ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ªå¯ä»¥æŸ¥è¯¢çš„è¡¨ä¸­ï¼Œå¹¶å®šæœŸä»åŸå§‹è¡¨ä¸­åˆ·æ–°æ•°æ®åˆ°è¿™å¼ è¡¨ä¸­ï¼Œè¿™å¼ è¡¨å’Œæ™®é€šç‰©ç†è¡¨ä¸€æ ·ï¼Œå¯ä»¥åˆ›å»ºç´¢å¼•ã€ä¸»é”®çº¦æŸç­‰ç­‰ï¼Œæ€§èƒ½ç›¸æ¯”äºä¸´æ—¶è¡¨ä¼šæœ‰è´¨çš„æå‡ã€‚ä½†é—æ†¾çš„æ˜¯ MySQL ç›®å‰å¹¶ä¸æ”¯æŒç‰©åŒ–è§†å›¾ï¼Œå½“ç„¶ MySQL ä¹Ÿä¸æ”¯æŒåœ¨è§†å›¾ä¸­åˆ›å»ºç´¢å¼•ã€‚ å­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨å›åˆ°ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæœ‰éå¸¸å¤šçš„äººåœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ å¦‚æœæœ‰æ·±å…¥äº†è§£è¿‡å­˜å‚¨è¿‡ç¨‹ï¼Œå°±ä¼šå‘ç°å­˜å‚¨è¿‡ç¨‹å¹¶æ²¡æœ‰å¤§å®¶æè¿°çš„é‚£ä¹ˆä¸å ªã€‚æˆ‘æ›¾ç»ç»å†è¿‡ä¸€äº›é‡åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹çš„äº§å“ï¼Œä¾èµ–åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå°±è¿™ä¹ˆè¯´å§ï¼Œä¸Šå±‚çš„åº”ç”¨åŸºæœ¬ä¸Šåªå¤„ç†äº¤äº’ä¸åŠ¨æ•ˆçš„é€»è¾‘ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œç”šè‡³æ˜¯å‚æ•°çš„æ ¡éªŒå‡åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°ã€‚æ›¾ç»æœ‰å‡ºç°è¿‡ä¸€ä¸ªè¶…å¤§çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå…¶æ–‡ä»¶å¤§å°è¾¾åˆ°æƒŠäººçš„ 80Kï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œå…¶ä¸šåŠ¡é€»è¾‘æœ‰å¤šä¹ˆå¤æ‚ã€‚åœ¨å¤§å¤šæ•°äººçœ¼ä¸­ï¼Œè¿™æ ·çš„æŠ€æœ¯æ¶æ„ç®€ç›´æœ‰ç‚¹ä¸å¯ç†å–»ï¼Œä½†å®é™…ä¸Šè¿™æ¬¾äº§å“éå¸¸æˆåŠŸã€‚ å…¶æˆåŠŸçš„åŸå› åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¾—ç›Šäºå­˜å‚¨è¿‡ç¨‹çš„ä¼˜ç‚¹ï¼Œç”±äºä¸šåŠ¡å±‚ä»£ç æ²¡æœ‰ä»»ä½•ä¾µå…¥ä¸šåŠ¡çš„ä»£ç ï¼Œåœ¨ä¸æ”¹å˜å‰ç«¯å±•ç¤ºæ•ˆæœçš„åŒæ—¶ï¼Œå¯ä»¥éå¸¸å¿«é€Ÿçš„ä¿®å¤ BUGã€å¼€å‘æ–°åŠŸèƒ½ã€‚ç”±äºè¿™æ¬¾äº§å“éœ€è¦éƒ¨ç½²åœ¨å®¢æˆ·çš„ç§æœ‰ç¯å¢ƒä¸Šï¼Œå¿«é€Ÿå“åº”å®¢æˆ·çš„éœ€æ±‚å°±å˜å¾—å°¤ä¸ºé‡è¦ï¼Œæ­£æ˜¯å¾—ç›Šäºè¿™ç§æ¶æ„ï¼Œå¯ä»¥åœ¨å®¢æˆ·å‡ºç°é—®é¢˜æˆ–è€…æå‡ºæ–°éœ€æ±‚æ—¶ï¼Œå¿«é€Ÿå“åº”ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ 1 å°æ—¶å†…ä¿®å¤å®¢æˆ·é‡åˆ°çš„é—®é¢˜ã€‚æ­£æ˜¯è¿™ç§å¿«é€Ÿå“åº”æœºåˆ¶ï¼Œè®©æˆ‘ä»¬è·å¾—å¤§é‡çš„å®¢æˆ·ã€‚ å½“ç„¶å­˜å‚¨è¿‡ç¨‹è¿˜æœ‰å…¶ä»–çš„ä¼˜ç‚¹ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„åŠ å¯†å­˜å‚¨è¿‡ç¨‹ä»£ç ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåº”ç”¨éƒ¨ç½²åˆ°ç§æœ‰ç¯å¢ƒé€ æˆæºä»£ç æ³„éœ²ã€å¯ä»¥åƒè°ƒè¯•å…¶ä»–åº”ç”¨ç¨‹åºä¸€æ ·è°ƒè¯•å­˜å‚¨è¿‡ç¨‹ã€å¯ä»¥è®¾å®šå­˜å‚¨è¿‡ç¨‹çš„ä½¿ç”¨æƒé™æ¥ä¿è¯æ•°æ®å®‰å…¨ç­‰ç­‰ã€‚ä¸€åˆ‡éƒ½éå¸¸ç¾å¥½ï¼Œä½†æˆ‘ä»¬çš„äº§å“æ˜¯åŸºäºMS SQL SERVERå®ç°çš„ï¼Œå…¶å¯ä»¥é€šè¿‡T-SQLéå¸¸æ–¹ä¾¿çš„å®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚ä½ å¯ä»¥æŠŠT-SQLçœ‹åšæ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œå…¶åŒ…å«SQLçš„æ‰€æœ‰åŠŸèƒ½ï¼Œè¿˜å…·å¤‡æµç¨‹æ§åˆ¶ã€æ‰¹å¤„ç†ã€å®šæ—¶ä»»åŠ¡ç­‰èƒ½åŠ›ï¼Œä½ ç”šè‡³å¯ä»¥ç”¨å…¶æ¥è§£æ XML æ•°æ®ã€‚å…³äºT-SQLçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒMSDNï¼Œä¸»æµçš„å…³ç³»å‹æ•°æ®åº“ç›®å‰åªæœ‰MS SQL SERVERæ”¯æŒT-SQLï¼Œå› æ­¤ï¼ŒMySQL å¹¶ä¸å…·å¤‡ä¸Šæ–‡æè¿°çš„ä¸€äº›èƒ½åŠ›ï¼Œæ¯”å¦‚ï¼ŒMySQL çš„å­˜å‚¨è¿‡ç¨‹è°ƒè¯•éå¸¸ä¸æ–¹ä¾¿ï¼ˆå½“ç„¶å¯ä»¥é€šè¿‡ä»˜è´¹è½¯ä»¶æ¥è·å¾—å¾ˆå¥½çš„æ”¯æŒï¼‰ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒMySQL å­˜å‚¨è¿‡ç¨‹è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é™åˆ¶ï¼š ä¼˜åŒ–å™¨æ— æ³•è¯„ä¼°å­˜å‚¨è¿‡ç¨‹çš„æ‰§è¡Œæˆæœ¬ æ¯ä¸ªè¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œè®¡åˆ’ç¼“å­˜ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿æ¥éœ€è¦è°ƒç”¨åŒä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œå°†ä¼šæµªè´¹ç¼“å­˜ç©ºé—´æ¥ç¼“å­˜ç›¸åŒçš„æ‰§è¡Œè®¡åˆ’ å› æ­¤ï¼Œåœ¨ MySQL ä¸­ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªå¤ªå¥½ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº›å¤§æ•°æ®ã€é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå°†å¤æ‚çš„é€»è¾‘äº¤ç»™ä¸Šå±‚åº”ç”¨å®ç°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰©å±•å·²æœ‰èµ„æºä»¥ä¾¿è·å¾—æ›´é«˜çš„è®¡ç®—èƒ½åŠ›ã€‚è€Œä¸”å¯¹äºç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€ï¼Œå…¶å¯è¯»æ€§ä¼šæ¯”å­˜å‚¨è¿‡ç¨‹æ›´å¥½ä¸€äº›ï¼Œä¹Ÿæ›´åŠ çµæ´»ã€‚ä¸è¿‡ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœå­˜å‚¨è¿‡ç¨‹æ¯”å…¶ä»–å®ç°ä¼šå¿«å¾ˆå¤šï¼Œå¹¶ä¸”æ˜¯ä¸€äº›è¾ƒå°çš„æ“ä½œï¼Œå¯ä»¥é€‚å½“è€ƒè™‘ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€‚ å’Œå­˜å‚¨è¿‡ç¨‹ç±»ä¼¼çš„ï¼Œè¿˜æœ‰è§¦å‘å™¨ï¼Œè§¦å‘å™¨å¯ä»¥è®©ä½ åœ¨æ‰§è¡ŒINSERTã€UPDATEå’ŒDELETEæ—¶ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œã€‚åœ¨ MySQL ä¸­å¯ä»¥é€‰æ‹©åœ¨ SQL æ‰§è¡Œä¹‹å‰è§¦å‘è¿˜æ˜¯åœ¨ SQL æ‰§è¡Œåè§¦å‘ã€‚è§¦å‘å™¨ä¸€èˆ¬ç”¨äºå®ç°ä¸€äº›å¼ºåˆ¶çš„é™åˆ¶ï¼Œè¿™äº›é™åˆ¶å¦‚æœåœ¨åº”ç”¨ç¨‹åºä¸­å®ç°ä¼šè®©ä¸šåŠ¡ä»£ç å˜å¾—éå¸¸å¤æ‚ï¼Œè€Œä¸”å®ƒä¹Ÿå¯ä»¥å‡å°‘å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ã€‚MySQL è§¦å‘å™¨çš„å®ç°éå¸¸ç®€å•ï¼Œæ‰€ä»¥åŠŸèƒ½éå¸¸æœ‰é™ï¼Œå¦‚æœä½ åœ¨å…¶ä»–æ•°æ®åº“äº§å“ä¸­å·²ç»é‡åº¦ä¾èµ–è§¦å‘å™¨ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ MySQL è§¦å‘å™¨æ—¶å€™éœ€è¦æ³¨æ„ï¼Œå› ä¸º MySQL è§¦å‘å™¨çš„è¡¨ç°å’Œé¢„æƒ³çš„ä¸ä¸€è‡´ã€‚ é¦–å…ˆå¯¹ä¸€å¼ è¡¨çš„æ¯ä¸€ä¸ªäº‹ä»¶ï¼Œæœ€å¤šåªèƒ½å®šä¹‰ä¸€ä¸ªè§¦å‘å™¨ï¼Œè€Œä¸”å®ƒåªæ”¯æŒ â€œåŸºäºè¡Œçš„è§¦å‘â€ï¼Œä¹Ÿå°±æ˜¯è§¦å‘å™¨å§‹ç»ˆæ˜¯é’ˆå¯¹ä¸€æ¡è®°å½•çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ•´ä¸ª SQL è¯­å¥ã€‚å¦‚æœæ˜¯æ‰¹é‡æ›´æ–°çš„è¯ï¼Œæ•ˆç‡å¯èƒ½ä¼šå¾ˆä½ã€‚å…¶æ¬¡ï¼Œè§¦å‘å™¨å¯ä»¥æ©ç›–æœåŠ¡å™¨æœ¬è´¨å·¥ä½œï¼Œä¸€ä¸ªç®€å•çš„ SQL è¯­å¥èƒŒåï¼Œå› ä¸ºè§¦å‘å™¨ï¼Œå¯èƒ½åŒ…å«äº†å¾ˆå¤šçœ‹ä¸è§çš„å·¥ä½œã€‚å†è€…ï¼Œè§¦å‘å™¨å‡ºç°é—®é¢˜æ—¶å¾ˆéš¾æ’æŸ¥ã€‚æœ€åï¼Œè§¦å‘å™¨å¹¶ä¸ä¸€å®šèƒ½ä¿è¯åŸå­æ€§ï¼Œæ¯”å¦‚MyISAMå¼•æ“ä¸‹è§¦å‘å™¨æ‰§è¡Œå¤±è´¥äº†ï¼Œä¹Ÿä¸èƒ½å›æ»šã€‚åœ¨InnoDBè¡¨ä¸Šçš„è§¦å‘å™¨æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå®Œæˆçš„ï¼Œæ‰€ä»¥ä»–ä»¬çš„æ‰§è¡Œæ˜¯åŸå­çš„ï¼ŒåŸæ“ä½œå’Œè§¦å‘å™¨æ“ä½œä¼šåŒæ—¶å¤±è´¥æˆ–è€…æˆåŠŸã€‚ è™½ç„¶è§¦å‘å™¨æœ‰è¿™ä¹ˆå¤šé™åˆ¶ï¼Œä½†å®ƒä»æœ‰é€‚ç”¨çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼Œå½“ä½ éœ€è¦è®°å½• MySQL æ•°æ®çš„å˜æ›´æ—¥å¿—ï¼Œè¿™æ—¶è§¦å‘å™¨å°±éå¸¸æ–¹ä¾¿äº†ã€‚ å¤–é”®çº¦æŸç›®å‰åœ¨å¤§å¤šæ•°äº’è”ç½‘é¡¹ç›®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§æ•°æ®çš„åœºæ™¯ä¸‹ï¼Œå·²ç»ä¸å»ºè®®ä½¿ç”¨å¤–é”®äº†ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°å¤–é”®çš„ä½¿ç”¨æˆæœ¬ï¼š å¤–é”®é€šå¸¸è¦æ±‚æ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶éƒ½è¦åœ¨å¦å¤–ä¸€å¼ è¡¨ä¸­æ‰§è¡Œä¸€æ¬¡æŸ¥æ‰¾æ“ä½œã€‚åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ä¼šå¼ºåˆ¶å¤–é”®ä½¿ç”¨ç´¢å¼•ï¼Œä½†åœ¨å¤§æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ä¸èƒ½å¿½ç•¥å¤–é”®æ£€æŸ¥å¸¦æ¥çš„å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å½“å¤–é”®çš„é€‰æ‹©æ€§å¾ˆä½æ—¶ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªéå¸¸å¤§ä¸”é€‰æ‹©æ€§ä½çš„ç´¢å¼•ã€‚ å¦‚æœå‘å­è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œå¤–é”®çº¦æŸä¼šè®© InnoDB æ£€æŸ¥å¯¹åº”çš„çˆ¶è¡¨çš„è®°å½•ï¼Œä¹Ÿå°±éœ€è¦å¯¹çˆ¶è¡¨å¯¹åº”è®°å½•è¿›è¡ŒåŠ é”æ“ä½œï¼Œæ¥ç¡®ä¿è¿™æ¡è®°å½•ä¸ä¼šåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆä¹‹æ—¶å°±è¢«åˆ é™¤äº†ã€‚è¿™ä¼šå¯¼è‡´é¢å¤–çš„é”ç­‰å¾…ï¼Œç”šè‡³ä¼šå¯¼è‡´ä¸€äº›æ­»é”ã€‚ é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ•°æ®åº“å¾ˆå®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œè‡ªç„¶è€Œç„¶çš„å°±å¸Œæœ›æ•°æ®åº“å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œè¿™æ—¶å°±éœ€è¦æŠŠæ•°æ®çš„ä¸€è‡´æ€§æ§åˆ¶æ”¾åˆ°åº”ç”¨å±‚ï¼Œä¹Ÿå°±æ˜¯è®©åº”ç”¨æœåŠ¡å™¨å¯ä»¥æ‰¿æ‹…å‹åŠ›ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®åº“å±‚é¢å°±ä¸èƒ½ä½¿ç”¨å¤–é”®ã€‚ å› æ­¤ï¼Œå½“ä¸ç”¨è¿‡å¤šè€ƒè™‘æ•°æ®åº“çš„æ€§èƒ½é—®é¢˜æ—¶ï¼Œæ¯”å¦‚ä¸€äº›å†…éƒ¨é¡¹ç›®æˆ–ä¼ ç»Ÿè¡Œä¸šé¡¹ç›®ï¼ˆå…¶ä½¿ç”¨äººæ•°æœ‰é™ï¼Œè€Œä¸”æ•°æ®é‡ä¸€èˆ¬ä¸ä¼šå¤ªå¤§ï¼‰ï¼Œä½¿ç”¨å¤–é”®æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ¯•ç«Ÿæƒ³è¦ç¡®ä¿ç›¸å…³è¡¨å§‹ç»ˆæœ‰ä¸€è‡´çš„æ•°æ®ï¼Œä½¿ç”¨å¤–é”®è¦æ¯”åœ¨åº”ç”¨ç¨‹åºä¸­æ£€æŸ¥ä¸€è‡´æ€§æ–¹ä¾¿ç®€å•è®¸å¤šï¼Œæ­¤å¤–ï¼Œå¤–é”®åœ¨ç›¸å…³æ•°æ®çš„åˆ é™¤å’Œæ›´æ–°æ“ä½œä¸Šä¹Ÿä¼šæ¯”åœ¨åº”ç”¨ä¸­è¦é«˜æ•ˆã€‚ ç»‘å®šå˜é‡å¯èƒ½å¤§å®¶çœ‹åˆ° â€œç»‘å®šå˜é‡â€ è¿™ä¸ªè¯æ—¶ï¼Œä¼šæœ‰ä¸€ç‚¹é™Œç”Ÿï¼Œæ¢ä¸ªè¯´æ³•å¯èƒ½ä¼šç†Ÿæ‚‰ä¸€äº›ï¼šprepared statementã€‚ç»‘å®šå˜é‡çš„ SQLï¼Œä½¿ç”¨é—®å·æ ‡è®°å¯ä»¥æ¥æ”¶å‚æ•°çš„ä½ç½®ï¼Œå½“çœŸæ­£éœ€è¦æ‰§è¡Œå…·ä½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨å…·ä½“çš„æ•°å€¼ä»£æ›¿è¿™äº›é—®å·ï¼Œæ¯”å¦‚ï¼š12345678910111213SELECT order_no, order_amount FROM sales WHERE order_status = ? and buyer = ?``` ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç»‘å®šå˜é‡ï¼Ÿæ€»æ‰€å‘¨çŸ¥çš„åŸå› æ˜¯å¯ä»¥é¢„å…ˆç¼–è¯‘ï¼Œå‡å°‘ SQL æ³¨å…¥çš„é£é™©ï¼Œé™¤äº†è¿™äº›å‘¢ï¼Ÿå½“åˆ›å»ºä¸€ä¸ªç»‘å®šå˜é‡ SQL æ—¶ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ª SQL è¯­å¥åŸå‹ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ª SQL è¯­å¥çš„æ¡†æ¶åï¼Œè§£æå¹¶å­˜å‚¨è¿™ä¸ª SQL è¯­å¥çš„éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ª SQL è¯­å¥å¤„ç†å¥æŸ„ï¼Œä»æ­¤ä»¥åï¼Œå®¢æˆ·ç«¯é€šè¿‡å‘æœåŠ¡å™¨å‘é€å„ä¸ªé—®å·çš„å–å€¼å’Œè¿™ä¸ªå¥æŸ„æ¥æ‰§è¡Œä¸€ä¸ªå…·ä½“æŸ¥è¯¢ï¼Œè¿™æ ·å°±å¯ä»¥æ›´é«˜æ•ˆåœ°æ‰§è¡Œå¤§é‡é‡å¤è¯­å¥ï¼Œå› ä¸ºï¼š* æœåŠ¡å™¨åªéœ€è¦è§£æä¸€æ¬¡ SQL è¯­å¥* æœåŠ¡å™¨æŸäº›ä¼˜åŒ–å™¨çš„ä¼˜åŒ–å·¥ä½œä¹Ÿåªéœ€è¦åšä¸€æ¬¡ï¼Œå› ä¸º MySQL ä¼šç¼“å­˜éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’* é€šä¿¡ä¸­ä»…ä»…å‘é€çš„æ˜¯å‚æ•°ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè¯­å¥ï¼Œç½‘ç»œå¼€é”€ä¹Ÿä¼šæ›´å°ï¼Œè€Œä¸”ä»¥äºŒè¿›åˆ¶å‘é€å‚æ•°å’Œå¥æŸ„è¦æ¯”å‘é€ ASCII æ–‡æœ¬çš„æ•ˆç‡æ›´é«˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQL å¹¶ä¸æ˜¯æ€»èƒ½ç¼“å­˜æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚æœæŸäº›æ‰§è¡Œè®¡åˆ’éœ€è¦æ ¹æ®å‚å…¥çš„å‚æ•°æ¥è®¡ç®—æ—¶ï¼ŒMySQL å°±æ— æ³•ç¼“å­˜è¿™éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ã€‚æ¯”å¦‚ï¼š```bash-- è¿™é‡Œå‡è£…æœ‰ä¸€ä¸ªä¾‹å­ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ€è€ƒä¸€ä¸‹ ä½¿ç”¨ç»‘å®šå˜é‡çš„æœ€å¤§é™·é˜±æ˜¯ï¼šä½ çŸ¥é“å…¶åŸç†ï¼Œä½†ä¸çŸ¥é“å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚æœ‰æ—¶å€™ï¼Œå¾ˆéš¾è§£é‡Šå¦‚ä¸‹ 3 ç§ç»‘å®šå˜é‡ç±»å‹ä¹‹é—´çš„åŒºåˆ«ï¼š å®¢æˆ·ç«¯æ¨¡æ‹Ÿçš„ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯çš„é©±åŠ¨ç¨‹åºæ¥æ”¶ä¸€ä¸ªå¸¦å‚æ•°çš„ SQLï¼Œå†å°†å‚æ•°çš„å€¼å¸¦å…¥å…¶ä¸­ï¼Œæœ€åå°†å®Œæ•´çš„æŸ¥è¯¢å‘é€åˆ°æœåŠ¡å™¨ã€‚ æœåŠ¡å™¨ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯ä½¿ç”¨ç‰¹æ®Šçš„äºŒè¿›åˆ¶åè®®å°†å¸¦å‚æ•°çš„ SQL è¯­å¥å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œç„¶åä½¿ç”¨äºŒè¿›åˆ¶åè®®å°†å…·ä½“çš„å‚æ•°å€¼å‘é€ç»™æœåŠ¡å™¨å¹¶æ‰§è¡Œã€‚ SQL æ¥å£çš„ç»‘å®šå˜é‡ï¼šå®¢æˆ·ç«¯å…ˆå‘é€ä¸€ä¸ªå¸¦å‚æ•°çš„ SQL è¯­å¥åˆ°æœåŠ¡å™¨ç«¯ï¼Œè¿™ç±»ä¼¼äºä½¿ç”¨preparedçš„ SQL è¯­å¥ï¼Œç„¶åå‘é€è®¾ç½®çš„å‚æ•°ï¼Œæœ€ååœ¨å‘é€executeæŒ‡ä»¤æ¥æ‰§è¡Œ SQLï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯ç”¨æ™®é€šçš„æ–‡æœ¬ä¼ è¾“åè®®ã€‚ æ¯”å¦‚æŸäº›ä¸æ”¯æŒé¢„ç¼–è¯‘çš„ JDBC é©±åŠ¨ï¼Œåœ¨è°ƒç”¨connection.prepareStatement(sql)æ—¶ï¼Œå¹¶ä¸ä¼šæŠŠ SQL è¯­å¥å‘é€ç»™æ•°æ®åº“åšé¢„å¤„ç†ï¼Œè€Œæ˜¯ç­‰åˆ°è°ƒç”¨executeQueryæ–¹æ³•æ—¶æ‰æŠŠæ•´ä¸ªè¯­å¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œè¿™ç§æ–¹å¼å°±ç±»ä¼¼äºç¬¬ 1 ç§æƒ…å†µã€‚å› æ­¤ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨ç»‘å®šå˜é‡æ—¶ï¼Œç†è§£ä½ ä½¿ç”¨çš„é©±åŠ¨é€šè¿‡å“ªç§æ–¹å¼æ¥å®ç°å°±æ˜¾å¾—å¾ˆæœ‰å¿…è¦ã€‚å»¶ä¼¸å¼€æ¥è¯´ï¼Œå¯¹äºè‡ªå·±ä½¿ç”¨çš„æ¡†æ¶ã€å¼€æºå·¥å…·ï¼Œä¸åº”ä»…ä»…åœç•™åœ¨ä¼šä½¿ç”¨è¿™ä¸ªå±‚é¢ï¼Œæœ‰æ—¶é—´å¯ä»¥æ·±å…¥äº†è§£å…¶åŸç†å’Œå®ç°ï¼Œä¸ç„¶æœ‰å¯èƒ½è¢«éª—äº†éƒ½ä¸çŸ¥é“å“¦ã€‚ ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°MySQL æœ¬èº«å†…ç½®äº†éå¸¸å¤šçš„å‡½æ•°ï¼Œæ¯”å¦‚SUMã€COUNTã€AVGç­‰ç­‰ï¼Œå¯å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ›´å¤šã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ›´å¼ºå¤§çš„åŠŸèƒ½éƒ½æ˜¯åœ¨åº”ç”¨å±‚é¢å®ç°ï¼Œä½†å®é™…ä¸Š MySQL ä¹Ÿæä¾›äº†æœºä¼šè®©æˆ‘ä»¬å¯ä»¥å»æ‰©å±• MySQL å‡½æ•°ï¼Œè¿™å°±æ˜¯ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•° (user-defined function)ï¼Œä¹Ÿç§°ä¸ºï¼šUDFã€‚éœ€è¦æ³¨æ„UDFä¸å­˜å‚¨è¿‡ç¨‹å’Œé€šè¿‡ SQL åˆ›å»ºå‡½æ•°çš„åŒºåˆ«ï¼Œå­˜å‚¨è¿‡ç¨‹åªèƒ½ä½¿ç”¨ SQL æ¥ç¼–å†™ï¼Œè€ŒUDFæ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨æ”¯æŒ C è¯­è¨€è°ƒç”¨çº¦å®šçš„ä»»ä½•ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€‚ UDFå¿…é¡»äº‹å…ˆç¼–è¯‘å¥½å¹¶åŠ¨æ€é“¾æ¥åˆ°æœåŠ¡å™¨ä¸Šï¼Œè¿™ç§å¹³å°ç›¸å…³æ€§ä½¿å¾—UDFåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¾ˆå¼ºå¤§ï¼ŒUDFé€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”å¯ä»¥è®¿é—®å¤§é‡æ“ä½œç³»ç»ŸåŠŸèƒ½ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¤§é‡åº“å‡½æ•°ã€‚å¦‚æœéœ€è¦ä¸€ä¸ª MySQL ä¸æ”¯æŒçš„ç»Ÿè®¡èšåˆå‡½æ•°ï¼Œå¹¶ä¸”æ— æ³•ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ¥å®ç°ï¼Œè€Œä¸”è¿˜æƒ³ä¸åŒçš„è¯­è¨€éƒ½å¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆUDFæ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œè‡³å°‘ä¸éœ€è¦æ¯ç§è¯­è¨€éƒ½æ¥å®ç°ç›¸åŒçš„é€»è¾‘ã€‚ æ‰€è°“èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»ä¹Ÿå°±è¶Šå¤§ï¼ŒUDFä¸­çš„ä¸€ä¸ªé”™è¯¯å¯èƒ½ç›´æ¥è®©æœåŠ¡å™¨å´©æºƒï¼Œç”šè‡³æ‰°ä¹±æœåŠ¡å™¨çš„å†…å­˜å’Œæ•°æ®ï¼Œå› æ­¤ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„å…¶æ½œåœ¨çš„é£é™©ã€‚åœ¨ MySQL ç‰ˆæœ¬å‡çº§æ—¶ä¹Ÿéœ€è¦æ³¨æ„ï¼Œå› ä¸ºä½ å¯èƒ½éœ€è¦é‡æ–°ç¼–è¯‘æˆ–è€…ä¿®æ”¹è¿™äº›UDFï¼Œä»¥ä¾¿è®©å®ƒä»¬èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­å·¥ä½œã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥å±•ç¤ºå¦‚ä½•åˆ›å»ºUDFï¼šå°†ç»“æœé›†è½¬åŒ–ä¸º JSONï¼Œå…·ä½“çš„ä»£ç è¯·å‚è€ƒï¼šlib_mysqludf_jsonã€‚1234567891011121314151617181920212223242526-- 1ã€é¦–å…ˆä½¿ç”¨cè¯­è¨€å®ç°åŠŸèƒ½-- 2ã€ç¼–è¯‘-- è¿™é‡Œçœç•¥ç¬¬1ã€2æ­¥ï¼Œå®ç°å¹¶ç¼–è¯‘æˆ.so-- 3ã€ä½¿ç”¨SQLåˆ›å»ºå‡½æ•°DROP FUNCTION json_array;CREATE FUNCTION json_array RETURNS string soname 'lib_mysqludf_json.so';-- 4ã€ä½¿ç”¨å‡½æ•°SELECT json_array( customer_id, first_name, last_name, last_update ) as customerFROM customerWHERE customer_id = 1;/*5ã€å¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š+------------------------------------------+| customer |+------------------------------------------+| [1,"MARY","SMITH","2006-02-15 04:57:20"] |+------------------------------------------+*/ å…¶å¤§è‡´çš„å®ç°æµç¨‹ï¼šä½¿ç”¨ C è¯­è¨€å®ç°é€»è¾‘ -> ç¼–è¯‘æˆ.soæ–‡ä»¶ -> åˆ›å»ºå‡½æ•° -> ä½¿ç”¨å‡½æ•°ã€‚UDFåœ¨å®é™…å·¥ä½œä¸­å¯èƒ½å¾ˆå°‘ä½¿ç”¨ï¼Œä½†ä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬ï¼Œäº†è§£è¿™ä¹ˆä¸€æ¬¾å¼ºå¤§çš„å·¥å…·ï¼Œåœ¨è§£å†³æ£˜æ‰‹é—®é¢˜æ—¶ï¼Œä¹Ÿè®©æˆ‘ä»¬æœ‰äº†æ›´å¤šçš„é€‰æ‹©ã€‚ å­—ç¬¦é›†æœ€åè¯´è¯´å­—ç¬¦é›†ã€‚ å…³äºå­—ç¬¦é›†å¤§å¤šæ•°äººçš„ç¬¬ä¸€å°è±¡å¯èƒ½å°±æ˜¯ï¼šæ•°æ®åº“å­—ç¬¦é›†å°½é‡ä½¿ç”¨UTF8ï¼Œå› ä¸ºUTF8å­—ç¬¦é›†æ˜¯ç›®å‰æœ€é€‚åˆäºå®ç°å¤šç§ä¸åŒå­—ç¬¦é›†ä¹‹é—´çš„è½¬æ¢çš„å­—ç¬¦é›†ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šé¿å…ä¹±ç é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿ä»¥åçš„æ•°æ®è¿ç§»ã€‚But whyï¼Ÿ å­—ç¬¦é›†æ˜¯æŒ‡ä¸€ç§ä»äºŒè¿›åˆ¶ç¼–ç åˆ°æŸç±»å­—ç¬¦ç¬¦å·çš„æ˜ å°„ï¼Œå¯ä»¥å‚è€ƒå¦‚ä½•ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºè‹±æ–‡å­—æ¯ã€‚æ ¡å¯¹è§„åˆ™æ˜¯æŒ‡ä¸€ç»„ç”¨äºæŸä¸ªå­—ç¬¦é›†çš„æ’åºè§„åˆ™ï¼Œå³é‡‡ç”¨ä½•ç§è§„åˆ™å¯¹æŸç±»å­—ç¬¦è¿›è¡Œæ’åºã€‚MySQL æ¯ä¸€ç±»ç¼–ç å­—ç¬¦éƒ½æœ‰å…¶å¯¹åº”çš„å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ã€‚MySQL å¯¹å„ç§å­—ç¬¦é›†çš„æ”¯æŒéƒ½éå¸¸å®Œå–„ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥ä¸€äº›å¤æ‚æ€§ï¼ŒæŸäº›åœºæ™¯ä¸‹ç”šè‡³ä¼šæœ‰ä¸€äº›æ€§èƒ½ç‰ºç‰²ã€‚ ä¸€ç§å­—ç¬¦é›†å¯èƒ½å¯¹åº”å¤šç§æ ¡å¯¹è§„åˆ™ï¼Œä¸”éƒ½æœ‰ä¸€ä¸ªé»˜è®¤æ ¡å¯¹è§„åˆ™ï¼Œé‚£åœ¨ MySQL ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨å­—ç¬¦é›†çš„ï¼Ÿåœ¨ MySQL ä¸­å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è®¾ç½®å­—ç¬¦é›†ï¼šåˆ›å»ºå¯¹è±¡æ—¶è®¾ç½®é»˜è®¤å€¼ã€å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ—¶æ˜¾å¼è®¾ç½®ã€‚ MySQL é‡‡ç”¨ â€œé˜¶æ¢¯â€ å¼çš„æ–¹å¼æ¥è®¾å®šå­—ç¬¦é›†é»˜è®¤å€¼ï¼Œæ¯ä¸ªæ•°æ®åº“ï¼Œæ¯å¼ è¡¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤å€¼ï¼Œå®ƒä»¬é€å±‚ç»§æ‰¿ï¼Œæœ€ç»ˆæœ€é åº•å±‚çš„é»˜è®¤è®¾ç½®å°†å½±å“ä½ åˆ›å»ºçš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œåˆ›å»ºæ•°æ®åº“æ—¶ï¼Œå°†æ ¹æ®æœåŠ¡å™¨ä¸Šçš„character_set_serveræ¥è®¾ç½®æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†ï¼ŒåŒæ ·çš„é“ç†ï¼Œæ ¹æ®databaseçš„å­—ç¬¦é›†æ¥æŒ‡å®šåº“ä¸­æ‰€æœ‰è¡¨çš„å­—ç¬¦é›†â€¦â€¦ ä¸ç®¡æ˜¯å¯¹æ•°æ®åº“ï¼Œè¿˜æ˜¯è¡¨å’Œåˆ—ï¼Œåªæœ‰å½“å®ƒä»¬æ²¡æœ‰æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†æ—¶ï¼Œé»˜è®¤å­—ç¬¦é›†æ‰ä¼šèµ·ä½œç”¨ã€‚ å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨ä¸åŒçš„å­—ç¬¦é›†ï¼Œè¿™æ—¶å€™æœåŠ¡å™¨å°†è¿›è¡Œå¿…è¦çš„è½¬æ¢å·¥ä½œã€‚å½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæ•°æ®ä»¥character_set_clientè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ï¼›è€Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ SQL æˆ–è€…æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§character_set_connectionè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œè½¬æ¢ï¼›å½“æœåŠ¡å™¨å°†è¦è¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰æ“ä½œå‰ä¼šå†æ¬¡å°†æ•°æ®è½¬æ¢æˆcharacter_set_database(æ•°æ®åº“é‡‡ç”¨çš„å­—ç¬¦é›†ï¼Œæ²¡æœ‰å•ç‹¬é…ç½®å³ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œå…·ä½“å‚è€ƒä¸Šæ–‡)ï¼Œæœ€åå½“æœåŠ¡å™¨è¿”å›æ•°æ®æˆ–è€…é”™è¯¯ä¿¡æ¯æ—¶ï¼Œåˆ™å°†æ•°æ®æŒ‰character_set_resultè®¾ç½®çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ã€‚æœåŠ¡å™¨ç«¯å¯ä»¥ä½¿ç”¨SET CHARACTER SETæ¥æ”¹å˜ä¸Šé¢çš„é…ç½®ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ ¹æ®å¯¹åº”çš„ API æ¥æ”¹å˜å­—ç¬¦é›†é…ç½®ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½ä½¿ç”¨æ­£ç¡®çš„å­—ç¬¦é›†æ‰èƒ½é¿å…åœ¨é€šä¿¡ä¸­å‡ºç°é—®é¢˜ã€‚ é‚£å¦‚ä½•é€‰æ‹©å­—ç¬¦é›†åœ¨è€ƒè™‘ä½¿ç”¨ä½•ç§å­—ç¬¦é›†æ—¶ï¼Œæœ€ä¸»è¦çš„è¡¡é‡å› ç´ æ˜¯å­˜å‚¨çš„å†…å®¹ï¼Œåœ¨èƒ½å¤Ÿæ»¡è¶³å­˜å‚¨å†…å®¹çš„å‰æä¸‹ï¼Œå°½é‡ä½¿ç”¨è¾ƒå°çš„å­—ç¬¦é›†ã€‚å› ä¸ºæ›´å°çš„å­—ç¬¦é›†æ„å‘³ç€æ›´å°‘ç©ºé—´å ç”¨ã€ä»¥åŠæ›´é«˜çš„ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼Œä¹Ÿé—´æ¥æé«˜äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚å¦‚æœå­˜å‚¨çš„å†…å®¹æ˜¯è‹±æ–‡å­—ç¬¦ç­‰æ‹‰ä¸è¯­ç³»å­—ç¬¦çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„latin1å­—ç¬¦é›†å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼ˆMySQL 8 é»˜è®¤utf8mb4ï¼‰ï¼Œå¦‚æœéœ€è¦å­˜å‚¨æ±‰å­—ã€ä¿„æ–‡ã€é˜¿æ‹‰ä¼¯è¯­ç­‰éæ‹‰ä¸è¯­ç³»å­—ç¬¦ï¼Œåˆ™å»ºè®®ä½¿ç”¨UTF8å­—ç¬¦é›†ã€‚å½“ç„¶ä¸åŒå­—ç¬¦åœ¨ä½¿ç”¨UTF8å­—ç¬¦é›†æ‰€å ç”¨çš„ç©ºé—´æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚è‹±æ–‡å­—ç¬¦åœ¨UTF8å­—ç¬¦é›†ä¸­åªä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œä¸€ä¸ªæ±‰å­—åˆ™å ç”¨ 3 ä¸ªå­—èŠ‚ã€‚ é™¤äº†å­—ç¬¦é›†ï¼Œæ ¡å¯¹è§„åˆ™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¯¹äºæ ¡å¯¹è§„åˆ™ï¼Œä¸€èˆ¬æ¥è¯´åªéœ€è¦è€ƒè™‘æ˜¯å¦ä»¥å¤§å°å†™æ•æ„Ÿçš„æ–¹å¼æ¯”è¾ƒå­—ç¬¦ä¸²æˆ–è€…æ˜¯å¦ç”¨å­—ç¬¦ä¸²ç¼–ç çš„äºŒè¿›åˆ¶æ¥æ¯”è¾ƒå¤§å°ï¼Œå…¶å¯¹åº”çš„æ ¡å¯¹è§„åˆ™çš„åç¼€åˆ†åˆ«æ˜¯_csã€_ciå’Œ_binã€‚å¤§å°å†™æ•æ„Ÿå’ŒäºŒè¿›åˆ¶æ ¡å¯¹è§„åˆ™çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒäºŒè¿›åˆ¶æ ¡å¯¹è§„åˆ™ç›´æ¥ä½¿ç”¨å­—ç¬¦çš„å­—èŠ‚è¿›è¡Œæ¯”è¾ƒï¼Œè€Œå¤§å°å†™æ•æ„Ÿçš„æ ¡å¯¹è§„åˆ™åœ¨å¤šå­—èŠ‚å­—ç¬¦é›†æ—¶ï¼Œå¦‚å¾·è¯­ï¼Œæœ‰æ›´å¤æ‚çš„æ¯”è¾ƒè§„åˆ™ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ŒUTF8å­—ç¬¦é›†å¯¹åº”æ ¡å¯¹è§„åˆ™æœ‰ä¸‰ç§ï¼š utf8_binå°†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ç”¨äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨ï¼ŒåŒºåˆ†å¤§å°å†™ utf8_general_ciä¸åŒºåˆ†å¤§å°å†™ï¼Œciä¸ºcase insensitiveçš„ç¼©å†™ï¼Œå³å¤§å°å†™ä¸æ•æ„Ÿ utf8_general_csåŒºåˆ†å¤§å°å†™ï¼Œcsä¸ºcase sensitiveçš„ç¼©å†™ï¼Œå³å¤§å°å†™æ•æ„Ÿ æ¯”å¦‚ï¼Œåˆ›å»ºä¸€å¼ è¡¨ï¼Œä½¿ç”¨UTF8ç¼–ç ï¼Œä¸”å¤§å°å†™æ•æ„Ÿæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥ï¼š12345CREATE TABLE sales ( order_no VARCHAR(32) NOT NULL PRIMARY KEY, order_amount INT NOT NULL DEFAULT 0, ......) ENGINE=InnoDB COLLATE=utf8_general_cs; å› æ­¤ï¼Œåœ¨é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨UTF8å­—ç¬¦é›†æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†éœ€è¦è®°ä½çš„æ˜¯ä¸è¦åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ä½¿ç”¨å¤šä¸ªä¸åŒçš„å­—ç¬¦é›†ï¼Œä¸åŒå­—ç¬¦é›†ä¹‹é—´çš„ä¸å…¼å®¹é—®é¢˜å¾ˆéš¾ç¼ ã€‚æœ‰æ—¶å€™ï¼Œçœ‹èµ·æ¥ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯å½“æŸä¸ªç‰¹æ®Šå­—ç¬¦å‡ºç°æ—¶ï¼Œä¸€åˆ‡æ“ä½œéƒ½ä¼šå‡ºé”™ï¼Œè€Œä¸”ä½ å¾ˆéš¾å‘ç°é”™è¯¯çš„åŸå› ã€‚ å­—ç¬¦é›†å¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰å½±å“å—æŸäº›å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™å¯èƒ½ä¼šéœ€è¦å¤šä¸ªçš„ CPU æ“ä½œï¼Œå¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ç©ºé—´ï¼Œè¿™ç‚¹åœ¨å‰æ–‡å·²ç»è¯´è¿‡ã€‚ç‰¹åˆ«æ˜¯åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ä½¿ç”¨ä¸åŒçš„å­—ç¬¦é›†ï¼Œé€ æˆçš„å½±å“å¯èƒ½ä¼šæ›´å¤§ã€‚ ä¸åŒå­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ä¹‹é—´çš„è½¬æ¢å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿå¼€é”€ï¼Œæ¯”å¦‚ï¼Œæ•°æ®è¡¨salesåœ¨buyerå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼Œåˆ™å¯ä»¥åŠ é€Ÿä¸‹é¢çš„ORDER BYæ“ä½œï¼š1SELECT order_no,order_amount FROM sales ORDER BY buyer; åªæœ‰å½“ SQL æŸ¥è¯¢ä¸­æ’åºè¦æ±‚çš„å­—ç¬¦é›†ä¸æœåŠ¡å™¨æ•°æ®çš„å­—ç¬¦é›†ç›¸åŒæ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™ä¸æ˜¯åºŸè¯å—ï¼Ÿå…¶å®ä¸ç„¶ï¼ŒMySQL æ˜¯å¯ä»¥å•ç‹¬æŒ‡å®šæ’åºæ—¶ä½¿ç”¨çš„æ ¡å¯¹è§„åˆ™çš„ï¼Œæ¯”å¦‚ï¼š123-- ä½ è¯´ï¼Œè¿™ä¸æ˜¯åƒé¥±äº†æ’‘çš„å—ï¼Ÿæˆ‘è§‰å¾—ä¹Ÿæ˜¯ï¼Œä¹Ÿè®¸ä¼šæœ‰å…¶é€‚ç”¨çš„åœºæ™¯å§-- è¿™æ—¶å€™å°±ä¸èƒ½ä½¿ç”¨ç´¢å¼•æ’åºå‘¢ï¼Œåªèƒ½ä½¿ç”¨æ–‡ä»¶æ’åºSELECT order_no,order_amount FROM sales ORDER BY buyer COLLATE utf8_bin; å½“ä½¿ç”¨ä¸¤ä¸ªå­—ç¬¦é›†ä¸åŒçš„åˆ—æ¥å…³è”ä¸¤å¼ è¡¨æ—¶ï¼ŒMySQL ä¼šå°è¯•è½¬æ¢å…¶ä¸­ä¸€ä¸ªåˆ—çš„å­—ç¬¦é›†ã€‚è¿™å’Œåœ¨æ•°æ®åˆ—å¤–é¢å°è£…ä¸€ä¸ªå‡½æ•°ä¸€æ ·ï¼Œä¼šè®© MySQL æ— æ³•ä½¿ç”¨è¿™ä¸ªåˆ—ä¸Šçš„ç´¢å¼•ã€‚å…³äº MySQL å­—ç¬¦é›†è¿˜æœ‰ä¸€äº›å‘ï¼Œä½†åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­é‡åˆ°çš„å­—ç¬¦é›†é—®é¢˜ï¼Œå…¶å®ä¸æ˜¯ç‰¹åˆ«çš„å¤šï¼Œæ‰€ä»¥å°±æ­¤æ‰“ä½ã€‚ ç»“è¯­MySQL è¿˜æœ‰ä¸€äº›å…¶ä»–é«˜çº§ç‰¹æ€§ï¼Œä½†åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬å¾ˆå°‘ä¼šä½¿ç”¨ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæ²¡æœ‰è®¨è®ºï¼Œä½†å¤šäº†è§£ä¸€äº›æ€»æ˜¯å¥½çš„ï¼Œè‡³å°‘åœ¨éœ€è¦çš„æ—¶å€™ï¼Œä½ çŸ¥é“æœ‰è¿™æ ·ä¸€ä¸ªä¸œè¥¿ã€‚æˆ‘ä»¬éå¸¸å¤šçš„äººï¼Œæ€»æ˜¯ä¼šè®¤ä¸ºè‡ªå·±æ‰€å­¦çš„çŸ¥è¯†å°±åƒç¢ç‰‡ä¸€æ ·ä¸æˆä½“ç³»ï¼Œåˆæ‰¾ä¸åˆ°è§£å†³åŠæ³•ï¼Œé‚£ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¹Ÿè®¸æ˜¯ç¢ç‰‡ä¸å¤Ÿå¤šçš„ç¼˜æ•…ï¼Ÿç‚¹å¤ªå°‘ï¼Œè‡ªç„¶ä¸èƒ½è¿æ¥æˆçº¿ï¼Œçº¿å¤ªå°‘ï¼Œè‡ªç„¶ä¸èƒ½ç»“æˆç½‘ã€‚å› è€Œï¼Œæ²¡æœ‰å…¶ä»–åŠæ³•ï¼Œä¿æŒå¥½å¥‡å¿ƒã€å¤šå­¦ä¹ ã€å¤šç§¯ç´¯ï¼Œé‡å˜æ€»æœ‰ä¸€å¤©ä¼šè´¨å˜ã€‚ å‰é¢æˆ‘å†™çš„ä¸€äº›æ–‡ç« é‡Œé¢ä¼šæœ‰æåˆ°è¿‡ï¼Œæ¶æ„è®¾è®¡æ˜¯ä¸€ç§å¹³è¡¡çš„è‰ºæœ¯ï¼Œå…¶å®è´¨åº”è¯¥æ˜¯ä¸€ç§å¦¥åï¼Œæ˜¯å¯¹ç°æœ‰èµ„æºçš„ä¸€ç§å¦¥åã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¼šä¸è‡ªè§‰çš„é™·å…¥æŸä¸€ä¸ªç‚¹ï¼Œæ¯”å¦‚ï¼Œä¸ºäº†è¿½æ±‚æ•°æ®çš„æ‰©å±•æ€§ï¼Œå¾ˆå¤šäººä¸€ä¸Šæ¥å°±å¼€å§‹åˆ†åº“åˆ†è¡¨ï¼Œç„¶åæŠŠåº”ç”¨æå¾—éå¸¸å¤æ‚ï¼Œåˆ°æœ€åè¡¨é‡Œè¿˜æ²¡æœ‰è£…æ»¡æ•°æ®ï¼Œé¡¹ç›®å°±å·²ç»æ­»äº†ã€‚æ‰€ä»¥åœ¨èµ„æºæœ‰é™æˆ–è€…æœªæ¥è¿˜ä¸å¯çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨æ•°æ®åº“ã€è¯­è¨€æœ¬èº«çš„ç‰¹æ€§æ¥å®Œæˆç›¸åº”çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯ä¼šæ›´å¥½ä¸€ç‚¹ã€‚è§£å†³å¤§æ•°æ®é—®é¢˜ï¼Œä¹Ÿä¸åªæ˜¯åˆ†åº“åˆ†è¡¨ï¼Œä½ è¿˜åº”è¯¥è¿˜å¯ä»¥æƒ³åˆ°åˆ†åŒºï¼›æœ‰äº›ä¸šåŠ¡å³ä½¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¹Ÿä¸ä¸€å®šéè¦åœ¨ä¸šåŠ¡å±‚å®Œæˆï¼Œåˆç†ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨æˆ–è€…ä½¿ç”¨è‡ªå·±æ ¹æ®åˆ†è¡¨åˆ†åº“è§„åˆ™çš„å°å·¥å…·ä¹Ÿè®¸ä¼šè®©ä½ æ›´è½»æ¾â€¦â€¦ å‚è€ƒèµ„æ–™é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL ä¼˜åŒ–åŸç†(ä¸€)]]></title>
    <url>%2F2019%2F03%2F29%2Fmysql-optimization-principle-1%2F</url>
    <content type="text"><![CDATA[æ‰«åœ°åªä¸è¿‡æ˜¯æˆ‘diè¡¨é¢å·¥ä½œï¼Œæˆ‘çœŸæ­£dièº«ä»½æ˜¯ä¸€ä½ç ”ç©¶â€”â€”åƒ§ã€‚ å‰è¨€è¯´èµ· MySQL çš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶æ”¶è—äº†ä¸€å †å¥‡æŠ€æ·«å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨ NULL å­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦â€¦ ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿæˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚ MySQL é€»è¾‘æ¶æ„å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹… MySQL å„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£ MySQL æœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº† MySQL çš„é€»è¾‘æ¶æ„å›¾ã€‚ MySQL é€»è¾‘æ¶æ„æ•´ä½“åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€ä¸Šå±‚ä¸ºå®¢æˆ·ç«¯å±‚ï¼Œå¹¶é MySQL æ‰€ç‹¬æœ‰ï¼Œè¯¸å¦‚ï¼šè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€å®‰å…¨ç­‰åŠŸèƒ½å‡åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚ MySQL å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡å‡åœ¨ä¸­é—´è¿™ä¸€å±‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢è§£æã€åˆ†æã€ä¼˜åŒ–ã€ç¼“å­˜ã€å†…ç½®å‡½æ•° (æ¯”å¦‚ï¼šæ—¶é—´ã€æ•°å­¦ã€åŠ å¯†ç­‰å‡½æ•°)ã€‚æ‰€æœ‰çš„è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼šå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚ æœ€ä¸‹å±‚ä¸ºå­˜å‚¨å¼•æ“ï¼Œå…¶è´Ÿè´£ MySQL ä¸­çš„æ•°æ®å­˜å‚¨å’Œæå–ã€‚å’Œ Linux ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¯ç§å­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ä¸­é—´çš„æœåŠ¡å±‚é€šè¿‡ API ä¸å­˜å‚¨å¼•æ“é€šä¿¡ï¼Œè¿™äº› API æ¥å£å±è”½äº†ä¸åŒå­˜å‚¨å¼•æ“é—´çš„å·®å¼‚ã€‚ MySQL æŸ¥è¯¢è¿‡ç¨‹æˆ‘ä»¬æ€»æ˜¯å¸Œæœ› MySQL èƒ½å¤Ÿè·å¾—æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å¼„æ¸…æ¥š MySQL æ˜¯å¦‚ä½•ä¼˜åŒ–å’Œæ‰§è¡ŒæŸ¥è¯¢çš„ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°ï¼šå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®© MySQL çš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚ å½“å‘ MySQL å‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒMySQL åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ å®¢æˆ·ç«¯ / æœåŠ¡ç«¯é€šä¿¡åè®®MySQL å®¢æˆ·ç«¯ / æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯ â€œåŠåŒå·¥â€ çš„ï¼šåœ¨ä»»ä¸€æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚ å®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®max_allowed_packetå‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ ä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨SELECT *ä»¥åŠåŠ ä¸ŠLIMITé™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚ æŸ¥è¯¢ç¼“å­˜åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆ MySQL ä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚ MySQL å°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆä¸è¦ç†è§£æˆtableï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç±»ä¼¼äºHashMapçš„æ•°æ®ç»“æ„ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚ å¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€MySQL åº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°NOW()æˆ–è€…CURRENT_DATE()ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«CURRENT_USERæˆ–è€…CONNECION_ID()çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚ æ—¢ç„¶æ˜¯ç¼“å­˜ï¼Œå°±ä¼šå¤±æ•ˆï¼Œé‚£æŸ¥è¯¢ç¼“å­˜ä½•æ—¶å¤±æ•ˆå‘¢ï¼ŸMySQL çš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQL å¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ï¼š ä»»ä½•çš„æŸ¥è¯¢è¯­å¥åœ¨å¼€å§‹ä¹‹å‰éƒ½å¿…é¡»ç»è¿‡æ£€æŸ¥ï¼Œå³ä½¿è¿™æ¡ SQL è¯­å¥æ°¸è¿œä¸ä¼šå‘½ä¸­ç¼“å­˜ å¦‚æœæŸ¥è¯¢ç»“æœå¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€— åŸºäºæ­¤ï¼Œæˆ‘ä»¬è¦çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†è¦å¦‚ä½•è¯„ä¼°æ‰“å¼€ç¼“å­˜æ˜¯å¦èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½æå‡æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…ï¼Œä¹Ÿä¸åœ¨æœ¬æ–‡è®¨è®ºçš„èŒƒç•´å†…ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡ æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥ åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚ å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜ æœ€åçš„å¿ å‘Šæ˜¯ä¸è¦è½»æ˜“æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯å†™å¯†é›†å‹åº”ç”¨ã€‚å¦‚æœä½ å®åœ¨æ˜¯å¿ä¸ä½ï¼Œå¯ä»¥å°†query_cache_typeè®¾ç½®ä¸ºDEMANDï¼Œè¿™æ—¶åªæœ‰åŠ å…¥SQL_CACHEçš„æŸ¥è¯¢æ‰ä¼šèµ°ç¼“å­˜ï¼Œå…¶ä»–æŸ¥è¯¢åˆ™ä¸ä¼šï¼Œè¿™æ ·å¯ä»¥éå¸¸è‡ªç”±åœ°æ§åˆ¶å“ªäº›æŸ¥è¯¢éœ€è¦è¢«ç¼“å­˜ã€‚ å½“ç„¶æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿæœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œè®¨è®ºçš„ä¹Ÿåªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–æ›´æ·±å…¥çš„è¯é¢˜ï¼Œæ¯”å¦‚ï¼šç¼“å­˜æ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„ï¼Ÿå¦‚ä½•æ§åˆ¶å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Ÿäº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜æœ‰ä½•å½±å“ç­‰ç­‰ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæƒå½“æŠ›ç –å¼•ç‰å§ã€‚ è¯­æ³•è§£æå’Œé¢„å¤„ç†MySQL é€šè¿‡å…³é”®å­—å°† SQL è¯­å¥è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æã€‚æ¯”å¦‚ SQL ä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ® MySQL è§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ã€‚æ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ç­‰ã€‚ æŸ¥è¯¢ä¼˜åŒ–ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚ MySQL ä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨ MySQL å¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚123456789mysql> select * from t_message limit 10;...çœç•¥ç»“æœé›†mysql> show status like 'last_query_cost';+-----------------+-------------+| Variable_name | Value |+-----------------+-------------+| Last_query_cost | 6391.799000 |+-----------------+-------------+ ç¤ºä¾‹ä¸­çš„ç»“æœè¡¨ç¤ºä¼˜åŒ–å™¨è®¤ä¸ºå¤§æ¦‚éœ€è¦åš 6391 ä¸ªæ•°æ®é¡µçš„éšæœºæŸ¥æ‰¾æ‰èƒ½å®Œæˆä¸Šé¢çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç»“æœæ˜¯æ ¹æ®ä¸€äº›åˆ—çš„ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å¾—æ¥çš„ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼šæ¯å¼ è¡¨æˆ–è€…ç´¢å¼•çš„é¡µé¢ä¸ªæ•°ã€ç´¢å¼•çš„åŸºæ•°ã€ç´¢å¼•å’Œæ•°æ®è¡Œçš„é•¿åº¦ã€ç´¢å¼•çš„åˆ†å¸ƒæƒ…å†µç­‰ç­‰ã€‚ æœ‰éå¸¸å¤šçš„åŸå› ä¼šå¯¼è‡´ MySQL é€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ã€ä¸ä¼šè€ƒè™‘ä¸å—å…¶æ§åˆ¶çš„æ“ä½œæˆæœ¬ï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€MySQL è®¤ä¸ºçš„æœ€ä¼˜è·Ÿæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼ˆæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½† MySQL åªé€‰æ‹©å®ƒè®¤ä¸ºæˆæœ¬å°çš„ï¼Œä½†æˆæœ¬å°å¹¶ä¸æ„å‘³ç€æ‰§è¡Œæ—¶é—´çŸ­ï¼‰ç­‰ç­‰ã€‚ MySQL çš„æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éƒ¨ä»¶ï¼Œå®ƒä½¿ç”¨äº†éå¸¸å¤šçš„ä¼˜åŒ–ç­–ç•¥æ¥ç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼š é‡æ–°å®šä¹‰è¡¨çš„å…³è”é¡ºåºï¼ˆå¤šå¼ è¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œå¹¶ä¸ä¸€å®šæŒ‰ç…§ SQL ä¸­æŒ‡å®šçš„é¡ºåºè¿›è¡Œï¼Œä½†æœ‰ä¸€äº›æŠ€å·§å¯ä»¥æŒ‡å®šå…³è”é¡ºåºï¼‰ ä¼˜åŒ–MIN()å’ŒMAX()å‡½æ•°ï¼ˆæ‰¾æŸåˆ—çš„æœ€å°å€¼ï¼Œå¦‚æœè¯¥åˆ—æœ‰ç´¢å¼•ï¼Œåªéœ€è¦æŸ¥æ‰¾ B+Tree ç´¢å¼•æœ€å·¦ç«¯ï¼Œåä¹‹åˆ™å¯ä»¥æ‰¾åˆ°æœ€å¤§å€¼ï¼Œå…·ä½“åŸç†è§ä¸‹æ–‡ï¼‰ æå‰ç»ˆæ­¢æŸ¥è¯¢ï¼ˆæ¯”å¦‚ï¼šä½¿ç”¨ Limit æ—¶ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ•°é‡çš„ç»“æœé›†åä¼šç«‹å³ç»ˆæ­¢æŸ¥è¯¢ï¼‰ ä¼˜åŒ–æ’åºï¼ˆåœ¨è€ç‰ˆæœ¬ MySQL ä¼šä½¿ç”¨ä¸¤æ¬¡ä¼ è¾“æ’åºï¼Œå³å…ˆè¯»å–è¡ŒæŒ‡é’ˆå’Œéœ€è¦æ’åºçš„å­—æ®µåœ¨å†…å­˜ä¸­å¯¹å…¶æ’åºï¼Œç„¶åå†æ ¹æ®æ’åºç»“æœå»è¯»å–æ•°æ®è¡Œï¼Œè€Œæ–°ç‰ˆæœ¬é‡‡ç”¨çš„æ˜¯å•æ¬¡ä¼ è¾“æ’åºï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡è¯»å–æ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç„¶åæ ¹æ®ç»™å®šçš„åˆ—æ’åºã€‚å¯¹äº I/O å¯†é›†å‹åº”ç”¨ï¼Œæ•ˆç‡ä¼šé«˜å¾ˆå¤šï¼‰ éšç€ MySQL çš„ä¸æ–­å‘å±•ï¼Œä¼˜åŒ–å™¨ä½¿ç”¨çš„ä¼˜åŒ–ç­–ç•¥ä¹Ÿåœ¨ä¸æ–­çš„è¿›åŒ–ï¼Œè¿™é‡Œä»…ä»…ä»‹ç»å‡ ä¸ªéå¸¸å¸¸ç”¨ä¸”å®¹æ˜“ç†è§£çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå…¶ä»–çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¤§å®¶è‡ªè¡ŒæŸ¥é˜…å§ã€‚ æŸ¥è¯¢æ‰§è¡Œå¼•æ“åœ¨å®Œæˆè§£æå’Œä¼˜åŒ–é˜¶æ®µä»¥åï¼ŒMySQL ä¼šç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œå¼•æ“æ ¹æ®æ‰§è¡Œè®¡åˆ’ç»™å‡ºçš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œå¾—å‡ºç»“æœã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„å¤§éƒ¨åˆ†æ“ä½œå‡æ˜¯é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£æ¥å®Œæˆï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸ºhandler APIã€‚æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ¯ä¸€å¼ è¡¨ç”±ä¸€ä¸ªhandlerå®ä¾‹è¡¨ç¤ºã€‚å®é™…ä¸Šï¼ŒMySQL åœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µå°±ä¸ºæ¯ä¸€å¼ è¡¨åˆ›å»ºäº†ä¸€ä¸ªhandlerå®ä¾‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®è¿™äº›å®ä¾‹çš„æ¥å£æ¥è·å–è¡¨çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„æ‰€æœ‰åˆ—åã€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚å­˜å‚¨å¼•æ“æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å…¶åº•å±‚ä»…æœ‰å‡ åä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£åƒæ­ç§¯æœ¨ä¸€æ ·å®Œæˆäº†ä¸€æ¬¡æŸ¥è¯¢çš„å¤§éƒ¨åˆ†æ“ä½œã€‚ è¿”å›ç»“æœç»™å®¢æˆ·ç«¯æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼ŒMySQL ä»ç„¶ä¼šè¿”å›è¿™ä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚è¯¥æŸ¥è¯¢å½±å“åˆ°çš„è¡Œæ•°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰ç­‰ã€‚ å¦‚æœæŸ¥è¯¢ç¼“å­˜è¢«æ‰“å¼€ä¸”è¿™ä¸ªæŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼ŒMySQL ä¹Ÿä¼šå°†ç»“æœå­˜æ”¾åˆ°ç¼“å­˜ä¸­ã€‚ ç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ä¸”é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚æœ‰å¯èƒ½ MySQL åœ¨ç”Ÿæˆç¬¬ä¸€æ¡ç»“æœæ—¶ï¼Œå°±å¼€å§‹å‘å®¢æˆ·ç«¯é€æ­¥è¿”å›ç»“æœé›†äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±æ— é¡»å­˜å‚¨å¤ªå¤šç»“æœè€Œæ¶ˆè€—è¿‡å¤šå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®©å®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›ç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œéƒ½ä¼šä»¥ä¸€ä¸ªæ»¡è¶³ â‘  ä¸­æ‰€æè¿°çš„é€šä¿¡åè®®çš„æ•°æ®åŒ…å‘é€ï¼Œå†é€šè¿‡ TCP åè®®è¿›è¡Œä¼ è¾“ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¹ MySQL çš„æ•°æ®åŒ…è¿›è¡Œç¼“å­˜ç„¶åæ‰¹é‡å‘é€ã€‚ å›å¤´æ€»ç»“ä¸€ä¸‹ MySQL æ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼š å®¢æˆ·ç«¯å‘ MySQL æœåŠ¡å™¨å‘é€ä¸€æ¡æŸ¥è¯¢è¯·æ±‚ æœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç«‹åˆ»è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœã€‚å¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ æœåŠ¡å™¨è¿›è¡Œ SQL è§£æã€é¢„å¤„ç†ã€å†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ MySQL æ ¹æ®æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„ API æ¥æ‰§è¡ŒæŸ¥è¯¢ å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ç¼“å­˜æŸ¥è¯¢ç»“æœ æ€§èƒ½ä¼˜åŒ–å»ºè®®çœ‹äº†è¿™ä¹ˆå¤šï¼Œä½ å¯èƒ½ä¼šæœŸå¾…ç»™å‡ºä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œæ˜¯çš„ï¼Œä¸‹é¢ä¼šä» 3 ä¸ªä¸åŒæ–¹é¢ç»™å‡ºä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ä½†è¯·ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€å¥å¿ å‘Šè¦å…ˆé€ç»™ä½ ï¼šä¸è¦å¬ä¿¡ä½ çœ‹åˆ°çš„å…³äºä¼˜åŒ–çš„ â€œç»å¯¹çœŸç†â€ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ‰€è®¨è®ºçš„å†…å®¹ï¼Œè€Œåº”è¯¥æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸‹é€šè¿‡æµ‹è¯•æ¥éªŒè¯ä½ å…³äºæ‰§è¡Œè®¡åˆ’ä»¥åŠå“åº”æ—¶é—´çš„å‡è®¾ã€‚ Scheme è®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ– é€‰æ‹©æ•°æ®ç±»å‹åªè¦éµå¾ªå°è€Œç®€å•çš„åŸåˆ™å°±å¥½ï¼Œè¶Šå°çš„æ•°æ®ç±»å‹é€šå¸¸ä¼šæ›´å¿«ï¼Œå ç”¨æ›´å°‘çš„ç£ç›˜ã€å†…å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„ CPU å‘¨æœŸä¹Ÿæ›´å°‘ã€‚è¶Šç®€å•çš„æ•°æ®ç±»å‹åœ¨è®¡ç®—æ—¶éœ€è¦æ›´å°‘çš„ CPU å‘¨æœŸï¼Œæ¯”å¦‚ï¼Œæ•´å‹å°±æ¯”å­—ç¬¦æ“ä½œä»£ä»·ä½ï¼Œå› è€Œä¼šä½¿ç”¨æ•´å‹æ¥å­˜å‚¨ IP åœ°å€ï¼Œä½¿ç”¨DATETIMEæ¥å­˜å‚¨æ—¶é—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ã€‚ è¿™é‡Œæ€»ç»“å‡ ä¸ªå¯èƒ½å®¹æ˜“ç†è§£é”™è¯¯çš„æŠ€å·§ï¼š é€šå¸¸æ¥è¯´æŠŠå¯ä¸ºNULLçš„åˆ—æ”¹ä¸ºNOT NULLä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå°‘å¸®åŠ©ï¼Œåªæ˜¯å¦‚æœè®¡åˆ’åœ¨åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå°±åº”è¯¥å°†è¯¥åˆ—è®¾ç½®ä¸ºNOT NULLã€‚ å¯¹æ•´æ•°ç±»å‹æŒ‡å®šå®½åº¦ï¼Œæ¯”å¦‚INT(11)ï¼Œæ²¡æœ‰ä»»ä½•åµç”¨ã€‚INTä½¿ç”¨ 32 ä½ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰å­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒçš„è¡¨ç¤ºèŒƒå›´å·²ç»ç¡®å®šï¼Œæ‰€ä»¥INT(1)å’ŒINT(20)å¯¹äºå­˜å‚¨å’Œè®¡ç®—æ˜¯ç›¸åŒçš„ã€‚ UNSIGNEDè¡¨ç¤ºä¸å…è®¸è´Ÿå€¼ï¼Œå¤§è‡´å¯ä»¥ä½¿æ­£æ•°çš„ä¸Šé™æé«˜ä¸€å€ã€‚æ¯”å¦‚TINYINTå­˜å‚¨èŒƒå›´æ˜¯ -128 ~ 127ï¼Œè€ŒUNSIGNED TINYINTå­˜å‚¨çš„èŒƒå›´å´æ˜¯ 0 - 255ã€‚ é€šå¸¸æ¥è®²ï¼Œæ²¡æœ‰å¤ªå¤§çš„å¿…è¦ä½¿ç”¨DECIMALæ•°æ®ç±»å‹ã€‚å³ä½¿æ˜¯åœ¨éœ€è¦å­˜å‚¨è´¢åŠ¡æ•°æ®æ—¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨BIGINTã€‚æ¯”å¦‚éœ€è¦ç²¾ç¡®åˆ°ä¸‡åˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ•°æ®ä¹˜ä»¥ä¸€ç™¾ä¸‡ç„¶åä½¿ç”¨BIGINTå­˜å‚¨ã€‚è¿™æ ·å¯ä»¥é¿å…æµ®ç‚¹æ•°è®¡ç®—ä¸å‡†ç¡®å’ŒDECIMALç²¾ç¡®è®¡ç®—ä»£ä»·é«˜çš„é—®é¢˜ã€‚ TIMESTAMPä½¿ç”¨ 4 ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ï¼ŒDATETIMEä½¿ç”¨ 8 ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ã€‚å› è€Œï¼ŒTIMESTAMPåªèƒ½è¡¨ç¤º 1970 - 2038 å¹´ï¼Œæ¯”DATETIMEè¡¨ç¤ºçš„èŒƒå›´å°å¾—å¤šï¼Œè€Œä¸”TIMESTAMPçš„å€¼å› æ—¶åŒºä¸åŒè€Œä¸åŒã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹æ²¡æœ‰ä½¿ç”¨æšä¸¾ç±»å‹çš„å¿…è¦ï¼Œå…¶ä¸­ä¸€ä¸ªç¼ºç‚¹æ˜¯æšä¸¾çš„å­—ç¬¦ä¸²åˆ—è¡¨æ˜¯å›ºå®šçš„ï¼Œæ·»åŠ å’Œåˆ é™¤å­—ç¬¦ä¸²ï¼ˆæšä¸¾é€‰é¡¹ï¼‰å¿…é¡»ä½¿ç”¨ALTER TABLEï¼ˆå¦‚æœåªåªæ˜¯åœ¨åˆ—è¡¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œä¸éœ€è¦é‡å»ºè¡¨ï¼‰ã€‚ schema çš„åˆ—ä¸è¦å¤ªå¤šã€‚åŸå› æ˜¯å­˜å‚¨å¼•æ“çš„ API å·¥ä½œæ—¶éœ€è¦åœ¨æœåŠ¡å™¨å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¹‹é—´é€šè¿‡è¡Œç¼“å†²æ ¼å¼æ‹·è´æ•°æ®ï¼Œç„¶ååœ¨æœåŠ¡å™¨å±‚å°†ç¼“å†²å†…å®¹è§£ç æˆå„ä¸ªåˆ—ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚å¦‚æœåˆ—å¤ªå¤šè€Œå®é™…ä½¿ç”¨çš„åˆ—åˆå¾ˆå°‘çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ CPU å ç”¨è¿‡é«˜ã€‚ å¤§è¡¨ALTER TABLEéå¸¸è€—æ—¶ï¼ŒMySQL æ‰§è¡Œå¤§éƒ¨åˆ†ä¿®æ”¹è¡¨ç»“æœæ“ä½œçš„æ–¹æ³•æ˜¯ç”¨æ–°çš„ç»“æ„åˆ›å»ºä¸€ä¸ªå¼ ç©ºè¡¨ï¼Œä»æ—§è¡¨ä¸­æŸ¥å‡ºæ‰€æœ‰çš„æ•°æ®æ’å…¥æ–°è¡¨ï¼Œç„¶åå†åˆ é™¤æ—§è¡¨ã€‚å°¤å…¶å½“å†…å­˜ä¸è¶³è€Œè¡¨åˆå¾ˆå¤§ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤§ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè€—æ—¶æ›´ä¹…ã€‚å½“ç„¶æœ‰ä¸€äº›å¥‡æŠ€æ·«å·§å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…ã€‚ åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•ç´¢å¼•æ˜¯æé«˜ MySQL æŸ¥è¯¢æ€§èƒ½çš„ä¸€ä¸ªé‡è¦é€”å¾„ï¼Œä½†è¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šå¯¼è‡´è¿‡é«˜çš„ç£ç›˜ä½¿ç”¨ç‡ä»¥åŠè¿‡é«˜çš„å†…å­˜å ç”¨ï¼Œä»è€Œå½±å“åº”ç”¨ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚åº”å½“å°½é‡é¿å…äº‹åæ‰æƒ³èµ·æ·»åŠ ç´¢å¼•ï¼Œå› ä¸ºäº‹åå¯èƒ½éœ€è¦ç›‘æ§å¤§é‡çš„ SQL æ‰èƒ½å®šä½åˆ°é—®é¢˜æ‰€åœ¨ï¼Œè€Œä¸”æ·»åŠ ç´¢å¼•çš„æ—¶é—´è‚¯å®šæ˜¯è¿œå¤§äºåˆå§‹æ·»åŠ ç´¢å¼•æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯è§ç´¢å¼•çš„æ·»åŠ ä¹Ÿæ˜¯éå¸¸æœ‰æŠ€æœ¯å«é‡çš„ã€‚ æ¥ä¸‹æ¥å°†å‘ä½ å±•ç¤ºä¸€ç³»åˆ—åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•çš„ç­–ç•¥ï¼Œä»¥åŠæ¯æ¡ç­–ç•¥å…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸ç´¢å¼•ç›¸å…³çš„ä¸€äº›ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå°†æœ‰åŠ©äºæ›´å¥½çš„ç†è§£åæ–‡çš„å†…å®¹ã€‚ ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³• é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„ç´¢å¼•æ˜¯æŒ‡B-Treeç´¢å¼•ï¼Œå®ƒæ˜¯ç›®å‰å…³ç³»å‹æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®æœ€ä¸ºå¸¸ç”¨å’Œæœ‰æ•ˆçš„ç´¢å¼•ï¼Œå¤§å¤šæ•°å­˜å‚¨å¼•æ“éƒ½æ”¯æŒè¿™ç§ç´¢å¼•ã€‚ä½¿ç”¨B-Treeè¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯å› ä¸º MySQL åœ¨CREATE TABLEæˆ–å…¶å®ƒè¯­å¥ä¸­ä½¿ç”¨äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½†å®é™…ä¸Šä¸åŒçš„å­˜å‚¨å¼•æ“å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ InnoDB å°±æ˜¯ä½¿ç”¨çš„æ˜¯å®ƒçš„å˜ç§B+Treeã€‚ B+Treeä¸­çš„ B æ˜¯æŒ‡balanceï¼Œæ„ä¸ºå¹³è¡¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒB + æ ‘ç´¢å¼•å¹¶ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªç»™å®šé”®å€¼çš„å…·ä½“è¡Œï¼Œå®ƒæ‰¾åˆ°çš„åªæ˜¯è¢«æŸ¥æ‰¾æ•°æ®è¡Œæ‰€åœ¨çš„é¡µï¼Œæ¥ç€æ•°æ®åº“ä¼šæŠŠé¡µè¯»å…¥åˆ°å†…å­˜ï¼Œå†åœ¨å†…å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œæœ€åå¾—åˆ°è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚ åœ¨ä»‹ç»B+Treeå‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œå…¶å·¦å­æ ‘çš„å€¼æ€»æ˜¯å°äºæ ¹çš„å€¼ï¼Œå³å­æ ‘çš„å€¼æ€»æ˜¯å¤§äºæ ¹çš„å€¼ï¼Œå¦‚ä¸‹å›¾ â‘ ã€‚å¦‚æœè¦åœ¨è¿™è¯¾æ ‘ä¸­æŸ¥æ‰¾å€¼ä¸º 5 çš„è®°å½•ï¼Œå…¶å¤§è‡´æµç¨‹ï¼šå…ˆæ‰¾åˆ°æ ¹ï¼Œå…¶å€¼ä¸º 6ï¼Œå¤§äº 5ï¼Œæ‰€ä»¥æŸ¥æ‰¾å·¦å­æ ‘ï¼Œæ‰¾åˆ° 3ï¼Œè€Œ 5 å¤§äº 3ï¼Œæ¥ç€æ‰¾ 3 çš„å³å­æ ‘ï¼Œæ€»å…±æ‰¾äº† 3 æ¬¡ã€‚åŒæ ·çš„æ–¹æ³•ï¼Œå¦‚æœæŸ¥æ‰¾å€¼ä¸º 8 çš„è®°å½•ï¼Œä¹Ÿéœ€è¦æŸ¥æ‰¾ 3 æ¬¡ã€‚æ‰€ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸º (3 + 3 + 3 + 2 + 2 + 1) / 6 = 2.3 æ¬¡ï¼Œè€Œé¡ºåºæŸ¥æ‰¾çš„è¯ï¼ŒæŸ¥æ‰¾å€¼ä¸º 2 çš„è®°å½•ï¼Œä»…éœ€è¦ 1 æ¬¡ï¼Œä½†æŸ¥æ‰¾å€¼ä¸º 8 çš„è®°å½•åˆ™éœ€è¦ 6 æ¬¡ï¼Œæ‰€ä»¥é¡ºåºæŸ¥æ‰¾çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸ºï¼š(1 + 2 + 3 + 4 + 5 + 6) / 6 = 3.3 æ¬¡ï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾é€Ÿåº¦æ¯”é¡ºåºæŸ¥æ‰¾è¦å¿«ã€‚ ç”±äºäºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥ä»»æ„æ„é€ ï¼ŒåŒæ ·çš„å€¼ï¼Œå¯ä»¥æ„é€ å‡ºå¦‚å›¾ â‘¡ çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¾ç„¶è¿™æ£µäºŒå‰æ ‘çš„æŸ¥è¯¢æ•ˆç‡å’Œé¡ºåºæŸ¥æ‰¾å·®ä¸å¤šã€‚è‹¥æƒ³äºŒå‰æŸ¥æ‰¾æ•°çš„æŸ¥è¯¢æ€§èƒ½æœ€é«˜ï¼Œéœ€è¦è¿™æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ï¼Œä¹Ÿå³å¹³è¡¡äºŒå‰æ ‘ï¼ˆAVL æ ‘ï¼‰ã€‚ å¹³è¡¡äºŒå‰æ ‘é¦–å…ˆéœ€è¦ç¬¦åˆäºŒå‰æŸ¥æ‰¾æ ‘çš„å®šä¹‰ï¼Œå…¶æ¬¡å¿…é¡»æ»¡è¶³ä»»ä½•èŠ‚ç‚¹çš„ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®ä¸èƒ½å¤§äº 1ã€‚æ˜¾ç„¶å›¾ â‘¡ ä¸æ»¡è¶³å¹³è¡¡äºŒå‰æ ‘çš„å®šä¹‰ï¼Œè€Œå›¾ â‘  æ˜¯ä¸€è¯¾å¹³è¡¡äºŒå‰æ ‘ã€‚å¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ€§èƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼ˆæ€§èƒ½æœ€å¥½çš„æ˜¯æœ€ä¼˜äºŒå‰æ ‘ï¼‰ï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå¥½ï¼Œç»´æŠ¤çš„æˆæœ¬å°±è¶Šå¤§ã€‚æ¯”å¦‚å›¾ â‘  çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œå½“ç”¨æˆ·éœ€è¦æ’å…¥ä¸€ä¸ªæ–°çš„å€¼ 9 çš„èŠ‚ç‚¹æ—¶ï¼Œå°±éœ€è¦åšå‡ºå¦‚ä¸‹å˜åŠ¨ã€‚ é€šè¿‡ä¸€æ¬¡å·¦æ—‹æ“ä½œå°±å°†æ’å…¥åçš„æ ‘é‡æ–°å˜ä¸ºå¹³è¡¡äºŒå‰æ ‘æ˜¯æœ€ç®€å•çš„æƒ…å†µäº†ï¼Œå®é™…åº”ç”¨åœºæ™¯ä¸­å¯èƒ½éœ€è¦æ—‹è½¬å¤šæ¬¡ã€‚è‡³æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ•ˆç‡è¿˜ä¸é”™ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œç›¸åº”çš„ç»´æŠ¤æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œä¸ºä»€ä¹ˆ MySQL ç´¢å¼•ä¸ç›´æ¥ä½¿ç”¨å¹³è¡¡äºŒå‰æ ‘ï¼Ÿ éšç€æ•°æ®åº“ä¸­æ•°æ®çš„å¢åŠ ï¼Œç´¢å¼•æœ¬èº«å¤§å°éšä¹‹å¢åŠ ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜ I/O æ¶ˆè€—ï¼Œç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/O å­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§ã€‚å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€æ£µå‡ ç™¾ä¸‡èŠ‚ç‚¹çš„äºŒå‰æ ‘çš„æ·±åº¦æ˜¯å¤šå°‘ï¼Ÿå¦‚æœå°†è¿™ä¹ˆå¤§æ·±åº¦çš„ä¸€é¢—äºŒå‰æ ‘æ”¾ç£ç›˜ä¸Šï¼Œæ¯è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä¸€æ¬¡ç£ç›˜çš„ I/O è¯»å–ï¼Œæ•´ä¸ªæŸ¥æ‰¾çš„è€—æ—¶æ˜¾ç„¶æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ã€‚é‚£ä¹ˆå¦‚ä½•å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„ I/O å­˜å–æ¬¡æ•°ï¼Ÿ ä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯å‡å°‘æ ‘çš„æ·±åº¦ï¼Œå°†äºŒå‰æ ‘å˜ä¸º m å‰æ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼‰ï¼Œè€ŒB+Treeå°±æ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘ã€‚ç†è§£B+Treeæ—¶ï¼Œåªéœ€è¦ç†è§£å…¶æœ€é‡è¦çš„ä¸¤ä¸ªç‰¹å¾å³å¯ï¼šç¬¬ä¸€ï¼Œæ‰€æœ‰çš„å…³é”®å­—ï¼ˆå¯ä»¥ç†è§£ä¸ºæ•°æ®ï¼‰éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼ˆLeaf Pageï¼‰ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆIndex Pageï¼‰å¹¶ä¸å­˜å‚¨çœŸæ­£çš„æ•°æ®ï¼Œæ‰€æœ‰è®°å½•èŠ‚ç‚¹éƒ½æ˜¯æŒ‰é”®å€¼å¤§å°é¡ºåºå­˜æ”¾åœ¨åŒä¸€å±‚å¶å­èŠ‚ç‚¹ä¸Šã€‚å…¶æ¬¡ï¼Œæ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ç”±æŒ‡é’ˆè¿æ¥ã€‚å¦‚ä¸‹å›¾ä¸ºé«˜åº¦ä¸º 2 çš„ç®€åŒ–äº†çš„B+Treeã€‚ æ€ä¹ˆç†è§£è¿™ä¸¤ä¸ªç‰¹å¾ï¼ŸMySQL å°†æ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ç½®ä¸ºä¸€ä¸ªé¡µçš„æ•´æ•°å€ï¼ˆåŸå› ä¸‹æ–‡ä¼šä»‹ç»ï¼‰ï¼Œä¹Ÿå°±æ˜¯åœ¨èŠ‚ç‚¹ç©ºé—´å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šçš„å†…ç»“ç‚¹ï¼Œè¿™æ ·æ¯ä¸ªç»“ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®ã€‚æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆé“¾æ¥çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡ŒåŒºé—´è®¿é—®ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå¦‚æœæŸ¥æ‰¾å¤§äº 20 è€Œå°äº 30 çš„è®°å½•ï¼Œåªéœ€è¦æ‰¾åˆ°èŠ‚ç‚¹ 20ï¼Œå°±å¯ä»¥éå†æŒ‡é’ˆä¾æ¬¡æ‰¾åˆ° 25ã€30ã€‚å¦‚æœæ²¡æœ‰é“¾æ¥æŒ‡é’ˆçš„è¯ï¼Œå°±æ— æ³•è¿›è¡ŒåŒºé—´æŸ¥æ‰¾ã€‚è¿™ä¹Ÿæ˜¯ MySQL ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•å­˜å‚¨ç»“æ„çš„é‡è¦åŸå› ã€‚ MySQL ä¸ºä½•å°†èŠ‚ç‚¹å¤§å°è®¾ç½®ä¸ºé¡µçš„æ•´æ•°å€ï¼Œè¿™å°±éœ€è¦ç†è§£ç£ç›˜çš„å­˜å‚¨åŸç†ã€‚ç£ç›˜æœ¬èº«å­˜å–å°±æ¯”ä¸»å­˜æ…¢å¾ˆå¤šï¼Œåœ¨åŠ ä¸Šæœºæ¢°è¿åŠ¨æŸè€—ï¼ˆç‰¹åˆ«æ˜¯æ™®é€šçš„æœºæ¢°ç¡¬ç›˜ï¼‰ï¼Œç£ç›˜çš„å­˜å–é€Ÿåº¦å¾€å¾€æ˜¯ä¸»å­˜çš„å‡ ç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œä¸ºäº†å°½é‡å‡å°‘ç£ç›˜ I/Oï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ï¼Œé¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µçš„æ•´æ•°å€ã€‚ é¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠ OS å¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆè®¸å¤š OS ä¸­ï¼Œé¡µçš„å¤§å°é€šå¸¸ä¸º 4Kï¼‰ã€‚ä¸»å­˜å’Œç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚å½“ç¨‹åºè¦è¯»å–çš„æ•°æ®ä¸åœ¨ä¸»å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šå‘ç£ç›˜å‘å‡ºè¯»ç›˜ä¿¡å·ï¼Œç£ç›˜ä¼šæ‰¾åˆ°æ•°æ®çš„èµ·å§‹ä½ç½®å¹¶å‘åè¿ç»­è¯»å–ä¸€é¡µæˆ–å‡ é¡µè½½å…¥å†…å­˜ä¸­ï¼Œç„¶åä¸€èµ·è¿”å›ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚ MySQL å·§å¦™åˆ©ç”¨äº†ç£ç›˜é¢„è¯»åŸç†ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸€æ¬¡ I/O å°±å¯ä»¥å®Œå…¨è½½å…¥ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†è¯»å–ä¸€ä¸ªèŠ‚ç‚¹åªéœ€ä¸€æ¬¡ I/Oã€‚å‡è®¾B+Treeçš„é«˜åº¦ä¸º hï¼Œä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1æ¬¡ I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œå¤æ‚åº¦ O(h) = O(logmN)ã€‚å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼ŒM é€šå¸¸è¾ƒå¤§ï¼Œå¸¸å¸¸è¶…è¿‡ 100ï¼Œå› æ­¤æ ‘çš„é«˜åº¦ä¸€èˆ¬éƒ½æ¯”è¾ƒå°ï¼Œé€šå¸¸ä¸è¶…è¿‡ 3ã€‚ æœ€åç®€å•äº†è§£ä¸‹B+TreeèŠ‚ç‚¹çš„æ“ä½œï¼Œåœ¨æ•´ä½“ä¸Šå¯¹ç´¢å¼•çš„ç»´æŠ¤æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè™½ç„¶ç´¢å¼•å¯ä»¥å¤§å¤§æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä½†ç»´æŠ¤ç´¢å¼•ä»è¦èŠ±è´¹å¾ˆå¤§çš„ä»£ä»·ï¼Œå› æ­¤åˆç†çš„åˆ›å»ºç´¢å¼•ä¹Ÿå°±å°¤ä¸ºé‡è¦ã€‚ ä»ä»¥ä¸Šé¢çš„æ ‘ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ 4 ä¸ªå†…èŠ‚ç‚¹ã€‚é¦–å…ˆè¦æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ 28ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æ¥ç€æ’å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ 70ï¼Œåœ¨ Index Page ä¸­æŸ¥è¯¢åå¾—çŸ¥åº”è¯¥æ’å…¥åˆ° 50 - 70 ä¹‹é—´çš„å¶å­èŠ‚ç‚¹ï¼Œä½†å¶å­èŠ‚ç‚¹å·²æ»¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿›è¡Œä¹Ÿåˆ†è£‚çš„æ“ä½œï¼Œå½“å‰çš„å¶å­èŠ‚ç‚¹èµ·ç‚¹ä¸º 50ï¼Œæ‰€ä»¥æ ¹æ®ä¸­é—´å€¼æ¥æ‹†åˆ†å¶å­èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æœ€åæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ 95ï¼Œè¿™æ—¶å€™ Index Page å’Œ Leaf Page éƒ½æ»¡äº†ï¼Œå°±éœ€è¦åšä¸¤æ¬¡æ‹†åˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Leaf Page ä¸ Index Page æ‹†åˆ†åæœ€ç»ˆå½¢æˆäº†è¿™æ ·ä¸€é¢—æ ‘ã€‚ B+Treeä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œå¯¹äºæ–°æ’å…¥çš„å€¼éœ€è¦åšå¤§é‡çš„æ‹†åˆ†é¡µæ“ä½œï¼Œè€Œé¡µçš„æ‹†åˆ†éœ€è¦ I/O æ“ä½œï¼Œä¸ºäº†å°½å¯èƒ½çš„å‡å°‘é¡µçš„æ‹†åˆ†æ“ä½œï¼ŒB+Treeä¹Ÿæä¾›äº†ç±»ä¼¼äºå¹³è¡¡äºŒå‰æ ‘çš„æ—‹è½¬åŠŸèƒ½ã€‚å½“ Leaf Page å·²æ»¡ä½†å…¶å·¦å³å…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰æ»¡çš„æƒ…å†µä¸‹ï¼ŒB+Treeå¹¶ä¸æ€¥äºå»åšæ‹†åˆ†æ“ä½œï¼Œè€Œæ˜¯å°†è®°å½•ç§»åˆ°å½“å‰æ‰€åœ¨é¡µçš„å…„å¼ŸèŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå·¦å…„å¼Ÿä¼šè¢«å…ˆæ£€æŸ¥ç”¨æ¥åšæ—‹è½¬æ“ä½œã€‚å°±æ¯”å¦‚ä¸Šé¢ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œå½“æ’å…¥ 70 çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå»åšé¡µæ‹†åˆ†ï¼Œè€Œæ˜¯å·¦æ—‹æ“ä½œã€‚ é€šè¿‡æ—‹è½¬æ“ä½œå¯ä»¥æœ€å¤§é™åº¦çš„å‡å°‘é¡µåˆ†è£‚ï¼Œä»è€Œå‡å°‘ç´¢å¼•ç»´æŠ¤è¿‡ç¨‹ä¸­çš„ç£ç›˜çš„ I/O æ“ä½œï¼Œä¹Ÿæé«˜ç´¢å¼•ç»´æŠ¤æ•ˆç‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤èŠ‚ç‚¹è·Ÿæ’å…¥èŠ‚ç‚¹ç±»ä¼¼ï¼Œä»ç„¶éœ€è¦æ—‹è½¬å’Œæ‹†åˆ†æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚ é«˜æ€§èƒ½ç­–ç•¥é€šè¿‡ä¸Šæ–‡ï¼Œç›¸ä¿¡ä½ å¯¹B+Treeçš„æ•°æ®ç»“æ„å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä½† MySQL ä¸­ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„å­˜å‚¨å‘¢ï¼Ÿä»¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹æ•°æ®è¡¨ï¼š1234567CREATE TABLE People( last_name varchar(50) not null, first_name varchar(50) not null, dob date not null, gender enum(`m`,`f`) not null, key(last_name,first_name,dob)); å¯¹äºè¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®ï¼Œç´¢å¼•ä¸­åŒ…å«äº† last_nameã€first_nameã€dob åˆ—çš„å€¼ï¼Œä¸‹å›¾å±•ç¤ºäº†ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•é¦–å…ˆæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥æ’åˆ—é¡ºåºï¼Œå½“åå­—ç›¸åŒæ—¶ï¼Œåˆ™æ ¹æ®ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå³å‡ºç”Ÿæ—¥æœŸæ¥æ’åºï¼Œæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæ‰æœ‰äº†ç´¢å¼•çš„ â€œæœ€å·¦åŸåˆ™â€ã€‚ MySQL ä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ— â€œç‹¬ç«‹çš„åˆ—â€ æ˜¯æŒ‡ç´¢å¼•åˆ—ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸èƒ½æ˜¯å‡½æ•°çš„å‚æ•°ã€‚æ¯”å¦‚ï¼š1select * from where id + 1 = 5 æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºå…¶ç­‰ä»·äº id = 4ï¼Œä½†æ˜¯ MySQL æ— æ³•è‡ªåŠ¨è§£æè¿™ä¸ªè¡¨è¾¾å¼ï¼Œä½¿ç”¨å‡½æ•°æ˜¯åŒæ ·çš„é“ç†ã€‚ å‰ç¼€ç´¢å¼•å¦‚æœåˆ—å¾ˆé•¿ï¼Œé€šå¸¸å¯ä»¥ç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚ å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåºåœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç‹¬ç«‹çš„ç´¢å¼•å¹¶ä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ç†ç”±éå¸¸ç®€å•ï¼ŒMySQL ä¸çŸ¥é“é€‰æ‹©å“ªä¸ªç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡æ›´å¥½ï¼Œæ‰€ä»¥åœ¨è€ç‰ˆæœ¬ï¼Œæ¯”å¦‚ MySQL5.0 ä¹‹å‰å°±ä¼šéšä¾¿é€‰æ‹©ä¸€ä¸ªåˆ—çš„ç´¢å¼•ï¼Œè€Œæ–°çš„ç‰ˆæœ¬ä¼šé‡‡ç”¨åˆå¹¶ç´¢å¼•çš„ç­–ç•¥ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸€å¼ ç”µå½±æ¼”å‘˜è¡¨ä¸­ï¼Œåœ¨ actor_id å’Œ film_id ä¸¤ä¸ªåˆ—ä¸Šéƒ½å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•ï¼Œç„¶åæœ‰å¦‚ä¸‹æŸ¥è¯¢ï¼š 1select film_id,actor_id from film_actor where actor_id = 1 or film_id = 1 è€ç‰ˆæœ¬çš„ MySQL ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä½†æ–°ç‰ˆæœ¬åšå¦‚ä¸‹çš„ä¼˜åŒ–ï¼š123select film_id,actor_id from film_actor where actor_id = 1union allselect film_id,actor_id from film_actor where film_id = 1 and actor_id 1 å½“å‡ºç°å¤šä¸ªç´¢å¼•åšç›¸äº¤æ“ä½œæ—¶ï¼ˆå¤šä¸ª AND æ¡ä»¶ï¼‰ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„ç´¢å¼•è¦ä¼˜äºå¤šä¸ªç‹¬ç«‹ç´¢å¼•ã€‚ å½“å‡ºç°å¤šä¸ªç´¢å¼•åšè”åˆæ“ä½œæ—¶ï¼ˆå¤šä¸ª OR æ¡ä»¶ï¼‰ï¼Œå¯¹ç»“æœé›†çš„åˆå¹¶ã€æ’åºç­‰æ“ä½œéœ€è¦è€—è´¹å¤§é‡çš„ CPU å’Œå†…å­˜èµ„æºï¼Œç‰¹åˆ«æ˜¯å½“å…¶ä¸­çš„æŸäº›ç´¢å¼•çš„é€‰æ‹©æ€§ä¸é«˜ï¼Œéœ€è¦è¿”å›åˆå¹¶å¤§é‡æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢æˆæœ¬æ›´é«˜ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¿˜ä¸å¦‚èµ°å…¨è¡¨æ‰«æã€‚ å› æ­¤explainæ—¶å¦‚æœå‘ç°æœ‰ç´¢å¼•åˆå¹¶ï¼ˆExtra å­—æ®µå‡ºç°Using unionï¼‰ï¼Œåº”è¯¥å¥½å¥½æ£€æŸ¥ä¸€ä¸‹æŸ¥è¯¢å’Œè¡¨ç»“æ„æ˜¯ä¸æ˜¯å·²ç»æ˜¯æœ€ä¼˜çš„ï¼Œå¦‚æœæŸ¥è¯¢å’Œè¡¨éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£åªèƒ½è¯´æ˜ç´¢å¼•å»ºçš„éå¸¸ç³Ÿç³•ï¼Œåº”å½“æ…é‡è€ƒè™‘ç´¢å¼•æ˜¯å¦åˆé€‚ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„å¤šåˆ—ç´¢å¼•æ›´é€‚åˆã€‚ å‰é¢æˆ‘ä»¬æåˆ°è¿‡ç´¢å¼•å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¤šåˆ—ç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„é¡ºåºå¯¹äºæŸ¥è¯¢æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¾ˆæ˜æ˜¾åº”è¯¥æŠŠé€‰æ‹©æ€§æ›´é«˜çš„å­—æ®µæ”¾åˆ°ç´¢å¼•çš„å‰é¢ï¼Œè¿™æ ·é€šè¿‡ç¬¬ä¸€ä¸ªå­—æ®µå°±å¯ä»¥è¿‡æ»¤æ‰å¤§å¤šæ•°ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚ ç´¢å¼•é€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼å’Œæ•°æ®è¡¨çš„æ€»è®°å½•æ•°çš„æ¯”å€¼ï¼Œé€‰æ‹©æ€§è¶Šé«˜æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œå› ä¸ºé€‰æ‹©æ€§è¶Šé«˜çš„ç´¢å¼•å¯ä»¥è®© MySQL åœ¨æŸ¥è¯¢æ—¶è¿‡æ»¤æ‰æ›´å¤šçš„è¡Œã€‚å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯ 1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚ ç†è§£ç´¢å¼•é€‰æ‹©æ€§çš„æ¦‚å¿µåï¼Œå°±ä¸éš¾ç¡®å®šå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§è¾ƒé«˜äº†ï¼ŒæŸ¥ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæ¯”å¦‚ï¼š1SELECT * FROM payment where staff_id = 2 and customer_id = 584 æ˜¯åº”è¯¥åˆ›å»º(staff_id,customer_id)çš„ç´¢å¼•è¿˜æ˜¯åº”è¯¥é¢ å€’ä¸€ä¸‹é¡ºåºï¼Ÿæ‰§è¡Œä¸‹é¢çš„æŸ¥è¯¢ï¼Œå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§æ›´æ¥è¿‘ 1 å°±æŠŠå“ªä¸ªå­—æ®µç´¢å¼•å‰é¢å°±å¥½ã€‚123select count(distinct staff_id)/count(*) as staff_id_selectivity, count(distinct customer_id)/count(*) as customer_id_selectivity, count(*) from payment å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªåŸåˆ™æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä»ç„¶æ³¨æ„ä½ çš„æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚è¦æŸ¥è¯¢æŸä¸ªç”¨æˆ·ç»„ä¸‹æœ‰è¿‡äº¤æ˜“çš„ç”¨æˆ·ä¿¡æ¯ï¼š1select user_id from trade where user_group_id = 1 and trade_amount > 0 MySQL ä¸ºè¿™ä¸ªæŸ¥è¯¢é€‰æ‹©äº†ç´¢å¼•(user_group_id,trade_amount)ï¼Œå¦‚æœä¸è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼Œè¿™çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å®é™…æƒ…å†µæ˜¯è¿™å¼ è¡¨çš„å¤§å¤šæ•°æ•°æ®éƒ½æ˜¯ä»è€ç³»ç»Ÿä¸­è¿ç§»è¿‡æ¥çš„ï¼Œç”±äºæ–°è€ç³»ç»Ÿçš„æ•°æ®ä¸å…¼å®¹ï¼Œæ‰€ä»¥å°±ç»™è€ç³»ç»Ÿè¿ç§»è¿‡æ¥çš„æ•°æ®èµ‹äºˆäº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·ç»„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ç´¢å¼•æ‰«æçš„è¡Œæ•°è·Ÿå…¨è¡¨æ‰«æåŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œç´¢å¼•ä¹Ÿå°±èµ·ä¸åˆ°ä»»ä½•ä½œç”¨ã€‚ æ¨å¹¿å¼€æ¥è¯´ï¼Œç»éªŒæ³•åˆ™å’Œæ¨è®ºåœ¨å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œå¯ä»¥æŒ‡å¯¼æˆ‘ä»¬å¼€å‘å’Œè®¾è®¡ï¼Œä½†å®é™…æƒ…å†µå¾€å¾€ä¼šæ›´å¤æ‚ï¼Œå®é™…ä¸šåŠ¡åœºæ™¯ä¸‹çš„æŸäº›ç‰¹æ®Šæƒ…å†µå¯èƒ½ä¼šæ‘§æ¯ä½ çš„æ•´ä¸ªè®¾è®¡ã€‚ é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶ å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨å¤šä¸ªèŒƒå›´æ¡ä»¶ï¼Œæ¯”å¦‚æƒ³æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…ç™»å½•è¿‡çš„ç”¨æˆ·ï¼š1select user.* from user where login_time > '2017-04-01' and age between 18 and 30; è¿™ä¸ªæŸ¥è¯¢æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå®ƒæœ‰ä¸¤ä¸ªèŒƒå›´æ¡ä»¶ï¼Œlogin_time åˆ—å’Œ age åˆ—ï¼ŒMySQL å¯ä»¥ä½¿ç”¨ login_time åˆ—çš„ç´¢å¼•æˆ–è€… age åˆ—çš„ç´¢å¼•ï¼Œä½†æ— æ³•åŒæ—¶ä½¿ç”¨å®ƒä»¬ã€‚ è¦†ç›–ç´¢å¼• å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å†å›è¡¨æŸ¥è¯¢ï¼Œè¿™å°±ç§°ä¸ºè¦†ç›–ç´¢å¼•ã€‚è¦†ç›–ç´¢å¼•æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æå¤§çš„æé«˜æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢åªéœ€è¦æ‰«æç´¢å¼•ä¼šå¸¦æ¥è®¸å¤šå¥½å¤„ï¼š ç´¢å¼•æ¡ç›®è¿œå°äºæ•°æ®è¡Œå¤§å°ï¼Œå¦‚æœåªè¯»å–ç´¢å¼•ï¼Œæå¤§å‡å°‘æ•°æ®è®¿é—®é‡ ç´¢å¼•æ˜¯æœ‰æŒ‰ç…§åˆ—å€¼é¡ºåºå­˜å‚¨çš„ï¼Œå¯¹äº I/O å¯†é›†å‹çš„èŒƒå›´æŸ¥è¯¢è¦æ¯”éšæœºä»ç£ç›˜è¯»å–æ¯ä¸€è¡Œæ•°æ®çš„ IO è¦å°‘çš„å¤š ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº MySQL æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”Ÿäº§æœ‰åºçš„ç»“æœé›†ï¼Œå…¶ä¸€æ˜¯å¯¹ç»“æœé›†è¿›è¡Œæ’åºçš„æ“ä½œï¼Œå…¶äºŒæ˜¯æŒ‰ç…§ç´¢å¼•é¡ºåºæ‰«æå¾—å‡ºçš„ç»“æœè‡ªç„¶æ˜¯æœ‰åºçš„ã€‚å¦‚æœ explain çš„ç»“æœä¸­typeåˆ—çš„å€¼ä¸ºindexè¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•æ‰«ææ¥åšæ’åºã€‚ æ‰«æç´¢å¼•æœ¬èº«å¾ˆå¿«ï¼Œå› ä¸ºåªéœ€è¦ä»ä¸€æ¡ç´¢å¼•è®°å½•ç§»åŠ¨åˆ°ç›¸é‚»çš„ä¸‹ä¸€æ¡è®°å½•ã€‚ä½†å¦‚æœç´¢å¼•æœ¬èº«ä¸èƒ½è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„åˆ—ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ¯æ‰«æä¸€æ¡ç´¢å¼•è®°å½•å°±å›è¡¨æŸ¥è¯¢ä¸€æ¬¡å¯¹åº”çš„è¡Œã€‚è¿™ä¸ªè¯»å–æ“ä½œåŸºæœ¬ä¸Šæ˜¯éšæœº I/Oï¼Œå› æ­¤æŒ‰ç…§ç´¢å¼•é¡ºåºè¯»å–æ•°æ®çš„é€Ÿåº¦é€šå¸¸è¦æ¯”é¡ºåºåœ°å…¨è¡¨æ‰«æè¦æ…¢ã€‚ åœ¨è®¾è®¡ç´¢å¼•æ—¶ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•æ—¢èƒ½å¤Ÿæ»¡è¶³æ’åºï¼Œåˆæ»¡è¶³æŸ¥è¯¢ï¼Œæ˜¯æœ€å¥½çš„ã€‚ åªæœ‰å½“ç´¢å¼•çš„åˆ—é¡ºåºå’ŒORDER BYå­å¥çš„é¡ºåºå®Œå…¨ä¸€è‡´ï¼Œå¹¶ä¸”æ‰€æœ‰åˆ—çš„æ’åºæ–¹å‘ä¹Ÿä¸€æ ·æ—¶ï¼Œæ‰èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•æ¥å¯¹ç»“æœåšæ’åºã€‚å¦‚æœæŸ¥è¯¢éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œåˆ™åªæœ‰ORDER BYå­å¥å¼•ç”¨çš„å­—æ®µå…¨éƒ¨ä¸ºç¬¬ä¸€å¼ è¡¨æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•åšæ’åºã€‚ORDER BYå­å¥å’ŒæŸ¥è¯¢çš„é™åˆ¶æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦æ»¡è¶³æœ€å·¦å‰ç¼€çš„è¦æ±‚ï¼ˆæœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯æœ€å·¦çš„åˆ—è¢«æŒ‡å®šä¸ºå¸¸æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼‰ï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½éœ€è¦æ‰§è¡Œæ’åºæ“ä½œï¼Œè€Œæ— æ³•åˆ©ç”¨ç´¢å¼•æ’åºã€‚12-- æœ€å·¦åˆ—ä¸ºå¸¸æ•°ï¼Œç´¢å¼•ï¼š(date,staff_id,customer_id)select staff_id,customer_id from demo where date = '2015-06-01' order by staff_id,customer_id å†—ä½™å’Œé‡å¤ç´¢å¼• å†—ä½™ç´¢å¼•æ˜¯æŒ‡åœ¨ç›¸åŒçš„åˆ—ä¸ŠæŒ‰ç…§ç›¸åŒçš„é¡ºåºåˆ›å»ºçš„ç›¸åŒç±»å‹çš„ç´¢å¼•ï¼Œåº”å½“å°½é‡é¿å…è¿™ç§ç´¢å¼•ï¼Œå‘ç°åç«‹å³åˆ é™¤ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç´¢å¼•(A,B)ï¼Œå†åˆ›å»ºç´¢å¼•(A)å°±æ˜¯å†—ä½™ç´¢å¼•ã€‚å†—ä½™ç´¢å¼•ç»å¸¸å‘ç”Ÿåœ¨ä¸ºè¡¨æ·»åŠ æ–°ç´¢å¼•æ—¶ï¼Œæ¯”å¦‚æœ‰äººæ–°å»ºäº†ç´¢å¼•(A,B)ï¼Œä½†è¿™ä¸ªç´¢å¼•ä¸æ˜¯æ‰©å±•å·²æœ‰çš„ç´¢å¼•(A)ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½åº”è¯¥å°½é‡æ‰©å±•å·²æœ‰çš„ç´¢å¼•è€Œä¸æ˜¯åˆ›å»ºæ–°ç´¢å¼•ã€‚ä½†æœ‰æå°‘æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–¹é¢çš„è€ƒè™‘éœ€è¦å†—ä½™ç´¢å¼•ï¼Œæ¯”å¦‚æ‰©å±•å·²æœ‰ç´¢å¼•è€Œå¯¼è‡´å…¶å˜å¾—è¿‡å¤§ï¼Œä»è€Œå½±å“åˆ°å…¶ä»–ä½¿ç”¨è¯¥ç´¢å¼•çš„æŸ¥è¯¢ã€‚ åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼• å®šæœŸåˆ é™¤ä¸€äº›é•¿æ—¶é—´æœªä½¿ç”¨è¿‡çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚ å…³äºç´¢å¼•è¿™ä¸ªè¯é¢˜æ‰“ç®—å°±æ­¤æ‰“ä½ï¼Œæœ€åè¦è¯´ä¸€å¥ï¼Œç´¢å¼•å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„å·¥å…·ï¼Œåªæœ‰å½“ç´¢å¼•å¸®åŠ©æé«˜æŸ¥è¯¢é€Ÿåº¦å¸¦æ¥çš„å¥½å¤„å¤§äºå…¶å¸¦æ¥çš„é¢å¤–å·¥ä½œæ—¶ï¼Œç´¢å¼•æ‰æ˜¯æœ‰æ•ˆçš„ã€‚å¯¹äºéå¸¸å°çš„è¡¨ï¼Œç®€å•çš„å…¨è¡¨æ‰«ææ›´é«˜æ•ˆã€‚å¯¹äºä¸­åˆ°å¤§å‹çš„è¡¨ï¼Œç´¢å¼•å°±éå¸¸æœ‰æ•ˆã€‚å¯¹äºè¶…å¤§å‹çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·éšä¹‹å¢é•¿ï¼Œè¿™æ—¶å€™å…¶ä»–æŠ€æœ¯ä¹Ÿè®¸æ›´æœ‰æ•ˆï¼Œæ¯”å¦‚åˆ†åŒºè¡¨ã€‚æœ€åçš„æœ€åï¼Œexplainåå†ææµ‹æ˜¯ä¸€ç§ç¾å¾·ã€‚ ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ– ä¼˜åŒ– COUNT() æŸ¥è¯¢ COUNT()å¯èƒ½æ˜¯è¢«å¤§å®¶è¯¯è§£æœ€å¤šçš„å‡½æ•°äº†ï¼Œå®ƒæœ‰ä¸¤ç§ä¸åŒçš„ä½œç”¨ï¼Œå…¶ä¸€æ˜¯ç»Ÿè®¡æŸä¸ªåˆ—å€¼çš„æ•°é‡ï¼Œå…¶äºŒæ˜¯ç»Ÿè®¡è¡Œæ•°ã€‚ç»Ÿè®¡åˆ—å€¼æ—¶ï¼Œè¦æ±‚åˆ—å€¼æ˜¯éç©ºçš„ï¼Œå®ƒä¸ä¼šç»Ÿè®¡ NULLã€‚å¦‚æœç¡®è®¤æ‹¬å·ä¸­çš„è¡¨è¾¾å¼ä¸å¯èƒ½ä¸ºç©ºæ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç»Ÿè®¡è¡Œæ•°ã€‚æœ€ç®€å•çš„å°±æ˜¯å½“ä½¿ç”¨COUNT(*)æ—¶ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³è±¡çš„é‚£æ ·æ‰©å±•æˆæ‰€æœ‰çš„åˆ—ï¼Œå®é™…ä¸Šï¼Œå®ƒä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—è€Œç›´æ¥ç»Ÿè®¡è¡Œæ•°ã€‚ æˆ‘ä»¬æœ€å¸¸è§çš„è¯¯è§£ä¹Ÿå°±åœ¨è¿™å„¿ï¼Œåœ¨æ‹¬å·å†…æŒ‡å®šäº†ä¸€åˆ—å´å¸Œæœ›ç»Ÿè®¡ç»“æœæ˜¯è¡Œæ•°ï¼Œè€Œä¸”è¿˜å¸¸å¸¸è¯¯ä»¥ä¸ºå‰è€…çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ä½†å®é™…å¹¶éè¿™æ ·ï¼Œå¦‚æœè¦ç»Ÿè®¡è¡Œæ•°ï¼Œç›´æ¥ä½¿ç”¨COUNT(*)ï¼Œæ„ä¹‰æ¸…æ™°ï¼Œä¸”æ€§èƒ½æ›´å¥½ã€‚ æœ‰æ—¶å€™æŸäº›ä¸šåŠ¡åœºæ™¯å¹¶ä¸éœ€è¦å®Œå…¨ç²¾ç¡®çš„COUNTå€¼ï¼Œå¯ä»¥ç”¨è¿‘ä¼¼å€¼æ¥ä»£æ›¿ï¼ŒEXPLAIN å‡ºæ¥çš„è¡Œæ•°å°±æ˜¯ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè€Œä¸”æ‰§è¡Œ EXPLAIN å¹¶ä¸éœ€è¦çœŸæ­£åœ°å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥æˆæœ¬éå¸¸ä½ã€‚é€šå¸¸æ¥è¯´ï¼Œæ‰§è¡ŒCOUNT()éƒ½éœ€è¦æ‰«æå¤§é‡çš„è¡Œæ‰èƒ½è·å–åˆ°ç²¾ç¡®çš„æ•°æ®ï¼Œå› æ­¤å¾ˆéš¾ä¼˜åŒ–ï¼ŒMySQL å±‚é¢è¿˜èƒ½åšå¾—ä¹Ÿå°±åªæœ‰è¦†ç›–ç´¢å¼•äº†ã€‚å¦‚æœä¸è¿˜èƒ½è§£å†³é—®é¢˜ï¼Œåªæœ‰ä»æ¶æ„å±‚é¢è§£å†³äº†ï¼Œæ¯”å¦‚æ·»åŠ æ±‡æ€»è¡¨ï¼Œæˆ–è€…ä½¿ç”¨ redis è¿™æ ·çš„å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿã€‚ ä¼˜åŒ–å…³è”æŸ¥è¯¢ åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œè¡¨ä¸è¡¨ä¹‹é—´é€šè¿‡ä¸€ä¸ªå†—ä½™å­—æ®µæ¥å…³è”ï¼Œè¦æ¯”ç›´æ¥ä½¿ç”¨JOINæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å¦‚æœç¡®å®éœ€è¦ä½¿ç”¨å…³è”æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š ç¡®ä¿ONå’ŒUSINGå­—å¥ä¸­çš„åˆ—ä¸Šæœ‰ç´¢å¼•ã€‚åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°å…³è”çš„é¡ºåºã€‚å½“è¡¨ A å’Œè¡¨ B ç”¨åˆ— c å…³è”çš„æ—¶å€™ï¼Œå¦‚æœä¼˜åŒ–å™¨å…³è”çš„é¡ºåºæ˜¯ Aã€Bï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨ A è¡¨çš„å¯¹åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚æ²¡æœ‰ç”¨åˆ°çš„ç´¢å¼•ä¼šå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé™¤éæœ‰å…¶ä»–ç†ç”±ï¼Œåªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆå…·ä½“åŸå› ä¸‹æ–‡åˆ†æï¼‰ã€‚ ç¡®ä¿ä»»ä½•çš„GROUP BYå’ŒORDER BYä¸­çš„è¡¨è¾¾å¼åªæ¶‰åŠåˆ°ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ · MySQL æ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ã€‚ è¦ç†è§£ä¼˜åŒ–å…³è”æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªæŠ€å·§ï¼Œå°±éœ€è¦ç†è§£ MySQL æ˜¯å¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢çš„ã€‚å½“å‰ MySQL å…³è”æ‰§è¡Œçš„ç­–ç•¥éå¸¸ç®€å•ï¼Œå®ƒå¯¹ä»»ä½•çš„å…³è”éƒ½æ‰§è¡ŒåµŒå¥—å¾ªç¯å…³è”æ“ä½œï¼Œå³å…ˆåœ¨ä¸€ä¸ªè¡¨ä¸­å¾ªç¯å–å‡ºå•æ¡æ•°æ®ï¼Œç„¶ååœ¨åµŒå¥—å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªè¡¨ä¸­å¯»æ‰¾åŒ¹é…çš„è¡Œï¼Œä¾æ¬¡ä¸‹å»ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰è¡¨ä¸­åŒ¹é…çš„è¡Œä¸ºä¸ºæ­¢ã€‚ç„¶åæ ¹æ®å„ä¸ªè¡¨åŒ¹é…çš„è¡Œï¼Œè¿”å›æŸ¥è¯¢ä¸­éœ€è¦çš„å„ä¸ªåˆ—ã€‚ å¤ªæŠ½è±¡äº†ï¼Ÿä»¥ä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œæ¯”å¦‚æœ‰è¿™æ ·çš„ä¸€ä¸ªæŸ¥è¯¢ï¼š1SELECT A.xx,B.yy FROM A INNER JOIN B USING(c) WHERE A.xx IN (5,6) å‡è®¾ MySQL æŒ‰ç…§æŸ¥è¯¢ä¸­çš„å…³è”é¡ºåº Aã€B æ¥è¿›è¡Œå…³è”æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¸‹é¢çš„ä¼ªä»£ç è¡¨ç¤º MySQL å¦‚ä½•å®Œæˆè¿™ä¸ªæŸ¥è¯¢ï¼š1234567891011outer_iterator = SELECT A.xx,A.c FROM A WHERE A.xx IN (5,6);outer_row = outer_iterator.next;while(outer_row) { inner_iterator = SELECT B.yy FROM B WHERE B.c = outer_row.c; inner_row = inner_iterator.next; while(inner_row) { output[inner_row.yy,outer_row.xx]; inner_row = inner_iterator.next; } outer_row = outer_iterator.next;} å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤–å±‚çš„æŸ¥è¯¢æ˜¯æ ¹æ®A.xxåˆ—æ¥æŸ¥è¯¢çš„ï¼ŒA.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œæ•´ä¸ªå…³è”æŸ¥è¯¢ä¹Ÿä¸ä¼šä½¿ç”¨ã€‚å†çœ‹å†…å±‚çš„æŸ¥è¯¢ï¼Œå¾ˆæ˜æ˜¾B.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œèƒ½å¤ŸåŠ é€ŸæŸ¥è¯¢ï¼Œå› æ­¤åªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•å³å¯ã€‚ ä¼˜åŒ– LIMIT åˆ†é¡µ å½“éœ€è¦åˆ†é¡µæ“ä½œæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨LIMITåŠ ä¸Šåç§»é‡çš„åŠæ³•å®ç°ï¼ŒåŒæ—¶åŠ ä¸Šåˆé€‚çš„ORDER BYå­—å¥ã€‚å¦‚æœæœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œé€šå¸¸æ•ˆç‡ä¼šä¸é”™ï¼Œå¦åˆ™ï¼ŒMySQL éœ€è¦åšå¤§é‡çš„æ–‡ä»¶æ’åºæ“ä½œã€‚ ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å½“åç§»é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼šLIMIT 10000 20è¿™æ ·çš„æŸ¥è¯¢ï¼ŒMySQL éœ€è¦æŸ¥è¯¢ 10020 æ¡è®°å½•ç„¶ååªè¿”å› 20 æ¡è®°å½•ï¼Œå‰é¢çš„ 10000 æ¡éƒ½å°†è¢«æŠ›å¼ƒï¼Œè¿™æ ·çš„ä»£ä»·éå¸¸é«˜ã€‚ ä¼˜åŒ–è¿™ç§æŸ¥è¯¢ä¸€ä¸ªæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨è¦†ç›–ç´¢å¼•æ‰«æï¼Œè€Œä¸æ˜¯æŸ¥è¯¢æ‰€æœ‰çš„åˆ—ã€‚ç„¶åæ ¹æ®éœ€è¦åšä¸€æ¬¡å…³è”æŸ¥è¯¢å†è¿”å›æ‰€æœ‰çš„åˆ—ã€‚å¯¹äºåç§»é‡å¾ˆå¤§æ—¶ï¼Œè¿™æ ·åšçš„æ•ˆç‡ä¼šæå‡éå¸¸å¤§ã€‚è€ƒè™‘ä¸‹é¢çš„æŸ¥è¯¢ï¼š1SELECT film_id,description FROM film ORDER BY title LIMIT 50,5; å¦‚æœè¿™å¼ è¡¨éå¸¸å¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š1234SELECT film.film_id,film.descriptionFROM film INNER JOIN ( SELECT film_id FROM film ORDER BY title LIMIT 50,5) AS tmp USING(film_id); è¿™é‡Œçš„å»¶è¿Ÿå…³è”å°†å¤§å¤§æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œè®© MySQL æ‰«æå°½å¯èƒ½å°‘çš„é¡µé¢ï¼Œè·å–éœ€è¦è®¿é—®çš„è®°å½•ååœ¨æ ¹æ®å…³è”åˆ—å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„åˆ—ã€‚ æœ‰æ—¶å€™å¦‚æœå¯ä»¥ä½¿ç”¨ä¹¦ç­¾è®°å½•ä¸Šæ¬¡å–æ•°æ®çš„ä½ç½®ï¼Œé‚£ä¹ˆä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»è¯¥ä¹¦ç­¾è®°å½•çš„ä½ç½®å¼€å§‹æ‰«æï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä½¿ç”¨OFFSETï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢ï¼š123SELECT id FROM t LIMIT 10000, 10;-- æ”¹ä¸ºï¼šSELECT id FROM t WHERE id > 10000 LIMIT 10; å…¶ä»–ä¼˜åŒ–çš„åŠæ³•è¿˜åŒ…æ‹¬ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„æ±‡æ€»è¡¨ï¼Œæˆ–è€…å…³è”åˆ°ä¸€ä¸ªå†—ä½™è¡¨ï¼Œå†—ä½™è¡¨ä¸­åªåŒ…å«ä¸»é”®åˆ—å’Œéœ€è¦åšæ’åºçš„åˆ—ã€‚ ä¼˜åŒ– UNIONMySQL å¤„ç†UNIONçš„ç­–ç•¥æ˜¯å…ˆåˆ›å»ºä¸´æ—¶è¡¨ï¼Œç„¶åå†æŠŠå„ä¸ªæŸ¥è¯¢ç»“æœæ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œæœ€åå†æ¥åšæŸ¥è¯¢ã€‚å› æ­¤å¾ˆå¤šä¼˜åŒ–ç­–ç•¥åœ¨UNIONæŸ¥è¯¢ä¸­éƒ½æ²¡æœ‰åŠæ³•å¾ˆå¥½çš„æ—¶å€™ã€‚ç»å¸¸éœ€è¦æ‰‹åŠ¨å°†WHEREã€LIMITã€ORDER BYç­‰å­—å¥ â€œä¸‹æ¨â€ åˆ°å„ä¸ªå­æŸ¥è¯¢ä¸­ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨å¯ä»¥å……åˆ†åˆ©ç”¨è¿™äº›æ¡ä»¶å…ˆä¼˜åŒ–ã€‚ é™¤éç¡®å®éœ€è¦æœåŠ¡å™¨å»é‡ï¼Œå¦åˆ™å°±ä¸€å®šè¦ä½¿ç”¨UNION ALLï¼Œå¦‚æœæ²¡æœ‰ALLå…³é”®å­—ï¼ŒMySQL ä¼šç»™ä¸´æ—¶è¡¨åŠ ä¸ŠDISTINCTé€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªä¸´æ—¶è¡¨çš„æ•°æ®åšå”¯ä¸€æ€§æ£€æŸ¥ï¼Œè¿™æ ·åšçš„ä»£ä»·éå¸¸é«˜ã€‚å½“ç„¶å³ä½¿ä½¿ç”¨ ALL å…³é”®å­—ï¼ŒMySQL æ€»æ˜¯å°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå†è¯»å‡ºï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è™½ç„¶å¾ˆå¤šæ—¶å€™æ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯ä»¥ç›´æ¥æŠŠæ¯ä¸ªå­æŸ¥è¯¢çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ç»“è¯­ç†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œä»¥åŠæ—¶é—´éƒ½æ¶ˆè€—åœ¨å“ªäº›åœ°æ–¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¼˜åŒ–è¿‡ç¨‹çš„çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ MySQLï¼Œç†è§£å¸¸è§ä¼˜åŒ–æŠ€å·§èƒŒåçš„åŸç†ã€‚å¸Œæœ›æœ¬æ–‡ä¸­çš„åŸç†ã€ç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½çš„å°†ç†è®ºå’Œå®è·µè”ç³»èµ·æ¥ï¼Œæ›´å¤šçš„å°†ç†è®ºçŸ¥è¯†è¿ç”¨åˆ°å®è·µä¸­ã€‚ å…¶ä»–ä¹Ÿæ²¡å•¥è¯´çš„äº†ï¼Œç»™å¤§å®¶ç•™ä¸¤ä¸ªæ€è€ƒé¢˜å§ï¼Œå¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ç­”æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„ï¼Œä½†å¾ˆå°‘æœ‰äººä¼šæ€è€ƒä¸ºä»€ä¹ˆï¼Ÿ æœ‰éå¸¸å¤šçš„ç¨‹åºå‘˜åœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ JOINæœ¬èº«ä¹ŸæŒºæ–¹ä¾¿çš„ï¼Œç›´æ¥æŸ¥è¯¢å°±å¥½äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è§†å›¾å‘¢ï¼Ÿ å‚è€ƒèµ„æ–™ ç”± B-/B+æ ‘çœ‹ MySQLç´¢å¼•ç»“æ„ MySQL æŠ€æœ¯å†…å¹•ï¼šInnoDB å­˜å‚¨å¼•æ“(ç¬¬ 2 ç‰ˆ) é«˜æ€§èƒ½ MySQL(ç¬¬ 3 ç‰ˆ) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQL ä¼˜åŒ–ä¹‹ Covering Index]]></title>
    <url>%2F2019%2F03%2F29%2FCoveringIndex%2F</url>
    <content type="text"><![CDATA[ä¸ºä»€ä¹ˆæˆ‘è€çˆ¸ä¸æ˜¯æå˜‰è¯šï¼Œä¸ºä»€ä¹ˆæˆ‘é•¿çš„è¿™ä¹ˆå¸…ï¼Œä½†æ˜¯è¦æ‰å¤´å‘å‘¢ï¼Œä½ ä»¬é•¿è¿™ä¹ˆä¸‘ï¼Œå´ä¸æ‰å¤´å‘å‘¢ï¼Ÿ å‰è¨€åœ¨ç½‘ä¸Šéšä¾¿æœæœï¼Œå°±èƒ½æ‰¾åˆ°å¤§æŠŠçš„å…³äº MySQL ä¼˜åŒ–çš„æ–‡ç« ï¼Œä¸è¿‡é‡Œé¢å¾ˆå¤šéƒ½ä¸å‡†ç¡®ï¼Œè¯´ä¸ªå¸¸è§çš„ï¼š1SELECT a FROM ... WHERE b = ... ä¸€èˆ¬æ¥è¯´ï¼Œå¾ˆå¤šæ–‡ç« ä¼šå‘Šè¯«ä½ ç±»ä¼¼è¿™æ ·çš„æŸ¥è¯¢ï¼Œä¸è¦åœ¨ â€œaâ€ å­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼Œè€Œåº”è¯¥åœ¨ â€œbâ€ ä¸Šå»ºç«‹ç´¢å¼•ã€‚è¿™æ ·åšç¡®å®ä¸é”™ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™è¿™å¹¶ä¸æ˜¯æœ€ä½³ç»“æœã€‚ä¸ºä»€ä¹ˆè¿™æ ·è¯´ï¼Ÿè¿™è¿˜å¾—å…ˆä»ç´¢å¼•æ¥è¯´èµ·ã€‚ ç´¢å¼•MySQL å®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆIndexï¼‰æ˜¯å¸®åŠ© MySQL é«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚æå–å¥å­ä¸»å¹²ï¼Œå°±å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚ åœ¨ MySQL ä¸­ï¼Œç´¢å¼•å±äºå­˜å‚¨å¼•æ“çº§åˆ«çš„æ¦‚å¿µï¼Œä¸åŒå­˜å‚¨å¼•æ“å¯¹ç´¢å¼•çš„å®ç°æ–¹å¼æ˜¯ä¸åŒçš„ï¼Œæœ¬æ–‡è®¨è®ºçš„ä¸»è¦æ˜¯ InnoDB çš„ B+Tree ç´¢å¼•ï¼Œå®ƒåˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š èšç°‡ç´¢å¼• éèšç°‡ç´¢å¼• èšç°‡ç´¢å¼•åˆç§°ä¸ºèšé›†ç´¢å¼•æˆ–ä¸»é”®ç´¢å¼•ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ç§å•ç‹¬çš„ç´¢å¼•ç±»å‹ï¼Œè€Œæ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ã€‚åœ¨ InnoDB ä¸­ï¼Œè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™æ£µæ ‘çš„å¶å­èŠ‚ç‚¹ç§°ä¸º leaf pageï¼Œå…¶ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚ä¹Ÿå³æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®è¡Œå³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®ã€‚ éèšç°‡ç´¢å¼•æ˜¯ç›¸å¯¹äºèšç°‡ç´¢å¼•æ¥è¯´çš„ï¼Œæˆ‘ä»¬åˆç§°ä¸ºè¾…åŠ©ç´¢å¼•æˆ–äºŒçº§ç´¢å¼•ã€‚ InnoDB çš„äºŒçº§ç´¢å¼• data åŸŸå­˜å‚¨çš„æ˜¯ç›¸åº”è®°å½•ä¸»é”®çš„å€¼è€Œä¸æ˜¯ç‰©ç†ä½ç½®çš„æŒ‡é’ˆã€‚ å›è¡¨äº†è§£äº† InnoDB ç´¢å¼•çš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¾ˆå®¹æ˜“ç†è§£ â€œå›è¡¨â€ è¿™ä¸ªæ¦‚å¿µäº†ã€‚ èšç°‡ç´¢å¼•è¿™ç§å®ç°æ–¹å¼ä½¿å¾—æŒ‰ä¸»é”®çš„æœç´¢ååˆ†é«˜æ•ˆï¼Œä½†æ˜¯äºŒçº§ç´¢å¼•æœç´¢éœ€è¦æ£€ç´¢ä¸¤éç´¢å¼•ï¼šé¦–å…ˆæ£€ç´¢äºŒçº§ç´¢å¼•è·å¾—ä¸»é”®ï¼Œç„¶åç”¨ä¸»é”®åˆ°ä¸»ç´¢å¼•ä¸­æ£€ç´¢è·å¾—è®°å½•ã€‚ è®©æˆ‘ä»¬å›åˆ°å¼€å¤´è¯´çš„é‚£ä¸ªä¾‹å­ï¼š1SELECT a FROM ... WHERE b = ... æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹æŸ¥è¯¢çš„å¤„ç†è¿‡ç¨‹ï¼šåœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šæŸ¥è¯¢ â€œbâ€ ç´¢å¼•è¿›è¡Œå®šä½ï¼Œç„¶åå›è¡¨æŸ¥è¯¢éœ€è¦çš„æ•°æ® â€œaâ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ä¸¤æ¬¡æŸ¥è¯¢ï¼Œä¸€æ¬¡æ˜¯æŸ¥è¯¢ç´¢å¼•ï¼Œå¦ä¸€æ¬¡æ˜¯æŸ¥è¯¢è¡¨ã€‚ é‚£æœ‰æ²¡æœ‰åŠæ³•ç”¨ä¸€æ¬¡æŸ¥è¯¢æå®šé—®é¢˜å‘¢ï¼Ÿæœ‰ï¼Œå°±æ˜¯ Covering Indexï¼ è¯´åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³èµ·æ¥ MySQL5.6 ä¸­å¼•å…¥çš„ MRRï¼ˆMulti-Range Readï¼Œå¤šèŒƒå›´è¯»ï¼‰ï¼Œå®ƒæ˜¯ä¸“é—¨æ¥ä¼˜åŒ–äºŒçº§ç´¢å¼•çš„èŒƒå›´æ‰«æå¹¶ä¸”éœ€è¦å›è¡¨çš„æƒ…å†µã€‚å®ƒçš„åŸç†æ˜¯ï¼Œå°†å¤šä¸ªéœ€è¦å›è¡¨çš„äºŒçº§ç´¢å¼•æ ¹æ®ä¸»é”®è¿›è¡Œæ’åºï¼Œç„¶åä¸€èµ·å›è¡¨ï¼Œå°†åŸæ¥çš„å›è¡¨æ—¶è¿›è¡Œçš„éšæœº IOï¼Œè½¬å˜æˆé¡ºåº IOã€‚MRR çš„ä¼˜åŠ¿æ˜¯å°†å¤šä¸ªéšæœº IO è½¬æ¢æˆè¾ƒå°‘æ•°é‡çš„é¡ºåº IOï¼Œæ‰€ä»¥å¯¹äº SSD æ¥è¯´ä»·å€¼è¿˜æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ç›¸æ¯”æœºæ¢°ç£ç›˜æ¥è¯´æ„ä¹‰å°ä¸€äº›ã€‚ Covering Indexæ‰€è°“ Covering Indexï¼Œå°±æ˜¯è¯´ä¸å¿…æŸ¥è¯¢è¡¨æ–‡ä»¶ï¼Œå•é æŸ¥è¯¢ç´¢å¼•æ–‡ä»¶å³å¯å®Œæˆã€‚ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„å¥½å¤„æ˜¯è¾…åŠ©ç´¢å¼•ä¸åŒ…å«æ•´è¡Œè®°å½•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ•…å…¶å¤§å°è¦è¿œå°äºèšé›†ç´¢å¼•ï¼Œå› æ­¤å¯ä»¥å‡å°‘å¤§é‡çš„ IO æ“ä½œã€‚ å…·ä½“åˆ°ä¸Šè¾¹çš„ä¾‹å­ä¸­å°±æ˜¯å»ºç«‹ä¸€ä¸ªå¤åˆç´¢å¼• (b, a)ï¼Œå½“æŸ¥è¯¢è¿›è¡Œæ—¶ï¼Œé€šè¿‡å¤åˆç´¢å¼•çš„ â€œbâ€ éƒ¨åˆ†å»å®šä½ï¼Œè‡³äºéœ€è¦çš„æ•°æ® â€œaâ€ï¼Œç«‹åˆ»å°±å¯ä»¥åœ¨ç´¢å¼•é‡Œå¾—åˆ°ï¼Œä»è€Œçœç•¥äº†è¡¨æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚ å¦‚æœä½ æƒ³åˆ©ç”¨ Covering Indexï¼Œé‚£ä¹ˆå°±è¦æ³¨æ„ SELECT æ–¹å¼ï¼Œåª SELECT å¿…è¦çš„å­—æ®µï¼Œåƒä¸‡åˆ«SELECT * FROM â€¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¤ªå¯èƒ½æŠŠæ‰€æœ‰çš„å­—æ®µä¸€èµ·åšç´¢å¼•ï¼Œè™½ç„¶å¯ä»¥é‚£æ ·åšï¼Œä½†é‚£æ ·ä¼šè®©ç´¢å¼•æ–‡ä»¶è¿‡å¤§ï¼Œç»“æœåå€’ä¼šå¼„å·§æˆæ‹™ã€‚ å¦‚ä½•æ‰èƒ½ç¡®è®¤æŸ¥è¯¢ä½¿ç”¨äº† Covering Index å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨ EXPLAIN å³å¯ï¼åªè¦åœ¨ Extra é‡Œå‡ºç°Using indexå°±è¯´æ˜ä½¿ç”¨çš„æ˜¯ Covering Indexã€‚ è¿™é‡Œå†ä¸¾ä¸¤ä¸ªæ —å­ï¼Œè®©å¤§å®¶å°è±¡æ·±ç‚¹ã€‚ ä¾‹å­ä¸€ åœ¨æ–‡ç« ç³»ç»Ÿé‡Œç»Ÿè®¡æ€»æ•°çš„æ—¶å€™ï¼Œä¸€èˆ¬çš„æŸ¥è¯¢æ˜¯è¿™æ ·çš„ï¼š1SELECT COUNT(*) FROM article WHERE category_id = ... å½“æˆ‘ä»¬åœ¨category_idå»ºç«‹ç´¢å¼•åï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨çš„å°±æ˜¯ Covering Indexã€‚ å‚è€ƒæ–‡æ¡£ï¼šCOUNT(*) vs COUNT(col) ä¾‹å­äºŒåœ¨æ–‡ç« ç³»ç»Ÿé‡Œåˆ†é¡µæ˜¾ç¤ºçš„æ—¶å€™ï¼Œä¸€èˆ¬çš„æŸ¥è¯¢æ˜¯è¿™æ ·çš„ï¼š1SELECT id, title, content FROM article ORDER BY created DESC LIMIT 10000, 10; é€šå¸¸è¿™æ ·çš„æŸ¥è¯¢ä¼šæŠŠç´¢å¼•å»ºåœ¨createdå­—æ®µï¼ˆå…¶ä¸­idæ˜¯ä¸»é”®ï¼‰ï¼Œä¸è¿‡å½“LIMITåç§»å¾ˆå¤§æ—¶ï¼ŒæŸ¥è¯¢æ•ˆç‡ä»ç„¶å¾ˆä½ï¼Œè¿™æ—¶è¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š1234SELECT id, title, content FROM articleINNER JOIN ( SELECT id FROM article ORDER BY created DESC LIMIT 10000, 10) AS page USING(id); æ­¤æ—¶ï¼Œå°±å¯ä»¥åœ¨å­æŸ¥è¯¢é‡Œåˆ©ç”¨ä¸Š Covering Indexï¼Œå¿«é€Ÿå®šä½ idï¼ŒæŸ¥è¯¢æ•ˆç‡å—·å—·çš„ã€‚ åŸºäºæˆ‘çš„æµ‹è¯•æ•°æ®ï¼Œè¿™ä¸¤æ¡è¯­å¥çš„æŸ¥è¯¢è€—æ—¶åˆ†åˆ«æ˜¯ â€œ0.08 ç§’â€ å’Œâ€œ0.01 ç§’ä»¥å†…â€ï¼Œ8 å€çš„å·®è·å•Šï¼ä¸ç”±åˆæƒ³èµ·äº†åœ°ç²¾çš„ç»å…¸è¯­å½•æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œæˆ‘çš„æœ‹å‹ï¼ è¡¥å……ï¼šInnoDB å¼•æ“å±‚æ˜¯ä¼šå¯¹äºŒçº§ç´¢å¼•åšè‡ªåŠ¨æ‰©å±•ï¼Œä¼˜åŒ–å™¨èƒ½è¯†åˆ«å‡ºæ‰©å±•çš„ä¸»é”®ã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ã€‚ æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸¤æ¡è¯­å¥åˆ†åˆ«å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’1234567891011121314151617mysql> EXPLAIN SELECT SQL_NO_CACHE id, title, content FROM article ORDER BY created DESC LIMIT 10000, 10;+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+| 1 | SIMPLE | article | NULL | ALL | NULL | NULL | NULL | NULL | 99210 | 100.00 | Using filesort |+----+-------------+---------+------------+------+---------------+------+---------+------+-------+----------+----------------+1 row in set, 2 warnings (0.00 sec)mysql> EXPLAIN SELECT SQL_NO_CACHE id, title, content FROM article INNER JOIN ( SELECT id FROM article ORDER BY created DESC LIMIT 10000, 10 ) AS page USING(id);+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+| 1 | PRIMARY | | NULL | ALL | NULL | NULL | NULL | NULL | 10010 | 100.00 | NULL || 1 | PRIMARY | article | NULL | eq_ref | PRIMARY | PRIMARY | 4 | page.id | 1 | 100.00 | NULL || 2 | DERIVED | article | NULL | index | NULL | idx_created | 5 | NULL | 10010 | 100.00 | Backward index scan; Using index |+----+-------------+------------+------------+--------+---------------+-------------+---------+---------+-------+----------+----------------------------------+3 rows in set, 2 warnings (0.00 sec) é€šè¿‡ EXPLAIN æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºï¼Œç¬¬ä¸€ä¸ªæŸ¥è¯¢æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼ŒExtra é‡Œæ˜¯ â€œUsing filesortâ€ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…çš„æƒ…å†µã€‚è€Œç¬¬äºŒä¸ªçš„ Extra æ˜¯ â€œUsing indexâ€ï¼Œæ‰€ä»¥è¿™ä¸¤è€…é—´æ•ˆç‡ä¸Šçš„å·®è·å°±æ˜¾è€Œæ˜“è§äº†ã€‚ æ€»ç»“Covering Index å¹¶ä¸æ˜¯ä»€ä¹ˆå¾ˆéš¾çš„æ¦‚å¿µï¼Œä½†æ˜¯æœ‰äº›äººè¿˜ä¸äº†è§£å®ƒæˆ–å¿½è§†å®ƒçš„ä»·å€¼ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½ç»™ä½ æä¸ªé†’ã€‚ å‚è€ƒ MySQL è¦†ç›–ç´¢å¼• MySQL ç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç† MySQL è®¤è¯†ç´¢å¼• è°ˆè°ˆ SQL æŸ¥è¯¢ä¸­å›è¡¨å¯¹æ€§èƒ½çš„å½±å“ MySQL ä¼˜åŒ–ä¹‹ MRR (Multi-Range Read: äºŒçº§ç´¢å¼•åˆå¹¶å›è¡¨) å…³äº MySQL InnoDB è¡¨çš„äºŒçº§ç´¢å¼•æ˜¯å¦åŠ å…¥ä¸»é”®åˆ—çš„é—®é¢˜è§£é‡Š document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[rsync å‘½ä»¤è¯¦è§£]]></title>
    <url>%2F2019%2F03%2F29%2Frsync%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯ RsyncRsyncï¼ˆremote synchronizeï¼‰æ˜¯ä¸€ä¸ªè¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯é€šè¿‡ LAN/WAN å¿«é€ŸåŒæ­¥å¤šå°ä¸»æœºé—´çš„æ–‡ä»¶ã€‚Rsync ä½¿ç”¨æ‰€è°“çš„ â€œRsync ç®—æ³•â€ æ¥ä½¿æœ¬åœ°å’Œè¿œ ç¨‹ä¸¤ä¸ªä¸»æœºä¹‹é—´çš„æ–‡ä»¶è¾¾åˆ°åŒæ­¥ï¼Œè¿™ä¸ªç®—æ³•åªä¼ é€ä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½æ•´ä»½ä¼ é€ï¼Œå› æ­¤é€Ÿåº¦ç›¸å½“å¿«ã€‚ Rsync æœ¬æ¥æ˜¯ç”¨äºæ›¿ä»£ rcp çš„ä¸€ä¸ªå·¥å…·ï¼Œç›®å‰ç”± samba ç»´æŠ¤ï¼Œæ‰€ä»¥ rsync.conf æ–‡ä»¶çš„æ ¼å¼ç±»ä¼¼äº Samba çš„ ä¸»é…ç½®æ–‡ä»¶ã€‚Rsync å¯ä»¥é€šè¿‡ rsh æˆ– ssh ä½¿ç”¨ï¼Œä¹Ÿèƒ½ä»¥ daemon æ¨¡å¼å»è¿è¡Œï¼Œåœ¨ä»¥ daemon æ–¹å¼è¿è¡Œæ—¶ Rsync server ä¼šæ‰“å¼€ä¸€ä¸ª 873 ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯å»è¿æ¥ã€‚è¿æ¥æ—¶ï¼ŒRsync server ä¼šæ£€æŸ¥å£ä»¤æ˜¯å¦ç›¸ç¬¦ï¼Œè‹¥é€šè¿‡å£ä»¤æŸ¥æ ¸ï¼Œåˆ™å¯ä»¥å¼€å§‹è¿›è¡Œæ–‡ä»¶ä¼ è¾“ã€‚ç¬¬ä¸€æ¬¡è¿é€šå®Œæˆæ—¶ï¼Œä¼šæŠŠæ•´ä»½æ–‡ä»¶ä¼ è¾“ä¸€æ¬¡ï¼Œä»¥ååˆ™å°±åªéœ€è¿›è¡Œå¢é‡å¤‡ä»½ã€‚ Rsync æ”¯æŒå¤§å¤šæ•°çš„ç±» Unix ç³»ç»Ÿï¼Œæ— è®ºæ˜¯ Linuxã€Solaris è¿˜æ˜¯ BSD ä¸Šéƒ½ç»è¿‡äº†è‰¯å¥½çš„æµ‹è¯•ã€‚æ­¤å¤–ï¼Œå®ƒåœ¨ windows å¹³å°ä¸‹ä¹Ÿæœ‰ç›¸åº”çš„ç‰ˆæœ¬ï¼Œå¦‚ cwRsync å’Œ Sync2NAS ç­‰å·¥å…·ã€‚ Rsync çš„åŸºæœ¬ç‰¹ç‚¹å¦‚ä¸‹ï¼š å¯ä»¥é•œåƒä¿å­˜æ•´ä¸ªç›®å½•æ ‘å’Œæ–‡ä»¶ç³»ç»Ÿï¼› å¯ä»¥å¾ˆå®¹æ˜“åšåˆ°ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰ï¼› æ— é¡»ç‰¹æ®Šæƒé™å³å¯å®‰è£…ï¼› ä¼˜åŒ–çš„æµç¨‹ï¼Œæ–‡ä»¶ä¼ è¾“æ•ˆç‡é«˜ï¼› å¯ä»¥ä½¿ç”¨ rshã€ssh ç­‰æ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç›´æ¥çš„ socket è¿æ¥ï¼› æ”¯æŒåŒ¿åä¼ è¾“ã€‚ Rsync åŒæ­¥ç®—æ³•Rsync åªæ‰€ä»¥åŒæ­¥æ–‡ä»¶çš„é€Ÿåº¦ç›¸å½“å¿«ï¼Œæ˜¯å› ä¸º â€œRsync åŒæ­¥ç®—æ³•â€ èƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è®¡ç®—å‡ºéœ€è¦å¤‡ä»½çš„æ•°æ®ï¼Œå…³äº Rsync çš„åŒæ­¥ç®—æ³•æè¿°å¦‚ä¸‹ï¼š å‡å®šåœ¨ 1 å·å’Œ 2 å·ä¸¤å°è®¡ç®—æœºä¹‹é—´åŒæ­¥ç›¸ä¼¼çš„æ–‡ä»¶ A ä¸ Bï¼Œå…¶ä¸­ 1 å·å¯¹æ–‡ä»¶ A æ‹¥æœ‰è®¿é—®æƒï¼Œ2 å·å¯¹æ–‡ä»¶ B æ‹¥æœ‰è®¿é—®æƒã€‚å¹¶ä¸”å‡å®šä¸»æœº 1 å·ä¸ 2 å·ä¹‹é—´çš„ç½‘ç»œå¸¦å®½å¾ˆå°ã€‚é‚£ä¹ˆ rsync ç®—æ³•å°†é€šè¿‡ä¸‹é¢çš„äº”ä¸ªæ­¥éª¤æ¥å®Œæˆï¼š 2 å·å°†æ–‡ä»¶ B åˆ†å‰²æˆä¸€ç»„ä¸é‡å çš„å›ºå®šå¤§å°ä¸º S å­—èŠ‚çš„æ•°æ®å—ï¼Œæœ€åä¸€å—å¯èƒ½ä¼šæ¯” S å°ã€‚ 2 å·å¯¹æ¯ä¸€ä¸ªåˆ†å‰²å¥½çš„æ•°æ®å—æ‰§è¡Œä¸¤ç§æ ¡éªŒï¼šä¸€ç§æ˜¯ 32 ä½çš„æ»šåŠ¨å¼±æ ¡éªŒï¼Œå¦ä¸€ç§æ˜¯ 128 ä½çš„ MD4 å¼ºæ ¡éªŒ 2 å·å°†è¿™äº›æ ¡éªŒç»“æœå‘ç»™ 1 å·ã€‚ 1 å·é€šè¿‡æœç´¢æ–‡ä»¶ A çš„æ‰€æœ‰å¤§å°ä¸º S çš„æ•°æ®å— (åç§»é‡å¯ä»¥ä»»é€‰ï¼Œä¸ä¸€å®šéè¦æ˜¯ S çš„å€æ•°)ï¼Œæ¥å¯»æ‰¾ä¸æ–‡ä»¶ B çš„æŸä¸€å—æœ‰ç€ç›¸åŒçš„å¼±æ ¡éªŒç å’Œå¼ºæ ¡éªŒç çš„æ•°æ®å—ã€‚è¿™é¡¹å·¥ä½œå¯ä»¥å€ŸåŠ©æ»šåŠ¨æ ¡éªŒçš„ç‰¹æ€§å¾ˆå¿«å®Œæˆã€‚ 1 å·å‘ç»™ 2 å·ä¸€ä¸²æŒ‡ä»¤æ¥ç”Ÿæˆæ–‡ä»¶ A åœ¨ 2 å·ä¸Šçš„å¤‡ä»½ã€‚è¿™é‡Œçš„æ¯ä¸€æ¡æŒ‡ä»¤è¦ä¹ˆæ˜¯å¯¹æ–‡ä»¶ B ç»æ‹¥æœ‰æŸä¸€ä¸ªæ•°æ®å—è€Œä¸é¡»é‡ä¼ çš„è¯æ˜ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªæ•°æ®å—ï¼Œè¿™ä¸ªæ•°æ®å—è‚¯å®šæ˜¯æ²¡æœ‰ä¸æ–‡ä»¶ B çš„ä»»ä½•ä¸€ä¸ªæ•°æ®å—åŒ¹é…ä¸Šçš„ã€‚ Rsync å‚æ•°è¯´æ˜é…ç½®æ–‡ä»¶ï¼šrsyncd.conf å…¨å±€å‚æ•°åœ¨æ–‡ä»¶ä¸­ï¼Œ[module]ä¹‹å‰çš„æ‰€æœ‰å‚æ•°éƒ½æ˜¯å…¨å±€å‚æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å…¨å±€å‚æ•°éƒ¨åˆ†å®šä¹‰æ¨¡å—å‚æ•°ï¼Œè¿™æ—¶å€™è¯¥å‚æ•°çš„å€¼å°±æ˜¯æ‰€æœ‰æ¨¡å—çš„é»˜è®¤å€¼ã€‚ portæŒ‡å®šåå°ç¨‹åºä½¿ç”¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º 873ã€‚ motd fileç”¨æ¥æŒ‡å®šä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶ï¼Œå½“å®¢æˆ·è¿æ¥æœåŠ¡å™¨æ—¶è¯¥æ–‡ä»¶çš„å†…å®¹æ˜¾ç¤ºç»™å®¢æˆ·ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ motd æ–‡ä»¶çš„ã€‚ log fileæŒ‡å®š rsync çš„æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸å°†æ—¥å¿—å‘é€ç»™ syslogã€‚æ¯”å¦‚å¯æŒ‡å®šä¸º /var/log/rsyncd.logã€‚ pid fileæŒ‡å®š rsync çš„ pid æ–‡ä»¶ï¼Œé€šå¸¸æŒ‡å®šä¸º /var/run/rsyncd.pidã€‚ syslog facilityæŒ‡å®š rsync å‘é€æ—¥å¿—æ¶ˆæ¯ç»™ syslog æ—¶çš„æ¶ˆæ¯çº§åˆ«ï¼Œå¸¸è§çš„æ¶ˆæ¯çº§åˆ«æ˜¯ï¼š daemon é»˜è®¤å€¼ uth authpriv cron daemon ftp kern lpr mail news security sys-log user uucp local0 local1 local2 local3 local4 local5 local6 local7 æ¨¡å—å‚æ•°ä¸»è¦æ˜¯å®šä¹‰æœåŠ¡å™¨å“ªä¸ªç›®å½•è¦è¢«åŒæ­¥ã€‚å…¶æ ¼å¼å¿…é¡»ä¸ºâ€œ[module]â€å½¢å¼ï¼Œè¿™ä¸ªåå­—å°±æ˜¯åœ¨ rsync å®¢æˆ·ç«¯çœ‹åˆ°çš„åå­—ï¼Œå…¶å®æœ‰ç‚¹è±¡ Samba æœåŠ¡å™¨æä¾›çš„å…±äº«åã€‚è€ŒæœåŠ¡å™¨çœŸæ­£åŒæ­¥çš„æ•°æ®æ˜¯é€šè¿‡ path æ¥æŒ‡å®šçš„ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œæ¥æŒ‡å®šå¤šä¸ªæ¨¡å—ï¼Œæ¨¡å—ä¸­å¯ä»¥å®šä¹‰ä»¥ä¸‹å‚æ•°ï¼š commentç»™æ¨¡å—æŒ‡å®šä¸€ä¸ªæè¿°ï¼Œè¯¥æè¿°è¿åŒæ¨¡å—ååœ¨å®¢æˆ·è¿æ¥å¾—åˆ°æ¨¡å—åˆ—è¡¨æ—¶æ˜¾ç¤ºç»™å®¢æˆ·ã€‚é»˜è®¤æ²¡æœ‰æè¿°å®šä¹‰ã€‚ pathæŒ‡å®šè¯¥æ¨¡å—çš„ä¾›å¤‡ä»½çš„ç›®å½•æ ‘è·¯å¾„ï¼Œè¯¥å‚æ•°æ˜¯å¿…é¡»æŒ‡å®šçš„ã€‚ use chrootå¦‚æœæŒ‡å®šä¸º trueï¼Œé‚£ä¹ˆ rsync åœ¨ä¼ è¾“æ–‡ä»¶ä»¥å‰é¦–å…ˆ chroot åˆ° path å‚æ•°æ‰€æŒ‡å®šçš„ç›®å½•ä¸‹ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å®ç°é¢å¤–çš„å®‰å…¨é˜²æŠ¤ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯éœ€è¦ä»¥ root æƒé™ï¼Œå¹¶ä¸”ä¸èƒ½å¤‡ä»½æŒ‡å‘å¤–éƒ¨çš„ç¬¦å·è¿æ¥æ‰€æŒ‡å‘çš„ç›®å½•æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º trueã€‚ uidæŒ‡å®šå½“è¯¥æ¨¡å—ä¼ è¾“æ–‡ä»¶æ—¶å®ˆæŠ¤è¿›ç¨‹åº”è¯¥å…·æœ‰çš„ uidï¼Œé…åˆ gidé€‰é¡¹ä½¿ç”¨å¯ä»¥ç¡®å®šå“ªäº›å¯ä»¥è®¿é—®æ€ä¹ˆæ ·çš„æ–‡ä»¶æƒé™ï¼Œé»˜è®¤å€¼æ˜¯â€nobodyâ€ã€‚ gidæŒ‡å®šå½“è¯¥æ¨¡å—ä¼ è¾“æ–‡ä»¶æ—¶å®ˆæŠ¤è¿›ç¨‹åº”è¯¥å…·æœ‰çš„ gidã€‚é»˜è®¤å€¼ä¸ºâ€nobodyâ€ã€‚ max connectionsæŒ‡å®šè¯¥æ¨¡å—çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°é‡ä»¥ä¿æŠ¤æœåŠ¡å™¨ï¼Œè¶…è¿‡é™åˆ¶çš„è¿æ¥è¯·æ±‚å°†è¢«å‘ŠçŸ¥éšåå†è¯•ã€‚é»˜è®¤å€¼æ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰é™åˆ¶ã€‚ listè¯¥é€‰é¡¹è®¾å®šå½“å®¢æˆ·è¯·æ±‚å¯ä»¥ä½¿ç”¨çš„æ¨¡å—åˆ—è¡¨æ—¶ï¼Œè¯¥æ¨¡å—æ˜¯å¦åº”è¯¥è¢«åˆ—å‡ºã€‚å¦‚æœè®¾ç½®è¯¥é€‰é¡¹ä¸º falseï¼Œå¯ä»¥åˆ›å»ºéšè—çš„æ¨¡å—ã€‚é»˜è®¤å€¼æ˜¯ trueã€‚ read onlyè®¾å®šæ˜¯å¦å…è®¸å®¢æˆ·ä¸Šè½½æ–‡ä»¶ã€‚å¦‚æœä¸º true é‚£ä¹ˆä»»ä½•ä¸Šè½½è¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼Œå¦‚æœä¸º false å¹¶ä¸”æœåŠ¡å™¨ç›®å½•è¯»å†™æƒé™å…è®¸é‚£ä¹ˆä¸Šè½½æ˜¯å…è®¸çš„ã€‚é»˜è®¤å€¼ä¸º trueã€‚ excludeç”¨æ¥æŒ‡å®šå¤šä¸ªç”±ç©ºæ ¼éš”å¼€çš„å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½• (ç›¸å¯¹è·¯å¾„)ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° exclude åˆ—è¡¨ä¸­ã€‚è¿™ç­‰åŒäºåœ¨å®¢æˆ·ç«¯å‘½ä»¤ä¸­ä½¿ç”¨--excludeæ¥æŒ‡å®š æ¨¡å¼ï¼Œä¸€ä¸ªæ¨¡å—åªèƒ½æŒ‡å®šä¸€ä¸ª exclude é€‰é¡¹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¯¥é€‰é¡¹æœ‰ä¸€å®šçš„å®‰å…¨æ€§é—®é¢˜ï¼Œå®¢æˆ·å¾ˆæœ‰å¯èƒ½ç»•è¿‡ exclude åˆ—è¡¨ï¼Œå¦‚æœå¸Œæœ›ç¡®ä¿ç‰¹å®š çš„æ–‡ä»¶ä¸èƒ½è¢«è®¿é—®ï¼Œé‚£å°±æœ€å¥½ç»“åˆ uid/gid é€‰é¡¹ä¸€èµ·ä½¿ç”¨ã€‚ exclude fromæŒ‡å®šä¸€ä¸ªåŒ…å« exclude æ¨¡å¼çš„å®šä¹‰çš„æ–‡ä»¶åï¼ŒæœåŠ¡å™¨ä»è¯¥æ–‡ä»¶ä¸­è¯»å– exclude åˆ—è¡¨å®šä¹‰ã€‚ includeç”¨æ¥æŒ‡å®šä¸æ’é™¤ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚è¿™ç­‰åŒäºåœ¨å®¢æˆ·ç«¯å‘½ä»¤ä¸­ä½¿ç”¨â€“include æ¥æŒ‡å®šæ¨¡å¼ï¼Œç»“åˆ include å’Œ exclude å¯ä»¥å®šä¹‰å¤æ‚çš„ exclude/include è§„åˆ™ã€‚ include fromæŒ‡å®šä¸€ä¸ªåŒ…å« include æ¨¡å¼çš„å®šä¹‰çš„æ–‡ä»¶åï¼ŒæœåŠ¡å™¨ä»è¯¥æ–‡ä»¶ä¸­è¯»å– include åˆ—è¡¨å®šä¹‰ã€‚ auth usersæŒ‡å®šç”±ç©ºæ ¼æˆ–é€—å·åˆ†éš”çš„ç”¨æˆ·ååˆ—è¡¨ï¼Œåªæœ‰è¿™äº›ç”¨æˆ·æ‰å…è®¸è¿æ¥è¯¥æ¨¡å—ã€‚è¿™é‡Œçš„ç”¨æˆ·å’Œç³»ç»Ÿç”¨æˆ·æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚å¦‚æœâ€auth usersâ€ è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘å‡ºå¯¹è¯¥æ¨¡å—çš„è¿æ¥è¯·æ±‚ä»¥åä¼šè¢« rsync è¯·æ±‚ challenged è¿›è¡ŒéªŒè¯èº«ä»½è¿™é‡Œä½¿ç”¨çš„ challenge/response è®¤è¯åè®®ã€‚ç”¨æˆ·çš„åå’Œå¯†ç ä»¥æ˜æ–‡æ–¹å¼å­˜æ”¾åœ¨â€secrets fileâ€ é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹æ— éœ€å¯†ç å°±å¯ä»¥è¿æ¥æ¨¡å— (ä¹Ÿå°±æ˜¯åŒ¿åæ–¹å¼)ã€‚ secrets fileæŒ‡å®šä¸€ä¸ªåŒ…å«å®šä¹‰ç”¨æˆ·å: å¯†ç å¯¹çš„æ–‡ä»¶ã€‚åªæœ‰åœ¨â€auth usersâ€ è¢«å®šä¹‰æ—¶ï¼Œè¯¥æ–‡ä»¶æ‰æœ‰ä½œç”¨ã€‚æ–‡ä»¶æ¯è¡ŒåŒ…å«ä¸€ä¸ª username:passwd å¯¹ã€‚ä¸€èˆ¬æ¥è¯´å¯†ç æœ€å¥½ä¸è¦è¶…è¿‡ 8 ä¸ªå­—ç¬¦ã€‚æ²¡æœ‰é»˜è®¤çš„ secures fileï¼Œéœ€è¦é™å¼æŒ‡å®šä¸€ä¸ª (ä¾‹å¦‚ï¼š/etc/rsyncd.passwd)ã€‚æ³¨æ„ï¼šè¯¥æ–‡ä»¶çš„æƒé™ä¸€å®šè¦æ˜¯ 600ï¼Œå¦åˆ™å®¢æˆ·ç«¯å°†ä¸èƒ½è¿æ¥æœåŠ¡å™¨ã€‚ strict modesæŒ‡å®šæ˜¯å¦ç›‘æµ‹å¯†ç æ–‡ä»¶çš„æƒé™ï¼Œå¦‚æœè¯¥é€‰é¡¹å€¼ä¸º true é‚£ä¹ˆå¯†ç æ–‡ä»¶åªèƒ½è¢« rsync æœåŠ¡å™¨è¿è¡Œèº«ä»½çš„ç”¨æˆ·è®¿é—®ï¼Œå…¶ä»–ä»»ä½•ç”¨æˆ·ä¸å¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º trueã€‚ hosts allowæŒ‡å®šå“ªäº› IP çš„å®¢æˆ·å…è®¸è¿æ¥è¯¥æ¨¡å—ã€‚å®¢æˆ·æ¨¡å¼å®šä¹‰å¯ä»¥æ˜¯ä»¥ä¸‹å½¢å¼ï¼š å•ä¸ª IP åœ°å€ï¼Œä¾‹å¦‚ï¼š192.167.0.1 æ•´ä¸ªç½‘æ®µï¼Œä¾‹å¦‚ï¼š192.168.0.0/24ï¼Œä¹Ÿå¯ä»¥æ˜¯ 192.168.0.0/255.255.255.0 å¤šä¸ª IP æˆ–ç½‘æ®µéœ€è¦ç”¨ç©ºæ ¼éš”å¼€ï¼Œâ€œ*â€ åˆ™è¡¨ç¤ºæ‰€æœ‰ï¼Œé»˜è®¤æ˜¯å…è®¸æ‰€æœ‰ä¸»æœºè¿æ¥ã€‚ hosts denyæŒ‡å®šä¸å…è®¸è¿æ¥ rsync æœåŠ¡å™¨çš„æœºå™¨ï¼Œå¯ä»¥ä½¿ç”¨ hosts allow çš„å®šä¹‰æ–¹å¼æ¥è¿›è¡Œå®šä¹‰ã€‚é»˜è®¤æ˜¯æ²¡æœ‰ hosts deny å®šä¹‰ã€‚ ignore errorsæŒ‡å®š rsyncd åœ¨åˆ¤æ–­æ˜¯å¦è¿è¡Œä¼ è¾“æ—¶çš„åˆ é™¤æ“ä½œæ—¶å¿½ç•¥ server ä¸Šçš„ IO é”™è¯¯ï¼Œä¸€èˆ¬æ¥è¯´ rsync åœ¨å‡ºç° IO é”™è¯¯æ—¶å°†å°†è·³è¿‡--deleteæ“ä½œï¼Œä»¥é˜²æ­¢å› ä¸ºæš‚æ—¶çš„èµ„æºä¸è¶³æˆ–å…¶å®ƒ IO é”™è¯¯å¯¼è‡´çš„ä¸¥é‡é—®é¢˜ã€‚ ignore nonreadableæŒ‡å®š rysnc æœåŠ¡å™¨å®Œå…¨å¿½ç•¥é‚£äº›ç”¨æˆ·æ²¡æœ‰è®¿é—®æƒé™çš„æ–‡ä»¶ã€‚è¿™å¯¹äºåœ¨éœ€è¦å¤‡ä»½çš„ç›®å½•ä¸­æœ‰äº›æ–‡ä»¶æ˜¯ä¸åº”è¯¥è¢«å¤‡ä»½è€…å¾—åˆ°çš„æƒ…å†µæ˜¯æœ‰æ„ä¹‰çš„ã€‚ lock fileæŒ‡å®šæ”¯æŒ max connections å‚æ•°çš„é”æ–‡ä»¶ï¼Œé»˜è®¤å€¼æ˜¯ /var/run/rsyncd.lockã€‚ transfer loggingä½¿ rsync æœåŠ¡å™¨ä½¿ç”¨ ftp æ ¼å¼çš„æ–‡ä»¶æ¥è®°å½•ä¸‹è½½å’Œä¸Šè½½æ“ä½œåœ¨è‡ªå·±å•ç‹¬çš„æ—¥å¿—ä¸­ã€‚ log formaté€šè¿‡è¯¥é€‰é¡¹ç”¨æˆ·åœ¨ä½¿ç”¨ transfer logging å¯ä»¥è‡ªå·±å®šåˆ¶æ—¥å¿—æ–‡ä»¶çš„å­—æ®µã€‚å…¶æ ¼å¼æ˜¯ä¸€ä¸ªåŒ…å«æ ¼å¼å®šä¹‰ç¬¦çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨çš„æ ¼å¼å®šä¹‰ç¬¦å¦‚ä¸‹ï¼š12345678910111213%h è¿œç¨‹ä¸»æœºå%a è¿œç¨‹IPåœ°å€%l æ–‡ä»¶é•¿åº¦å­—ç¬¦æ•°%p è¯¥æ¬¡rsyncä¼šè¯çš„è¿›ç¨‹id%o æ“ä½œç±»å‹ï¼š"send"æˆ–"recv"%f æ–‡ä»¶å%P æ¨¡å—è·¯å¾„%m æ¨¡å—å%t å½“å‰æ—¶é—´%u è®¤è¯çš„ç”¨æˆ·å(åŒ¿åæ—¶æ˜¯null)%b å®é™…ä¼ è¾“çš„å­—èŠ‚æ•°%c å½“å‘é€æ–‡ä»¶æ—¶ï¼Œè¯¥å­—æ®µè®°å½•è¯¥æ–‡ä»¶çš„æ ¡éªŒç é»˜è®¤logæ ¼å¼ä¸ºï¼š`%o %h [%a] %m (%u) %f %l`ï¼Œä¸€èˆ¬æ¥è¯´,åœ¨æ¯è¡Œçš„å¤´ä¸Šä¼šæ·»åŠ `%t [%p]`ã€‚åœ¨æºä»£ç ä¸­åŒæ—¶å‘å¸ƒæœ‰ä¸€ä¸ªå«rsyncstatsçš„perlè„šæœ¬ç¨‹åºæ¥ç»Ÿè®¡è¿™ç§æ ¼å¼çš„æ—¥å¿—æ–‡ä»¶ã€‚ timeouté€šè¿‡è¯¥é€‰é¡¹å¯ä»¥è¦†ç›–å®¢æˆ·æŒ‡å®šçš„ IP è¶…æ—¶æ—¶é—´ã€‚é€šè¿‡è¯¥é€‰é¡¹å¯ä»¥ç¡®ä¿ rsync æœåŠ¡å™¨ä¸ä¼šæ°¸è¿œç­‰å¾…ä¸€ä¸ªå´©æºƒçš„å®¢æˆ·ç«¯ã€‚è¶…æ—¶å•ä½ä¸ºç§’é’Ÿï¼Œ0 è¡¨ç¤ºæ²¡æœ‰è¶…æ—¶å®šä¹‰ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚å¯¹äºåŒ¿å rsync æœåŠ¡å™¨æ¥è¯´ï¼Œä¸€ä¸ªç†æƒ³çš„æ•°å­—æ˜¯ 600ã€‚ refuse optionsé€šè¿‡è¯¥é€‰é¡¹å¯ä»¥å®šä¹‰ä¸€äº›ä¸å…è®¸å®¢æˆ·å¯¹è¯¥æ¨¡å—ä½¿ç”¨çš„å‘½ä»¤å‚æ•°åˆ—è¡¨ã€‚è¿™é‡Œå¿…é¡»ä½¿ç”¨å‘½ä»¤å…¨åï¼Œè€Œä¸èƒ½æ˜¯ç®€ç§°ã€‚ä½†å‘ç”Ÿæ‹’ç»æŸä¸ªå‘½ä»¤çš„æƒ…å†µæ—¶æœåŠ¡å™¨å°†æŠ¥å‘Šé”™è¯¯ä¿¡æ¯ç„¶åé€€å‡ºã€‚å¦‚æœè¦é˜²æ­¢ä½¿ç”¨å‹ç¼©ï¼Œåº”è¯¥æ˜¯ï¼šdont compress = *ã€‚ dont compressç”¨æ¥æŒ‡å®šé‚£äº›ä¸è¿›è¡Œå‹ç¼©å¤„ç†å†ä¼ è¾“çš„æ–‡ä»¶ï¼Œé»˜è®¤å€¼æ˜¯ *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz Rsync å‘½ä»¤åœ¨å¯¹ rsync æœåŠ¡å™¨é…ç½®ç»“æŸä»¥åï¼Œä¸‹ä¸€æ­¥å°±éœ€è¦åœ¨å®¢æˆ·ç«¯å‘å‡º rsync å‘½ä»¤æ¥å®ç°å°†æœåŠ¡å™¨ç«¯çš„æ–‡ä»¶å¤‡ä»½åˆ°å®¢æˆ·ç«¯æ¥ã€‚rsync æ˜¯ä¸€ä¸ªåŠŸèƒ½éå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå…¶å‘½ä»¤ä¹Ÿæœ‰å¾ˆå¤šåŠŸèƒ½ç‰¹è‰²é€‰é¡¹ï¼Œä¸‹é¢å°±å¯¹å®ƒçš„é€‰é¡¹ä¸€ä¸€è¿›è¡Œåˆ†æè¯´æ˜ã€‚Rsync çš„å‘½ä»¤æ ¼å¼å¯ä»¥ä¸ºä»¥ä¸‹å…­ç§ï¼š rsync [OPTION]... SRC DEST rsync [OPTION]... SRC [USER@]HOST:DEST rsync [OPTION]... [USER@]HOST:SRC DEST rsync [OPTION]... [USER@]HOST::SRC DEST rsync [OPTION]... SRC [USER@]HOST::DEST rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST] å¯¹åº”äºä»¥ä¸Šå…­ç§å‘½ä»¤æ ¼å¼ï¼Œrsync æœ‰å…­ç§ä¸åŒçš„å·¥ä½œæ¨¡å¼ï¼š æ‹·è´æœ¬åœ°æ–‡ä»¶ã€‚å½“ SRC å’Œ DES è·¯å¾„ä¿¡æ¯éƒ½ä¸åŒ…å«æœ‰å•ä¸ªå†’å·â€:â€ åˆ†éš”ç¬¦æ—¶å°±å¯åŠ¨è¿™ç§å·¥ä½œæ¨¡å¼ã€‚å¦‚ï¼šrsync -a /data /backup ä½¿ç”¨ä¸€ä¸ªè¿œç¨‹ shell ç¨‹åº (å¦‚ rshã€ssh) æ¥å®ç°å°†æœ¬åœ°æœºå™¨çš„å†…å®¹æ‹·è´åˆ°è¿œç¨‹æœºå™¨ã€‚å½“ DST è·¯å¾„åœ°å€åŒ…å«å•ä¸ªå†’å·â€:â€åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -avz *.c foo:src ä½¿ç”¨ä¸€ä¸ªè¿œç¨‹ shell ç¨‹åº (å¦‚ rshã€ssh) æ¥å®ç°å°†è¿œç¨‹æœºå™¨çš„å†…å®¹æ‹·è´åˆ°æœ¬åœ°æœºå™¨ã€‚å½“ SRC åœ°å€è·¯å¾„åŒ…å«å•ä¸ªå†’å·â€:â€åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -avz foo:src/bar /data ä»è¿œç¨‹ rsync æœåŠ¡å™¨ä¸­æ‹·è´æ–‡ä»¶åˆ°æœ¬åœ°æœºã€‚å½“ SRC è·¯å¾„ä¿¡æ¯åŒ…å«â€::â€ åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -av root@172.16.78.192::www /databack ä»æœ¬åœ°æœºå™¨æ‹·è´æ–‡ä»¶åˆ°è¿œç¨‹ rsync æœåŠ¡å™¨ä¸­ã€‚å½“ DST è·¯å¾„ä¿¡æ¯åŒ…å«â€::â€ åˆ†éš”ç¬¦æ—¶å¯åŠ¨è¯¥æ¨¡å¼ã€‚å¦‚ï¼šrsync -av /databack root@172.16.78.192::www åˆ—è¿œç¨‹æœºçš„æ–‡ä»¶åˆ—è¡¨ã€‚è¿™ç±»ä¼¼äº rsync ä¼ è¾“ï¼Œä¸è¿‡åªè¦åœ¨å‘½ä»¤ä¸­çœç•¥æ‰æœ¬åœ°æœºä¿¡æ¯å³å¯ã€‚å¦‚ï¼šrsync -v rsync://172.16.78.192/www rsync å‚æ•°çš„å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061-v, --verbose è¯¦ç»†æ¨¡å¼è¾“å‡º-q, --quiet ç²¾ç®€è¾“å‡ºæ¨¡å¼-c, --checksum æ‰“å¼€æ ¡éªŒå¼€å…³ï¼Œå¼ºåˆ¶å¯¹æ–‡ä»¶ä¼ è¾“è¿›è¡Œæ ¡éªŒ-a, --archive å½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§ï¼Œç­‰äº-rlptgoD-r, --recursive å¯¹å­ç›®å½•ä»¥é€’å½’æ¨¡å¼å¤„ç†-R, --relative ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿¡æ¯-b, --backup åˆ›å»ºå¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯å¯¹äºç›®çš„å·²ç»å­˜åœ¨æœ‰åŒæ ·çš„æ–‡ä»¶åæ—¶ï¼Œå°†è€çš„æ–‡ä»¶é‡æ–°å‘½åä¸º~filenameã€‚å¯ä»¥ä½¿ç”¨--suffixé€‰é¡¹æ¥æŒ‡å®šä¸åŒçš„å¤‡ä»½æ–‡ä»¶å‰ç¼€ã€‚--backup-dir å°†å¤‡ä»½æ–‡ä»¶(å¦‚~filename)å­˜æ”¾åœ¨åœ¨ç›®å½•ä¸‹ã€‚-suffix=SUFFIX å®šä¹‰å¤‡ä»½æ–‡ä»¶å‰ç¼€-u, --update ä»…ä»…è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è·³è¿‡æ‰€æœ‰å·²ç»å­˜åœ¨äºDSTï¼Œå¹¶ä¸”æ–‡ä»¶æ—¶é—´æ™šäºè¦å¤‡ä»½çš„æ–‡ä»¶ã€‚(ä¸è¦†ç›–æ›´æ–°çš„æ–‡ä»¶)-l, --links ä¿ç•™è½¯é“¾ç»“-L, --copy-links æƒ³å¯¹å¾…å¸¸è§„æ–‡ä»¶ä¸€æ ·å¤„ç†è½¯é“¾ç»“--copy-unsafe-links ä»…ä»…æ‹·è´æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“--safe-links å¿½ç•¥æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾ç»“-H, --hard-links ä¿ç•™ç¡¬é“¾ç»“-p, --perms ä¿æŒæ–‡ä»¶æƒé™-o, --owner ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯-g, --group ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯-D, --devices ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯-t, --times ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯-S, --sparse å¯¹ç¨€ç–æ–‡ä»¶è¿›è¡Œç‰¹æ®Šå¤„ç†ä»¥èŠ‚çœDSTçš„ç©ºé—´-n, --dry-runç°å®å“ªäº›æ–‡ä»¶å°†è¢«ä¼ è¾“-W, --whole-file æ‹·è´æ–‡ä»¶ï¼Œä¸è¿›è¡Œå¢é‡æ£€æµ‹-x, --one-file-system ä¸è¦è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿè¾¹ç•Œ-B, --block-size=SIZE æ£€éªŒç®—æ³•ä½¿ç”¨çš„å—å°ºå¯¸ï¼Œé»˜è®¤æ˜¯700å­—èŠ‚-e, --rsh=COMMAND æŒ‡å®šä½¿ç”¨rshã€sshæ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥--rsync-path=PATH æŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„rsyncå‘½ä»¤æ‰€åœ¨è·¯å¾„ä¿¡æ¯-C, --cvs-exclude ä½¿ç”¨å’ŒCVSä¸€æ ·çš„æ–¹æ³•è‡ªåŠ¨å¿½ç•¥æ–‡ä»¶ï¼Œç”¨æ¥æ’é™¤é‚£äº›ä¸å¸Œæœ›ä¼ è¾“çš„æ–‡ä»¶--existing ä»…ä»…æ›´æ–°é‚£äº›å·²ç»å­˜åœ¨äºDSTçš„æ–‡ä»¶ï¼Œè€Œä¸å¤‡ä»½é‚£äº›æ–°åˆ›å»ºçš„æ–‡ä»¶--delete åˆ é™¤é‚£äº›DSTä¸­SRCæ²¡æœ‰çš„æ–‡ä»¶--delete-excluded åŒæ ·åˆ é™¤æ¥æ”¶ç«¯é‚£äº›è¢«è¯¥é€‰é¡¹æŒ‡å®šæ’é™¤çš„æ–‡ä»¶--delete-after ä¼ è¾“ç»“æŸä»¥åå†åˆ é™¤--ignore-errors åŠæ—¶å‡ºç°IOé”™è¯¯ä¹Ÿè¿›è¡Œåˆ é™¤--max-delete=NUM æœ€å¤šåˆ é™¤NUMä¸ªæ–‡ä»¶--partial ä¿ç•™é‚£äº›å› æ•…æ²¡æœ‰å®Œå…¨ä¼ è¾“çš„æ–‡ä»¶ï¼Œä»¥æ˜¯åŠ å¿«éšåçš„å†æ¬¡ä¼ è¾“--force å¼ºåˆ¶åˆ é™¤ç›®å½•ï¼Œå³ä½¿ä¸ä¸ºç©º--numeric-ids ä¸å°†æ•°å­—çš„ç”¨æˆ·å’Œç»„IDåŒ¹é…ä¸ºç”¨æˆ·åå’Œç»„å--timeout=TIME IPè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’-I, --ignore-times ä¸è·³è¿‡é‚£äº›æœ‰åŒæ ·çš„æ—¶é—´å’Œé•¿åº¦çš„æ–‡ä»¶--size-only å½“å†³å®šæ˜¯å¦è¦å¤‡ä»½æ–‡ä»¶æ—¶ï¼Œä»…ä»…å¯Ÿçœ‹æ–‡ä»¶å¤§å°è€Œä¸è€ƒè™‘æ–‡ä»¶æ—¶é—´--modify-window=NUM å†³å®šæ–‡ä»¶æ˜¯å¦æ—¶é—´ç›¸åŒæ—¶ä½¿ç”¨çš„æ—¶é—´æˆ³çª—å£ï¼Œé»˜è®¤ä¸º0-T --temp-dir=DIR åœ¨DIRä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶--compare-dest=DIR åŒæ ·æ¯”è¾ƒDIRä¸­çš„æ–‡ä»¶æ¥å†³å®šæ˜¯å¦éœ€è¦å¤‡ä»½-P ç­‰åŒäº --partial--progress æ˜¾ç¤ºå¤‡ä»½è¿‡ç¨‹-z, --compress å¯¹å¤‡ä»½çš„æ–‡ä»¶åœ¨ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©å¤„ç†--exclude=PATTERN æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼--include=PATTERN æŒ‡å®šä¸æ’é™¤è€Œéœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼--exclude-from=FILE æ’é™¤FILEä¸­æŒ‡å®šæ¨¡å¼çš„æ–‡ä»¶--include-from=FILE ä¸æ’é™¤FILEæŒ‡å®šæ¨¡å¼åŒ¹é…çš„æ–‡ä»¶--version æ‰“å°ç‰ˆæœ¬ä¿¡æ¯--address ç»‘å®šåˆ°ç‰¹å®šçš„åœ°å€--config=FILE æŒ‡å®šå…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œä¸ä½¿ç”¨é»˜è®¤çš„rsyncd.confæ–‡ä»¶--port=PORT æŒ‡å®šå…¶ä»–çš„rsyncæœåŠ¡ç«¯å£--blocking-io å¯¹è¿œç¨‹shellä½¿ç”¨é˜»å¡IO-stats ç»™å‡ºæŸäº›æ–‡ä»¶çš„ä¼ è¾“çŠ¶æ€--progress åœ¨ä¼ è¾“æ—¶ç°å®ä¼ è¾“è¿‡ç¨‹--log-format=formAT æŒ‡å®šæ—¥å¿—æ–‡ä»¶æ ¼å¼--password-file=FILE ä»FILEä¸­å¾—åˆ°å¯†ç --bwlimit=KBPS é™åˆ¶I/Oå¸¦å®½ï¼ŒKBytes per second-h, --help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ Rsync ä½¿ç”¨å®ä¾‹SSH æ–¹å¼åœ¨æœåŠ¡ç«¯å¯åŠ¨ ssh æœåŠ¡12$ service sshd startå¯åŠ¨ sshdï¼š [ç¡®å®š] ä½¿ç”¨ rsync è¿›è¡ŒåŒæ­¥ æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ rsync å‘½ä»¤æ¥å¤‡ä»½æœåŠ¡ç«¯ä¸Šçš„æ•°æ®äº†ï¼ŒSSH æ–¹å¼æ˜¯é€šè¿‡ç³»ç»Ÿç”¨æˆ·æ¥è¿›è¡Œå¤‡ä»½çš„ï¼Œå¦‚ä¸‹ï¼š123456789101112131415$ rsync -vzrtopg --progress -e ssh --delete work@172.16.78.192:/www/* /databack/experiment/rsyncwork@172.16.78.192's password:receiving file list ...5 files to considertest/a0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5)b67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5)c0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5)dd100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5)sent 96 bytes received 98190 bytes 11563.06 bytes/sectotal size is 100663363 speedup is 1024.19 ä¸Šé¢çš„ä¿¡æ¯æè¿°äº†æ•´ä¸ªçš„å¤‡ä»½è¿‡ç¨‹ï¼Œä»¥åŠæ€»å…±å¤‡ä»½æ•°æ®çš„å¤§å°ã€‚ åå°æœåŠ¡æ–¹å¼å¯åŠ¨ rsync æœåŠ¡ ç¼–è¾‘ / etc/xinetd.d/rsync æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„ disable=yes æ”¹ä¸º disable=noï¼Œå¹¶é‡å¯ xinetd æœåŠ¡ï¼Œå¦‚ä¸‹ï¼š12345678910111213# default: off# description: The rsync server is a good addition to an ftp server, as it \# allows crc checksumming etc.service rsync{disable = nosocket_type = streamwait = nouser = rootserver = /usr/bin/rsyncserver_args = --daemonlog_on_failure += USERID} 123$ /etc/init.d/xinetd restartåœæ­¢ xinetdï¼š [ç¡®å®š]å¯åŠ¨ xinetdï¼š [ç¡®å®š] æˆ–è€…è‡ªå·±æ‰‹åŠ¨å¯åŠ¨å¹¶æ·»åŠ è‡ªå¯åŠ¨ï¼š12/usr/bin/rsync --daemon --config=/etc/rsyncd.confecho "/usr/bin/rsync --daemon --config=/etc/rsyncd.conf" >> /etc/rc.local åˆ›å»ºé…ç½®æ–‡ä»¶ é»˜è®¤å®‰è£…å¥½ rsync ç¨‹åºåï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»º rsync çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ‰‹å·¥æ¥åˆ›å»ºï¼Œå…¶ä¸»é…ç½®æ–‡ä»¶ä¸º â€œ/etc/rsyncd.confâ€ï¼Œåˆ›å»ºè¯¥æ–‡ä»¶å¹¶æ’å…¥å¦‚ä¸‹å†…å®¹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# Minimal configuration file for rsync daemon# See rsync(1) and rsyncd.conf(5) man pages for help############################ ä»¥ä¸‹æ˜¯å…¬å…±å‚æ•°é…ç½® ############################# This line is required by the /etc/init.d/rsyncd scriptpid file = /var/run/rsyncd.pid# æœåŠ¡çš„ç«¯å£port = 873# æœåŠ¡çš„IPaddress = 10.44.201.202# è¿è¡Œçš„å®¿ä¸»è´¦æˆ·ï¼Œè¿™é‡Œä¸ºç®€å•å°±rootäº†uid = rootgid = root# æ‰“å¼€ï¼ˆyesï¼‰åæœ‰ä¸ªåŠŸèƒ½æ˜¯è®©ç¬¦å·é“¾æ¥å¯ä»¥åŒæ­¥è¿‡å»ï¼ˆä¸é€šè¿‡ç¬¦å·é“¾æ¥å¯¹åº”çš„å®é™…æ–‡ä»¶ï¼‰use chroot = no# å®¢æˆ·ç«¯åªè¯»read only = yes#limit access to private LANshosts allow=10.51.56.165/255.255.255.0# hosts deny=*# æœ€å¤§è¿æ¥æ•°max connections = 5# æ¬¢è¿ä¿¡æ¯å¯¹åº”çš„æ–‡ä»¶# motd file = /etc/rsyncd.motd# å®¢æˆ·ç«¯é“¾æ¥çš„è¶…æ—¶æ—¶é—´timeout = 300# ä»¥ä¸‹æ˜¯æ—¥å¿—ç›¸å…³é…ç½®ï¼Œå¯é€‰ä½¿ç”¨ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶å’Œç³»ç»Ÿæ—¥å¿—# This will give you a separate log file# log file = /var/log/rsync.log# This will log every file transferred - up to 85,000+ per user, per sync# transfer logging = yes# log format = %t %a %m %f %b# syslog facility = local3############################# åŒæ­¥æ¨¡å—é…ç½® ################################[thrift]# éœ€è¦åŒæ­¥çš„è·¯å¾„path = /data/JiemoLucenes# å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨listå‘½ä»¤åˆ—è¡¨æ˜¾ç¤ºlist=yes# å¿½ç•¥é”™è¯¯ignore errors# è®¤è¯ç”¨æˆ·auth users = root# è®¤è¯ä½¿ç”¨çš„è´¦æˆ·å¯†ç æ–‡ä»¶secrets file = /etc/rsyncd.secrets# å¤‡æ³¨ä¿¡æ¯comment = This is nexus data# å¦‚æœæœ‰å¿½ç•¥çš„å­ç›®å½•ï¼Œå¯ä»¥é€šè¿‡excludeå®šä¹‰# exclude = easylife/ samba/ åˆ›å»ºå¯†ç æ–‡ä»¶é‡‡ç”¨è¿™ç§æ–¹å¼ä¸èƒ½ä½¿ç”¨ç³»ç»Ÿç”¨æˆ·å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªå¯†ç æ–‡ä»¶ï¼Œå…¶æ ¼å¼ä¸º â€œusername:passwordâ€ï¼Œç”¨æˆ·åå¯ä»¥å’Œå¯†ç å¯ä»¥éšä¾¿å®šä¹‰ï¼Œæœ€å¥½ä¸è¦å’Œç³»ç»Ÿå¸æˆ·ä¸€è‡´ï¼ŒåŒæ—¶è¦æŠŠåˆ›å»ºçš„å¯†ç æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600ï¼Œè¿™åœ¨å‰é¢çš„æ¨¡å—å‚æ•°åšäº†è¯¦ç»†ä»‹ç»ã€‚12echo "work:abc123" > /etc/rsyncd.passwdchmod 600 /etc/rsyncd.passwd å¤‡ä»½å®Œæˆä»¥ä¸Šå·¥ä½œï¼Œç°åœ¨å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå¤‡ä»½äº†ï¼Œå¦‚ä¸‹ï¼š123456789101112131415$ rsync -avz --progress --delete work@172.16.78.192::www /databack/experiment/rsyncPassword:receiving file list ...6 files to consider./ files...a0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)b67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)c0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)dd100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6)sent 172 bytes received 98276 bytes 17899.64 bytes/sectotal size is 150995011 speedup is 1533.75 æ¢å¤å½“æœåŠ¡å™¨çš„æ•°æ®å‡ºç°é—®é¢˜æ—¶ï¼Œé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦é€šè¿‡å®¢æˆ·ç«¯çš„æ•°æ®å¯¹æœåŠ¡ç«¯è¿›è¡Œæ¢å¤ï¼Œä½†å‰ææ˜¯æœåŠ¡ç«¯å…è®¸å®¢æˆ·ç«¯æœ‰å†™å…¥æƒé™ï¼Œå¦åˆ™ä¹Ÿä¸èƒ½åœ¨å®¢æˆ·ç«¯ç›´æ¥å¯¹æœåŠ¡ç«¯è¿›è¡Œæ¢å¤ï¼Œä½¿ç”¨ rsync å¯¹æ•°æ®è¿›è¡Œæ¢å¤çš„æ–¹æ³•å¦‚ä¸‹ï¼š1234567891011$ rsync -avz --progress /databack/experiment/rsync/ work@172.16.78.192::wwwPassword:building file list ...6 files to consider./ab67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)csent 258 bytes received 76 bytes 95.43 bytes/sectotal size is 150995011 speedup is 452080.87 ç¤ºä¾‹è„šæœ¬è¿™é‡Œè¿™äº›è„šæœ¬éƒ½æ˜¯ rsync ç½‘ç«™ä¸Šçš„ä¾‹å­ï¼š1ã€æ¯éš”ä¸ƒå¤©å°†æ•°æ®å¾€ä¸­å¿ƒæœåŠ¡å™¨åšå¢é‡å¤‡ä»½1234567891011121314151617181920212223242526272829303132333435#!/bin/sh# This script does personal backups to a rsync backup server. You will end up# with a 7 day rotating incremental backup. The incrementals will go# into subdirectories named after the day of the week, and the current# full backup goes into a directory called "current"# tridge@linuxcare.com# directory to backupBDIR=/home/$USER# excludes file - this contains a wildcard pattern per line of files to excludeEXCLUDES=$HOME/cron/excludes# the name of the backup machineBSERVER=owl# your password on the backup serverexport RSYNC_PASSWORD=XXXXXX#######################################################################BACKUPDIR=`date +%A`OPTS="--force --ignore-errors --delete-excluded --exclude-from=$EXCLUDES--delete --backup --backup-dir=/$BACKUPDIR -a"export PATH=$PATH:/bin:/usr/bin:/usr/local/bin# the following line clears the last weeks incremental directory[ -d $HOME/emptydir ] || mkdir $HOME/emptydirrsync --delete -a $HOME/emptydir/ $BSERVER::$USER/$BACKUPDIR/rmdir $HOME/emptydir# now the actual transferrsync $OPTS $BDIR $BSERVER::$USER/current 2ã€å¤‡ä»½è‡³ä¸€ä¸ªç©ºé—²çš„ç¡¬ç›˜12345678910111213141516#!/bin/shexport PATH=/usr/local/bin:/usr/bin:/binLIST="rootfs usr data data2"for d in $LIST; domount /backup/$drsync -ax --exclude fstab --delete /$d/ /backup/$d/umount /backup/$ddoneDAY=`date "+%A"`rsync -a --delete /usr/local/apache /data2/backups/$DAYrsync -a --delete /data/solid /data2/backups/$DAY 3ã€å¯¹ vger.rutgers.edu çš„ cvs æ ‘è¿›è¡Œé•œåƒ1234567891011121314151617181920212223#!/bin/bashcd /var/www/cvs/vger/PATH=/usr/local/bin:/usr/freeware/bin:/usr/bin:/binRUN=`lps x | grep rsync | grep -v grep | wc -l`if [ "$RUN" -gt 0 ]; thenecho already runningexit 1firsync -az vger.rutgers.edu::cvs/CVSROOT/ChangeLog $HOME/ChangeLogsum1=`sum $HOME/ChangeLog`sum2=`sum /var/www/cvs/vger/CVSROOT/ChangeLog`if [ "$sum1" = "$sum2" ]; thenecho nothing to doexit 0firsync -az --delete --force vger.rutgers.edu::cvs/ /var/www/cvs/vger/exit 0 FAQQï¼šå¦‚ä½•é€šè¿‡ ssh è¿›è¡Œ rsyncï¼Œè€Œä¸”æ— é¡»è¾“å…¥å¯†ç ï¼Ÿ Aï¼šå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ * é€šè¿‡ ssh-keygen åœ¨ server A ä¸Šå»ºç«‹ SSH keysï¼Œä¸è¦æŒ‡å®šå¯†ç ï¼Œä½ ä¼šåœ¨~/.ssh ä¸‹çœ‹åˆ° identity å’Œ identity.pub æ–‡ä»¶ * åœ¨ server B ä¸Šçš„ home ç›®å½•å»ºç«‹å­ç›®å½•. ssh * å°† A çš„ identity.pub æ‹·è´åˆ° server B ä¸Š * å°† identity.pub åŠ åˆ°`~[user b]/.ssh/authorized_keys` * äºæ˜¯ server A ä¸Šçš„ A ç”¨æˆ·ï¼Œå¯é€šè¿‡ä¸‹é¢å‘½ä»¤ä»¥ç”¨æˆ· B ssh åˆ° server B ä¸Šäº† e.g.`ssh -l userB serverB` * è¿™æ ·å°±ä½¿ server A ä¸Šçš„ç”¨æˆ· A å°±å¯ä»¥ ssh ä»¥ç”¨æˆ· B çš„èº«ä»½æ— éœ€å¯†ç ç™»é™†åˆ° server B ä¸Šäº†ã€‚ Qï¼šå¦‚ä½•é€šè¿‡åœ¨ä¸å±å®³å®‰å…¨çš„æƒ…å†µä¸‹é€šè¿‡é˜²ç«å¢™ä½¿ç”¨ rsync? Aï¼šè§£ç­”å¦‚ä¸‹ï¼š è¿™é€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æœåŠ¡å™¨åœ¨é˜²ç«å¢™å†…ï¼Œä¸€ç§æ˜¯æœåŠ¡å™¨åœ¨é˜²ç«å¢™å¤–ã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œé€šå¸¸è¿˜æ˜¯ä½¿ç”¨ sshï¼Œè¿™æ—¶æœ€å¥½æ–°å»ºä¸€ä¸ªå¤‡ä»½ç”¨æˆ·ï¼Œå¹¶ä¸”é…ç½® sshd ä»…å…è®¸è¿™ä¸ªç”¨æˆ·é€šè¿‡ RSA è®¤è¯æ–¹å¼è¿›å…¥ã€‚å¦‚æœæœåŠ¡å™¨åœ¨é˜²ç«å¢™å†…ï¼Œåˆ™æœ€å¥½é™å®šå®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œæ‹’ç»å…¶å®ƒæ‰€æœ‰è¿æ¥ã€‚å¦‚æœå®¢æˆ·æœºåœ¨é˜²ç«å¢™å†…ï¼Œåˆ™å¯ä»¥ç®€ å•å…è®¸é˜²ç«å¢™æ‰“å¼€ TCP ç«¯å£ 22 çš„ ssh å¤–å‘è¿æ¥å°± ok äº†ã€‚ Qï¼šæˆ‘èƒ½å°†æ›´æ”¹è¿‡æˆ–è€…åˆ é™¤çš„æ–‡ä»¶ä¹Ÿå¤‡ä»½ä¸Šæ¥å—ï¼Ÿ Aï¼šå½“ç„¶å¯ä»¥ï¼š ä½ å¯ä»¥ä½¿ç”¨å¦‚ï¼šrsync -other -options -backupdir = ./backup-2000-2-13 ...è¿™æ ·çš„å‘½ä»¤æ¥å®ç°ã€‚è¿™æ ·å¦‚æœæºæ–‡ä»¶:/path/to/some/file.c æ”¹å˜äº†ï¼Œé‚£ä¹ˆæ—§çš„æ–‡ä»¶å°±ä¼šè¢«ç§»åˆ°./backup-2000-2-13/path/to/some/file.cï¼Œè¿™é‡Œè¿™ä¸ªç›®å½•éœ€è¦è‡ªå·±æ‰‹å·¥å»ºç«‹èµ·æ¥ Qï¼šæˆ‘éœ€è¦åœ¨é˜²ç«å¢™ä¸Šå¼€æ”¾å“ªäº›ç«¯å£ä»¥é€‚åº” rsyncï¼Ÿ Aï¼šè§†æƒ…å†µè€Œå®š rsync å¯ä»¥ç›´æ¥é€šè¿‡ 873 ç«¯å£çš„ tcp è¿æ¥ä¼ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ 22 ç«¯å£çš„ ssh æ¥è¿›è¡Œæ–‡ä»¶ä¼ é€’ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æ”¹å˜å®ƒçš„ç«¯å£ï¼šrsync --port 8730 otherhost::æˆ–è€…rsync -e 'ssh -p 2002' otherhost: Qï¼šæˆ‘å¦‚ä½•é€šè¿‡ rsync åªå¤åˆ¶ç›®å½•ç»“æ„ï¼Œå¿½ç•¥æ‰æ–‡ä»¶å‘¢ï¼Ÿ Aï¼šrsync -av --include '*/' --exclude '*' source-dir dest-dir Qï¼šä¸ºä»€ä¹ˆæˆ‘æ€»ä¼šå‡ºç° â€œRead-only file systemâ€ çš„é”™è¯¯å‘¢ï¼Ÿ Aï¼šçœ‹çœ‹æ˜¯å¦å¿˜äº†è®¾ â€œread only = noâ€ äº† Qï¼šä¸ºä»€ä¹ˆæˆ‘ä¼šå‡ºç°â€˜@ERROR: invalid gidâ€™çš„é”™è¯¯å‘¢ï¼Ÿ Aï¼šrsync ä½¿ç”¨æ—¶é»˜è®¤æ˜¯ç”¨ uid=nobody;gid=nobody æ¥è¿è¡Œçš„ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿä¸å­˜åœ¨ nobody ç»„çš„è¯ï¼Œå°±ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ï¼Œå¯ä»¥è¯•è¯• gid = nogroup æˆ–è€…å…¶å®ƒ Qï¼šç»‘å®šç«¯å£ 873 å¤±è´¥æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ Aï¼šå¦‚æœä½ ä¸æ˜¯ä»¥ root æƒé™è¿è¡Œè¿™ä¸€å®ˆæŠ¤è¿›ç¨‹çš„è¯ï¼Œå› ä¸º 1024 ç«¯å£ä»¥ä¸‹æ˜¯ç‰¹æƒç«¯å£ï¼Œä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ã€‚ä½ å¯ä»¥ç”¨â€“port å‚æ•°æ¥æ”¹å˜ã€‚ Qï¼šä¸ºä»€ä¹ˆæˆ‘è®¤è¯å¤±è´¥ï¼Ÿ Aï¼šä»ä½ çš„å‘½ä»¤è¡Œçœ‹æ¥ï¼š123$ rsync -a 144.16.251.213::test testPassword:@ERROR: auth failed on module test åº”è¯¥æ˜¯æ²¡æœ‰ä»¥ä½ çš„ç”¨æˆ·åç™»é™†å¯¼è‡´çš„é—®é¢˜ï¼Œè¯•è¯•rsync -a max@144.16.251.213::test test document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Modules åˆè¯• -- Go åŒ…ç®¡ç†è§£å†³ä¹‹é“]]></title>
    <url>%2F2019%2F03%2F29%2FgoModules%2F</url>
    <content type="text"><![CDATA[å‰è¨€Go çš„åŒ…ç®¡ç†æ˜¯ä¸€ç›´æ˜¯ä¸ºäººè¯Ÿç—…ä¹‹å¤„ï¼Œä» Go 1.5 å¼•å…¥çš„ vendor æœºåˆ¶ï¼Œåˆ°å‡†å®˜æ–¹å·¥å…· depï¼Œç›®å‰ä¸ºæ­¢è¿˜æ²¡ä¸€ä¸ªç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆ ä¸è¿‡ç°åœ¨ go modules éšç€ golang1.11 çš„å‘å¸ƒè€Œå’Œæˆ‘ä»¬è§é¢äº†ï¼Œè¿™æ˜¯å®˜æ–¹æå€¡çš„æ–°çš„åŒ…ç®¡ç†ï¼Œä¹ƒè‡³é¡¹ç›®ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥ä¸å†éœ€è¦ GOPATH çš„å­˜åœ¨ã€‚ æ¬£å–œä¹‹ä½™ï¼Œèµ¶ç´§ä¸Šæ‰‹æ¥è¯•ä¸€ä¸‹å§~ Go modules çš„å‰ä¸–ä»Šç”Ÿ è¯´èµ· Go çš„åŒ…ä¾èµ–ç®¡ç†ï¼Œä½œä¸º Google è„‘æ®‹ç²‰çš„æˆ‘ä¹Ÿæ˜¯è¿è¿å¹æ°”ã€‚ã€‚ã€‚ å¦‚æœè¯´ Java(Maven) æ˜¯å¨ shit çš„è¯ï¼Œé‚£ Go çœŸæ˜¯è¿ Java éƒ½ä¸å¦‚ã€‚ è‡ª 2007 å¹´ â€œä¸‰å·¨å¤´â€ï¼ˆRobert Griesemer, Rob Pike, Ken Thompsonï¼‰æå‡ºè®¾è®¡å’Œå®ç° Go è¯­è¨€ä»¥æ¥ï¼Œè¿™é—¨è¯­è¨€å·²ç»å‘å±•å’Œæ¼”åŒ–äº†åä½™å¹´äº†ã€‚ ä½†æ˜¯è‡ªä» Go è¯­è¨€è¯ç”Ÿä»¥æ¥å§ï¼Œå¤§ä½¬ä»¬å°±è®¤ä¸ºgo get å·²ç»æŒºå¥½äº†ï¼Œæ²¡å¿…è¦å†é¢å¤–é€ ä¸€ä¸ªè½®å­äº†â€”â€”åŒ…ç®¡ç†å™¨ã€‚ ä¹Ÿè®¸æ˜¯å¤§ä½¬ä»¬éƒ½ä¸éœ€è¦å›¢é˜Ÿå¼€å‘å§ï¼Œä½†æ˜¯å¤§ä½¬æ¯•ç«Ÿæ˜¯å°‘æ•°ï¼Œäºæ˜¯ï¼Œå„ç§å„æ ·çš„ç¤¾åŒºè§£å†³æ–¹æ¡ˆå°±å‡ºç°äº†ï¼Œå¯è°“æ˜¯ç™¾å®¶äº‰é¸£ã€‚ dep manul - Vendor packages using git submodules. Godep Govendor godm govend - Manage dependencies like go get but for /vendor. Glide - Manage packages like composer, npm, bundler, or other languages. å½“åˆçœ‹åˆ°è¿™ä¸ªåˆ—è¡¨çš„æ—¶å€™ï¼Œæˆ‘ä¸ç¦æ„Ÿæ…¨ï¼šâ€œè¿™ä¹ˆå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œå¯çœŸæ˜¯æŒ‘èŠ±äº†æœ•çš„çœ¼ç›å‘€ã€‚â€ Go å®˜æ–¹è¯´ï¼šâ€œè«æ€¥ï¼Œè¿™ä»½å®˜æ–¹å¯¹æ¯”æ‹¿å¥½ä¸è°¢ã€‚â€ Go åœ¨æ„å»ºè®¾è®¡æ–¹é¢æ·±å— Google å†…éƒ¨å¼€å‘å®è·µçš„å½±å“ï¼Œæ¯”å¦‚ go get çš„è®¾è®¡å°±æ·±å— Google å†…éƒ¨å•ä¸€ä»£ç ä»“åº“ (single monorepo) å’ŒåŸºäºä¸»å¹² (trunk/mainline based) çš„å¼€å‘æ¨¡å‹çš„å½±å“ï¼šåªè·å– Trunk/mainline ä»£ç å’Œç‰ˆæœ¬æ— æ„ŸçŸ¥ã€‚ Google å†…éƒ¨åŸºäºä¸»å¹²çš„å¼€å‘æ¨¡å‹ï¼š æ‰€æœ‰å¼€å‘äººå‘˜åŸºäºä¸»å¹² trunk/mainline å¼€å‘ï¼šæäº¤åˆ° trunk æˆ–ä» trunk è·å–æœ€æ–°çš„ä»£ç ï¼ˆåŒæ­¥åˆ°æœ¬åœ° workspaceï¼‰ ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œå»ºç«‹ Release branchï¼Œrelease branch å®è´¨ä¸Šå°±æ˜¯æŸä¸€ä¸ªæ—¶åˆ»ä¸»å¹²ä»£ç çš„å¿«ç…§ å¿…é¡»åŒæ­¥åˆ° release branch ä¸Šçš„ bug fix å’Œå¢å¼ºæ”¹è¿›ä»£ç ä¹Ÿé€šå¸¸æ˜¯å…ˆåœ¨ trunk ä¸Šæäº¤ (commit)ï¼Œç„¶åå† cherry-pick åˆ° release branch ä¸Š æˆ‘ä»¬çŸ¥é“ go get è·å–çš„ä»£ç ä¼šæ”¾åœ¨ $GOPATH/src ä¸‹é¢ï¼Œè€Œ go build ä¼šåœ¨ $GOROOT/src å’Œ \$GOPATH/src ä¸‹é¢æŒ‰ç…§ import path å»æœç´¢ packageï¼Œç”±äº go get è·å–çš„éƒ½æ˜¯å„ä¸ª package repo çš„ trunk/mainline çš„ä»£ç ï¼Œå› æ­¤ï¼ŒGo 1.5 ä¹‹å‰çš„ Go compiler éƒ½æ˜¯åŸºäºç›®æ ‡ Go ç¨‹åºä¾èµ–åŒ…çš„ trunk/mainline ä»£ç å»ç¼–è¯‘çš„ã€‚è¿™æ ·çš„æœºåˆ¶å¸¦æ¥çš„é—®é¢˜æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œè‡³å°‘åŒ…æ‹¬ï¼š å› ä¾èµ–åŒ…çš„ trunk çš„å˜åŒ–ï¼Œå¯¼è‡´ä¸åŒäººè·å–å’Œç¼–è¯‘ä½ çš„åŒ… / ç¨‹åºæ—¶å¾—åˆ°çš„ç»“æœå®è´¨æ˜¯ä¸åŒçš„ï¼Œå³ä¸èƒ½å®ç° reproduceable build å› ä¾èµ–åŒ…çš„ trunk çš„å˜åŒ–ï¼Œå¼•å…¥ä¸å…¼å®¹çš„å®ç°ï¼Œå¯¼è‡´ä½ çš„åŒ… / ç¨‹åºæ— æ³•é€šè¿‡ç¼–è¯‘ å› ä¾èµ–åŒ…æ¼”è¿›è€Œæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œå¯¼è‡´ä½ çš„åŒ… / ç¨‹åºæ— æ³•é€šè¿‡ç¼–è¯‘ ä¸ºäº†å®ç° reporduceable buildï¼ŒGo 1.5 å¼•å…¥äº† Vendor æœºåˆ¶ï¼ŒGo ç¼–è¯‘å™¨ä¼šä¼˜å…ˆåœ¨ vendor ä¸‹æœç´¢ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…ï¼Œè¿™æ ·å¦‚æœå¼€å‘è€…å°†ç‰¹å®šç‰ˆæœ¬çš„ä¾èµ–åŒ…å­˜æ”¾åœ¨ vendor ä¸‹é¢å¹¶æäº¤åˆ° code repoï¼Œé‚£ä¹ˆæ‰€æœ‰äººç†è®ºä¸Šéƒ½ä¼šå¾—åˆ°åŒæ ·çš„ç¼–è¯‘ç»“æœï¼Œä»è€Œå®ç° reporduceable buildã€‚ åœ¨ Go 1.5 å‘å¸ƒåçš„è‹¥å¹²å¹´ï¼Œgopher ä»¬æŠŠæ³¨æ„åŠ›éƒ½é›†ä¸­åœ¨å¦‚ä½•åˆ©ç”¨ vendor è§£å†³åŒ…ä¾èµ–é—®é¢˜ï¼Œä»æ‰‹å·¥æ·»åŠ ä¾èµ–åˆ° vendorã€æ‰‹å·¥æ›´æ–°ä¾èµ–ï¼Œåˆ°ä¸€ä¼—åŒ…ä¾èµ–ç®¡ç†å·¥å…·çš„è¯ç”Ÿï¼Œæ¯”å¦‚ï¼šGovendorã€glide ä»¥åŠå·ç§°å‡†å®˜æ–¹å·¥å…·çš„ depï¼ŒåŠªåŠ›åœ°å°è¯•ç€æŒ‰ç…§å½“ä»Šä¸»æµæ€è·¯è§£å†³ç€è¯¸å¦‚ â€œé’»çŸ³å‹ä¾èµ–â€ ç­‰éš¾é¢˜ã€‚ æ­£å½“ gopher è®¤ä¸º dep å°† â€œé¡ºç†æˆç« â€ åœ°å‡çº§ä¸º go toolchain ä¸€éƒ¨åˆ†çš„æ—¶å€™ï¼Œä»Šå¹´å¹´åˆï¼ŒGo æ ¸å¿ƒ Team çš„æŠ€æœ¯ leaderï¼Œä¹Ÿæ˜¯ Go Team æœ€æ—©æœŸæˆå‘˜ä¹‹ä¸€çš„ Russ Cox åœ¨ä¸ªäººåšå®¢ä¸Šè¿ç»­å‘è¡¨äº†ä¸ƒç¯‡æ–‡ç« ï¼Œç³»ç»Ÿé˜è¿°äº† Go team è§£å†³â€ åŒ…ä¾èµ–ç®¡ç†â€ çš„æŠ€æœ¯æ–¹æ¡ˆ: vgo â€”â€” modules çš„å‰èº«ã€‚ vgo çš„ä¸»è¦æ€è·¯åŒ…æ‹¬ï¼šSemantic Import Versioningã€Minimal Version Selectionã€å¼•å…¥ Go module ç­‰ã€‚è¿™ä¸ƒç¯‡æ–‡ç« çš„å‘å¸ƒå¼•å‘äº† Go ç¤¾åŒºæ¿€çƒˆåœ°äº‰è®ºï¼Œå°¤å…¶æ˜¯ MVS(æœ€å°ç‰ˆæœ¬é€‰æ‹©) ä¸ç›®å‰ä¸»æµçš„ä¾èµ–ç‰ˆæœ¬é€‰æ‹©æ–¹æ³•çš„ç›¸æ‚–è®©å¾ˆå¤šä¼ ç»Ÿ Go åŒ…ç®¡ç†å·¥å…·çš„ç»´æŠ¤è€…â€ ä¸æ»¡â€ï¼Œå°¤å…¶æ˜¯â€ å‡†å®˜æ–¹å·¥å…·â€ï¼šdepã€‚vgo æ–¹æ¡ˆçš„æå‡ºä¹Ÿæ„å‘³ç€ dep é¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸå³å°†è¿›å…¥å°¾å£°ã€‚ 5 æœˆä»½ï¼ŒRuss Cox çš„ Proposal â€œcmd/go: add package version support to Go toolchainâ€ è¢« acceptedï¼Œè¿™å‘¨äº”æ—©äº›æ—¶å€™ Russ Cox å°† vgo çš„ä»£ç  merge åˆ° Go ä¸»å¹²ï¼Œå¹¶å°†è¿™å¥—æœºåˆ¶æ­£å¼å‘½åä¸ºâ€go modulesâ€ã€‚ç”±äº vgo é¡¹ç›®æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®éªŒåŸå‹ï¼Œmerge åˆ°ä¸»å¹²åï¼Œvgo è¿™ä¸ªæœ¯è¯­ä»¥åŠ vgo é¡¹ç›®çš„ä½¿å‘½ä¹Ÿå°±å°±æ­¤ç»“æŸäº†ã€‚åç»­ Go modules æœºåˆ¶å°†ç›´æ¥åœ¨ Go ä¸»å¹²ä¸Šç»§ç»­æ¼”åŒ–ã€‚ Go modules æ˜¯ Go team åœ¨è§£å†³åŒ…ä¾èµ–ç®¡ç†æ–¹é¢çš„ä¸€æ¬¡å‹‡æ•¢å°è¯•ï¼Œæ— è®ºå¦‚ä½•ï¼Œå¯¹ Go è¯­è¨€æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªå¥½äº‹ã€‚ Go modules ä¸Šæ‰‹è¿™é‡Œå°±ç”¨ Gin æ¡†æ¶æ¥å®ç°ä¸¤ä¸ª RESTful API ä½œç¤ºä¾‹å§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œä¸¤ä¸ª handler åˆ†åˆ«å±äº main å’Œ pkg/api/data è¿™ä¸¤ä¸ª package123456mytestâ”œâ”€â”€ main.goâ””â”€â”€ pkg â””â”€â”€ api â””â”€â”€ data â””â”€â”€ api.go è¿›å…¥ myproj ç›®å½•ï¼Œç„¶åä½¿ç”¨ go mod å»ºç«‹ modules12$ go mod init github.com/wangjiemin/mytestgo: creating new go.mod: module github.com/wangjiemin/mytest æ­¤æ—¶ä¼šè‡ªåŠ¨äº§ç”Ÿä¸€ä¸ª go.mod æ–‡ä»¶ï¼Œæ‰“å¼€çœ‹åˆ°é‡Œè¾¹å†…å®¹åªæœ‰ä¸€è¡Œ1module github.com/wangjiemin/mytest ç°åœ¨å¼€å§‹å†™æˆ‘ä»¬çš„ä¸¤ä¸ª handler1.pkg/api/data/api.go123456789101112131415package dataimport ( "net/http" "github.com/gin-gonic/gin")// GetDataAPIHealthHandler GET /health-dataapi to expose heathy check result of data APIfunc GetDataAPIHealthHandler(c *gin.Context) { // do something to check heathy of data API c.JSON(http.StatusOK, gin.H{ "code": 0, "message": "Data API is alive", })} 2.main.go1234567891011121314151617181920212223242526272829package mainimport ( dataapi "github.com/wangjiemin/mytest/pkg/api/data" "net/http" "github.com/gin-gonic/gin")func main() { router := gin.Default() router.GET("/health", GetHealthHandler) router.GET("/health-dataapi", dataapi.GetDataAPIHealthHandler) s := &http.Server{ Addr: ":8000", Handler: router, } s.ListenAndServe()}// GetHealthHandler - GET /health to expose service healthfunc GetHealthHandler(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ "code": 0, "message": "Service is alive!", })} ç„¶åç”¨æˆ‘ä»¬çš„è€æœ‹å‹ go build åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶1234567891011121314151617$ go build -o bin/main main.gogo: finding github.com/gin-gonic/gin v1.3.0go: downloading github.com/gin-gonic/gin v1.3.0go: finding github.com/gin-contrib/sse latestgo: finding github.com/ugorji/go/codec latestgo: finding github.com/golang/protobuf/proto latestgo: finding github.com/mattn/go-isatty v0.0.4go: finding gopkg.in/yaml.v2 v2.2.1go: finding gopkg.in/go-playground/validator.v8 v8.18.2go: downloading github.com/gin-contrib/sse v0.0.0-20170109093832-22d885f9ecc7go: downloading github.com/mattn/go-isatty v0.0.4go: downloading github.com/ugorji/go/codec v0.0.0-20181022190402-e5e69e061d4fgo: finding github.com/golang/protobuf v1.2.0go: downloading gopkg.in/yaml.v2 v2.2.1go: downloading gopkg.in/go-playground/validator.v8 v8.18.2go: downloading github.com/golang/protobuf v1.2.0go: finding gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405 å¯ä»¥çœ‹åˆ° go compiler ä¸»åŠ¨ä¸‹è½½äº†ç›¸å…³ packageã€‚ é‚£ä¹ˆè¿™äº› package è¢«ä¸‹è½½åˆ°äº†å“ªé‡Œå‘¢ï¼Œä½ æ‰“å¼€ $GOPATH/pkg/mod å°±å¯ä»¥çœ‹åˆ°äº†ï¼Œå¦å¤– modules æ˜¯å…è®¸åŒ package å¤šç§ç‰ˆæœ¬å¹¶å­˜çš„ã€‚12345678910~/go/pkg/modâ”œâ”€â”€ cacheâ”‚ â”œâ”€â”€ downloadâ”‚ â”‚ â”œâ”€â”€ github.comâ”‚ â”‚ â””â”€â”€ gopkg.inâ”‚ â””â”€â”€ vcsâ”‚ â”œâ”€â”€ 37981a5904034a62f98c21341f5422b08cc21ccf1bea734e2aafc91119af6c9bâ”‚ â”œâ”€â”€ 37981a5904034a62f98c21341f5422b08cc21ccf1bea734e2aafc91119af6c9b.infoâ”‚ â”œâ”€â”€ 3cef6ea433a84771f272e076cd77b94bd94828b89b4ccd04fa8622bf2d5d3a3fâ”‚ â”œâ”€â”€ 3cef6ea433a84771f272e076cd77b94bd94828b89b4ccd04fa8622bf2d5d3a3f.info æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œ go build å go.mod æ–‡ä»¶çš„å†…å®¹ï¼š1234567891011module github.com/wangjiemin/mytestrequire ( github.com/gin-contrib/sse v0.0.0-20170109093832-22d885f9ecc7 // indirect github.com/gin-gonic/gin v1.3.0 github.com/golang/protobuf v1.2.0 // indirect github.com/mattn/go-isatty v0.0.4 // indirect github.com/ugorji/go/codec v0.0.0-20181022190402-e5e69e061d4f // indirect gopkg.in/go-playground/validator.v8 v8.18.2 // indirect gopkg.in/yaml.v2 v2.2.1 // indirect) æˆ‘ä»¬çœ‹åˆ° go modules åˆ†æå‡ºäº† mytest çš„ä¾èµ–ï¼Œå¹¶å°†å…¶æ”¾å…¥ go.mod çš„ require åŒºåŸŸã€‚ go modules æ‹‰å– package çš„åŸåˆ™æ˜¯å…ˆæ‹‰å–æœ€æ–°çš„ release tagï¼Œè‹¥æ—  tag åˆ™æ‹‰æœ€æ–° commit å¹¶ä»¥ Pseudo-versions çš„å½¢å¼è®°å½•ã€‚å› ä¸ºæˆ‘ä»¬çš„ module åªç›´æ¥ä¾èµ–äº† ginï¼Œå…¶ä»–çš„éƒ½æ˜¯éç›´æ¥ä¾èµ–çš„ï¼Œæ‰€ä»¥å®ƒä»¬åè¾¹éƒ½è¢«ä»¥æ³¨é‡Šå½¢å¼æ ‡è®°äº† indirectï¼Œå³ä¼ é€’ä¾èµ–ã€‚go.mod æ–‡ä»¶ä¸€æ—¦åˆ›å»ºåï¼Œå®ƒçš„å†…å®¹å°†ä¼šè¢« go toolchain å…¨é¢æŒæ§ã€‚go toolchain ä¼šåœ¨å„ç±»å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ¯”å¦‚ go getã€go buildã€go mod ç­‰ä¿®æ”¹å’Œç»´æŠ¤ go.mod æ–‡ä»¶ã€‚ åŒæ—¶å‘ç°ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ªæ–‡ä»¶ go.sum123456789101112131415github.com/gin-contrib/sse v0.0.0-20170109093832-22d885f9ecc7 h1:AzN37oI0cOS+cougNAV9szl6CVoj2RYwzS3DpUQNtlY=github.com/gin-contrib/sse v0.0.0-20170109093832-22d885f9ecc7/go.mod h1:VJ0WA2NBN22VlZ2dKZQPAPnyWw5XTlK1KymzLKsr59s=github.com/gin-gonic/gin v1.3.0 h1:kCmZyPklC0gVdL728E6Aj20uYBJV93nj/TkwBTKhFbs=github.com/gin-gonic/gin v1.3.0/go.mod h1:7cKuhb5qV2ggCFctp2fJQ+ErvciLZrIeoOSOm6mUr7Y=github.com/golang/protobuf v1.2.0 h1:P3YflyNX/ehuJFLhxviNdFxQPkGK5cDcApsge1SqnvM=github.com/golang/protobuf v1.2.0/go.mod h1:6lQm79b+lXiMfvg/cZm0SGofjICqVBUtrP5yJMmIC1U=github.com/mattn/go-isatty v0.0.4 h1:bnP0vzxcAdeI1zdubAl5PjU6zsERjGZb7raWodagDYs=github.com/mattn/go-isatty v0.0.4/go.mod h1:M+lRXTBqGeGNdLjl/ufCoiOlB5xdOkqRJdNxMWT7Zi4=github.com/ugorji/go/codec v0.0.0-20181022190402-e5e69e061d4f h1:y3Vj7GoDdcBkxFa2RUUFKM25TrBbWVDnjRDI0u975zQ=github.com/ugorji/go/codec v0.0.0-20181022190402-e5e69e061d4f/go.mod h1:VFNgLljTbGfSG7qAOspJ7OScBnGdDN/yBr0sguwnwf0=gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=gopkg.in/go-playground/validator.v8 v8.18.2 h1:lFB4DoMU6B626w8ny76MV7VX6W2VHct2GVOI3xgiMrQ=gopkg.in/go-playground/validator.v8 v8.18.2/go.mod h1:RX2a/7Ha8BgOhfk7j780h4/u/RRjR0eouCJSH80/M2Y=gopkg.in/yaml.v2 v2.2.1 h1:mUhvW9EsL+naU5Q3cakzfE91YhliOondGd6ZrsDBHQE=gopkg.in/yaml.v2 v2.2.1/go.mod h1:hI93XBmqTisBFMUTm0b8Fm+jr3Dg1NNxqwp+5A1VGuI= å†™è¿‡ node çš„äººåº”è¯¥ä¼šå‘ç°ï¼Œ go.mod/go.sum çš„å…³ç³»è·Ÿ package.json/package-lock.json ç±»ä¼¼ï¼Œå‰è€…å®šä¹‰ dependency rootï¼Œåè€…å°†å…³ç³»å±•å¼€ã€‚ æœ€åæ‰§è¡Œ bin/main å¯ä»¥çœ‹åˆ° Gin å¾ˆè´´å¿ƒçš„åˆ—å‡ºäº† handler æ‰€å±çš„ package1234567891011$ ./bin/main[GIN-debug] [WARNING] Now Gin requires Go 1.6 or later and Go 1.7 will be required soon.[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production. - using env: export GIN_MODE=release - using code: gin.SetMode(gin.ReleaseMode)[GIN-debug] GET /health --> main.GetHealthHandler (3 handlers)[GIN-debug] GET /health-dataapi --> github.com/wangjiemin/mytest/pkg/api/data.GetDataAPIHealthHandler (3 handlers) åˆ°è¿™é‡Œï¼Œä¸€ä¸ª go modules å°±å®Œæˆäº†ã€‚ GO111MODULEModules æ˜¯ä½œä¸º experiment feature åŠ å…¥åˆ°ä¸ä¹…å‰æ­£å¼å‘å¸ƒçš„ Go 1.11 ä¸­çš„ã€‚ æŒ‰ç…§ Go çš„æƒ¯ä¾‹ï¼Œåœ¨æ–°çš„ experiment feature é¦–æ¬¡åŠ å…¥æ—¶ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹æ€§å¼€å…³ï¼Œgo modules ä¹Ÿä¸ä¾‹å¤–ï¼ŒGO111MODULE è¿™ä¸ªä¸´æ—¶çš„ç¯å¢ƒå˜é‡å°±æ˜¯ go modules ç‰¹æ€§çš„ experiment å¼€å…³ã€‚ off: go modules experiment feature å…³é—­ï¼Œgo compiler ä¼šå§‹ç»ˆä½¿ç”¨ GOPATH modeï¼Œå³æ— è®ºè¦æ„å»ºçš„æºç ç›®å½•æ˜¯å¦åœ¨ GOPATH è·¯å¾„ä¸‹ï¼Œgo compiler éƒ½ä¼šåœ¨ä¼ ç»Ÿçš„ GOPATH å’Œ vendor ç›®å½• (ä»…æ”¯æŒåœ¨ GOPATH ç›®å½•ä¸‹çš„ package) ä¸‹æœç´¢ç›®æ ‡ç¨‹åºä¾èµ–çš„ go packageï¼› on: å§‹ç»ˆä½¿ç”¨ module-aware modeï¼Œåªæ ¹æ® go.mod ä¸‹è½½ dependency è€Œå®Œå…¨å¿½ç•¥ GOPATH ä»¥åŠ vendor ç›®å½• auto: Golang 1.11 é¢„è®¾å€¼ï¼Œä½¿ç”¨ GOPATH mode è¿˜æ˜¯ module-aware modeï¼Œå–å†³äºè¦æ„å»ºçš„æºç ç›®å½•æ‰€åœ¨ä½ç½®ä»¥åŠæ˜¯å¦åŒ…å« go.mod æ–‡ä»¶ã€‚æ»¡è¶³ä»»ä¸€æ¡ä»¶æ—¶æ‰ä½¿ç”¨ module-aware mode: å½“å‰ç›®å½•ä½äº GOPATH/src ä¹‹å¤–å¹¶ä¸”åŒ…å« go.mod æ–‡ä»¶ å½“å‰ç›®å½•ä½äºåŒ…å« go.mod æ–‡ä»¶çš„ç›®å½•ä¸‹ go mod å‘½ä»¤12345678download download modules to local cache (ä¸‹è½½ä¾èµ–çš„ modules åˆ°æœ¬åœ° cache)edit edit go.mod from tools or scripts (ç¼–è¾‘ go.mod æ–‡ä»¶)graph print module requirement graph (æ‰“å°æ¨¡å—ä¾èµ–å›¾)init initialize new module in current directory (å†å½“å‰æ–‡ä»¶å¤¹ä¸‹åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ module, åˆ›å»º go.mod æ–‡ä»¶)tidy add missing and remove unused modules (å¢åŠ ä¸¢å¤±çš„ modulesï¼Œå»æ‰æœªç”¨çš„ modules)vendor make vendored copy of dependencies (å°†ä¾èµ–å¤åˆ¶åˆ° vendor ä¸‹)verify verify dependencies have expected content (æ ¡éªŒä¾èµ–)why explain why packages or modules are needed (è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–) çœ‹è¿™äº›å‘½ä»¤çš„å¸®åŠ©å·²ç»æ¯”è¾ƒå®¹æ˜“äº†è§£å‘½ä»¤çš„åŠŸèƒ½ã€‚ æ—¢æœ‰é¡¹ç›®å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª go é¡¹ç›®ï¼Œ æ¯”å¦‚åœ¨$GOPATH/github.com/wangjiemim/mytestä¸‹ï¼Œ ä½ å¯ä»¥ä½¿ç”¨go mod init github.com/wangjiemim/myteståœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„ go.mod (åªæœ‰ç¬¬ä¸€è¡Œ module github.com/wangjiemim/mytest)ã€‚ ç„¶åä½ å¯ä»¥é€šè¿‡ go get ./...è®©å®ƒæŸ¥æ‰¾ä¾èµ–ï¼Œå¹¶è®°å½•åœ¨ go.mod æ–‡ä»¶ä¸­ (ä½ è¿˜å¯ä»¥æŒ‡å®š -tags, è¿™æ ·å¯ä»¥æŠŠ tags çš„ä¾èµ–éƒ½æŸ¥æ‰¾åˆ°)ã€‚ é€šè¿‡go mod tidyä¹Ÿå¯ä»¥ç”¨æ¥ä¸º go.mod å¢åŠ ä¸¢å¤±çš„ä¾èµ–ï¼Œåˆ é™¤ä¸éœ€è¦çš„ä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä¸ç¡®å®šå®ƒæ€ä¹ˆå¤„ç†tagsã€‚ æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä¼šæŠŠ go.mod çš„latestç‰ˆæœ¬æ¢æˆå®é™…çš„æœ€æ–°çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆä¸€ä¸ªgo.sumè®°å½•æ¯ä¸ªä¾èµ–åº“çš„ç‰ˆæœ¬å’Œå“ˆå¸Œå€¼ã€‚ replaceåœ¨å›½å†…è®¿é—®golang.org/xçš„å„ä¸ªåŒ…éƒ½éœ€è¦æ¢¯å­ï¼Œä½ å¯ä»¥åœ¨ go.mod ä¸­ä½¿ç”¨replaceæ›¿æ¢æˆ github ä¸Šå¯¹åº”çš„åº“ã€‚12345replace ( golang.org/x/crypto v0.0.0-20180820150726-614d502a4dac => github.com/golang/crypto v0.0.0-20180820150726-614d502a4dac golang.org/x/net v0.0.0-20180821023952-922f4815f713 => github.com/golang/net v0.0.0-20180826012351-8a410e7b638d golang.org/x/text v0.3.0 => github.com/golang/text v0.3.0) ä¾èµ–åº“ä¸­çš„replaceå¯¹ä½ çš„ä¸» go.mod ä¸èµ·ä½œç”¨ï¼Œæ¯”å¦‚github.com/wangjiemin/mytestçš„ go.mod å·²ç»å¢åŠ äº†replace, ä½†æ˜¯ä½ çš„ go.mod è™½ç„¶requireäº†rpcxçš„åº“ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®replaceçš„è¯ï¼Œ go getè¿˜æ˜¯ä¼šè®¿é—®golang.org/xã€‚ æ‰€ä»¥å¦‚æœæƒ³ç¼–è¯‘é‚£ä¸ªé¡¹ç›®ï¼Œå°±åœ¨å“ªä¸ªé¡¹ç›®ä¸­å¢åŠ replaceã€‚ åŒ…çš„ç‰ˆæœ¬æ§åˆ¶ä¸‹é¢çš„ç‰ˆæœ¬éƒ½æ˜¯åˆæ³•çš„ï¼š12345gopkg.in/tomb.v1 v1.0.0-20141024135613-dd632973f1e7gopkg.in/vmihailenco/msgpack.v2 v2.9.1gopkg.in/yaml.v2 { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[masterha-master-switch å‚æ•°è¯¦è§£]]></title>
    <url>%2F2019%2F03%2F28%2Fmasterha-master-switch%2F</url>
    <content type="text"><![CDATA[MHA å‘½ä»¤ masterha_master_switchå¸¸ç”¨å‚æ•°ä»‹ç»1234567891011121314151617181920212223242526272829303132333435363738394041424344--master_state=dead å¼ºåˆ¶çš„å‚æ•°ï¼Œå‚æ•°å€¼ä¸º"dead" æˆ–è€… "alive" . å¦‚æœ è®¾ç½®ä¸º alive æ¨¡å¼ï¼Œmasterha_master_switch å¼€å§‹åœ¨çº¿ä¸»åº“åˆ‡æ¢æ“ä½œã€‚ --dead_master_host=(hostname) å¼ºåˆ¶å‚æ•°ï¼Œå®•æœºçš„ä¸»åº“æ‰€åœ¨çš„ä¸»æœºåç§°ã€‚--dead_master_ip å’Œ --dead_master_port æ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœè¿™äº›å‚æ•°æ²¡æœ‰è®¾ç½®ï¼Œ--dead_master_ip å°±æ˜¯ --dead_master_host è§£æçš„IPåœ°å€ã€‚--dead_master_port ä¸º 3306 --new_master_host=(hostname) æ–°ä¸»æœºåœ°å€ï¼Œå¯é€‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨ä½ æ˜ç¡®æ–°çš„ä¸»åº“çš„ä¸»æœºï¼Œéå¸¸æœ‰ç”¨ã€‚(è¿™å°±æ„å‘³ç€ä½ ä¸éœ€è¦è®©MHAæ¥å†³å®šæ–°çš„ä¸»åº“)ã€‚å¦‚æœä¸è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¼šåˆ©ç”¨è‡ªåŠ¨failoverçš„è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»åº“ã€‚å¦‚æœè®¾ç½®--new_master_hostï¼ŒMHAé€‰æ‹©æ­¤ä¸»æœºä¸ºæ–°çš„ä¸»åº“ï¼Œå¦‚æœä¸èƒ½æˆä¸ºä¸»åº“ï¼ŒMHAå°†ä¼šé€€å‡º --interactive=(0|1) å¦‚æœè®¾ç½®ä¸º0ï¼Œåœ¨masterha_master_switchï¼Œå®ƒè‡ªåŠ¨æ‰§è¡Œæ•…éšœè½¬ç§»(éäº¤äº’å¼)ã€‚è¿™å®é™…ä¸Šæ˜¯å’Œmasterha_managerçš„å†…éƒ¨è¿è¡Œæœºåˆ¶ä¸€æ ·ï¼Œè¿™ç§éäº¤äº’å¼æ•…éšœè½¬ç§»æ˜¯æœ‰ç”¨çš„ï¼Œå¦‚æœä½ å·²ç»è¯å®äº†masteræ­»äº†,ä½†ä½ æƒ³å°½å¿«åšæ•…éšœè½¬ç§»ã€‚éäº¤äº’å¼æ•…éšœè½¬ç§»ä¹Ÿæ˜¯æœ‰ç”¨çš„,å¦‚æœä½ ä½¿ç”¨å…¶ä»–ç°æœ‰çš„ä¸»ç›‘æ§è½¯ä»¶å’Œè¦è°ƒç”¨çš„éäº¤äº’å¼æ•…éšœè½¬ç§»å‘½ä»¤è½¯ä»¶ã€‚å…¸å‹çš„ä¾‹å­æ˜¯masterha_master_switchè°ƒç”¨ä»é›†ç¾¤è½¯ä»¶åƒèµ·æå™¨ã€‚ --ssh_reachable=(0|1|2) æŒ‡å®šmaster ç»è¿‡SSHæ˜¯å¦å¯è¾¾ã€‚0:ä¸å¯è¾¾ã€1:å¯è¾¾ã€2:æœªçŸ¥(é»˜è®¤å€¼)ã€‚ å¦‚æœè®¾ç½®ä¸ºäº†2ï¼Œæ­¤å‘½ä»¤å†…éƒ¨å°†ä¼šæ£€æµ‹é€šè¿‡SSH æ˜¯å¦å¯è¾¾masterï¼Œå¹¶ä¸”è·Ÿæ–°SSH çŠ¶æ€ã€‚å¦‚æœå¯è¾¾ï¼Œä¸”è®¾ç½®master_ip_failover_script æˆ–è€… shutdown_script .å°†ä¼šæ‰§è¡Œ"--command=stopssh"ã€‚å¦åˆ™ï¼Œæ‰§è¡Œ "--command=stop"ã€‚å¦å¤–ï¼Œå¦‚æœå®•æœºçš„masteré€šè¿‡SSHå¯è¾¾ï¼Œfailoverè„šæœ¬è¯•å›¾ä»å®•æœºçš„masteræœºå™¨ä¸Šæ‹·è´æ²¡æœ‰æ²¡æœ‰å‘é€çš„binlogã€‚ --skip_change_master å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå½“å‘ç”Ÿfailoverçš„æ—¶å€™ï¼ŒMAH åœ¨åº”ç”¨å®Œä¸åŒçš„relay logé€€å‡ºï¼Œå¿½ç•¥CHANGE MASTER å’Œ START SLAVE æ“ä½œã€‚æ‰€ä»¥ slaves ä¸ä¼šæŒ‡å‘ æ–°çš„master. å¼€å¯æ­¤å‚æ•°ï¼Œæœ‰åˆ©äºæ‰‹åŠ¨çš„äºŒæ¬¡æ£€æŸ¥slave æ¢å¤æ˜¯å¦æˆåŠŸ --skip_disable_read_only è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¸ä¼šåœ¨æ–°çš„ä¸»åº“ä¸Šæ‰§è¡Œ SET GLOBAL read_only =0 æ“ä½œï¼Œæœ‰åˆ©äºæ‰‹åŠ¨æ“ä½œ --last_failover_minute=(minutes) å‚è€ƒmaster_manager --ignore_last_failover å‚è€ƒmaster_manager --wait_on_failover_error=(seconds) ç±»ä¼¼äºmaster_manager, æ­¤å‚æ•°åªç”¨äºè‡ªåŠ¨çš„/éäº¤äº’å¼çš„failoverã€‚å¦‚æœæ²¡æœ‰è®¾ç½®--interval=0ï¼Œwait_on_failover_error å°†ä¼šè¢«å¿½ç•¥ï¼Œåœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ä¸ä¼šsleepã€‚ --remove_dead_master_conf å‚è€ƒmasterha_manager --wait_until_gtid_in_sync(0|1) æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœè®¾ç½®æˆ1ï¼Œå½“åŸºäºGITDçš„failoveræ—¶,MHA ä¼šç­‰å¾…æ‰€æœ‰çš„ä»åº“è¿½ä¸Šæ–°ä¸»åº“çš„GITD --skip_change_master æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼ŒMHA è·³è¿‡ CHANGE MASTER çš„æ“ä½œ --skip_disable_read_only æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼ŒMHA å°†ä¼šåœ¨æ–°çš„master è·³è¿‡ SET GLOBAL read_only = 0; --ignore_binlog_server_error æ­¤å‚æ•°ä»0.56ç‰ˆæœ¬å¼€å§‹å¯ç”¨ï¼Œå¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼Œå½“æ‰§è¡Œfailoverçš„æ—¶ï¼ŒMHAå¿½ç•¥binlog serverä¸Šä»»ä½•é”™è¯¯ ä¸»åœ¨çº¿åˆ‡æ¢æ—¶ç›¸å…³å‚æ•°1234567891011--new_master_host=(hostname) æ–°ä¸»æœºåœ°å€ï¼Œå¯é€‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨ä½ æ˜ç¡®æ–°çš„ä¸»åº“çš„ä¸»æœºï¼Œéå¸¸æœ‰ç”¨ã€‚(è¿™å°±æ„å‘³ç€ä½ ä¸éœ€è¦è®©MHAæ¥å†³å®šæ–°çš„ä¸»åº“)ã€‚å¦‚æœä¸è®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¼šåˆ©ç”¨è‡ªåŠ¨failoverçš„è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»åº“ã€‚å¦‚æœè®¾ç½®--new_master_hostï¼ŒMHAé€‰æ‹©æ­¤ä¸»æœºä¸ºæ–°çš„ä¸»åº“ï¼Œå¦‚æœä¸èƒ½æˆä¸ºä¸»åº“ï¼ŒMHAå°†ä¼šé€€å‡º --orig_master_is_new_slave å½“å®Œæˆä¸»åº“åˆ‡æ¢åï¼ŒåŸå…ˆçš„ä¸»åº“å°†ä½œä¸ºç°åœ¨ä¸»åº“çš„slaveè¿è¡Œã€‚é»˜è®¤:ä¸å¼€å¯(åŸå…ˆçš„ä¸»åº“ä¸ä¼šåŠ å…¥åˆ°æ–°çš„å¤åˆ¶ç¯å¢ƒä¸­)ã€‚å¦‚æœå¼€å¯æ­¤é€‰é¡¹ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®repl_passwordå‚æ•°ï¼Œç”±äºå½“æœŸçš„Masterå¹¶ä¸çŸ¥é“æ–°çš„Masterçš„replicationçš„å¯†ç  --remove_orig_master_conf å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå½“æˆåŠŸfailoveråï¼ŒMHA managerå°†ä¼šè‡ªåŠ¨åˆ é™¤é…ç½®æ–‡ä»¶ä¸­å…³äºdead masterçš„é…ç½®é€‰é¡¹ã€‚ --skip_lock_all_tables å½“åœ¨åšä¸»åº“åˆ‡æ¢çš„æ—¶å€™ï¼ŒMHAä¼šåœ¨åŸå…ˆçš„ä¸»åº“ä¸Šæ‰§è¡ŒFLUSH TABLES WITH READ LOCK æ“ä½œï¼Œç¡®ä¿æ²¡æœ‰è·Ÿæ–°æ“ä½œï¼Œä½†æ˜¯FLUSH TABLES WITH READ LOCK æ“ä½œæ˜¯éå¸¸è€—è´¹èµ„æºçš„ï¼Œå¹¶ä¸”ä½ å¯ä»¥åœ¨åŸå…ˆçš„ä¸»åº“ç¡®å®šæ²¡æœ‰è·Ÿæ–°æ“ä½œ(é€šè¿‡master_ip_online_change_script ä¸­kill all clientsæ“ä½œç­‰)ã€‚å¯ä»¥åˆ©ç”¨æ­¤é€‰é¡¹é¿å…é”è¡¨ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MHA</category>
      </categories>
      <tags>
        <tag>MHA</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MHA æ•…éšœåˆ‡æ¢æ¼”ç»ƒ --- masterha_master_switch]]></title>
    <url>%2F2019%2F03%2F28%2Fmha-switch%2F</url>
    <content type="text"><![CDATA[å‰è¨€æ˜¨å¤©å…¬å¸è¦è¿›è¡Œçº¿ä¸ŠMHAé«˜å¯ç”¨é›†ç¾¤æ•…éšœåˆ‡æ¢æ¼”ç»ƒã€‚ç”±äºæˆ‘åˆšå…¥èŒå…¬å¸ã€‚å…¬å¸è¿˜æ²¡æœ‰åšè¿‡å¤ªå¤šçš„ç¾éš¾çº§åˆ«çš„æ•…éšœæ¼”ç»ƒã€‚ æˆ‘å†™äº†ä¸€äº›æ­¥éª¤ï¼šæ•…éšœåˆ‡æ¢ æŸ¥çœ‹ä¸»ä»å»¶è¿ŸçŠ¶æ€ ç™»å½•MHAä¸­æ§æœºï¼ŒæŸ¥çœ‹æ¼”ç»ƒåˆ‡æ¢çš„æ•°æ®åº“MHA logæ–‡ä»¶ï¼Œä½¿ç”¨tail -f å‘½ä»¤æ¥è·å–åˆ‡æ¢çš„logæ—¥å¿—ä¿¡æ¯ ç™»å½•masteræœºå™¨ï¼Œæ‰§è¡Œ /etc/init.d/mysql stop æŸ¥çœ‹MHAä¸­æ§æœºæ—¥å¿—ä¿¡æ¯ã€‚ åˆ‡æ¢æˆåŠŸï¼Œç™»å½•åˆ° new_master ä¸­æŸ¥çœ‹vipæ˜¯å¦å·²ç»ç»‘å®šåˆ°ç½‘å¡ä¸Š ç™»å½•slaveï¼ŒæŸ¥çœ‹ show slave status æ˜¯å¦å·²ç»change master to new_master ipä¸Šï¼ŒæŸ¥çœ‹slaveæ­£å¸¸ä¸å¦ åœ¨ MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹MHAé›†ç¾¤å¯åŠ¨æ˜¯å¦æ­£å¸¸ã€‚(ä¸¤èŠ‚ç‚¹)ç»“æ„å›¾ï¼šnew_master: (master)â€”> slave: (slave) master æ•°æ®åº“æ¢å¤ ç™»å½•åˆ°old_master æœºå™¨ä¸Šæ‰§è¡Œ /etc/init.d/mysql start æ˜¯å¦æ­£å¸¸å¯åŠ¨æœåŠ¡ åœ¨MHAä¸­æ§æœºä¸­è·å–åˆ‡æ¢çš„log æ—¥å¿—ä¿¡æ¯æ‰¾å‡º change master to new_master ä¿¡æ¯è¯­å¥ åœ¨old_master ä¸­æ‰§è¡Œchange master to è¯­å¥ï¼Œå˜ä¸º new_masterçš„slave show slave status æŸ¥çœ‹ old_master æ˜¯å¦æ­£å¸¸å˜ä¸º new_master çš„slave åœ¨MHA ä¸­æ§æœºèŠ‚ç‚¹ï¼Œæ‰§è¡Œ masterha_stop å‘½ä»¤ç»“æŸ masterha_managerè¿›ç¨‹ã€‚ åœ¨MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹æ¢å¤å¥½çš„old_masteræ˜¯å¦æ­£å¸¸åŠ å…¥åˆ°MHAèŠ‚ç‚¹ (ä¸‰èŠ‚ç‚¹ï¼‰ç»“æ„å›¾ï¼šnew_master: (master)â€”> old_master: (slave)â€”> slave: (slave) æ¢å¤ old_masterä¸º master è§’è‰² æŸ¥çœ‹ä¸»ä»å»¶è¿ŸçŠ¶æ€ ç™»å½•MHAä¸­æ§æœºï¼ŒæŸ¥çœ‹æ¼”ç»ƒåˆ‡æ¢çš„æ•°æ®åº“MHA logæ–‡ä»¶ï¼Œä½¿ç”¨tail -f å‘½ä»¤æ¥è·å–åˆ‡æ¢çš„logæ—¥å¿—ä¿¡æ¯ ç™»å½•new_masteræœºå™¨ï¼Œæ‰§è¡Œ /etc/init.d/mysql stop æŸ¥çœ‹MHAä¸­æ§æœºæ—¥å¿—ä¿¡æ¯ã€‚ åˆ‡æ¢æˆåŠŸï¼Œç™»å½•åˆ° old_master ä¸­æŸ¥çœ‹vipæ˜¯å¦å·²ç»ç»‘å®šåˆ°ç½‘å¡ä¸Š ç™»å½•slaveï¼ŒæŸ¥çœ‹ show slave status æ˜¯å¦å·²ç»change master to old_master ipä¸Šï¼ŒæŸ¥çœ‹slaveæ­£å¸¸ä¸å¦ åœ¨ MHA ä¸­æ§æœºå¯åŠ¨ masterha_manager è¿›ç¨‹ï¼ŒæŸ¥çœ‹MHAé›†ç¾¤å¯åŠ¨æ˜¯å¦æ­£å¸¸ã€‚(ä¸¤èŠ‚ç‚¹)ç»“æ„å›¾ï¼šmaster(old_master): (master)â€”> slave(new_master): (slave)â€”> slave: (slave) ä½†æ˜¯è¿™ä¹ˆæ“ä½œè™½ç„¶èƒ½æ›´è´´è¿‘çœŸå®ç¾éš¾(æš‚æ—¶æ²¡æœ‰æŠŠä¸»ä»æ•°æ®å»¶è¿Ÿè€ƒè™‘è¿›å…¥)ï¼Œéœ€è¦çš„æ—¶é—´ä¼šæ›´å¤šã€‚é¢†å¯¼å»ºè®®æ‰‹åŠ¨æ“ä½œMHA failoveræµ‹è¯•èƒ½ä¸èƒ½åˆ‡æ¢ã€‚æœåŠ¡å™¨æ¶æ„ server role master old_master slave new_master slave slave å…·ä½“æ“ä½œåœ¨MHA ä¸­æ§æœºä¸­æ‰§è¡Œå‘½ä»¤1# masterha_check_repl --conf=/root/dba/mha/conf/babybi_#1.conf 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182Wed Mar 27 23:28:28 2019 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.Wed Mar 27 23:28:28 2019 - [info] Reading application default configuration from /root/dba/mha/conf/babybi_#1.conf..Wed Mar 27 23:28:28 2019 - [info] Reading server configuration from /root/dba/mha/conf/babybi_#1.conf..Wed Mar 27 23:28:28 2019 - [info] MHA::MasterMonitor version 0.56.Wed Mar 27 23:28:28 2019 - [info] GTID failover mode = 0Wed Mar 27 23:28:28 2019 - [info] Dead Servers:Wed Mar 27 23:28:28 2019 - [info] Alive Servers:Wed Mar 27 23:28:28 2019 - [info] 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:28:28 2019 - [info] 10.25.1.67(10.25.1.67:3306)Wed Mar 27 23:28:28 2019 - [info] 10.25.1.68(10.25.1.68:3306)Wed Mar 27 23:28:28 2019 - [info] Alive Slaves:Wed Mar 27 23:28:28 2019 - [info] 10.25.1.67(10.25.1.67:3306) Version=5.6.29-76.2-log (oldest major version between slaves) log-bin:enabledWed Mar 27 23:28:28 2019 - [info] Replicating from 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:28:28 2019 - [info] Primary candidate for the new Master (candidate_master is set)Wed Mar 27 23:28:28 2019 - [info] 10.25.1.68(10.25.1.68:3306) Version=5.6.29-76.2-log (oldest major version between slaves) log-bin:enabledWed Mar 27 23:28:28 2019 - [info] Replicating from 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:28:28 2019 - [info] Current Alive Master: 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:28:28 2019 - [info] Checking slave configurations..Wed Mar 27 23:28:28 2019 - [warning] relay_log_purge=0 is not set on slave 10.25.1.67(10.25.1.67:3306).Wed Mar 27 23:28:28 2019 - [warning] relay_log_purge=0 is not set on slave 10.25.1.68(10.25.1.68:3306).Wed Mar 27 23:28:28 2019 - [info] Checking replication filtering settings..Wed Mar 27 23:28:28 2019 - [info] binlog_do_db= , binlog_ignore_db= Wed Mar 27 23:28:28 2019 - [info] Replication filtering check ok.Wed Mar 27 23:28:28 2019 - [info] GTID (with auto-pos) is not supportedWed Mar 27 23:28:28 2019 - [info] Starting SSH connection tests..Wed Mar 27 23:28:29 2019 - [info] All SSH connection tests passed successfully.Wed Mar 27 23:28:29 2019 - [info] Checking MHA Node version..Wed Mar 27 23:28:30 2019 - [info] Version check ok.Wed Mar 27 23:28:30 2019 - [info] Checking SSH publickey authentication settings on the current master..Wed Mar 27 23:28:30 2019 - [info] HealthCheck: SSH to 10.25.1.66 is reachable.Wed Mar 27 23:28:30 2019 - [info] Master MHA Node version is 0.56.Wed Mar 27 23:28:30 2019 - [info] Checking recovery script configurations on 10.25.1.66(10.25.1.66:3306)..Wed Mar 27 23:28:30 2019 - [info] Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/log/mysql/binlog/ --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.004691 Wed Mar 27 23:28:30 2019 - [info] Connecting to root@10.25.1.66(10.25.1.66:22).. Creating /var/tmp if not exists.. ok. Checking output directory is accessible or not.. ok. Binlog found at /log/mysql/binlog/, up to mysql-bin.004691Wed Mar 27 23:28:31 2019 - [info] Binlog setting check done.Wed Mar 27 23:28:31 2019 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..Wed Mar 27 23:28:31 2019 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='mha' --slave_host=10.25.1.67 --slave_ip=10.25.1.67 --slave_port=3306 --workdir=/var/tmp --target_version=5.6.29-76.2-log --manager_version=0.56 --relay_log_info=/my/data/percona/relay-log.info --relay_dir=/my/data/percona/ --slave_pass=xxxWed Mar 27 23:28:31 2019 - [info] Connecting to root@10.25.1.67(10.25.1.67:22).. Checking slave recovery environment settings.. Opening /my/data/percona/relay-log.info ... ok. Relay log found at /log/mysql/relaylog, up to relay-log.014072 Temporary relay log file is /log/mysql/relaylog/relay-log.014072 Testing mysql connection and privileges..Warning: Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done.Wed Mar 27 23:28:31 2019 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user='mha' --slave_host=10.25.1.68 --slave_ip=10.25.1.68 --slave_port=3306 --workdir=/var/tmp --target_version=5.6.29-76.2-log --manager_version=0.56 --relay_log_info=/my/data/percona/relay-log.info --relay_dir=/my/data/percona/ --slave_pass=xxxWed Mar 27 23:28:31 2019 - [info] Connecting to root@10.25.1.68(10.25.1.68:22).. Checking slave recovery environment settings.. Opening /my/data/percona/relay-log.info ... ok. Relay log found at /log/mysql/relaylog, up to relay-log.014072 Temporary relay log file is /log/mysql/relaylog/relay-log.014072 Testing mysql connection and privileges..Warning: Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done.Wed Mar 27 23:28:31 2019 - [info] Slaves settings check done.Wed Mar 27 23:28:31 2019 - [info] 10.25.1.66(10.25.1.66:3306) (current master) +--10.25.1.67(10.25.1.67:3306) +--10.25.1.68(10.25.1.68:3306)Wed Mar 27 23:28:31 2019 - [info] Checking replication health on 10.25.1.67..Wed Mar 27 23:28:31 2019 - [info] ok.Wed Mar 27 23:28:31 2019 - [info] Checking replication health on 10.25.1.68..Wed Mar 27 23:28:31 2019 - [info] ok.Wed Mar 27 23:28:31 2019 - [info] Checking master_ip_failover_script status:Wed Mar 27 23:28:31 2019 - [info] /root/dba/mha/script/master_ip_failover.sh --command=status --ssh_user=root --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===Checking the Status of the script.. OK Wed Mar 27 23:28:31 2019 - [info] OK.Wed Mar 27 23:28:31 2019 - [warning] shutdown_script is not defined.Wed Mar 27 23:28:31 2019 - [info] Got exit code 0 (Not master dead).MySQL Replication Health is OK. æ‰§è¡Œ masterha_master_switch å‘½ä»¤1# masterha_master_switch --conf=/root/dba/mha/conf/babybi_#1.conf --master_state=alive --new_master_host=10.25.1.67 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798Wed Mar 27 23:34:27 2019 - [info] MHA::MasterRotate version 0.56.Wed Mar 27 23:34:27 2019 - [info] Starting online master switch..Wed Mar 27 23:34:27 2019 - [info] Wed Mar 27 23:34:27 2019 - [info] * Phase 1: Configuration Check Phase..Wed Mar 27 23:34:27 2019 - [info] Wed Mar 27 23:34:27 2019 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.Wed Mar 27 23:34:27 2019 - [info] Reading application default configuration from /root/dba/mha/conf/babybi_#1.conf..Wed Mar 27 23:34:27 2019 - [info] Reading server configuration from /root/dba/mha/conf/babybi_#1.conf..Wed Mar 27 23:34:27 2019 - [info] GTID failover mode = 0Wed Mar 27 23:34:27 2019 - [info] Current Alive Master: 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:34:27 2019 - [info] Alive Slaves:Wed Mar 27 23:34:27 2019 - [info] 10.25.1.67(10.25.1.67:3306) Version=5.6.29-76.2-log (oldest major version between slaves) log-bin:enabledWed Mar 27 23:34:27 2019 - [info] Replicating from 10.25.1.66(10.25.1.66:3306)Wed Mar 27 23:34:27 2019 - [info] Primary candidate for the new Master (candidate_master is set)Wed Mar 27 23:34:27 2019 - [info] 10.25.1.68(10.25.1.68:3306) Version=5.6.29-76.2-log (oldest major version between slaves) log-bin:enabledWed Mar 27 23:34:27 2019 - [info] Replicating from 10.25.1.66(10.25.1.66:3306)It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on 10.25.1.66(10.25.1.66:3306)? (YES/no): ---> è¾“å…¥: yesWed Mar 27 23:34:34 2019 - [info] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take long time..Wed Mar 27 23:34:34 2019 - [info] ok.Wed Mar 27 23:34:34 2019 - [info] Checking MHA is not monitoring or doing failover..Wed Mar 27 23:34:34 2019 - [info] Checking replication health on 10.25.1.67..Wed Mar 27 23:34:34 2019 - [info] ok.Wed Mar 27 23:34:34 2019 - [info] Checking replication health on 10.25.1.68..Wed Mar 27 23:34:34 2019 - [info] ok.Wed Mar 27 23:34:34 2019 - [info] 10.25.1.67 can be new master.Wed Mar 27 23:34:34 2019 - [info] From:10.25.1.66(10.25.1.66:3306) (current master) +--10.25.1.67(10.25.1.67:3306) +--10.25.1.68(10.25.1.68:3306)To:10.25.1.67(10.25.1.67:3306) (new master) +--10.25.1.68(10.25.1.68:3306) +--10.25.1.66(10.25.1.66:3306)Starting master switch from 10.25.1.66(10.25.1.66:3306) to 10.25.1.67(10.25.1.67:3306)? (yes/NO): ---> è¾“å…¥: yesWed Mar 27 23:34:37 2019 - [info] Checking whether 10.25.1.67(10.25.1.67:3306) is ok for the new master..Wed Mar 27 23:34:37 2019 - [info] ok.Wed Mar 27 23:34:37 2019 - [info] 10.25.1.66(10.25.1.66:3306): SHOW SLAVE STATUS returned empty result. To check replication filtering rules, temporarily executing CHANGE MASTER to a dummy host.Wed Mar 27 23:34:37 2019 - [info] 10.25.1.66(10.25.1.66:3306): Resetting slave pointing to the dummy host.Wed Mar 27 23:34:37 2019 - [info] ** Phase 1: Configuration Check Phase completed.Wed Mar 27 23:34:37 2019 - [info] Wed Mar 27 23:34:37 2019 - [info] * Phase 2: Rejecting updates Phase..Wed Mar 27 23:34:37 2019 - [info] Wed Mar 27 23:34:37 2019 - [info] Executing master ip online change script to disable write on the current master:Wed Mar 27 23:34:37 2019 - [info] /root/dba/mha/script/master_ip_online_change.sh --command=stop --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 --orig_master_user='mha' --orig_master_password='mhapassword' --new_master_host=10.25.1.67 --new_master_ip=10.25.1.67 --new_master_port=3306 --new_master_user='mha' --new_master_password='mhapassword' --orig_master_ssh_user=root --new_master_ssh_user=root --orig_master_is_new_slave2019-03-27 23:34:38 set_mysql_read_only successful!Stopping keepalived: [ OK ]2019-03-27 23:34:38 stop_keepalived successful!Wed Mar 27 23:34:38 2019 - [info] ok.Wed Mar 27 23:34:38 2019 - [info] Locking all tables on the orig master to reject updates from everybody (including root):Wed Mar 27 23:34:38 2019 - [info] Executing FLUSH TABLES WITH READ LOCK..Wed Mar 27 23:34:38 2019 - [info] ok.Wed Mar 27 23:34:38 2019 - [info] Orig master binlog:pos is mysql-bin.004691:854373586.Wed Mar 27 23:34:38 2019 - [info] Waiting to execute all relay logs on 10.25.1.67(10.25.1.67:3306)..Wed Mar 27 23:34:38 2019 - [info] master_pos_wait(mysql-bin.004691:854373586) completed on 10.25.1.67(10.25.1.67:3306). Executed 0 events.Wed Mar 27 23:34:38 2019 - [info] done.Wed Mar 27 23:34:38 2019 - [info] Getting new master's binlog name and position..Wed Mar 27 23:34:38 2019 - [info] mysql-bin.000001:120Wed Mar 27 23:34:38 2019 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='10.25.1.67', MASTER_PORT=3306, MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=120, MASTER_USER='repl', MASTER_PASSWORD='xxx';Wed Mar 27 23:34:38 2019 - [info] Executing master ip online change script to allow write on the new master:Wed Mar 27 23:34:38 2019 - [info] /root/dba/mha/script/master_ip_online_change.sh --command=start --orig_master_host=10.25.1.66 --orig_master_ip=10.25.1.66 --orig_master_port=3306 --orig_master_user='mha' --orig_master_password='mhapassword' --new_master_host=10.25.1.67 --new_master_ip=10.25.1.67 --new_master_port=3306 --new_master_user='mha' --new_master_password='mhapassword' --orig_master_ssh_user=root --new_master_ssh_user=root --orig_master_is_new_slaveStarting keepalived: [ OK ]2019-03-27 23:34:38 start_keepalived successful!Wed Mar 27 23:34:38 2019 - [info] ok.Wed Mar 27 23:34:38 2019 - [info] Setting read_only=0 on 10.25.1.67(10.25.1.67:3306)..Wed Mar 27 23:34:38 2019 - [info] ok.Wed Mar 27 23:34:38 2019 - [info] Wed Mar 27 23:34:38 2019 - [info] * Switching slaves in parallel..Wed Mar 27 23:34:38 2019 - [info] Wed Mar 27 23:34:38 2019 - [info] -- Slave switch on host 10.25.1.68(10.25.1.68:3306) started, pid: 20673Wed Mar 27 23:34:38 2019 - [info] Wed Mar 27 23:34:38 2019 - [info] Log messages from 10.25.1.68 ...Wed Mar 27 23:34:39 2019 - [info] Wed Mar 27 23:34:38 2019 - [info] Waiting to execute all relay logs on 10.25.1.68(10.25.1.68:3306)..Wed Mar 27 23:34:38 2019 - [info] master_pos_wait(mysql-bin.004691:854373586) completed on 10.25.1.68(10.25.1.68:3306). Executed 0 events.Wed Mar 27 23:34:38 2019 - [info] done.Wed Mar 27 23:34:38 2019 - [info] Resetting slave 10.25.1.68(10.25.1.68:3306) and starting replication from the new master 10.25.1.67(10.25.1.67:3306)..Wed Mar 27 23:34:38 2019 - [info] Executed CHANGE MASTER.Wed Mar 27 23:34:38 2019 - [info] Slave started.Wed Mar 27 23:34:39 2019 - [info] End of log messages from 10.25.1.68 ...Wed Mar 27 23:34:39 2019 - [info] Wed Mar 27 23:34:39 2019 - [info] -- Slave switch on host 10.25.1.68(10.25.1.68:3306) succeeded.Wed Mar 27 23:34:39 2019 - [info] Unlocking all tables on the orig master:Wed Mar 27 23:34:39 2019 - [info] Executing UNLOCK TABLES..Wed Mar 27 23:34:39 2019 - [info] ok.Wed Mar 27 23:34:39 2019 - [info] Starting orig master as a new slave..Wed Mar 27 23:34:39 2019 - [info] Resetting slave 10.25.1.66(10.25.1.66:3306) and starting replication from the new master 10.25.1.67(10.25.1.67:3306)..Wed Mar 27 23:34:39 2019 - [info] Executed CHANGE MASTER.Wed Mar 27 23:34:39 2019 - [info] Slave started.Wed Mar 27 23:34:39 2019 - [info] All new slave servers switched successfully.Wed Mar 27 23:34:39 2019 - [info] Wed Mar 27 23:34:39 2019 - [info] * Phase 5: New master cleanup phase..Wed Mar 27 23:34:39 2019 - [info] Wed Mar 27 23:34:39 2019 - [info] 10.25.1.67: Resetting slave info succeeded.Wed Mar 27 23:34:39 2019 - [info] Switching master to 10.25.1.67(10.25.1.67:3306) completed successfully. 1234# ps -ef|grep babybi_#1.confroot 3578 1 0 Jan08 ? 00:42:35 perl /usr/bin/masterha_manager --conf=/root/dba/mha/conf/babybi_#1.conf --ignore_last_failoverroot 21082 17518 0 23:35 pts/0 00:00:00 grep --colour=auto babybi_#1.conf# åˆ°new_masteræœºå™¨ä¸­æŸ¥çœ‹VIPæœ‰æ²¡æœ‰ç»‘å®šè¿‡æ¥åˆ°ç½‘å¡ä¸Š1# ip a 123456789101112131415161718191: lo: mtu 65536 qdisc noqueue state UNKNOWN link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: em1: mtu 1500 qdisc mq master bond0 state UP qlen 1000 link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff3: em2: mtu 1500 qdisc mq master bond0 state UP qlen 1000 link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff4: em3: mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 24:6e:96:13:61:34 brd ff:ff:ff:ff:ff:ff5: em4: mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 24:6e:96:13:61:35 brd ff:ff:ff:ff:ff:ff6: bond0: mtu 1500 qdisc noqueue state UP link/ether 24:6e:96:13:61:30 brd ff:ff:ff:ff:ff:ff inet 10.25.1.67/24 brd 10.25.1.255 scope global bond0 inet 10.25.1.203/32 scope global bond0 inet6 fe80::266e:96ff:fe13:6130/64 scope link valid_lft forever preferred_lft forever ç™»å½•åˆ°slaveæœºå™¨ä¸Š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364mysql> show slave status\GERROR 2006 (HY000): MySQL server has gone awayNo connection. Trying to reconnect...Connection id: 2049252955Current database: *** NONE ****************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.25.1.67 Master_User: repl Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.000001 Read_Master_Log_Pos: 62528 Relay_Log_File: relay-log.000002 Relay_Log_Pos: 62691 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 62528 Relay_Log_Space: 62858 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 1673306 Master_UUID: ca479c32-fa0d-11e8-bc0f-246e96136130 Master_Info_File: /my/data/percona/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 01 row in set (0.00 sec)mysql> æ­£å¸¸ CHANGE MASTER TO NEW_MASTER ç™»å½•åˆ°old_masterä¸­æŸ¥çœ‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859mysql> show slave status\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.25.1.67 Master_User: repl Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.000001 Read_Master_Log_Pos: 66875 Relay_Log_File: relay-log.000002 Relay_Log_Pos: 67038 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 66875 Relay_Log_Space: 67205 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 1673306 Master_UUID: ca479c32-fa0d-11e8-bc0f-246e96136130 Master_Info_File: /my/data/percona/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 01 row in set (0.00 sec)mysql> åˆ°new_masterä¸ŠæŸ¥çœ‹12345$ ps -ef|grep keepalivedroot 37477 1 0 23:41 ? 00:00:00 /usr/sbin/keepalived -Droot 37478 37477 0 23:41 ? 00:00:00 /usr/sbin/keepalived -Droot 37479 37477 0 23:41 ? 00:00:00 /usr/sbin/keepalived -Ddbctl 38747 35598 0 23:49 pts/0 00:00:00 grep --colour=auto keepalived åœ¨åˆ‡æ¢å›æ¥åˆ°old_masterææˆä¸ºmasteræ­¥éª¤æŒ‰ç…§ä¸Šé¢æ“ä½œï¼Œå°±ä¸é‡å¤æ¬ç –äº†ã€‚ ç»“æœMHA é«˜å¯ç”¨é›†ç¾¤åˆ‡æ¢æˆåŠŸï¼Œè™½ç„¶æ˜¯æ‰‹åŠ¨MHA failoveræµ‹è¯•ï¼Œå¹¶ä¸èƒ½ä»£è¡¨MHAçš„é«˜å¯ç”¨ã€‚ä»¥åè¿˜ä¼šæŒ‰ç…§ä¸Šé¢ç¼©å†™çš„æ­¥éª¤åœ¨åŠ ä¸Šä¸€å®šçš„ä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿæ¥è¿›è¡Œæ¼”ç»ƒã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MHA</category>
      </categories>
      <tags>
        <tag>MHA</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CentOS Install git Source]]></title>
    <url>%2F2019%2F03%2F25%2Fgit-install%2F</url>
    <content type="text"><![CDATA[å‰è¨€Git åŒç”Ÿæ´»ä¸­çš„è®¸å¤šä¼Ÿå¤§äº‹ä»¶ä¸€æ ·ï¼ŒGit è¯ç”Ÿäºä¸€ä¸ªæå¯Œçº·äº‰å¤§ä¸¾åˆ›æ–°çš„å¹´ä»£ã€‚Linux å†…æ ¸å¼€æºé¡¹ç›®æœ‰ç€ä¸ºæ•°ä¼—å¹¿çš„å‚ä¸è€…ã€‚ç»å¤§å¤šæ•°çš„ Linux å†…æ ¸ç»´æŠ¤å·¥ä½œéƒ½èŠ±åœ¨äº†æäº¤è¡¥ä¸å’Œä¿å­˜å½’æ¡£çš„ç¹çäº‹åŠ¡ä¸Šï¼ˆ1991ï¼2002å¹´é—´ï¼‰ã€‚åˆ° 2002 å¹´ï¼Œæ•´ä¸ªé¡¹ç›®ç»„å¼€å§‹å¯ç”¨åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ BitKeeper æ¥ç®¡ç†å’Œç»´æŠ¤ä»£ç ã€‚å®˜æ–¹æ–‡æ¡£ åˆ°äº† 2005 å¹´ï¼Œå¼€å‘ BitKeeper çš„å•†ä¸šå…¬å¸åŒ Linux å†…æ ¸å¼€æºç¤¾åŒºçš„åˆä½œå…³ç³»ç»“æŸï¼Œä»–ä»¬æ”¶å›äº†å…è´¹ä½¿ç”¨ BitKeeper çš„æƒåŠ›ã€‚è¿™å°±è¿«ä½¿ Linux å¼€æºç¤¾åŒºï¼ˆç‰¹åˆ«æ˜¯ Linux çš„ç¼”é€ è€… Linus Torvalds ï¼‰ä¸å¾—ä¸å¸å–æ•™è®­ï¼Œåªæœ‰å¼€å‘ä¸€å¥—å±äºè‡ªå·±çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ‰ä¸è‡³äºé‡è¹ˆè¦†è¾™ã€‚ä»–ä»¬å¯¹æ–°çš„ç³»ç»Ÿåˆ¶è®¢äº†è‹¥å¹²ç›®æ ‡ï¼š é€Ÿåº¦ ç®€å•çš„è®¾è®¡ å¯¹éçº¿æ€§å¼€å‘æ¨¡å¼çš„å¼ºåŠ›æ”¯æŒï¼ˆå…è®¸ä¸Šåƒä¸ªå¹¶è¡Œå¼€å‘çš„åˆ†æ”¯ï¼‰ å®Œå…¨åˆ†å¸ƒå¼ æœ‰èƒ½åŠ›é«˜æ•ˆç®¡ç†ç±»ä¼¼ Linux å†…æ ¸ä¸€æ ·çš„è¶…å¤§è§„æ¨¡é¡¹ç›®ï¼ˆé€Ÿåº¦å’Œæ•°æ®é‡ï¼‰ å®‰è£…git æºç å®‰è£…ã€‚ä¸‹è½½æºç 1# wget https://github.com/git/git/archive/v2.21.0.zip è§£å‹ç¼©12345# tar zxvf v2.21.0.zip# cd git-2.20.1ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹# # make prefix=/usr/local/git all å¦‚æœé‡åˆ°è¯¥é”™è¯¯ 123http.h:6:23: warning: curl/curl.h: No such file or directoryhttp.h:7:23: warning: curl/easy.h: No such file or directoryâ€¦â€¦ 12æ‰§è¡Œå‘½ä»¤# yum install -y curl curl-devel é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤ å‘ç°ç¼–è¯‘æŠ¥é”™ 1234567891011121314151617181920212223242526272829303132 CC http.o CC http-walker.o CC http-fetch.o LINK git-http-fetch CC http-push.ohttp-push.c:22:19: warning: expat.h: No such file or directoryhttp-push.c:830: warning: type defaults to â€˜intâ€™ in declaration of â€˜XML_Charâ€™http-push.c:830: error: expected â€˜;â€™, â€˜,â€™ or â€˜)â€™ before â€˜*â€™ tokenhttp-push.c: In function â€˜lock_remoteâ€™:http-push.c:900: error: â€˜XML_Parserâ€™ undeclared (first use in this function)http-push.c:900: error: (Each undeclared identifier is reported only oncehttp-push.c:900: error: for each function it appears in.)http-push.c:900: error: expected â€˜;â€™ before â€˜parserâ€™http-push.c:907: warning: implicit declaration of function â€˜XML_SetUserDataâ€™http-push.c:907: error: â€˜parserâ€™ undeclared (first use in this function)http-push.c:908: warning: implicit declaration of function â€˜XML_SetElementHandlerâ€™http-push.c:910: warning: implicit declaration of function â€˜XML_SetCharacterDataHandlerâ€™http-push.c:910: error: â€˜xml_cdataâ€™ undeclared (first use in this function)http-push.c:911: warning: implicit declaration of function â€˜XML_Parseâ€™http-push.c:916: warning: implicit declaration of function â€˜XML_ErrorStringâ€™http-push.c:917: warning: implicit declaration of function â€˜XML_GetErrorCodeâ€™http-push.c:920: warning: implicit declaration of function â€˜XML_ParserFreeâ€™http-push.c: In function â€˜remote_lsâ€™:http-push.c:1154: error: â€˜XML_Parserâ€™ undeclared (first use in this function)http-push.c:1154: error: expected â€˜;â€™ before â€˜parserâ€™http-push.c:1161: error: â€˜parserâ€™ undeclared (first use in this function)http-push.c:1164: error: â€˜xml_cdataâ€™ undeclared (first use in this function)http-push.c: In function â€˜locking_availableâ€™:http-push.c:1228: error: â€˜XML_Parserâ€™ undeclared (first use in this function)http-push.c:1228: error: expected â€˜;â€™ before â€˜parserâ€™http-push.c:1235: error: â€˜parserâ€™ undeclared (first use in this function)make: *** [http-push.o] Error 1 æ‰§è¡Œå‘½ä»¤è§£å†³è¿™ä¸ªé—®é¢˜1# yum install -y expat-devel å†æ¬¡é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤ å‘ç°å†æ¬¡æŠ¥é”™ 1234567GITGUI_VERSION = 0.21.GITGUI * new locations or Tcl/Tk interpreter GEN git-gui INDEX lib/ * tclsh failed; using unoptimized loading MSGFMT po/bg.msg make[1]: *** [po/bg.msg] Error 127make: *** [all] Error 2 æ‰§è¡Œå‘½ä»¤è§£å†³1# yum install -y tcl build-essential tk gettext å†æ¬¡é‡æ–°æ‰§è¡Œç¼–è¯‘å‘½ä»¤ gitæºç ç¼–è¯‘æˆåŠŸæ‰§è¡Œæ‰§è¡Œå‘½ä»¤1# make prefix=/usr/local/git install 123456789101112# cd /usr/local/git/# lsbin libexec share# cd bin/# lsgit git-cvsserver gitk git-receive-pack git-shell git-upload-archive git-upload-pack# ./git --versiongit version 2.20.1 å®‰è£…å®Œæˆã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux Netcat å‘½ä»¤ - ç½‘ç»œä¸­çš„ç‘å£«å†›åˆ€]]></title>
    <url>%2F2019%2F03%2F25%2Fnc%2F</url>
    <content type="text"><![CDATA[å‰è¨€netcatæ˜¯ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå®ƒèƒ½é€šè¿‡TCPå’ŒUDPåœ¨ç½‘ç»œä¸­è¯»å†™æ•°æ®ã€‚é€šè¿‡ä¸å…¶ä»–å·¥å…·ç»“åˆå’Œé‡å®šå‘ï¼Œä½ å¯ä»¥åœ¨è„šæœ¬ä¸­ä»¥å¤šç§æ–¹å¼ä½¿ç”¨å®ƒã€‚ä½¿ç”¨netcatå‘½ä»¤æ‰€èƒ½å®Œæˆçš„äº‹æƒ…ä»¤äººæƒŠè®¶ã€‚å®ƒçš„ä¸‹è½½åœ°å€ netcatæ‰€åšçš„å°±æ˜¯åœ¨ä¸¤å°ç”µè„‘ä¹‹é—´å»ºç«‹é“¾æ¥å¹¶è¿”å›ä¸¤ä¸ªæ•°æ®æµï¼Œåœ¨è¿™ä¹‹åæ‰€èƒ½åšçš„äº‹å°±çœ‹ä½ çš„æƒ³åƒåŠ›äº†ã€‚ä½ èƒ½å»ºç«‹ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¼ è¾“æ–‡ä»¶ï¼Œä¸æœ‹å‹èŠå¤©ï¼Œä¼ è¾“æµåª’ä½“æˆ–è€…ç”¨å®ƒä½œä¸ºå…¶å®ƒåè®®çš„ç‹¬ç«‹å®¢æˆ·ç«¯ã€‚1234567891011121314151617181920212223242526272829$ nc -husage: nc [-46DdhklnrStUuvzC] [-i interval] [-p source_port] [-s source_ip_address] [-T ToS] [-w timeout] [-X proxy_version] [-x proxy_address[:port]] [hostname] [port[s]] Command Summary: -4 Use IPv4 -6 Use IPv6 -D Enable the debug socket option -d Detach from stdin -h This help text -i secs Delay interval for lines sent, ports scanned -k Keep inbound sockets open for multiple connects -l Listen mode, for inbound connects -n Suppress name/port resolutions -p port Specify local port for remote connects -r Randomize remote ports -S Enable the TCP MD5 signature option -s addr Local source address -T ToS Set IP Type of Service -C Send CRLF as line-ending -t Answer TELNET negotiation -U Use UNIX domain socket -u UDP mode -v Verbose -w secs Timeout for connects and final net reads -X proto Proxy protocol: "4", "5" (SOCKS) or "connect" -x addr[:port] Specify proxy address and port -z Zero-I/O mode [used for scanning] Port numbers can be individual or ranges: lo-hi [inclusive] 1234$ ncusage: nc [-46DdhklnrStUuvzC] [-i interval] [-p source_port] [-s source_ip_address] [-T ToS] [-w timeout] [-X proxy_version] [-x proxy_address[:port]] [hostname] [port[s]] nc çš„åŸºæœ¬åŠŸèƒ½å¦‚ä¸‹ï¼š telnet / è·å–ç³»ç»Ÿ banner ä¿¡æ¯ ä¼ è¾“æ–‡æœ¬ä¿¡æ¯ ä¼ è¾“æ–‡ä»¶å’Œç›®å½• åŠ å¯†ä¼ è¾“æ–‡ä»¶ ç«¯å£æ‰«æ è¿œç¨‹æ§åˆ¶ / æ­£æ–¹å‘ shell æµåª’ä½“æœåŠ¡å™¨ è¿œç¨‹å…‹éš†ç¡¬ç›˜ ä½¿ç”¨ä¾‹å­ç«¯å£æ‰«æç«¯å£æ‰«æç»å¸¸è¢«ç³»ç»Ÿç®¡ç†å‘˜å’Œé»‘å®¢ç”¨æ¥å‘ç°åœ¨ä¸€äº›æœºå™¨ä¸Šå¼€æ”¾çš„ç«¯å£ï¼Œå¸®åŠ©ä»–ä»¬è¯†åˆ«ç³»ç»Ÿä¸­çš„æ¼æ´1$ nc -z -v -n 192.168.10.10 10-100 å¯ä»¥è¿è¡Œåœ¨TCPæˆ–è€…UDPæ¨¡å¼ï¼Œé»˜è®¤æ˜¯TCPï¼Œ-uå‚æ•°è°ƒæ•´ä¸ºudp. z å‚æ•°å‘Šè¯‰netcatä½¿ç”¨0 IO,è¿æ¥æˆåŠŸåç«‹å³å…³é—­è¿æ¥ï¼Œ ä¸è¿›è¡Œæ•°æ®äº¤æ¢ v å‚æ•°æŒ‡ä½¿ç”¨å†—ä½™é€‰é¡¹ï¼ˆè¯‘è€…æ³¨ï¼šå³è¯¦ç»†è¾“å‡ºï¼‰ n å‚æ•°å‘Šè¯‰netcat ä¸è¦ä½¿ç”¨DNSåå‘æŸ¥è¯¢IPåœ°å€çš„åŸŸå è¿™ä¸ªå‘½ä»¤ä¼šæ‰“å°21åˆ°25 æ‰€æœ‰å¼€æ”¾çš„ç«¯å£ã€‚Banneræ˜¯ä¸€ä¸ªæ–‡æœ¬ï¼ŒBanneræ˜¯ä¸€ä¸ªä½ è¿æ¥çš„æœåŠ¡å‘é€ç»™ä½ çš„æ–‡æœ¬ä¿¡æ¯ã€‚å½“ä½ è¯•å›¾é‰´åˆ«æ¼æ´æˆ–è€…æœåŠ¡çš„ç±»å‹å’Œç‰ˆæœ¬çš„æ—¶å€™ï¼ŒBannerä¿¡æ¯æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå‘é€bannerã€‚ ä¸€æ—¦ä½ å‘ç°å¼€æ”¾çš„ç«¯å£ï¼Œä½ å¯ä»¥å®¹æ˜“çš„ä½¿ç”¨netcat è¿æ¥æœåŠ¡æŠ“å–ä»–ä»¬çš„bannerã€‚ 1$ nc -v 192.168.10.10 22 netcat å‘½ä»¤ä¼šè¿æ¥å¼€æ”¾ç«¯å£21å¹¶ä¸”æ‰“å°è¿è¡Œåœ¨è¿™ä¸ªç«¯å£ä¸ŠæœåŠ¡çš„bannerä¿¡æ¯ã€‚ C S(Chat Server) èŠå¤©Server1$ nc -l 10010 netcat å‘½ä»¤åœ¨1567ç«¯å£å¯åŠ¨äº†ä¸€ä¸ªtcp æœåŠ¡å™¨ï¼Œæ‰€æœ‰çš„æ ‡å‡†è¾“å‡ºå’Œè¾“å…¥ä¼šè¾“å‡ºåˆ°è¯¥ç«¯å£ã€‚è¾“å‡ºå’Œè¾“å…¥éƒ½åœ¨æ­¤shellä¸­å±•ç¤ºã€‚ Client1$ nc 192.168.10.10 10010 ä¸ç®¡ä½ åœ¨æœºå™¨Bä¸Šé”®å…¥ä»€ä¹ˆéƒ½ä¼šå‡ºç°åœ¨æœºå™¨Aä¸Šã€‚ æ–‡ä»¶ä¼ è¾“å¤§éƒ¨åˆ†æ—¶é—´ä¸­ï¼Œæˆ‘ä»¬éƒ½åœ¨è¯•å›¾é€šè¿‡ç½‘ç»œæˆ–è€…å…¶ä»–å·¥å…·ä¼ è¾“æ–‡ä»¶ã€‚æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œæ¯”å¦‚FTP,SCP,SMBç­‰ç­‰ï¼Œä½†æ˜¯å½“ä½ åªæ˜¯éœ€è¦ä¸´æ—¶æˆ–è€…ä¸€æ¬¡ä¼ è¾“æ–‡ä»¶ï¼ŒçœŸçš„å€¼å¾—æµªè´¹æ—¶é—´æ¥å®‰è£…é…ç½®ä¸€ä¸ªè½¯ä»¶åˆ°ä½ çš„æœºå™¨ä¸Šå˜›ã€‚å‡è®¾ï¼Œä½ æƒ³è¦ä¼ ä¸€ä¸ªæ–‡ä»¶testfile.txt ä»A åˆ°Bã€‚Aæˆ–è€…Béƒ½å¯ä»¥ä½œä¸ºæœåŠ¡å™¨æˆ–è€…å®¢æˆ·ç«¯ï¼Œä»¥ä¸‹ï¼Œè®©Aä½œä¸ºæœåŠ¡å™¨ï¼ŒBä¸ºå®¢æˆ·ç«¯ã€‚ Server1$ nc -l 10010 > testfile.txt Client1$ nc -n 192.168.10.10 10010 < testfile.txt è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡å™¨åœ¨Aä¸Šå¹¶ä¸”é‡å®šå‘netcatçš„è¾“å…¥ä¸ºæ–‡ä»¶testfile.txtï¼Œé‚£ä¹ˆå½“ä»»ä½•æˆåŠŸè¿æ¥åˆ°è¯¥ç«¯å£ï¼Œnetcatä¼šå‘é€fileçš„æ–‡ä»¶å†…å®¹ã€‚åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬é‡å®šå‘è¾“å‡ºåˆ°testfile.txtï¼Œå½“Bè¿æ¥åˆ°Aï¼ŒAå‘é€æ–‡ä»¶å†…å®¹ï¼ŒBä¿å­˜æ–‡ä»¶å†…å®¹åˆ°testfile.txt. æ²¡æœ‰å¿…è¦åˆ›å»ºæ–‡ä»¶æºä½œä¸ºServerï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›¸åçš„æ–¹æ³•ä½¿ç”¨ã€‚åƒä¸‹é¢çš„æˆ‘ä»¬å‘é€æ–‡ä»¶ä»Båˆ°Aï¼Œä½†æ˜¯æœåŠ¡å™¨åˆ›å»ºåœ¨Aä¸Šï¼Œè¿™æ¬¡æˆ‘ä»¬ä»…éœ€è¦é‡å®šå‘netcatçš„è¾“å‡ºå¹¶ä¸”é‡å®šå‘Bçš„è¾“å…¥æ–‡ä»¶ã€‚ ç›®å½•ä¼ è¾“å‘é€ä¸€ä¸ªæ–‡ä»¶å¾ˆç®€å•ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦å‘é€å¤šä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æ•´ä¸ªç›®å½•ï¼Œä¸€æ ·å¾ˆç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨å‹ç¼©å·¥å…·tarï¼Œå‹ç¼©åå‘é€å‹ç¼©åŒ…ã€‚ å¦‚æœä½ æƒ³è¦é€šè¿‡ç½‘ç»œä¼ è¾“ä¸€ä¸ªç›®å½•ä»Aåˆ°Bã€‚ Server12$ tar -cvf - dir_name | nc -n 192.168.10.10 10010$ tar -cvf - dir_name | nc 192.168.10.10 10010 Client1$ nc -l 10010 | tar -xvf - è¿™é‡Œåœ¨AæœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªtarå½’æ¡£åŒ…å¹¶ä¸”é€šè¿‡-åœ¨æ§åˆ¶å°é‡å®šå‘å®ƒï¼Œç„¶åä½¿ç”¨ç®¡é“ï¼Œé‡å®šå‘ç»™netcatï¼Œnetcatå¯ä»¥é€šè¿‡ç½‘ç»œå‘é€å®ƒã€‚ åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬ä¸‹è½½è¯¥å‹ç¼©åŒ…é€šè¿‡netcat ç®¡é“ç„¶åæ‰“å¼€æ–‡ä»¶ã€‚ å¦‚æœæƒ³è¦èŠ‚çœå¸¦å®½ä¼ è¾“å‹ç¼©åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨bzip2æˆ–è€…å…¶ä»–å·¥å…·å‹ç¼©ã€‚ Server123$ tar -cvf - dir_name| bzip2 -z | nc -n 192.168.10.10 10010$ tar -cvf - dir_name| bzip2 -z | nc 192.168.10.10 10010#ä½¿ç”¨ bzip2 å‹ç¼© Client12$ nc -l 10010 | bzip2 -d | tar -xvf -#ä½¿ç”¨ bzip2 è§£å‹ç¼© åŠ å¯†é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®å¦‚æœä½ æ‹…å¿ƒä½ åœ¨ç½‘ç»œä¸Šå‘é€æ•°æ®çš„å®‰å…¨ï¼Œä½ å¯ä»¥åœ¨å‘é€ä½ çš„æ•°æ®ä¹‹å‰ç”¨å¦‚ mcrypt çš„å·¥å…·åŠ å¯†ã€‚ Server12$ nc localhost 10010 | mcrypt -flush -bare -F -q -d -m ecb > testfile.txt#ä½¿ç”¨mcryptå·¥å…·åŠ å¯†æ•°æ® Client1$ mcrypt -flush -bare -F -q -m ecb < testfile.txt | nc -l 10010 ä½¿ç”¨mcryptå·¥å…·è§£å¯†æ•°æ®ã€‚ ä»¥ä¸Šä¸¤ä¸ªå‘½ä»¤ä¼šæç¤ºéœ€è¦å¯†ç ï¼Œç¡®ä¿ä¸¤ç«¯ä½¿ç”¨ç›¸åŒçš„å¯†ç ã€‚ è¿™é‡Œæˆ‘ä»¬æ˜¯ä½¿ç”¨mcryptç”¨æ¥åŠ å¯†ï¼Œä½¿ç”¨å…¶å®ƒä»»æ„åŠ å¯†å·¥å…·éƒ½å¯ä»¥ã€‚ åå‘ SHELLåå‘shellæ˜¯æŒ‡åœ¨å®¢æˆ·ç«¯æ‰“å¼€çš„shellã€‚åå‘shellè¿™æ ·å‘½åæ˜¯å› ä¸ºä¸åŒäºå…¶ä»–é…ç½®ï¼Œè¿™é‡ŒæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ç”±å®¢æˆ·æä¾›çš„æœåŠ¡ã€‚ Server1$ nc -l 10010 åœ¨å®¢æˆ·ç«¯ï¼Œç®€å•åœ°å‘Šè¯‰netcatåœ¨è¿æ¥å®Œæˆåï¼Œæ‰§è¡Œshell Client1$ nc 192.168.10.10 10010 -e /bin/bash ç°åœ¨ï¼Œä»€ä¹ˆæ˜¯åå‘shellçš„ç‰¹åˆ«ä¹‹å¤„å‘¢ åå‘shellç»å¸¸è¢«ç”¨æ¥ç»•è¿‡é˜²ç«å¢™çš„é™åˆ¶ï¼Œå¦‚é˜»æ­¢å…¥ç«™è¿æ¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘æœ‰ä¸€ä¸ªä¸“ç”¨IPåœ°å€ä¸º192.168.10.10ï¼Œæˆ‘ä½¿ç”¨ä»£ç†æœåŠ¡å™¨è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œã€‚å¦‚æœæˆ‘æƒ³ä»ç½‘ç»œå¤–éƒ¨è®¿é—® è¿™å°æœºå™¨å¦‚10.1.1.10çš„shellï¼Œé‚£ä¹ˆæˆ‘ä¼šç”¨åå‘å¤–å£³ç”¨äºè¿™ä¸€ç›®çš„ã€‚ å…‹éš†è®¾å¤‡å¦‚æœä½ å·²ç»å®‰è£…é…ç½®ä¸€å°Linuxæœºå™¨å¹¶ä¸”éœ€è¦é‡å¤åŒæ ·çš„æ“ä½œå¯¹å…¶ä»–çš„æœºå™¨ï¼Œè€Œä½ ä¸æƒ³åœ¨é‡å¤é…ç½®ä¸€éã€‚ä¸åœ¨éœ€è¦é‡å¤é…ç½®å®‰è£…çš„è¿‡ç¨‹ï¼Œåªå¯åŠ¨å¦ä¸€å°æœºå™¨çš„ä¸€äº›å¼•å¯¼å¯ä»¥éšèº«ç¢Ÿå’Œå…‹éš†ä½ çš„æœºå™¨ã€‚ å…‹éš†Linux PCå¾ˆç®€å•ï¼Œå‡å¦‚ä½ çš„ç³»ç»Ÿåœ¨ç£ç›˜/dev/sdaä¸Š Server1$ dd if=/dev/sda | nc -l 10010 åœ¨å®¢æˆ·ç«¯ï¼Œç®€å•åœ°å‘Šè¯‰netcatåœ¨è¿æ¥å®Œæˆåï¼Œæ‰§è¡Œshell Client1$ nc -n 192.168.10.10 10010 | dd of=/dev/sda ddæ˜¯ä¸€ä¸ªä»ç£ç›˜è¯»å–åŸå§‹æ•°æ®çš„å·¥å…·ï¼Œæˆ‘é€šè¿‡netcatæœåŠ¡å™¨é‡å®šå‘å®ƒçš„è¾“å‡ºæµåˆ°å…¶ä»–æœºå™¨å¹¶ä¸”å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œå®ƒä¼šéšç€åˆ†åŒºè¡¨æ‹·è´æ‰€æœ‰çš„ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬å·²ç»åšè¿‡åˆ†åŒºå¹¶ä¸”åªéœ€è¦å…‹éš†rootåˆ†åŒºï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬ç³»ç»Ÿrootåˆ†åŒºçš„ä½ç½®ï¼Œæ›´æ”¹sda ä¸ºsda1ï¼Œsda2.ç­‰ç­‰ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é˜²æ­¢ rm -rf è¯¯åˆ å¸¦æ¥çš„ç¾éš¾]]></title>
    <url>%2F2019%2F03%2F20%2Ftrash-cli%2F</url>
    <content type="text"><![CDATA[å‰è¨€æè¿‡è¿ç»´æƒ³è¿‡è¡Œä¸šçš„æ·«ä»¬éƒ½æœ‰è¿‡rmä¹‹ä¼¤ï¼Œé€ æˆè¡€çš„æ•™è®­ã€‚ä¸ºäº†é¿å…ä»¥åæ‰å‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä¸­åƒä¸‡ä¸è¦ä½¿ç”¨rm -rf è¿™ç§æ“ä½œï¼Œå¤ªå±é™©äº†ã€‚ä¸ºä»€ä¹ˆä¸å­¦å­¦Ubuntu/MacOSç­‰ç³»ç»Ÿæœ‰ä¸€ä¸ªå›æ”¶ç«™ï¼Œåˆ é™¤äº†å¯ä»¥å»å›æ”¶ç«™é‡Œé¢æ‰¾ã€‚ç»è¿‡æŠ˜è…¾ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå·¥å…· trash-cliã€‚trash-cliæ˜¯ä¸€ä¸ªä½¿ç”¨ python å¼€å‘çš„è½¯ä»¶åŒ…ï¼Œtrash-cli trashesè®°å½•åŸå§‹è·¯å¾„ï¼Œåˆ é™¤æ—¥æœŸå’Œæƒé™çš„æ–‡ä»¶ã€‚å®ƒä½¿ç”¨KDEï¼ŒGNOMEå’ŒXFCEä½¿ç”¨çš„ç›¸åŒåƒåœ¾æ¡¶ï¼Œä½†æ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œï¼ˆå’Œè„šæœ¬ï¼‰è°ƒç”¨å®ƒã€‚åŒ…å«:12345* trash-put trash files and directories.* trash-empty empty the trashcan(s).* trash-list list trashed files.* trash-restore restore a trashed file.* trash-rm remove individual files from the trashcan. trash-cli å®‰è£…The easy wayRequirements: Python 2.7 or Python 3 setuptools (use apt-get install python-setuptools on Debian) Installation command:1easy_install trash-cli From sourcesSystem-wide installation:123git clone https://github.com/andreafrancia/trash-cli.gitcd trash-clisudo python setup.py install User-only installation:123git clone https://github.com/andreafrancia/trash-cli.gitcd trash-clipython setup.py install --user trash-cli å‘½ä»¤æŸ¥çœ‹å®‰è£…æˆåŠŸä¹‹åçš„å‘½ä»¤1234567# ll /usr/bin/ | grep trash-rwxr-xr-x 1 root root 123 Feb 2 17:43 trash-rwxr-xr-x 1 root root 125 Feb 2 17:43 trash-empty-rwxr-xr-x 1 root root 124 Feb 2 17:43 trash-list-rwxr-xr-x 1 root root 123 Feb 2 17:43 trash-put-rwxr-xr-x 1 root root 127 Feb 2 17:43 trash-restore-rwxr-xr-x 1 root root 122 Feb 2 17:43 trash-rm åŠŸèƒ½è¯´æ˜ï¼š trash-put å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å›æ”¶ç«™ trash-empty æ¸…ç©ºå›æ”¶ç«™ trash-list åˆ—å‡ºå›æ”¶ç«™ä¸­çš„æ–‡ä»¶ trash-restore è¿˜åŸå›æ”¶ç«™ä¸­çš„æ–‡ä»¶ trash-rm åˆ é™¤å›é¦–ç«™ä¸­çš„å•ä¸ªæ–‡ä»¶ ç”¨å®ƒæ›¿ä»£ rmå‘½ä»¤1234# vim .bashrc # .bashrc#alias rm='rm -i'alias rm='trash-put' å®éªŒæµ‹è¯•åˆ é™¤æµ‹è¯•ï¼š123456# rm -rf dump.sql# ll ~/.local/share/Trash/files -rw-r--r-- 1 root root 123 Jul 17 2018 dump.sql # trash-list2019-02-02 18:02:33 /root/dump.sql è¿˜åŸåˆ é™¤çš„æ–‡ä»¶12345678# trash-restore /root/dump.rdb 0 2019-02-02 18:01:08 /root/dump.sql.bak 1 2019-02-02 18:02:33 /root/dump.sqlWhat file to restore [0..1]: 1è¿˜åŸæˆåŠŸ# ll /root/dump.rdb -rw-r--r-- 1 root root 123 Jul 17 2018 /root/dump.sql ç»“æŸtrash-putå‘½ä»¤ä¼šæŠŠæˆ‘ä»¬æƒ³è¦åˆ é™¤çš„æ–‡ä»¶ç§»åŠ¨åˆ°~/.local/share/Trash/files ä¸­ã€‚ç›¸å…³ä¿¡æ¯è®°å½•åœ¨~/.local/share/Trash/infoä¸­ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ClickHouse-sync-to-MySQLDate]]></title>
    <url>%2F2019%2F03%2F20%2FClickHouse-sync-to-MySQLDate%2F</url>
    <content type="text"><![CDATA[å‰è¨€ ClickHouse è¿™æ¬¾äº§å“å¤§å®¶éƒ½å¬è¯´è¿‡å¾ˆå¿«ï¼Œä½†æ˜¯åˆ°åº•æœ‰å¤šææ€–ï¼Ÿ ClickHouse åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ ä»‹ç»ClickHouseæœ€åˆæ˜¯ä¸º Yandex.Metrica ä¸–ç•Œç¬¬äºŒå¤§Webåˆ†æå¹³å° è€Œå¼€å‘çš„ã€‚å¤šå¹´æ¥ä¸€ç›´ä½œä¸ºè¯¥ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶è¢«è¯¥ç³»ç»ŸæŒç»­ä½¿ç”¨ç€ã€‚ç›®å‰ä¸ºæ­¢ï¼Œè¯¥ç³»ç»Ÿåœ¨ClickHouseä¸­æœ‰è¶…è¿‡13ä¸‡äº¿æ¡è®°å½•ï¼Œå¹¶ä¸”æ¯å¤©è¶…è¿‡200å¤šäº¿ä¸ªäº‹ä»¶è¢«å¤„ç†ã€‚å®ƒå…è®¸ç›´æ¥ä»åŸå§‹æ•°æ®ä¸­åŠ¨æ€æŸ¥è¯¢å¹¶ç”ŸæˆæŠ¥å‘Šã€‚æœ¬æ–‡ç®€è¦ä»‹ç»äº†ClickHouseåœ¨å…¶æ—©æœŸå‘å±•é˜¶æ®µçš„ç›®æ ‡ã€‚ Yandex.MetricaåŸºäºç”¨æˆ·å®šä¹‰çš„å­—æ®µï¼Œå¯¹å®æ—¶è®¿é—®ã€è¿æ¥ä¼šè¯ï¼Œç”Ÿæˆå®æ—¶çš„ç»Ÿè®¡æŠ¥è¡¨ã€‚è¿™ç§éœ€æ±‚å¾€å¾€éœ€è¦å¤æ‚èšåˆæ–¹å¼ï¼Œæ¯”å¦‚å¯¹è®¿é—®ç”¨æˆ·è¿›è¡Œå»é‡ã€‚æ„å»ºæŠ¥è¡¨çš„æ•°æ®ï¼Œæ˜¯å®æ—¶æ¥æ”¶å­˜å‚¨çš„æ–°æ•°æ®ã€‚ æˆªè‡³2014å¹´4æœˆï¼ŒYandex.Metricaæ¯å¤©è·Ÿè¸ªå¤§çº¦120äº¿ä¸ªäº‹ä»¶ï¼ˆç”¨æˆ·çš„ç‚¹å‡»å’Œæµè§ˆï¼‰ã€‚ä¸ºäº†å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„æŠ¥è¡¨ï¼Œæˆ‘ä»¬å¿…é¡»å­˜å‚¨å…¨éƒ¨è¿™äº›äº‹ä»¶ã€‚åŒæ—¶ï¼Œè¿™äº›æŸ¥è¯¢å¯èƒ½éœ€è¦åœ¨å‡ ç™¾æ¯«ç§’å†…æ‰«ææ•°ç™¾ä¸‡è¡Œçš„æ•°æ®ï¼Œæˆ–åœ¨å‡ ç§’å†…æ‰«ææ•°äº¿è¡Œçš„æ•°æ®ã€‚ ä»€ä¹ˆæ˜¯ClickHouse ?ClickHouse æ˜¯é¢å‘ OLAP çš„åˆ†å¸ƒå¼åˆ—å¼ DBMS. ClickHouseçš„æ˜¾è‘—ç‰¹æ€§ çœŸæ­£çš„é¢å‘åˆ—çš„DBMS æ•°æ®é«˜æ•ˆå‹ç¼© ç£ç›˜å­˜å‚¨çš„æ•°æ® å¤šæ ¸å¹¶è¡Œå¤„ç† åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šåˆ†å¸ƒå¼å¤„ç† SQLè¯­æ³•æ”¯æŒ å‘é‡åŒ–å¼•æ“ å®æ—¶æ•°æ®æ›´æ–° ç´¢å¼• é€‚åˆåœ¨çº¿æŸ¥è¯¢ æ”¯æŒè¿‘ä¼¼é¢„ä¼°è®¡ç®— æ”¯æŒåµŒå¥—çš„æ•°æ®ç»“æ„ æ”¯æŒæ•°ç»„ä½œä¸ºæ•°æ®ç±»å‹ æ”¯æŒé™åˆ¶æŸ¥è¯¢å¤æ‚æ€§ä»¥åŠé…é¢ å¤åˆ¶æ•°æ®å¤åˆ¶å’Œå¯¹æ•°æ®å®Œæ•´æ€§çš„æ”¯æŒ OLAPåœºæ™¯çš„å…³é”®ç‰¹å¾ å¤§å¤šæ•°æ˜¯è¯»è¯·æ±‚ æ•°æ®æ€»æ˜¯ä»¥ç›¸å½“å¤§çš„æ‰¹(> 1000 rows)è¿›è¡Œå†™å…¥ ä¸ä¿®æ”¹å·²æ·»åŠ çš„æ•°æ® æ¯æ¬¡æŸ¥è¯¢éƒ½ä»æ•°æ®åº“ä¸­è¯»å–å¤§é‡çš„è¡Œï¼Œä½†æ˜¯åŒæ—¶åˆä»…éœ€è¦å°‘é‡çš„åˆ— å®½è¡¨ï¼Œå³æ¯ä¸ªè¡¨åŒ…å«ç€å¤§é‡çš„åˆ— è¾ƒå°‘çš„æŸ¥è¯¢(é€šå¸¸æ¯å°æœåŠ¡å™¨æ¯ç§’æ•°ç™¾ä¸ªæŸ¥è¯¢æˆ–æ›´å°‘) å¯¹äºç®€å•æŸ¥è¯¢ï¼Œå…è®¸å»¶è¿Ÿå¤§çº¦50æ¯«ç§’ åˆ—ä¸­çš„æ•°æ®ç›¸å¯¹è¾ƒå°ï¼š æ•°å­—å’ŒçŸ­å­—ç¬¦ä¸²(ä¾‹å¦‚ï¼Œæ¯ä¸ªURL 60ä¸ªå­—èŠ‚) å¤„ç†å•ä¸ªæŸ¥è¯¢æ—¶éœ€è¦é«˜ååé‡ï¼ˆæ¯ä¸ªæœåŠ¡å™¨æ¯ç§’é«˜è¾¾æ•°åäº¿è¡Œï¼‰ äº‹åŠ¡ä¸æ˜¯å¿…é¡»çš„ å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä½ æ¯ä¸€ä¸ªæŸ¥è¯¢é™¤äº†ä¸€ä¸ªå¤§è¡¨å¤–éƒ½å¾ˆå° æŸ¥è¯¢ç»“æœæ˜æ˜¾å°äºæºæ•°æ®ï¼Œæ¢å¥è¯è¯´ï¼Œæ•°æ®è¢«è¿‡æ»¤æˆ–èšåˆåèƒ½å¤Ÿè¢«ç››æ”¾åœ¨å•å°æœåŠ¡å™¨çš„å†…å­˜ä¸­ åˆ—å¼æ•°æ®åº“æ›´é€‚åˆOLAPåœºæ™¯çš„åŸå› åˆ—å¼æ•°æ®åº“æ›´é€‚åˆäºOLAPåœºæ™¯(å¯¹äºå¤§å¤šæ•°æŸ¥è¯¢è€Œè¨€ï¼Œå¤„ç†é€Ÿåº¦è‡³å°‘æé«˜äº†100å€)ï¼Œä¸‹é¢è¯¦ç»†è§£é‡Šäº†åŸå› (é€šè¿‡å›¾ç‰‡æ›´æœ‰åˆ©äºç›´è§‚ç†è§£)ï¼šè¡Œå¼åˆ—å¼çœ‹åˆ°å·®åˆ«äº†ä¹ˆï¼Ÿä¸‹é¢å°†è¯¦ç»†ä»‹ç»ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚1.é’ˆå¯¹åˆ†æç±»æŸ¥è¯¢ï¼Œé€šå¸¸åªéœ€è¦è¯»å–è¡¨çš„ä¸€å°éƒ¨åˆ†åˆ—ã€‚åœ¨åˆ—å¼æ•°æ®åº“ä¸­ä½ å¯ä»¥åªè¯»å–ä½ éœ€è¦çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåªéœ€è¦è¯»å–100åˆ—ä¸­çš„5åˆ—ï¼Œè¿™å°†å¸®åŠ©ä½ æœ€å°‘å‡å°‘20å€çš„I/Oæ¶ˆè€—ã€‚2.ç”±äºæ•°æ®æ€»æ˜¯æ‰“åŒ…æˆæ‰¹é‡è¯»å–çš„ï¼Œæ‰€ä»¥å‹ç¼©æ˜¯éå¸¸å®¹æ˜“çš„ã€‚åŒæ—¶æ•°æ®æŒ‰åˆ—åˆ†åˆ«å­˜å‚¨è¿™ä¹Ÿæ›´å®¹æ˜“å‹ç¼©ã€‚è¿™è¿›ä¸€æ­¥é™ä½äº†I/Oçš„ä½“ç§¯ã€‚3.ç”±äºI/Oçš„é™ä½ï¼Œè¿™å°†å¸®åŠ©æ›´å¤šçš„æ•°æ®è¢«ç³»ç»Ÿç¼“å­˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041$ clickhouse-clientClickHouse client version 0.0.52053.Connecting to localhost:9000.Connected to ClickHouse server version 0.0.52053.:) SELECT CounterID, count() FROM hits GROUP BY CounterID ORDER BY count() DESC LIMIT 20SELECT CounterID, count()FROM hitsGROUP BY CounterIDORDER BY count() DESCLIMIT 20â”Œâ”€CounterIDâ”€â”¬â”€â”€count()â”€â”â”‚ 114208 â”‚ 56057344 â”‚â”‚ 115080 â”‚ 51619590 â”‚â”‚ 3228 â”‚ 44658301 â”‚â”‚ 38230 â”‚ 42045932 â”‚â”‚ 145263 â”‚ 42042158 â”‚â”‚ 91244 â”‚ 38297270 â”‚â”‚ 154139 â”‚ 26647572 â”‚â”‚ 150748 â”‚ 24112755 â”‚â”‚ 242232 â”‚ 21302571 â”‚â”‚ 338158 â”‚ 13507087 â”‚â”‚ 62180 â”‚ 12229491 â”‚â”‚ 82264 â”‚ 12187441 â”‚â”‚ 232261 â”‚ 12148031 â”‚â”‚ 146272 â”‚ 11438516 â”‚â”‚ 168777 â”‚ 11403636 â”‚â”‚ 4120072 â”‚ 11227824 â”‚â”‚ 10938808 â”‚ 10519739 â”‚â”‚ 74088 â”‚ 9047015 â”‚â”‚ 115079 â”‚ 8837972 â”‚â”‚ 337234 â”‚ 8205961 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜20 rows in set. Elapsed: 0.153 sec. Processed 1.00 billion rows, 4.00 GB (6.53 billion rows/s., 26.10 GB/s.):) ClickHouse SQLCreating a Table12345678910111213CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1, INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2) ENGINE = MergeTree()[PARTITION BY expr][ORDER BY expr][PRIMARY KEY expr][SAMPLE BY expr][SETTINGS name=value, ...] Example of sections setting1ENGINE MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER BY (CounterID, EventDate, intHash32(UserID)) SAMPLE BY intHash32(UserID) SETTINGS index_granularity=8192 MySQL æ•°æ®å¯¼å…¥æµ‹è¯•æµ‹è¯•ä¸€12345678910# duå‡ºçš„è¡¨å¤§å°5.5G test_1.ibd# ClickHouseæ“ä½œè¯­å¥CREATE TABLE test_1ENGINE = MergeTreeORDER BY id ASSELECT *FROM mysql('host:port', 'dbtest', 'test_1', 'user', 'password') # è€—æ—¶å’Œå¹³å‡é€Ÿåº¦0 rows in set. Elapsed: 137.251 sec. Processed 18.59 million rows, 7.34 GB (135.43 thousand rows/s., 53.48 MB/s.) æµ‹è¯•äºŒ123456789# å¦ä¸€ä¸ªè¡¨20G test_2.ibdCREATE TABLE test_2ENGINE = MergeTreeORDER BY id ASSELECT *FROM mysql('host:port', 'dbtest', 'test_2', 'user', 'password') # ä¸çŸ¥é“ä¸ºå•¥è¿™è¡¨è¿™ä¹ˆå¿«å°±å¯¼å…¥äº† è²Œä¼¼æ˜¯è¡Œå°‘ï¼Œä½†æ˜¯è¡¨çš„æ€»å¤§å°å¤§å•Š0 rows in set. Elapsed: 44.389 sec. Processed 13.03 million rows, 1.44 GB (293.44 thousand rows/s., 32.35 MB/s.) å‚è€ƒClickHouse å®˜æ–¹èµ„æ–™ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[disk cache policy in RAID]]></title>
    <url>%2F2019%2F03%2F11%2Fdisk-cache-policy-in-RAID%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è¿™ç¯‡æ–‡ç« èƒŒåï¼Œå­—å­—éƒ½æ˜¯è¡€æ³ªã€‚æ›¾ç»å› ä¸ºEXT4-fs errorï¼Œä»å¤œé‡Œ10ç‚¹æŠ¢æ•‘æ•°æ®åˆ°å‡Œæ™¨7ç‚¹ï¼Œ ç¡ä¸€ä¸ªå°æ—¶å€™ä¹‹åï¼Œåƒé¥­ï¼Œè§å®¢æˆ·ï¼Œå‘Šè¯‰å®¢æˆ·æ•°æ®æ¢å¤å›æ¥äº†ã€‚åŸç†é¦–å…ˆï¼ŒRAIDçš„write policyåˆ†æˆä¸¤ç§ï¼š write back write through ä¸€ç§æ¨¡å¼æ˜¯write backä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å› ä¸ºåœ¨write backæ¨¡å¼ä¸‹ï¼Œæ•°æ®å†™å…¥Controller Cacheï¼Œå°±è®¤ä¸ºWrite IOç»“æŸäº†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å†™å…¥Hard driverã€‚è¿™ç§æ¨¡å¼å¾ˆæ˜æ˜¾å­˜åœ¨å®‰å…¨éšæ‚£ï¼Œå¼‚å¸¸æ‰ç”µæƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å¼•èµ·æ•°æ®ä¸¢å¤±ã€‚ å¦ä¸€ç§æ¨¡å¼æ˜¯write throughï¼Œè¿™ç§æ¨¡å¼æ¯”è¾ƒè°¨æ…ï¼Œå®ƒå‹æ ¹ä¸ä½¿ç”¨Raid Cacheæ¥åŠ é€Ÿå†™æ“ä½œï¼Œå› æ­¤è¿™ç§æ¨¡å¼çš„æ€§èƒ½è¦æ¯”write back ä½ä¸å°‘ã€‚ ä½†æ˜¯write backçš„ä¸å®‰å…¨ä¹Ÿæ˜¯æœ‰åŠæ³•è§£å†³çš„ï¼š ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ˜¯UPSâ€“Uninterruptible Power Supplyï¼Œè¿™ä¸ªæŒ‰ä¸‹ä¸æ ç¬¬äºŒä¸ªæ–¹æ¡ˆæ˜¯BBUâ€“Backup Battery Unitï¼Œæœ‰äº†BBUï¼Œå°±å¯ä»¥å®‰å¿ƒåœ°é‡‡ç”¨write-backæ¨¡å¼äº† å¯¹BBUä¸å¤ªäº†è§£çš„ï¼Œå¯ä»¥é˜…è¯»[Barriers, Caches, Filesystems]ï¼Œä»‹ç»çš„éå¸¸å¥½ è®²å®Œäº†è¿™ä¸ªwrite policyï¼Œè¿˜æœ‰ä¸€ä¸ªä¸œä¸œå«disk cache policyï¼Œè¿™ä¸ªä¸œè¥¿ç”¨æ¥å†³å®šç£ç›˜ä¸€çº§çš„cacheæ˜¯å¦enableã€‚ ä¸€å®šè¦æ³¨æ„è¿™ä¸ªä¸œè¥¿ï¼Œæ— æ•°è¡€æ³ªéƒ½æ˜¯è¿™ä¸ªä¸œè¥¿å¼•èµ·çš„ã€‚ å¦‚æœé€‰æ‹©write throughæ¨¡å¼ï¼Œå³ä¸ä½¿ç”¨RAID cacheï¼Œè¿™ç§æƒ…å†µä¸‹disk cacheå¯¹æ€§èƒ½çš„æå‡æ˜¯å¾ˆå¤§çš„ã€‚ä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œä¹Ÿä¸è¦enable disk cacheï¼Œå› ä¸ºï¼Œä¼šæœ‰æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚å¦‚æœå¯èƒ½å¼‚å¸¸æ‰ç”µï¼Œé‚£ä¹ˆä¸€å®šä¸è¦enable disk cacheã€‚ ç›¸å…³å‘½ä»¤æŸ¥çœ‹write policy å’Œ disk cache policyçš„å‘½ä»¤å¦‚ä¸‹ï¼š1/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aAll è¾“å‡ºå¦‚ä¸‹ï¼š1234567891011121314151617181920Virtual Drive: 1 (Target Id: 1)Name :RAID Level : Primary-5, Secondary-0, RAID Level Qualifier-3Size : 25.466 TBSector Size : 512Is VD emulated : NoParity Size : 3.637 TBState : OptimalStrip Size : 128 KBNumber Of Drives : 8Span Depth : 1Default Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache if Bad BBUCurrent Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache if Bad BBUDefault Access Policy: Read/WriteCurrent Access Policy: Read/WriteDisk Cache Policy : Disk's DefaultEncryption Type : NonePI type: No PIIs VD Cached: No å¯ä»¥çœ‹åˆ°Disk Cache Policy æ˜¯ Diskâ€™s Default ã€‚è¿™ä¸ªdefaultå€¼å¯ä»¥åˆ†æˆä»¥ä¸‹æƒ…å†µï¼š For virtual disks containing SATA disks ï¼Œ Enabled For virtual disks containing SAS disks ï¼Œ Disabled å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å°†Disk Cache Policyçš„å€¼æ”¹æˆ Disable1/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -DisDskCache -Immediate -Lall -aAll è¾“å‡ºå¦‚ä¸‹ï¼š123456789Set Disk Cache Policy to Disabled on Adapter 0, VD 0 (target id: 0) successSet Disk Cache Policy to Disabled on Adapter 0, VD 1 (target id: 1) successSet Disk Cache Policy to Disabled on Adapter 0, VD 2 (target id: 2) successSet Disk Cache Policy to Disabled on Adapter 0, VD 3 (target id: 3) successSet Disk Cache Policy to Disabled on Adapter 0, VD 4 (target id: 4) successSet Disk Cache Policy to Disabled on Adapter 0, VD 5 (target id: 5) successSet Disk Cache Policy to Disabled on Adapter 0, VD 6 (target id: 6) successExit Code: 0x00 æ­¤æ—¶å†æ¬¡æŸ¥çœ‹è¾“å‡ºï¼š1234567891011121314151617181920Virtual Drive: 1 (Target Id: 1)Name :RAID Level : Primary-5, Secondary-0, RAID Level Qualifier-3Size : 25.466 TBSector Size : 512Is VD emulated : NoParity Size : 3.637 TBState : OptimalStrip Size : 128 KBNumber Of Drives : 8Span Depth : 1Default Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache if Bad BBUCurrent Cache Policy: WriteBack, ReadAhead, Direct, No Write Cache if Bad BBUDefault Access Policy: Read/WriteCurrent Access Policy: Read/WriteDisk Cache Policy : DisabledEncryption Type : NonePI type: No PIIs VD Cached: No æ¨èè®¾ç½®1.å•†ç”¨ç¯å¢ƒï¼ŒRAIDä¸€å®šè¦æœ‰BBU2.write policy é‡‡ç”¨ write back3.disk cache policy ä¸€å®šè¦ä¸ºdisable è¿™ä¸ªæ¨èè®¾ç½®ï¼Œå’ŒIntelç»™å‡ºçš„ Configuring RAID For Optimal Performance æ˜¯ä¸€è‡´çš„ï¼Œé™¤æ­¤ä»¥å¤–ï¼ŒRAID Controller and Hard Disk Cache Settingsä¹Ÿç»™å‡ºäº†ç±»ä¼¼çš„ç»“è®ºã€‚è¿™äº›éƒ½æ˜¯ä¸é”™çš„å‚è€ƒæ–‡çŒ®ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[check e2fsck progress realtime]]></title>
    <url>%2F2019%2F03%2F11%2Fcheck-e2fsck-progress-realtime%2F</url>
    <content type="text"><![CDATA[å‰è¨€å¯¹äºe2fsck è€Œè¨€ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå¦‚æœæ–‡ä»¶ç³»ç»Ÿæ˜¯å¥åº·çš„ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆï¼Œ3ç§’ä¹‹å†…è§£å†³æˆ˜æ–—ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨errorçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è€—æ—¶éå¸¸ä¹…ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿›åº¦æ±‡æŠ¥æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¿®å¤å‡ ä¸ªå°æ—¶ï¼Œåˆæ²¡æœ‰è¿›åº¦æ±‡æŠ¥ï¼Œäººä¼šæŠ“ç‹‚çš„ã€‚å®æ—¶æ£€æŸ¥ e2fsck è¿›åº¦çš„æ–¹æ³•åœ¨e2fsck è¿›è¡Œçš„æ—¶å€™ï¼Œåœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯å‘e2fsck è¿›ç¨‹å‘é€SIGUSR1ä¿¡å·ã€‚1watch -n 5 kill -10 `pidof e2fsck` åœ¨e2fsckè°ƒç”¨çš„ç»ˆç«¯ä¸Šï¼Œå°±ä¼šæ¯5ç§’é’Ÿæ˜¾ç¤ºä¸€ä¸‹å®æ—¶çš„è¿›åº¦ã€‚12345678e2fsck 1.42 (29-Nov-2011)/dev/dm-19 contains a file system with errors, check forced.Pass 1: Checking inodes, blocks, and sizesPass 2: Checking directory structure Pass 3: Checking directory connectivity Pass 4: Checking reference counts Pass 5: Checking group summary information /dev/dm-19: |====================================================== \ 95.8% ç»“æŸè¯­å¹¶éåªæœ‰e2fsck è¿™ä¸ªå·¥å…·ä¼šå“åº”SIGUSR1ä¿¡å·ï¼Œddå·¥å…·ä¹Ÿæœ‰åŒæ ·çš„ç‰¹ç‚¹ã€‚dd æ‹·è´å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œåªæœ‰åœ¨æ‹·è´ç»“æŸçš„æ—¶å€™ï¼Œæ‰ä¼šæ±‡æŠ¥æ—¶é—´ä»¥åŠé€Ÿåº¦ç­‰ä¿¡æ¯ï¼Œä½†æ˜¯åƒæˆ‘è¿™ç§ç­‰å¾…ç„¦è™‘ç»¼åˆç—‡çš„é€‰æ‰‹ï¼Œä¸€å®šæ˜¯ä¼šæŠ“ç‹‚çš„ï¼ŒåŒæ ·é“ç†ï¼Œé€šè¿‡å®æ—¶å‘ddè¿›ç¨‹å‘é€ SIGUSR1ä¿¡å·ï¼Œddè¿›ç¨‹å°±ä¼šæ—¶æ—¶æ±‡æŠ¥é€Ÿç‡ä¿¡æ¯ï¼Œä¸å¦¨è¯•è¯•ï¼Œå¾ˆæœ‰ç”¨ã€‚ å¯¹äºå¼€å‘å„ç§å·¥å…·çš„äººæ¥è¯´ï¼Œå¦‚æœå·¥å…·è¿è¡Œæ—¶é—´å¯èƒ½å¾ˆä¹…ï¼Œå¯ä»¥é€šè¿‡æ³¨å†ŒSIGUSR1ä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œå®æ—¶å‘ç”¨æˆ·æ±‡æŠ¥è¿›åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„ä¹ æƒ¯ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[iSCSI_command]]></title>
    <url>%2F2019%2F03%2F11%2FiSCSI-command%2F</url>
    <content type="text"><![CDATA[å‰è¨€iSCSIå®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤æ€»æ˜¯å¿˜è®°ï¼Œåœ¨æ­¤å¤„è®°å½•ä¸‹ã€‚å¸¸ç”¨å‘½ä»¤æŸ¥çœ‹å½“å‰sessionæŒ‚è½½ä¹‹å‰ï¼Œä¸€èˆ¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š12root@node:~# iscsiadm -m session iscsiadm: No active sessions. æŒ‚è½½ä¹‹å12345678910111213141516171819202122232425262728293031323334353637383940root@node-242:~# iscsiadm -m session tcp: [2] 10.16.172.247:3260,1 iqn.2018-11.com:BEANroot@node-242:~# iscsiadm -m session -P 3iSCSI Transport Class version 2.0-870version 2.0-871Target: iqn.2018-11.com:BEAN Current Portal: 10.16.172.247:3260,1 Persistent Portal: 10.16.172.247:3260,1 ********** Interface: ********** Iface Name: default Iface Transport: tcp Iface Initiatorname: iqn.1993-08.org.debian:01:c9c12dd76e Iface IPaddress: 10.16.172.242 Iface HWaddress: (null) Iface Netdev: (null) SID: 2 iSCSI Connection State: LOGGED IN iSCSI Session State: LOGGED_IN Internal iscsid Session State: NO CHANGE ************************ Negotiated iSCSI params: ************************ HeaderDigest: None DataDigest: None MaxRecvDataSegmentLength: 262144 MaxXmitDataSegmentLength: 1048576 FirstBurstLength: 262144 MaxBurstLength: 1048576 ImmediateData: Yes InitialR2T: No MaxOutstandingR2T: 1 ************************ Attached SCSI devices: ************************ Host Number: 25 State: running scsi25 Channel 00 Id 0 Lun: 0 Attached scsi disk sde State: running æ ¹æ®IP å‘ç°target1iscsiadm -m discovery -t st -p 10.16.172.246 è¾“å‡ºå¦‚ä¸‹ï¼š1234root@node:~# iscsiadm -m discovery -t st -p 10.16.172.24610.16.172.246:3260,1 iqn.2018-11.com:BEAN10.16.172.247:3260,1 iqn.2018-11.com:BEAN10.16.172.248:3260,1 iqn.2018-11.com:BEAN ç™»å½•åˆ°æŒ‡å®štarget1iscsiadm -m node -T [target_name] -p [ip:3260] -l å¦‚ä¸‹æ‰€ç¤ºï¼š1iscsiadm -m node -T iqn.2018-11.com:BEAN -p 10.16.172.246:3260 -l è¾“å‡ºå¦‚ä¸‹ï¼š123root@node:~# iscsiadm -m node -T iqn.2018-11.com:BEAN -p 10.16.172.246:3260 -lLogging in to [iface: default, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260]Login to [iface: default, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260]: successful ç™»å½•ä¹‹åï¼Œå¯ä»¥ç”¨iscsiadm -m sessionæŸ¥çœ‹ã€‚ç»“æœä¸€èˆ¬å¦‚ä¸‹æ‰€ç¤ºï¼š12root@node-242:~# iscsiadm -m session tcp: [3] 10.16.172.246:3260,1 iqn.2018-11.com:BEAN ç™»å‡ºæŒ‡å®štarget1iscsiadm -m node -T [target_name] -p [ip:3260] -u å…·ä½“æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š123root@node:~# iscsiadm -m node -T iqn.2018-11.com:BEAN -p 10.16.172.246:3260 -uLogging out of session [sid: 3, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260]Logout of [sid: 3, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260]: successful ç™»å‡ºä¹‹åï¼Œå¯ä»¥ç”¨iscsiadm -m session æ£€æŸ¥æ•ˆæœã€‚12root@node-242:~# iscsiadm -m session iscsiadm: No active sessions. ä¿¡æ¯ä¸€èˆ¬æ¥è®²ï¼Œç™»å½•targetä¹‹åä¼šæ–°å¢ä¸€ä¸ªç›˜ç¬¦ï¼Œç™»å½•ä¹‹å‰ï¼Œlsblkè¾“å‡ºå¦‚ä¸‹ï¼š123456789101112root@node:~# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk â”œâ”€sda1 8:1 0 7M 0 part â”œâ”€sda2 8:2 0 22.2G 0 part /â”œâ”€sda3 8:3 0 7.5G 0 part [SWAP]â””â”€sda4 8:4 0 261M 0 part sdb 8:16 0 100G 0 disk â”œâ”€sdb1 8:17 0 8G 0 part â””â”€sdb2 8:18 0 92G 0 part /data/osd.2sdc 8:32 0 2T 0 disk sr0 11:0 1 1024M 0 rom æ‰§è¡Œç™»å½•targetä¹‹åï¼š123456789101112131415root@node:~# iscsiadm -m node -T iqn.2018-11.com:BEAN -p 10.16.172.246:3260 -lLogging in to [iface: default, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260] (multiple)Login to [iface: default, target: iqn.2018-11.com:BEAN, portal: 10.16.172.246,3260] successful.root@node2:~# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk â”œâ”€sda1 8:1 0 7M 0 part â”œâ”€sda2 8:2 0 22.2G 0 part /â”œâ”€sda3 8:3 0 7.5G 0 part [SWAP]â””â”€sda4 8:4 0 261M 0 part sdb 8:16 0 100G 0 disk â”œâ”€sdb1 8:17 0 8G 0 part â””â”€sdb2 8:18 0 92G 0 part /data/osd.2sdc 8:32 0 2T 0 disk sr0 11:0 1 1024M 0 rom æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–°å¢äº†ä¸€ä¸ªsdcã€‚ å¦‚æœç¡®å®šsdcå’ŒiSCSI targetçš„å…³ç³»å‘¢:1iscsiadm -m session -P 3 æ¯”å¦‚ä¹‹å‰çš„è¾“å‡º, sdeè¿™å—ç£ç›˜å³iSCSIï¼Œæ¥è‡ª 10.16.172.247:3260çš„Target: iqn.2018-11.com:BEAN12345678910111213141516171819202122232425262728293031323334353637root@node:~# iscsiadm -m session -P 3iSCSI Transport Class version 2.0-870version 2.0-871Target: iqn.2018-11.com:BEAN Current Portal: 10.16.172.247:3260,1 Persistent Portal: 10.16.172.247:3260,1 ********** Interface: ********** Iface Name: default Iface Transport: tcp Iface Initiatorname: iqn.1993-08.org.debian:01:c9c12dd76e Iface IPaddress: 10.16.172.242 Iface HWaddress: (null) Iface Netdev: (null) SID: 2 iSCSI Connection State: LOGGED IN iSCSI Session State: LOGGED_IN Internal iscsid Session State: NO CHANGE ************************ Negotiated iSCSI params: ************************ HeaderDigest: None DataDigest: None MaxRecvDataSegmentLength: 262144 MaxXmitDataSegmentLength: 1048576 FirstBurstLength: 262144 MaxBurstLength: 1048576 ImmediateData: Yes InitialR2T: No MaxOutstandingR2T: 1 ************************ Attached SCSI devices: ************************ Host Number: 25 State: running scsi25 Channel 00 Id 0 Lun: 0 Attached scsi disk sde State: running document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ié€šè¿‡ipmitoolè·å–å„å…ƒä»¶çš„æ¸©åº¦ä¿¡æ¯å’Œæ£€æŸ¥ç”µæºæ¨¡å—çŠ¶æ€]]></title>
    <url>%2F2019%2F03%2F11%2Fipmitool%2F</url>
    <content type="text"><![CDATA[å‰è¨€ipmitoolå¯ä»¥è·å–å„ä¸ªå…ƒä»¶çš„æ¸©åº¦ä¿¡æ¯ï¼Œå¦‚ä½•åˆ¤æ–­å„ä¸ªç»„ä»¶çš„æ¸©åº¦ä¿¡æ¯ï¼Œå„ä¸ªç»„ä»¶çš„æ¸©åº¦ä¿¡æ¯æ˜¯å¦OKï¼Œæœ‰æ²¡æœ‰æ¸©åº¦è¿‡é«˜æˆ–è€…è¿‡ä½çš„å…ƒä»¶éœ€è¦å‘Šè­¦ï¼Ÿè·å–å„ä¸ªå…ƒä»¶æ¸©åº¦çš„æ–¹æ³•æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤è·å–æ‰€æœ‰å…ƒä»¶çš„æ¸©åº¦ä¿¡æ¯å’Œç›¸å…³çš„çŠ¶æ€123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657root@node:~# ipmitool sensor list CPU1 Temp | 29.000 | degrees C | ok | 0.000 | 0.000 | 0.000 | 85.000 | 90.000 | 90.000 CPU2 Temp | 33.000 | degrees C | nr | 10.000 | 10.000 | 10.000 | 30.000 | 30.000 | 30.000 PCH Temp | 32.000 | degrees C | ok | 0.000 | 5.000 | 16.000 | 90.000 | 95.000 | 100.000 System Temp | 30.000 | degrees C | ok | -10.000 | -5.000 | 0.000 | 80.000 | 85.000 | 90.000 Peripheral Temp | 34.000 | degrees C | ok | -10.000 | -5.000 | 0.000 | 80.000 | 85.000 | 90.000 Vcpu1VRM Temp | 28.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 Vcpu2VRM Temp | 34.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 VmemABVRM Temp | 29.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 VmemCDVRM Temp | 28.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 VmemEFVRM Temp | 31.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 VmemGHVRM Temp | 30.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 95.000 | 100.000 | 105.000 P1-DIMMA1 Temp | 27.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 80.000 | 85.000 | 90.000 P1-DIMMA2 Temp | na | | na | na | na | na | na | na | na P1-DIMMB1 Temp | 27.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 80.000 | 85.000 | 90.000 P1-DIMMB2 Temp | na | | na | na | na | na | na | na | na P1-DIMMC1 Temp | na | | na | na | na | na | na | na | na P1-DIMMC2 Temp | na | | na | na | na | na | na | na | na P1-DIMMD1 Temp | na | | na | na | na | na | na | na | na P1-DIMMD2 Temp | na | | na | na | na | na | na | na | na P2-DIMME1 Temp | 29.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 80.000 | 85.000 | 90.000 P2-DIMME2 Temp | na | | na | na | na | na | na | na | na P2-DIMMF1 Temp | 30.000 | degrees C | ok | -5.000 | 0.000 | 5.000 | 80.000 | 85.000 | 90.000 P2-DIMMF2 Temp | na | | na | na | na | na | na | na | na P2-DIMMG1 Temp | na | | na | na | na | na | na | na | na P2-DIMMG2 Temp | na | | na | na | na | na | na | na | na P2-DIMMH1 Temp | na | | na | na | na | na | na | na | na P2-DIMMH2 Temp | na | | na | na | na | na | na | na | na FAN1 | 4400.000 | RPM | ok | 300.000 | 500.000 | 700.000 | 25300.000 | 25400.000 | 25500.000 FAN2 | 4300.000 | RPM | ok | 300.000 | 500.000 | 700.000 | 25300.000 | 25400.000 | 25500.000 FAN3 | 4400.000 | RPM | ok | 300.000 | 500.000 | 700.000 | 25300.000 | 25400.000 | 25500.000 FAN4 | na | | na | na | na | na | na | na | na FAN5 | na | | na | na | na | na | na | na | na FAN6 | na | | na | na | na | na | na | na | na FANA | 4400.000 | RPM | ok | 300.000 | 500.000 | 700.000 | 25300.000 | 25400.000 | 25500.000 FANB | na | | na | na | na | na | na | na | na 12V | 12.315 | Volts | ok | 10.173 | 10.299 | 10.740 | 12.945 | 13.260 | 13.386 5VCC | 5.000 | Volts | ok | 4.246 | 4.298 | 4.480 | 5.390 | 5.546 | 5.598 3.3VCC | 3.316 | Volts | ok | 2.789 | 2.823 | 2.959 | 3.554 | 3.656 | 3.690 VBAT | 3.104 | Volts | ok | 2.376 | 2.480 | 2.584 | 3.494 | 3.598 | 3.676 Vcpu1 | 1.800 | Volts | ok | 1.242 | 1.260 | 1.395 | 1.899 | 2.088 | 2.106 Vcpu2 | 1.809 | Volts | ok | 1.242 | 1.260 | 1.395 | 1.899 | 2.088 | 2.106 VDIMMAB | 1.200 | Volts | ok | 0.948 | 0.975 | 1.047 | 1.344 | 1.425 | 1.443 VDIMMCD | 1.209 | Volts | ok | 0.948 | 0.975 | 1.047 | 1.344 | 1.425 | 1.443 VDIMMEF | 1.209 | Volts | ok | 0.948 | 0.975 | 1.047 | 1.344 | 1.425 | 1.443 VDIMMGH | 1.209 | Volts | ok | 0.948 | 0.975 | 1.047 | 1.344 | 1.425 | 1.443 5VSB | 4.974 | Volts | ok | 4.246 | 4.298 | 4.480 | 5.390 | 5.546 | 5.598 3.3VSB | 3.316 | Volts | ok | 2.789 | 2.823 | 2.959 | 3.554 | 3.656 | 3.690 1.5V PCH | 1.509 | Volts | ok | 1.320 | 1.347 | 1.401 | 1.644 | 1.671 | 1.698 1.2V BMC | 1.209 | Volts | ok | 1.020 | 1.047 | 1.092 | 1.344 | 1.371 | 1.398 1.05V PCH | 1.050 | Volts | ok | 0.870 | 0.897 | 0.942 | 1.194 | 1.221 | 1.248 Chassis Intru | 0x0 | discrete | 0x0000| na | na | na | na | na | na PS1 Status | 0x1 | discrete | 0x0100| na | na | na | na | na | na PS2 Status | 0x1 | discrete | 0x0100| na | na | na | na | na | na AOC_SAS Temp | 60.000 | degrees C | ok | -11.000 | -8.000 | -5.000 | 100.000 | 105.000 | 110.000 HDD Temp | 29.000 | degrees C | ok | -11.000 | -8.000 | -5.000 | 50.000 | 55.000 | 60.000 HDD Status | 0x1 | discrete | 0x01ff| na | na | na | na | na | na ä¸€èˆ¬æ¥è®²ï¼Œç¬¬ä¸‰åˆ—çš„å€¼ä¸­æœ‰degreeçš„ï¼Œæˆ‘ä»¬ç»Ÿè®¡çš„æ˜¯æ¸©åº¦ä¿¡æ¯ã€‚ ç¬¬ä¸€åˆ—ï¼š ä¼ æ„Ÿå™¨çš„åç§°ï¼Œæ¯”å¦‚CPU1 Tempï¼Œ ç¬¬äºŒåˆ—: è¯¥å…ƒä»¶çš„å½“å‰æ¸©åº¦å€¼ï¼Œæ³¨æ„æœ‰æ—¶å€™ä¼šæ˜¯naï¼Œå³å–ä¸åˆ°ã€‚ ç¬¬å››åˆ—ï¼š æ¸©åº¦çš„çŠ¶æ€ä¿¡æ¯ï¼Œokè¡¨ç¤ºæ¸©åº¦æ­£å¸¸ï¼Œæœ‰æ—¶å€™è¯¥çŠ¶æ€å€¼ä¸ºnrï¼Œä¸ºnon-recoveryï¼Œä¸å¯æ¢å¤çš„æ„æ€ ä¸€èˆ¬æ¥è®²ï¼Œå¸¸è§çš„æ¸©åº¦çŠ¶æ€æœ‰ä»¥ä¸‹5ç§ï¼š okï¼šæ¸©åº¦æ­£å¸¸ ncï¼š non-criticalï¼Œæ¸©åº¦åé«˜ï¼ˆæˆ–è€…åä½ï¼‰ï¼Œä½†æ˜¯å¹¶ä¸å¤ªä¸¥é‡ crï¼šcriticalï¼Œæ¸©åº¦å¤ªé«˜æˆ–è€…æ¸©åº¦å¤ªä½ï¼Œå¾ˆä¸¥é‡ nrï¼š non-recoveryï¼Œæ¸©åº¦å¤ªé«˜æˆ–è€…æ¸©åº¦å¤ªä½ï¼Œé€ æˆä¸å¯æ¢å¤çš„æŸä¼¤ã€‚ naï¼šæ¸©åº¦çŠ¶æ€ä¸æ˜ï¼Œæ¯”è¾ƒå°‘è§ã€‚ æ³¨æ„ok â€“> nc â€“> cr â€“> nr ä»æ­£å¸¸ï¼Œåˆ°è¶Šæ¥è¶Šä¸¥é‡çš„æ¸©åº¦é—®é¢˜ã€‚ å¦‚ä½•è§¦å‘æ¸©åº¦å‘Šè­¦ä»‹ç»äº†nc cr å’Œnrä¸‰ç§çŠ¶æ€ï¼Œéƒ½è¯´æ¸©åº¦åé«˜æˆ–è€…æ¸©åº¦åä½ï¼Œé‚£ä¹ˆ æ¸©åº¦åˆ°ä»€ä¹ˆç¨‹åº¦çŠ¶æ€ä¼šå˜æˆncï¼Œ æ¸©åº¦åˆ°ä»€ä¹ˆç¨‹åº¦ä¼šå˜æˆcr æ¸©åº¦åˆ°ä»€ä¹ˆç¨‹åº¦ä¼šå˜æˆnr æ˜¾ç„¶ï¼Œå„ä¸ªå…ƒä»¶çš„çŠ¶æ€æ”¹å˜æ˜¯æœ‰æ¸©åº¦é—¨é™å€¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æŸ¥çœ‹ï¼š123456789101112131415161718192021222324252627root@node:~# ipmitool sensor get "CPU1 Temp"Locating sensor record...Sensor ID : CPU1 Temp (0x1) Entity ID : 3.1 (Processor) Sensor Type (Threshold) : Temperature (0x01) Sensor Reading : 29 (+/- 0) degrees C Status : ok Nominal Reading : 40.000 Normal Minimum : -4.000 Normal Maximum : 89.000 Upper non-recoverable : 90.000 Upper critical : 90.000 Upper non-critical : 85.000 Lower non-recoverable : 0.000 Lower critical : 0.000 Lower non-critical : 0.000 Positive Hysteresis : 2.000 Negative Hysteresis : 2.000 Minimum sensor range : Unspecified Maximum sensor range : Unspecified Event Message Control : Per-threshold Readable Thresholds : lnr lcr lnc unc ucr unr Settable Thresholds : lnr lcr lnc unc ucr unr Threshold Read Mask : lnr lcr lnc unc ucr unr Assertion Events : Assertions Enabled : ucr+ Deassertions Enabled : ucr+ ä»ä¸Šé¢çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼š Upper non-critical 85 åº¦ Upper critical 90 åº¦ Upper non-recovery 90 åº¦ Lower non-critical 0 åº¦ Lower critical 0 åº¦ Lower non-recoverable æœ‰äº†é—¨é™å€¼ï¼Œæ˜¯å“ªç§çŠ¶æ€å°±æ¯”è¾ƒç®€å•äº†ã€‚ [0,85]ä¹‹é—´æ˜¯ï¼ŒçŠ¶æ€ok [85,90] çŠ¶æ€ä¸ºnc [90,] çŠ¶æ€ä¸ºnr ï¼ˆå› ä¸ºcrçš„é—¨é™å’Œnrçš„é—¨é™éƒ½æ˜¯90ï¼ŒçŠ¶æ€å–nrï¼‰ ä½æ¸©çš„æƒ…å†µä¹Ÿæ˜¯ç±»ä¼¼ã€‚ å¦‚ä½•è®©æ¸©åº¦çŠ¶æ€å‘Šè­¦å‘¢ï¼Œå³å˜æˆncæˆ–è€…cræˆ–è€…nrçŠ¶æ€å‘¢ï¼Ÿ ipmitoolæä¾›äº†æ–¹æ³•æ¥è®¾ç½®å„ä¸ªçŠ¶æ€çš„é—¨é™å€¼ã€‚1ipmitool -I open sensor thresh 'CPU2 Temp' upper 20 30 90 ä¸Šè¿°æŒ‡ä»¤çš„æ„æ€æ˜¯å°†CPU2 Tempå…ƒä»¶çš„å‘Šè­¦é—¨é™ä¸­çš„æ¸©åº¦ä¸Šé™å‘Šè­¦é—¨é™è®¾ç½®ä¸º20 30 å’Œ90. ä»¥ä¸ºCPUçš„æ¸©åº¦æ˜¯33åº¦å·¦å³ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤ï¼Œå°†çŠ¶æ€å˜ä¸ºncï¼š12345root@node:~# ipmitool -I open sensor thresh 'CPU2 Temp' upper 20 40 90Locating sensor record 'CPU2 Temp'...Setting sensor "CPU2 Temp" Upper Non-Critical threshold to 20.000Setting sensor "CPU2 Temp" Upper Critical threshold to 40.000Setting sensor "CPU2 Temp" Upper Non-Recoverable threshold to 90.000 12root@node:~# ipmitool sensor listCPU2 Temp | 33.000 | degrees C | nc | 10.000 | 10.000 | 10.000 | 20.000 | 40.000 | 90.000 33æ‘„æ°åº¦ï¼Œè¶…è¿‡äº†20åº¦ï¼Œä½†æ˜¯æ²¡è¦è¶…è¿‡40åº¦ï¼Œå› æ­¤çŠ¶æ€æ˜¯ncï¼Œå³non-criticalã€‚ åŒæ ·é“ç†ï¼Œæˆ‘ä»¬å°†å‘Šè­¦é—¨é™è®¾ç½®ä¸º 20 30 90çš„è¯ï¼Œå°±ä¼šå‘ç°çŠ¶æ€ä¸ºcrï¼Œå³criticalï¼š123456789root@node:~# ipmitool -I open sensor thresh 'CPU2 Temp' upper 20 30 90Locating sensor record 'CPU2 Temp'...Setting sensor "CPU2 Temp" Upper Non-Critical threshold to 20.000Setting sensor "CPU2 Temp" Upper Critical threshold to 30.000Setting sensor "CPU2 Temp" Upper Non-Recoverable threshold to 90.000root@node:~# ipmitool sensor list CPU1 Temp | 30.000 | degrees C | ok | 0.000 | 0.000 | 0.000 | 85.000 | 90.000 | 90.000 CPU2 Temp | 33.000 | degrees C | cr | 10.000 | 10.000 | 10.000 | 20.000 | 30.000 | 90.000 åŒæ ·é“ç†ï¼Œå¯ä»¥å°†çŠ¶æ€å˜æˆnrï¼Œåªéœ€è¦è®¾ç½®é—¨é™ä¸º20 30 30 ï¼Œå³å¯ã€‚ æ£€æŸ¥ç”µæºæ¨¡å—çŠ¶æ€æˆ‘ä»¬çŸ¥é“IPMIå¾ˆå¼ºå¤§ï¼Œå¦‚ä½•åˆ©ç”¨ipmitoolè·å–åˆ°ç”µæºçš„å®æ–½çŠ¶æ€çš„ã€‚ç°ä»£çš„æœåŠ¡å™¨ï¼ŒåŸºæœ¬ä¸Šéƒ½æœ‰ä¸¤ä¸ªç”µæºæ¨¡å—ï¼Œä½œä¸ºå†—ä½™ã€‚å¦‚ä½•æŸ¥çœ‹ç”µæºçš„çŠ¶æ€ä¿¡æ¯å‘¢ï¼Œæ˜¯å¦æ‰€æœ‰çš„ç”µæºæ¨¡å—éƒ½å·²å¯ç”¨ï¼Œç”µæºæ˜¯å¦éƒ½é€šç”µï¼Ÿ æ–¹æ³•ä¸€é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤å¯ä»¥è·å–åˆ°ç”µæºçš„çŠ¶æ€ä¿¡æ¯ï¼š1ipmitool sdr type "power supply" æ­£å¸¸æƒ…å†µä¸‹ç”µæºçš„çŠ¶æ€å¦‚ä¸‹æ‰€ç¤º12PS1 Status | C4h | ok | 10.1 | Presence detectedPS2 Status | C5h | ok | 10.2 | Presence detected å¦‚æœï¼Œæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªæ‹”æ‰ç”µæºæ’å¤´ï¼ŒçŠ¶æ€å°±ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼š12PS1 Status | C4h | ok | 10.1 | Presence detectedPS2 Status | C5h | ok | 10.2 | Presence detected, Failure detected, Power Supply AC lost å¦‚æœæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªçš„ç”µæºæ¨¡å—(PSU, power supply unit)ç›´æ¥ä»æœåŠ¡å™¨ä¸Šæ‹”å‡ºï¼ŒçŠ¶æ€å°±ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼š12PS1 Status | C4h | ok | 10.1 | Presence detectedPS2 Status | C5h | ok | 10.2 | äº‹å®ä¸Šé™¤äº†ä¸Šé¢çš„å‡ ç§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡1ipmitool sensor get "PS1 Status" æŸ¥çœ‹å…¶ä»–å¯èƒ½çš„å€¼123456789101112131415161718192021222324Sensor ID : PS1 Status (0xc4)Entity ID : 10.1 (Power Supply)Sensor Type (Discrete): Power Supply (0x08)Sensor Reading : 1h { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è°è¿äº†æˆ‘çš„NFSç›®å½•]]></title>
    <url>%2F2019%2F03%2F11%2Fshowmount%2F</url>
    <content type="text"><![CDATA[å‰è¨€æœ‰äº›æ—¶å€™ï¼Œä½œä¸ºNFS Serverï¼Œéœ€è¦äº†è§£å“ªäº›clientç«¯è¿äº†æˆ‘çš„NFS ç›®å½•ï¼Œè¿™æ—¶å€™ï¼Œshowmountå‘½ä»¤å°±é—ªäº®ç™»åœºäº†ã€‚ ä½¿ç”¨æ–¹æ³•showmount -a å¯ä»¥æŸ¥çœ‹ï¼Œå½“å‰åˆ°åº•æœ‰å“ªäº›clientè¿æ¥äº†æœ¬Server exportsçš„ç›®å½•12345678910root@node # showmount -a All mount points on Storage-b3:10.1.226.105:/var/share/ezfs/shareroot/mgt10.1.227.1:/var/share/ezfs/shareroot/backup10.1.227.201:/var/share/ezfs/shareroot/mgt10.1.227.2:/var/share/ezfs/shareroot/backup10.1.227.3:/var/share/ezfs/shareroot/backup10.1.227.81:/var/share/ezfs/shareroot/mgt10.1.227.85:/var/share/ezfs/shareroot/mgt10.1.232.199:/var/share/ezfs/shareroot/mgt å°¾å£°showmountæ˜¯ä¸€ä¸ªæ¯”è¾ƒç»¼åˆçš„å‘½ä»¤ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„ç”¨æ³•ã€‚å¯ä»¥é€šè¿‡man æŸ¥çœ‹ã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£iostat]]></title>
    <url>%2F2019%2F03%2F11%2F%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3iostat%2F</url>
    <content type="text"><![CDATA[å‰è¨€iostatç®—æ˜¯æ¯”è¾ƒé‡è¦çš„æŸ¥çœ‹å—è®¾å¤‡è¿è¡ŒçŠ¶æ€çš„å·¥å…·ï¼Œç›¸ä¿¡å¤§å¤šæ•°ä½¿ç”¨Linuxçš„åŒå­¦éƒ½ç”¨è¿‡è¿™ä¸ªå·¥å…·ï¼Œæˆ–è€…å¬è¯´è¿‡è¿™ä¸ªå·¥å…·ã€‚ä½†æ˜¯å¯¹äºè¿™ä¸ªå·¥å…·ï¼Œå¼•èµ·çš„è¯¯è§£ä¹Ÿæ˜¯æœ€å¤šçš„ï¼Œå¤§å¤šæ•°äººå¯¹è¿™ä¸ªå·¥å…·å¤„äºæœ¦æœ¦èƒ§èƒ§çš„çŠ¶æ€ã€‚ç°åœ¨æˆ‘ä»¬ç”±æµ…åˆ°æ·±åœ°ä»‹ç»è¿™ä¸ªå·¥å…·ï¼Œå®ƒè¾“å‡ºçš„å«ä¹‰ä»€ä¹ˆï¼Œä»‹ç»å®ƒçš„èƒ½åŠ›è¾¹ç•Œï¼Œä»‹ç»å…³äºè¿™ä¸ªå·¥å…·çš„å¸¸è§è¯¯è§£ã€‚åŸºæœ¬ç”¨æ³•å’Œè¾“å‡ºçš„åŸºæœ¬å«ä¹‰iostatçš„ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬æ¥è¯´ç”¨æ³•å¦‚ä¸‹ï¼š1iostat -mtx 2 å«ä¹‰æ˜¯è¯´ï¼Œæ¯2ç§’é’Ÿé‡‡é›†ä¸€ç»„æ•°æ®ï¼š123-m Display statistics in megabytes per second.-t Print the time for each report displayed. The timestamp format may depend on the value of the S_TIME_FORMAT environment variable (see below).-x Display extended statistics. è¾“å‡ºçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š æ³¨æ„ï¼Œä¸Šå›¾æ˜¯åœ¨å¯¹sdcè¿™å—å•ç›˜ï¼ˆRAIDå¡ä¸Šçš„å•ç›˜ï¼‰åš4KBçš„éšæœºå†™å…¥æµ‹è¯•ï¼š1fio --name=randwrite --rw=randwrite --bs=4k --size=20G --runtime=1200 --ioengine=libaio --iodepth=64 --numjobs=1 --rate_iops=5000 --filename=/dev/sdf --direct=1 --group_reporting å› æ­¤ä¸Šå›¾ä¸­åªæœ‰sdcåœ¨å¿™ã€‚å¦‚ä½•é˜…è¯»iostatçš„è¾“å‡ºï¼Œå„ä¸ªå‚æ•°éƒ½æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Œåæ˜ äº†ç£ç›˜çš„ä»€ä¹ˆä¿¡æ¯ï¼Ÿç¬¬ä¸€åˆ—Deviceæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå°±æ˜¯è¯´è¿™ä¸€è¡Œæè¿°çš„æ˜¯å“ªä¸€ä¸ªè®¾å¤‡ã€‚ rrqm/s : æ¯ç§’åˆå¹¶è¯»æ“ä½œçš„æ¬¡æ•° wrqm/s: æ¯ç§’åˆå¹¶å†™æ“ä½œçš„æ¬¡æ•° r/s ï¼š æ¯ç§’è¯»æ“ä½œçš„æ¬¡æ•° w/s : æ¯ç§’å†™æ“ä½œçš„æ¬¡æ•° rMB/s : æ¯ç§’è¯»å–çš„MBå­—èŠ‚æ•° wMB/s: æ¯ç§’å†™å…¥çš„MBå­—èŠ‚æ•° avgrq-szï¼š æ¯ä¸ªIOçš„å¹³å‡æ‰‡åŒºæ•°ï¼Œå³æ‰€æœ‰è¯·æ±‚çš„å¹³å‡å¤§å°ï¼Œä»¥æ‰‡åŒºï¼ˆ512å­—èŠ‚ï¼‰ä¸ºå•ä½ avgqu-szï¼š å¹³å‡ä¸ºå®Œæˆçš„IOè¯·æ±‚æ•°é‡ï¼Œå³å¹³å‡æ„ä¹‰å±±çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ awaitï¼š å¹³å‡æ¯ä¸ªIOæ‰€éœ€è¦çš„æ—¶é—´ï¼ŒåŒ…æ‹¬åœ¨é˜Ÿåˆ—ç­‰å¾…çš„æ—¶é—´ï¼Œä¹ŸåŒ…æ‹¬ç£ç›˜æ§åˆ¶å™¨å¤„ç†æœ¬æ¬¡è¯·æ±‚çš„æœ‰æ•ˆæ—¶é—´ã€‚ r_waitï¼š æ¯ä¸ªè¯»æ“ä½œå¹³å‡æ‰€éœ€è¦çš„æ—¶é—´ï¼Œä¸ä»…åŒ…æ‹¬ç¡¬ç›˜è®¾å¤‡è¯»æ“ä½œçš„æ—¶é—´ï¼Œä¹ŸåŒ…æ‹¬åœ¨å†…æ ¸é˜Ÿåˆ—ä¸­çš„æ—¶é—´ã€‚ w_wait: æ¯ä¸ªå†™æ“å¹³å‡æ‰€éœ€è¦çš„æ—¶é—´ï¼Œä¸ä»…åŒ…æ‹¬ç¡¬ç›˜è®¾å¤‡å†™æ“ä½œçš„æ—¶é—´ï¼Œä¹ŸåŒ…æ‹¬åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ã€‚ svctmï¼š è¡¨é¢çœ‹æ˜¯æ¯ä¸ªIOè¯·æ±‚çš„æœåŠ¡æ—¶é—´ï¼Œä¸åŒ…æ‹¬ç­‰å¾…æ—¶é—´ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œè¿™ä¸ªæŒ‡æ ‡å·²ç»åºŸå¼ƒã€‚å®é™…ä¸Šï¼Œiostatå·¥å…·æ²¡æœ‰ä»»ä½•ä¸€è¾“å‡ºé¡¹è¡¨ç¤ºçš„æ˜¯ç¡¬ç›˜è®¾å¤‡å¹³å‡æ¯æ¬¡IOçš„æ—¶é—´ã€‚ %utilï¼š å·¥ä½œæ—¶é—´æˆ–è€…ç¹å¿™æ—¶é—´å æ€»æ—¶é—´çš„ç™¾åˆ†æ¯” avgqu-sz å’Œç¹å¿™ç¨‹åº¦é¦–å…ˆæˆ‘ä»¬ç”¨è¶…å¸‚è´­ç‰©æ¥æ¯”å¯¹iostatçš„è¾“å‡ºã€‚æˆ‘ä»¬åœ¨è¶…å¸‚ç»“è´¦çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæœ‰å¾ˆå¤šé˜Ÿå¯ä»¥æ’ï¼Œé˜Ÿåˆ—çš„é•¿åº¦ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šååº”äº†è¯¥æ”¶é“¶æŸœå°çš„ç¹å¿™ç¨‹åº¦ã€‚é‚£ä¹ˆè¿™ä¸ªå˜é‡æ˜¯avgqu-szè¿™ä¸ªè¾“å‡ºååº”çš„ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºæ’é˜Ÿç­‰å¾…å¤„ç†çš„ioè¶Šå¤šã€‚ æˆ‘ä»¬æ4Kçš„éšæœºIOï¼Œä½†æ˜¯iodepth=1 ï¼ŒæŸ¥çœ‹ä¸‹fioçš„æŒ‡ä»¤å’Œiostatçš„è¾“å‡ºï¼š1fio --name=randwrite --rw=randwrite --bs=4k --size=20G --runtime=1200 --ioengine=libaio --iodepth=1 --numjobs=1 --filename=/dev/sdc --direct=1 --group_reporting åŒæ ·æ˜¯4Kçš„éšæœºIOï¼Œæˆ‘ä»¬è®¾ç½®iodepth=16ï¼Œ æŸ¥çœ‹fioçš„æŒ‡ä»¤å’Œiostatçš„è¾“å‡ºï¼š1fio --name=randwrite --rw=randwrite --bs=4k --size=20G --runtime=1200 --ioengine=libaio --iodepth=16 --numjobs=1 --filename=/dev/sdc --direct=1 --group_reporting æ³¨æ„ sdcçš„avgrq-szè¿™åˆ—çš„å€¼ï¼Œå˜æˆäº†256ï¼Œå³256 ä¸ªæ‰‡åŒº = 256* 512 Byte = 128KBï¼Œç­‰äºæˆ‘ä»¬fioæµ‹è¯•æ—¶ï¼Œä¸‹è¾¾çš„bs = 128kã€‚æ³¨æ„ï¼Œè¿™ä¸ªå€¼ä¹Ÿä¸æ˜¯ä¸ºæ‰€æ¬²ä¸ºçš„ï¼Œå®ƒå—å†…æ ¸å‚æ•°çš„æ§åˆ¶ï¼š123root@node1:~# cat /sys/block/sdc/queue/max_sectors_kb 256#è¿™ä¸ªå€¼ä¸æ˜¯æœ€å¤§ä¸‹å‘çš„IOæ˜¯256KBï¼Œå³512ä¸ªæ‰‡åŒºã€‚å½“æˆ‘ä»¬fioå¯¹sdcè¿™å—ç›˜åšæµ‹è¯•çš„æ—¶å€™ï¼Œå¦‚æœbs=256kï¼Œiostatè¾“å‡ºä¸­çš„avgrq-sz ä¼šå˜æˆ 512 æ‰‡åŒºï¼Œä½†æ˜¯ï¼Œå¦‚æœç»§ç»­å¢å¤§bsï¼Œæ¯”å¦‚bs=512kï¼Œé‚£ä¹ˆiostatè¾“å‡ºä¸­çš„avgrq-szä¸ä¼šç»§ç»­å¢å¤§ï¼Œä»ç„¶æ˜¯512ï¼Œè¡¨ç¤º512æ‰‡åŒºã€‚ 1fio --name=randwrite --rw=randwrite --bs=512k --size=20G --runtime=1200 --ioengine=libaio --iodepth=1 --numjobs=1 --filename=/dev/sdc --direct=1 --group_reporting æ³¨æ„ï¼Œæœ¬æ¥512KBç­‰äº1024ä¸ªæ‰‡åŒºï¼Œavgrq-szåº”è¯¥ä¸º1204ï¼Œä½†æ˜¯ç”±äºå†…æ ¸çš„max_sectors_kbæ§åˆ¶å‚æ•°ï¼Œå†³å®šäº†ä¸å¯èƒ½ï¼šå¦å¤–ä¸€ä¸ªéœ€è¦æ³¨æ„ä¹Ÿä¸éš¾ç†è§£çš„ç°è±¡æ˜¯ï¼Œioè¯·æ±‚è¶Šå¤§ï¼Œéœ€è¦æ¶ˆè€—çš„æ—¶é—´å°±ä¼šè¶Šé•¿ã€‚å¯¹äºå—è®¾å¤‡è€Œè¨€ï¼Œæ—¶é—´åˆ†æˆ2ä¸ªéƒ¨åˆ†ï¼š å¯»é“ è¯»æˆ–å†™æ“ä½œæ³¨æ„æ­¤å¤„çš„å¯»é“ä¸èƒ½ç®€å•åœ°ç†è§£æˆç£ç›˜ç£å¤´æ—‹è½¬åˆ°æŒ‡å®šä½ç½®ï¼Œå› ä¸ºåå¤‡å—è®¾å¤‡å¯èƒ½æ˜¯RAIDï¼Œå¯èƒ½æ˜¯SSDï¼Œæˆ‘ä»¬ç†è§£å†™å…¥å‰çš„å‡†å¤‡åŠ¨ä½œã€‚å‡†å¤‡å·¥ä½œå®Œæˆä¹‹åï¼Œå†™å…¥4Kå’Œå†™å…¥128KBï¼Œæ˜æ˜¾å†™å…¥128KBçš„å·¥ä½œé‡è¦æ›´å¤§ä¸€äº›ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç†è§£éšæœºå†™å…¥128KBç»™å—è®¾å¤‡å¸¦æ¥çš„è´Ÿè½½è¦æ¯”éšæœºå†™å…¥4Kç»™å—è®¾å¤‡å¸¦æ¥çš„è´Ÿè½½è¦é«˜ä¸€äº›ã€‚ å¯¹æ¯”ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œè¶…æ—¶æ’é˜Ÿçš„æ—¶å€™ï¼Œä½ ä¼šé¦–å…ˆæŸ¥çœ‹é˜Ÿåˆ—çš„é•¿åº¦æ¥è¯„ä¼°ä¸‹æ—¶é—´ï¼Œå¦‚æœé˜Ÿåˆ—éƒ½å·®ä¸å¤šé•¿çš„æƒ…å†µä¸‹ï¼Œä½ å°±è¦å…³å¿ƒå‰é¢é¡¾å®¢ç¯®å­é‡Œä¸œè¥¿çš„å¤šå°‘äº†ã€‚å¦‚æœå‰é¢é¡¾å®¢æ¯äººæ‰‹é‡Œæ‹¿ç€ä¸€ä¸¤ä»¶å•†å“ï¼Œå¦ä¸€é˜Ÿå‡ ä¹æ¯ä¸€ä¸ªäººéƒ½æ¨è¿™æ»¡æ»¡ä¸€è½¦å­çš„å•†å“ï¼Œä½ å¯èƒ½çŸ¥é“è¦æ’é‚£ä¸€é˜Ÿã€‚å› ä¸ºå•†å“è¶Šå¤šï¼Œå¤„ç†å•ä¸ªé¡¾å®¢çš„æ—¶é—´å°±ä¼šè¶Šä¹…ã€‚IOä¹Ÿæ˜¯å¦‚æ­¤ã€‚ rrqm/s å’Œwrqm/så—è®¾å¤‡æœ‰ç›¸åº”çš„è°ƒåº¦ç®—æ³•ã€‚å¦‚æœä¸¤ä¸ªIOå‘ç”Ÿåœ¨ç›¸é‚»çš„æ•°æ®å—æ—¶ï¼Œä»–ä»¬å¯ä»¥åˆå¹¶æˆ1ä¸ªIOã€‚ è¿™ä¸ªç®€å•çš„å¯ä»¥ç†è§£ä¸ºå¿«é€’å‘˜è¦ç»™ä¸€ä¸ª18å±‚çš„å…¬å¸æ‰€æœ‰å‘˜å·¥é€å¿«é€’ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸€äº›åŒ…è£¹ï¼Œå¯¹äºå¿«é€’å‘˜æ¥è¯´ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯åŒä¸€æ¥¼å±‚ç›¸è¿‘çš„ä½ç½®çš„åŒ…è£¹ä¸€èµ·æŠ•é€’ï¼Œå¦åˆ™å¦‚æœä¸é‡‡ç”¨è¿™ç§ç®—æ³•ï¼Œé‡‡ç”¨æœ€åŸå§‹çš„æ¥ä¸€ä¸ªé€ä¸€ä¸ªï¼ˆå³noopç®—æ³•ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå¿«é€’å‘˜ï¼Œå¯èƒ½å…ˆé€äº†ä¸€ä¸ªåŒ…æ‹¬åˆ°18å±‚ï¼Œåˆä¸å¾—ä¸è·‘åˆ°2å±‚é€å¦ä¸€ä¸ªåŒ…è£¹ï¼Œç„¶åæœ‰ä¸å¾—ä¸è·‘åˆ°16å±‚é€ç¬¬ä¸‰ä¸ªåŒ…è£¹ï¼Œç„¶ååŒ…åˆ°1å±‚é€ç¬¬ä¸‰ä¸ªåŒ…è£¹ï¼Œé‚£ä¹ˆå¿«é€’å‘˜çš„è½¨è¿¹æ˜¯æ‚ä¹±æ— ç« çš„ï¼Œä¹Ÿæ˜¯éå¸¸ä½æ•ˆçš„ã€‚ Linuxå¸¸è§çš„è°ƒåº¦ç®—æ³•æœ‰: noop deadline cfq 12root@node:~# cat /sys/block/sdc/queue/scheduler [noop] deadline cfq ç±»æ¯”æ€»ç»“æˆ‘ä»¬è¿˜æ˜¯ä»¥è¶…æ—¶è´­ç‰©ä¸ºä¾‹ï¼Œæ¯”å¦‚ä¸€å®¶ä¸‰å£å»è´­ç‰©ï¼Œå„äººä¹°å„äººçš„ä¸œè¥¿ï¼Œæœ€ç»ˆä¼šæ±‡æ€»åˆ°æ”¶é“¶å°ï¼Œä½ å›ºç„¶å¯ä»¥æ¯äººå„è‡ªä»˜å„è‡ªçš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ±‡æ€»ä¸€ä¸‹ï¼ŒæŠŠæ‰€æœ‰è´­ä¹°çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·ï¼Œç”±ä¸€ä¸ªäººæ¥å®Œæˆï¼Œä¹Ÿå°±è¯´ï¼Œä¸‰æ¬¡æ”¶é“¶äº‹ä»¶mergeæˆäº†ä¸€æ¬¡ã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬ä»¥è¶…æ—¶è´­ç‰©æ”¶é“¶ä¸ºä¾‹ï¼Œä»‹ç»äº†avgqu-sz ç±»æ¯”äºé˜Ÿä¼çš„é•¿åº¦ï¼Œavgrq-sz ç±»æ¯”äºæ¯ä¸ªäººè´­ç‰©è½¦é‡Œç‰©å“çš„å¤šå°‘ï¼Œrrqm/så’Œwrqm/s ç±»æ¯”äºå°†ä¸€å®¶è´­å¾—ä¸œè¥¿æ±‡æ€»ä¸€èµ·ï¼Œä»˜è´¹ä¸€æ¬¡ã€‚è¿˜æœ‰svctmå’Œ%utilä¸¤ä¸ªæ²¡æœ‰ä»‹ç»ã€‚ æŒ‰ç…§æˆ‘ä»¬çš„å‰§æƒ…ï¼Œæˆ‘ä»¬è‡ªç„¶è€Œç„¶åœ°å¯ä»¥å°†svctmç±»æ¯”æˆæ”¶é“¶æœåŠ¡å‘˜æœåŠ¡æ¯ä¸ªå®¢æˆ·éœ€è¦çš„å¹³å‡æ—¶é—´ï¼Œ%utilç±»æ¯”æˆæ”¶é“¶æœåŠ¡å‘˜å·¥ä½œçš„ç¹å¿™ç¨‹åº¦ã€‚ æ³¨æ„è¿™ä¸ªç±»æ¯”æ˜¯é”™è¯¯çš„ï¼Œå°±æ˜¯å› ä¸ºç±»ä¼¼çš„ç±»æ¯”ï¼Œå®¹æ˜“è®©äººé™·å…¥è¯¯åŒºä¸èƒ½è‡ªæ‹”ã€‚ä¸èƒ½ç®€å•åœ°å°†svctmç†è§£æˆå•ä¸ªIOè¢«å—è®¾å¤‡å¤„ç†çš„æœ‰æ•ˆæ—¶é—´ï¼ŒåŒæ—¶ä¸èƒ½ç†è§£æˆ%utilåˆ°äº†100% ï¼Œç£ç›˜å·¥ä½œå°±é¥±å’Œäº†ï¼Œä¸èƒ½ç»§ç»­æå‡äº†ï¼Œè¿™æ˜¯ä¸¤ä¸ªå¸¸è§çš„è¯¯åŒºã€‚ svctmå’Œ%utilæ˜¯iostatæœ€å®¹æ˜“å¼•èµ·è¯¯è§£çš„ä¸¤ä¸ªè¾“å‡ºã€‚ä¸ºäº†å‡†ç¡®åœ°è¯„ä¼°å—è®¾å¤‡çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°è¿™æ ·ä¸€ä¸ªæ•°å€¼ï¼šå³ä¸€ä¸ªioä»å‘ç»™å—è®¾å¤‡å±‚åˆ°å®Œæˆè¿™ä¸ªioçš„æ—¶é—´ï¼Œä¸åŒ…æ‹¬å…¶ä»–åœ¨é˜Ÿåˆ—ç­‰å¾…çš„æ—¶é—´ã€‚ä»è¡¨é¢çœ‹ï¼Œsvctmå°±æ˜¯è¿™ä¸ªå€¼ã€‚å®é™…ä¸Šå¹¶éå¦‚æ­¤ã€‚ Linuxä¸‹iostatè¾“å‡ºçš„svctmå¹¶ä¸å…·å¤‡è¿™æ–¹é¢çš„å«ä¹‰ï¼Œè¿™ä¸ªæŒ‡æ ‡åº”è¯¥éåºŸå¼ƒã€‚iostatå’Œsarçš„man pageéƒ½æœ‰è¿™æ–¹é¢çš„è­¦å‘Šï¼š12svctmThe average service time (in milliseconds) for I/O requests that were issued to the device. Warning! Do not trust this field any more. This field will be removed in a future sysstat version. é‚£ä¹ˆiostatè¾“å‡ºä¸­çš„svctmåˆ°åº•æ˜¯æ€ä¹ˆæ¥çš„ï¼Œ%utilåˆæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Œè¿›è€Œiostatçš„è¾“å‡ºçš„å„ä¸ªå­—æ®µéƒ½æ˜¯ä»å“ªé‡Œæ‹¿åˆ°çš„ä¿¡æ¯å‘¢ï¼Ÿ iostatè¾“å‡ºçš„æ•°æ®æ¥æºdiskstatsiostatæ•°æ®çš„æ¥æºæ˜¯ Linux æ“ä½œç³»ç»Ÿçš„ /proc/diskstats æ³¨æ„ï¼Œprocfsä¸­çš„å‰ä¸‰ä¸ªå­—æ®µï¼šä¸»è®¾å¤‡å·ã€ä»è®¾å¤‡å·ã€è®¾å¤‡åã€‚ä»ç¬¬å››ä¸ªå­—æ®µå¼€å§‹ï¼Œä»‹ç»çš„æ˜¯è¯¥è®¾å¤‡çš„ç›¸å…³ç»Ÿè®¡ï¼š (rd_ios) : è¯»æ“ä½œçš„æ¬¡æ•° (rd_merges):åˆå¹¶è¯»æ“ä½œçš„æ¬¡æ•°ã€‚å¦‚æœä¸¤ä¸ªè¯»æ“ä½œè¯»å–ç›¸é‚»çš„æ•°æ®å—ï¼Œé‚£ä¹ˆå¯ä»¥è¢«åˆå¹¶æˆ1ä¸ªã€‚ (rd_sectors): è¯»å–çš„æ‰‡åŒºæ•°é‡ (rd_ticks):è¯»æ“ä½œæ¶ˆè€—çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚æ¯ä¸ªè¯»æ“ä½œä»__make_request()å¼€å§‹è®¡æ—¶ï¼Œåˆ°end_that_request_last()ä¸ºæ­¢ï¼ŒåŒ…æ‹¬äº†åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ã€‚ (wr_ios):å†™æ“ä½œçš„æ¬¡æ•° (wr_merges):åˆå¹¶å†™æ“ä½œçš„æ¬¡æ•° (wr_sectors): å†™å…¥çš„æ‰‡åŒºæ•°é‡ (wr_ticks): å†™æ“ä½œæ¶ˆè€—çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ (in_flight): å½“å‰æœªå®Œæˆçš„I/Oæ•°é‡ã€‚åœ¨I/Oè¯·æ±‚è¿›å…¥é˜Ÿåˆ—æ—¶è¯¥å€¼åŠ 1ï¼Œåœ¨I/Oç»“æŸæ—¶è¯¥å€¼å‡1ã€‚ æ³¨æ„ï¼šæ˜¯I/Oè¯·æ±‚è¿›å…¥é˜Ÿåˆ—æ—¶ï¼Œè€Œä¸æ˜¯æäº¤ç»™ç¡¬ç›˜è®¾å¤‡æ—¶ (io_ticks)è¯¥è®¾å¤‡ç”¨äºå¤„ç†I/Oçš„è‡ªç„¶æ—¶é—´(wall-clock time) (time_in_queue): å¯¹å­—æ®µ#10(io_ticks)çš„åŠ æƒå€¼ è¿™äº›å­—æ®µå¤§å¤šæ¥è‡ªå†…æ ¸çš„å¦‚ä¸‹æ•°æ®ï¼š123456789include/linux/genhd.hstruct disk_stats { unsigned long sectors[2]; /* READs and WRITEs */ unsigned long ios[2]; unsigned long merges[2]; unsigned long ticks[2]; unsigned long io_ticks; unsigned long time_in_queue;}; é™¤äº†in_flightæ¥è‡ªï¼š12345part_in_flight(hd), static inline int part_in_flight(struct hd_struct *part){ return atomic_read(&part->in_flight[0]) + atomic_read(&part->in_flight[1]);} å†…æ ¸ç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š1234567891011121314151617181920while ((hd = disk_part_iter_next(&piter))) { cpu = part_stat_lock(); part_round_stats(cpu, hd); part_stat_unlock(); seq_printf(seqf, "%4d %7d %s %lu %lu %llu " "%u %lu %lu %llu %u %u %u %u\n", MAJOR(part_devt(hd)), MINOR(part_devt(hd)), disk_name(gp, hd->partno, buf), part_stat_read(hd, ios[READ]), part_stat_read(hd, merges[READ]), (unsigned long long)part_stat_read(hd, sectors[READ]), jiffies_to_msecs(part_stat_read(hd, ticks[READ])), part_stat_read(hd, ios[WRITE]), part_stat_read(hd, merges[WRITE]), (unsigned long long)part_stat_read(hd, sectors[WRITE]), jiffies_to_msecs(part_stat_read(hd, ticks[WRITE])), part_in_flight(hd), jiffies_to_msecs(part_stat_read(hd, io_ticks)), jiffies_to_msecs(part_stat_read(hd, time_in_queue)) ); io_ticks and time_in_queueè¿™é‡Œé¢å¤§éƒ¨åˆ†å­—æ®µéƒ½æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œç¨å¾®éš¾ç†è§£çš„åœ¨äºio_ticksã€‚åˆçœ‹ä¹‹ä¸‹ï¼Œæ˜æ˜å·²ç»æœ‰äº†rd_tickså’Œwr_ticks ä¸ºä»€ä¹ˆè¿˜éœ€ä¸€ä¸ªio_ticksã€‚æ³¨æ„rd_tickså’Œwr_ticksæ˜¯æŠŠæ¯ä¸€ä¸ªIOæ¶ˆè€—æ—¶é—´ç´¯åŠ èµ·æ¥ï¼Œä½†æ˜¯ç¡¬ç›˜è®¾å¤‡ä¸€èˆ¬å¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªIOï¼Œå› æ­¤ï¼Œrd_tickså’Œwr_ticksä¹‹å’Œä¸€èˆ¬ä¼šæ¯”è‡ªç„¶æ—¶é—´ï¼ˆwall-clock timeï¼‰è¦å¤§ã€‚è€Œio_ticks ä¸å…³å¿ƒé˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªIOåœ¨æ’é˜Ÿï¼Œå®ƒåªå…³å¿ƒè®¾å¤‡æœ‰IOçš„æ—¶é—´ã€‚å³ä¸è€ƒè™‘IOæœ‰å¤šå°‘ï¼Œåªè€ƒè™‘IOæœ‰æ²¡æœ‰ã€‚åœ¨å®é™…è¿ç®—ä¸­ï¼Œin_flightä¸æ˜¯0çš„æ—¶å€™ä¿æŒè®¡æ—¶ï¼Œè€Œin_flight ç­‰äº0çš„æ—¶å€™ï¼Œæ—¶é—´ä¸ç´¯åŠ åˆ°io_ticksã€‚ ä¸‹ä¸€ä¸ªæ¯”è¾ƒéš¾ç†è§£çš„æ˜¯time_in_queueè¿™ä¸ªå€¼ï¼Œå®ƒçš„è®¡ç®—æ˜¯å½“å‰IOæ•°é‡ï¼ˆå³in_flightçš„å€¼ï¼‰ä¹˜ä»¥è‡ªç„¶æ—¶é—´é—´éš”ã€‚è¡¨é¢çœ‹è¯¥å˜é‡çš„åå­—å«time_in_queueï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œå¹¶ä¸åªæ˜¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ã€‚ æœ‰äººä¸ç†è§£time_in_queueï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡è¯»è¿‡å°å­¦ å¬è¿‡ä¸‹é¢è¿™å¥è¯çš„å°æœ‹å‹éƒ½ä¼šç†è§£time_in_queueï¼š å› ä¸ºä½ ä¸Šè¯¾è®²è¯ï¼Œ è®©è€å¸ˆæ‰¹è¯„ä½ 5åˆ†é’Ÿï¼Œç­é‡Œæœ‰50äººï¼Œ50ä¸ªäººä½ å°±æµªè´¹äº†å…¨ç­250åˆ†é’Ÿã€‚ è¿™æ®µè¯éå¸¸å½¢è±¡åœ°ä»‹ç»äº†time_in_queueçš„è®¡ç®—æ³•åˆ™ï¼Œå³è‡ªç„¶æ—¶é—´åªè¿‡å»äº†5åˆ†é’Ÿï¼Œä½†æ˜¯å¯¹äºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰åŒå­¦ï¼Œå“¦ä¸ï¼Œæ‰€æœ‰IOæ¥è¯´ï¼Œéœ€è¦åŠ æƒè®¡ç®—ï¼š123456789101112131415161718static void part_round_stats_single(int cpu, struct hd_struct *part, unsigned long now){ if (now == part->stamp) return; /*å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå­˜åœ¨in_flight io*/ if (part_in_flight(part)) { /*å°å­¦æ•°å­¦è€å¸ˆçš„ç®—æ³•ï¼Œnow-part->stamp ä¹˜ä»¥ç­çº§äººæ•°ï¼Œå“¦ä¸ï¼Œæ˜¯ä¹˜ä»¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ioè¯·æ±‚ä¸ªæ•°*/ __part_stat_add(cpu, part, time_in_queue, part_in_flight(part) * (now - part->stamp)); /*å¦‚å®çš„è®°å½•ï¼Œå› ä¸ºæ‰¹è¯„è°ƒçš®å­¦ç”Ÿï¼Œæµªè´¹äº†5åˆ†é’Ÿã€‚ioä¸æ˜¯ç©ºçš„æ—¶é—´å¢åŠ now - part->stamp*/ __part_stat_add(cpu, part, io_ticks, (now - part->stamp)); } part->stamp = now;} è¿™ä¸ªè®¡ç®—çš„æ–¹æ³•å¾ˆç®€å•ï¼š å½“è¯·æ±‚é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ io_ticksä¸å¢åŠ  time_in_queueä¸å¢åŠ  part->stamp æ›´æ–°ä¸ºnow å½“è¯·æ±‚é˜Ÿåˆ—ä¸æ˜¯ç©ºçš„æ—¶å€™ io_tickså¢åŠ ï¼Œ å¢åŠ é‡ä¸º now - part->timestamp time_in_queueå¢åŠ ï¼Œå¢åŠ é‡ä¸º åœ¨é˜Ÿåˆ—ä¸­IOçš„ä¸ªæ•°ä¹˜ä»¥ (now - part->stamp) part->stamp æ›´æ–°ä¸ºnow æ³¨æ„è°ƒç”¨part_round_stats_singleå‡½æ•°çš„æ—¶æœºåœ¨äº åœ¨æ–°IOè¯·æ±‚æ’å…¥é˜Ÿåˆ—ï¼ˆè¢«mergeçš„ä¸ç®—ï¼‰ å®Œæˆä¸€ä¸ªIOè¯·æ±‚ ç©ºè¯´å¤ªè¿‡æŠ½è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ç»™å‡ºä¸€ä¸ªä¾‹å­æ¥ä»‹ç»io_tickså’Œtime_in_queueçš„è®¡ç®— ID Time Ops in_flight stamp stamp_delta io_ticks time_in_queue 0 100 æ–°è¯·æ±‚å…¥é˜Ÿåˆ— 0 0 æ— éœ€è®¡ç®— 0 0 1 100.10 æ–°è¯·æ±‚å…¥é˜Ÿåˆ— 1 100 100.10-100 = 0.1 0.1 0.1 2 101.20 å®Œæˆä¸€ä¸ªIOè¯·æ±‚ 2 100.10 101.20-100.10 = 1.1 1.2 0.1+1.1*2 = 2.3 3 103.60 å®Œæˆä¸€ä¸ªIOè¯·æ±‚ 1 101.20 103.60-101.20 = 2.4 3.6 2.3+2.4*1=4.7 4 153.60 æ–°è¯·æ±‚å…¥é˜Ÿåˆ— 0 103.60 æ— éœ€è®¡ç®— 3.6 4.7 5 153.90 å®Œæˆä¸€ä¸ªIOè¯·æ±‚ 1 153.60 153.90 - 153.60 = 0.3 3.9 4.7+0.3 * 1= 5 æ³¨æ„ä¸Šé¢æ€»æ—¶é—´æ˜¯53.90æ—¶é—´å†…ï¼Œæœ‰3.9ç§’çš„è‡ªç„¶æ—¶é—´å†…æ˜¯æœ‰IOçš„ï¼Œå³IOé˜Ÿåˆ—çš„éç©ºæ—¶é—´ä¸º3.9ç§’ã€‚ æ³¨æ„ï¼Œio_ticksè¿™ä¸ªå­—æ®µè¢«iostatç”¨æ¥è®¡ç®—%utilï¼Œè€Œtime_in_queueè¿™ä¸ªå­—æ®µè¢«iostatç”¨æ¥è®¡ç®—avgqu-szï¼Œå³å¹³å‡é˜Ÿåˆ—é•¿åº¦ã€‚ å…¶å®ä¸éš¾ç†è§£äº†ï¼Œé˜Ÿåˆ—ä¸­ä¸ä¸ºç©ºçš„æ—¶å€™å æ€»æ—¶é—´çš„æ¯”ä¾‹å³ä¸º %util /proc/diskstatsä¸­å…¶ä»–æ•°æ®é¡¹çš„æ›´æ–°æ—¢ç„¶æˆ‘ä»¬ä»‹ç»äº†io_tickså’Œtime_in_queueï¼Œæˆ‘ä»¬ä¹Ÿç®€å•ä»‹ç»ä¸‹å…¶ä»–å­—æ®µçš„è·å–ã€‚åœ¨æ¯ä¸ªIOç»“æŸåï¼Œéƒ½ä¼šè°ƒç”¨blk_account_io_doneå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè´Ÿè´£æ›´æ–°rd_ios/wr_iosã€rd_ticks/wr_ticks ,åŒ…æ‹¬ä¼šæ›´æ–°in_flightã€‚123456789101112131415161718192021222324252627282930313233343536373839404142void blk_account_io_done(struct request *req){ /* * Account IO completion. flush_rq isn't accounted as a * normal IO on queueing nor completion. Accounting the * containing request is enough. */ if (blk_do_io_stat(req) && !(req->rq_flags & RQF_FLUSH_SEQ)) { unsigned long duration = jiffies - req->start_time; /*ä»reqè·å–è¯·æ±‚ç±»å‹ï¼šR / W*/ const int rw = rq_data_dir(req); struct hd_struct *part; int cpu; cpu = part_stat_lock(); part = req->part; /*æ›´æ–°è¯»æˆ–å†™æ¬¡æ•°ï¼Œè‡ªåŠ */ part_stat_inc(cpu, part, ios[rw]); /*å°†ioçš„å­˜æ´»æ—¶é—´ï¼Œæ›´æ–°åˆ°rd_ticks or wr_ticks*/ part_stat_add(cpu, part, ticks[rw], duration); /*æ›´æ–°io_tickså’Œtime_in_queue*/ part_round_stats(cpu, part); /*å¯¹åº”infight å‡ 1 */ part_dec_in_flight(part, rw); hd_struct_put(part); part_stat_unlock(); } }``` ##### æ³¨æ„part_round_statsä¼šè°ƒç”¨ä¸Šä¸€å°èŠ‚ä»‹ç»çš„part_round_stats_singleå‡½æ•°ï¼š```cgovoid part_round_stats(int cpu, struct hd_struct *part){ /*æ—¢è¦æ›´æ–°åˆ†åŒºçš„ç»Ÿè®¡ï¼Œä¹Ÿè¦æ›´æ–°æ•´ä¸ªå—è®¾å¤‡çš„ç»Ÿè®¡*/ unsigned long now = jiffies; if (part->partno) part_round_stats_single(cpu, &part_to_disk(part)->part0, now); part_round_stats_single(cpu, part, now);} è¯»å†™æ‰‡åŒºçš„ä¸ªæ•°ç»Ÿè®¡ï¼Œæ˜¯åœ¨blk_account_io_completionå‡½æ•°ä¸­å®ç°çš„ï¼š12345678910111213void blk_account_io_completion(struct request *req, unsigned int bytes) { if (blk_do_io_stat(req)) { const int rw = rq_data_dir(req); struct hd_struct *part; int cpu; cpu = part_stat_lock(); part = req->part; /*å³ç§»9ä½ï¼Œç›¸å½“äºé™¤ä»¥512å­—èŠ‚ï¼Œå³ä¸€ä¸ªæ‰‡åŒºçš„å­—èŠ‚æ•°*/ part_stat_add(cpu, part, sectors[rw], bytes >> 9); part_stat_unlock(); } } å…³äºmergeéƒ¨åˆ†çš„ç»Ÿè®¡ï¼Œåœ¨blk_account_io_startå‡½æ•°ä¸­ç»Ÿè®¡ï¼š123456789101112131415161718192021222324252627282930void blk_account_io_start(struct request *rq, bool new_io){ struct hd_struct *part; int rw = rq_data_dir(rq); int cpu; if (!blk_do_io_stat(rq)) return; cpu = part_stat_lock(); if (!new_io) { /*æ³¨æ„ï¼Œmergeçš„IOå°±ä¸ä¼šå¯¼è‡´in_flight++*/ part = rq->part; part_stat_inc(cpu, part, merges[rw]); } else { part = disk_map_sector_rcu(rq->rq_disk, blk_rq_pos(rq)); if (!hd_struct_try_get(part)) { part = &rq->rq_disk->part0; hd_struct_get(part); } /*æ–°IOï¼Œæ›´æ–°io_ticks and time_in_queue*/ part_round_stats(cpu, part); /*in_flight åŠ 1*/ part_inc_in_flight(part, rw); rq->part = part; } part_stat_unlock();} iostat è¾“å‡ºçš„è®¡ç®—æ³¨æ„ï¼Œ/proc/diskstats å·²ç»å°†æ‰€æœ‰çš„ç´ æéƒ½å‡†å¤‡å¥½äº†ï¼Œå¯¹äºiostatç¨‹åºæ¥è¯´ï¼Œå°±æ˜¯å°†å¤„ç†è¿™äº›æ•°æ®ï¼Œç»™å®¢æˆ·å±•ç°å‡ºæ›´å‹å¥½ï¼Œæ›´æœ‰æ„ä¹‰çš„æ•°å€¼ã€‚äº‹å®ä¸Šï¼Œiostatçš„æºç éå¸¸çš„çŸ­ï¼Œå®ƒå±äºsysstatè¿™ä¸ªå¼€æºè½¯ä»¶ï¼Œæ•´ä¸ªæ–‡ä»¶å¤§å°1619è¡Œã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950int read_sysfs_file_stat(int curr, char *filename, char *dev_name){ FILE *fp; struct io_stats sdev; int i; unsigned int ios_pgr, tot_ticks, rq_ticks, wr_ticks; unsigned long rd_ios, rd_merges_or_rd_sec, wr_ios, wr_merges; unsigned long rd_sec_or_wr_ios, wr_sec, rd_ticks_or_wr_sec; /* Try to read given stat file */ if ((fp = fopen(filename, "r")) == NULL) return 0; i = fscanf(fp, "%lu %lu %lu %lu %lu %lu %lu %u %u %u %u", &rd_ios, &rd_merges_or_rd_sec, &rd_sec_or_wr_ios, &rd_ticks_or_wr_sec, &wr_ios, &wr_merges, &wr_sec, &wr_ticks, &ios_pgr, &tot_ticks, &rq_ticks); if (i == 11) { /* Device or partition */ sdev.rd_ios = rd_ios; sdev.rd_merges = rd_merges_or_rd_sec; sdev.rd_sectors = rd_sec_or_wr_ios; sdev.rd_ticks = (unsigned int) rd_ticks_or_wr_sec; sdev.wr_ios = wr_ios; sdev.wr_merges = wr_merges; sdev.wr_sectors = wr_sec; sdev.wr_ticks = wr_ticks; sdev.ios_pgr = ios_pgr; sdev.tot_ticks = tot_ticks; sdev.rq_ticks = rq_ticks; } else if (i == 4) { /* Partition without extended statistics */ sdev.rd_ios = rd_ios; sdev.rd_sectors = rd_merges_or_rd_sec; sdev.wr_ios = rd_sec_or_wr_ios; sdev.wr_sectors = rd_ticks_or_wr_sec; } if ((i == 11) || !DISPLAY_EXTENDED(flags)) { /* * In fact, we _don't_ save stats if it's a partition without * extended stats and yet we want to display ext stats. */ save_stats(dev_name, curr, &sdev, iodev_nr, st_hdr_iodev); } fclose(fp); return 1;} æ•°æ®éƒ½é‡‡é›†åˆ°äº†ï¼Œå‰©ä¸‹å°±æ˜¯è®¡ç®—äº†ã€‚å…¶ä¸­ä¸‹é¢å‡ é¡¹çš„è®¡ç®—æ˜¯éå¸¸ç®€å•çš„ï¼š rrqm/s wrqm/s r/s w/s rMB/s wMB/s è¿™å‡ é¡¹çš„è®¡ç®—æ˜¯éå¸¸ç®€å•çš„ï¼Œå°±æ˜¯é‡‡æ ·ä¸¤æ¬¡ï¼Œåä¸€æ¬¡çš„å€¼å‡å»å‰ä¸€æ¬¡çš„å€¼ï¼Œç„¶åé™¤ä»¥æ—¶é—´é—´éš”ï¼Œå¾—åˆ°å¹³å‡å€¼å³å¯ã€‚å› ä¸ºè¿™äº›/proc/diskstatsä¸­å¯¹åº”çš„å€¼éƒ½æ˜¯ç´¯åŠ çš„ï¼Œåä¸€æ¬¡å‡å»å‰ä¸€æ¬¡ï¼Œå³å¾—åˆ°é‡‡æ ·æ—¶é—´é—´éš”å†…çš„æ–°å¢é‡ã€‚ä¸èµ˜è¿°ã€‚ avgrq-szçš„è®¡ç®—123456789101112/* rrq/s wrq/s r/s w/s rsec wsec rqsz qusz await r_await w_await svctm %util */ cprintf_f(2, 8, 2, S_VALUE(ioj->rd_merges, ioi->rd_merges, itv), S_VALUE(ioj->wr_merges, ioi->wr_merges, itv)); cprintf_f(2, 7, 2, S_VALUE(ioj->rd_ios, ioi->rd_ios, itv), S_VALUE(ioj->wr_ios, ioi->wr_ios, itv)); cprintf_f(4, 8, 2, S_VALUE(ioj->rd_sectors, ioi->rd_sectors, itv) / fctr, S_VALUE(ioj->wr_sectors, ioi->wr_sectors, itv) / fctr, xds.arqsz, //æ­¤å¤„æ˜¯avgrq-sz S_VALUE(ioj->rq_ticks, ioi->rq_ticks, itv) / 1000.0);//æ­¤å¤„æ˜¯avgqu-sz æ³¨æ„avgrq-szæ¥è‡ªxdsçš„argszå˜é‡ï¼Œè¯¥å˜é‡æ˜¯é€šè¿‡è¯¥å‡½æ•°è®¡ç®—å¾—åˆ°çš„ï¼š1234567891011121314151617/*æ³¨æ„sdcä¸­çš„cæŒ‡çš„æ˜¯currentï¼Œsdpä¸­çš„pæŒ‡çš„æ˜¯previous*/void compute_ext_disk_stats(struct stats_disk *sdc, struct stats_disk *sdp, unsigned long long itv, struct ext_disk_stats *xds){ double tput = ((double) (sdc->nr_ios - sdp->nr_ios)) * HZ / itv; xds->util = S_VALUE(sdp->tot_ticks, sdc->tot_ticks, itv); xds->svctm = tput ? xds->util / tput : 0.0; xds->await = (sdc->nr_ios - sdp->nr_ios) ? ((sdc->rd_ticks - sdp->rd_ticks) + (sdc->wr_ticks - sdp->wr_ticks)) / ((double) (sdc->nr_ios - sdp->nr_ios)) : 0.0; xds->arqsz = (sdc->nr_ios - sdp->nr_ios) ? ((sdc->rd_sect - sdp->rd_sect) + (sdc->wr_sect - sdp->wr_sect)) / ((double) (sdc->nr_ios - sdp->nr_ios)) : 0.0;} æ³¨æ„nr_iosæ¥è‡ªå¦‚ä¸‹è¿ç®—ï¼Œå³è¯»IOå’Œå†™IOçš„å’Œ 12sdc.nr_ios = ioi->rd_ios + ioi->wr_ios;sdp.nr_ios = ioj->rd_ios + ioj->wr_ios; é‚£ä¹ˆxds->arqsz çš„è®¡ç®—å°±æ˜¯å¦‚ä¸‹å«ä¹‰ï¼š1234xds->arqsz = (è¯»æ‰‡åŒºæ€»æ•° + å†™æ‰‡åŒºæ€»æ•°)/(è¯»IOæ¬¡æ•°+å†™IOæ¬¡æ•°)xds->arqsz = (sdc->nr_ios - sdp->nr_ios) ? ((sdc->rd_sect - sdp->rd_sect) + (sdc->wr_sect - sdp->wr_sect)) / ((double) (sdc->nr_ios - sdp->nr_ios)) : 0.0; å¥½å§ã€‚åæ­£æˆ‘æ˜¯éå¸¸ä¸ç†è§£è¿™ä»–å¦ˆçš„å’‹å›äº‹ğŸ˜‚ã€‚avgqu-szçš„è®¡ç®—å¹³å‡é˜Ÿåˆ—é•¿åº¦çš„è®¡ç®—ï¼Œè¿™ä¸ªè®¡ç®—å°±ç”¨åˆ°äº†diskstatsä¸­time_in_queueè¿™ä¸ªå€¼ã€‚è¿™ä¸ªå€¼çš„è®¡ç®—æ¥è‡ªè¿™å¥è¯ï¼š1S_VALUE(ioj->rq_ticks, ioi->rq_ticks, itv) / 1000.0) å…¶ä¸­rq_tickså³diskstatsä¸­çš„time_in_queueã€‚ æˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹çš„åœºæ™¯ï¼Œå¦‚æœIOè¯·æ±‚æœ‰ä¸€ä¸ªburstï¼ŒåŒä¸€æ—¶é—´æ¥äº†250ä¸ªIOè¯·æ±‚ï¼Œåç»­å†ä¹Ÿæ²¡æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè¯·æ±‚å¤„ç†æ—¶é—´éƒ½æ˜¯4msï¼Œé‚£ä¹ˆæ‰€æœ‰IOçš„å¹³å‡ç­‰å¾…æ—¶é—´ä¸ºï¼š1å¹³å‡ç­‰å¾…æ—¶é—´ = å•ä¸ªè¯·æ±‚å¤„ç†æ—¶é—´*(1+2+3+4...+(è¯·æ±‚æ€»æ•°-1))/è¯·æ±‚æ€»æ•° å¯¹äºæˆ‘ä»¬è¿™ä¸ªä¾‹å­è€Œè¨€ï¼Œå¹³å‡ç­‰å¾…æ—¶é—´æ˜¯4*125 = 500 ms é‚£ä¹ˆæ‰€æœ‰IOèŠ±è´¹çš„æ€»æ—¶é—´ä¸º250*500=125000æ¯«ç§’ï¼Œè¿™ä¸ªæ—¶é—´é™¤ä»¥1000æ¯«ç§’ï¼š1125000/1000 = 125 å³å¹³å‡ä¸‹æ¥ï¼Œé˜Ÿåˆ—çš„é•¿åº¦æ˜¯125 ï¼Œè¿™ä¸ªå€¼å¾ˆæ˜æ˜¾æ˜¯ç¬¦åˆç›´è§‚çš„ã€‚æ’åœ¨é˜Ÿåˆ—æœ€å‰ç«¯çš„IOè®¤ä¸ºï¼Œé˜Ÿåˆ—çš„é•¿åº¦æ˜¯0ï¼Œç¬¬2ä¸ªIOè®¤ä¸ºé˜Ÿåˆ—çš„é•¿åº¦æ˜¯1ï¼Œç¬¬3ä¸ªIOè®¤ä¸ºé˜Ÿåˆ—çš„é•¿åº¦æ˜¯2ï¼Œæœ€åä¸€ä¸ªè®¤ä¸ºé˜Ÿåˆ—çš„é•¿åº¦æ˜¯249ã€‚ æˆ‘ä»¬æ¢ä¸€ç§æ€è·¯æ¥è€ƒè™‘ï¼Œå³diskstatsä¸­time_in_queueçš„æ€è·¯ã€‚ å½“ç¬¬ä¸€ä¸ªIOå®Œæˆçš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­250ä¸ªIOï¼Œ250ä¸ªIOéƒ½ç­‰äº†4msï¼Œå³time_in_queue + = (2504) ï¼Œå½“ç¬¬äºŒä¸ªIOå®Œæˆçš„æ—¶å€™ï¼Œtime_in_queue += (2494)ï¼Œå½“æ‰€æœ‰IOéƒ½å®Œæˆçš„æ—¶å€™ï¼Œtime_in_queue = 4*(250+249+248â€¦.+1)ï¼Œ â€¦ æ ¹æ®time_in_queue/1000,æ®Šé€”åŒå½’åœ°è·å¾—äº†å¹³å‡é˜Ÿåˆ—é•¿åº¦ã€‚ awaitã€r_waitåŠw_waitçš„è®¡ç®—123456789void compute_ext_disk_stats(struct stats_disk *sdc, struct stats_disk *sdp, unsigned long long itv, struct ext_disk_stats *xds){ ... xds->await = (sdc->nr_ios - sdp->nr_ios) ? ((sdc->rd_ticks - sdp->rd_ticks) + (sdc->wr_ticks - sdp->wr_ticks)) / ((double) (sdc->nr_ios - sdp->nr_ios)) : 0.0; ...} è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„äº†ï¼š1await = ((æ‰€æœ‰è¯»IOçš„æ—¶é—´)+(æ‰€æœ‰å†™IOçš„æ—¶é—´))/((è¯»è¯·æ±‚çš„ä¸ªæ•°) + (å†™è¯·æ±‚çš„ä¸ªæ•°)) æ³¨æ„ä¸€ç‚¹å°±è¡Œäº†ï¼Œè¿™ä¸ªæ‰€æœ‰è¯»IOçš„æ—¶é—´å’Œæ‰€æœ‰å†™IOçš„æ—¶é—´ï¼Œéƒ½æ˜¯åŒ…æ‹¬IOåœ¨é˜Ÿåˆ—çš„æ—¶é—´åœ¨å†…çš„ã€‚ä¸èƒ½ä¸€å¢æƒ…æ„¿åœ°è®¤ä¸ºï¼Œæ˜¯ç£ç›˜æ§åˆ¶å™¨å¤„ç†è¯¥IOçš„æ—¶é—´ã€‚ æ³¨æ„ï¼Œèƒ½ä¸èƒ½è¯´ï¼Œawaitæ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥æ­¦æ–­åœ°åˆ¤å®šè¿™å—ç›˜çš„èƒ½åŠ›å¾ˆèœï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ã€‚awaitè¿™ä¸ªå€¼ä¸èƒ½åæ˜ ç¡¬ç›˜è®¾å¤‡çš„æ€§èƒ½ã€‚awaitçš„è¿™ä¸ªå€¼ä¸èƒ½åæ˜ ç¡¬ç›˜è®¾å¤‡çš„æ€§èƒ½ï¼Œawaitè¿™ä¸ªå€¼ä¸èƒ½åæ˜ ç¡¬ç›˜è®¾å¤‡çš„æ€§èƒ½ï¼Œé‡è¦çš„è¯è®²ä¸‰éã€‚ æˆ‘ä»¬è€ƒè™‘ä¸¤ç§IOçš„æ¨¡å‹ 250ä¸ªIOè¯·æ±‚åŒæ—¶è¿›å…¥ç­‰å¾…é˜Ÿåˆ— 250ä¸ªIOè¯·æ±‚åŒæ—¶è¿›å…¥ç­‰å¾…é˜Ÿåˆ— ç¬¬ä¸€ç§æƒ…å†µawaité«˜è¾¾500msï¼Œç¬¬äºŒä¸ªæƒ…å†µawaitåªæœ‰4msï¼Œä½†æ˜¯éƒ½æ˜¯åŒä¸€å—ç›˜ã€‚ ä½†æ˜¯æ³¨æ„awaitæ˜¯ç›¸å½“é‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼Œå®ƒè¡¨æ˜äº†ç”¨æˆ·å‘èµ·çš„IOè¯·æ±‚çš„å¹³å‡å»¶è¿Ÿï¼š1wait = IO å¹³å‡å¤„ç†æ—¶é—´ + IOåœ¨é˜Ÿåˆ—çš„å¹³å‡ç­‰å¾…æ—¶é—´ å› æ­¤ï¼Œè¿™ä¸ªæŒ‡æ ‡æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæŒ‡æ ‡ğŸ˜³ã€‚ %util å’Œç£ç›˜è®¾å¤‡é¥±å’Œåº¦æ³¨æ„ï¼Œ%utilæ˜¯æœ€å®¹æ˜“è®©äººäº§ç”Ÿè¯¯è§£çš„ä¸€ä¸ªå‚æ•°ã€‚å¾ˆå¤šåˆå­¦è€…çœ‹åˆ°%util ç­‰äº100%å°±è¯´ç¡¬ç›˜èƒ½åŠ›åˆ°é¡¶äº†ï¼Œè¿™ç§è¯´æ³•æ˜¯é”™è¯¯çš„ğŸ˜¨ã€‚%utilæ•°æ®æºè‡ªdiskstatsä¸­çš„io_ticksï¼Œè¿™ä¸ªå€¼å¹¶ä¸å…³å¿ƒç­‰å¾…åœ¨é˜Ÿé‡Œé‡Œé¢IOçš„ä¸ªæ•°ï¼Œå®ƒåªå…³å¿ƒé˜Ÿåˆ—ä¸­æœ‰æ²¡æœ‰IOã€‚ å’Œè¶…æ—¶æ’é˜Ÿç»“è´¦è¿™ä¸ªç±»æ¯”æœ€æœ¬è´¨çš„åŒºåˆ«åœ¨äºï¼Œç°ä»£ç¡¬ç›˜éƒ½æœ‰å¹¶è¡Œå¤„ç†å¤šä¸ªIOçš„èƒ½åŠ›ï¼Œä½†æ˜¯æ”¶é“¶å‘˜æ²¡æœ‰ã€‚æ”¶é“¶å‘˜æ— æ³•åšåˆ°åŒæ—¶å¤„ç†10ä¸ªé¡¾å®¢çš„ç»“è´¦ä»»åŠ¡è€Œæ¶ˆè€—çš„æ€»æ—¶é—´ä¸å¤„ç†ä¸€ä¸ªé¡¾å®¢ç»“è´¦ä»»åŠ¡ç›¸å·®æ— å‡ ã€‚ä½†æ˜¯ç£ç›˜å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå³ä½¿%utilåˆ°äº†100%ï¼Œä¹Ÿå¹¶ä¸æ„å‘³ç€è®¾å¤‡é¥±å’Œäº†ã€‚ æœ€ç®€å•çš„ä¾‹å­æ˜¯ï¼ŒæŸç¡¬ç›˜å¤„ç†å•ä¸ªIOè¯·æ±‚éœ€è¦0.1ç§’ï¼Œæœ‰èƒ½åŠ›åŒæ—¶å¤„ç†10ä¸ªã€‚ä½†æ˜¯å½“10ä¸ªè¯·æ±‚ä¾æ¬¡æäº¤çš„æ—¶å€™ï¼Œéœ€è¦1ç§’é’Ÿæ‰èƒ½å®Œæˆè¿™10%çš„è¯·æ±‚ï¼Œï¼Œåœ¨1ç§’çš„é‡‡æ ·å‘¨æœŸé‡Œï¼Œ%utilè¾¾åˆ°äº†100%ã€‚ä½†æ˜¯å¦‚æœ10ä¸ªè¯·ä¸€æ¬¡æ€§æäº¤çš„è¯ï¼Œ ç¡¬ç›˜å¯ä»¥åœ¨0.1ç§’å†…å…¨éƒ¨å®Œæˆï¼Œè¿™æ—¶å€™ï¼Œ%utilåªæœ‰10%ã€‚ å› æ­¤ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸€ç§’ä¸­10ä¸ªIOï¼Œå³IOPS=10çš„æ—¶å€™ï¼Œ%utilå°±è¾¾åˆ°äº†100%ï¼Œè¿™å¹¶ä¸èƒ½è¡¨æ˜ï¼Œè¯¥ç›˜çš„IOPSå°±åªèƒ½åˆ°10ï¼Œäº‹å®ä¸Šï¼Œçºµä½¿%utilåˆ°äº†100%ï¼Œç¡¬ç›˜å¯èƒ½ä»ç„¶æœ‰å¾ˆå¤§çš„ä½™åŠ›å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œå³å¹¶æœªè¾¾åˆ°é¥±å’Œçš„çŠ¶æ€ã€‚ ä¸‹ä¸€å°èŠ‚æœ‰4å¼ å›¾ï¼Œå¯ä»¥çœ‹åˆ°å½“IOPSä¸º1000çš„æ—¶å€™%utilä¸º100%ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€è¯¥ç›˜çš„IOPSå°±åœ¨1000ï¼Œå®é™…ä¸Š2000ï¼Œ3000,5000çš„IOPSéƒ½å¯ä»¥è¾¾åˆ°ã€‚æ ¹æ®%util 100%æ—¶çš„ r/s æˆ–w/s æ¥æ¨ç®—ç£ç›˜çš„IOPSæ˜¯ä¸å¯¹çš„ã€‚ é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªæŒ‡æ ‡ç”¨æ¥è¡¡é‡ç¡¬ç›˜è®¾å¤‡çš„é¥±å’Œç¨‹åº¦å‘¢ã€‚å¾ˆé—æ†¾ï¼Œiostatæ²¡æœ‰ä¸€ä¸ªæŒ‡æ ‡å¯ä»¥è¡¡é‡ç£ç›˜è®¾å¤‡çš„é¥±å’Œåº¦ã€‚ svctmçš„è®¡ç®—å¯¹äºiostatè¿™ä¸ªåŠŸèƒ½è€Œè¨€ï¼Œ%utilå›ºç„¶ä¼šç»™äººå¸¦æ¥ä¸€å®šçš„è¯¯è§£å’Œè‹¦æ‰°ï¼Œä½†æ˜¯svctmç»™äººå¸¦æ¥çš„è¯¯è§£æ›´å¤šã€‚ä¸€ç›´ä»¥æ¥ï¼Œäººä»¬å¸Œæœ›äº†è§£å—è®¾å¤‡å¤„ç†å•ä¸ªIOçš„service timeï¼Œè¿™ä¸ªæŒ‡æ ‡ç›´æ¥åœ°ååº”äº†ç¡¬ç›˜çš„èƒ½åŠ›ã€‚ å›åˆ°è¶…å¸‚æ”¶é“¶è¿™ä¸ªç±»æ¯”ä¸­ï¼Œå¦‚æœæ”¶é“¶å‘˜æ˜¯ä¸ªè€æ‰‹ï¼Œæ“ä½œæµï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œé‚£ä¹ˆå¤§å®¶è‚¯å®šæ›´æ„¿æ„æ’è¿™ä¸€é˜Ÿã€‚ä½†æ˜¯å¦‚æœæ”¶é“¶å‘˜æ˜¯ä¸ªæ–°æ‰‹ï¼Œå„ç§æ“ä½œä¸ç†Ÿæ‚‰ï¼ŒåŠ¨ä½œæ…¢ï¼Œæ•ˆç‡å¾ˆä½ï¼Œé‚£ä¹ˆåŒæ ·å¤šçš„ä»»åŠ¡ï¼Œå°±ä¼šèŠ±è´¹æ›´é•¿çš„æ—¶é—´ã€‚å› æ­¤IOçš„å¹³å‡service timeï¼ˆä¸åŒ…æ‹¬æ’é˜Ÿæ—¶é—´ï¼‰æ˜¯éå¸¸æœ‰æ„ä¹‰çš„ã€‚ ä½†æ˜¯service timeå’Œiostatæ— å…³ï¼Œiostatæ²¡æœ‰ä»»ä½•ä¸€ä¸ªå‚æ•°èƒ½å¤Ÿæä¾›è¿™æ–¹é¢çš„ä¿¡æ¯ã€‚è€Œsvctmè¿™ä¸ªè¾“å‡ºç»™äº†äººä»¬è¿™ç§ç¾å¥½çš„æœŸå¾…ï¼Œå´åªèƒ½è®©äººç©ºæ¬¢å–œã€‚ ä»ç°åœ¨èµ·ï¼Œæˆ‘ä»¬è®°ä½ï¼Œæˆ‘ä»¬ä¸èƒ½ä»svctmä¸­å¾—åˆ°è‡ªå·±æœŸå¾…çš„service timeè¿™ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å…¶å®å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œäº‹å®ä¸Šï¼Œè¿™ä¸ªå€¼ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒæ˜¯æ ¹æ®å…¶ä»–å€¼è®¡ç®—å‡ºæ¥çš„ã€‚12345678910void compute_ext_disk_stats(struct stats_disk *sdc, struct stats_disk *sdp, unsigned long long itv, struct ext_disk_stats *xds) { double tput = ((double) (sdc->nr_ios - sdp->nr_ios)) * HZ / itv; xds->util = S_VALUE(sdp->tot_ticks, sdc->tot_ticks, itv); xds->svctm = tput ? xds->util / tput : 0.0; ...} å¦‚æœä¸€ä¸ªç›˜çš„èƒ½åŠ›å¾ˆå¼ºæ‚ï¼Œéšæœºå°IOï¼ˆ4Kï¼‰fioæµ‹è¯•ä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ç°è±¡ï¼šå½“IOPSä¸º1000çš„æ—¶å€™ï¼Œiostaè¾“å‡ºçš„svctmä¸º1(ms)ï¼Œå½“IOPSä¸º2000çš„æ—¶å€™ï¼Œiostatè¾“å‡ºçš„svctmä¸º0.5(ms),å½“IOPSä¸º3000çš„æ—¶å€™ï¼Œiostatè¾“å‡ºçš„svctmä¸º0.33ã€‚åŸå› å…¶å®æ— ä»–ï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹%utiléƒ½æ˜¯100%ï¼Œå³å½“é‡‡æ ·å‘¨æœŸæ˜¯1ç§’çš„æ—¶å€™ï¼Œç”¨æ»¡äº†1ç§’ï¼Œtputå°±æ˜¯fioæŒ‡å®šçš„â€“rate-iops å³1000ã€2000ã€3000ï¼Œå› æ­¤ç®—å‡ºæ¥svctmä¸ºå¯¹åº”çš„1ã€0.5ã€0.33ã€‚ æ³¨æ„ä¸Šé¢çš„ç›˜sdgæ˜¯iSCSIï¼Œå­˜å‚¨ç©ºé—´æ˜¯ç”±åˆ†å¸ƒå¼å­˜å‚¨æä¾›ï¼Œä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆå•ä¸ªç›˜éšæœºIOPSèƒ½æ— å‹åŠ›çš„åˆ°5000ï¼‰ å› æ­¤ä»è¿™ä¸ªä¾‹å­çœ‹ï¼ŒæŠŠiostatçš„è¾“å‡ºä¸­çš„svctmçœ‹ä½œæ˜¯IOçš„å¤„ç†æ—¶é—´æ˜¯ç›¸å½“ä¸é è°±çš„ã€‚ä¸ºäº†é˜²æ­¢å¸¦æ¥çš„è¯¯è§£ï¼Œå¯ä»¥ç›´æ¥å¿½ç•¥è¿™ä¸ªå‚æ•°ã€‚ æ—¢ç„¶svctmä¸èƒ½åæ˜ IOå¤„ç†æ—¶é—´ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªå‚æ•°å¯ä»¥æµ‹é‡å—è®¾å¤‡çš„IOå¹³å‡å¤„ç†æ—¶é—´å‘¢ï¼Ÿå¾ˆé—æ†¾iostatæ˜¯åšä¸åˆ°çš„ã€‚ä½†æ˜¯åªè¦æ€æƒ³ä¸æ»‘å¡ï¼ŒåŠæ³•æ€»æ¯”å›°éš¾å¤šï¼Œblktraceè¿™ä¸ªç¥å™¨å¯èƒ½å¾—åˆ°è¿™ä¸ªè®¾å¤‡çš„IOå¹³å‡å¤„ç†æ—¶é—´ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è¿›å…¥å¦ä¸€ä¸ªå¤©åœ°ğŸ˜‡ã€‚ å°¾å£°iostatèƒ½å¤Ÿæä¾›ç»™æˆ‘ä»¬çš„ä¿¡æ¯å°±è¿™ä¹ˆå¤šäº†ï¼Œé€šè¿‡åˆ†ææˆ‘ä»¬æœŸå¾…èƒ½å¤Ÿå¾—åˆ°å—è®¾å¤‡å¤„ç†IOçš„æ—¶é—´ï¼Œè¿™å°±è¦é blocktraceè¿™ä¸ªå·¥å…·äº†ã€‚blktraceå¯ä»¥è®²IOè·¯å¾„åˆ†æ®µï¼Œåˆ†åˆ«ç»Ÿè®¡å„æ®µçš„æ¶ˆè€—çš„æ—¶é—´ã€‚ æœ¬æ–‡å¤§é‡å‚è€ƒvmunixçš„å®¹æ˜“è¢«è¯¯è¯»çš„IOSTATï¼Œä»¥åŠæ·±å…¥åˆ†ædiskstatsï¼Œå…¶ä¸­ç¬¬äºŒç¯‡æ–‡ç« ç»™å‡ºäº†ä¸€ä¸ªå¾ˆè¯¦ç»†çš„IO PATHçš„æµç¨‹å›¾ï¼Œéå¸¸æœ‰ç”¨ã€‚ç¬¬äºŒç¯‡æ–‡ç« ä¸­éšç€ä»£ç æ¼”è¿›æœ‰ä¸€äº›å˜åŒ–ï¼Œæœ¬æ–‡é‡‡ç”¨çš„æ¯”è¾ƒæ–°çš„Linux Kernel codeåšä»‹ç»ï¼ŒåŒæ—¶æ¼”ç®—io_tickså’Œtime_in_queueéƒ¨åˆ†ç¬¬äºŒç¯‡æ–‡ç« ä¹Ÿæœ‰é”™è¯¯ï¼Œä¹Ÿä¸€å¹¶ä¿®æ­£äº†ã€‚ä¸è¿‡ç‘•ä¸æ©ç‘œï¼Œè¿™ä¸¤ç¯‡éƒ½æ˜¯éå¸¸æ£’çš„æ–‡ç« ã€‚å‘å‰è¾ˆè‡´æ•¬ã€‚ æœ¬æ–‡æ¥è‡ªäºBean Li document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gdisk_å¸¸ç”¨æ“ä½œ]]></title>
    <url>%2F2019%2F03%2F11%2Fgdisk-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%2F</url>
    <content type="text"><![CDATA[å‰è¨€ä¼ ç»Ÿçš„è€ç‰Œçš„åˆ†åŒºå·¥å…·æ˜¯fdiskï¼Œä½†æ˜¯fdiskå‡ºé“å¤ªæ—©ï¼Œåªæ”¯æŒMBRï¼ˆMaster Boot Recordï¼‰ï¼Œå¹¶ä¸æ”¯æŒGPTï¼ˆGUID Partition Tableï¼‰ï¼Œæ— æ³•æ“ä½œè¶…è¿‡2Tçš„ç£ç›˜ï¼Œå› æ­¤gdisk partedç­‰åˆ†åŒºå·¥å…·æ¨ªç©ºå‡ºä¸–ã€‚gdiskå’Œpartedéƒ½æ›¾ç»ç”¨è¿‡ï¼Œä½†æ˜¯æˆ‘æ›´å–œæ¬¢gdiskï¼Œå› ä¸ºä½¿ç”¨ä¸Šï¼Œgdisk ä¸Šæ‰¿fdiskï¼Œæ²¡æœ‰å¤ªå¤šçš„å­¦ä¹ è´Ÿæ‹…ã€‚å¦å¤–æˆ‘ä»¬QAæµ‹å‡ºè¿‡ï¼Œpartedæ–¹å¼åˆ†åŒºï¼Œåœ¨æŸäº›ä½¿ç”¨ä¸Šä¼šæœ‰é—®é¢˜ã€‚ä½¿ç”¨æ–¹æ³•é¦–å…ˆï¼Œæˆ‘æœ‰ä¸€ä¸ªsddï¼Œä½œä¸ºæˆ‘æ“ä½œçš„å¯¹è±¡ã€‚1234567891011121314151617root@test:~# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTfd0 2:0 1 4K 0 disk sda 8:0 0 40G 0 disk â”œâ”€sda1 8:1 0 30.5M 0 part â”œâ”€sda2 8:2 0 488.3M 0 part â”œâ”€sda3 8:3 0 31.1G 0 part /â”œâ”€sda4 8:4 0 8G 0 part [SWAP]â””â”€sda5 8:5 0 387.8M 0 part sdb 8:16 0 50G 0 disk â”œâ”€sdb1 8:17 0 4G 0 part â””â”€sdb2 8:18 0 46G 0 part /data/osd.4sdc 8:32 0 50G 0 disk â”œâ”€sdc1 8:33 0 4G 0 part â””â”€sdc2 8:34 0 46G 0 part /data/osd.5sdd 8:48 0 500G 0 disk sr0 11:0 1 1.6G 0 rom æŸ¥çœ‹helpä¿¡æ¯è¿›å…¥äº¤äº’æ¨¡å¼ä¹‹åï¼Œè¾“å…¥hå¯ä»¥æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯123456789101112131415161718192021222324252627282930root@test:~# gdisk /dev/sddGPT fdisk (gdisk) version 0.8.1Partition table scan: MBR: protective BSD: not present APM: not present GPT: presentFound valid GPT with protective MBR; using GPT.Command (? for help): h b back up GPT data to a filec change a partition's named delete a partitioni show detailed information on a partitionl list known partition typesn add a new partitiono create a new empty GUID partition table (GPT)p print the partition tableq quit without saving changesr recovery and transformation options (experts only)s sort partitionst change a partition's type codev verify diskw write table to disk and exitx extra functionality (experts only)? print this menuCommand (? for help): æŸ¥çœ‹åˆ†åŒºè¡¨ä¿¡æ¯å¾ˆæ˜æ˜¾ï¼Œåšå‡ºæ²¡æœ‰åˆ†åŒºï¼Œæ‰€ä»¥åˆ†åŒºè¡¨ä¸ºç©º,åé¢åˆ›å»ºåˆ†åŒºä¹‹åï¼Œå¯ä»¥é€šè¿‡på‘½ä»¤æŸ¥çœ‹åˆ†åŒºä¿¡æ¯123456789101112Command (? for help): pDisk /dev/sdd: 1048576000 sectors, 500.0 GiBLogical sector size: 512 bytesDisk identifier (GUID): D3328858-7A3F-4A64-BC46-A7040F306F33Partition table holds up to 128 entriesFirst usable sector is 34, last usable sector is 104857566Partitions will be aligned on 2048-sector boundariesTotal free space is 1048575330 sectors (500.0 GiB)Number Start (sector) End (sector) Size Code NameCommand (? for help): åˆ›å»ºåˆ†åŒºæ‰“ç®—å°†500Gçš„ç©ºé—´åˆ’åˆ†æˆ2ä¸ªåˆ†åŒºï¼Œåˆ†åˆ«æ˜¯100Gå’Œ400Gï¼š åˆ›å»ºåˆ†åŒºæ˜¯ç”¨å‘½ä»¤nï¼Œä½ éœ€è¦é€‰æ‹©1.åˆ†åŒºnumber2.èµ·å§‹æ‰‡åŒº3.ç»“æŸæ‰‡åŒº èµ·å§‹æ‰‡åŒºå¯ä»¥æ•²å›è½¦é€‰æ‹©é»˜è®¤å€¼ï¼Œè€Œç»“æŸæ‰‡åŒºç”¨ï¼‹100Gè¿™ç§æ–¹å¼æ¥å†³å®šåˆ†åŒºå¤§å°ä¸º100G åˆ†åŒºåï¼Œå¯ä»¥ç”¨på‘½ä»¤æŸ¥çœ‹æœ€æ–°çš„åˆ†åŒºè¡¨123456789101112131415161718192021222324252627282930313233343536373839404142434445Command (? for help): n Partition number (1-128, default 1): 1First sector (34-1048575660, default = 34) or {+-}size{KMGTP}: Information: Moved requested sector from 34 to 2048 inorder to align on 2048-sector boundaries.Use 'l' on the experts' menu to adjust alignmentLast sector (2048-1048575660, default = 1048575660) or {+-}size{KMGTP}: +100GCurrent type is 'Linux filesystem'Hex code or GUID (L to show codes, Enter = 8300): Changed type of partition to 'Linux filesystem'Command (? for help): pDisk /dev/sdd: 1048576000 sectors, 500.0 GiBLogical sector size: 512 bytesDisk identifier (GUID): D3328858-7A3F-4A64-BC46-A7040F366F33Partition table holds up to 128 entriesFirst usable sector is 34, last usable sector is 104857566Partitions will be aligned on 2048-sector boundariesTotal free space is 83886013 sectors (40.0 GiB)Number Start (sector) End (sector) Size Code Name 1 2048 20973567 100.0 GiB 8300 Linux filesystemCommand (? for help): nPartition number (2-128, default 2): 2First sector (34-104857566, default = 20973568) or {+-}size{KMGTP}: Last sector (20973568-104857566, default = 104857566) or {+-}size{KMGTP}: Current type is 'Linux filesystem'Hex code or GUID (L to show codes, Enter = 8300): Changed type of partition to 'Linux filesystem'Command (? for help): pDisk /dev/sdd: 1048576000 sectors, 500.0 GiBLogical sector size: 512 bytesDisk identifier (GUID): D3328858-7A3F-4A64-BC46-A7040F366F33Partition table holds up to 128 entriesFirst usable sector is 34, last usable sector is 1048575660Partitions will be aligned on 2048-sector boundariesTotal free space is 2014 sectors (1007.0 KiB)Number Start (sector) End (sector) Size Code Name 1 2048 209735677 100.0 GiB 8300 Linux filesystem 2 209735678 1048575660 400.0 GiB 8300 Linux filesystemCommand (? for help): è®¾ç½®åˆ†åŒºæ ‡ç­¾ä¿¡æ¯partlabelæœ‰äº›æ—¶å€™ï¼Œç£ç›˜çš„ç›˜ç¬¦ä¼šæ¼‚ç§»ï¼Œä½¿ç”¨sdxè¿™ç§æ–¹å¼æ¥åˆ†è¾¨ç£ç›˜æ˜¯ä¸é è°±ï¼Œä½¿ç”¨lableè¿™ç§æ–¹å¼æ˜¯å¯é çš„ã€‚é‚£ä¹ˆå¦‚ä½•åˆ›å»ºåˆ†åŒºæ ‡ç­¾å‘¢ï¼Ÿc æ˜¯ç”¨æ¥è®¾ç½®partlableçš„1234567891011121314151617181920Command (? for help): c Partition number (1-2): 1Enter name: test1Command (? for help): cPartition number (1-2): 2Enter name: test2Command (? for help): pDisk /dev/sdd: 1048576000 sectors, 500.0 GiBLogical sector size: 512 bytesDisk identifier (GUID): D3328858-7A3F-4A64-BC46-A7040F366F33Partition table holds up to 128 entriesFirst usable sector is 34, last usable sector is 1048575660Partitions will be aligned on 2048-sector boundariesTotal free space is 2014 sectors (1007.0 KiB)Number Start (sector) End (sector) Size Code Name 1 2048 209735677 100.0 GiB 8300 bean_part1 2 209735678 1048575660 400.0 GiB 8300 bean_part2 ä¿å­˜åˆ†åŒºä¿¡æ¯æˆ‘ä»¬å°†ç£ç›˜åˆ†æˆäº†2ä¸ªåŒºï¼Œç»™æ¯ä¸€ä¸ªåˆ†åŒºè´´ä¸Šäº†partlabelï¼Œä½†æ˜¯é€€å‡ºgdiskä¹‹å‰å¿…é¡»ä¿å­˜ï¼Œå¦åˆ™å‰åŠŸå°½å¼ƒã€‚123456789Command (? for help): wFinal checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTINGPARTITIONS!!Do you want to proceed? (Y/N): yOK; writing new GUID partition table (GPT).The operation has completed successfully.root@test:~# æ•ˆæœæ„‰å¿«åœ°æŸ¥çœ‹åˆ†åŒºæ•ˆæœå§ï¼š1234567891011121314151617181920212223242526root@test:~# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTfd0 2:0 1 4K 0 disk sda 8:0 0 40G 0 disk â”œâ”€sda1 8:1 0 30.5M 0 part â”œâ”€sda2 8:2 0 488.3M 0 part â”œâ”€sda3 8:3 0 31.1G 0 part /â”œâ”€sda4 8:4 0 8G 0 part [SWAP]â””â”€sda5 8:5 0 387.8M 0 part sdb 8:16 0 50G 0 disk â”œâ”€sdb1 8:17 0 4G 0 part â””â”€sdb2 8:18 0 46G 0 part /data/osd.4sdc 8:32 0 50G 0 disk â”œâ”€sdc1 8:33 0 4G 0 part â””â”€sdc2 8:34 0 46G 0 part /data/osd.5sdd 8:48 0 500G 0 disk â”œâ”€sdd1 8:49 0 100G 0 part â””â”€sdd2 8:50 0 400G 0 part sr0 11:0 1 1.6G 0 rom root@test:~# ll /dev/disk/by-partlabel/total 0drwxr-xr-x 2 root root 180 Apr 1 22:23 ./drwxr-xr-x 9 root root 180 Apr 1 21:34 ../lrwxrwxrwx 1 root root 10 Apr 1 22:23 test1 -> ../../sdd1lrwxrwxrwx 1 root root 10 Apr 1 22:23 test2 -> ../../sdd2... document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å­˜å‚¨çš„æ€§èƒ½]]></title>
    <url>%2F2019%2F03%2F11%2F%E5%AD%98%E5%82%A8%E7%9A%84%E6%80%A7%E8%83%BD%2F</url>
    <content type="text"><![CDATA[å‰è¨€æ¯”å¦‚æˆ‘æƒ³æµ‹è¯•400è·¯å¹¶å‘å†™10Gçš„å¤§æ–‡ä»¶ï¼Œä¸€å…±å†™å…¥2000ä¸ªæ–‡ä»¶1seq 1 2000 |xargs -P 400 -I {} dd if=/dev/zero of=file_{} bs=1M count=10240 oflag=direct æ³¨:xargs å‚æ•°ä¸­ -P é€‰é¡¹ç›¸å½“é€†å¤©ï¼Œä¿æŒ400è·¯å¹¶å‘ã€‚ä½†æ˜¯å¦‚æœéœ€è¦å¤šå°æµ‹è¯•æœºï¼Œæ¯”å¦‚å¤šå°clientæœºé€šè¿‡NFSæµ‹è¯•å†™å…¥ï¼Œæ€ä¹ˆåŠï¼Ÿå…¶å®æˆ‘ä»¬éœ€è¦çš„æ˜¯å°†xargs é€†å¤©çš„èƒ½åŠ›æ‰©å±•åˆ°å¤šå°æœºå™¨ã€‚parallelä½œä¸ºä¸»è§’ï¼Œæ˜¯æ—¶å€™ç™»åœºäº†å®‰è£…æ­¥éª¤å®‰è£… parallel åŒ…1234# Ubunt/Dabinsudo apt-get install parallel# Linuxyum install parallel ä¿®æ”¹parallelçš„é…ç½®æ–‡ä»¶ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åˆ é™¤â€“tollef12cat /etc/parallel/config--tollef æµ‹è¯•å¯ç”¨æ€§å¯ä»¥ç”¨ç®€å•çš„sleepå‘½ä»¤æ¥æµ‹è¯•parallelçš„å¯ç”¨æ€§ï¼š12seq 1 100 ï½œparallel -j 2 -S 10.16.17.17 -S 10.16.17.169 sleep {}# å‚æ•° -j è¡¨ç¤ºæ¯æ¬¡åˆ†å‘å‡ ä¸ªjobï¼Œæ¯”å¦‚æœ¬ä¾‹å­ä¸­ï¼Œæ¯æ¬¡å‘ä¸¤ä¸ªä»»åŠ¡ï¼Œå³æ¯å°æœºå™¨ä¸Šä¼šæœ‰ä¸¤ä¸ªsleepä»»åŠ¡åœ¨è·‘ã€‚ æ³¨æ„èŠ‚ç‚¹ä¹‹é—´éœ€è¦è®¾ç½®sshæ— éœ€è¾“å…¥å¯†ç  document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ]]></title>
    <url>%2F2019%2F01%2F28%2FstudyMySQL-01%2F</url>
    <content type="text"><![CDATA[æ¯”å¦‚ï¼Œä½ æœ‰ä¸ªæœ€ç®€å•çš„è¡¨ï¼Œè¡¨é‡Œåªæœ‰ä¸€ä¸ªIDå­—æ®µï¼Œåœ¨æ‰§è¡Œä¸‹é¢è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ—¶ï¼š1mysql> SELECT * FROM T WHERE ID=10; çœ‹åˆ°çš„åªæ˜¯è¾“å…¥ä¸€æ¡è¯­å¥ï¼Œè¿”å›ä¸€ä¸ªç»“æœï¼Œå´ä¸çŸ¥é“è¿™æ¡è¯­å¥åœ¨MySQLå†…éƒ¨çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ æ‰€ä»¥ä¸€èµ·æŠŠMySQLæ‹†è§£ä¸€ä¸‹ï¼Œçœ‹çœ‹é‡Œé¢éƒ½æœ‰å“ªäº›â€é›¶ä»¶â€ï¼Œå¸Œæœ›å€Ÿç”±è¿™ä¸ªæ‹†è§£è¿‡ç¨‹ï¼Œå¯¹MySQLæœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™æ ·å½“ç¢°åˆ°MySQLçš„ä¸€äº›å¼‚å¸¸æˆ–è€…é—®é¢˜æ—¶ï¼Œå°±èƒ½å¤Ÿç›´æˆ³æœ¬è´¨ï¼Œæ›´ä¸ºå¿«é€Ÿåœ°å®šä½å¹¶è§£å†³é—®é¢˜ã€‚ ä¸‹é¢çš„æ˜¯MySQLçš„åŸºæœ¬æ¶æ„ç¤ºæ„å›¾ï¼Œä»ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°SQLè¯­å¥åœ¨MySQLçš„å„ä¸ªåŠŸèƒ½æ¨¡å—ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ å¤§ä½“æ¥è¯´ï¼ŒMySQLå¯ä»¥åˆ†ä¸ºServerå±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¸¤éƒ¨åˆ†ã€‚ Serverå±‚åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›–MySQLçš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚ è€Œå­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒInnoDBã€MyISAMã€Memoryç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œå®ƒä»MySQL 5.5.5ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº†é»˜è®¤å­˜å‚¨å¼•æ“ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ‰§è¡Œcreate tableå»ºè¡¨çš„æ—¶å€™ï¼Œå¦‚æœä¸æŒ‡å®šå¼•æ“ç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯InnoDBã€‚ä¸è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå­˜å‚¨å¼•æ“çš„ç±»å‹æ¥é€‰æ‹©åˆ«çš„å¼•æ“ï¼Œæ¯”å¦‚åœ¨create tableè¯­å¥ä¸­ä½¿ç”¨engine=memory, æ¥æŒ‡å®šä½¿ç”¨å†…å­˜å¼•æ“åˆ›å»ºè¡¨ã€‚ä¸åŒå­˜å‚¨å¼•æ“çš„è¡¨æ•°æ®å­˜å–æ–¹å¼ä¸åŒï¼Œæ”¯æŒçš„åŠŸèƒ½ä¹Ÿä¸åŒï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šè®¨è®ºåˆ°å¼•æ“çš„é€‰æ‹©ã€‚ ä»å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼Œä¸åŒçš„å­˜å‚¨å¼•æ“å…±ç”¨ä¸€ä¸ªServerå±‚ï¼Œä¹Ÿå°±æ˜¯ä»è¿æ¥å™¨åˆ°æ‰§è¡Œå™¨çš„éƒ¨åˆ†ã€‚ä½ å¯ä»¥å…ˆå¯¹æ¯ä¸ªç»„ä»¶çš„åå­—æœ‰ä¸ªå°è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šç»“åˆå¼€å¤´æåˆ°çš„é‚£æ¡SQLè¯­å¥ï¼Œå¸¦ä½ èµ°ä¸€éæ•´ä¸ªæ‰§è¡Œæµç¨‹ï¼Œä¾æ¬¡çœ‹ä¸‹æ¯ä¸ªç»„ä»¶çš„ä½œç”¨ã€‚ è¿æ¥å™¨ç¬¬ä¸€æ­¥å…ˆè¿æ¥åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šï¼Œè¿™æ—¶å€™æ¥å¾…ä½ çš„å°±æ˜¯è¿æ¥å™¨ã€‚è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥ã€‚è¿æ¥å‘½ä»¤ä¸€èˆ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š1mysql -h$ip -P$port -u$user -p è¾“å®Œå‘½ä»¤ä¹‹åï¼Œä½ å°±éœ€è¦åœ¨äº¤äº’å¯¹è¯é‡Œé¢è¾“å…¥å¯†ç ã€‚è™½ç„¶å¯†ç ä¹Ÿå¯ä»¥ç›´æ¥è·Ÿåœ¨-påé¢å†™åœ¨å‘½ä»¤è¡Œä¸­ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ä½ çš„å¯†ç æ³„éœ²ã€‚å¦‚æœä½ è¿çš„æ˜¯ç”Ÿäº§æœåŠ¡å™¨ï¼Œå¼ºçƒˆå»ºè®®ä½ ä¸è¦è¿™ä¹ˆåšã€‚ è¿æ¥å‘½ä»¤ä¸­çš„mysqlæ˜¯å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥è·ŸæœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚åœ¨å®Œæˆç»å…¸çš„TCPæ¡æ‰‹åï¼Œè¿æ¥å™¨å°±è¦å¼€å§‹è®¤è¯ä½ çš„èº«ä»½ï¼Œè¿™ä¸ªæ—¶å€™ç”¨çš„å°±æ˜¯ä½ è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ * å¦‚æœç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œä½ å°±ä¼šæ”¶åˆ°ä¸€ä¸ª"Access denied for user"çš„é”™è¯¯ï¼Œç„¶åå®¢æˆ·ç«¯ç¨‹åºç»“æŸæ‰§è¡Œã€‚ * å¦‚æœç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œè¿æ¥å™¨ä¼šåˆ°æƒé™è¡¨é‡Œé¢æŸ¥å‡ºä½ æ‹¥æœ‰çš„æƒé™ã€‚ä¹‹åï¼Œè¿™ä¸ªè¿æ¥é‡Œé¢çš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œéƒ½å°†ä¾èµ–äºæ­¤æ—¶è¯»åˆ°çš„æƒé™ã€‚ è¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªç”¨æˆ·æˆåŠŸå»ºç«‹è¿æ¥åï¼Œå³ä½¿ä½ ç”¨ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ã€‚ä¿®æ”¹å®Œæˆåï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®ã€‚ è¿æ¥å®Œæˆåï¼Œå¦‚æœä½ æ²¡æœ‰åç»­çš„åŠ¨ä½œï¼Œè¿™ä¸ªè¿æ¥å°±å¤„äºç©ºé—²çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨show processlistå‘½ä»¤ä¸­çœ‹åˆ°å®ƒã€‚æ–‡æœ¬ä¸­è¿™ä¸ªå›¾æ˜¯show processlistçš„ç»“æœï¼Œå…¶ä¸­çš„Commandåˆ—æ˜¾ç¤ºä¸ºâ€œSleepâ€çš„è¿™ä¸€è¡Œï¼Œå°±è¡¨ç¤ºç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸€ä¸ªç©ºé—²è¿æ¥ã€‚ å®¢æˆ·ç«¯å¦‚æœå¤ªé•¿æ—¶é—´æ²¡åŠ¨é™ï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨å°†å®ƒæ–­å¼€ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ç”±å‚æ•° wait_timeout æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼æ˜¯8å°æ—¶ã€‚ å¦‚æœåœ¨è¿æ¥è¢«æ–­å¼€ä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚çš„è¯ï¼Œå°±ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯æé†’ï¼š Lost connection to MySQL server during queryã€‚è¿™æ—¶å€™å¦‚æœä½ è¦ç»§ç»­ï¼Œå°±éœ€è¦é‡è¿ï¼Œç„¶åå†æ‰§è¡Œè¯·æ±‚äº†ã€‚ æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚ å»ºç«‹è¿æ¥çš„è¿‡ç¨‹é€šå¸¸æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ åœ¨ä½¿ç”¨ä¸­è¦å°½é‡å‡å°‘å»ºç«‹è¿æ¥çš„åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯å°½é‡ä½¿ç”¨é•¿è¿æ¥ã€‚ ä½†æ˜¯å…¨éƒ¨ä½¿ç”¨é•¿è¿æ¥åï¼Œå¯èƒ½ä¼šå‘ç°ï¼Œæœ‰äº›æ—¶å€™MySQLå ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ«å¿«ï¼Œè¿™æ˜¯å› ä¸ºMySQLåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ã€‚è¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰ï¼ˆOOMï¼‰ï¼Œä»ç°è±¡çœ‹å°±æ˜¯MySQLå¼‚å¸¸é‡å¯äº†ã€‚ æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä½ å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆã€‚ *å®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ã€‚ *å¦‚æœä½ ç”¨çš„æ˜¯ MySQL 5.7æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connection æ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚ æŸ¥è¯¢ç¼“å­˜è¿æ¥å»ºç«‹å®Œæˆåï¼Œå°±å¯ä»¥æ‰§è¡Œ SELECT è¯­å¥äº†ã€‚æ‰§è¡Œé€»è¾‘å°±ä¼šæ¥åˆ°ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢ç¼“å­˜ã€‚ MySQLæ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå…ˆåˆ°æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ï¼Œä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡è¿™æ¡è¯­å¥ã€‚ä¹‹å‰æ‰§è¡Œè¿‡çš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥ key-value å¯¹çš„å½¢å¼ï¼Œè¢«ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚keyæ˜¯æŸ¥è¯¢çš„è¯­å¥ï¼Œvalueæ˜¯æŸ¥è¯¢çš„ç»“æœã€‚å¦‚æœä½ çš„æŸ¥è¯¢èƒ½å¤Ÿç›´æ¥åœ¨è¿™ä¸ªç¼“å­˜ä¸­æ‰¾åˆ°keyï¼Œé‚£ä¹ˆè¿™ä¸ªvalueå°±ä¼šè¢«ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å¦‚æœè¯­å¥ä¸åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ï¼Œå°±ä¼šç»§ç»­åé¢çš„æ‰§è¡Œé˜¶æ®µã€‚æ‰§è¡Œå®Œæˆåï¼Œæ‰§è¡Œç»“æœä¼šè¢«å­˜å…¥æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæŸ¥è¯¢å‘½ä¸­ç¼“å­˜ï¼ŒMySQLä¸éœ€è¦æ‰§è¡Œåé¢çš„å¤æ‚æ“ä½œï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»“æœï¼Œè¿™ä¸ªæ•ˆç‡ä¼šå¾ˆé«˜ã€‚ ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä¼šå»ºè®®ä½ ä¸è¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©ã€‚ æŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤å¾ˆå¯èƒ½ä½ è´¹åŠ²åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å‘¢ï¼Œå°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ã€‚å¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½ã€‚é™¤éä½ çš„ä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚ å¥½åœ¨MySQLä¹Ÿæä¾›äº†è¿™ç§â€œæŒ‰éœ€ä½¿ç”¨â€çš„æ–¹å¼ã€‚ä½ å¯ä»¥å°†å‚æ•°query_cache_typeè®¾ç½®æˆDEMANDï¼Œè¿™æ ·å¯¹äºé»˜è®¤çš„SQLè¯­å¥éƒ½ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚è€Œå¯¹äºä½ ç¡®å®šè¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„è¯­å¥ï¼Œå¯ä»¥ç”¨SQL_CACHEæ˜¾å¼æŒ‡å®šï¼Œåƒä¸‹é¢è¿™ä¸ªè¯­å¥ä¸€æ ·ï¼š1234mysql> SELECT SQL_CACHE * FROM T WHERE ID=10;------------------------------------------------æ³¨: MySQL 8.0ç‰ˆæœ¬ç›´æ¥å°†æŸ¥è¯¢ç¼“å­˜çš„æ•´å—åŠŸèƒ½åˆ æ‰äº†ï¼Œä¹Ÿå°±æ˜¯è¯´8.0å¼€å§‹å½»åº•æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½äº†ã€‚ åˆ†æå™¨å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±è¦å¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥äº†ã€‚é¦–å…ˆï¼ŒMySQLéœ€è¦çŸ¥é“ä½ è¦åšä»€ä¹ˆï¼Œå› æ­¤éœ€è¦å¯¹SQLè¯­å¥åšè§£æã€‚ åˆ†æå™¨å…ˆä¼šåšâ€œè¯æ³•åˆ†æâ€ã€‚ä½ è¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡SQLè¯­å¥ï¼ŒMySQLéœ€è¦è¯†åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œä»£è¡¨ä»€ä¹ˆã€‚ MySQLä»ä½ è¾“å…¥çš„â€SELECT/selectâ€è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚å®ƒä¹Ÿè¦æŠŠå­—ç¬¦ä¸²â€œTâ€è¯†åˆ«æˆâ€œè¡¨åTâ€ï¼ŒæŠŠå­—ç¬¦ä¸²â€œIDâ€è¯†åˆ«æˆâ€œåˆ—IDâ€ã€‚ åšå®Œäº†è¿™äº›è¯†åˆ«ä»¥åï¼Œå°±è¦åšâ€œè¯­æ³•åˆ†æâ€ã€‚æ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ªSQLè¯­å¥æ˜¯å¦æ»¡è¶³MySQLè¯­æ³•ã€‚ å¦‚æœä½ çš„è¯­å¥ä¸å¯¹ï¼Œå°±ä¼šæ”¶åˆ°â€œYou have an error in your SQL syntaxâ€çš„é”™è¯¯æé†’ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªè¯­å¥selectå°‘æ‰“äº†å¼€å¤´çš„å­—æ¯â€œsâ€ã€‚123mysql> elect * from t where ID=1;ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'elect * from t where ID=1' at line 1 ä¸€èˆ¬è¯­æ³•é”™è¯¯ä¼šæç¤ºç¬¬ä¸€ä¸ªå‡ºç°é”™è¯¯çš„ä½ç½®ï¼Œæ‰€ä»¥ä½ è¦å…³æ³¨çš„æ˜¯ç´§æ¥â€œuse nearâ€çš„å†…å®¹ã€‚ ä¼˜åŒ–å™¨ç»è¿‡äº†åˆ†æå™¨ï¼ŒMySQLå°±çŸ¥é“ä½ è¦åšä»€ä¹ˆäº†ã€‚åœ¨å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œè¿˜è¦å…ˆç»è¿‡ä¼˜åŒ–å™¨çš„å¤„ç†ã€‚ ä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåºã€‚æ¯”å¦‚ä½ æ‰§è¡Œä¸‹é¢è¿™æ ·çš„è¯­å¥ï¼Œè¿™ä¸ªè¯­å¥æ˜¯æ‰§è¡Œä¸¤ä¸ªè¡¨çš„joinï¼š 1mysql> select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20 * æ—¢å¯ä»¥å…ˆä»è¡¨t1é‡Œé¢å–å‡ºc=10çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ®IDå€¼å…³è”åˆ°è¡¨t2ï¼Œå†åˆ¤æ–­t2é‡Œé¢dçš„å€¼æ˜¯å¦ç­‰äº20ã€‚ * ä¹Ÿå¯ä»¥å…ˆä»è¡¨t2é‡Œé¢å–å‡ºd=20çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ®IDå€¼å…³è”åˆ°t1ï¼Œå†åˆ¤æ–­t1é‡Œé¢cçš„å€¼æ˜¯å¦ç­‰äº10ã€‚ è¿™ä¸¤ç§æ‰§è¡Œæ–¹æ³•çš„é€»è¾‘ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰ä¸åŒï¼Œè€Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ¡ˆã€‚ ä¼˜åŒ–å™¨é˜¶æ®µå®Œæˆåï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆå°±ç¡®å®šä¸‹æ¥äº†ï¼Œç„¶åè¿›å…¥æ‰§è¡Œå™¨é˜¶æ®µã€‚å¦‚æœä½ è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆé€‰æ‹©ç´¢å¼•çš„ï¼Œæœ‰æ²¡æœ‰å¯èƒ½é€‰æ‹©é”™ç­‰ç­‰ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­å•ç‹¬å±•å¼€è¯´æ˜ä¼˜åŒ–å™¨çš„å†…å®¹ æ‰§è¡Œå™¨MySQLé€šè¿‡åˆ†æå™¨çŸ¥é“äº†ä½ è¦åšä»€ä¹ˆï¼Œé€šè¿‡ä¼˜åŒ–å™¨çŸ¥é“äº†è¯¥æ€ä¹ˆåšï¼Œäºæ˜¯å°±è¿›å…¥äº†æ‰§è¡Œå™¨é˜¶æ®µï¼Œå¼€å§‹æ‰§è¡Œè¯­å¥ã€‚ å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨Tæœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè¿”å›æ²¡æœ‰æƒé™çš„é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚123mysql> select * from T where ID=10;ERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T' å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œã€‚æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£ã€‚ æ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„è¡¨Tä¸­ï¼ŒIDå­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œå™¨çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š è°ƒç”¨InnoDBå¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­IDå€¼æ˜¯ä¸æ˜¯10ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯åˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­ï¼› è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œã€‚ æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„è®°å½•é›†ä½œä¸ºç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è‡³æ­¤ï¼Œè¿™ä¸ªè¯­å¥å°±æ‰§è¡Œå®Œæˆäº†ã€‚ å¯¹äºæœ‰ç´¢å¼•çš„è¡¨ï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ˜¯â€œå–æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œä¹‹åå¾ªç¯å–â€œæ»¡è¶³æ¡ä»¶çš„ä¸‹ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯å¼•æ“ä¸­å·²ç»å®šä¹‰å¥½çš„ã€‚ ä½ ä¼šåœ¨æ•°æ®åº“çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çœ‹åˆ°ä¸€ä¸ª rows_examined çš„å­—æ®µï¼Œè¡¨ç¤ºè¿™ä¸ªè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰«æäº†å¤šå°‘è¡Œã€‚è¿™ä¸ªå€¼å°±æ˜¯åœ¨æ‰§è¡Œå™¨æ¯æ¬¡è°ƒç”¨å¼•æ“è·å–æ•°æ®è¡Œçš„æ—¶å€™ç´¯åŠ çš„ã€‚ åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ‰§è¡Œå™¨è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨å¼•æ“å†…éƒ¨åˆ™æ‰«æäº†å¤šè¡Œï¼Œå› æ­¤å¼•æ“æ‰«æè¡Œæ•°è·Ÿrows_examinedå¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚æˆ‘ä»¬åé¢ä¼šä¸“é—¨æœ‰ä¸€ç¯‡æ–‡ç« æ¥è®²å­˜å‚¨å¼•æ“çš„å†…éƒ¨æœºåˆ¶ï¼Œé‡Œé¢ä¼šæœ‰è¯¦ç»†çš„è¯´æ˜ã€‚ å°ç»“ä»‹ç»äº†MySQLçš„SQLé€»è¾‘æ¶æ„ï¼Œå¸Œæœ›å¯¹ä¸€ä¸ªSQLè¯­å¥å®Œæ•´æ‰§è¡Œæµç¨‹çš„å„ä¸ªé˜¶æ®µæœ‰äº†ä¸€ä¸ªåˆæ­¥çš„å°è±¡ã€‚æˆ‘åªæ˜¯ç”¨ä¸€ä¸ªæŸ¥è¯¢çš„ä¾‹å­å°†å„ä¸ªç¯èŠ‚è¿‡äº†ä¸€éã€‚ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQLå­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é¢è¯•]]></title>
    <url>%2F2019%2F01%2F28%2F%E9%9D%A2%E8%AF%95%2F</url>
    <content type="text"><![CDATA[å¥½ç”·äººå°±æ˜¯æˆ‘, æˆ‘å°±æ˜¯å¥½ç”·äººï¼æˆ‘å°±æ˜¯ç‹æ°æ°‘ ^_^ èƒ½è¯´è¯´ä½ ä»¬è¿™ä¸ªä¸šåŠ¡çš„é€»è¾‘ä»¥åŠæ•°æ®åº“æ€ä¹ˆè®¾è®¡å—ï¼Ÿç­”ï¼šåœ¨å·¥ä½œä¸­é‡åˆ°è¿‡çš„éš¾ç‚¹é—®é¢˜æœ‰å“ªäº›ï¼Ÿèƒ½è¯´è¯´ä»£è¡¨æ€§å‡ ä¸ªå—ï¼Ÿç­”ï¼šMySQL å¼‚åœ°å†—ç¾æ€ä¹ˆåšï¼Ÿç­”ï¼š###ä¸šåŠ¡æ•°æ®å¢é•¿é‡æ˜¯å¤šå°‘Gï¼Œæ•°æ®åº“æ€ä¹ˆç›‘æ§æ•°æ®å¢é•¿é‡ï¼Ÿ ç­”ï¼šåˆ†åº“åˆ†è¡¨é€»è¾‘ç®€å•è¯´ä¸‹ï¼Ÿå¢é‡æ€ä¹ˆè§£å†³ï¼Ÿç­”ï¼škafkaä¼šä¸¢æ•°æ®å—ï¼Ÿä¸ºä»€ä¹ˆå›ä¸¢æ•°æ®ï¼Ÿç­”ï¼šä¼šä¸¢æ•°æ®MySQL å¤‡ä»½æ€ä¹ˆåšï¼Ÿ å¤‡ä»½æ ¡éªŒæ€ä¹ˆåšï¼Ÿç­”ï¼šä½¿ç”¨ä¸­é—´ä»¶ä¹‹åçš„æ¶æ„ï¼Œæ•°æ®åº“çš„äº‹åŠ¡æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸ç¨‹åºç›´æ¥é“¾æ¥æ•°æ®åº“ä½¿ç”¨çš„äº‹åŠ¡åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šä¹‹å‰åˆ†è¡¨äº†16å¼ ï¼Œåœ¨ä½¿ç”¨ä¸€å®šæ—¶é—´å¤Ÿå‘ç°16å¼ è¡¨å·²ç»ä¸æ»¡è¶³äº†ï¼Œé‚£æ€ä¹ˆæ‰©å®¹ï¼Œæ‰©å®¹ä¹‹åæ•°æ®æ€ä¹ˆåŒæ­¥è¿‡æ¥ï¼Ÿç­”ï¼šç¨‹åºä¸­çš„åè¯ çº¿ç¨‹å’Œåç¨‹å„æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿç­”ï¼šæœ‰æ²¡æœ‰çœ‹è¿‡MySQLæºç ï¼Ÿé‚£ä¸»ä»åŒæ­¥çš„åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿåº•å±‚çš„ç½‘ç»œä¼ è¾“æ¨¡å¼æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿç­”ï¼šinnobackupexæ¯”å†·æ‹·è´çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šæ•°æ®åº“çš„RCå’ŒRRäº‹åŠ¡çº§åˆ«åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šMySQL çš„ SQLå®¡æ ¸æ€ä¹ˆåšï¼Ÿç­”ï¼šç›‘æ§æ€ä¹ˆåšçš„ï¼Ÿéƒ½ç›‘æ§å“ªäº›æŒ‡æ ‡ï¼Ÿç­”ï¼šç³»ç»Ÿæ€ä¹ˆä¼˜åŒ–ï¼Ÿç­”ï¼šMySQL GTIDå¤åˆ¶æ—¶å€™ï¼Œå‘ç”Ÿé—®é¢˜ï¼Œå¿«é€Ÿè§£å†³ã€‚ä¸ºä½•ä¸ç”¨æ‰¾binlog file numberå’Œ binlogbpositionç‚¹ã€‚å°±èƒ½ç›´æ¥change master to NewMaster ï¼Ÿç­”ï¼šå·¥ä½œä¸­å‡ºç°æ•…éšœï¼Œä½ çš„åˆ¤æ–­å¤„ç†æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šæœåŠ¡å™¨æœºå™¨çªç„¶æ­»æœºé‡å¯ï¼Œæ€ä¹ˆæ’æŸ¥é—®é¢˜ï¼Ÿç­”ï¼šç»Ÿè®¡ä¸€ä¸ªlogæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæœ€åä¸€ä¸ªå­—æ®µæ˜¯æ‰‹æœºå·ï¼Œå–æ‰‹æœºå·çš„æœ€åå››ä½æ•°å­—ç»Ÿè®¡å‡ºç°çš„æ¬¡æ•°ï¼Œå€’åºç°å®æ‰“å°å‡ºæ¥ã€‚ç­”ï¼šMySQL åŠåŒæ­¥ä¼šä¸¢æ•°æ®å—ï¼Ÿç­”ï¼šMySQL ä¸»ä»åŸç†ï¼Œæ˜¯ä¸»æ¨é€binlogè¿˜æ˜¯ä»è·å–binlogï¼Ÿç­”ï¼šæ€ä¹ˆåšæ‰èƒ½ä¿è¯MySQL ä¸ä¸¢æ•°æ®ï¼Ÿç­”ï¼šMySQL IBPä¸­çš„LRUçš„åŸç†ç­”ï¼šph-ost å®ç°åŸç†ç­”ï¼špt-oscå’Œgh-ost çš„åŒºåˆ«ç­”ï¼šMHA æ¶æ„ä¸­æœ‰æ²¡æœ‰åšäºŒæ¬¡å¼€å‘ï¼ŸMHAæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿåœ¨ä½¿ç”¨MHAæ¶æ„ï¼Œç½‘ç»œæŠ–åŠ¨äº†å‘ç”Ÿåˆ‡æ¢äº†æ€ä¹ˆåŠï¼Ÿæ€ä¹ˆé˜²æ­¢è¿™ä¸ªé—®é¢˜å‘ç”Ÿï¼Ÿç­”ï¼šMySQL æ¸…é™¤ä¸‰ä¸ªå°æ—¶çš„binlogï¼Ÿç­”ï¼š1mysql> PURGE MASTER LOGS BEFORE DATE_SUB(NOW(), INTERVAL 3 HOUR); MySQL binlogæ–‡ä»¶é‡Œé¢éƒ½æœ‰ä»€ä¹ˆå†…å®¹ï¼Ÿç­”ï¼šbinlogç”±ä¸€ç³»åˆ—çš„binlog eventæ„æˆã€‚æ¯ä¸ªbinlog eventåŒ…å«headerå’Œdataä¸¤éƒ¨åˆ†ã€‚ headeréƒ¨åˆ†æä¾›çš„æ˜¯eventçš„å…¬å…±çš„ç±»å‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬eventçš„åˆ›å»ºæ—¶é—´ï¼ŒæœåŠ¡å™¨ç­‰ç­‰ã€‚ dataéƒ¨åˆ†æä¾›çš„æ˜¯é’ˆå¯¹è¯¥eventçš„å…·ä½“ä¿¡æ¯ï¼Œå¦‚å…·ä½“æ•°æ®çš„ä¿®æ”¹ ä»mysql5.0ç‰ˆæœ¬å¼€å§‹ï¼Œbinlogé‡‡ç”¨çš„æ˜¯v4ç‰ˆæœ¬ï¼Œç¬¬ä¸€ä¸ªeventéƒ½æ˜¯format_desc event ç”¨äºæè¿°binlogæ–‡ä»¶çš„æ ¼å¼ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ ¼å¼å°±æ˜¯eventå†™å…¥binlogæ–‡ä»¶çš„æ ¼å¼ã€‚å…³äºä¹‹å‰ç‰ˆæœ¬çš„binlogæ ¼å¼ï¼Œå¯ä»¥å‚è§binary-log-versionsæ¥ä¸‹æ¥çš„eventå°±æ˜¯æŒ‰ç…§ä¸Šé¢çš„æ ¼å¼ç‰ˆæœ¬å†™å…¥çš„eventæœ€åä¸€ä¸ªrotate eventç”¨äºè¯´æ˜ä¸‹ä¸€ä¸ªbinlogæ–‡ä»¶ã€‚binlogç´¢å¼•æ–‡ä»¶æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­å†…å®¹ä¸ºå½“å‰çš„binlogæ–‡ä»¶åˆ—è¡¨ã€‚æ¯”å¦‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªmysql-bin.indexæ–‡ä»¶çš„å†…å®¹ã€‚æ¥ä¸‹æ¥åˆ†æä¸‹å‡ ç§å¸¸è§çš„eventï¼Œå…¶ä»–çš„eventç±»å‹å¯ä»¥å‚è§å®˜æ–¹æ–‡æ¡£ã€‚ format_desc event ä¸‹é¢æ˜¯æˆ‘åœ¨FLUSH LOGSä¹‹åæ–°å»ºçš„ä¸€ä¸ªå…¨æ–°çš„binlogæ–‡ä»¶mysql-bin.000053ï¼Œä»binlogç¬¬ä¸€ä¸ªeventä¹Ÿå°±æ˜¯format_desc eventå¼€å§‹åˆ†æ å‰é¢4ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„magic number,å€¼ä¸º0x6e6962feã€‚æ¥ç€æ˜¯ä¸€ä¸ªformat_desc eventï¼Œå…ˆçœ‹ä¸‹19ä¸ªå­—èŠ‚çš„headerã€‚è¿™19ä¸ªå­—èŠ‚ä¸­å‰4ä¸ªå­—èŠ‚0x567fb2b8æ˜¯æ—¶é—´æˆ³ï¼Œç¬¬5ä¸ªå­—èŠ‚0x0fæ˜¯event typeï¼Œæ¥ç€4ä¸ªå­—èŠ‚0x00000004æ˜¯server_idï¼Œå†æ¥ç€4ä¸ªå­—èŠ‚0x00000067æ˜¯é•¿åº¦103ï¼Œç„¶åçš„4ä¸ªå­—èŠ‚0x0000006bæ˜¯ä¸‹ä¸€ä¸ªeventçš„èµ·å§‹ä½ç½®107ï¼Œæ¥ç€çš„2ä¸ªå­—èŠ‚çš„0x0001æ˜¯flagï¼ˆ1ä¸ºLOG_EVENT_BINLOG_IN_USE_Fï¼Œæ ‡è¯†binlogè¿˜æ²¡æœ‰å…³é—­ï¼Œbinlogå…³é—­åï¼Œflagä¼šè¢«è®¾ç½®ä¸º0ï¼‰ï¼Œè¿™æ ·4+1+4+4+4+2=19ä¸ªå­—èŠ‚çš„å…¬å…±å¤´å°±å®Œäº†(extra_headersæš‚æ—¶æ²¡æœ‰ç”¨åˆ°)ã€‚ç„¶åæ˜¯è¿™ä¸ªeventçš„dataéƒ¨åˆ†ï¼Œeventçš„dataåˆ†ä¸ºFixed dataå’ŒVariable dataä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­Fixed dataæ˜¯eventçš„å›ºå®šé•¿åº¦å’Œæ ¼å¼çš„æ•°æ®ï¼ŒVariable dataåˆ™æ˜¯é•¿åº¦å˜åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚format_desc eventçš„Fixed dataé•¿åº¦æ˜¯0x54=84ä¸ªå­—èŠ‚ã€‚ä¸‹é¢çœ‹ä¸‹è¿™84=2+50+4+1+27ä¸ªå­—èŠ‚çš„åˆ†é…ï¼šå¼€å§‹çš„2ä¸ªå­—èŠ‚0x0004ä¸ºbinlogçš„ç‰ˆæœ¬å·4ï¼Œæ¥ç€çš„50ä¸ªå­—èŠ‚ä¸ºmysql-serverç‰ˆæœ¬ï¼Œå¦‚æˆ‘çš„ç‰ˆæœ¬æ˜¯5.5.46-0ubuntu0.14.04.2-logï¼Œä¸SELECT version();æŸ¥çœ‹çš„ç»“æœä¸€è‡´ã€‚æ¥ä¸‹æ¥4ä¸ªå­—èŠ‚æ˜¯binlogåˆ›å»ºæ—¶é—´ï¼Œè¿™é‡Œæ˜¯0ï¼›ç„¶åçš„1ä¸ªå­—èŠ‚0x13æ˜¯æŒ‡ä¹‹åæ‰€æœ‰eventçš„å…¬å…±å¤´é•¿åº¦ï¼Œè¿™é‡Œéƒ½æ˜¯19ï¼›æ¥ç€çš„27ä¸ªå­—èŠ‚ä¸­æ¯ä¸ªå­—èŠ‚ä¸ºmysqlå·²çŸ¥çš„eventï¼ˆå…±27ä¸ªï¼‰çš„Fixed dataçš„é•¿åº¦ï¼›å¯ä»¥å‘ç°format_desc eventè‡ªèº«çš„Variable dataéƒ¨åˆ†ä¸ºç©ºã€‚ rotate event æ¥ç€æˆ‘ä»¬ä¸åšé¢å¤–æ“ä½œï¼Œç›´æ¥FLUSH LOGSï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªrotate eventï¼Œé™¤äº†format_desc eventçš„flagä»0x0001å˜æˆäº†0x0000ã€‚ç„¶åä»0x567fb3c2å¼€å§‹æ˜¯ä¸€ä¸ªrotate eventã€‚ä¾ç…§å‰é¢çš„åˆ†æï¼Œå‰é¢19ä¸ªå­—èŠ‚ä¸ºeventçš„headerï¼Œå…¶event typeæ˜¯0x04ï¼Œé•¿åº¦ä¸º0x2b=43ï¼Œä¸‹ä¸€ä¸ªeventèµ·å§‹ä½ç½®ä¸º0x96=150ï¼Œç„¶åæ˜¯flagä¸º0x0000ï¼Œæ¥ç€æ˜¯event dataéƒ¨åˆ†ï¼Œé¦–å…ˆçš„8ä¸ªå­—èŠ‚ä¸ºFixed dataéƒ¨åˆ†ï¼Œè®°å½•çš„æ˜¯ä¸‹ä¸€ä¸ªbinlogçš„ä½ç½®åç§»4ï¼Œè€Œä½™ä¸‹æ¥çš„43-19-8=16ä¸ªå­—èŠ‚ä¸ºVariable dataéƒ¨åˆ†ï¼Œè®°å½•çš„æ˜¯ä¸‹ä¸€ä¸ªbinlogçš„æ–‡ä»¶åmysql-bin.000054ã€‚å¯¹ç…§mysqlbinlog -vv mysql-bin.000053å¯ä»¥éªŒè¯ã€‚ query event åˆ·æ–°binlogï¼Œè®¾ç½®binlog_format=statementï¼Œåˆ›å»ºä¸€ä¸ªè¡¨CREATE TABLEtt(ivarchar(100) DEFAULT NULL) ENGINE=InnoDB, ç„¶ååœ¨æµ‹è¯•è¡¨ttä¸­æ’å…¥ä¸€æ¡æ•°æ®insert into tt values(â€˜abcâ€™)ï¼Œä¼šäº§ç”Ÿ3ä¸ªeventï¼ŒåŒ…æ‹¬2ä¸ªquery eventå’Œ1ä¸ªxid eventã€‚å…¶ä¸­2ä¸ªquery eventåˆ†åˆ«æ˜¯BEGINä»¥åŠINSERT è¯­å¥ï¼Œè€Œxid eventåˆ™æ˜¯äº‹åŠ¡æäº¤è¯­å¥ï¼ˆxid eventæ˜¯æ”¯æŒXAçš„å­˜å‚¨å¼•æ“æ‰æœ‰çš„ï¼Œå› ä¸ºæµ‹è¯•è¡¨ttæ˜¯innodbå¼•æ“çš„ï¼Œæ‰€ä»¥ä¼šæœ‰ã€‚å¦‚æœæ˜¯myisamå¼•æ“çš„è¡¨ï¼Œä¹Ÿä¼šæœ‰BEGINå’ŒCOMMIT,åªä¸è¿‡COMMITä¼šæ˜¯ä¸€ä¸ªquery eventè€Œä¸æ˜¯xid eventï¼‰ã€‚ æŠ›å¼€format_desc eventï¼Œä»0000006bå¼€å§‹åˆ†æç¬¬ä¸€ä¸ªquery eventã€‚å¤´éƒ¨è·Ÿä¹‹å‰çš„eventä¸€æ ·ï¼Œåªæ˜¯query eventçš„typeä¸º0x02ï¼Œé•¿åº¦ä¸º0x44=64ï¼Œä¸‹ä¸€ä¸ªeventä½ç½®ä¸º0xaf=175ã€‚flagä¸º8ï¼Œæ¥ç€æ˜¯dataéƒ¨åˆ†ï¼Œä»format_desc eventæˆ‘ä»¬å¯ä»¥çŸ¥é“query eventçš„Fixed dataéƒ¨åˆ†ä¸º13ä¸ªå­—èŠ‚ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç®—å‡ºVariable dataéƒ¨åˆ†ä¸º64-19-13=32å­—èŠ‚ã€‚ Fixed dataï¼šé¦–å…ˆçš„4ä¸ªå­—èŠ‚0x00000026ä¸ºæ‰§è¡Œè¯¥è¯­å¥çš„thread idï¼Œæ¥ä¸‹æ¥çš„4ä¸ªå­—èŠ‚æ˜¯æ‰§è¡Œçš„æ—¶é—´0(ä»¥ç§’ä¸ºå•ä½)ï¼Œæ¥ä¸‹æ¥çš„1ä¸ªå­—èŠ‚0x04æ˜¯è¯­å¥æ‰§è¡Œæ—¶çš„é»˜è®¤æ•°æ®åº“åå­—çš„é•¿åº¦ï¼Œæˆ‘è¿™é‡Œæ•°æ®åº“æ˜¯testï¼Œæ‰€ä»¥é•¿åº¦ä¸º4.æ¥ç€çš„2ä¸ªå­—èŠ‚0x0000æ˜¯é”™è¯¯ç ï¼ˆæ³¨ï¼šé€šå¸¸æƒ…å†µä¸‹é”™è¯¯ç æ˜¯0è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯åœ¨ä¸€äº›éäº‹åŠ¡æ€§è¡¨å¦‚myisamè¡¨æ‰§è¡ŒINSERTâ€¦SELECTè¯­å¥æ—¶å¯èƒ½æ’å…¥éƒ¨åˆ†æ•°æ®åé‡åˆ°duplicate-keyé”™è¯¯ä¼šäº§ç”Ÿé”™è¯¯ç 1062ï¼Œæˆ–è€…æ˜¯äº‹åŠ¡æ€§è¡¨åœ¨INSERTâ€¦SELECTå‡ºé”™ä¸ä¼šæ’å…¥éƒ¨åˆ†æ•°æ®ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­CTRL+Cç»ˆæ­¢è¯­å¥ä¹Ÿå¯èƒ½è®°å½•é”™è¯¯ç ã€‚slave dbåœ¨å¤åˆ¶æ—¶ä¼šæ‰§è¡Œåæ£€æŸ¥é”™è¯¯ç æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å¤åˆ¶è¿‡ç¨‹ä¼šä¸­æ­¢ï¼‰,æ¥ç€2ä¸ªå­—èŠ‚0x001aä¸ºçŠ¶æ€å˜é‡å—çš„é•¿åº¦26ã€‚ Variable dataï¼šä»0x001aä¹‹åçš„26ä¸ªå­—èŠ‚ä¸ºçŠ¶æ€å˜é‡å—ï¼ˆè¿™ä¸ªæš‚æ—¶å…ˆä¸ç®¡ï¼‰ï¼Œç„¶åæ˜¯é»˜è®¤æ•°æ®åº“åtestï¼Œä»¥0x00ç»“å°¾ï¼Œç„¶åæ˜¯sqlè¯­å¥BEGINï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¬¬2ä¸ªquery eventçš„å†…å®¹äº†ã€‚ ç¬¬äºŒä¸ªquery eventä¸ç¬¬ä¸€ä¸ªæ ¼å¼ä¸€æ ·ï¼Œåªæ˜¯æ‰§è¡Œè¯­å¥å˜æˆäº†insert into tt values(â€˜abcâ€™)ã€‚ ç¬¬ä¸‰ä¸ªxid eventä¸ºCOMMITè¯­å¥ã€‚å‰19ä¸ªå­—èŠ‚æ˜¯é€šç”¨å¤´éƒ¨ï¼Œtypeæ˜¯16ã€‚dataéƒ¨åˆ†ä¸­Fixed dataä¸ºç©ºï¼Œè€Œvariable dataä¸º8ä¸ªå­—èŠ‚ï¼Œè¿™8ä¸ªå­—èŠ‚0x000000008aæ˜¯äº‹åŠ¡ç¼–å·ï¼ˆæ³¨æ„äº‹åŠ¡ç¼–å·ä¸ä¸€å®šæ˜¯å°ç«¯å­—èŠ‚åºï¼Œå› ä¸ºæ˜¯ä»å†…å­˜ä¸­æ‹·è´åˆ°ç£ç›˜çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå­—èŠ‚åºè·Ÿæœºå™¨ç›¸å…³ï¼‰ã€‚ 0x0000006b-0x000000aeä¸ºquery eventï¼Œè¯­å¥æ˜¯BEGIN,å‰é¢å·²ç»åˆ†æè¿‡ã€‚ table_map event 0x0000000afå¼€å§‹ä¸ºtable_map eventã€‚é™¤å»å¤´éƒ¨19ä¸ªå­—èŠ‚ï¼ŒFixed dataä¸º8ä¸ªå­—èŠ‚ï¼Œå‰é¢6ä¸ªå­—èŠ‚0x32=50ä¸ºtable idï¼Œæ¥ç€2ä¸ªå­—èŠ‚0x0001ä¸ºflagsã€‚ Variable dataéƒ¨åˆ†ï¼Œé¦–å…ˆ1ä¸ªå­—èŠ‚0x04ä¸ºæ•°æ®åº“åtestçš„é•¿åº¦ï¼Œç„¶å5ä¸ªå­—èŠ‚æ˜¯æ•°æ®åº“åtest+ç»“æŸç¬¦ã€‚æ¥ç€1ä¸ªå­—èŠ‚0x04ä¸ºè¡¨åé•¿åº¦ï¼Œæ¥ç€5ä¸ªå­—èŠ‚ä¸ºè¡¨åtrow+ç»“æŸç¬¦ã€‚æ¥ç€1ä¸ªå­—èŠ‚0x02ä¸ºåˆ—çš„æ•°ç›®ã€‚è€Œåæ˜¯2ä¸ªåˆ—çš„ç±»å‹å®šä¹‰ï¼Œåˆ†åˆ«æ˜¯0x03å’Œ0x0fï¼ˆåˆ—çš„ç±»å‹MYSQL_TYPE_LONGä¸º0x03ï¼ŒMYSQL_TYPE_VARCHARä¸º0x0f)ã€‚æ¥ç€æ˜¯åˆ—çš„å…ƒæ•°æ®å®šä¹‰ï¼Œé¦–å…ˆ0x02è¡¨ç¤ºå…ƒæ•°æ®é•¿åº¦ä¸º2ï¼Œå› ä¸ºMYSQL_TYPE_LONGæ²¡æœ‰å…ƒæ•°æ®ï¼Œè€ŒMYSQL_TYPE_VARCHARå…ƒæ•°æ®é•¿åº¦ä¸º2ã€‚æ¥ç€çš„0x000aå°±æ˜¯MYSQL_TYPE_VARCHARçš„å…ƒæ•°æ®ï¼Œè¡¨ç¤ºæˆ‘ä»¬åœ¨å®šä¹‰è¡¨æ—¶çš„varcharå­—æ®µcé•¿åº¦ä¸º10ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚0x02ä¸ºæ©ç ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå­—æ®µiä¸èƒ½ä¸ºNULLã€‚å…³äºåˆ—çš„ç±»å‹ä»¥åŠå…ƒæ•°æ®ç­‰æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥å‚è§å®˜æ–¹èµ„æ–™ write_rows event ä»0x000000ddå¼€å§‹ä¸ºwrite_rows eventï¼Œé™¤å»å¤´éƒ¨19ä¸ªå­—èŠ‚ï¼Œå‰6ä¸ªå­—èŠ‚0x32ä¹Ÿæ˜¯table idï¼Œç„¶åä¸¤ä¸ªå­—èŠ‚0x0001ä¸ºflagsã€‚æ¥ç€çš„1ä¸ªå­—èŠ‚0x02ä¸ºè¡¨ä¸­åˆ—çš„æ•°ç›®ã€‚ç„¶å1ä¸ªå­—èŠ‚0xffå„ä¸ªbitæ ‡è¯†å„åˆ—æ˜¯å¦å­˜åœ¨å€¼ï¼Œè¿™é‡Œè¡¨ç¤ºéƒ½å­˜åœ¨ã€‚ æ¥ç€çš„å°±æ˜¯æ’å…¥çš„å„è¡Œæ•°æ®äº†ã€‚ç¬¬1ä¸ªå­—èŠ‚0xfeçš„å„ä¸ªbitæ ‡è¯†è¯¥è¡Œå˜åŒ–ä¹‹åå„åˆ—æ˜¯å¦ä¸ºNULLï¼Œä¸ºNULLè®°ä¸º1.è¿™é‡Œè¡¨ç¤ºç¬¬1åˆ—ä¸ä¸ºNULLï¼Œå› ä¸ºç¬¬ä¸€è¡Œæ•°æ®æ’å…¥çš„æ˜¯(1,NULL)ã€‚æ¥ä¸‹æ¥æ˜¯å„åˆ—çš„æ•°æ®ï¼Œç¬¬ä¸€åˆ—æ˜¯MYSQL_TYPE_LONG,é•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥0x00000001å°±æ˜¯è¿™ä¸ªå€¼ã€‚ç¬¬äºŒåˆ—æ˜¯NULLä¸å å­—èŠ‚ã€‚æ¥ä¸‹æ¥æ˜¯ç¬¬äºŒè¡Œï¼Œå…ˆæ˜¯0xfcæ ‡è¯†ä¸¤åˆ—éƒ½ä¸ä¸ºNULLï¼Œå…ˆè¯»å–ç¬¬ä¸€åˆ—çš„4ä¸ªå­—èŠ‚0x00000002ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ’å…¥çš„æ•°å­—2ï¼Œç„¶åè¯»å–ç¬¬äºŒåˆ—ï¼Œå…ˆæ˜¯ä¸€ä¸ªå­—èŠ‚çš„é•¿åº¦0x01ï¼Œç„¶åæ˜¯å†…å®¹0x61ä¹Ÿå°±æ˜¯å­—ç¬¦â€™aâ€™ã€‚åˆ°æ­¤ï¼Œwrite_rows eventä¹Ÿå°±åˆ†æå®Œäº†ã€‚rowsç›¸å…³çš„eventè¿˜æœ‰update_rows eventå’Œdelete_rows eventç­‰ï¼Œæ¬²äº†è§£æ›´å¤šå¯ä»¥å‚è§å®˜æ–¹æ–‡æ¡£ã€‚ intvar event intvar eventåœ¨binlog_format=statementæ—¶ä½¿ç”¨åˆ°ï¼Œç”¨äºè‡ªå¢é”®ç±»å‹auto_incrementï¼Œååˆ†é‡è¦ã€‚intval eventçš„Fixed dataéƒ¨åˆ†ä¸ºç©ºï¼Œè€ŒVariable dataéƒ¨åˆ†ä¸º9ä¸ªå­—èŠ‚ï¼Œç¬¬1ä¸ªå­—èŠ‚ç”¨äºæ ‡è¯†è‡ªå¢äº‹ä»¶ç±»å‹ LAST_INSERT_ID_EVENT = 1 or INSERT_ID_EVENT = 2ï¼Œä½™ä¸‹çš„8ä¸ªå­—èŠ‚ä¸ºè‡ªå¢IDã€‚ åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ create table tinc (i int auto_increment primary key, c varchar(10)) engine=innodb;ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªæ’å…¥è¯­å¥INSERT INTO tinc(c) values(â€˜abcâ€™);å°±å¯ä»¥çœ‹åˆ°intvar eventäº†ï¼Œè¿™é‡Œçš„è‡ªå¢äº‹ä»¶ç±»å‹ä¸ºINSERT_ID_EVENTã€‚è€Œå¦‚æœç”¨è¯­å¥INSERT INTO tinc(i, c) VALUES(LAST_INSERT_ID()+1, â€˜abcâ€™)ï¼Œåˆ™å¯ä»¥çœ‹åˆ°è‡ªå¢äº‹ä»¶ç±»å‹ä¸ºLAST_INSERT_ID_EVENTçš„intvar eventã€‚ å‚è€ƒèµ„æ–™ä¸ºå®˜æ–¹èµ„æ–™ æ•°æ®åº“åŠ é”æ˜¯ä»€ä¹ˆæ ·çš„æµç¨‹ï¼Ÿç­”ï¼šè¡¨çº§é”å®šï¼ˆtable-levelï¼‰* è¡¨çº§åˆ«çš„é”å®šæ˜¯MySQLå„å­˜å‚¨å¼•æ“ä¸­æœ€å¤§é¢—ç²’åº¦çš„é”å®šæœºåˆ¶ã€‚è¯¥é”å®šæœºåˆ¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯å®ç°é€»è¾‘éå¸¸ç®€å•ï¼Œå¸¦æ¥çš„ç³»ç»Ÿè´Ÿé¢å½±å“æœ€å°ã€‚æ‰€ä»¥è·å–é”å’Œé‡Šæ”¾é”çš„é€Ÿåº¦å¾ˆå¿«ã€‚ç”±äºè¡¨çº§é”ä¸€æ¬¡ä¼šå°†æ•´ä¸ªè¡¨é”å®šï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå¥½çš„é¿å…å›°æ‰°æˆ‘ä»¬çš„æ­»é”é—®é¢˜ã€‚å½“ç„¶ï¼Œé”å®šé¢—ç²’åº¦å¤§æ‰€å¸¦æ¥æœ€å¤§çš„è´Ÿé¢å½±å“å°±æ˜¯å‡ºç°é”å®šèµ„æºäº‰ç”¨çš„æ¦‚ç‡ä¹Ÿä¼šæœ€é«˜ï¼Œè‡´ä½¿å¹¶å¤§åº¦å¤§æ‰“æŠ˜æ‰£ã€‚ä½¿ç”¨è¡¨çº§é”å®šçš„ä¸»è¦æ˜¯MyISAMï¼ŒMEMORYï¼ŒCSVç­‰ä¸€äº›éäº‹åŠ¡æ€§å­˜å‚¨å¼•æ“ã€‚ è¡Œçº§é”å®šï¼ˆrow-levelï¼‰* è¡Œçº§é”å®šæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯é”å®šå¯¹è±¡çš„é¢—ç²’åº¦å¾ˆå°ï¼Œä¹Ÿæ˜¯ç›®å‰å„å¤§æ•°æ®åº“ç®¡ç†è½¯ä»¶æ‰€å®ç°çš„é”å®šé¢—ç²’åº¦æœ€å°çš„ã€‚ç”±äºé”å®šé¢—ç²’åº¦å¾ˆå°ï¼Œæ‰€ä»¥å‘ç”Ÿé”å®šèµ„æºäº‰ç”¨çš„æ¦‚ç‡ä¹Ÿæœ€å°ï¼Œèƒ½å¤Ÿç»™äºˆåº”ç”¨ç¨‹åºå°½å¯èƒ½å¤§çš„å¹¶å‘å¤„ç†èƒ½åŠ›è€Œæé«˜ä¸€äº›éœ€è¦é«˜å¹¶å‘åº”ç”¨ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚è™½ç„¶èƒ½å¤Ÿåœ¨å¹¶å‘å¤„ç†èƒ½åŠ›ä¸Šé¢æœ‰è¾ƒå¤§çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯è¡Œçº§é”å®šä¹Ÿå› æ­¤å¸¦æ¥äº†ä¸å°‘å¼Šç«¯ã€‚ç”±äºé”å®šèµ„æºçš„é¢—ç²’åº¦å¾ˆå°ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–é”å’Œé‡Šæ”¾é”éœ€è¦åšçš„äº‹æƒ…ä¹Ÿæ›´å¤šï¼Œå¸¦æ¥çš„æ¶ˆè€—è‡ªç„¶ä¹Ÿå°±æ›´å¤§äº†ã€‚æ­¤å¤–ï¼Œè¡Œçº§é”å®šä¹Ÿæœ€å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚ä½¿ç”¨è¡Œçº§é”å®šçš„ä¸»è¦æ˜¯InnoDBå­˜å‚¨å¼•æ“ã€‚ é¡µçº§é”å®šï¼ˆpage-levelï¼‰* é¡µçº§é”å®šæ˜¯MySQLä¸­æ¯”è¾ƒç‹¬ç‰¹çš„ä¸€ç§é”å®šçº§åˆ«ï¼Œåœ¨å…¶ä»–æ•°æ®åº“ç®¡ç†è½¯ä»¶ä¸­ä¹Ÿå¹¶ä¸æ˜¯å¤ªå¸¸è§ã€‚é¡µçº§é”å®šçš„ç‰¹ç‚¹æ˜¯é”å®šé¢—ç²’åº¦ä»‹äºè¡Œçº§é”å®šä¸è¡¨çº§é”ä¹‹é—´ï¼Œæ‰€ä»¥è·å–é”å®šæ‰€éœ€è¦çš„èµ„æºå¼€é”€ï¼Œä»¥åŠæ‰€èƒ½æä¾›çš„å¹¶å‘å¤„ç†èƒ½åŠ›ä¹ŸåŒæ ·æ˜¯ä»‹äºä¸Šé¢äºŒè€…ä¹‹é—´ã€‚å¦å¤–ï¼Œé¡µçº§é”å®šå’Œè¡Œçº§é”å®šä¸€æ ·ï¼Œä¼šå‘ç”Ÿæ­»é”ã€‚åœ¨æ•°æ®åº“å®ç°èµ„æºé”å®šçš„è¿‡ç¨‹ä¸­ï¼Œéšç€é”å®šèµ„æºé¢—ç²’åº¦çš„å‡å°ï¼Œé”å®šç›¸åŒæ•°æ®é‡çš„æ•°æ®æ‰€éœ€è¦æ¶ˆè€—çš„å†…å­˜æ•°é‡æ˜¯è¶Šæ¥è¶Šå¤šçš„ï¼Œå®ç°ç®—æ³•ä¹Ÿä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚ä¸è¿‡ï¼Œéšç€é”å®šèµ„æºé¢—ç²’åº¦çš„å‡å°ï¼Œåº”ç”¨ç¨‹åºçš„è®¿é—®è¯·æ±‚é‡åˆ°é”ç­‰å¾…çš„å¯èƒ½æ€§ä¹Ÿä¼šéšä¹‹é™ä½ï¼Œç³»ç»Ÿæ•´ä½“å¹¶å‘åº¦ä¹Ÿéšä¹‹æå‡ã€‚ä½¿ç”¨é¡µçº§é”å®šçš„ä¸»è¦æ˜¯BerkeleyDBå­˜å‚¨å¼•æ“ã€‚ æ€»çš„æ¥è¯´ï¼ŒMySQLè¿™3ç§é”çš„ç‰¹æ€§å¯å¤§è‡´å½’çº³å¦‚ä¸‹ï¼š è¡¨çº§é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼› è¡Œçº§é”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ï¼› é¡µé¢é”ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ã€‚é€‚ç”¨ï¼šä»é”çš„è§’åº¦æ¥è¯´ï¼Œè¡¨çº§é”æ›´é€‚åˆäºä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œåªæœ‰å°‘é‡æŒ‰ç´¢å¼•æ¡ä»¶æ›´æ–°æ•°æ®çš„åº”ç”¨ï¼Œå¦‚Webåº”ç”¨ï¼›è€Œè¡Œçº§é”åˆ™æ›´é€‚åˆäºæœ‰å¤§é‡æŒ‰ç´¢å¼•æ¡ä»¶å¹¶å‘æ›´æ–°å°‘é‡ä¸åŒæ•°æ®ï¼ŒåŒæ—¶åˆæœ‰å¹¶å‘æŸ¥è¯¢çš„åº”ç”¨ï¼Œå¦‚ä¸€äº›åœ¨çº¿äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰ç³»ç»Ÿã€‚InnoDBé”å®šæ¨¡å¼åŠå®ç°æœºåˆ¶InnoDBçš„è¡Œçº§é”å®šåŒæ ·åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå…±äº«é”å’Œæ’ä»–é”ï¼Œè€Œåœ¨é”å®šæœºåˆ¶çš„å®ç°è¿‡ç¨‹ä¸­ä¸ºäº†è®©è¡Œçº§é”å®šå’Œè¡¨çº§é”å®šå…±å­˜ï¼ŒInnoDBä¹ŸåŒæ ·ä½¿ç”¨äº†æ„å‘é”ï¼ˆè¡¨çº§é”å®šï¼‰çš„æ¦‚å¿µï¼Œä¹Ÿå°±æœ‰äº†æ„å‘å…±äº«é”å’Œæ„å‘æ’ä»–é”è¿™ä¸¤ç§ã€‚å½“ä¸€ä¸ªäº‹åŠ¡éœ€è¦ç»™è‡ªå·±éœ€è¦çš„æŸä¸ªèµ„æºåŠ é”çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°ä¸€ä¸ªå…±äº«é”æ­£é”å®šç€è‡ªå·±éœ€è¦çš„èµ„æºçš„æ—¶å€™ï¼Œè‡ªå·±å¯ä»¥å†åŠ ä¸€ä¸ªå…±äº«é”ï¼Œä¸è¿‡ä¸èƒ½åŠ æ’ä»–é”ã€‚ä½†æ˜¯ï¼Œå¦‚æœé‡åˆ°è‡ªå·±éœ€è¦é”å®šçš„èµ„æºå·²ç»è¢«ä¸€ä¸ªæ’ä»–é”å æœ‰ä¹‹åï¼Œåˆ™åªèƒ½ç­‰å¾…è¯¥é”å®šé‡Šæ”¾èµ„æºä¹‹åè‡ªå·±æ‰èƒ½è·å–é”å®šèµ„æºå¹¶æ·»åŠ è‡ªå·±çš„é”å®šã€‚è€Œæ„å‘é”çš„ä½œç”¨å°±æ˜¯å½“ä¸€ä¸ªäº‹åŠ¡åœ¨éœ€è¦è·å–èµ„æºé”å®šçš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°è‡ªå·±éœ€è¦çš„èµ„æºå·²ç»è¢«æ’ä»–é”å ç”¨çš„æ—¶å€™ï¼Œè¯¥äº‹åŠ¡å¯ä»¥éœ€è¦é”å®šè¡Œçš„è¡¨ä¸Šé¢æ·»åŠ ä¸€ä¸ªåˆé€‚çš„æ„å‘é”ã€‚å¦‚æœè‡ªå·±éœ€è¦ä¸€ä¸ªå…±äº«é”ï¼Œé‚£ä¹ˆå°±åœ¨è¡¨ä¸Šé¢æ·»åŠ ä¸€ä¸ªæ„å‘å…±äº«é”ã€‚è€Œå¦‚æœè‡ªå·±éœ€è¦çš„æ˜¯æŸè¡Œï¼ˆæˆ–è€…æŸäº›è¡Œï¼‰ä¸Šé¢æ·»åŠ ä¸€ä¸ªæ’ä»–é”çš„è¯ï¼Œåˆ™å…ˆåœ¨è¡¨ä¸Šé¢æ·»åŠ ä¸€ä¸ªæ„å‘æ’ä»–é”ã€‚æ„å‘å…±äº«é”å¯ä»¥åŒæ—¶å¹¶å­˜å¤šä¸ªï¼Œä½†æ˜¯æ„å‘æ’ä»–é”åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è¯´InnoDBçš„é”å®šæ¨¡å¼å®é™…ä¸Šå¯ä»¥åˆ†ä¸ºå››ç§ï¼šå…±äº«é”ï¼ˆSï¼‰ï¼Œæ’ä»–é”ï¼ˆXï¼‰ï¼Œæ„å‘å…±äº«é”ï¼ˆISï¼‰å’Œæ„å‘æ’ä»–é”ï¼ˆIXï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹è¡¨æ ¼æ¥æ€»ç»“ä¸Šé¢è¿™å››ç§æ‰€çš„å…±å­˜é€»è¾‘å…³ç³»ï¼š å¦‚æœä¸€ä¸ªäº‹åŠ¡è¯·æ±‚çš„é”æ¨¡å¼ä¸å½“å‰çš„é”å…¼å®¹ï¼ŒInnoDBå°±å°†è¯·æ±‚çš„é”æˆäºˆè¯¥äº‹åŠ¡ï¼›åä¹‹ï¼Œå¦‚æœä¸¤è€…ä¸å…¼å®¹ï¼Œè¯¥äº‹åŠ¡å°±è¦ç­‰å¾…é”é‡Šæ”¾ã€‚ æ„å‘é”æ˜¯InnoDBè‡ªåŠ¨åŠ çš„ï¼Œä¸éœ€ç”¨æˆ·å¹²é¢„ã€‚å¯¹äºUPDATEã€DELETEå’ŒINSERTè¯­å¥ï¼ŒInnoDBä¼šè‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ æ’ä»–é”ï¼ˆX)ï¼›å¯¹äºæ™®é€šSELECTè¯­å¥ï¼ŒInnoDBä¸ä¼šåŠ ä»»ä½•é”ï¼›äº‹åŠ¡å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æ˜¾ç¤ºç»™è®°å½•é›†åŠ å…±äº«é”æˆ–æ’ä»–é”ã€‚12å…±äº«é”ï¼ˆSï¼‰ï¼šSELECT * FROM table_name WHERE ... LOCK IN SHARE MODEæ’ä»–é”ï¼ˆX)ï¼šSELECT * FROM table_name WHERE ... FOR UPDATE ç”¨SELECT â€¦ IN SHARE MODEè·å¾—å…±äº«é”ï¼Œä¸»è¦ç”¨åœ¨éœ€è¦æ•°æ®ä¾å­˜å…³ç³»æ—¶æ¥ç¡®è®¤æŸè¡Œè®°å½•æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ç¡®ä¿æ²¡æœ‰äººå¯¹è¿™ä¸ªè®°å½•è¿›è¡ŒUPDATEæˆ–è€…DELETEæ“ä½œã€‚ ä½†æ˜¯å¦‚æœå½“å‰äº‹åŠ¡ä¹Ÿéœ€è¦å¯¹è¯¥è®°å½•è¿›è¡Œæ›´æ–°æ“ä½œï¼Œåˆ™å¾ˆæœ‰å¯èƒ½é€ æˆæ­»é”ï¼Œå¯¹äºé”å®šè¡Œè®°å½•åéœ€è¦è¿›è¡Œæ›´æ–°æ“ä½œçš„åº”ç”¨ï¼Œåº”è¯¥ä½¿ç”¨SELECTâ€¦ FOR UPDATEæ–¹å¼è·å¾—æ’ä»–é”ã€‚InnoDBè¡Œé”å®ç°æ–¹å¼ InnoDBè¡Œé”æ˜¯é€šè¿‡ç»™ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é” åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¦ç‰¹åˆ«æ³¨æ„InnoDBè¡Œé”çš„è¿™ä¸€ç‰¹æ€§ï¼Œä¸ç„¶çš„è¯ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„é”å†²çªï¼Œä»è€Œå½±å“å¹¶å‘æ€§èƒ½ã€‚ä¸‹é¢é€šè¿‡ä¸€äº›å®é™…ä¾‹å­æ¥åŠ ä»¥è¯´æ˜ã€‚ ï¼ˆ1ï¼‰åœ¨ä¸é€šè¿‡ç´¢å¼•æ¡ä»¶æŸ¥è¯¢çš„æ—¶å€™ï¼ŒInnoDBç¡®å®ä½¿ç”¨çš„æ˜¯è¡¨é”ï¼Œè€Œä¸æ˜¯è¡Œé”ã€‚ ï¼ˆ2ï¼‰ç”±äºMySQLçš„è¡Œé”æ˜¯é’ˆå¯¹ç´¢å¼•åŠ çš„é”ï¼Œä¸æ˜¯é’ˆå¯¹è®°å½•åŠ çš„é”ï¼Œæ‰€ä»¥è™½ç„¶æ˜¯è®¿é—®ä¸åŒè¡Œçš„è®°å½•ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä½¿ç”¨ç›¸åŒçš„ç´¢å¼•é”®ï¼Œæ˜¯ä¼šå‡ºç°é”å†²çªçš„ã€‚ ï¼ˆ3ï¼‰å½“è¡¨æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œä¸åŒçš„äº‹åŠ¡å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç´¢å¼•é”å®šä¸åŒçš„è¡Œï¼Œå¦å¤–ï¼Œä¸è®ºæ˜¯ä½¿ç”¨ä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•æˆ–æ™®é€šç´¢å¼•ï¼ŒInnoDBéƒ½ä¼šä½¿ç”¨è¡Œé”æ¥å¯¹æ•°æ®åŠ é”ã€‚ ï¼ˆ4ï¼‰å³ä¾¿åœ¨æ¡ä»¶ä¸­ä½¿ç”¨äº†ç´¢å¼•å­—æ®µï¼Œä½†æ˜¯å¦ä½¿ç”¨ç´¢å¼•æ¥æ£€ç´¢æ•°æ®æ˜¯ç”±MySQLé€šè¿‡åˆ¤æ–­ä¸åŒæ‰§è¡Œè®¡åˆ’çš„ä»£ä»·æ¥å†³å®šçš„ï¼Œå¦‚æœMySQLè®¤ä¸ºå…¨è¡¨æ‰«ææ•ˆç‡æ›´é«˜ï¼Œæ¯”å¦‚å¯¹ä¸€äº›å¾ˆå°çš„è¡¨ï¼Œå®ƒå°±ä¸ä¼šä½¿ç”¨ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µä¸‹InnoDBå°†ä½¿ç”¨è¡¨é”ï¼Œè€Œä¸æ˜¯è¡Œé”ã€‚å› æ­¤ï¼Œåœ¨åˆ†æé”å†²çªæ—¶ï¼Œåˆ«å¿˜äº†æ£€æŸ¥SQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œä»¥ç¡®è®¤æ˜¯å¦çœŸæ­£ä½¿ç”¨äº†ç´¢å¼•ã€‚ 3.é—´éš™é”ï¼ˆNext-Keyé”ï¼‰ å½“æˆ‘ä»¬ç”¨èŒƒå›´æ¡ä»¶è€Œä¸æ˜¯ç›¸ç­‰æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œå¹¶è¯·æ±‚å…±äº«æˆ–æ’ä»–é”æ—¶ï¼ŒInnoDBä¼šç»™ç¬¦åˆæ¡ä»¶çš„å·²æœ‰æ•°æ®è®°å½•çš„ç´¢å¼•é¡¹åŠ é”ï¼› å¯¹äºé”®å€¼åœ¨æ¡ä»¶èŒƒå›´å†…ä½†å¹¶ä¸å­˜åœ¨çš„è®°å½•ï¼Œå«åšâ€œé—´éš™ï¼ˆGAP)â€ï¼ŒInnoDBä¹Ÿä¼šå¯¹è¿™ä¸ªâ€œé—´éš™â€åŠ é”ï¼Œè¿™ç§é”æœºåˆ¶å°±æ˜¯æ‰€è°“çš„é—´éš™é”ï¼ˆNext-Keyé”ï¼‰ nnoDBä½¿ç”¨é—´éš™é”çš„ç›®çš„ï¼š é˜²æ­¢å¹»è¯»ï¼Œä»¥æ»¡è¶³ç›¸å…³éš”ç¦»çº§åˆ«çš„è¦æ±‚ã€‚å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œè¦æ˜¯ä¸ä½¿ç”¨é—´éš™é”ï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡æ’å…¥äº†empidå¤§äº100çš„ä»»ä½•è®°å½•ï¼Œé‚£ä¹ˆæœ¬äº‹åŠ¡å¦‚æœå†æ¬¡æ‰§è¡Œä¸Šè¿°è¯­å¥ï¼Œå°±ä¼šå‘ç”Ÿå¹»è¯»ï¼› ä¸ºäº†æ»¡è¶³å…¶æ¢å¤å’Œå¤åˆ¶çš„éœ€è¦ã€‚ å¾ˆæ˜¾ç„¶ï¼Œåœ¨ä½¿ç”¨èŒƒå›´æ¡ä»¶æ£€ç´¢å¹¶é”å®šè®°å½•æ—¶ï¼Œå³ä½¿æŸäº›ä¸å­˜åœ¨çš„é”®å€¼ä¹Ÿä¼šè¢«æ— è¾œçš„é”å®šï¼Œè€Œé€ æˆåœ¨é”å®šçš„æ—¶å€™æ— æ³•æ’å…¥é”å®šé”®å€¼èŒƒå›´å†…çš„ä»»ä½•æ•°æ®ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹è¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„å±å®³ã€‚ é™¤äº†é—´éš™é”ç»™InnoDBå¸¦æ¥æ€§èƒ½çš„è´Ÿé¢å½±å“ä¹‹å¤–ï¼Œé€šè¿‡ç´¢å¼•å®ç°é”å®šçš„æ–¹å¼è¿˜å­˜åœ¨å…¶ä»–å‡ ä¸ªè¾ƒå¤§çš„æ€§èƒ½éšæ‚£ï¼š å½“Queryæ— æ³•åˆ©ç”¨ç´¢å¼•çš„æ—¶å€™ï¼ŒInnoDBä¼šæ”¾å¼ƒä½¿ç”¨è¡Œçº§åˆ«é”å®šè€Œæ”¹ç”¨è¡¨çº§åˆ«çš„é”å®šï¼Œé€ æˆå¹¶å‘æ€§èƒ½çš„é™ä½ï¼› å½“Queryä½¿ç”¨çš„ç´¢å¼•å¹¶ä¸åŒ…å«æ‰€æœ‰è¿‡æ»¤æ¡ä»¶çš„æ—¶å€™ï¼Œæ•°æ®æ£€ç´¢ä½¿ç”¨åˆ°çš„ç´¢å¼•é”®æ‰€åªæƒ³çš„æ•°æ®å¯èƒ½æœ‰éƒ¨åˆ†å¹¶ä¸å±äºè¯¥Queryçš„ç»“æœé›†çš„è¡Œåˆ—ï¼Œä½†æ˜¯ä¹Ÿä¼šè¢«é”å®šï¼Œå› ä¸ºé—´éš™é”é”å®šçš„æ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œè€Œä¸æ˜¯å…·ä½“çš„ç´¢å¼•é”®ï¼› å½“Queryåœ¨ä½¿ç”¨ç´¢å¼•å®šä½æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨çš„ç´¢å¼•é”®ä¸€æ ·ä½†è®¿é—®çš„æ•°æ®è¡Œä¸åŒçš„æ—¶å€™ï¼ˆç´¢å¼•åªæ˜¯è¿‡æ»¤æ¡ä»¶çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œä¸€æ ·ä¼šè¢«é”å®šã€‚å› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯å¹¶å‘æ’å…¥æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œæˆ‘ä»¬è¦å°½é‡ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ï¼Œå°½é‡ä½¿ç”¨ç›¸ç­‰æ¡ä»¶æ¥è®¿é—®æ›´æ–°æ•°æ®ï¼Œé¿å…ä½¿ç”¨èŒƒå›´æ¡ä»¶ã€‚è¿˜è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼ŒInnoDBé™¤äº†é€šè¿‡èŒƒå›´æ¡ä»¶åŠ é”æ—¶ä½¿ç”¨é—´éš™é”å¤–ï¼Œå¦‚æœä½¿ç”¨ç›¸ç­‰æ¡ä»¶è¯·æ±‚ç»™ä¸€ä¸ªä¸å­˜åœ¨çš„è®°å½•åŠ é”ï¼ŒInnoDBä¹Ÿä¼šä½¿ç”¨é—´éš™é”ã€‚é€šå¸¸æ¥è¯´ï¼Œæ­»é”éƒ½æ˜¯åº”ç”¨è®¾è®¡çš„é—®é¢˜ï¼Œé€šè¿‡è°ƒæ•´ä¸šåŠ¡æµç¨‹ã€æ•°æ®åº“å¯¹è±¡è®¾è®¡ã€äº‹åŠ¡å¤§å°ï¼Œä»¥åŠè®¿é—®æ•°æ®åº“çš„SQLè¯­å¥ï¼Œç»å¤§éƒ¨åˆ†æ­»é”éƒ½å¯ä»¥é¿å…ã€‚ä¸‹é¢å°±é€šè¿‡å®ä¾‹æ¥ä»‹ç»å‡ ç§é¿å…æ­»é”çš„å¸¸ç”¨æ–¹æ³•ï¼š åœ¨åº”ç”¨ä¸­ï¼Œå¦‚æœä¸åŒçš„ç¨‹åºä¼šå¹¶å‘å­˜å–å¤šä¸ªè¡¨ï¼Œåº”å°½é‡çº¦å®šä»¥ç›¸åŒçš„é¡ºåºæ¥è®¿é—®è¡¨ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§é™ä½äº§ç”Ÿæ­»é”çš„æœºä¼šã€‚ åœ¨ç¨‹åºä»¥æ‰¹é‡æ–¹å¼å¤„ç†æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœäº‹å…ˆå¯¹æ•°æ®æ’åºï¼Œä¿è¯æ¯ä¸ªçº¿ç¨‹æŒ‰å›ºå®šçš„é¡ºåºæ¥å¤„ç†è®°å½•ï¼Œä¹Ÿå¯ä»¥å¤§å¤§é™ä½å‡ºç°æ­»é”çš„å¯èƒ½ã€‚ åœ¨äº‹åŠ¡ä¸­ï¼Œå¦‚æœè¦æ›´æ–°è®°å½•ï¼Œåº”è¯¥ç›´æ¥ç”³è¯·è¶³å¤Ÿçº§åˆ«çš„é”ï¼Œå³æ’ä»–é”ï¼Œè€Œä¸åº”å…ˆç”³è¯·å…±äº«é”ï¼Œæ›´æ–°æ—¶å†ç”³è¯·æ’ä»–é”ï¼Œå› ä¸ºå½“ç”¨æˆ·ç”³è¯·æ’ä»–é”æ—¶ï¼Œå…¶ä»–äº‹åŠ¡å¯èƒ½åˆå·²ç»è·å¾—äº†ç›¸åŒè®°å½•çš„å…±äº«é”ï¼Œä»è€Œé€ æˆé”å†²çªï¼Œç”šè‡³æ­»é”ã€‚ åœ¨REPEATABLE-READéš”ç¦»çº§åˆ«ä¸‹ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ç›¸åŒæ¡ä»¶è®°å½•ç”¨SELECTâ€¦FOR UPDATEåŠ æ’ä»–é”ï¼Œåœ¨æ²¡æœ‰ç¬¦åˆè¯¥æ¡ä»¶è®°å½•æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šåŠ é”æˆåŠŸã€‚ç¨‹åºå‘ç°è®°å½•å°šä¸å­˜åœ¨ï¼Œå°±è¯•å›¾æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½è¿™ä¹ˆåšï¼Œå°±ä¼šå‡ºç°æ­»é”ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°†éš”ç¦»çº§åˆ«æ”¹æˆREAD COMMITTEDï¼Œå°±å¯é¿å…é—®é¢˜ã€‚ å½“éš”ç¦»çº§åˆ«ä¸ºREAD COMMITTEDæ—¶ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½å…ˆæ‰§è¡ŒSELECTâ€¦FOR UPDATEï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ’å…¥è®°å½•ã€‚æ­¤æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ’å…¥æˆåŠŸï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¼šå‡ºç°é”ç­‰å¾…ï¼Œå½“ç¬¬1ä¸ªçº¿ç¨‹æäº¤åï¼Œç¬¬2ä¸ªçº¿ç¨‹ä¼šå› ä¸»é”®é‡å‡ºé”™ï¼Œä½†è™½ç„¶è¿™ä¸ªçº¿ç¨‹å‡ºé”™äº†ï¼Œå´ä¼šè·å¾—ä¸€ä¸ªæ’ä»–é”ã€‚è¿™æ—¶å¦‚æœæœ‰ç¬¬3ä¸ªçº¿ç¨‹åˆæ¥ç”³è¯·æ’ä»–é”ï¼Œä¹Ÿä¼šå‡ºç°æ­»é”ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥ç›´æ¥åšæ’å…¥æ“ä½œï¼Œç„¶åå†æ•è·ä¸»é”®é‡å¼‚å¸¸ï¼Œæˆ–è€…åœ¨é‡åˆ°ä¸»é”®é‡é”™è¯¯æ—¶ï¼Œæ€»æ˜¯æ‰§è¡ŒROLLBACKé‡Šæ”¾è·å¾—çš„æ’ä»–é”ã€‚ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è¡¨é”å¯¹äºInnoDBè¡¨ï¼Œåœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½åº”è¯¥ä½¿ç”¨è¡Œçº§é”ï¼Œå› ä¸ºäº‹åŠ¡å’Œè¡Œé”å¾€å¾€æ˜¯æˆ‘ä»¬ä¹‹æ‰€ä»¥é€‰æ‹©InnoDBè¡¨çš„ç†ç”±ã€‚ä½†åœ¨ä¸ªåˆ«ç‰¹æ®Šäº‹åŠ¡ä¸­ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨è¡¨çº§é”ï¼š * äº‹åŠ¡éœ€è¦æ›´æ–°å¤§éƒ¨åˆ†æˆ–å…¨éƒ¨æ•°æ®ï¼Œè¡¨åˆæ¯”è¾ƒå¤§ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„è¡Œé”ï¼Œä¸ä»…è¿™ä¸ªäº‹åŠ¡æ‰§è¡Œæ•ˆç‡ä½ï¼Œè€Œä¸”å¯èƒ½é€ æˆå…¶ä»–äº‹åŠ¡é•¿æ—¶é—´é”ç­‰å¾…å’Œé”å†²çªï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨è¡¨é”æ¥æé«˜è¯¥äº‹åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ã€‚ * äº‹åŠ¡æ¶‰åŠå¤šä¸ªè¡¨ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œå¾ˆå¯èƒ½å¼•èµ·æ­»é”ï¼Œé€ æˆå¤§é‡äº‹åŠ¡å›æ»šã€‚è¿™ç§æƒ…å†µä¹Ÿå¯ä»¥è€ƒè™‘ä¸€æ¬¡æ€§é”å®šäº‹åŠ¡æ¶‰åŠçš„è¡¨ï¼Œä»è€Œé¿å…æ­»é”ã€å‡å°‘æ•°æ®åº“å› äº‹åŠ¡å›æ»šå¸¦æ¥çš„å¼€é”€ã€‚ å½“ç„¶ï¼Œåº”ç”¨ä¸­è¿™ä¸¤ç§äº‹åŠ¡ä¸èƒ½å¤ªå¤šï¼Œå¦åˆ™ï¼Œå°±åº”è¯¥è€ƒè™‘ä½¿ç”¨MyISAMè¡¨äº†ã€‚ * åœ¨InnoDBä¸‹ï¼Œä½¿ç”¨è¡¨é”è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ã€‚ * ä½¿ç”¨LOCK TABLESè™½ç„¶å¯ä»¥ç»™InnoDBåŠ è¡¨çº§é”ï¼Œä½†å¿…é¡»è¯´æ˜çš„æ˜¯ï¼Œè¡¨é”ä¸æ˜¯ç”±InnoDBå­˜å‚¨å¼•æ“å±‚ç®¡ç†çš„ï¼Œè€Œæ˜¯ç”±å…¶ä¸Šä¸€å±‚â”€â”€MySQL Serverè´Ÿè´£çš„ï¼Œä»…å½“autocommit=0ã€InnoDB_table_locks=1ï¼ˆé»˜è®¤è®¾ç½®ï¼‰æ—¶ï¼ŒInnoDBå±‚æ‰èƒ½çŸ¥é“MySQLåŠ çš„è¡¨é”ï¼ŒMySQL Serverä¹Ÿæ‰èƒ½æ„ŸçŸ¥InnoDBåŠ çš„è¡Œé”ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒInnoDBæ‰èƒ½è‡ªåŠ¨è¯†åˆ«æ¶‰åŠè¡¨çº§é”çš„æ­»é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†æ— æ³•è‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†è¿™ç§æ­»é” * åœ¨ç”¨ LOCK TABLESå¯¹InnoDBè¡¨åŠ é”æ—¶è¦æ³¨æ„ï¼Œè¦å°†AUTOCOMMITè®¾ä¸º0ï¼Œå¦åˆ™MySQLä¸ä¼šç»™è¡¨åŠ é”ï¼›äº‹åŠ¡ç»“æŸå‰ï¼Œä¸è¦ç”¨UNLOCK TABLESé‡Šæ”¾è¡¨é”ï¼Œå› ä¸ºUNLOCK TABLESä¼šéšå«åœ°æäº¤äº‹åŠ¡ï¼›COMMITæˆ–ROLLBACKå¹¶ä¸èƒ½é‡Šæ”¾ç”¨LOCK TABLESåŠ çš„è¡¨çº§é”ï¼Œå¿…é¡»ç”¨UNLOCK TABLESé‡Šæ”¾è¡¨é” SQLä¼˜åŒ–æ€ä¹ˆåšï¼ŸSQLæ‰§è¡Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä»clientå‘èµ·è¯·æ±‚åˆ°æ•°æ®åº“æ‰§è¡ŒSQLåœ¨è¿”å›æ•°æ®æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼š è¿æ¥ å®¢æˆ·ç«¯å‘èµ·ä¸€æ¡Queryè¯·æ±‚ï¼Œç›‘å¬å®¢æˆ·ç«¯çš„â€™è¿æ¥ç®¡ç†æ¨¡å—â€™æ¥æ”¶è¯·æ±‚ å°†è¯·æ±‚è½¬å‘åˆ°â€™è¿æ¥è¿›/çº¿ç¨‹æ¨¡å—â€™ è°ƒç”¨â€™ç”¨æˆ·æ¨¡å—â€™æ¥è¿›è¡Œæˆæƒæ£€æŸ¥ é€šè¿‡æ£€æŸ¥åï¼Œâ€™è¿æ¥è¿›/çº¿ç¨‹æ¨¡å—â€™ä»â€™çº¿ç¨‹è¿æ¥æ± â€™ä¸­å–å‡ºç©ºé—²çš„è¢«ç¼“å­˜çš„è¿æ¥çº¿ç¨‹å’Œå®¢æˆ·ç«¯è¯·æ±‚å¯¹æ¥ï¼Œå¦‚æœå¤±è´¥åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚å¤„ç† å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œæ£€æŸ¥Queryè¯­å¥æ˜¯å¦å®Œå…¨åŒ¹é…ï¼Œæ¥ç€å†æ£€æŸ¥æ˜¯å¦å…·æœ‰æƒé™ï¼Œéƒ½æˆåŠŸåˆ™ç›´æ¥å–æ•°æ®è¿”å› ä¸Šä¸€æ­¥æœ‰å¤±è´¥åˆ™è½¬äº¤ç»™â€™å‘½ä»¤è§£æå™¨â€™ï¼Œç»è¿‡è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æåç”Ÿæˆè§£ææ ‘ æ¥ä¸‹æ¥æ˜¯é¢„å¤„ç†é˜¶æ®µï¼Œå¤„ç†è§£æå™¨æ— æ³•è§£å†³çš„è¯­ä¹‰ï¼Œæ£€æŸ¥æƒé™ç­‰ï¼Œç”Ÿæˆæ–°çš„è§£ææ ‘ å†è½¬äº¤ç»™å¯¹åº”çš„æ¨¡å—å¤„ç† å¦‚æœæ˜¯SELECTæŸ¥è¯¢è¿˜ä¼šç»ç”±â€™æŸ¥è¯¢ä¼˜åŒ–å™¨â€™åšå¤§é‡çš„ä¼˜åŒ–ï¼Œç”Ÿæˆæ‰§è¡Œè®¡åˆ’ æ¨¡å—æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡â€™è®¿é—®æ§åˆ¶æ¨¡å—â€™æ£€æŸ¥æ‰€è¿æ¥çš„ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®ç›®æ ‡è¡¨å’Œç›®æ ‡å­—æ®µçš„æƒé™ æœ‰åˆ™è°ƒç”¨â€™è¡¨ç®¡ç†æ¨¡å—â€™ï¼Œå…ˆæ˜¯æŸ¥çœ‹table cacheä¸­æ˜¯å¦å­˜åœ¨ï¼Œæœ‰åˆ™ç›´æ¥å¯¹åº”çš„è¡¨å’Œè·å–é”ï¼Œå¦åˆ™é‡æ–°æ‰“å¼€è¡¨æ–‡ä»¶ æ ¹æ®è¡¨çš„metaæ•°æ®ï¼Œè·å–è¡¨çš„å­˜å‚¨å¼•æ“ç±»å‹ç­‰ä¿¡æ¯ï¼Œé€šè¿‡æ¥å£è°ƒç”¨å¯¹åº”çš„å­˜å‚¨å¼•æ“å¤„ç† ä¸Šè¿°è¿‡ç¨‹ä¸­äº§ç”Ÿæ•°æ®å˜åŒ–çš„æ—¶å€™ï¼Œè‹¥æ‰“å¼€æ—¥å¿—åŠŸèƒ½ï¼Œåˆ™ä¼šè®°å½•åˆ°ç›¸åº”äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ä¸­ç»“æœ Queryè¯·æ±‚å®Œæˆåï¼Œå°†ç»“æœé›†è¿”å›ç»™â€™è¿æ¥è¿›/çº¿ç¨‹æ¨¡å—â€™ è¿”å›çš„ä¹Ÿå¯ä»¥æ˜¯ç›¸åº”çš„çŠ¶æ€æ ‡è¯†ï¼Œå¦‚æˆåŠŸæˆ–å¤±è´¥ç­‰ è¿æ¥è¿›/çº¿ç¨‹æ¨¡å—â€™è¿›è¡Œåç»­çš„æ¸…ç†å·¥ä½œï¼Œå¹¶ç»§ç»­ç­‰å¾…è¯·æ±‚æˆ–æ–­å¼€ä¸å®¢æˆ·ç«¯çš„è¿æ¥ å°ç»“ç”¨æˆ·æ¨¡å—æ ¡éªŒç”¨æˆ·,ç„¶åå»çº¿ç¨‹è¿æ¥æ± æ‹¿çº¿ç¨‹(è¿æ¥è¶³å¤Ÿçš„è¯),æ‰¾å‘½ä»¤åˆ†å‘å™¨,åˆ°æŸ¥è¯¢ç¼“å­˜æ¨¡å—æŸ¥SQLè¯­å¥,å¦‚æœæ²¡æœ‰,èµ°å‘½ä»¤è§£æå™¨,ç„¶åè®¿é—®æ§åˆ¶æ¨¡å—,è®¾å®šç”¨æˆ·çš„æƒé™,è®¾å®šå¥½åèµ°è¡¨ç®¡ç†æ¨¡å—,è·å–é”å’Œç¼“å­˜,ç„¶åè·å–å„ç§ä¿¡æ¯,å­˜å‚¨çš„æ–¹å¼:å­˜å‚¨å¼•æ“,ä»å­˜å‚¨å¼•æ“è·å–æ•°æ®,ç„¶åè¿”å› æ•°æ®åº“äº‹åŠ¡ACIDç‰¹æ€§ç­”ï¼šæ•°æ®åº“äº‹åŠ¡ACIDç‰¹æ€§,æ•°æ®åº“äº‹åŠ¡çš„4ä¸ªç‰¹æ€§ï¼š åŸå­æ€§(Atomic): äº‹åŠ¡ä¸­çš„å¤šä¸ªæ“ä½œï¼Œä¸å¯åˆ†å‰²ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼› All or Nothing. ä¸€è‡´æ€§(Consistency): äº‹åŠ¡æ“ä½œä¹‹å, æ•°æ®åº“æ‰€å¤„çš„çŠ¶æ€å’Œä¸šåŠ¡è§„åˆ™æ˜¯ä¸€è‡´çš„; æ¯”å¦‚a,bè´¦æˆ·ç›¸äº’è½¬è´¦ä¹‹åï¼Œæ€»é‡‘é¢ä¸å˜ï¼› éš”ç¦»æ€§(Isolation): å¤šä¸ªäº‹åŠ¡ä¹‹é—´å°±åƒæ˜¯ä¸²è¡Œæ‰§è¡Œä¸€æ ·ï¼Œä¸ç›¸äº’å½±å“; æŒä¹…æ€§(Durability): äº‹åŠ¡æäº¤åè¢«æŒä¹…åŒ–åˆ°æ°¸ä¹…å­˜å‚¨.éš”ç¦»æ€§,å…¶ä¸­éš”ç¦»æ€§åˆ†ä¸ºäº†å››ç§ï¼š READ UNCOMMITTEDï¼šå¯ä»¥è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œæœªæäº¤çš„æ•°æ®ç§°ä¸ºè„æ•°æ®ï¼Œæ‰€ä»¥åˆç§°è„è¯»ã€‚æ­¤æ—¶ï¼šå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œè„è¯»å‡å…è®¸ï¼› READ COMMITTEDï¼šåªèƒ½è¯»å–å·²ç»æäº¤çš„æ•°æ®ï¼›æ­¤æ—¶ï¼šå…è®¸å¹»è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†ä¸å…è®¸è„è¯»ï¼Œæ‰€ä»¥RCéš”ç¦»çº§åˆ«è¦æ±‚è§£å†³è„è¯»ï¼› REPEATABLE READï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªselect,è¯»å–åˆ°çš„æ•°æ®æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼›æ­¤æ—¶ï¼šå…è®¸å¹»è¯»ï¼Œä½†ä¸å…è®¸ä¸å¯é‡å¤è¯»å’Œè„è¯»ï¼Œæ‰€ä»¥RRéš”ç¦»çº§åˆ«è¦æ±‚è§£å†³ä¸å¯é‡å¤è¯»ï¼› SERIALIZABLE: å¹»è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œè„è¯»éƒ½ä¸å…è®¸ï¼Œæ‰€ä»¥serializableè¦æ±‚è§£å†³å¹»è¯»ï¼›åŠ å¼ºç†è§£ï¼š è„è¯»ï¼šå¯ä»¥è¯»å–æœªæäº¤çš„æ•°æ®ã€‚RC è¦æ±‚è§£å†³è„è¯»ï¼› ä¸å¯é‡å¤è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªselect, è¯»å–åˆ°çš„æ•°æ®å‘ç”Ÿäº†æ”¹å˜(è¢«å…¶å®ƒäº‹åŠ¡updateå¹¶ä¸”æäº¤)ï¼› å¯é‡å¤è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªselect, è¯»å–åˆ°çš„æ•°æ®æ²¡æœ‰å‘ç”Ÿæ”¹å˜(ä¸€èˆ¬ä½¿ç”¨MVCCå®ç°)ï¼›RRå„çº§çº§åˆ«è¦æ±‚è¾¾åˆ°å¯é‡å¤è¯»çš„æ ‡å‡†ï¼› å¹»è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªselect, è¯»å–åˆ°çš„æ•°æ®è¡Œå‘ç”Ÿæ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¡Œæ•°å‡å°‘æˆ–è€…å¢åŠ äº†(è¢«å…¶å®ƒäº‹åŠ¡delete/insertå¹¶ä¸”æäº¤)ã€‚SERIALIZABLEè¦æ±‚è§£å†³å¹»è¯»é—®é¢˜ï¼› è¿™é‡Œä¸€å®šè¦åŒºåˆ† ä¸å¯é‡å¤è¯» å’Œ å¹»è¯»ï¼š ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹: åŒæ ·çš„æ¡ä»¶çš„select, ä½ è¯»å–è¿‡çš„æ•°æ®, å†æ¬¡è¯»å–å‡ºæ¥å‘ç°å€¼ä¸ä¸€æ ·äº† å¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤: åŒæ ·çš„æ¡ä»¶çš„select, ç¬¬1æ¬¡å’Œç¬¬2æ¬¡è¯»å‡ºæ¥çš„è®°å½•æ•°ä¸ä¸€æ · ä»ç»“æœä¸Šæ¥çœ‹, ä¸¤è€…éƒ½æ˜¯ä¸ºå¤šæ¬¡è¯»å–çš„ç»“æœä¸ä¸€è‡´ã€‚ä½†å¦‚æœä½ ä»å®ç°çš„è§’åº¦æ¥çœ‹, å®ƒä»¬çš„åŒºåˆ«å°±æ¯”è¾ƒå¤§ï¼š å¯¹äºå‰è€…, åœ¨RCä¸‹åªéœ€è¦é”ä½æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå°±å¯ä»¥é¿å…è¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ select for update, select in share mode; RRéš”ç¦»ä¸‹ä½¿ç”¨MVCCå®ç°å¯é‡å¤è¯»ï¼› å¯¹äºåè€…, è¦é”ä½æ»¡è¶³æ¡ä»¶çš„è®°å½•åŠæ‰€æœ‰è¿™äº›è®°å½•ä¹‹é—´çš„gapï¼Œä¹Ÿå°±æ˜¯éœ€è¦ gap lockã€‚ è€ŒANSI SQLæ ‡å‡†æ²¡æœ‰ä»éš”ç¦»ç¨‹åº¦è¿›è¡Œå®šä¹‰ï¼Œè€Œæ˜¯å®šä¹‰äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸åŒäº‹åŠ¡éš”ç¦»çº§åˆ«è§£å†³çš„ä¸‰å¤§å¹¶å‘é—®é¢˜ï¼š Isolation Level Dirty Read Unrepeatable Read Phantom Read Read UNCOMMITTED YES YES YES READ COMMITTED NO YES YES READ REPEATABLE NO NO YES SERIALIZABLE NO NO NO MySQL ä¸­RCå’ŒRRéš”ç¦»çº§åˆ«çš„åŒºåˆ«MySQLæ•°æ®åº“ä¸­é»˜è®¤éš”ç¦»çº§åˆ«ä¸ºRRï¼Œä½†æ˜¯å®é™…æƒ…å†µæ˜¯ä½¿ç”¨RC å’Œ RRéš”ç¦»çº§åˆ«çš„éƒ½ä¸å°‘ã€‚å¥½åƒæ·˜å®ã€ç½‘æ˜“éƒ½æ˜¯ä½¿ç”¨çš„ RC éš”ç¦»çº§åˆ«ã€‚é‚£ä¹ˆåœ¨MySQLä¸­ RC å’Œ RRæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ‘ä»¬è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿä¸ºä»€ä¹ˆMySQLå°†RRä½œä¸ºé»˜è®¤çš„éš”ç¦»çº§åˆ«å‘¢ï¼ŸRC ä¸ RR åœ¨é”æ–¹é¢çš„åŒºåˆ« æ˜¾ç„¶ RR æ”¯æŒ gap lock(next-key lock)ï¼Œè€ŒRCåˆ™æ²¡æœ‰gap lockã€‚å› ä¸ºMySQLçš„RRéœ€è¦gap lockæ¥è§£å†³å¹»è¯»é—®é¢˜ã€‚è€ŒRCéš”ç¦»çº§åˆ«åˆ™æ˜¯å…è®¸å­˜åœ¨ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„ã€‚æ‰€ä»¥RCçš„å¹¶å‘ä¸€èˆ¬è¦å¥½äºRRï¼› RC éš”ç¦»çº§åˆ«ï¼Œé€šè¿‡ where æ¡ä»¶è¿‡æ»¤ä¹‹åï¼Œä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ä¸Šçš„è¡Œé”ï¼Œä¼šé‡Šæ”¾æ‰(è™½ç„¶è¿™é‡Œç ´åäº†â€œä¸¤é˜¶æ®µåŠ é”åŸåˆ™â€)ï¼›ä½†æ˜¯RRéš”ç¦»çº§åˆ«ï¼Œå³ä½¿ä¸ç¬¦åˆwhereæ¡ä»¶çš„è®°å½•ï¼Œä¹Ÿä¸ä¼šæ˜¯å¦è¡Œé”å’Œgap lockï¼›æ‰€ä»¥ä»é”æ–¹é¢æ¥çœ‹ï¼ŒRCçš„å¹¶å‘åº”è¯¥è¦å¥½äºRRï¼›å¦å¤– insert into t select â€¦ from s where è¯­å¥åœ¨sè¡¨ä¸Šçš„é”ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡Aï¼ŒBæ‰§è¡Œçš„æ—¶é—´åºåˆ—å¦‚ä¸‹(Aå…ˆäºBå¼€å§‹ï¼ŒBå…ˆäºAç»“æŸ)1234567A1: start transaction;B1: start transaction;A2: select * from t;B2: insert into t values (4, wangwu);A3: select * from t;B3: commit;A4: select * from t; 123456789101112æé—®1ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»RRï¼Œäº‹åŠ¡Aä¸­çš„ä¸‰æ¬¡æŸ¥è¯¢ï¼ŒA2, A3, A4åˆ†åˆ«è¯»åˆ°ä»€ä¹ˆç»“æœé›†ï¼Ÿå›ç­”ï¼šRRä¸‹(1)A2è¯»åˆ°çš„ç»“æœé›†è‚¯å®šæ˜¯{1, 2, 3}ï¼Œè¿™æ˜¯äº‹åŠ¡Açš„ç¬¬ä¸€ä¸ªreadï¼Œå‡è®¾ä¸ºæ—¶é—´Tï¼›(2)A3è¯»åˆ°çš„ç»“æœé›†ä¹Ÿæ˜¯{1, 2, 3}ï¼Œå› ä¸ºBè¿˜æ²¡æœ‰æäº¤ï¼›(3)A4è¯»åˆ°çš„ç»“æœé›†è¿˜æ˜¯{1, 2, 3}ï¼Œå› ä¸ºäº‹åŠ¡Bæ˜¯åœ¨æ—¶é—´Tä¹‹åæäº¤çš„ï¼ŒA4å¾—è¯»åˆ°å’ŒA2ä¸€æ ·çš„è®°å½•ï¼›æé—®2ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯è¯»æäº¤RCï¼ŒA2, A3, A4åˆåˆ†åˆ«è¯»åˆ°ä»€ä¹ˆç»“æœé›†å‘¢ï¼Ÿå›ç­”ï¼šRCä¸‹(1)A2è¯»åˆ°çš„ç»“æœé›†æ˜¯{1, 2, 3}ï¼›(2)A3è¯»åˆ°çš„ç»“æœé›†ä¹Ÿæ˜¯{1, 2, 3}ï¼Œå› ä¸ºBè¿˜æ²¡æœ‰æäº¤ï¼›(3)A4è¯»åˆ°çš„ç»“æœé›†è¿˜æ˜¯{1, 2, 3, 4}ï¼Œå› ä¸ºäº‹åŠ¡Bå·²ç»æäº¤ ä»ç„¶æ˜¯ä¸Šé¢çš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œåªæ˜¯Aå’ŒBå¼€å§‹æ—¶é—´ç¨æœ‰ä¸åŒ(Bå…ˆäºAå¼€å§‹ï¼ŒBå…ˆäºAç»“æŸ)12345678910111213B1: start transaction;A1: start transaction;A2: select * from t;B2: insert into t values (4, wangwu);A3: select * from t;B3: commit;A4: select * from t;æé—®3ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»RRï¼Œäº‹åŠ¡Aä¸­çš„ä¸‰æ¬¡æŸ¥è¯¢ï¼ŒA2, A3, A4åˆ†åˆ«è¯»åˆ°ä»€ä¹ˆç»“æœé›†ï¼Ÿæé—®4ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯è¯»æäº¤RCï¼ŒA2, A3, A4çš„ç»“æœé›†åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå›ç­”ï¼šäº‹åŠ¡çš„å¼€å§‹æ—¶é—´ä¸ä¸€æ ·ï¼Œä¸ä¼šå½±å“â€œå¿«ç…§è¯»â€çš„ç»“æœï¼Œæ‰€ä»¥ç»“æœé›†å’Œcase 1ä¸€æ ·ã€‚ ä»ç„¶æ˜¯å¹¶å‘çš„äº‹åŠ¡Aä¸B(Aå…ˆäºBå¼€å§‹ï¼ŒBå…ˆäºAç»“æŸ)12345678910A1: start transaction;B1: start transaction;B2: insert into t values (4, wangwu);B3: commit;A2: select * from t;æé—®5ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»RRï¼Œäº‹åŠ¡Aä¸­çš„A2æŸ¥è¯¢ï¼Œç»“æœé›†æ˜¯ä»€ä¹ˆï¼Ÿæé—®6ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯è¯»æäº¤RCï¼ŒA2çš„ç»“æœé›†åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå›ç­”ï¼šåœ¨RRä¸‹ï¼ŒA2æ˜¯äº‹åŠ¡Açš„ç¬¬ä¸€ä¸ªreadï¼Œå‡è®¾ä¸ºæ—¶é—´Tï¼Œå®ƒèƒ½è¯»å–åˆ°Tä¹‹å‰æäº¤äº‹åŠ¡å†™å…¥çš„æ•°æ®è¡Œï¼Œæ•…ç»“æœé›†ä¸º{1, 2, 3, 4}ã€‚åœ¨RCä¸‹ï¼Œæ²¡æœ‰ç–‘é—®ï¼Œä¸€å®šæ˜¯{1, 2, 3, 4}ã€‚ äº‹åŠ¡å¼€å§‹çš„æ—¶é—´å†æ¢ä¸€ä¸‹(Bå…ˆäºAå¼€å§‹ï¼ŒBå…ˆäºAç»“æŸ)12345678910B1: start transaction;A1: start transaction;B2: insert into t values (4, wangwu);B3: commit;A2: select * from t;æé—®7ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»RRï¼Œäº‹åŠ¡Aä¸­çš„A2æŸ¥è¯¢ï¼Œç»“æœé›†æ˜¯ä»€ä¹ˆï¼Ÿæé—®8ï¼šå‡è®¾äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯è¯»æäº¤RCï¼ŒA2çš„ç»“æœé›†åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå›ç­”ï¼šäº‹åŠ¡çš„å¼€å§‹æ—¶é—´ä¸ä¸€æ ·ï¼Œä¸ä¼šå½±å“â€œå¿«ç…§è¯»â€çš„ç»“æœï¼Œæ‰€ä»¥ç»“æœé›†å’Œcase 3ä¸€æ ·ã€‚ æ€»ç»“ï¼š RRä¸‹ï¼Œäº‹åŠ¡åœ¨ç¬¬ä¸€ä¸ªReadæ“ä½œæ—¶ï¼Œä¼šå»ºç«‹Read View RCä¸‹ï¼Œäº‹åŠ¡åœ¨æ¯æ¬¡Readæ“ä½œæ—¶ï¼Œéƒ½ä¼šå»ºç«‹Read View æ€ä¹ˆé’ˆå¯¹æ•°æ®åº“ä¸­æŸä¸€å¼ è¡¨ä¸­çš„ä¸€æ¡æ•°æ®ä¸Šé”ï¼Ÿç­”ï¼š12mysql> SELECT * FROM T1 WHERE ID = 1 FOR UPDATE;mysql> SELECT * FROM T1 WHERE ID = 1 LOCK IN SHARE MODE; è¡Œé”çš„ä¸‰ç§æ¨¡å¼ï¼Œè®²è®²æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šInnoDBæœ‰ä¸‰ç§è¡Œé”çš„ç®—æ³•ï¼š Record Lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”ã€‚ Gap Lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†ä¸åŒ…æ‹¬è®°å½•æœ¬èº«ã€‚GAPé”çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åŒä¸€äº‹åŠ¡çš„ä¸¤æ¬¡å½“å‰è¯»ï¼Œå‡ºç°å¹»è¯»çš„æƒ…å†µã€‚ Next-Key Lockï¼š1+2ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«ã€‚å¯¹äºè¡Œçš„æŸ¥è¯¢ï¼Œéƒ½æ˜¯é‡‡ç”¨è¯¥æ–¹æ³•ï¼Œä¸»è¦ç›®çš„æ˜¯è§£å†³å¹»è¯»çš„é—®é¢˜ã€‚ innobackupexåŸç†è¯´ä¸€ä¸‹ç­”ï¼š innobackupex åœ¨å¯åŠ¨åï¼Œä¼šå…ˆ fork ä¸€ä¸ªè¿›ç¨‹ï¼Œå¯åŠ¨ xtrabackupè¿›ç¨‹ï¼Œç„¶åå°±ç­‰å¾… xtrabackup å¤‡ä»½å®Œ ibd æ•°æ®æ–‡ä»¶ï¼› xtrabackup åœ¨å¤‡ä»½ InnoDB ç›¸å…³æ•°æ®æ—¶ï¼Œæ˜¯æœ‰2ç§çº¿ç¨‹çš„ï¼Œ1ç§æ˜¯ redo æ‹·è´çº¿ç¨‹ï¼Œè´Ÿè´£æ‹·è´ redo æ–‡ä»¶ï¼Œ1ç§æ˜¯ ibd æ‹·è´çº¿ç¨‹ï¼Œè´Ÿè´£æ‹·è´ ibd æ–‡ä»¶ï¼›redo æ‹·è´çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œåœ¨ ibd æ‹·è´çº¿ç¨‹ä¹‹å‰å¯åŠ¨ï¼Œåœ¨ ibd çº¿ç¨‹ç»“æŸåç»“æŸã€‚xtrabackup è¿›ç¨‹å¼€å§‹æ‰§è¡Œåï¼Œå…ˆå¯åŠ¨ redo æ‹·è´çº¿ç¨‹ï¼Œä»æœ€æ–°çš„ checkpoint ç‚¹å¼€å§‹é¡ºåºæ‹·è´ redo æ—¥å¿—ï¼›ç„¶åå†å¯åŠ¨ ibd æ•°æ®æ‹·è´çº¿ç¨‹ï¼Œåœ¨ xtrabackup æ‹·è´ ibd è¿‡ç¨‹ä¸­ï¼Œinnobackupex è¿›ç¨‹ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆç­‰å¾…æ–‡ä»¶è¢«åˆ›å»ºï¼‰ã€‚ xtrabackup æ‹·è´å®Œæˆidbåï¼Œé€šçŸ¥ innobackupexï¼ˆé€šè¿‡åˆ›å»ºæ–‡ä»¶ï¼‰ï¼ŒåŒæ—¶è‡ªå·±è¿›å…¥ç­‰å¾…ï¼ˆredo çº¿ç¨‹ä»ç„¶ç»§ç»­æ‹·è´ï¼‰; innobackupex æ”¶åˆ° xtrabackup é€šçŸ¥åï¼Œæ‰§è¡ŒFLUSH TABLES WITH READ LOCK (FTWRL)ï¼Œå–å¾—ä¸€è‡´æ€§ä½ç‚¹ï¼Œç„¶åå¼€å§‹å¤‡ä»½é InnoDB æ–‡ä»¶ï¼ˆåŒ…æ‹¬ frmã€MYDã€MYIã€CSVã€optã€parç­‰ï¼‰ã€‚æ‹·è´é InnoDB æ–‡ä»¶è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæ•°æ®åº“å¤„äºå…¨å±€åªè¯»çŠ¶æ€ï¼Œå¦‚æœåœ¨ä¸šåŠ¡çš„ä¸»åº“å¤‡ä»½çš„è¯ï¼Œè¦ç‰¹åˆ«å°å¿ƒï¼Œé InnoDB è¡¨ï¼ˆä¸»è¦æ˜¯MyISAMï¼‰æ¯”è¾ƒå¤šçš„è¯æ•´åº“åªè¯»æ—¶é—´å°±ä¼šæ¯”è¾ƒé•¿ï¼Œè¿™ä¸ªå½±å“ä¸€å®šè¦è¯„ä¼°åˆ°ã€‚ å½“ innobackupex æ‹·è´å®Œæ‰€æœ‰é InnoDB è¡¨æ–‡ä»¶åï¼Œé€šçŸ¥ xtrabackupï¼ˆé€šè¿‡åˆ æ–‡ä»¶ï¼‰ ï¼ŒåŒæ—¶è‡ªå·±è¿›å…¥ç­‰å¾…ï¼ˆç­‰å¾…å¦ä¸€ä¸ªæ–‡ä»¶è¢«åˆ›å»ºï¼‰ï¼› xtrabackup æ”¶åˆ° innobackupex å¤‡ä»½å®Œé InnoDB é€šçŸ¥åï¼Œå°±åœæ­¢ redo æ‹·è´çº¿ç¨‹ï¼Œç„¶åé€šçŸ¥ innobackupexredo log æ‹·è´å®Œæˆï¼ˆé€šè¿‡åˆ›å»ºæ–‡ä»¶ï¼‰ï¼› innobackupex æ”¶åˆ° redo å¤‡ä»½å®Œæˆé€šçŸ¥åï¼Œå°±å¼€å§‹è§£é”ï¼Œæ‰§è¡Œ UNLOCK TABLESï¼› æœ€å innobackupex å’Œ xtrabackup è¿›ç¨‹å„è‡ªå®Œæˆæ”¶å°¾å·¥ä½œï¼Œå¦‚èµ„æºçš„é‡Šæ”¾ã€å†™å¤‡ä»½å…ƒæ•°æ®ä¿¡æ¯ç­‰ï¼Œinnobackupex ç­‰å¾… xtrabackup å­è¿›ç¨‹ç»“æŸåé€€å‡ºã€‚ åœ¨ä¸Šé¢æè¿°çš„æ–‡ä»¶æ‹·è´ï¼Œéƒ½æ˜¯å¤‡ä»½è¿›ç¨‹ç›´æ¥é€šè¿‡æ“ä½œç³»ç»Ÿè¯»å–æ•°æ®æ–‡ä»¶çš„ï¼Œåªåœ¨æ‰§è¡Œ SQL å‘½ä»¤æ—¶å’Œæ•°æ®åº“æœ‰äº¤äº’ï¼ŒåŸºæœ¬ä¸å½±å“æ•°æ®åº“çš„è¿è¡Œï¼Œåœ¨å¤‡ä»½é InnoDB æ—¶ä¼šæœ‰ä¸€æ®µæ—¶é—´åªè¯»ï¼ˆå¦‚æœæ²¡æœ‰MyISAMè¡¨çš„è¯ï¼Œåªè¯»æ—¶é—´åœ¨å‡ ç§’å·¦å³ï¼‰ï¼Œåœ¨å¤‡ä»½ InnoDB æ•°æ®æ–‡ä»¶æ—¶ï¼Œå¯¹æ•°æ®åº“å®Œå…¨æ²¡æœ‰å½±å“ï¼Œæ˜¯çœŸæ­£çš„çƒ­å¤‡ã€‚InnoDB å’Œé InnoDB æ–‡ä»¶çš„å¤‡ä»½éƒ½æ˜¯é€šè¿‡æ‹·è´æ–‡ä»¶æ¥åšçš„ï¼Œä½†æ˜¯å®ç°çš„æ–¹å¼ä¸åŒï¼Œå‰è€…æ˜¯ä»¥pageä¸ºç²’åº¦åšçš„(xtrabackup)ï¼Œåè€…æ˜¯ cp æˆ–è€… tar å‘½ä»¤(innobackupex)ï¼Œxtrabackup åœ¨è¯»å–æ¯ä¸ªpageæ—¶ä¼šæ ¡éªŒ checksum å€¼ï¼Œä¿è¯æ•°æ®å—æ˜¯ä¸€è‡´çš„ï¼Œè€Œ innobackupex åœ¨ cp MyISAM æ–‡ä»¶æ—¶å·²ç»åšäº†flushï¼ˆFTWRLï¼‰ï¼Œç£ç›˜ä¸Šçš„æ–‡ä»¶ä¹Ÿæ˜¯å®Œæ•´çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå¤‡ä»½é›†é‡Œçš„æ•°æ®æ–‡ä»¶éƒ½æ˜¯å†™å…¥å®Œæ•´çš„ã€‚ å¯¹NoSQLæœ‰äº†è§£å—ï¼ŸmongoDBå‰¯æœ¬é›†é€‰ä¸¾æµç¨‹ä»€ä¹ˆï¼Ÿç­”ï¼šMongodbå¤åˆ¶é›†ç”±ä¸€ç»„Mongodå®ä¾‹ï¼ˆè¿›ç¨‹ï¼‰ç»„æˆï¼ŒåŒ…å«ä¸€ä¸ªPrimaryèŠ‚ç‚¹å’Œå¤šä¸ªSecondaryèŠ‚ç‚¹ï¼ŒMongodb Driverï¼ˆå®¢æˆ·ç«¯ï¼‰çš„æ‰€æœ‰æ•°æ®éƒ½å†™å…¥Primaryï¼ŒSecondaryä»PrimaryåŒæ­¥å†™å…¥çš„æ•°æ®ï¼Œä»¥ä¿æŒå¤åˆ¶é›†å†…æ‰€æœ‰æˆå‘˜å­˜å‚¨ç›¸åŒçš„æ•°æ®é›†ï¼Œæä¾›æ•°æ®çš„é«˜å¯ç”¨ã€‚ Primaryé€‰ä¸¾ å¤åˆ¶é›†é€šè¿‡replSetInitiateå‘½ä»¤ï¼ˆæˆ–mongo shellçš„rs.initiate()ï¼‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–åå„ä¸ªæˆå‘˜é—´å¼€å§‹å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¹¶å‘èµ·Priamryé€‰ä¸¾æ“ä½œï¼Œè·å¾—ã€å¤§å¤šæ•°ã€æˆå‘˜æŠ•ç¥¨æ”¯æŒçš„èŠ‚ç‚¹ï¼Œä¼šæˆä¸ºPrimaryï¼Œå…¶ä½™èŠ‚ç‚¹æˆä¸ºSecondaryã€‚ å¤§å¤šæ•°ã€çš„å®šä¹‰ å‡è®¾å¤åˆ¶é›†å†…æŠ•ç¥¨æˆå‘˜ï¼ˆåç»­ä»‹ç»ï¼‰æ•°é‡ä¸ºNï¼Œåˆ™å¤§å¤šæ•°ä¸º N/2 + 1ï¼Œå½“å¤åˆ¶é›†å†…å­˜æ´»æˆå‘˜æ•°é‡ä¸è¶³å¤§å¤šæ•°æ—¶ï¼Œæ•´ä¸ªå¤åˆ¶é›†å°†æ— æ³•é€‰ä¸¾å‡ºPrimaryï¼Œå¤åˆ¶é›†å°†æ— æ³•æä¾›å†™æœåŠ¡ï¼Œå¤„äºåªè¯»çŠ¶æ€ã€‚ ç‰¹æ®Šçš„Secondary æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤åˆ¶é›†çš„Seconaryä¼šå‚ä¸Primaryé€‰ä¸¾ï¼ˆè‡ªèº«ä¹Ÿå¯èƒ½ä¼šè¢«é€‰ä¸ºPrimaryï¼‰ï¼Œå¹¶ä»PrimaryåŒæ­¥æœ€æ–°å†™å…¥çš„æ•°æ®ï¼Œä»¥ä¿è¯ä¸Primaryå­˜å‚¨ç›¸åŒçš„æ•°æ®ã€‚ Secondaryå¯ä»¥æä¾›è¯»æœåŠ¡ï¼Œå¢åŠ SecondaryèŠ‚ç‚¹å¯ä»¥æä¾›å¤åˆ¶é›†çš„è¯»æœåŠ¡èƒ½åŠ›ï¼ŒåŒæ—¶æå‡å¤åˆ¶é›†çš„å¯ç”¨æ€§ã€‚å¦å¤–ï¼ŒMongodbæ”¯æŒå¯¹å¤åˆ¶é›†çš„SecondaryèŠ‚ç‚¹è¿›è¡Œçµæ´»çš„é…ç½®ï¼Œä»¥é€‚åº”å¤šç§åœºæ™¯çš„éœ€æ±‚ã€‚ ç‰¹æ®Šçš„Secondary æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤åˆ¶é›†çš„Seconaryä¼šå‚ä¸Primaryé€‰ä¸¾ï¼ˆè‡ªèº«ä¹Ÿå¯èƒ½ä¼šè¢«é€‰ä¸ºPrimaryï¼‰ï¼Œå¹¶ä»PrimaryåŒæ­¥æœ€æ–°å†™å…¥çš„æ•°æ®ï¼Œä»¥ä¿è¯ä¸Primaryå­˜å‚¨ç›¸åŒçš„æ•°æ®ã€‚ Secondaryå¯ä»¥æä¾›è¯»æœåŠ¡ï¼Œå¢åŠ SecondaryèŠ‚ç‚¹å¯ä»¥æä¾›å¤åˆ¶é›†çš„è¯»æœåŠ¡èƒ½åŠ›ï¼ŒåŒæ—¶æå‡å¤åˆ¶é›†çš„å¯ç”¨æ€§ã€‚å¦å¤–ï¼ŒMongodbæ”¯æŒå¯¹å¤åˆ¶é›†çš„SecondaryèŠ‚ç‚¹è¿›è¡Œçµæ´»çš„é…ç½®ï¼Œä»¥é€‚åº”å¤šç§åœºæ™¯çš„éœ€æ±‚ Arbiter ArbiterèŠ‚ç‚¹åªå‚ä¸æŠ•ç¥¨ï¼Œä¸èƒ½è¢«é€‰ä¸ºPrimaryï¼Œå¹¶ä¸”ä¸ä»PrimaryåŒæ­¥æ•°æ®ã€‚ æ¯”å¦‚ä½ éƒ¨ç½²äº†ä¸€ä¸ª2ä¸ªèŠ‚ç‚¹çš„å¤åˆ¶é›†ï¼Œ1ä¸ªPrimaryï¼Œ1ä¸ªSecondaryï¼Œä»»æ„èŠ‚ç‚¹å®•æœºï¼Œå¤åˆ¶é›†å°†ä¸èƒ½æä¾›æœåŠ¡äº†ï¼ˆæ— æ³•é€‰å‡ºPrimaryï¼‰ï¼Œè¿™æ—¶å¯ä»¥ç»™å¤åˆ¶é›†æ·»åŠ ä¸€ä¸ªArbiterèŠ‚ç‚¹ï¼Œå³ä½¿æœ‰èŠ‚ç‚¹å®•æœºï¼Œä»èƒ½é€‰å‡ºPrimaryã€‚ Arbiteræœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ˜¯éå¸¸è½»é‡çº§çš„æœåŠ¡ï¼Œå½“å¤åˆ¶é›†æˆå‘˜ä¸ºå¶æ•°æ—¶ï¼Œæœ€å¥½åŠ å…¥ä¸€ä¸ªArbiterèŠ‚ç‚¹ï¼Œä»¥æå‡å¤åˆ¶é›†å¯ç”¨æ€§ã€‚ Priority0 Priority0èŠ‚ç‚¹çš„é€‰ä¸¾ä¼˜å…ˆçº§ä¸º0ï¼Œä¸ä¼šè¢«é€‰ä¸¾ä¸ºPrimaryã€‚ æ¯”å¦‚ä½ è·¨æœºæˆ¿Aã€Béƒ¨ç½²äº†ä¸€ä¸ªå¤åˆ¶é›†ï¼Œå¹¶ä¸”æƒ³æŒ‡å®šPrimaryå¿…é¡»åœ¨Aæœºæˆ¿ï¼Œè¿™æ—¶å¯ä»¥å°†Bæœºæˆ¿çš„å¤åˆ¶é›†æˆå‘˜Priorityè®¾ç½®ä¸º0ï¼Œè¿™æ ·Primaryå°±ä¸€å®šä¼šæ˜¯Aæœºæˆ¿çš„æˆå‘˜ã€‚ï¼ˆæ³¨æ„ï¼šå¦‚æœè¿™æ ·éƒ¨ç½²ï¼Œæœ€å¥½å°†ã€å¤§å¤šæ•°ã€èŠ‚ç‚¹éƒ¨ç½²åœ¨Aæœºæˆ¿ï¼Œå¦åˆ™ç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½æ— æ³•é€‰å‡ºPrimaryï¼‰ Vote0 Mongodb 3.0é‡Œï¼Œå¤åˆ¶é›†æˆå‘˜æœ€å¤š50ä¸ªï¼Œå‚ä¸Primaryé€‰ä¸¾æŠ•ç¥¨çš„æˆå‘˜æœ€å¤š7ä¸ªï¼Œå…¶ä»–æˆå‘˜ï¼ˆVote0ï¼‰çš„voteå±æ€§å¿…é¡»è®¾ç½®ä¸º0ï¼Œå³ä¸å‚ä¸æŠ•ç¥¨ã€‚ Hidden HiddenèŠ‚ç‚¹ä¸èƒ½è¢«é€‰ä¸ºä¸»ï¼ˆPriorityä¸º0ï¼‰ï¼Œå¹¶ä¸”å¯¹Driverä¸å¯è§ã€‚ å› HiddenèŠ‚ç‚¹ä¸ä¼šæ¥å—Driverçš„è¯·æ±‚ï¼Œå¯ä½¿ç”¨HiddenèŠ‚ç‚¹åšä¸€äº›æ•°æ®å¤‡ä»½ã€ç¦»çº¿è®¡ç®—çš„ä»»åŠ¡ï¼Œä¸ä¼šå½±å“å¤åˆ¶é›†çš„æœåŠ¡ã€‚ Delayed DelayedèŠ‚ç‚¹å¿…é¡»æ˜¯HiddenèŠ‚ç‚¹ï¼Œå¹¶ä¸”å…¶æ•°æ®è½åä¸Primaryä¸€æ®µæ—¶é—´ï¼ˆå¯é…ç½®ï¼Œæ¯”å¦‚1ä¸ªå°æ—¶ï¼‰ã€‚ å› DelayedèŠ‚ç‚¹çš„æ•°æ®æ¯”Primaryè½åä¸€æ®µæ—¶é—´ï¼Œå½“é”™è¯¯æˆ–è€…æ— æ•ˆçš„æ•°æ®å†™å…¥Primaryæ—¶ï¼Œå¯é€šè¿‡DelayedèŠ‚ç‚¹çš„æ•°æ®æ¥æ¢å¤åˆ°ä¹‹å‰çš„æ—¶é—´ç‚¹ã€‚ æ•°æ®åŒæ­¥ Primaryä¸Secondaryä¹‹é—´é€šè¿‡oplogæ¥åŒæ­¥æ•°æ®ï¼ŒPrimaryä¸Šçš„å†™æ“ä½œå®Œæˆåï¼Œä¼šå‘ç‰¹æ®Šçš„local.oplog.rsç‰¹æ®Šé›†åˆå†™å…¥ä¸€æ¡oplogï¼ŒSecondaryä¸æ–­çš„ä»Primaryå–æ–°çš„oplogå¹¶åº”ç”¨ã€‚ å› oplogçš„æ•°æ®ä¼šä¸æ–­å¢åŠ ï¼Œlocal.oplog.rsè¢«è®¾ç½®æˆä¸ºä¸€ä¸ªcappedé›†åˆï¼Œå½“å®¹é‡è¾¾åˆ°é…ç½®ä¸Šé™æ—¶ï¼Œä¼šå°†æœ€æ—§çš„æ•°æ®åˆ é™¤æ‰ã€‚å¦å¤–è€ƒè™‘åˆ°oplogåœ¨Secondaryä¸Šå¯èƒ½é‡å¤åº”ç”¨ï¼Œoplogå¿…é¡»å…·æœ‰å¹‚ç­‰æ€§ï¼Œå³é‡å¤åº”ç”¨ä¹Ÿä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚ oplogé‡Œå„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ tsï¼š æ“ä½œæ—¶é—´ï¼Œå½“å‰timestamp + è®¡æ•°å™¨ï¼Œè®¡æ•°å™¨æ¯ç§’éƒ½è¢«é‡ç½® hï¼šæ“ä½œçš„å…¨å±€å”¯ä¸€æ ‡è¯† vï¼šoplogç‰ˆæœ¬ä¿¡æ¯ opï¼šæ“ä½œç±»å‹ iï¼šæ’å…¥æ“ä½œ uï¼šæ›´æ–°æ“ä½œ dï¼šåˆ é™¤æ“ä½œ cï¼šæ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚createDatabaseï¼ŒdropDatabaseï¼‰ nï¼šç©ºæ“ä½œï¼Œç‰¹æ®Šç”¨é€” nsï¼šæ“ä½œé’ˆå¯¹çš„é›†åˆ oï¼šæ“ä½œå†…å®¹ï¼Œå¦‚æœæ˜¯æ›´æ–°æ“ä½œ o2ï¼šæ“ä½œæŸ¥è¯¢æ¡ä»¶ï¼Œä»…updateæ“ä½œåŒ…å«è¯¥å­—æ®µSecondaryåˆæ¬¡åŒæ­¥æ•°æ®æ—¶ï¼Œä¼šå…ˆè¿›è¡Œinit syncï¼Œä»Primaryï¼ˆæˆ–å…¶ä»–æ•°æ®æ›´æ–°çš„Secondaryï¼‰åŒæ­¥å…¨é‡æ•°æ®ï¼Œç„¶åä¸æ–­é€šè¿‡tailable cursorä»Primaryçš„local.oplog.rsé›†åˆé‡ŒæŸ¥è¯¢æœ€æ–°çš„oplogå¹¶åº”ç”¨åˆ°è‡ªèº«ã€‚ T1æ—¶é—´ï¼Œä»PrimaryåŒæ­¥æ‰€æœ‰æ•°æ®åº“çš„æ•°æ®ï¼ˆlocalé™¤å¤–ï¼‰ï¼Œé€šè¿‡listDatabases + listCollections + cloneCollectionæ•å‘½ä»¤ç»„åˆå®Œæˆï¼Œå‡è®¾T2æ—¶é—´å®Œæˆæ‰€æœ‰æ“ä½œã€‚ ä»Primaryåº”ç”¨[T1-T2]æ—¶é—´æ®µå†…çš„æ‰€æœ‰oplogï¼Œå¯èƒ½éƒ¨åˆ†æ“ä½œå·²ç»åŒ…å«åœ¨æ­¥éª¤1ï¼Œä½†ç”±äºoplogçš„å¹‚ç­‰æ€§ï¼Œå¯é‡å¤åº”ç”¨ã€‚ æ ¹æ®Primaryå„é›†åˆçš„indexè®¾ç½®ï¼Œåœ¨Secondaryä¸Šä¸ºç›¸åº”é›†åˆåˆ›å»ºindexã€‚ï¼ˆæ¯ä¸ªé›†åˆ_idçš„indexå·²åœ¨æ­¥éª¤1ä¸­å®Œæˆï¼‰ã€‚ oplogé›†åˆçš„å¤§å°åº”æ ¹æ®DBè§„æ¨¡åŠåº”ç”¨å†™å…¥éœ€æ±‚åˆç†é…ç½®ï¼Œé…ç½®å¾—å¤ªå¤§ï¼Œä¼šé€ æˆå­˜å‚¨ç©ºé—´çš„æµªè´¹ï¼›é…ç½®å¾—å¤ªå°ï¼Œå¯èƒ½é€ æˆSecondaryçš„init syncä¸€ç›´æ— æ³•æˆåŠŸã€‚æ¯”å¦‚åœ¨æ­¥éª¤1é‡Œç”±äºDBæ•°æ®å¤ªå¤šã€å¹¶ä¸”oplogé…ç½®å¤ªå°ï¼Œå¯¼è‡´oplogä¸è¶³ä»¥å­˜å‚¨[T1, T2]æ—¶é—´å†…çš„æ‰€æœ‰oplogï¼Œè¿™å°±Secondaryæ— æ³•ä»Primaryä¸ŠåŒæ­¥å®Œæ•´çš„æ•°æ®é›†ã€‚ç»†è¯´Primaryé€‰ä¸¾Primaryé€‰ä¸¾é™¤äº†åœ¨å¤åˆ¶é›†åˆå§‹åŒ–æ—¶å‘ç”Ÿï¼Œè¿˜æœ‰å¦‚ä¸‹åœºæ™¯ å¤åˆ¶é›†è¢«reconfig SecondaryèŠ‚ç‚¹æ£€æµ‹åˆ°Primaryå®•æœºæ—¶ï¼Œä¼šè§¦å‘æ–°Primaryçš„é€‰ä¸¾ å½“æœ‰PrimaryèŠ‚ç‚¹ä¸»åŠ¨stepDownï¼ˆä¸»åŠ¨é™çº§ä¸ºSecondaryï¼‰æ—¶ï¼Œä¹Ÿä¼šè§¦å‘æ–°çš„Primaryé€‰ä¸¾Primaryçš„é€‰ä¸¾å—èŠ‚ç‚¹é—´å¿ƒè·³ã€ä¼˜å…ˆçº§ã€æœ€æ–°çš„oplogæ—¶é—´ç­‰å¤šç§å› ç´ å½±å“ã€‚èŠ‚ç‚¹é—´å¿ƒè·³å¤åˆ¶é›†æˆå‘˜é—´é»˜è®¤æ¯2sä¼šå‘é€ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯ï¼Œå¦‚æœ10sæœªæ”¶åˆ°æŸä¸ªèŠ‚ç‚¹çš„å¿ƒè·³ï¼Œåˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹å·²å®•æœºï¼›å¦‚æœå®•æœºçš„èŠ‚ç‚¹ä¸ºPrimaryï¼ŒSecondaryï¼ˆå‰ææ˜¯å¯è¢«é€‰ä¸ºPrimaryï¼‰ä¼šå‘èµ·æ–°çš„Primaryé€‰ä¸¾ã€‚èŠ‚ç‚¹ä¼˜å…ˆçº§ æ¯ä¸ªèŠ‚ç‚¹éƒ½å€¾å‘äºæŠ•ç¥¨ç»™ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ ä¼˜å…ˆçº§ä¸º0çš„èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨å‘èµ·Primaryé€‰ä¸¾ å½“Primaryå‘ç°æœ‰ä¼˜å…ˆçº§æ›´é«˜Secondaryï¼Œå¹¶ä¸”è¯¥Secondaryçš„æ•°æ®è½ååœ¨10så†…ï¼Œåˆ™Primaryä¼šä¸»åŠ¨é™çº§ï¼Œè®©ä¼˜å…ˆçº§æ›´é«˜çš„Secondaryæœ‰æˆä¸ºPrimaryçš„æœºä¼šã€‚Optime æ‹¥æœ‰æœ€æ–°optimeï¼ˆæœ€è¿‘ä¸€æ¡oplogçš„æ—¶é—´æˆ³ï¼‰çš„èŠ‚ç‚¹æ‰èƒ½è¢«é€‰ä¸ºä¸»ã€‚ ç½‘ç»œåˆ†åŒº åªæœ‰æ›´å¤§å¤šæ•°æŠ•ç¥¨èŠ‚ç‚¹é—´ä¿æŒç½‘ç»œè¿é€šï¼Œæ‰æœ‰æœºä¼šè¢«é€‰Primaryï¼›å¦‚æœPrimaryä¸å¤§å¤šæ•°çš„èŠ‚ç‚¹æ–­å¼€è¿æ¥ï¼ŒPrimaryä¼šä¸»åŠ¨é™çº§ä¸ºSecondaryã€‚å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºæ—¶ï¼Œå¯èƒ½åœ¨çŸ­æ—¶é—´å†…å‡ºç°å¤šä¸ªPrimaryï¼Œæ•…Driveråœ¨å†™å…¥æ—¶ï¼Œæœ€å¥½è®¾ç½®ã€å¤§å¤šæ•°æˆåŠŸã€çš„ç­–ç•¥ï¼Œè¿™æ ·å³ä½¿å‡ºç°å¤šä¸ªPrimaryï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªPrimaryèƒ½æˆåŠŸå†™å…¥å¤§å¤šæ•°ã€‚ è¯´è¯´TCPåè®®æµç¨‹ç­”ï¼š å­—æ®µ å«ä¹‰ URG ç´§æ€¥æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆã€‚ä¸º1ï¼Œè¡¨ç¤ºæŸä¸€ä½éœ€è¦è¢«ä¼˜å…ˆå¤„ç† ACK ç¡®è®¤å·æ˜¯å¦æœ‰æ•ˆï¼Œä¸€èˆ¬ç½®ä¸º1ã€‚ PSH æç¤ºæ¥æ”¶ç«¯åº”ç”¨ç¨‹åºç«‹å³ä»TCPç¼“å†²åŒºæŠŠæ•°æ®è¯»èµ°ã€‚ RST å¯¹æ–¹è¦æ±‚é‡æ–°å»ºç«‹è¿æ¥ï¼Œå¤ä½ã€‚ SYN è¯·æ±‚å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨å…¶åºåˆ—å·çš„å­—æ®µè¿›è¡Œåºåˆ—å·çš„åˆå§‹å€¼è®¾å®šã€‚å»ºç«‹è¿æ¥ï¼Œè®¾ç½®ä¸º1 FIN å¸Œæœ›æ–­å¼€è¿æ¥ã€‚ TCP æ¡æ‰‹ ç¬¬ä¸€æ¬¡æ¡æ‰‹ å®¢æˆ·ç«¯å‘é€æ•°æ®åŒ…åˆ°æœåŠ¡å™¨,(åœ¨æ­¤è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µä¸­çš„åŒæ­¥ä½SYN=1,ç¡®è®¤ACK=0,è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªTCPè¿æ¥è¯·æ±‚æ•°æ®æŠ¥æ–‡,åºå·seq=x,è¡¨ç¤ºä¼ è¾“æ•°æ®æ—¶çš„èµ·å§‹åºå·æ˜¯x)æ­¤æ—¶,å®¢æˆ·ç«¯è¿›å…¥SYN_SENTçŠ¶æ€,ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ ç¬¬äºŒæ¬¡æ¡æ‰‹ æœåŠ¡å™¨æ”¶åˆ°è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µåï¼Œè‹¥åŒæ„å»ºç«‹è¿æ¥,åˆ™å‘å®¢æˆ·ç«¯å‘é€ç¡®è®¤æŠ¥æ–‡æ®µã€‚æ­¤æ—¶æœåŠ¡å™¨è¿›å…¥SYN_RECVçŠ¶æ€ã€‚ï¼ˆå…¶ä¸­ç¡®è®¤æŠ¥æ–‡æ®µä¸­ï¼Œæ ‡è¯†ä½SYN=1ï¼ŒACK=1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªTCPè¿æ¥å“åº”æ•°æ®æŠ¥æ–‡ï¼Œå¹¶å«æœåŠ¡ç«¯çš„åˆå§‹åºå·seq(æœåŠ¡å™¨)=yï¼Œä»¥åŠæœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯åˆå§‹åºå·çš„ç¡®è®¤å·ack(æœåŠ¡å™¨)=seq(å®¢æˆ·ç«¯)+1=x+1ï¼‰ã€‚ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ å®¢æˆ·ç«¯å†æ¬¡å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªåºåˆ—å·(seq=x+1)ï¼Œç¡®è®¤å·ä¸ºack(å®¢æˆ·ç«¯)=y+1ï¼Œæ­¤åŒ…å‘é€å®Œæ¯•ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿›å…¥ESTAB_LISHED(TCPè¿æ¥æˆåŠŸ)çŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ã€‚ TCPé‡Šæ”¾ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ é¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFINï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¼ é€ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ã€‚å…¶ä¸­ç»ˆæ­¢æ ‡å¿—ä½FIN=1ï¼Œåºåˆ—å·seq=uã€‚ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ æœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ªFINï¼Œå®ƒå‘é€ä¸€ä¸ªACKï¼Œç¡®è®¤ackä¸ºæ”¶åˆ°çš„åºå·åŠ ä¸€ã€‚ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ å…³é—­æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå‘é€ä¸€ä¸ªFINç»™å®¢æˆ·ç«¯ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹ å®¢æˆ·ç«¯æ”¶åˆ°FINåï¼Œå¹¶å‘å›ä¸€ä¸ªACKæŠ¥æ–‡ç¡®è®¤ï¼Œå¹¶å°†ç¡®è®¤åºå·seqè®¾ç½®ä¸ºæ”¶åˆ°åºå·åŠ ä¸€ã€‚é¦–å…ˆè¿›è¡Œå…³é—­çš„ä¸€æ–¹å°†æ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œè€Œå¦ä¸€æ–¹æ‰§è¡Œè¢«åŠ¨å…³é—­ã€‚ TCP æŒ¥æ‰‹æ€»ç»“å®¢æˆ·ç«¯å‘é€FINåï¼Œè¿›å…¥ç»ˆæ­¢ç­‰å¾…çŠ¶æ€ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå°±ç«‹å³ç»™å®¢æˆ·ç«¯å‘é€ç¡®è®¤ï¼ŒæœåŠ¡å™¨å°±è¿›å…¥CLOSE_WAITçŠ¶æ€ï¼Œæ­¤æ—¶TCPæœåŠ¡å™¨è¿›ç¨‹å°±é€šçŸ¥é«˜å±‚åº”ç”¨è¿›ç¨‹ï¼Œå› è€Œä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„è¿æ¥å°±é‡Šæ”¾äº†ã€‚æ­¤æ—¶æ˜¯â€œåŠå…³é—­çŠ¶æ€â€ï¼Œå³å®¢æˆ·ç«¯ä¸å¯ä»¥å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚æ­¤æ—¶ï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ•°æ®æŠ¥å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå…¶åº”ç”¨ç¨‹åºå°±é€šçŸ¥TCPé‡Šæ”¾è¿æ¥ï¼Œç„¶åå‘é€ç»™å®¢æˆ·ç«¯è¿æ¥é‡Šæ”¾æ•°æ®æŠ¥ï¼Œå¹¶ç­‰å¾…ç¡®è®¤ã€‚å®¢æˆ·ç«¯å‘é€ç¡®è®¤åï¼Œè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œä½†æ˜¯æ­¤æ—¶TCPè¿æ¥è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œç„¶åç»è¿‡ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„2MSLåï¼Œæ‰è¿›å…¥åˆ°CLOSEçŠ¶æ€ã€‚ MySQLçš„ Double Writer(åŒå†™)æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šæœ‰ä¸€ä¸ªdouble write bufferï¼Œå¤§å°ä¸º2Mã€‚å¦ä¸€éƒ¨åˆ†æ˜¯ç‰©ç†ç£ç›˜ä¸Šibdataç³»ç»Ÿè¡¨ç©ºé—´ä¸­å¤§å°ä¸º2MBï¼Œå…±128ä¸ªè¿ç»­çš„Pageï¼Œæ—¢2ä¸ªåˆ†åŒºã€‚å…¶ä¸­120ä¸ªç”¨äºæ‰¹é‡å†™è„ï¼Œå¦å¤–8ä¸ªç”¨äºSingle Page Flushã€‚åšåŒºåˆ†çš„åŸå› æ˜¯æ‰¹é‡åˆ·è„æ˜¯åå°çº¿ç¨‹åšçš„ï¼Œä¸å½±å“å‰å°çº¿ç¨‹ã€‚è€ŒSingle page flushæ˜¯ç”¨æˆ·çº¿ç¨‹å‘èµ·çš„ï¼Œéœ€è¦å°½å¿«çš„åˆ·è„å¹¶æ›¿æ¢å‡ºä¸€ä¸ªç©ºé—²é¡µå‡ºæ¥ã€‚å¯¹äºæ‰¹é‡åˆ·è„ï¼Œæ¯æ¬¡æ‰¾åˆ°ä¸€ä¸ªå¯åšflushçš„pageï¼Œå¯¹å…¶æŒæœ‰S lockï¼Œç„¶åå°†è¯¥pageæ‹·è´åˆ°dblwrä¸­ï¼Œå½“dblwræ»¡åè€…ä¸€æ¬¡æ‰¹é‡åˆ·è„ç»“æŸæ—¶ï¼Œå°†dblwrä¸­çš„pageå…¨éƒ¨åˆ·åˆ°ibdataä¸­ï¼Œæ³¨æ„è¿™æ˜¯åŒæ­¥å†™æ“ä½œï¼›ç„¶åå†å”¤é†’åå°IOçº¿ç¨‹å»å†™æ•°æ®é¡µã€‚å½“åå°IOçº¿ç¨‹å®Œæˆå†™æ“ä½œåï¼Œä¼šå»æ›´æ–°dblwrä¸­çš„è®¡æ•°ä»¥è…¾å‡ºç©ºé—´ï¼Œé‡Šæ”¾blockä¸Šçš„Sé”ï¼Œå®Œæˆå†™å…¥ã€‚ å¯¹äºSingle Page Flushï¼Œåˆ™åšçš„æ˜¯åŒæ­¥å†™æ“ä½œï¼Œåœ¨æŒ‘å‡ºä¸€ä¸ªå¯ä»¥åˆ·è„çš„pageåï¼Œå…ˆåŠ å…¥åˆ°dblwrä¸­ï¼Œåˆ·åˆ°ibdataï¼Œç„¶åå†™åˆ°ç”¨æˆ·è¡¨ç©ºé—´ï¼Œå®Œæˆåï¼Œä¼šå¯¹è¯¥ç”¨æˆ·è¡¨ç©ºé—´åšä¸€æ¬¡fsyncæ“ä½œã€‚ Single Page Flushåœ¨buffer poolä¸­free pageä¸å¤Ÿæ—¶è§¦å‘ï¼Œé€šå¸¸ç”±å‰å°çº¿ç¨‹å‘èµ·ï¼Œç”±äºæ¯æ¬¡single page flushéƒ½ä¼šå¯¼è‡´ä¸€æ¬¡fsyncæ“ä½œï¼Œåœ¨å¤§å¹¶å‘è´Ÿè½½ä¸‹ï¼Œå¦‚æœå¤§é‡çº¿ç¨‹å»åšflushï¼Œå¾ˆæ˜¾ç„¶ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½ä¸‹é™ã€‚Perconaåœ¨5.6ç‰ˆæœ¬ä¸­åšäº†ä¼˜åŒ–ï¼Œå¯ä»¥é€‰æ‹©ç”±åå°çº¿ç¨‹lru manageræ¥åšé¢„åˆ·ï¼Œé¿å…ç”¨æˆ·çº¿ç¨‹é™·å…¥å…¶ä¸­ã€‚ å¦‚æœå‘ç”Ÿäº†æç«¯æƒ…å†µï¼ˆæ–­ç”µï¼‰Crash Recoveryï¼ŒInnoDBå†æ¬¡å¯åŠ¨åï¼Œå‘ç°äº†ä¸€ä¸ªPageæ•°æ®å·²ç»æŸåï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥ä»double write bufferä¸­è¿›è¡Œæ•°æ®æ¢å¤äº†ã€‚è§¦å‘æ•°æ®ç¼“å†²æ± ä¸­çš„è„é¡µè¿›è¡Œåˆ·æ–°åˆ°data fileçš„æ—¶å€™ï¼Œå¹¶ä¸ç›´æ¥å†™ç£ç›˜ï¼Œè€Œæ˜¯ä¼šé€šè¿‡memcpyå‡½æ•°å°†è„é¡µå…ˆå¤åˆ¶åˆ°å†…å­˜ä¸­çš„double write bufferï¼Œä¹‹åé€šè¿‡double write bufferå†åˆ†ä¸¤æ¬¡ã€æ¯æ¬¡1MBé¡ºåºå†™å…¥å…±äº«è¡¨ç©ºé—´çš„ç‰©ç†ç£ç›˜ä¸Šã€‚ç„¶åé©¬ä¸Šè°ƒç”¨fsyncå‡½æ•°ï¼ŒåŒæ­¥è„é¡µè¿›ç£ç›˜ä¸Šã€‚ç”±äºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œdouble writeé¡µçš„å­˜å‚¨æ—¶è¿ç»­çš„ï¼Œå› æ­¤å†™å…¥ç£ç›˜ä¸ºé¡ºåºå†™ï¼Œæ€§èƒ½å¾ˆé«˜ï¼›å®Œæˆdouble writeåï¼Œå†å°†è„é¡µå†™å…¥å®é™…çš„å„ä¸ªè¡¨ç©ºé—´æ–‡ä»¶ã€‚ MySQL åŠåŒæ­¥ä¸­5.7æ¯”5.6çš„ä¼˜ç‚¹æ˜¯é‚£äº›å‘¢ï¼Ÿç­”ï¼šåŠåŒæ­¥å¤åˆ¶ï¼Œæ™®é€šçš„replicationï¼Œå³mysqlçš„å¼‚æ­¥å¤åˆ¶ï¼Œä¾é mysqläºŒè¿›åˆ¶æ—¥å¿—ä¹Ÿå³binary logè¿›è¡Œæ•°æ®å¤åˆ¶ã€‚æ¯”å¦‚ä¸¤å°æœºå™¨ï¼Œä¸€å°ä¸»æœº(master)ï¼Œå¦å¤–ä¸€å°æ˜¯ä»æœº(slave)ã€‚ æ­£å¸¸çš„å¤åˆ¶ä¸ºï¼šäº‹åŠ¡ä¸€ï¼ˆt1ï¼‰å†™å…¥binlog bufferï¼›dumper çº¿ç¨‹é€šçŸ¥slaveæœ‰æ–°çš„äº‹åŠ¡t1ï¼›binlog buffer è¿›è¡Œcheckpointï¼›slaveçš„ioçº¿ç¨‹æ¥æ”¶åˆ°t1å¹¶å†™å…¥åˆ°è‡ªå·±çš„çš„relay logï¼›slaveçš„sqlçº¿ç¨‹å†™å…¥åˆ°æœ¬åœ°æ•°æ®åº“ã€‚ è¿™æ—¶ï¼Œmasterå’Œslaveéƒ½èƒ½çœ‹åˆ°è¿™æ¡æ–°çš„äº‹åŠ¡ï¼Œå³ä½¿masteræŒ‚äº†ï¼Œslaveå¯ä»¥æå‡ä¸ºæ–°çš„masterã€‚ å¼‚å¸¸çš„å¤åˆ¶ä¸ºï¼šäº‹åŠ¡ä¸€ï¼ˆt1ï¼‰å†™å…¥binlog bufferï¼›dumper çº¿ç¨‹é€šçŸ¥slaveæœ‰æ–°çš„äº‹åŠ¡t1ï¼›binlog buffer è¿›è¡Œcheckpointï¼›slaveå› ä¸ºç½‘ç»œä¸ç¨³å®šï¼Œä¸€ç›´æ²¡æœ‰æ”¶åˆ°t1ï¼›master æŒ‚æ‰ï¼Œslaveæå‡ä¸ºæ–°çš„masterï¼Œt1ä¸¢å¤±ã€‚ å¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸»æœºå’Œä»æœºäº‹åŠ¡æ›´æ–°çš„ä¸åŒæ­¥ï¼Œå°±ç®—æ˜¯æ²¡æœ‰ç½‘ç»œæˆ–è€…å…¶ä»–ç³»ç»Ÿçš„å¼‚å¸¸ï¼Œå½“ä¸šåŠ¡å¹¶å‘ä¸Šæ¥æ—¶ï¼Œslaveå› ä¸ºè¦é¡ºåºæ‰§è¡Œmasteræ‰¹é‡äº‹åŠ¡ï¼Œå¯¼è‡´å¾ˆå¤§çš„å»¶è¿Ÿã€‚ ä¸ºäº†å¼¥è¡¥ä»¥ä¸Šå‡ ç§åœºæ™¯çš„ä¸è¶³ï¼Œmysqlä»5.5å¼€å§‹æ¨å‡ºäº†åŠåŒæ­¥ã€‚å³åœ¨masterçš„dumperçº¿ç¨‹é€šçŸ¥slaveåï¼Œå¢åŠ äº†ä¸€ä¸ªackï¼Œå³æ˜¯å¦æˆåŠŸæ”¶åˆ°t1çš„æ ‡å¿—ç ã€‚ä¹Ÿå°±æ˜¯dumperçº¿ç¨‹é™¤äº†å‘é€t1åˆ°slaveï¼Œè¿˜æ‰¿æ‹…äº†æ¥æ”¶slaveçš„ackå·¥ä½œã€‚å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰æ”¶åˆ°ackï¼Œé‚£ä¹ˆå°†è‡ªåŠ¨é™çº§ä¸ºæ™®é€šçš„å¤åˆ¶ï¼Œç›´åˆ°å¼‚å¸¸ä¿®å¤ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŠåŒæ­¥å¸¦æ¥çš„æ–°é—®é¢˜ï¼š å¦‚æœå¼‚å¸¸å‘ç”Ÿï¼Œä¼šé™çº§ä¸ºæ™®é€šçš„å¤åˆ¶ã€‚ é‚£ä¹ˆä»æœºå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„å‡ ç‡ä¼šå‡å°‘ï¼Œå¹¶ä¸æ˜¯å®Œå…¨æ¶ˆå¤±ã€‚ ä¸»æœºdumperçº¿ç¨‹æ‰¿æ‹…çš„å·¥ä½œå˜å¤šäº†ï¼Œè¿™æ ·æ˜¾ç„¶ä¼šé™ä½æ•´ä¸ªæ•°æ®åº“çš„æ€§èƒ½ã€‚ åœ¨MySQL 5.5å’Œ5.6ä½¿ç”¨after_commitçš„æ¨¡å¼ä¸‹, å³å¦‚æœslave æ²¡æœ‰æ”¶åˆ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¿˜æ²¡æœ‰å†™å…¥åˆ°relay log ä¹‹å‰ï¼Œç½‘ç»œå‡ºç°å¼‚å¸¸æˆ–è€…ä¸ç¨³å®šï¼Œæ­¤æ—¶åˆšå¥½masteræŒ‚äº†ï¼Œç³»ç»Ÿåˆ‡æ¢åˆ°ä»æœºï¼Œä¸¤è¾¹çš„æ•°æ®å°±ä¼šå‡ºç°ä¸ä¸€è‡´ã€‚ åœ¨æ­¤æƒ…å†µä¸‹ï¼Œslaveä¼šå°‘ä¸€ä¸ªäº‹åŠ¡çš„æ•°æ®ã€‚ MySQL 5.7 ä¸»ä»ä¸€è‡´æ€§åŠ å¼ºï¼Œæ”¯æŒåœ¨äº‹åŠ¡commitå‰ç­‰å¾…ACKæ–°ç‰ˆæœ¬çš„semi sync å¢åŠ äº†rpl_semi_sync_master_wait_point= AFTER_SYNC;å‚æ•°, æ¥æ§åˆ¶åŠåŒæ­¥æ¨¡å¼ä¸‹ä¸»åº“åœ¨è¿”å›ç»™ä¼šè¯äº‹åŠ¡æˆåŠŸä¹‹å‰æäº¤äº‹åŠ¡çš„æ–¹å¼ã€‚è¯¥å‚æ•°æœ‰ä¸¤ä¸ªå€¼:12AFTER_COMMIT: masterå°†æ¯ä¸ªäº‹åŠ¡å†™å…¥binlog ,ä¼ é€’åˆ°slave åˆ·æ–°åˆ°ç£ç›˜(relay log)ï¼ŒåŒæ—¶ä¸»åº“æäº¤äº‹åŠ¡ã€‚masterç­‰å¾…slave åé¦ˆæ”¶åˆ°relay logï¼Œåªæœ‰æ”¶åˆ°ACKåmasteræ‰å°†commit OKç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ã€‚AFTER_SYNC(5.7ç‹¬æœ‰): master å°†æ¯ä¸ªäº‹åŠ¡å†™å…¥binlog , ä¼ é€’åˆ°slave åˆ·æ–°åˆ°ç£ç›˜(relay log)ã€‚masterç­‰å¾…slave åé¦ˆæ¥æ”¶åˆ°relay logçš„ackä¹‹åï¼Œå†æäº¤äº‹åŠ¡å¹¶ä¸”è¿”å›commit OKç»“æœç»™å®¢æˆ·ç«¯ã€‚ å³ä½¿ä¸»åº“crashï¼Œæ‰€æœ‰åœ¨ä¸»åº“ä¸Šå·²ç»æäº¤çš„äº‹åŠ¡éƒ½èƒ½ä¿è¯å·²ç»åŒæ­¥åˆ°slaveçš„relay logä¸­ã€‚ æ”¯æŒå‘é€binlogå’Œæ¥å—ACKçš„å¼‚æ­¥åŒ– æ—§ç‰ˆæœ¬çš„semi sync å—é™äºdump thread ï¼ŒåŸå› æ˜¯dump thread æ‰¿æ‹…äº†ä¸¤ä»½ä¸åŒä¸”åˆååˆ†é¢‘ç¹çš„ä»»åŠ¡ï¼šä¼ é€binlog ç»™slave ï¼Œè¿˜éœ€è¦ç­‰å¾…slaveåé¦ˆä¿¡æ¯ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œdump thread å¿…é¡»ç­‰å¾… slave è¿”å›ä¹‹åæ‰ä¼šä¼ é€ä¸‹ä¸€ä¸ª events äº‹åŠ¡ã€‚dump thread å·²ç„¶æˆä¸ºæ•´ä¸ªåŠåŒæ­¥æé«˜æ€§èƒ½çš„ç“¶é¢ˆã€‚åœ¨é«˜å¹¶å‘ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œè¿™æ ·çš„æœºåˆ¶ä¼šå½±å“æ•°æ®åº“æ•´ä½“çš„TPS ã€‚ without_ack_receiving_thread ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œåœ¨5.7ç‰ˆæœ¬çš„semi sync æ¡†æ¶ä¸­ï¼Œç‹¬ç«‹å‡ºä¸€ä¸ª ack collector thread ï¼Œä¸“é—¨ç”¨äºæ¥æ”¶slave çš„åé¦ˆä¿¡æ¯ã€‚è¿™æ ·master ä¸Šæœ‰ä¸¤ä¸ªçº¿ç¨‹ç‹¬ç«‹å·¥ä½œï¼Œå¯ä»¥åŒæ—¶å‘é€binlog åˆ°slave ï¼Œå’Œæ¥æ”¶slaveçš„åé¦ˆã€‚ æ§åˆ¶ä¸»åº“æ¥å—SLAVEå†™äº‹åŠ¡æˆåŠŸåé¦ˆæ•°é‡ã€‚ MySQL 5.7 æ–°å¢äº†SET GLOBAL rpl_semi_sync_master_wait_for_slave_count= N;å‚æ•°ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶ä¸»åº“æ¥å—å¤šå°‘ä¸ªslaveå†™äº‹åŠ¡æˆåŠŸåé¦ˆï¼Œç»™é«˜å¯ç”¨æ¶æ„åˆ‡æ¢æä¾›äº†çµæ´»æ€§ã€‚å½“countå€¼ä¸º2æ—¶ï¼Œmasteréœ€ç­‰å¾…ä¸¤ä¸ªslaveçš„ackã€‚ Binlog äº’æ–¥é”æ”¹è¿› æ—§ç‰ˆæœ¬åŠåŒæ­¥å¤åˆ¶åœ¨ä¸»æäº¤binlogçš„å†™ä¼šè¯å’Œdump threadè¯»binlogçš„æ“ä½œéƒ½ä¼šå¯¹binlogæ·»åŠ äº’æ–¥é”ï¼Œå¯¼è‡´binlogæ–‡ä»¶çš„è¯»å†™æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œå­˜åœ¨å¹¶å‘åº¦çš„é—®é¢˜ã€‚ binlog_mutex_after_tuning MySQL 5.7 å¯¹binlog lockè¿›è¡Œäº†ä»¥ä¸‹ä¸¤æ–¹é¢ä¼˜åŒ–: ç§»é™¤äº†dump threadå¯¹binlogçš„äº’æ–¥é” åŠ å…¥äº†å®‰å…¨è¾¹é™…ä¿è¯binlogçš„è¯»å®‰å…¨ ç»„æäº¤ MySQL 5.7 å¼•å…¥äº†æ–°çš„å˜é‡slave-parallel-typeï¼Œå…¶å¯ä»¥é…ç½®çš„å€¼æœ‰: DATABASE ï¼ˆ5.7ä¹‹å‰é»˜è®¤å€¼ï¼‰ï¼ŒåŸºäºåº“çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ LOGICAL_CLOCK ï¼ˆ5.7æ–°å¢å€¼ï¼‰ï¼ŒåŸºäºç»„æäº¤çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ï¼› MySQLçš„RPO å’Œ RTO åè¯æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿç­”ï¼šRPO: æ¢å¤ç‚¹ç›®æ ‡ æ¢å¤ç‚¹ç›®æ ‡æ˜¯æŒ‡ä¼ä¸šçš„æŸå¤±å®¹é™ï¼šåœ¨å¯¹ä¸šåŠ¡é€ æˆé‡å¤§æŸå®³ä¹‹å‰å¯èƒ½ä¸¢å¤±çš„æ•°æ®é‡ã€‚è¯¥ç›®æ ‡è¡¨ç¤ºä¸ºä»ä¸¢å¤±äº‹ä»¶åˆ°æœ€è¿‘ä¸€æ¬¡åœ¨å‰å¤‡ä»½çš„æ—¶é—´åº¦é‡ã€‚RTO: æ¢å¤æ—¶é—´ç›®æ ‡ RTOæŒ‡çš„æ˜¯åº”ç”¨ç¨‹åºå¯ä»¥ä¸­æ–­æˆ–å…³é—­å¤šå°‘æ—¶é—´è€Œä¸ä¼šå¯¹ä¸šåŠ¡é€ æˆé‡å¤§æŸå®³ã€‚æœ‰äº›åº”ç”¨ç¨‹åºå¯èƒ½ä¼šåœæœºæ•°å¤©è€Œä¸ä¼šäº§ç”Ÿä¸¥é‡çš„åæœã€‚è€Œä¸€äº›é«˜ä¼˜å…ˆçº§çš„åº”ç”¨ç¨‹åºåªèƒ½åœä¸‹æ¥å‡ ç§’é’Ÿï¼Œå¦åˆ™å°†ä¼šè®©ä¼ä¸šå’Œå®¢æˆ·éš¾ä»¥åº”å¯¹ï¼Œå¹¶å¯¼è‡´ä¸šåŠ¡ä¸¢å¤±ã€‚ æ¯”å¦‚ä¸€ä¸ªæ“ä½œï¼ŒBegin;insert intoâ€¦.; commit; è¿™ä¹ˆæ“ä½œã€‚TPS æ˜¯å‡ ï¼ŸQPS æ˜¯å‡ ?ç­”ï¼šæˆ‘ç†è§£çš„æ˜¯QPSä¸­åŒ…å«TPSï¼Œæ‰€ä»¥QPS æ˜¯3ï¼ŒTPS æ˜¯1. InnoDBçš„ MVCC å’Œ READ VIEW ç»™æˆ‘è®²è§£ä¸‹ï¼Ÿç­”ï¼šMVCC æ˜¯multiversion concurrency controlçš„ç®€ç§°ï¼Œä¹Ÿå°±æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œæ˜¯ä¸ªå¾ˆåŸºæœ¬çš„æ¦‚å¿µã€‚MVCCçš„ä½œç”¨æ˜¯è®©äº‹åŠ¡åœ¨å¹¶è¡Œå‘ç”Ÿæ—¶ï¼Œåœ¨ä¸€å®šéš”ç¦»çº§åˆ«å‰æä¸‹ï¼Œå¯ä»¥ä¿è¯åœ¨æŸä¸ªäº‹åŠ¡ä¸­èƒ½å®ç°ä¸€è‡´æ€§è¯»ï¼Œä¹Ÿå°±æ˜¯è¯¥äº‹åŠ¡å¯åŠ¨æ—¶æ ¹æ®æŸä¸ªæ¡ä»¶è¯»å–åˆ°çš„æ•°æ®ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ—¶ï¼Œå†æ¬¡æ‰§è¡Œç›¸åŒæ¡ä»¶ï¼Œè¿˜æ˜¯è¯»åˆ°åŒä¸€ä»½æ•°æ®ï¼Œä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆä¸ä¼šçœ‹åˆ°è¢«å…¶ä»–å¹¶è¡Œäº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ï¼‰ã€‚read view InnoDB MVCCä½¿ç”¨çš„å†…éƒ¨å¿«ç…§çš„æ„æ€ã€‚åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡å¯åŠ¨æ—¶ï¼ˆæœ‰äº›æƒ…å†µä¸‹ï¼Œå¯èƒ½æ˜¯SQLè¯­å¥å¼€å§‹æ—¶ï¼‰çœ‹åˆ°çš„æ•°æ®å¿«ç…§ç‰ˆæœ¬å¯èƒ½ä¹Ÿä¸åŒã€‚åœ¨RRã€RCã€RUï¼ˆREAD UNCOMMITTEDï¼‰ç­‰å‡ ä¸ªéš”ç¦»çº§åˆ«ä¸‹ä¼šç”¨åˆ° read viewã€‚ä½•æ—¶åˆ›å»ºread view å…¶å®ï¼Œæˆ‘ä»¬ä»ä¸Šé¢çš„è§£é‡Šå·²ç»æ˜ç™½äº†ï¼Œåœ¨RCéš”ç¦»çº§åˆ«ä¸‹ï¼Œæ˜¯æ¯ä¸ªSELECTéƒ½ä¼šè·å–æœ€æ–°çš„read viewï¼›è€Œåœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œåˆ™æ˜¯å½“äº‹åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªSELECTè¯·æ±‚æ‰åˆ›å»ºread viewMySQL mysqldump å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿç­”ï¼š FLUSH /!40101 LOCAL / TABLES FLUSH TABLES WITH READ LOCK æ‰§è¡Œflush tablesæ“ä½œï¼Œå¹¶åŠ ä¸€ä¸ªå…¨å±€è¯»é”ï¼Œå¾ˆå¤šç«¥é‹å¯èƒ½ä¼šå¥½å¥‡ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤è²Œä¼¼æ˜¯é‡å¤çš„ï¼Œä¸ºä»€ä¹ˆä¸åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œflush tablesæ“ä½œçš„æ—¶å€™åŠ ä¸Šé”äº†ï¼Œå…¶å®ï¼Œè¿™æ ·åšçš„åŸå› åœ¨äºå¯ä»¥å°½é‡å‡å°‘åŠ é”çš„å½±å“ã€‚åŠ ä¸Šå…¨å±€è¯»é”ï¼Œåªå…è®¸è¯»ï¼Œä¸å…è®¸æ›´æ–°æ“ä½œã€‚ SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ è®¾ç½®å½“å‰ä¼šè¯çš„äº‹åŠ¡éš”ç¦»ç­‰çº§ä¸ºRRï¼ŒRRå¯é¿å…ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚ START TRANSACTION /!40100 WITH CONSISTENT SNAPSHOT / è·å–å½“å‰æ•°æ®åº“çš„å¿«ç…§ï¼Œè¿™ä¸ªæ˜¯ç”±mysqldumpä¸­â€“single-transactionå†³å®šçš„ã€‚ è¿™ä¸ªåªé€‚ç”¨äºæ”¯æŒäº‹åŠ¡çš„è¡¨ï¼Œåœ¨MySQLä¸­ï¼Œåªæœ‰Innodbã€‚ æ³¨æ„ï¼šSTART TRANSACTION å’Œ START TRANSACTION WITH CONSISTENT SNAPSHOT å¹¶ä¸ä¸€æ ·ï¼Œ START TRANSACTION WITH CONSISTENT SNAPSHOT æ˜¯å¼€å¯äº‹åŠ¡çš„ä¸€è‡´æ€§å¿«ç…§ã€‚ RC ä¸‹çš„ START TRANSACTION WITH CONSISTENT SNAPSHOT ç›¸å½“äºRRä¸‹çš„START TRANSACTIONã€‚ ä¸æ˜ç™½äº‹åŠ¡çš„ç«¥é‹å¯èƒ½è§‰å¾—è¿™ç‚¹ä¼šæ¯”è¾ƒç»•ï¼Œå…¶å®æ‰€è°“çš„ä¸å¯é‡å¤è¯»å’Œå¹»è¯»å¯ç®€å•ç†è§£ä¸ºï¼Œåœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡SELECTçš„ç»“æœå¹¶ä¸ç›¸åŒã€‚ ä¹‹æ‰€ä»¥è¦ä½¿ç”¨START TRANSACTION WITH CONSISTENT SNAPSHOTï¼Œå› ä¸ºæ¯ä¸ªè¡¨çš„å¤‡ä»½æ—¶é—´å¹¶ä¸ç›¸åŒï¼Œè¿™å°±è¦æ±‚åœ¨å¯¹ç¬¬ä¸€å¼ è¡¨è¿›è¡Œå¤‡ä»½çš„æœŸé—´ï¼Œå¯¹ç¬¬äºŒä¸ªè¡¨è¿›è¡Œçš„æ“ä½œï¼Œå¹¶ä¸ä¼šåæ˜ åˆ°ç¬¬äºŒå¼ è¡¨å¼€å§‹å¤‡ä»½æ—¶æ‰§è¡Œçš„SELECTæ“ä½œä¸­ã€‚ï¼ˆæ³¨ï¼šmysqldumpå¤‡ä»½çš„åº•å±‚å®ç°å³æ˜¯select * from tabï¼‰ã€‚è€Œè¿™ç”¨START TRANSACTIONå°±æ— æ³•å®ç°ã€‚ SHOW MASTER STATUS è¿™ä¸ªæ˜¯ç”±â€“master-dataå†³å®šçš„ï¼Œè®°å½•äº†å¼€å§‹å¤‡ä»½æ—¶ï¼Œbinlogçš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬MASTER_LOG_FILEå’ŒMASTER_LOG_POS UNLOCK TABLES ç­‰è®°å½•å®Œæˆåï¼Œå°±ç«‹å³é‡Šæ”¾äº†ï¼Œå› ä¸ºç°åœ¨å·²ç»åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­äº†ï¼Œå…¶ä»–çº¿ç¨‹å†ä¿®æ”¹æ•°æ®å·²ç»æ— æ‰€è°“ï¼Œåœ¨æœ¬çº¿ç¨‹ä¸­å·²ç»æ˜¯å¯é‡å¤è¯»ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸€æ­¥å¿…é¡»åœ¨19 rowsä¹‹åçš„åŸå› ï¼Œå¦‚æœ20 rowså’Œ21 rowséƒ½åœ¨19 rowsä¹‹å‰çš„è¯å°±ä¸è¡Œäº†ï¼Œå› ä¸ºè¿™æ—¶äº‹åŠ¡è¿˜æ²¡å¼€å¯ï¼Œä¸€æ—¦é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹ç«‹å³å°±å¯ä»¥æ›´æ”¹æ•°æ®ï¼Œä»è€Œæ— æ³•ä¿è¯å¾—åˆ°äº‹åŠ¡å¼€å¯æ—¶æœ€å‡†ç¡®çš„posç‚¹ å¤‡ä»½çš„æ ¸å¿ƒæ˜¯SELECT /!40001 SQL_NO_CACHE / * FROM test1è¯­å¥ã€‚ è¯¥è¯­å¥ä¼šæŸ¥è¯¢åˆ°è¡¨test1çš„æ‰€æœ‰æ•°æ®ï¼Œåœ¨å¤‡ä»½æ–‡ä»¶ä¸­ä¼šç”Ÿæˆç›¸åº”çš„insertè¯­å¥ã€‚ å…¶ä¸­SQL_NO_CACHEçš„ä½œç”¨æ˜¯æŸ¥è¯¢çš„ç»“æœå¹¶ä¸ä¼šç¼“å­˜åˆ°æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚ SHOW CREATE DATABASE IF NOT EXISTS testï¼Œshow create table test1 ç”Ÿæˆåˆ›åº“è¯­å¥å’Œåˆ›è¡¨è¯­å¥ã€‚ SHOW TRIGGERS LIKE â€˜test1â€™ å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸åŠ -Rå‚æ•°ï¼Œé»˜è®¤æ˜¯ä¼šå¤‡ä»½è§¦å‘å™¨çš„ã€‚ SHOW FUNCTION STATUS WHERE Db = â€˜testâ€™SHOW CREATE FUNCTION mycat_seq_currvalSHOW PROCEDURE STATUS WHERE Db = â€˜testâ€™ ç”¨äºå¤‡ä»½å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ã€‚ è®¾ç½®SAVEPOINTï¼Œç„¶åå¤‡ä»½å®Œæ¯ä¸ªè¡¨åå†å›æ»šåˆ°è¯¥SAVEPOINTã€‚å› ä¸ºå‰é¢é€šè¿‡START TRANSACTION WITH CONSISTENT SNAPSHOTå¼€å¯çš„äº‹åŠ¡åªèƒ½é€šè¿‡commitæˆ–è€…rollbackæ¥ç»“æŸï¼Œè€Œä¸æ˜¯ROLLBACK TO SAVEPOINT spã€‚PSï¼šè¿™æ ·åšä¸ä¼šé˜»å¡åœ¨å¤‡ä»½æœŸé—´å¯¹å·²ç»å¤‡ä»½è¡¨çš„ddlæ“ä½œï¼Œå…·ä½“å¯è§ä¸‹é¢çš„â€œåç»­è¡¥å……â€ç¬¬ä¸‰ç‚¹ã€‚ æ€»ç»“ï¼š mysqldumpçš„æœ¬è´¨æ˜¯é€šè¿‡select * from tabæ¥è·å–è¡¨çš„æ•°æ®çš„ã€‚ START TRANSACTION /!40100 WITH CONSISTENT SNAPSHOT /å¿…é¡»æ”¾åˆ°FLUSH TABLES WITH READ LOCKå’ŒUNLOCK TABLESä¹‹é—´ï¼Œæ”¾åˆ°ä¹‹å‰ä¼šé€ æˆSTART TRANSACTION /!40100 WITH CONSISTENT SNAPSHOT /å’ŒFLUSH TABLES WITH READ LOCKä¹‹é—´æ‰§è¡Œçš„DMLè¯­å¥ä¸¢å¤±ï¼Œæ”¾åˆ°ä¹‹åï¼Œä¼šé€ æˆä»åº“é‡å¤æ’å…¥æ•°æ®ã€‚ mysqldumpåªé€‚åˆæ”¾åˆ°ä¸šåŠ¡ä½å³°æœŸåšï¼Œå¦‚æœå¤‡ä»½çš„è¿‡ç¨‹ä¸­æ•°æ®æ“ä½œå¾ˆé¢‘ç¹ï¼Œä¼šé€ æˆUndoè¡¨ç©ºé—´è¶Šæ¥è¶Šå¤§ï¼Œundoè¡¨ç©ºé—´é»˜è®¤æ˜¯æ”¾åˆ°å…±äº«è¡¨ç©ºé—´ä¸­çš„ï¼Œè€Œibdataçš„ç‰¹æ€§æ˜¯ä¸€æ—¦å¢å¤§ï¼Œå°±ä¸ä¼šæ”¶ç¼©ã€‚ mysqldumpçš„æ•ˆç‡è¿˜æ˜¯æ¯”è¾ƒä½ä¸‹ï¼ŒSTART TRANSACTION /!40100 WITH CONSISTENT SNAPSHOT /åªèƒ½ç­‰åˆ°æ‰€æœ‰è¡¨å¤‡ä»½å®Œåæ‰ç»“æŸï¼Œå…¶å®æ•ˆç‡æ¯”è¾ƒé«˜çš„åšæ³•æ˜¯å¤‡ä»½å®Œä¸€å¼ è¡¨å°±æäº¤ä¸€æ¬¡ï¼Œè¿™æ ·å¯å°½å¿«é‡Šæ”¾Undoè¡¨ç©ºé—´å¿«ç…§å ç”¨çš„ç©ºé—´ã€‚ä½†è¿™æ ·åšï¼Œå°±æ— æ³•å®ç°å¯¹æ‰€æœ‰è¡¨çš„ä¸€è‡´æ€§å¤‡ä»½ã€‚ mysqldump single-transactionæ€ä¹ˆå®ç°è·å–InnoDBè¡¨çš„ä¸€è‡´æ€§å¤‡ä»½ï¼Ÿç­”ï¼š SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ æ‰¹æ³¨ï¼šâ€“single-transactionå‚æ•°çš„ä½œç”¨ï¼Œè®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼Œå³REPEATABLE READï¼Œè¿™æ ·èƒ½ä¿è¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€æœ‰ç›¸åŒçš„æŸ¥è¯¢è¯»å–åˆ°åŒæ ·çš„æ•°æ®ï¼Œä¹Ÿå°±å¤§æ¦‚ä¿è¯äº†åœ¨dumpæœŸé—´ï¼Œå¦‚æœå…¶ä»–innodbå¼•æ“çš„çº¿ç¨‹ä¿®æ”¹äº†è¡¨çš„æ•°æ®å¹¶æäº¤ï¼Œå¯¹è¯¥dumpçº¿ç¨‹çš„æ•°æ®å¹¶æ— å½±å“ï¼Œç„¶è€Œè¿™ä¸ªè¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦çœ‹ä¸‹ä¸€æ¡ START TRANSACTION /!40100 WITH CONSISTENT SNAPSHOT / è¿™æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”è®¾ç½®WITH CONSISTENT SNAPSHOTä¸ºå¿«ç…§çº§åˆ«ï¼ˆå¦‚æœmysqlç‰ˆæœ¬é«˜äºæŸä¸€ä¸ªç‰ˆæœ¬å€¼ï¼Œæˆ‘è¿˜ä¸å¤§æ¸…æ¥š40100ä»£è¡¨ä»€ä¹ˆç‰ˆæœ¬ï¼‰ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœåªæ˜¯å¯é‡å¤è¯»ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡å¼€å§‹æ—¶è¿˜æ²¡dumpæ•°æ®æ—¶ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼Œé‚£ä¹ˆè¿™æ—¶ç¬¬ä¸€æ¬¡æŸ¥è¯¢å¾—åˆ°çš„ç»“æœæ˜¯å…¶ä»–çº¿ç¨‹æäº¤åçš„ç»“æœï¼Œè€ŒWITH CONSISTENT SNAPSHOTèƒ½å¤Ÿä¿è¯åœ¨äº‹åŠ¡å¼€å¯çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœå°±æ˜¯äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®Aï¼Œå³ä½¿è¿™æ—¶å…¶ä»–çº¿ç¨‹å°†å…¶æ•°æ®ä¿®æ”¹ä¸ºBï¼ŒæŸ¥çš„ç»“æœä¾ç„¶æ˜¯A Paxosåè®®å’ŒRaftåè®®ç­”ï¼šåœ¨åˆ†å¸ƒå¼ä¸­æˆ‘ä»¬éå¸¸éå¸¸çœ‹é‡çš„æœ‰ä¸€èˆ¬ç½‘ä¸Šç»å¸¸è¯´çš„ä¸‰ä¸ªç‚¹ï¼ŒCAP ï¼å³ï¼šC (Consistency ä¸€è‡´æ€§)ã€A (Availability å¯ç”¨æ€§)ã€P (Partition)ï¼›ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æ‰€è¯´çš„ã€CAPåŸç†ã€‘ï¼›è€Œåœ¨ä¸€è‡´æ€§ä¸­æˆ‘ä»¬æœ‰éå¸¸éå¸¸æ³¨é‡å››ä¸ªç‚¹ï¼Œ ACID ï¼ å³ï¼šA (Atomicity åŸå­æ€§)ã€C (Consistency ä¸€è‡´æ€§)ã€ I (Isolation éš”ç¦»æ€§)ã€ D (Durability æŒä¹…æ€§)ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ã€ACIDåŸåˆ™ã€‘æ˜¯çš„ä¸€è‡´æ€§åŸåˆ™ä¸­çš„ä¸€ç§ RaftRaftæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼ç®—æ³•ï¼Œæ˜¯Replicated And Fault Tolerantçš„ç¼©å†™ã€‚åœ¨raftä¸­é¦–å…ˆå…·å¤‡äº†ä¸‰ç§è§’è‰²ï¼š Leader (é¢†å¯¼è€…) Candidateï¼ˆå€™é€‰è€…ï¼‰ Followerï¼ˆè¿½éšè€…ï¼‰ é€šå¸¸å†åšå†³ç­–ä¹‹å‰éœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªå…¨å±€çš„Leaderæ¥ç®€åŒ–åç»­çš„å†³ç­–è¿‡ç¨‹ã€‚Leaderå†³å®šäº†logçš„æäº¤ï¼Œä¸” logåªèƒ½æ˜¯Leader æƒ³followerå•å‘æäº¤ã€‚ Leader (é¢†å¯¼è€…)ï¼šè´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„Logï¼Œå¹¶åˆ†å‘ç»™å…¶ä»–èŠ‚ç‚¹ã€‚ Candidate ï¼ˆå€™é€‰è€…ï¼‰ï¼šå‘èµ·é€‰ä¸¾è¯·æ±‚ï¼Œç«äº‰Leaderã€‚ Follower ï¼ˆè¿½éšè€…ï¼‰ï¼šè´Ÿè´£æ¥æ”¶Leaderå‘é€è¿‡æ¥çš„Logï¼Œå¹¶åˆ·æ–°ä¿å­˜ã€‚ Raft åˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹: é€‰ä¸¾Leader æ—¥å¿—åŒæ­¥ã€‚ Raftçš„æ ¸å¿ƒæ€æƒ³ Leaderçš„é€‰ä¸¾è¿‡ç¨‹ Logçš„å¤åˆ¶æ–¹æ¡ˆ æ•°æ®å®‰å…¨ï¼ˆå…¶å®å°±æ˜¯ä¸€è‡´æ€§ï¼‰ Paxosï¼ˆLamportï¼‰ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹é€šä¿¡å­˜åœ¨ä¸¤ç§æ¨¡å‹ï¼šå…±äº«å†…å­˜ï¼ˆShared memoryï¼‰å’Œæ¶ˆæ¯ä¼ é€’ï¼ˆMessages passingï¼‰ã€‚ åŸºäºæ¶ˆæ¯ä¼ é€’é€šä¿¡æ¨¡å‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¸å¯é¿å…çš„ä¼šå‘ç”Ÿä»¥ä¸‹é”™è¯¯ï¼šè¿›ç¨‹å¯èƒ½ä¼šæ…¢ã€è¢«æ€æ­»æˆ–è€…é‡å¯ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šå»¶è¿Ÿã€ä¸¢å¤±ã€é‡å¤ï¼Œåœ¨åŸºç¡€Paxosåœºæ™¯ä¸­ï¼Œå…ˆä¸è€ƒè™‘å¯èƒ½å‡ºç°æ¶ˆæ¯ç¯¡æ”¹å³æ‹œå åº­é”™è¯¯çš„æƒ…å†µã€‚ Paxosç®—æ³•è§£å†³çš„é—®é¢˜æ˜¯åœ¨ä¸€ä¸ªå¯èƒ½å‘ç”Ÿä¸Šè¿°å¼‚å¸¸çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¿è¯ä¸è®ºå‘ç”Ÿä»¥ä¸Šä»»ä½•å¼‚å¸¸ï¼Œéƒ½ä¸ä¼šç ´åå†³è®®çš„ä¸€è‡´æ€§ã€‚ ä¸»è¦æœ‰ä¸‰ç±»èŠ‚ç‚¹: æè®®è€…ï¼ˆProposerï¼‰ï¼šæå‡ºææ¡ˆç­‰å¾…å¤§å®¶è®¤å¯è¯¥ææ¡ˆä¸ºå†³è®®ã€‚(ç³»ç»Ÿä¸­çš„ææ¡ˆéƒ½æ‹¥æœ‰ä¸€ä¸ªè‡ªå¢çš„å”¯ä¸€ææ¡ˆå·ï¼Œ) æ¥å—è€…ï¼ˆAcceptorï¼‰ï¼šè´Ÿè´£å¯¹ææ¡ˆè¿›è¡ŒæŠ•ç¥¨ï¼Œè®¤å¯ææ¡ˆã€‚ å­¦ä¹ è€…ï¼ˆLearnerï¼‰ï¼šè·å–æ‰¹å‡†çš„ç»“æœ ï¼ˆå­¦ä¹ acceptoræ‰€è®¤å¯çš„ç»“æœï¼‰ï¼Œå¹¶å¸®å¿™ä¼ æ’­ï¼Œä¸å‚ä¸æŠ•ç¥¨è¿‡ç¨‹ã€‚ Paxosçš„æµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ: å‡†å¤‡é˜¶æ®µ æäº¤é˜¶æ®µ å‡†å¤‡é˜¶æ®µï¼š proposerå‘ç½‘ç»œå†…è¶…è¿‡åŠæ•°çš„acceptorå‘é€prepareæ¶ˆæ¯ (å³ï¼šæäº¤è‡ªå·±çš„ææ¡ˆç¼–å·) acceptoræ­£å¸¸æƒ…å†µä¸‹å›å¤promiseæ¶ˆæ¯ï¼ˆæ¥å—è€…æ—¶å¯ä¿å­˜æ”¶åˆ°è¿‡çš„ææ¡ˆçš„æœ€å¤§ç¼–å·å’Œè®¤å¯çš„æœ€å¤§ææ¡ˆï¼Œå¦‚æœæ”¶åˆ°çš„ææ¡ˆå·æ¯”è‡ªå·±ä¿ç•™çš„æœ€å¤§ææ¡ˆå·è¿˜å¤§ï¼Œåˆ™è¿”å›è‡ªå·±å·²è®¤å¯çš„ææ¡ˆå·ï¼›å¦‚æœä»æœªè®¤å¯è¿‡ææ¡ˆï¼Œåˆ™è¿”å›ç©ºï¼Œå¹¶æ›´æ–°å½“å‰ä¿å­˜çš„æœ€å¤§ææ¡ˆå·ï¼Œå¹¶è¯´æ˜ä¸å†è®¤å¯å°äºæœ€å¤§ææ¡ˆå·çš„ææ¡ˆï¼‰ æäº¤é˜¶æ®µï¼š åœ¨æœ‰è¶³å¤Ÿå¤šacceptorå›å¤promiseæ¶ˆæ¯æ—¶ï¼Œproposerå‘é€acceptæ¶ˆæ¯ï¼ˆå¦‚æœææ¡ˆè€…æ”¶åˆ°å¤§å¤šæ•°çš„å›å¤ï¼Œåˆ™å‘é€å¸¦æœ‰åˆšæ‰ææ¡ˆå·çš„æ¥å— accept ä¿¡æ¯ã€‚ /proc/sys/net/ipv4/ip_forward# sed -i '/net.ipv4.ip_forward/ s/\(.*= \).*/\11/' /etc/sysctl.conf åœ¨InnoDBå¼•æ“ä¸­ï¼Œ16k PAGE SIZE, InnoDBçš„éå¶å­èŠ‚ç‚¹æœ€å¤šèƒ½æ”¾å¤šå°‘ä¸ªINTçš„Primary Keys,èƒ½ç”¨ 16K/4 æ¥ä¼°ç®—å—ï¼Ÿç­”ï¼šåœ¨InnoDBå¼•æ“ä¸­ï¼Œæ¯ä¸€ä¸ªpageé¢„ç•™1/6ç©ºé—²ç©ºé—´ï¼Œå†å‡å»å¤´å°¾å…ƒæ•°æ®ä¿¡æ¯ï¼Œå°±æ˜¯ 16338*15/16*1024/4ã€‚å°±æ˜¯å¤§æ¦‚çš„ç»“æœã€‚æ³¨: 16338 æ˜¯å»æ‰ å¤´å°¾å…ƒæ•°æ®ä¿¡æ¯åçš„å¤§å°ã€‚ å‚è€ƒå®˜æ–¹èµ„æ–™ è¯´ä¸€è¯´ä¸‰ä¸ªèŒƒå¼ç­”ï¼šç¬¬ä¸€èŒƒå¼(1NF): æ•°æ®åº“è¡¨ä¸­çš„å­—æ®µéƒ½æ˜¯å•ä¸€å±æ€§çš„,ä¸å¯å†åˆ†. è¿™ä¸ªå•ä¸€å±æ€§ç”±åŸºæœ¬ç±»å‹æ„æˆ, åŒ…æ‹¬æ•´å‹/å®æ•°/å­—ç¬¦å‹/é€»è¾‘æ€§/æ—¥æœŸå‹ç­‰. ç¬¬äºŒèŒƒå¼(2NF): æ•°æ®åº“è¡¨ä¸­ä¸å­˜åœ¨éå…³é”®å­—æ®µå¯¹ä»»ä¸€å€™é€‰å…³é”®å­—æ®µçš„éƒ¨åˆ†å‡½æ•°ä¾èµ–(éƒ¨åˆ†å‡½æ•°ä¾èµ–æŒ‡çš„æ˜¯å­˜åœ¨ç»„åˆå…³é”®å­—æ®µä¸­çš„æŸäº›å­—æ®µå†³å®šéå…³é”®å­—æ®µçš„æƒ…å†µ), ä¹Ÿå³æ‰€æœ‰éå…³é”®å­—æ®µéƒ½å®Œå…¨ä¾èµ–äºä»»æ„ä¸€ç»„å€™é€‰å…³é”®å­—. ç¬¬ä¸‰èŒƒå¼(3NF): åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œæ•°æ®è¡¨ä¸­å¦‚æœä¸å­˜åœ¨éå…³é”®å­—æ®µå¯¹ä»»ä¸€å€™é€‰å…³é”®å­—æ®µçš„ä¼ é€’å‡½æ•°ä¾èµ–åˆ™ç¬¦åˆç¬¬ä¸‰èŒƒå¼. æ‰€è°“ä¼ é€’å‡½æ•°ä¾èµ–, æŒ‡çš„æ˜¯å¦‚æœå­˜åœ¨ â€˜A -> B -> Câ€™ çš„å†³å®šå…³ç³», åˆ™Cä¼ é€’å‡½æ•°ä¾èµ–äºA. å› æ­¤, æ»¡è¶³ç¬¬ä¸‰èŒƒå¼çš„æ•°æ®åº“è¡¨åº”è¯¥ä¸å­˜åœ¨å¦‚ä¸‹ä¾èµ–å…³ç³»: å…³é”®å­—æ®µ -> éå…³é”®å­—æ®µx -> éå…³é”®å­—æ®µy document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>MySQL é¢è¯•ç¬”è®°</category>
      </categories>
      <tags>
        <tag>MySQL é¢è¯•ç¬”è®°</tag>
      </tags>
  </entry>
</search>
